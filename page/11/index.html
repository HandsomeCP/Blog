<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
  <meta name="theme-color" content="#222">
  <meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>
  <script id="hexo-configurations">
    var NexT = window.NexT ||
    {};
    var CONFIG = {
      "hostname": "cuiqingcai.com",
      "root": "/",
      "scheme": "Pisces",
      "version": "7.8.0",
      "exturl": false,
      "sidebar":
      {
        "position": "right",
        "width": 360,
        "display": "post",
        "padding": 18,
        "offset": 12,
        "onmobile": false,
        "widgets": [
          {
            "type": "image",
            "name": "阿布云",
            "enable": true,
            "url": "https://www.abuyun.com/http-proxy/introduce.html",
            "src": "https://qiniu.cuiqingcai.com/88au8.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "天验",
            "enable": true,
            "url": "https://tutorial.lengyue.video/?coupon=12ef4b1a-a3db-11ea-bb37-0242ac130002_cqx_850",
            "src": "https://qiniu.cuiqingcai.com/bco2a.png",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "华为云",
            "enable": false,
            "url": "https://activity.huaweicloud.com/2020_618_promotion/index.html?bpName=5f9f98a29e2c40b780c1793086f29fe2&bindType=1&salesID=wangyubei",
            "src": "https://qiniu.cuiqingcai.com/y42ik.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "张小鸡",
            "enable": false,
            "url": "http://www.zxiaoji.com/",
            "src": "https://qiniu.cuiqingcai.com/fm72f.png",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "Luminati",
            "src": "https://qiniu.cuiqingcai.com/ikkq9.jpg",
            "url": "https://luminati-china.io/?affiliate=ref_5fbbaaa9647883f5c6f77095",
            "width": "100%",
            "enable": true
      },
          {
            "type": "tags",
            "name": "标签云",
            "enable": true
      },
          {
            "type": "categories",
            "name": "分类",
            "enable": true
      },
          {
            "type": "friends",
            "name": "友情链接",
            "enable": true
      },
          {
            "type": "hot",
            "name": "猜你喜欢",
            "enable": true
      }]
      },
      "copycode":
      {
        "enable": true,
        "show_result": true,
        "style": "mac"
      },
      "back2top":
      {
        "enable": true,
        "sidebar": false,
        "scrollpercent": true
      },
      "bookmark":
      {
        "enable": false,
        "color": "#222",
        "save": "auto"
      },
      "fancybox": false,
      "mediumzoom": false,
      "lazyload": false,
      "pangu": true,
      "comments":
      {
        "style": "tabs",
        "active": "gitalk",
        "storage": true,
        "lazyload": false,
        "nav": null
      },
      "algolia":
      {
        "hits":
        {
          "per_page": 10
        },
        "labels":
        {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      },
      "localsearch":
      {
        "enable": true,
        "trigger": "auto",
        "top_n_per_article": 10,
        "unescape": false,
        "preload": false
      },
      "motion":
      {
        "enable": false,
        "async": false,
        "transition":
        {
          "post_block": "bounceDownIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      "path": "search.xml"
    };

  </script>
  <meta name="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
  <meta property="og:type" content="website">
  <meta property="og:title" content="静觅">
  <meta property="og:url" content="https://cuiqingcai.com/page/11/index.html">
  <meta property="og:site_name" content="静觅">
  <meta property="og:description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
  <meta property="og:locale" content="zh_CN">
  <meta property="article:author" content="崔庆才">
  <meta property="article:tag" content="崔庆才">
  <meta property="article:tag" content="静觅">
  <meta property="article:tag" content="PHP">
  <meta property="article:tag" content="Java">
  <meta property="article:tag" content="Python">
  <meta property="article:tag" content="Spider">
  <meta property="article:tag" content="爬虫">
  <meta property="article:tag" content="Web">
  <meta property="article:tag" content="Kubernetes">
  <meta property="article:tag" content="深度学习">
  <meta property="article:tag" content="机器学习">
  <meta property="article:tag" content="数据分析">
  <meta property="article:tag" content="网络">
  <meta property="article:tag" content="IT">
  <meta property="article:tag" content="技术">
  <meta property="article:tag" content="博客">
  <meta name="twitter:card" content="summary">
  <link rel="canonical" href="https://cuiqingcai.com/page/11/">
  <script id="page-configurations">
    // https://hexo.io/docs/variables.html
    CONFIG.page = {
      sidebar: "",
      isHome: true,
      isPost: false,
      lang: 'zh-CN'
    };

  </script>
  <title>静觅丨崔庆才的个人站点</title>
  <meta name="google-site-verification" content="p_bIcnvirkFzG2dYKuNDivKD8-STet5W7D-01woA2fc" />
  <noscript>
    <style>
      .use-motion .brand,
      .use-motion .menu-item,
      .sidebar-inner,
      .use-motion .post-block,
      .use-motion .pagination,
      .use-motion .comments,
      .use-motion .post-header,
      .use-motion .post-body,
      .use-motion .collection-header
      {
        opacity: initial;
      }

      .use-motion .site-title,
      .use-motion .site-subtitle
      {
        opacity: initial;
        top: initial;
      }

      .use-motion .logo-line-before i
      {
        left: initial;
      }

      .use-motion .logo-line-after i
      {
        right: initial;
      }

    </style>
  </noscript>
  <link rel="alternate" href="/atom.xml" title="静觅" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-container">
          <div class="site-nav-toggle">
            <div class="toggle" aria-label="切换导航栏">
              <span class="toggle-line toggle-line-first"></span>
              <span class="toggle-line toggle-line-middle"></span>
              <span class="toggle-line toggle-line-last"></span>
            </div>
          </div>
          <div class="site-meta">
            <a href="/" class="brand" rel="start">
              <span class="logo-line-before"><i></i></span>
              <h1 class="site-title">静觅 <span class="site-subtitle"> 崔庆才的个人站点 </span>
              </h1>
              <span class="logo-line-after"><i></i></span>
            </a>
          </div>
          <div class="site-nav-right">
            <div class="toggle popup-trigger">
              <i class="fa fa-search fa-fw fa-lg"></i>
            </div>
          </div>
        </div>
        <nav class="site-nav">
          <ul id="menu" class="main-menu menu">
            <li class="menu-item menu-item-home">
              <a href="/" rel="section">首页</a>
            </li>
            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">文章列表</a>
            </li>
            <li class="menu-item menu-item-tags">
              <a href="/tags/" rel="section">文章标签</a>
            </li>
            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">文章分类</a>
            </li>
            <li class="menu-item menu-item-about">
              <a href="/about/" rel="section">关于博主</a>
            </li>
            <li class="menu-item menu-item-message">
              <a href="/message/" rel="section">给我留言</a>
            </li>
            <li class="menu-item menu-item-search">
              <a role="button" class="popup-trigger">搜索 </a>
            </li>
          </ul>
        </nav>
        <div class="search-pop-overlay">
          <div class="popup search-popup">
            <div class="search-header">
              <span class="search-icon">
                <i class="fa fa-search"></i>
              </span>
              <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
              </div>
              <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
              </span>
            </div>
            <div id="search-result">
              <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span>0%</span>
    </div>
    <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content index posts-expand">
            <div class="carousel">
              <div id="wowslider-container">
                <div class="ws_images">
                  <ul>
                    <li><a target="_blank" href="https://cuiqingcai.com/5052.html"><img title="Python3网络爬虫开发实战教程" src="https://qiniu.cuiqingcai.com/ipy96.jpg" /></a></li>
                    <li><a target="_blank" href="https://t.lagou.com/fRCBRsRCSN6FA"><img title="52讲轻松搞定网络爬虫" src="https://qiniu.cuiqingcai.com/fqq5e.png" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/4320.html"><img title="Python3网络爬虫开发视频教程" src="https://qiniu.cuiqingcai.com/bjrny.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/1052.html"><img title="Python2爬虫学习系列教程" src="https://qiniu.cuiqingcai.com/uyl5v.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/5094.html"><img title="爬虫代理哪家强？十大付费代理详细对比评测出炉！" src="https://qiniu.cuiqingcai.com/nifs6.jpg" /></a></li>
                  </ul>
                </div>
                <div class="ws_thumbs">
                  <div>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/ipy96.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/fqq5e.png" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/bjrny.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/uyl5v.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/nifs6.jpg" /></a>
                  </div>
                </div>
                <div class="ws_shadow"></div>
              </div>
            </div>
            <link rel="stylesheet" href="/lib/wowslide/slide.css">
            <script src="/lib/wowslide/jquery.min.js"></script>
            <script src="/lib/wowslide/slider.js"></script>
            <script>
              jQuery("#wowslider-container").wowSlider(
              {
                effect: "cube",
                prev: "",
                next: "",
                duration: 20 * 100,
                delay: 20 * 100,
                width: 716,
                height: 297,
                autoPlay: true,
                playPause: true,
                stopOnHover: false,
                loop: false,
                bullets: 0,
                caption: true,
                captionEffect: "slide",
                controls: true,
                onBeforeStep: 0,
                images: 0
              });

            </script>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6101.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6101.html" class="post-title-link" itemprop="url">自然语言处理中句子相似度计算的几种方法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在做自然语言处理的过程中，我们经常会遇到需要找出相似语句的场景，或者找出句子的近似表达，这时候我们就需要把类似的句子归到一起，这里面就涉及到句子相似度计算的问题，那么本节就来了解一下怎么样来用 Python 实现句子相似度的计算。</p>
                  <h2 id="基本方法"><a href="#基本方法" class="headerlink" title="基本方法"></a>基本方法</h2>
                  <p>句子相似度计算我们一共归类了以下几种方法：</p>
                  <ul>
                    <li>编辑距离计算</li>
                    <li>杰卡德系数计算</li>
                    <li>TF 计算</li>
                    <li>TFIDF 计算</li>
                    <li>Word2Vec 计算</li>
                  </ul>
                  <p>下面我们来一一了解一下这几种算法的原理和 Python 实现。</p>
                  <h2 id="编辑距离计算"><a href="#编辑距离计算" class="headerlink" title="编辑距离计算"></a>编辑距离计算</h2>
                  <p>编辑距离，英文叫做 Edit Distance，又称 Levenshtein 距离，是指两个字串之间，由一个转成另一个所需的最少编辑操作次数，如果它们的距离越大，说明它们越是不同。许可的编辑操作包括将一个字符替换成另一个字符，插入一个字符，删除一个字符。 例如我们有两个字符串：string 和 setting，如果我们想要把 string 转化为 setting，需要这么两步：</p>
                  <ul>
                    <li>第一步，在 s 和 t 之间加入字符 e。</li>
                    <li>第二步，把 r 替换成 t。</li>
                  </ul>
                  <p>所以它们的编辑距离差就是 2，这就对应着二者要进行转化所要改变（添加、替换、删除）的最小步数。 那么用 Python 怎样来实现呢，我们可以直接使用 distance 库：</p>
                  <figure class="highlight mipsasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import <span class="keyword">distance</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">def </span>edit_distance(<span class="built_in">s1</span>, <span class="built_in">s2</span>):</span><br><span class="line">    return <span class="keyword">distance.levenshtein(s1, </span><span class="built_in">s2</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">s1</span> = <span class="string">'string'</span></span><br><span class="line"><span class="built_in">s2</span> = <span class="string">'setting'</span></span><br><span class="line">print(edit_distance(<span class="built_in">s1</span>, <span class="built_in">s2</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们直接使用 distance 库的 levenshtein() 方法，传入两个字符串，即可获取两个字符串的编辑距离了。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里的 distance 库我们可以直接使用 pip3 来安装：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> distance</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样如果我们想要获取相似的文本的话可以直接设定一个编辑距离的阈值来实现，如设置编辑距离为 2，下面是一个样例：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> distance</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_distance</span><span class="params">(s1, s2)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> distance.levenshtein(s1, s2)</span><br><span class="line"></span><br><span class="line">strings = [</span><br><span class="line">    <span class="string">'你在干什么'</span>,</span><br><span class="line">    <span class="string">'你在干啥子'</span>,</span><br><span class="line">    <span class="string">'你在做什么'</span>,</span><br><span class="line">    <span class="string">'你好啊'</span>,</span><br><span class="line">    <span class="string">'我喜欢吃香蕉'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">target = <span class="string">'你在干啥'</span></span><br><span class="line">results = list(filter(<span class="keyword">lambda</span> x: edit_distance(x, target) &lt;= <span class="number">2</span>, strings))</span><br><span class="line">print(results)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们定义了一些字符串，然后定义了一个目标字符串，然后用编辑距离 2 的阈值进行设定，最后得到的结果就是编辑距离在 2 及以内的结果，运行结果如下：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">'你在干什么</span>', <span class="symbol">'你在干啥子</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>通过这种方式我们可以大致筛选出类似的句子，但是发现一些句子例如“你在做什么” 就没有被识别出来，但他们的意义确实是相差不大的，因此，编辑距离并不是一个好的方式，但是简单易用。</p>
                  <h2 id="杰卡德系数计算"><a href="#杰卡德系数计算" class="headerlink" title="杰卡德系数计算"></a>杰卡德系数计算</h2>
                  <p>杰卡德系数，英文叫做 Jaccard index, 又称为 Jaccard 相似系数，用于比较有限样本集之间的相似性与差异性。Jaccard 系数值越大，样本相似度越高。 实际上它的计算方式非常简单，就是两个样本的交集除以并集得到的数值，当两个样本完全一致时，结果为 1，当两个样本完全不同时，结果为 0。 算法非常简单，就是交集除以并集，下面我们用 Python 代码来实现一下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jaccard_similarity</span><span class="params">(s1, s2)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_space</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">' '</span>.join(list(s))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将字中间加入空格</span></span><br><span class="line">    s1, s2 = add_space(s1), add_space(s2)</span><br><span class="line">    <span class="comment"># 转化为TF矩阵</span></span><br><span class="line">    cv = CountVectorizer(tokenizer=<span class="keyword">lambda</span> s: s.split())</span><br><span class="line">    corpus = [s1, s2]</span><br><span class="line">    vectors = cv.fit_transform(corpus).toarray()</span><br><span class="line">    <span class="comment"># 求交集</span></span><br><span class="line">    numerator = np.sum(np.min(vectors, axis=<span class="number">0</span>))</span><br><span class="line">    <span class="comment"># 求并集</span></span><br><span class="line">    denominator = np.sum(np.max(vectors, axis=<span class="number">0</span>))</span><br><span class="line">    <span class="comment"># 计算杰卡德系数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.0</span> * numerator / denominator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s1 = <span class="string">'你在干嘛呢'</span></span><br><span class="line">s2 = <span class="string">'你在干什么呢'</span></span><br><span class="line">print(jaccard_similarity(s1, s2))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们使用了 Sklearn 库中的 CountVectorizer 来计算句子的 TF 矩阵，然后利用 Numpy 来计算二者的交集和并集，随后计算杰卡德系数。 这里值得学习的有 CountVectorizer 的用法，通过它的 fit_transform() 方法我们可以将字符串转化为词频矩阵，例如这里有两句话“你在干嘛呢”和“你在干什么呢”，首先 CountVectorizer 会计算出不重复的有哪些字，会得到一个字的列表，结果为：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">'么</span>', <span class="symbol">'什</span>', <span class="symbol">'你</span>', <span class="symbol">'呢</span>', <span class="symbol">'嘛</span>', <span class="symbol">'在</span>', <span class="symbol">'干</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个其实可以通过如下代码来获取，就是获取词表内容：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">cv</span><span class="selector-class">.get_feature_names</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来通过转化之后，vectors 变量就变成了：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span>]</span><br><span class="line"> [<span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span>]]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>它对应的是两个句子对应词表的词频统计，这里是两个句子，所以结果是一个长度为 2 的二维数组，比如第一句话“你在干嘛呢”中不包含“么”字，那么第一个“么”字对应的结果就是0，即数量为 0，依次类推。 后面我们使用了 np.min() 方法并传入了 axis 为 0，实际上就是获取了每一列的最小值，这样实际上就是取了交集，np.max() 方法是获取了每一列的最大值，实际上就是取了并集。 二者分别取和即是交集大小和并集大小，然后作商即可，结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0.5714285714285714</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个数值越大，代表两个字符串越接近，否则反之，因此我们也可以使用这个方法，并通过设置一个相似度阈值来进行筛选。</p>
                  <h2 id="TF-计算"><a href="#TF-计算" class="headerlink" title="TF 计算"></a>TF 计算</h2>
                  <p>第三种方案就是直接计算 TF 矩阵中两个向量的相似度了，实际上就是求解两个向量夹角的余弦值，就是点乘积除以二者的模长，公式如下：</p>
                  <figure class="highlight gherkin">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">cosθ=a·b/|<span class="string">a</span>|<span class="string">*</span>|<span class="string">b</span>|</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>上面我们已经获得了 TF 矩阵，下面我们只需要求解两个向量夹角的余弦值就好了，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.linalg <span class="keyword">import</span> norm</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tf_similarity</span><span class="params">(s1, s2)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_space</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">' '</span>.join(list(s))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将字中间加入空格</span></span><br><span class="line">    s1, s2 = add_space(s1), add_space(s2)</span><br><span class="line">    <span class="comment"># 转化为TF矩阵</span></span><br><span class="line">    cv = CountVectorizer(tokenizer=<span class="keyword">lambda</span> s: s.split())</span><br><span class="line">    corpus = [s1, s2]</span><br><span class="line">    vectors = cv.fit_transform(corpus).toarray()</span><br><span class="line">    <span class="comment"># 计算TF系数</span></span><br><span class="line">    <span class="keyword">return</span> np.dot(vectors[<span class="number">0</span>], vectors[<span class="number">1</span>]) / (norm(vectors[<span class="number">0</span>]) * norm(vectors[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s1 = <span class="string">'你在干嘛呢'</span></span><br><span class="line">s2 = <span class="string">'你在干什么呢'</span></span><br><span class="line">print(tf_similarity(s1, s2))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在在这里我们使用了 np.dot() 方法获取了向量的点乘积，然后通过 norm() 方法获取了向量的模长，经过计算得到二者的 TF 系数，结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0.7302967433402214</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="TFIDF-计算"><a href="#TFIDF-计算" class="headerlink" title="TFIDF 计算"></a>TFIDF 计算</h2>
                  <p>另外除了计算 TF 系数我们还可以计算 TFIDF 系数，TFIDF 实际上就是在词频 TF 的基础上再加入 IDF 的信息，IDF 称为逆文档频率，不了解的可以看下阮一峰老师的讲解：<a href="http://www.ruanyifeng.com/blog/2013/03/tf-idf.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2013/03/tf-idf.html</a>，里面对 TFIDF 的讲解也是十分透彻的。 下面我们还是借助于 Sklearn 中的模块 TfidfVectorizer 来实现，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.linalg <span class="keyword">import</span> norm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tfidf_similarity</span><span class="params">(s1, s2)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_space</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">' '</span>.join(list(s))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将字中间加入空格</span></span><br><span class="line">    s1, s2 = add_space(s1), add_space(s2)</span><br><span class="line">    <span class="comment"># 转化为TF矩阵</span></span><br><span class="line">    cv = TfidfVectorizer(tokenizer=<span class="keyword">lambda</span> s: s.split())</span><br><span class="line">    corpus = [s1, s2]</span><br><span class="line">    vectors = cv.fit_transform(corpus).toarray()</span><br><span class="line">    <span class="comment"># 计算TF系数</span></span><br><span class="line">    <span class="keyword">return</span> np.dot(vectors[<span class="number">0</span>], vectors[<span class="number">1</span>]) / (norm(vectors[<span class="number">0</span>]) * norm(vectors[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s1 = <span class="string">'你在干嘛呢'</span></span><br><span class="line">s2 = <span class="string">'你在干什么呢'</span></span><br><span class="line">print(tfidf_similarity(s1, s2))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里的 vectors 变量实际上就对应着 TFIDF 值，内容如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[<span class="number">0.</span>         <span class="number">0.</span>         <span class="number">0.4090901</span>  <span class="number">0.4090901</span>  <span class="number">0.57496187</span> <span class="number">0.4090901</span> <span class="number">0.4090901</span> ]</span><br><span class="line"> [<span class="number">0.49844628</span> <span class="number">0.49844628</span> <span class="number">0.35464863</span> <span class="number">0.35464863</span> <span class="number">0.</span>  <span class="number">0.35464863</span> <span class="number">0.35464863</span>]]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0.5803329846765686</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>所以通过 TFIDF 系数我们也可以进行相似度的计算。</p>
                  <h2 id="Word2Vec-计算"><a href="#Word2Vec-计算" class="headerlink" title="Word2Vec 计算"></a>Word2Vec 计算</h2>
                  <p>Word2Vec，顾名思义，其实就是将每一个词转换为向量的过程。如果不了解的话可以参考：<a href="https://blog.csdn.net/itplus/article/details/37969519" target="_blank" rel="noopener">https://blog.csdn.net/itplus/article/details/37969519</a>。 这里我们可以直接下载训练好的 Word2Vec 模型，模型的链接地址为：<a href="https://pan.baidu.com/s/1TZ8GII0CEX32ydjsfMc0zw" target="_blank" rel="noopener">https://pan.baidu.com/s/1TZ8GII0CEX32ydjsfMc0zw</a>，是使用新闻、百度百科、小说数据来训练的 64 维的 Word2Vec 模型，数据量很大，整体效果还不错，我们可以直接下载下来使用，这里我们使用的是 news_12g_baidubaike_20g_novel_90g_embedding_64.bin 数据，然后实现 Sentence2Vec，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> gensim</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.linalg <span class="keyword">import</span> norm</span><br><span class="line"></span><br><span class="line">model_file = <span class="string">'./word2vec/news_12g_baidubaike_20g_novel_90g_embedding_64.bin'</span></span><br><span class="line">model = gensim.models.KeyedVectors.load_word2vec_format(model_file, binary=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vector_similarity</span><span class="params">(s1, s2)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sentence_vector</span><span class="params">(s)</span>:</span></span><br><span class="line">        words = jieba.lcut(s)</span><br><span class="line">        v = np.zeros(<span class="number">64</span>)</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">            v += model[word]</span><br><span class="line">        v /= len(words)</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line">    </span><br><span class="line">    v1, v2 = sentence_vector(s1), sentence_vector(s2)</span><br><span class="line">    <span class="keyword">return</span> np.dot(v1, v2) / (norm(v1) * norm(v2))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在获取 Sentence Vector 的时候，我们首先对句子进行分词，然后对分好的每一个词获取其对应的 Vector，然后将所有 Vector 相加并求平均，这样就可得到 Sentence Vector 了，然后再计算其夹角余弦值即可。 调用示例如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">s1 = <span class="string">'你在干嘛'</span></span><br><span class="line">s2 = <span class="string">'你正做什么'</span></span><br><span class="line"><span class="function"><span class="title">vector_similarity</span><span class="params">(s1, s2)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0.6701133967824016</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时如果我们再回到最初的例子看下效果：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">strings = [</span><br><span class="line">    <span class="string">'你在干什么'</span>,</span><br><span class="line">    <span class="string">'你在干啥子'</span>,</span><br><span class="line">    <span class="string">'你在做什么'</span>,</span><br><span class="line">    <span class="string">'你好啊'</span>,</span><br><span class="line">    <span class="string">'我喜欢吃香蕉'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">target = <span class="string">'你在干啥'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">string</span> in <span class="built_in">string</span><span class="variable">s:</span></span><br><span class="line">    <span class="keyword">print</span>(<span class="built_in">string</span>, vector_similarity(<span class="built_in">string</span>, target))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>依然是前面的例子，我们看下它们的匹配度结果是多少，运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">你在干什么 <span class="number">0.8785495016487204</span></span><br><span class="line">你在干啥子 <span class="number">0.9789649689827049</span></span><br><span class="line">你在做什么 <span class="number">0.8781992402695274</span></span><br><span class="line">你好啊 <span class="number">0.5174225914249863</span></span><br><span class="line">我喜欢吃香蕉 <span class="number">0.582990841450621</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到相近的语句相似度都能到 0.8 以上，而不同的句子相似度都不足 0.6，这个区分度就非常大了，可以说有了 Word2Vec 我们可以结合一些语义信息来进行一些判断，效果明显也好很多。 所以总体来说，Word2Vec 计算的方式是非常好的。 另外学术界还有一些可能更好的研究成果，这个可以参考知乎上的一些回答：<a href="https://www.zhihu.com/question/29978268/answer/54399062" target="_blank" rel="noopener">https://www.zhihu.com/question/29978268/answer/54399062</a>。 以上便是进行句子相似度计算的基本方法和 Python 实现，本节代码地址：<a href="https://github.com/AIDeepLearning/SentenceDistance" target="_blank" rel="noopener">https://github.com/AIDeepLearning/SentenceDistance</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-06-08 20:01:51" itemprop="dateCreated datePublished" datetime="2018-06-08T20:01:51+08:00">2018-06-08</time>
                </span>
                <span id="/6101.html" class="post-meta-item leancloud_visitors" data-flag-title="自然语言处理中句子相似度计算的几种方法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6058.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6058.html" class="post-title-link" itemprop="url">小白进阶之Scrapy第六篇Scrapy-Redis详解</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h1 id="Scrapy-Redis-详解"><a href="#Scrapy-Redis-详解" class="headerlink" title="Scrapy-Redis 详解"></a>Scrapy-Redis 详解</h1>
                  <p>通常我们在一个站站点进行采集的时候，如果是小站的话 我们使用scrapy本身就可以满足。 但是如果在面对一些比较大型的站点的时候，单个scrapy就显得力不从心了。 <img src="https://thsheep-wordpress.oss-cn-beijing.aliyuncs.com/6fd6b3659b0e7bc8c3ebcf741e221f3c.jpg" alt=""> 要是我们能够多个Scrapy一起采集该多好啊 人多力量大。 很遗憾Scrapy官方并不支持多个同时采集一个站点，虽然官方给出一个方法： <strong><strong>将一个站点的分割成几部分 交给不同的scrapy去采集</strong></strong> 似乎是个解决办法，但是很麻烦诶！毕竟分割很麻烦的哇 下面就改轮到我们的额主角Scrapy-Redis登场了！ <img src="https://thsheep-wordpress.oss-cn-beijing.aliyuncs.com/9af3afb195a78aa8770204115cc7959d.jpg" alt=""></p>
                  <h2 id="什么？？你这么就登场了？还没说为什么呢？"><a href="#什么？？你这么就登场了？还没说为什么呢？" class="headerlink" title="什么？？你这么就登场了？还没说为什么呢？"></a>什么？？你这么就登场了？还没说为什么呢？</h2>
                  <p>好吧 为了简单起见 就用官方图来简单说明一下： <img src="https://thsheep-wordpress.oss-cn-beijing.aliyuncs.com/62d1dc3038e8b596d6df6f8e8a28258a.jpg" alt=""> 这张图大家相信大家都很熟悉了。重点看一下SCHEDULER 1. 先来看看官方对于SCHEDULER的定义： <strong><strong>SCHEDULER接受来自Engine的Requests,并将它们放入队列（可以按顺序优先级），以便在之后将其提供给Engine</strong></strong> <a href="https://doc.scrapy.org/en/latest/topics/architecture.html#component-scheduler" target="_blank" rel="noopener">点我看文档</a> 2. 现在我们来看看SCHEDULER都提供了些什么功能： 根据官方文档说明 在我们没有没有指定 SCHEDULER 参数时，默认使用：’scrapy.core.scheduler.Scheduler’ 作为SCHEDULER(调度器) scrapy.core.scheduler.py: </p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span>(<span class="title">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, dupefilter, jobdir=None, dqclass=None, mqclass=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 logunser=False, stats=None, pqclass=None)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.df = dupefilter</span><br><span class="line">        <span class="keyword">self</span>.dqdir = <span class="keyword">self</span>._dqdir(jobdir)</span><br><span class="line">        <span class="keyword">self</span>.pqclass = pqclass</span><br><span class="line">        <span class="keyword">self</span>.dqclass = dqclass</span><br><span class="line">        <span class="keyword">self</span>.mqclass = mqclass</span><br><span class="line">        <span class="keyword">self</span>.logunser = logunser</span><br><span class="line">        <span class="keyword">self</span>.stats = stats</span><br><span class="line">        <span class="comment"># 注意在scrpy中优先注意这个方法，此方法是一个钩子 用于访问当前爬虫的配置</span></span><br><span class="line">    @classmethod</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span></span><span class="symbol">:</span></span><br><span class="line">        settings = crawler.settings</span><br><span class="line">        <span class="comment"># 获取去重用的类 默认：scrapy.dupefilters.RFPDupeFilter</span></span><br><span class="line">        dupefilter_cls = load_object(settings[<span class="string">'DUPEFILTER_CLASS'</span>])</span><br><span class="line">        <span class="comment"># 对去重类进行配置from_settings 在 scrapy.dupefilters.RFPDupeFilter 43行</span></span><br><span class="line">        <span class="comment"># 这种调用方式对于IDE跳转不是很好  所以需要自己去找</span></span><br><span class="line">        <span class="comment"># <span class="doctag">@classmethod</span></span></span><br><span class="line">        <span class="comment"># def from_settings(cls, settings):</span></span><br><span class="line">        <span class="comment">#     debug = settings.getbool('DUPEFILTER_DEBUG')</span></span><br><span class="line">        <span class="comment">#     return cls(job_dir(settings), debug)</span></span><br><span class="line">        <span class="comment"># 上面就是from_settings方法 其实就是设置工作目录 和是否开启debug</span></span><br><span class="line">        dupefilter = dupefilter_cls.from_settings(settings)</span><br><span class="line">        <span class="comment"># 获取优先级队列 类对象 默认：queuelib.pqueue.PriorityQueue</span></span><br><span class="line">        pqclass = load_object(settings[<span class="string">'SCHEDULER_PRIORITY_QUEUE'</span>])</span><br><span class="line">        <span class="comment"># 获取磁盘队列 类对象（SCHEDULER使用磁盘存储 重启不会丢失）</span></span><br><span class="line">        dqclass = load_object(settings[<span class="string">'SCHEDULER_DISK_QUEUE'</span>])</span><br><span class="line">        <span class="comment"># 获取内存队列 类对象（SCHEDULER使用内存存储 重启会丢失）</span></span><br><span class="line">        mqclass = load_object(settings[<span class="string">'SCHEDULER_MEMORY_QUEUE'</span>])</span><br><span class="line">        <span class="comment"># 是否开启debug</span></span><br><span class="line">        logunser = settings.getbool(<span class="string">'LOG_UNSERIALIZABLE_REQUESTS'</span>, settings.getbool(<span class="string">'SCHEDULER_DEBUG'</span>))</span><br><span class="line">        <span class="comment"># 将这些参数传递给 __init__方法</span></span><br><span class="line">        <span class="keyword">return</span> cls(dupefilter, jobdir=job_dir(settings), logunser=logunser,</span><br><span class="line">                   stats=crawler.stats, pqclass=pqclass, dqclass=dqclass, mqclass=mqclass)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_pending_requests</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">      <span class="string">""</span><span class="string">"检查是否有没处理的请求"</span><span class="string">""</span></span><br><span class="line">        <span class="keyword">return</span> len(<span class="keyword">self</span>) &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(<span class="keyword">self</span>, spider)</span></span><span class="symbol">:</span></span><br><span class="line">      <span class="string">""</span><span class="string">"Engine创建完毕之后会调用这个方法"</span><span class="string">""</span></span><br><span class="line">        <span class="keyword">self</span>.spider = spider</span><br><span class="line">        <span class="comment"># 创建一个有优先级的内存队列 实例化对象</span></span><br><span class="line">        <span class="comment"># self.pqclass 默认是：queuelib.pqueue.PriorityQueue</span></span><br><span class="line">        <span class="comment"># self._newmq 会返回一个内存队列的 实例化对象 在110  111 行</span></span><br><span class="line">        <span class="keyword">self</span>.mqs = <span class="keyword">self</span>.pqclass(<span class="keyword">self</span>._newmq)</span><br><span class="line">        <span class="comment"># 如果self.dqdir 有设置 就创建一个磁盘队列 否则self.dqs 为空</span></span><br><span class="line">        <span class="keyword">self</span>.dqs = <span class="keyword">self</span>._dq() <span class="keyword">if</span> <span class="keyword">self</span>.dqdir <span class="keyword">else</span> None</span><br><span class="line">        <span class="comment"># 获得一个去重实例对象 open 方法是从BaseDupeFilter继承的</span></span><br><span class="line">        <span class="comment"># 现在我们可以用self.df来去重啦</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.df.open()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(<span class="keyword">self</span>, reason)</span></span><span class="symbol">:</span></span><br><span class="line">      <span class="string">""</span><span class="string">"当然Engine关闭时"</span><span class="string">""</span></span><br><span class="line">          <span class="comment"># 如果有磁盘队列 则对其进行dump后保存到active.json文件中</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">dqs:</span></span><br><span class="line">            prios = <span class="keyword">self</span>.dqs.close()</span><br><span class="line">            with open(join(<span class="keyword">self</span>.dqdir, <span class="string">'active.json'</span>), <span class="string">'w'</span>) as <span class="symbol">f:</span></span><br><span class="line">                json.dump(prios, f)</span><br><span class="line">        <span class="comment"># 然后关闭去重</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.df.close(reason)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enqueue_request</span><span class="params">(<span class="keyword">self</span>, request)</span></span><span class="symbol">:</span></span><br><span class="line">      <span class="string">""</span><span class="string">"添加一个Requests进调度队列"</span><span class="string">""</span></span><br><span class="line">          <span class="comment"># self.df.request_seen是检查这个Request是否已经请求过了 如果有会返回True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.dont_filter <span class="keyword">and</span> <span class="keyword">self</span>.df.request_seen(request)<span class="symbol">:</span></span><br><span class="line">              <span class="comment"># 如果Request的dont_filter属性没有设置（默认为False）和 已经存在则去重</span></span><br><span class="line">            <span class="comment"># 不push进队列</span></span><br><span class="line">            <span class="keyword">self</span>.df.log(request, <span class="keyword">self</span>.spider)</span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line">        <span class="comment"># 先尝试将Request push进磁盘队列</span></span><br><span class="line">        dqok = <span class="keyword">self</span>._dqpush(request)</span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">dqok:</span></span><br><span class="line">              <span class="comment"># 如果成功 则在记录一次状态</span></span><br><span class="line">            <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/enqueued/disk'</span>, spider=<span class="keyword">self</span>.spider)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">              <span class="comment"># 不能添加进磁盘队列则会添加进内存队列</span></span><br><span class="line">            <span class="keyword">self</span>._mqpush(request)</span><br><span class="line">            <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/enqueued/memory'</span>, spider=<span class="keyword">self</span>.spider)</span><br><span class="line">        <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/enqueued'</span>, spider=<span class="keyword">self</span>.spider)</span><br><span class="line">        <span class="keyword">return</span> True</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_request</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">      <span class="string">""</span><span class="string">"从队列中获取一个Request"</span><span class="string">""</span></span><br><span class="line">          <span class="comment"># 优先从内存队列中获取</span></span><br><span class="line">        request = <span class="keyword">self</span>.mqs.pop()</span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">request:</span></span><br><span class="line">            <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/dequeued/memory'</span>, spider=<span class="keyword">self</span>.spider)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">              <span class="comment"># 不能获取的时候从磁盘队列队里获取</span></span><br><span class="line">            request = <span class="keyword">self</span>._dqpop()</span><br><span class="line">            <span class="keyword">if</span> <span class="symbol">request:</span></span><br><span class="line">                <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/dequeued/disk'</span>, spider=<span class="keyword">self</span>.spider)</span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">request:</span></span><br><span class="line">            <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/dequeued'</span>, spider=<span class="keyword">self</span>.spider)</span><br><span class="line">        <span class="comment"># 将获取的到Request返回给Engine</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> len(<span class="keyword">self</span>.dqs) + len(<span class="keyword">self</span>.mqs) <span class="keyword">if</span> <span class="keyword">self</span>.dqs <span class="keyword">else</span> len(<span class="keyword">self</span>.mqs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dqpush</span><span class="params">(<span class="keyword">self</span>, request)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.dqs is <span class="symbol">None:</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            reqd = request_to_dict(request, <span class="keyword">self</span>.spider)</span><br><span class="line">            <span class="keyword">self</span>.dqs.push(reqd, -request.priority)</span><br><span class="line">        except ValueError as <span class="symbol">e:</span>  <span class="comment"># non serializable request</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">logunser:</span></span><br><span class="line">                msg = (<span class="string">"Unable to serialize request: %(request)s - reason:"</span></span><br><span class="line">                       <span class="string">" %(reason)s - no more unserializable requests will be"</span></span><br><span class="line">                       <span class="string">" logged (stats being collected)"</span>)</span><br><span class="line">                logger.warning(msg, &#123;<span class="string">'request'</span>: request, <span class="string">'reason'</span>: e&#125;,</span><br><span class="line">                               exc_info=True, extra=&#123;<span class="string">'spider'</span>: <span class="keyword">self</span>.spider&#125;)</span><br><span class="line">                <span class="keyword">self</span>.logunser = False</span><br><span class="line">            <span class="keyword">self</span>.stats.inc_value(<span class="string">'scheduler/unserializable'</span>,</span><br><span class="line">                                 spider=<span class="keyword">self</span>.spider)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            <span class="keyword">return</span> True</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_mqpush</span><span class="params">(<span class="keyword">self</span>, request)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.mqs.push(request, -request.priority)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dqpop</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">dqs:</span></span><br><span class="line">            d = <span class="keyword">self</span>.dqs.pop()</span><br><span class="line">            <span class="keyword">if</span> <span class="symbol">d:</span></span><br><span class="line">                <span class="keyword">return</span> request_from_dict(d, <span class="keyword">self</span>.spider)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_newmq</span><span class="params">(<span class="keyword">self</span>, priority)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.mqclass()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_newdq</span><span class="params">(<span class="keyword">self</span>, priority)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.dqclass(join(<span class="keyword">self</span>.dqdir, <span class="string">'p%s'</span> % priority))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dq</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        activef = join(<span class="keyword">self</span>.dqdir, <span class="string">'active.json'</span>)</span><br><span class="line">        <span class="keyword">if</span> exists(activef)<span class="symbol">:</span></span><br><span class="line">            with open(activef) as <span class="symbol">f:</span></span><br><span class="line">                prios = json.load(f)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            prios = ()</span><br><span class="line">        q = <span class="keyword">self</span>.pqclass(<span class="keyword">self</span>._newdq, startprios=prios)</span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">q:</span></span><br><span class="line">            logger.info(<span class="string">"Resuming crawl (%(queuesize)d requests scheduled)"</span>,</span><br><span class="line">                        &#123;<span class="string">'queuesize'</span>: len(q)&#125;, extra=&#123;<span class="string">'spider'</span>: <span class="keyword">self</span>.spider&#125;)</span><br><span class="line">        <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dqdir</span><span class="params">(<span class="keyword">self</span>, jobdir)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">jobdir:</span></span><br><span class="line">            dqdir = join(jobdir, <span class="string">'requests.queue'</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> exists(dqdir)<span class="symbol">:</span></span><br><span class="line">                os.makedirs(dqdir)</span><br><span class="line">            <span class="keyword">return</span> dqdir</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p> 只挑了一些重点的写了一些注释剩下大家自己领会(才不是我懒哦 ) 从上面的代码 我们可以很清楚的知道 SCHEDULER的主要是完成了 push Request pop Request 和 去重的操作。 而且queue 操作是在内存队列中完成的。 大家看queuelib.queue就会发现基于内存的（deque） 那么去重呢？</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RFPDupeFilter</span>(<span class="title">BaseDupeFilter</span>):</span></span><br><span class="line">    <span class="string">""</span><span class="string">"Request Fingerprint duplicates filter"</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, path=None, debug=False)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.file = None</span><br><span class="line">        <span class="keyword">self</span>.fingerprints = set()</span><br><span class="line">        <span class="keyword">self</span>.logdupes = True</span><br><span class="line">        <span class="keyword">self</span>.debug = debug</span><br><span class="line">        <span class="keyword">self</span>.logger = logging.getLogger(__name_<span class="number">_</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">path:</span></span><br><span class="line">              <span class="comment"># 此处可以看到去重其实打开了一个名叫 requests.seen的文件</span></span><br><span class="line">            <span class="comment"># 如果是使用的磁盘的话</span></span><br><span class="line">            <span class="keyword">self</span>.file = open(os.path.join(path, <span class="string">'requests.seen'</span>), <span class="string">'a+'</span>)</span><br><span class="line">            <span class="keyword">self</span>.file.seek(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">self</span>.fingerprints.update(x.rstrip() <span class="keyword">for</span> x <span class="keyword">in</span> <span class="keyword">self</span>.file)</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_settings</span><span class="params">(cls, settings)</span></span><span class="symbol">:</span></span><br><span class="line">        debug = settings.getbool(<span class="string">'DUPEFILTER_DEBUG'</span>)</span><br><span class="line">        <span class="keyword">return</span> cls(job_dir(settings), debug)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request_seen</span><span class="params">(<span class="keyword">self</span>, request)</span></span><span class="symbol">:</span></span><br><span class="line">        fp = <span class="keyword">self</span>.request_fingerprint(request)</span><br><span class="line">        <span class="keyword">if</span> fp <span class="keyword">in</span> <span class="keyword">self</span>.<span class="symbol">fingerprints:</span></span><br><span class="line">              <span class="comment"># 判断我们的请求是否在这个在集合中</span></span><br><span class="line">            <span class="keyword">return</span> True</span><br><span class="line">        <span class="comment"># 没有在集合就添加进去</span></span><br><span class="line">        <span class="keyword">self</span>.fingerprints.add(fp)</span><br><span class="line">        <span class="comment"># 如果用的磁盘队列就写进去记录一下</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">file:</span></span><br><span class="line">            <span class="keyword">self</span>.file.write(fp + os.linesep)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <pre><code>  按照正常流程就是大家都会进行重复的采集；我们都知道进程之间内存中的数据不可共享的，那么你在开启多个Scrapy的时候，它们相互之间并不知道对方采集了些什么那些没有没采集。那就大家伙儿自己玩自己的了。完全没没有效率的提升啊！ ![](https://thsheep-wordpress.oss-cn-beijing.aliyuncs.com/7015cb643d0c05854dab5b8457f076af.jpg) 怎么解决呢？ 这就是我们Scrapy-Redis解决的问题了，不能协作不就是因为Request 和 去重这两个 不能共享吗？ 那我把这两个独立出来好了。 将Scrapy中的SCHEDULER组件独立放到大家都能访问的地方不就OK啦！加上scrapy-redis后流程图就应该变成这样了? ![](https://thsheep-wordpress.oss-cn-beijing.aliyuncs.com/0a94645a8f10707fe80610b5ebeb945e.jpg) So············· 这样是不是看起来就清楚多了？？？ 下面我们来看看Scrapy-Redis是怎么处理的? scrapy_redis.scheduler.py：
</code></pre>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">class Scheduler(object):</span><br><span class="line">    <span class="string">""</span><span class="string">"Redis-based scheduler</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Settings</span></span><br><span class="line"><span class="string">    --------</span></span><br><span class="line"><span class="string">    SCHEDULER_PERSIST : bool (default: False)</span></span><br><span class="line"><span class="string">        Whether to persist or clear redis queue.</span></span><br><span class="line"><span class="string">    SCHEDULER_FLUSH_ON_START : bool (default: False)</span></span><br><span class="line"><span class="string">        Whether to flush redis queue on start.</span></span><br><span class="line"><span class="string">    SCHEDULER_IDLE_BEFORE_CLOSE : int (default: 0)</span></span><br><span class="line"><span class="string">        How many seconds to wait before closing if no message is received.</span></span><br><span class="line"><span class="string">    SCHEDULER_QUEUE_KEY : str</span></span><br><span class="line"><span class="string">        Scheduler redis key.</span></span><br><span class="line"><span class="string">    SCHEDULER_QUEUE_CLASS : str</span></span><br><span class="line"><span class="string">        Scheduler queue class.</span></span><br><span class="line"><span class="string">    SCHEDULER_DUPEFILTER_KEY : str</span></span><br><span class="line"><span class="string">        Scheduler dupefilter redis key.</span></span><br><span class="line"><span class="string">    SCHEDULER_DUPEFILTER_CLASS : str</span></span><br><span class="line"><span class="string">        Scheduler dupefilter class.</span></span><br><span class="line"><span class="string">    SCHEDULER_SERIALIZER : str</span></span><br><span class="line"><span class="string">        Scheduler serializer.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">    def __init__(self, server,</span><br><span class="line">                 <span class="attribute">persist</span>=<span class="literal">False</span>,</span><br><span class="line">                 <span class="attribute">flush_on_start</span>=<span class="literal">False</span>,</span><br><span class="line">                 <span class="attribute">queue_key</span>=defaults.SCHEDULER_QUEUE_KEY,</span><br><span class="line">                 <span class="attribute">queue_cls</span>=defaults.SCHEDULER_QUEUE_CLASS,</span><br><span class="line">                 <span class="attribute">dupefilter_key</span>=defaults.SCHEDULER_DUPEFILTER_KEY,</span><br><span class="line">                 <span class="attribute">dupefilter_cls</span>=defaults.SCHEDULER_DUPEFILTER_CLASS,</span><br><span class="line">                 <span class="attribute">idle_before_close</span>=0,</span><br><span class="line">                 <span class="attribute">serializer</span>=None):</span><br><span class="line">        <span class="string">""</span><span class="string">"Initialize scheduler.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        server : Redis</span></span><br><span class="line"><span class="string">            这是Redis实例</span></span><br><span class="line"><span class="string">        persist : bool</span></span><br><span class="line"><span class="string">            是否在关闭时清空Requests.默认值是False。</span></span><br><span class="line"><span class="string">        flush_on_start : bool</span></span><br><span class="line"><span class="string">            是否在启动时清空Requests。 默认值是False。</span></span><br><span class="line"><span class="string">        queue_key : str</span></span><br><span class="line"><span class="string">            Request队列的Key名字</span></span><br><span class="line"><span class="string">        queue_cls : str</span></span><br><span class="line"><span class="string">            队列的可导入路径（就是使用什么队列）</span></span><br><span class="line"><span class="string">        dupefilter_key : str</span></span><br><span class="line"><span class="string">            去重队列的Key</span></span><br><span class="line"><span class="string">        dupefilter_cls : str</span></span><br><span class="line"><span class="string">            去重类的可导入路径。</span></span><br><span class="line"><span class="string">        idle_before_close : int</span></span><br><span class="line"><span class="string">            等待多久关闭</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> idle_before_close &lt; 0:</span><br><span class="line">            raise TypeError(<span class="string">"idle_before_close cannot be negative"</span>)</span><br><span class="line"></span><br><span class="line">        self.server = server</span><br><span class="line">        self.persist = persist</span><br><span class="line">        self.flush_on_start = flush_on_start</span><br><span class="line">        self.queue_key = queue_key</span><br><span class="line">        self.queue_cls = queue_cls</span><br><span class="line">        self.dupefilter_cls = dupefilter_cls</span><br><span class="line">        self.dupefilter_key = dupefilter_key</span><br><span class="line">        self.idle_before_close = idle_before_close</span><br><span class="line">        self.serializer = serializer</span><br><span class="line">        self.stats = None</span><br><span class="line"></span><br><span class="line">    def __len__(self):</span><br><span class="line">        return len(self.queue)</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def from_settings(cls, settings):</span><br><span class="line">        kwargs = &#123;</span><br><span class="line">            <span class="string">'persist'</span>: settings.getbool(<span class="string">'SCHEDULER_PERSIST'</span>),</span><br><span class="line">            <span class="string">'flush_on_start'</span>: settings.getbool(<span class="string">'SCHEDULER_FLUSH_ON_START'</span>),</span><br><span class="line">            <span class="string">'idle_before_close'</span>: settings.getint(<span class="string">'SCHEDULER_IDLE_BEFORE_CLOSE'</span>),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # <span class="keyword">If</span> these values are missing, it means we want <span class="keyword">to</span> use the defaults.</span><br><span class="line">        optional = &#123;</span><br><span class="line">            # TODO: Use custom prefixes <span class="keyword">for</span> this<span class="built_in"> settings </span><span class="keyword">to</span><span class="built_in"> note </span>that are</span><br><span class="line">            # specific <span class="keyword">to</span> scrapy-redis.</span><br><span class="line">            <span class="string">'queue_key'</span>: <span class="string">'SCHEDULER_QUEUE_KEY'</span>,</span><br><span class="line">            <span class="string">'queue_cls'</span>: <span class="string">'SCHEDULER_QUEUE_CLASS'</span>,</span><br><span class="line">            <span class="string">'dupefilter_key'</span>: <span class="string">'SCHEDULER_DUPEFILTER_KEY'</span>,</span><br><span class="line">            # We use the<span class="built_in"> default </span>setting name <span class="keyword">to</span> keep compatibility.</span><br><span class="line">            <span class="string">'dupefilter_cls'</span>: <span class="string">'DUPEFILTER_CLASS'</span>,</span><br><span class="line">            <span class="string">'serializer'</span>: <span class="string">'SCHEDULER_SERIALIZER'</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        # 从setting中获取配置组装成dict(具体获取那些配置是optional字典中key)</span><br><span class="line">        <span class="keyword">for</span> name, setting_name <span class="keyword">in</span> optional.items():</span><br><span class="line">            val = settings.<span class="builtin-name">get</span>(setting_name)</span><br><span class="line">            <span class="keyword">if</span> val:</span><br><span class="line">                kwargs[name] = val</span><br><span class="line"></span><br><span class="line">        # Support serializer as a path <span class="keyword">to</span> a module.</span><br><span class="line">        <span class="keyword">if</span> isinstance(kwargs.<span class="builtin-name">get</span>(<span class="string">'serializer'</span>), six.string_types):</span><br><span class="line">            kwargs[<span class="string">'serializer'</span>] = importlib.import_module(kwargs[<span class="string">'serializer'</span>])</span><br><span class="line">                # 或得一个Redis连接</span><br><span class="line">       <span class="built_in"> server </span>= connection.from_settings(settings)</span><br><span class="line">        # Ensure the<span class="built_in"> connection </span>is working.</span><br><span class="line">        server.ping()</span><br><span class="line"></span><br><span class="line">        return cls(<span class="attribute">server</span>=server, **kwargs)</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def from_crawler(cls, crawler):</span><br><span class="line">       <span class="built_in"> instance </span>= cls.from_settings(crawler.settings)</span><br><span class="line">        # FIXME: <span class="keyword">for</span> now, stats are only supported <span class="keyword">from</span> this constructor</span><br><span class="line">        instance.stats = crawler.stats</span><br><span class="line">        return instance</span><br><span class="line"></span><br><span class="line">    def open(self, spider):</span><br><span class="line">        self.spider = spider</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">              # 根据self.queue_cls这个可以导入的类 实例化一个队列</span><br><span class="line">            self.queue = load_object(self.queue_cls)(</span><br><span class="line">                <span class="attribute">server</span>=self.server,</span><br><span class="line">                <span class="attribute">spider</span>=spider,</span><br><span class="line">                <span class="attribute">key</span>=self.queue_key % &#123;<span class="string">'spider'</span>: spider.name&#125;,</span><br><span class="line">                <span class="attribute">serializer</span>=self.serializer,</span><br><span class="line">            )</span><br><span class="line">        except TypeError as e:</span><br><span class="line">            raise ValueError(<span class="string">"Failed to instantiate queue class '%s': %s"</span>,</span><br><span class="line">                             self.queue_cls, e)</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">              # 根据self.dupefilter_cls这个可以导入的类 实例一个去重集合</span><br><span class="line">            # 默认是集合 可以实现自己的去重方式 比如 bool 去重</span><br><span class="line">            self.df = load_object(self.dupefilter_cls)(</span><br><span class="line">                <span class="attribute">server</span>=self.server,</span><br><span class="line">                <span class="attribute">key</span>=self.dupefilter_key % &#123;<span class="string">'spider'</span>: spider.name&#125;,</span><br><span class="line">                <span class="attribute">debug</span>=spider.settings.getbool('DUPEFILTER_DEBUG'),</span><br><span class="line">            )</span><br><span class="line">        except TypeError as e:</span><br><span class="line">            raise ValueError(<span class="string">"Failed to instantiate dupefilter class '%s': %s"</span>,</span><br><span class="line">                             self.dupefilter_cls, e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.flush_on_start:</span><br><span class="line">            self.flush()</span><br><span class="line">        # notice <span class="keyword">if</span> there are requests already <span class="keyword">in</span> the<span class="built_in"> queue </span><span class="keyword">to</span> resume the crawl</span><br><span class="line">        <span class="keyword">if</span> len(self.queue):</span><br><span class="line">            spider.log(<span class="string">"Resuming crawl (%d requests scheduled)"</span> % len(self.queue))</span><br><span class="line"></span><br><span class="line">    def close(self, reason):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.persist:</span><br><span class="line">            self.flush()</span><br><span class="line"></span><br><span class="line">    def flush(self):</span><br><span class="line">        self.df.clear()</span><br><span class="line">        self.queue.clear()</span><br><span class="line"></span><br><span class="line">    def enqueue_request(self, request):</span><br><span class="line">      <span class="string">""</span><span class="string">"这个和Scrapy本身的一样"</span><span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.dont_filter <span class="keyword">and</span> self.df.request_seen(request):</span><br><span class="line">            self.df.log(request, self.spider)</span><br><span class="line">            return <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> self.stats:</span><br><span class="line">            self.stats.inc_value(<span class="string">'scheduler/enqueued/redis'</span>, <span class="attribute">spider</span>=self.spider)</span><br><span class="line">        # 向队列里面添加一个Request</span><br><span class="line">        self.queue.push(request)</span><br><span class="line">        return <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    def next_request(self):</span><br><span class="line">      <span class="string">""</span><span class="string">"获取一个Request"</span><span class="string">""</span></span><br><span class="line">        block_pop_timeout = self.idle_before_close</span><br><span class="line">        # block_pop_timeout 是一个等待参数 队列没有东西会等待这个时间  超时就会关闭</span><br><span class="line">        request = self.queue.pop(block_pop_timeout)</span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">and</span> self.stats:</span><br><span class="line">            self.stats.inc_value(<span class="string">'scheduler/dequeued/redis'</span>, <span class="attribute">spider</span>=self.spider)</span><br><span class="line">        return request</span><br><span class="line"></span><br><span class="line">    def has_pending_requests(self):</span><br><span class="line">        return len(self) &gt; 0</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p> 来先来看看 以上就是Scrapy-Redis中的SCHEDULER模块。下面我们来看看queue和本身的什么不同： scrapy_redis.queue.py 以最常用的优先级队列 PriorityQueue 举例： </p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PriorityQueue</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="string">"""Per-spider priority queue abstraction using redis' sorted set"""</span></span><br><span class="line">        <span class="string">"""其实就是使用Redis的有序集合 来对Request进行排序，这样就可以优先级高的在有序集合的顶层 我们只需要"""</span></span><br><span class="line">    <span class="string">"""从上往下依次获取Request即可"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return the length of the queue"""</span></span><br><span class="line">        <span class="keyword">return</span> self.server.zcard(self.key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""Push a request"""</span></span><br><span class="line">        <span class="string">"""添加一个Request进队列"""</span></span><br><span class="line">        <span class="comment"># self._encode_request 将Request请求进行序列化</span></span><br><span class="line">        data = self._encode_request(request)</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        d = &#123;</span></span><br><span class="line"><span class="string">        'url': to_unicode(request.url),  # urls should be safe (safe_string_url)</span></span><br><span class="line"><span class="string">        'callback': cb,</span></span><br><span class="line"><span class="string">        'errback': eb,</span></span><br><span class="line"><span class="string">        'method': request.method,</span></span><br><span class="line"><span class="string">        'headers': dict(request.headers),</span></span><br><span class="line"><span class="string">        'body': request.body,</span></span><br><span class="line"><span class="string">        'cookies': request.cookies,</span></span><br><span class="line"><span class="string">        'meta': request.meta,</span></span><br><span class="line"><span class="string">        '_encoding': request._encoding,</span></span><br><span class="line"><span class="string">        'priority': request.priority,</span></span><br><span class="line"><span class="string">        'dont_filter': request.dont_filter,</span></span><br><span class="line"><span class="string">        'flags': request.flags,</span></span><br><span class="line"><span class="string">        '_class': request.__module__ + '.' + request.__class__.__name__</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        data就是上面这个字典的序列化</span></span><br><span class="line"><span class="string">        在Scrapy.utils.reqser.py 中的request_to_dict方法中处理</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在Redis有序集合中数值越小优先级越高(就是会被放在顶层)所以这个位置是取得 相反数</span></span><br><span class="line">        score = -request.priority</span><br><span class="line">        <span class="comment"># We don't use zadd method as the order of arguments change depending on</span></span><br><span class="line">        <span class="comment"># whether the class is Redis or StrictRedis, and the option of using</span></span><br><span class="line">        <span class="comment"># kwargs only accepts strings, not bytes.</span></span><br><span class="line">        <span class="comment"># ZADD 是添加进有序集合</span></span><br><span class="line">        self.server.execute_command(<span class="string">'ZADD'</span>, self.key, score, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, timeout=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Pop a request</span></span><br><span class="line"><span class="string">        timeout not support in this queue class</span></span><br><span class="line"><span class="string">        有序集合不支持超时所以就木有使用timeout了  这个timeout就是挂羊头卖狗肉</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">"""从有序集合中取出一个Request"""</span></span><br><span class="line">        <span class="comment"># use atomic range/remove using multi/exec</span></span><br><span class="line">        <span class="string">"""使用multi的原因是为了将获取Request和删除Request合并成一个操作(原子性的)在获取到一个元素之后 删除它，因为有序集合 不像list 有pop 这种方式啊"""</span></span><br><span class="line">        pipe = self.server.pipeline()</span><br><span class="line">        pipe.multi()</span><br><span class="line">        <span class="comment"># 取出 顶层第一个</span></span><br><span class="line">        <span class="comment"># zrange :返回有序集 key 中，指定区间内的成员。0,0 就是第一个了</span></span><br><span class="line">        <span class="comment"># zremrangebyrank：移除有序集 key 中，指定排名(rank)区间内的所有成员 0，0也就是第一个了</span></span><br><span class="line">        <span class="comment"># 更多请参考Redis官方文档</span></span><br><span class="line">        pipe.zrange(self.key, <span class="number">0</span>, <span class="number">0</span>).zremrangebyrank(self.key, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        results, count = pipe.execute()</span><br><span class="line">        <span class="keyword">if</span> results:</span><br><span class="line">            <span class="keyword">return</span> self._decode_request(results[<span class="number">0</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p> 以上就是SCHEDULER在处理Request的时候做的操作了。 是时候来看看SCHEDULER是怎么处理去重的了！ 只需要注意这个?方法即可：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_seen</span><span class="params">(self, request)</span>:</span></span><br><span class="line">  <span class="string">"""Returns True if request was already seen.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        request : scrapy.http.Request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns</span></span><br><span class="line"><span class="string">        -------</span></span><br><span class="line"><span class="string">        bool</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">  <span class="comment"># 通过self.request_fingerprint 会生一个sha1的指纹</span></span><br><span class="line">  fp = self.request_fingerprint(request)</span><br><span class="line">  <span class="comment"># This returns the number of values added, zero if already exists.</span></span><br><span class="line">  <span class="comment"># 添加进一个Redis集合如果self.key这个集合中存在fp这个指纹会返回1  不存在返回0</span></span><br><span class="line">  added = self.server.sadd(self.key, fp)</span><br><span class="line">  <span class="keyword">return</span> added == <span class="number">0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <pre><code>这样大家就都可以访问同一个Redis 获取同一个spider的Request 在同一个位置去重，就不用担心重复啦 大概就像这样：
</code></pre>
                  <ol>
                    <li>spider1：检查一下这个Request是否在Redis去重，如果在就证明其它的spider采集过啦！如果不在就添加进调度队列，等待别 人获取。自己继续干活抓取网页 产生新的Request了 重复之前步骤。</li>
                    <li>spider2：以相同的逻辑执行</li>
                  </ol>
                  <p>可能有些小伙儿会产生疑问了~~！spider2拿到了别人的Request了 怎么能正确的执行呢？逻辑不会错吗？ 这个不用担心啦 因为整Request当中包含了，所有的逻辑，回去看看上面那个序列化的字典。 总结一下：</p>
                  <ol>
                    <li>1. Scrapy-Reids 就是将Scrapy原本在内存中处理的 调度(就是一个队列Queue)、去重、这两个操作通过Redis来实现</li>
                    <li>多个Scrapy在采集同一个站点时会使用相同的redis key（可以理解为队列）添加Request 获取Request 去重Request，这样所有的spider不会进行重复采集。效率自然就嗖嗖的上去了。</li>
                    <li>3. Redis是原子性的，好处不言而喻(一个Request要么被处理 要么没被处理，不存在第三可能)</li>
                  </ol>
                  <p>另外Scrapy-Redis本身不支持Redis-Cluster，大量网站去重的话会给单机很大的压力（就算使用boolfilter 内存也不够整啊！） 改造方式很简单：</p>
                  <ol>
                    <li>使用 <strong><strong>rediscluster</strong></strong> 这个包替换掉本身的Redis连接</li>
                    <li>Redis-Cluster 不支持事务，可以使用lua脚本进行代替（lua脚本是原子性的哦）</li>
                    <li><strong><strong>注意使用lua脚本 不能写占用时间很长的操作</strong></strong>（毕竟一大群人等着操作Redis 你总不能让人家等着吧）</li>
                  </ol>
                  <p>以上！完毕 对于懒人小伙伴儿 看看这个我改好的: <a href="https://github.com/thsheep/scrapy_redis_cluster" target="_blank" rel="noopener">集群版Scrapy-Redis</a> <strong><strong>PS: 支持Python3.6+ 哦 ！ 其余的版本没测试过</strong></strong> <img src="https://thsheep-wordpress.oss-cn-beijing.aliyuncs.com/4a99cdf73bef5f5aaaa4ec9f61b8d838.jpg" alt=""></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-06-06 09:10:29" itemprop="dateCreated datePublished" datetime="2018-06-06T09:10:29+08:00">2018-06-06</time>
                </span>
                <span id="/6058.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶之Scrapy第六篇Scrapy-Redis详解" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>14k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>13 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6080.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6080.html" class="post-title-link" itemprop="url">Python中logging模块的基本用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在 PyCon 2018 上，Mario Corchero 介绍了在开发过程中如何更方便轻松地记录日志的流程。</p>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/6/3/163c61861faf256f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
                  <p>整个演讲的内容包括：</p>
                  <ul>
                    <li>为什么日志记录非常重要</li>
                    <li>日志记录的流程是怎样的</li>
                    <li>怎样来进行日志记录</li>
                    <li>怎样进行日志记录相关配置</li>
                    <li>日志记录使用常见误区</li>
                  </ul>
                  <p>下面我们来梳理一下整个演讲的过程，其实其核心就是介绍了 logging 模块的使用方法和一些配置。</p>
                  <h2 id="日志记录的重要性"><a href="#日志记录的重要性" class="headerlink" title="日志记录的重要性"></a>日志记录的重要性</h2>
                  <p>在开发过程中，如果程序运行出现了问题，我们是可以使用我们自己的 Debug 工具来检测到到底是哪一步出现了问题，如果出现了问题的话，是很容易排查的。但程序开发完成之后，我们会将它部署到生产环境中去，这时候代码相当于是在一个黑盒环境下运行的，我们只能看到其运行的效果，是不能直接看到代码运行过程中每一步的状态的。在这个环境下，运行过程中难免会在某个地方出现问题，甚至这个问题可能是我们开发过程中未曾遇到的问题，碰到这种情况应该怎么办？ 如果我们现在只能得知当前问题的现象，而没有其他任何信息的话，如果我们想要解决掉这个问题的话，那么只能根据问题的现象来试图复现一下，然后再一步步去调试，这恐怕是很难的，很大的概率上我们是无法精准地复现这个问题的，而且 Debug 的过程也会耗费巨多的时间，这样一旦生产环境上出现了问题，修复就会变得非常棘手。但这如果我们当时有做日志记录的话，不论是正常运行还是出现报错，都有相关的时间记录，状态记录，错误记录等，那么这样我们就可以方便地追踪到在当时的运行过程中出现了怎样的状况，从而可以快速排查问题。 因此，日志记录是非常有必要的，任何一款软件如果没有标准的日志记录，都不能算作一个合格的软件。作为开发者，我们需要重视并做好日志记录过程。</p>
                  <h2 id="日志记录的流程框架"><a href="#日志记录的流程框架" class="headerlink" title="日志记录的流程框架"></a>日志记录的流程框架</h2>
                  <p>那么在 Python 中，怎样才能算作一个比较标准的日志记录过程呢？或许很多人会使用 print 语句输出一些运行信息，然后再在控制台观察，运行的时候再将输出重定向到文件输出流保存到文件中，这样其实是非常不规范的，在 Python 中有一个标准的 logging 模块，我们可以使用它来进行标注的日志记录，利用它我们可以更方便地进行日志记录，同时还可以做更方便的级别区分以及一些额外日志信息的记录，如时间、运行模块信息等。 接下来我们先了解一下日志记录流程的整体框架。 <img src="https://user-gold-cdn.xitu.io/2018/6/3/163c618941cfc03f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""> 如图所示，整个日志记录的框架可以分为这么几个部分：</p>
                  <ul>
                    <li>Logger：即 Logger Main Class，是我们进行日志记录时创建的对象，我们可以调用它的方法传入日志模板和信息，来生成一条条日志记录，称作 Log Record。</li>
                    <li>Log Record：就代指生成的一条条日志记录。</li>
                    <li>Handler：即用来处理日志记录的类，它可以将 Log Record 输出到我们指定的日志位置和存储形式等，如我们可以指定将日志通过 FTP 协议记录到远程的服务器上，Handler 就会帮我们完成这些事情。</li>
                    <li>Formatter：实际上生成的 Log Record 也是一个个对象，那么我们想要把它们保存成一条条我们想要的日志文本的话，就需要有一个格式化的过程，那么这个过程就由 Formatter 来完成，返回的就是日志字符串，然后传回给 Handler 来处理。</li>
                    <li>Filter：另外保存日志的时候我们可能不需要全部保存，我们可能只需要保存我们想要的部分就可以了，所以保存前还需要进行一下过滤，留下我们想要的日志，如只保存某个级别的日志，或只保存包含某个关键字的日志等，那么这个过滤过程就交给 Filter 来完成。</li>
                    <li>Parent Handler：Handler 之间可以存在分层关系，以使得不同 Handler 之间共享相同功能的代码。</li>
                  </ul>
                  <p>以上就是整个 logging 模块的基本架构和对象功能，了解了之后我们详细来了解一下 logging 模块的用法。</p>
                  <h2 id="日志记录的相关用法"><a href="#日志记录的相关用法" class="headerlink" title="日志记录的相关用法"></a>日志记录的相关用法</h2>
                  <p>总的来说 logging 模块相比 print 有这么几个优点：</p>
                  <ul>
                    <li>可以在 logging 模块中设置日志等级，在不同的版本（如开发环境、生产环境）上通过设置不同的输出等级来记录对应的日志，非常灵活。</li>
                    <li>print 的输出信息都会输出到标准输出流中，而 logging 模块就更加灵活，可以设置输出到任意位置，如写入文件、写入远程服务器等。</li>
                    <li>logging 模块具有灵活的配置和格式化功能，如配置输出当前模块信息、运行时间等，相比 print 的字符串格式化更加方便易用。</li>
                  </ul>
                  <p>下面我们初步来了解下 logging 模块的基本用法，先用一个实例来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="attribute">level</span>=logging.INFO, <span class="attribute">format</span>=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'This is a log info'</span>)</span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Debugging'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Warning exists'</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finish'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们首先引入了 logging 模块，然后进行了一下基本的配置，这里通过 basicConfig 配置了 level 信息和 format 信息，这里 level 配置为 INFO 信息，即只输出 INFO 级别的信息，另外这里指定了 format 格式的字符串，包括 asctime、name、levelname、message 四个内容，分别代表运行时间、模块名称、日志级别、日志内容，这样输出内容便是这四者组合而成的内容了，这就是 logging 的全局配置。 接下来声明了一个 Logger 对象，它就是日志输出的主类，调用对象的 info() 方法就可以输出 INFO 级别的日志信息，调用 debug() 方法就可以输出 DEBUG 级别的日志信息，非常方便。在初始化的时候我们传入了模块的名称，这里直接使用 <strong>name</strong> 来代替了，就是模块的名称，如果直接运行这个脚本的话就是 <strong>main</strong>，如果是 import 的模块的话就是被引入模块的名称，这个变量在不同的模块中的名字是不同的，所以一般使用 <strong>name</strong> 来表示就好了，再接下来输出了四条日志信息，其中有两条 INFO、一条 WARNING、一条 DEBUG 信息，我们看下输出结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">42</span>:<span class="number">43</span>,<span class="number">526</span> - __main__ - INFO - This <span class="keyword">is</span> a log info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">42</span>:<span class="number">43</span>,<span class="number">526</span> - __main__ - WARNING - Warning exists</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">42</span>:<span class="number">43</span>,<span class="number">526</span> - __main__ - INFO - Finish</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到输出结果一共有三条日志信息，每条日志都是对应了指定的格式化内容，另外我们发现 DEBUG 的信息是没有输出的，这是因为我们在全局配置的时候设置了输出为 INFO 级别，所以 DEBUG 级别的信息就被过滤掉了。 这时如果我们将输出的日志级别设置为 DEBUG，就可以看到 DEBUG 级别的日志输出了：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">logging.basic<span class="constructor">Config(<span class="params">level</span>=<span class="params">logging</span>.DEBUG, <span class="params">format</span>='%(<span class="params">asctime</span>)</span>s - %(name)s - %(levelname)s - %(message)s')</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">49</span>:<span class="number">22</span>,<span class="number">770</span> - __main__ - INFO - This <span class="keyword">is</span> a log info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">49</span>:<span class="number">22</span>,<span class="number">770</span> - __main__ - DEBUG - Debugging</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">49</span>:<span class="number">22</span>,<span class="number">770</span> - __main__ - WARNING - Warning exists</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">13</span>:<span class="number">49</span>:<span class="number">22</span>,<span class="number">770</span> - __main__ - INFO - Finish</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>由此可见，相比 print 来说，通过刚才的代码，我们既可以输出时间、模块名称，又可以输出不同级别的日志信息作区分并加以过滤，是不是灵活多了？ 当然这只是 logging 模块的一小部分功能，接下来我们首先来全面了解一下 basicConfig 的参数都有哪些：</p>
                  <ul>
                    <li>filename：即日志输出的文件名，如果指定了这个信息之后，实际上会启用 FileHandler，而不再是 StreamHandler，这样日志信息便会输出到文件中了。</li>
                    <li>filemode：这个是指定日志文件的写入方式，有两种形式，一种是 w，一种是 a，分别代表清除后写入和追加写入。</li>
                    <li>format：指定日志信息的输出格式，即上文示例所示的参数，详细参数可以参考：<a href="https://link.juejin.im?target=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Flogging.html%3Fhighlight%3Dlogging%2520threadname%23logrecord-attributes">docs.python.org/3/library/l…</a>，部分参数如下所示：<ul>
                        <li>%(levelno)s：打印日志级别的数值。</li>
                        <li>%(levelname)s：打印日志级别的名称。</li>
                        <li>%(pathname)s：打印当前执行程序的路径，其实就是sys.argv[0]。</li>
                        <li>%(filename)s：打印当前执行程序名。</li>
                        <li>%(funcName)s：打印日志的当前函数。</li>
                        <li>%(lineno)d：打印日志的当前行号。</li>
                        <li>%(asctime)s：打印日志的时间。</li>
                        <li>%(thread)d：打印线程ID。</li>
                        <li>%(threadName)s：打印线程名称。</li>
                        <li>%(process)d：打印进程ID。</li>
                        <li>%(processName)s：打印线程名称。</li>
                        <li>%(module)s：打印模块名称。</li>
                        <li>%(message)s：打印日志信息。</li>
                      </ul>
                    </li>
                    <li>datefmt：指定时间的输出格式。</li>
                    <li>style：如果 format 参数指定了，这个参数就可以指定格式化时的占位符风格，如 %、{、$ 等。</li>
                    <li>level：指定日志输出的类别，程序会输出大于等于此级别的信息。</li>
                    <li>stream：在没有指定 filename 的时候会默认使用 StreamHandler，这时 stream 可以指定初始化的文件流。</li>
                    <li>handlers：可以指定日志处理时所使用的 Handlers，必须是可迭代的。</li>
                  </ul>
                  <p>下面我们再用一个实例来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="attribute">level</span>=logging.DEBUG,</span><br><span class="line">                    <span class="attribute">filename</span>=<span class="string">'output.log'</span>,</span><br><span class="line">                    <span class="attribute">datefmt</span>=<span class="string">'%Y/%m/%d %H:%M:%S'</span>,</span><br><span class="line">                    <span class="attribute">format</span>=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(lineno)d - %(module)s - %(message)s'</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'This is a log info'</span>)</span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Debugging'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Warning exists'</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finish'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们指定了输出文件的名称为 output.log，另外指定了日期的输出格式，其中年月日的格式变成了 %Y/%m/%d，另外输出的 format 格式增加了 lineno、module 这两个信息，运行之后便会生成一个 output.log 的文件，内容如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">26</span> - __main__ - INFO - <span class="number">9</span> - demo3 - This <span class="keyword">is</span> a log info</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">26</span> - __main__ - DEBUG - <span class="number">10</span> - demo3 - Debugging</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">26</span> - __main__ - WARNING - <span class="number">11</span> - demo3 - Warning exists</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">26</span> - __main__ - INFO - <span class="number">12</span> - demo3 - Finish</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到日志便会输出到文件中，同时输出了行号、模块名称等信息。 以上我们通过 basicConfig 来进行了一些全局的配置，我们同样可以使用 Formatter、Handler 进行更灵活的处理，下面我们来了解一下。</p>
                  <h3 id="Level"><a href="#Level" class="headerlink" title="Level"></a>Level</h3>
                  <p>首先我们来了解一下输出日志的等级信息，logging 模块共提供了如下等级，每个等级其实都对应了一个数值，列表如下：</p>
                  <p>等级</p>
                  <p>数值</p>
                  <p>CRITICAL</p>
                  <p>50</p>
                  <p>FATAL</p>
                  <p>50</p>
                  <p>ERROR</p>
                  <p>40</p>
                  <p>WARNING</p>
                  <p>30</p>
                  <p>WARN</p>
                  <p>30</p>
                  <p>INFO</p>
                  <p>20</p>
                  <p>DEBUG</p>
                  <p>10</p>
                  <p>NOTSET</p>
                  <p>0</p>
                  <p>这里最高的等级是 CRITICAL 和 FATAL，两个对应的数值都是 50，另外对于 WARNING 还提供了简写形式 WARN，两个对应的数值都是 30。 我们设置了输出 level，系统便只会输出 level 数值大于或等于该 level 的的日志结果，例如我们设置了输出日志 level 为 INFO，那么输出级别大于等于 INFO 的日志，如 WARNING、ERROR 等，DEBUG 和 NOSET 级别的不会输出。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(<span class="attribute">level</span>=logging.WARN)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Debugging'</span>)</span><br><span class="line">logger.critical(<span class="string">'Critical Something'</span>)</span><br><span class="line">logger.<span class="builtin-name">error</span>(<span class="string">'Error Occurred'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Warning exists'</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finished'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们设置了输出级别为 WARN，然后对应输出了五种不同级别的日志信息，运行结果如下：</p>
                  <figure class="highlight subunit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Critical Something</span><br><span class="line"><span class="keyword">Error </span>Occurred</span><br><span class="line">Warning exists</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到只有 CRITICAL、ERROR、WARNING 信息输出了，DEBUG、INFO 信息没有输出。</p>
                  <h3 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h3>
                  <p>下面我们先来了解一下 Handler 的用法，看下面的实例：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(<span class="attribute">level</span>=logging.INFO)</span><br><span class="line">handler = logging.FileHandler(<span class="string">'output.log'</span>)</span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'This is a log info'</span>)</span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Debugging'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Warning exists'</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finish'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们没有再使用 basicConfig 全局配置，而是先声明了一个 Logger 对象，然后指定了其对应的 Handler 为 FileHandler 对象，然后 Handler 对象还单独指定了 Formatter 对象单独配置输出格式，最后给 Logger 对象添加对应的 Handler 即可，最后可以发现日志就会被输出到 output.log 中，内容如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">53</span>:<span class="number">36</span>,<span class="number">467</span> - __main__ - INFO - This <span class="keyword">is</span> a log info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">53</span>:<span class="number">36</span>,<span class="number">468</span> - __main__ - WARNING - Warning exists</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">53</span>:<span class="number">36</span>,<span class="number">468</span> - __main__ - INFO - Finish</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外我们还可以使用其他的 Handler 进行日志的输出，logging 模块提供的 Handler 有：</p>
                  <ul>
                    <li>StreamHandler：logging.StreamHandler；日志输出到流，可以是 sys.stderr，sys.stdout 或者文件。</li>
                    <li>FileHandler：logging.FileHandler；日志输出到文件。</li>
                    <li>BaseRotatingHandler：logging.handlers.BaseRotatingHandler；基本的日志回滚方式。</li>
                    <li>RotatingHandler：logging.handlers.RotatingHandler；日志回滚方式，支持日志文件最大数量和日志文件回滚。</li>
                    <li>TimeRotatingHandler：logging.handlers.TimeRotatingHandler；日志回滚方式，在一定时间区域内回滚日志文件。</li>
                    <li>SocketHandler：logging.handlers.SocketHandler；远程输出日志到TCP/IP sockets。</li>
                    <li>DatagramHandler：logging.handlers.DatagramHandler；远程输出日志到UDP sockets。</li>
                    <li>SMTPHandler：logging.handlers.SMTPHandler；远程输出日志到邮件地址。</li>
                    <li>SysLogHandler：logging.handlers.SysLogHandler；日志输出到syslog。</li>
                    <li>NTEventLogHandler：logging.handlers.NTEventLogHandler；远程输出日志到Windows NT/2000/XP的事件日志。</li>
                    <li>MemoryHandler：logging.handlers.MemoryHandler；日志输出到内存中的指定buffer。</li>
                    <li>HTTPHandler：logging.handlers.HTTPHandler；通过”GET”或者”POST”远程输出到HTTP服务器。</li>
                  </ul>
                  <p>下面我们使用三个 Handler 来实现日志同时输出到控制台、文件、HTTP 服务器：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers import HTTPHandler</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(<span class="attribute">level</span>=logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># StreamHandler</span></span><br><span class="line">stream_handler = logging.StreamHandler(sys.stdout)</span><br><span class="line">stream_handler.setLevel(<span class="attribute">level</span>=logging.DEBUG)</span><br><span class="line">logger.addHandler(stream_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileHandler</span></span><br><span class="line">file_handler = logging.FileHandler(<span class="string">'output.log'</span>)</span><br><span class="line">file_handler.setLevel(<span class="attribute">level</span>=logging.INFO)</span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">file_handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTPHandler</span></span><br><span class="line">http_handler = HTTPHandler(<span class="attribute">host</span>=<span class="string">'localhost:8001'</span>, <span class="attribute">url</span>=<span class="string">'log'</span>, <span class="attribute">method</span>=<span class="string">'POST'</span>)</span><br><span class="line">logger.addHandler(http_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'This is a log info'</span>)</span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Debugging'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Warning exists'</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finish'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行之前我们需要先启动 HTTP Server，并运行在 8001 端口，其中 log 接口是用来接收日志的接口。 运行之后控制台输出会输出如下内容：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">This <span class="keyword">is</span> a <span class="keyword">log</span> <span class="keyword">info</span></span><br><span class="line">Debugging</span><br><span class="line"><span class="built_in">Warning</span> <span class="keyword">exists</span></span><br><span class="line">Finish</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>output.log 文件会写入如下内容：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">15</span>:<span class="number">13</span>:<span class="number">44</span>,<span class="number">895</span> - __main__ - INFO - This <span class="keyword">is</span> a log info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">15</span>:<span class="number">13</span>:<span class="number">44</span>,<span class="number">947</span> - __main__ - WARNING - Warning exists</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">15</span>:<span class="number">13</span>:<span class="number">44</span>,<span class="number">949</span> - __main__ - INFO - Finish</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>HTTP Server 会收到控制台输出的信息。 这样一来，我们就通过设置多个 Handler 来控制了日志的多目标输出。 另外值得注意的是，在这里 StreamHandler 对象我们没有设置 Formatter，因此控制台只输出了日志的内容，而没有包含时间、模块等信息，而 FileHandler 我们通过 setFormatter() 方法设置了一个 Formatter 对象，因此输出的内容便是格式化后的日志信息。 另外每个 Handler 还可以设置 level 信息，最终输出结果的 level 信息会取 Logger 对象的 level 和 Handler 对象的 level 的交集。</p>
                  <h3 id="Formatter"><a href="#Formatter" class="headerlink" title="Formatter"></a>Formatter</h3>
                  <p>在进行日志格式化输出的时候，我们可以不借助于 basicConfig 来全局配置格式化输出内容，可以借助于 Formatter 来完成，下面我们再来单独看下 Formatter 的用法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(<span class="attribute">level</span>=logging.WARN)</span><br><span class="line">formatter = logging.Formatter(<span class="attribute">fmt</span>=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>, <span class="attribute">datefmt</span>=<span class="string">'%Y/%m/%d %H:%M:%S'</span>)</span><br><span class="line">handler = logging.StreamHandler()</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Debugging'</span>)</span><br><span class="line">logger.critical(<span class="string">'Critical Something'</span>)</span><br><span class="line">logger.<span class="builtin-name">error</span>(<span class="string">'Error Occurred'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Warning exists'</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finished'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们指定了一个 Formatter，并传入了 fmt 和 datefmt 参数，这样就指定了日志结果的输出格式和时间格式，然后 handler 通过 setFormatter() 方法设置此 Formatter 对象即可，输出结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">15</span> - __main__ - CRITICAL - Critical Something</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">15</span> - __main__ - ERROR - Error Occurred</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">03</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">15</span> - __main__ - WARNING - Warning exists</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们可以每个 Handler 单独配置输出的格式，非常灵活。</p>
                  <h3 id="捕获-Traceback"><a href="#捕获-Traceback" class="headerlink" title="捕获 Traceback"></a>捕获 Traceback</h3>
                  <p>如果遇到错误，我们更希望报错时出现的详细 Traceback 信息，便于调试，利用 logging 模块我们可以非常方便地实现这个记录，我们用一个实例来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(<span class="attribute">level</span>=logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Formatter</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileHandler</span></span><br><span class="line">file_handler = logging.FileHandler(<span class="string">'result.log'</span>)</span><br><span class="line">file_handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># StreamHandler</span></span><br><span class="line">stream_handler = logging.StreamHandler()</span><br><span class="line">stream_handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(stream_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Start'</span>)</span><br><span class="line">logger.<span class="builtin-name">warning</span>(<span class="string">'Something maybe fail.'</span>)</span><br><span class="line">try:</span><br><span class="line">    result = 10 / 0</span><br><span class="line">except Exception:</span><br><span class="line">    logger.<span class="builtin-name">error</span>(<span class="string">'Faild to get result'</span>, <span class="attribute">exc_info</span>=<span class="literal">True</span>)</span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Finished'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们在 error() 方法中添加了一个参数，将 exc_info 设置为了 True，这样我们就可以输出执行过程中的信息了，即完整的 Traceback 信息。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">00</span>:<span class="number">15</span>,<span class="number">382</span> - __main__ - INFO - Start print log</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">00</span>:<span class="number">15</span>,<span class="number">382</span> - __main__ - DEBUG - Do something</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">00</span>:<span class="number">15</span>,<span class="number">382</span> - __main__ - WARNING - Something maybe fail.</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">00</span>:<span class="number">15</span>,<span class="number">382</span> - __main__ - ERROR - Faild to <span class="keyword">get</span> result</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/private/var/books/aicodes/loggingtest/demo8.py"</span>, line <span class="number">23</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line">ZeroDivisionError: division by zero</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">00</span>:<span class="number">15</span>,<span class="number">383</span> - __main__ - INFO - Finished</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到这样我们就非常方便地记录下来了报错的信息，一旦出现了错误，我们也能非常方便地排查。</p>
                  <h3 id="配置共享"><a href="#配置共享" class="headerlink" title="配置共享"></a>配置共享</h3>
                  <p>在写项目的时候，我们肯定会将许多配置放置在许多模块下面，这时如果我们每个文件都来配置 logging 配置那就太繁琐了，logging 模块提供了父子模块共享配置的机制，会根据 Logger 的名称来自动加载父模块的配置。 例如我们这里首先定义一个 main.py 文件：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line">import core</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'main'</span>)</span><br><span class="line">logger.setLevel(<span class="attribute">level</span>=logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Handler</span></span><br><span class="line">handler = logging.FileHandler(<span class="string">'result.log'</span>)</span><br><span class="line">handler.setLevel(logging.INFO)</span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">logger.<span class="builtin-name">info</span>(<span class="string">'Main Info'</span>)</span><br><span class="line">logger.<span class="builtin-name">debug</span>(<span class="string">'Main Debug'</span>)</span><br><span class="line">logger.<span class="builtin-name">error</span>(<span class="string">'Main Error'</span>)</span><br><span class="line">core.<span class="builtin-name">run</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们配置了日志的输出格式和文件路径，同时定义了 Logger 的名称为 main，然后引入了另外一个模块 core，最后调用了 core 的 run() 方法。 接下来我们定义 core.py，内容如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'main.core'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="builtin-name">run</span>():</span><br><span class="line">    logger.<span class="builtin-name">info</span>(<span class="string">'Core Info'</span>)</span><br><span class="line">    logger.<span class="builtin-name">debug</span>(<span class="string">'Core Debug'</span>)</span><br><span class="line">    logger.<span class="builtin-name">error</span>(<span class="string">'Core Error'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们定义了 Logger 的名称为 main.core，注意这里开头是 main，即刚才我们在 main.py 里面的 Logger 的名称，这样 core.py 里面的 Logger 就会复用 main.py 里面的 Logger 配置，而不用再去配置一次了。 运行之后会生成一个 result.log 文件，内容如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">56</span>,<span class="number">259</span> - main - INFO - Main Info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">56</span>,<span class="number">259</span> - main - ERROR - Main Error</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">56</span>,<span class="number">259</span> - main.core - INFO - Core Info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">56</span>,<span class="number">259</span> - main.core - ERROR - Core Error</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到父子模块都使用了同样的输出配置。 如此一来，我们只要在入口文件里面定义好 logging 模块的输出配置，子模块只需要在定义 Logger 对象时名称使用父模块的名称开头即可共享配置，非常方便。</p>
                  <h3 id="文件配置"><a href="#文件配置" class="headerlink" title="文件配置"></a>文件配置</h3>
                  <p>在开发过程中，将配置在代码里面写死并不是一个好的习惯，更好的做法是将配置写在配置文件里面，我们可以将配置写入到配置文件，然后运行时读取配置文件里面的配置，这样是更方便管理和维护的，下面我们以一个实例来说明一下，首先我们定义一个 yaml 配置文件：</p>
                  <figure class="highlight less">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">version</span>: <span class="number">1</span></span><br><span class="line"><span class="attribute">formatters</span>:</span><br><span class="line">  <span class="attribute">brief</span>:</span><br><span class="line">    <span class="attribute">format</span>: <span class="string">"%(asctime)s - %(message)s"</span></span><br><span class="line">  <span class="attribute">simple</span>:</span><br><span class="line">    <span class="attribute">format</span>: <span class="string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span></span><br><span class="line"><span class="attribute">handlers</span>:</span><br><span class="line">  <span class="attribute">console</span>:</span><br><span class="line">    <span class="attribute">class </span>: logging.StreamHandler</span><br><span class="line">    <span class="attribute">formatter</span>: brief</span><br><span class="line">    <span class="attribute">level   </span>: INFO</span><br><span class="line">    <span class="attribute">stream  </span>: <span class="attribute">ext</span>:<span class="comment">//sys.stdout</span></span><br><span class="line">  <span class="attribute">file</span>:</span><br><span class="line">    <span class="attribute">class </span>: logging.FileHandler</span><br><span class="line">    <span class="attribute">formatter</span>: simple</span><br><span class="line">    <span class="attribute">level</span>: DEBUG</span><br><span class="line">    <span class="attribute">filename</span>: debug.log</span><br><span class="line">  <span class="attribute">error</span>:</span><br><span class="line">    <span class="attribute">class</span>: logging.handlers.RotatingFileHandler</span><br><span class="line">    <span class="attribute">level</span>: ERROR</span><br><span class="line">    <span class="attribute">formatter</span>: simple</span><br><span class="line">    <span class="attribute">filename</span>: error.log</span><br><span class="line">    <span class="attribute">maxBytes</span>: <span class="number">10485760</span></span><br><span class="line">    <span class="attribute">backupCount</span>: <span class="number">20</span></span><br><span class="line">    <span class="attribute">encoding</span>: utf8</span><br><span class="line"><span class="attribute">loggers</span>:</span><br><span class="line">  main.<span class="attribute">core</span>:</span><br><span class="line">    <span class="attribute">level</span>: DEBUG</span><br><span class="line">    <span class="attribute">handlers</span>: [console, file, error]</span><br><span class="line"><span class="attribute">root</span>:</span><br><span class="line">  <span class="attribute">level</span>: DEBUG</span><br><span class="line">  <span class="attribute">handlers</span>: [console]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们定义了 formatters、handlers、loggers、root 等模块，实际上对应的就是各个 Formatter、Handler、Logger 的配置，参数和它们的构造方法都是相同的。 接下来我们定义一个主入口文件，main.py，内容如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line">import core</span><br><span class="line">import yaml</span><br><span class="line">import logging.config</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def setup_logging(<span class="attribute">default_path</span>=<span class="string">'config.yaml'</span>, <span class="attribute">default_level</span>=logging.INFO):</span><br><span class="line">    path = default_path</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(path):</span><br><span class="line">        with open(path, <span class="string">'r'</span>, <span class="attribute">encoding</span>=<span class="string">'utf-8'</span>) as f:</span><br><span class="line">           <span class="built_in"> config </span>= yaml.load(f)</span><br><span class="line">            logging.config.dictConfig(config)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.basicConfig(<span class="attribute">level</span>=default_level)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def log():</span><br><span class="line">    logging.<span class="builtin-name">debug</span>(<span class="string">'Start'</span>)</span><br><span class="line">    logging.<span class="builtin-name">info</span>(<span class="string">'Exec'</span>)</span><br><span class="line">    logging.<span class="builtin-name">info</span>(<span class="string">'Finished'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    yaml_path = <span class="string">'config.yaml'</span></span><br><span class="line">    setup_logging(yaml_path)</span><br><span class="line">    log()</span><br><span class="line">    core.<span class="builtin-name">run</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们定义了一个 setup_logging() 方法，里面读取了 yaml 文件的配置，然后通过 dictConfig() 方法将配置项传给了 logging 模块进行全局初始化。 另外这个模块还引入了另外一个模块 core，所以我们定义 core.py 如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'main.core'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="builtin-name">run</span>():</span><br><span class="line">    logger.<span class="builtin-name">info</span>(<span class="string">'Core Info'</span>)</span><br><span class="line">    logger.<span class="builtin-name">debug</span>(<span class="string">'Core Debug'</span>)</span><br><span class="line">    logger.<span class="builtin-name">error</span>(<span class="string">'Core Error'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个文件的内容和上文是没有什么变化的。 观察配置文件，主入口文件 main.py 实际上对应的是 root 一项配置，它指定了 handlers 是 console，即只输出到控制台。另外在 loggers 一项配置里面，我们定义了 main.core 模块，handlers 是 console、file、error 三项，即输出到控制台、输出到普通文件和回滚文件。 这样运行之后，我们便可以看到所有的运行结果输出到了控制台：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">727</span> - Exec</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">727</span> - Finished</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">727</span> - Core Info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">727</span> - Core Info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">728</span> - Core Error</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">728</span> - Core Error</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在 debug.log 文件中则包含了 core.py 的运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">727</span> - main.core - INFO - Core Info</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">727</span> - main.core - DEBUG - Core Debug</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">12</span>,<span class="number">728</span> - main.core - ERROR - Core Error</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，通过配置文件，我们可以非常灵活地定义 Handler、Formatter、Logger 等配置，同时也显得非常直观，也非常容易维护，在实际项目中，推荐使用此种方式进行配置。 以上便是 logging 模块的基本使用方法，有了它，我们可以方便地进行日志管理和维护，会给我们的工作带来极大的方便。</p>
                  <h2 id="日志记录使用常见误区"><a href="#日志记录使用常见误区" class="headerlink" title="日志记录使用常见误区"></a>日志记录使用常见误区</h2>
                  <p>在日志输出的时候经常我们会用到字符串拼接的形式，很多情况下我们可能会使用字符串的 format() 来构造一个字符串，但这其实并不是一个好的方法，因为还有更好的方法，下面我们对比两个例子：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="attribute">level</span>=logging.DEBUG, <span class="attribute">format</span>=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bad</span></span><br><span class="line">logging.<span class="builtin-name">debug</span>(<span class="string">'Hello &#123;0&#125;, &#123;1&#125;!'</span>.format(<span class="string">'World'</span>, <span class="string">'Congratulations'</span>))</span><br><span class="line"><span class="comment"># good</span></span><br><span class="line">logging.<span class="builtin-name">debug</span>(<span class="string">'Hello %s, %s!'</span>, <span class="string">'World'</span>, <span class="string">'Congratulations'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里有两种打印 Log 的方法，第一种使用了字符串的 format() 的方法进行构造，传给 logging 的只用到了第一个参数，实际上 logging 模块提供了字符串格式化的方法，我们只需要在第一个参数写上要打印输出的模板，占位符用 %s、%d 等表示即可，然后在后续参数添加对应的值就可以了，推荐使用这种方法。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">22</span>:<span class="number">27</span>:<span class="number">51</span>,<span class="number">220</span> - root - DEBUG - Hello World, Congratulations!</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">22</span>:<span class="number">27</span>:<span class="number">51</span>,<span class="number">220</span> - root - DEBUG - Hello World, Congratulations!</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/6/3/163c618ce73174a9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
                  <p>另外在进行异常处理的时候，通常我们会直接将异常进行字符串格式化，但其实可以直接指定一个参数将 traceback 打印出来，示例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="attribute">level</span>=logging.DEBUG, <span class="attribute">format</span>=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    result = 5 / 0</span><br><span class="line">except Exception as e:</span><br><span class="line">    # bad</span><br><span class="line">    logging.<span class="builtin-name">error</span>(<span class="string">'Error: %s'</span>, e)</span><br><span class="line">    # good</span><br><span class="line">    logging.<span class="builtin-name">error</span>(<span class="string">'Error'</span>, <span class="attribute">exc_info</span>=<span class="literal">True</span>)</span><br><span class="line">    # good</span><br><span class="line">    logging.exception(<span class="string">'Error'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果我们直接使用字符串格式化的方法将错误输出的话，是不会包含 Traceback 信息的，但如果我们加上 exc_info 参数或者直接使用 exception() 方法打印的话，那就会输出 Traceback 信息了。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">22</span>:<span class="number">24</span>:<span class="number">31</span>,<span class="number">927</span> - root - ERROR - Error: division by zero</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">22</span>:<span class="number">24</span>:<span class="number">31</span>,<span class="number">927</span> - root - ERROR - Error</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/private/var/books/aicodes/loggingtest/demo9.py"</span>, line <span class="number">6</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    result = <span class="number">5</span> / <span class="number">0</span></span><br><span class="line">ZeroDivisionError: division by zero</span><br><span class="line"><span class="number">2018</span><span class="number">-06</span><span class="number">-03</span> <span class="number">22</span>:<span class="number">24</span>:<span class="number">31</span>,<span class="number">928</span> - root - ERROR - Error</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/private/var/books/aicodes/loggingtest/demo9.py"</span>, line <span class="number">6</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    result = <span class="number">5</span> / <span class="number">0</span></span><br><span class="line">ZeroDivisionError: division by zero</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/6/3/163c618f69092989?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
                  <p>以上便是整个对 logging 模块的介绍。嗯，是时候抛弃 print 了，开始体验下 logging 的便利吧！</p>
                  <h2 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h2>
                  <ul>
                    <li><a href="https://docs.python.org/3/library/logging.html" target="_blank" rel="noopener">https://docs.python.org/3/library/logging.html</a> * <a href="http://www.cnblogs.com/dahu-daqing/p/7040764.html" target="_blank" rel="noopener">http://www.cnblogs.com/dahu-daqing/p/7040764.html</a></li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-06-03 23:38:38" itemprop="dateCreated datePublished" datetime="2018-06-03T23:38:38+08:00">2018-06-03</time>
                </span>
                <span id="/6080.html" class="post-meta-item leancloud_visitors" data-flag-title="Python中logging模块的基本用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>16k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>14 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6009.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6009.html" class="post-title-link" itemprop="url">《Python3网络爬虫开发实战》来了！</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>嗨~ 给大家重磅推荐一本新书！还未上市前就已经重印 3 次的 Python 爬虫书！那么它就是由静觅博客博主崔庆才所作的《Python3网络爬虫开发实战》！！！ <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/05/Python-3网格爬虫开发实战-立体图-857x1100-857x1100.jpg" alt=""></p>
                  <h2 id="书籍介绍"><a href="#书籍介绍" class="headerlink" title="书籍介绍"></a><strong>书籍介绍</strong></h2>
                  <p>本书<strong>《Python3网络爬虫开发实战》</strong>全面介绍了利用 Python3 开发网络爬虫的知识，书中首先详细介绍了各种类型的环境配置过程和爬虫基础知识，还讨论了 urllib、requests 等请求库和 Beautiful Soup、XPath、pyquery 等解析库以及文本和各类数据库的存储方法，另外本书通过多个真实新鲜案例介绍了分析 Ajax 进行数据爬取，Selenium 和 Splash 进行动态网站爬取的过程，接着又分享了一些切实可行的爬虫技巧，比如使用代理爬取和维护动态代理池的方法、ADSL 拨号代理的使用、各类验证码（图形、极验、点触、宫格等）的破解方法、模拟登录网站爬取的方法及 Cookies 池的维护等等。 此外，本书的内容还远远不止这些，作者还结合移动互联网的特点探讨了使用 Charles、mitmdump、Appium 等多种工具实现 App 抓包分析、加密参数接口爬取、微信朋友圈爬取的方法。此外本书还详细介绍了 pyspider 框架、Scrapy 框架的使用和分布式爬虫的知识，另外对于优化及部署工作，本书还包括 Bloom Filter 效率优化、Docker 和 Scrapyd 爬虫部署、分布式爬虫管理框架Gerapy 的分享。 全书共 604 页，足足两斤重呢~ 定价为 99 元！</p>
                  <h2 id="作者介绍"><a href="#作者介绍" class="headerlink" title="作者介绍"></a><strong>作者介绍</strong></h2>
                  <p>看书就先看看谁写的嘛，我们来了解一下~ 崔庆才，静觅博客博主（<a href="https://cuiqingcai.com），博客" target="_blank" rel="noopener">https://cuiqingcai.com），博客</a> Python 爬虫博文已过百万，北京航空航天大学硕士，微软小冰大数据工程师，有多个大型分布式爬虫项目经验，乐于技术分享，文章通俗易懂 ^<em>^ 附皂片一张 ~(@^</em>^@)~ <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/06/WechatIMG785-825x1100.jpeg" alt=""></p>
                  <h2 id="图文介绍"><a href="#图文介绍" class="headerlink" title="图文介绍"></a><strong>图文介绍</strong></h2>
                  <p>呕心沥血设计的宣传图也得放一下~ <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/06/WechatIMG556.jpeg" alt=""></p>
                  <h2 id="专家评论"><a href="#专家评论" class="headerlink" title="专家评论"></a><strong>专家评论</strong></h2>
                  <p>书是好是坏，得让专家看评一评呀，那么下面就是几位专家的精彩评论，快来看看吧~ 在互联网软件开发工程师的分类中，爬虫工程师是非常重要的。爬虫工作往往是一个公司核心业务开展的基础，数据抓取下来，才有后续的加工处理和最终展现。此时数据的抓取规模、稳定性、实时性、准确性就显得非常重要。早期的互联网充分开放互联，数据获取的难度很小。随着各大公司对数据资产日益看重，反爬水平也在不断提高，各种新技术不断给爬虫软件提出新的课题。本书作者对爬虫的各个领域都有深刻研究，书中探讨了Ajax数据的抓取、动态渲染页面的抓取、验证码识别、模拟登录等高级话题，同时也结合移动互联网的特点探讨了App的抓取等。更重要的是，本书提供了大量源码，可以帮助读者更好地理解相关内容。强烈推荐给各位技术爱好者阅读！</p>
                  <p><strong>——梁斌</strong>，八友科技总经理</p>
                  <p>数据既是当今大数据分析的前提，也是各种人工智能应用场景的基础。得数据者得天下，会爬虫者走遍天下也不怕！一册在手，让小白到老司机都能有所收获！</p>
                  <p><strong>——李舟军</strong>，北京航空航天大学教授，博士生导师</p>
                  <p>本书从爬虫入门到分布式抓取，详细介绍了爬虫技术的各个要点，并针对不同的场景提出了对应的解决方案。另外，书中通过大量的实例来帮助读者更好地学习爬虫技术，通俗易懂，干货满满。强烈推荐给大家！</p>
                  <p><strong>——宋睿华</strong>，微软小冰首席科学家</p>
                  <p>有人说中国互联网的带宽全给各种爬虫占据了，这说明网络爬虫的重要性以及中国互联网数据封闭垄断的现状。爬是一种能力，爬是为了不爬。</p>
                  <p><strong>——施水才</strong>，北京拓尔思信息技术股份有限公司总裁</p>
                  <h2 id="全书目录"><a href="#全书目录" class="headerlink" title="全书目录"></a><strong>全书目录</strong></h2>
                  <p>书的目录也有~ 看这里！</p>
                  <ul>
                    <li><strong>1-开发环境配置</strong></li>
                    <li>1.1-Python3的安装</li>
                    <li>1.2-请求库的安装</li>
                    <li>1.3-解析库的安装</li>
                    <li>1.4-数据库的安装</li>
                    <li>1.5-存储库的安装</li>
                    <li>1.6-Web库的安装</li>
                    <li>1.7-App爬取相关库的安装</li>
                    <li>1.8-爬虫框架的安装</li>
                    <li>1.9-部署相关库的安装</li>
                    <li><strong>2-爬虫基础</strong></li>
                    <li>2.1-HTTP基本原理</li>
                    <li>2.2-网页基础</li>
                    <li>2.3-爬虫的基本原理</li>
                    <li>2.4-会话和Cookies</li>
                    <li>2.5-代理的基本原理</li>
                    <li><strong>3-基本库的使用</strong></li>
                    <li>3.1-使用urllib</li>
                    <li>3.1.1-发送请求</li>
                    <li>3.1.2-处理异常</li>
                    <li>3.1.3-解析链接</li>
                    <li>3.1.4-分析Robots协议</li>
                    <li>3.2-使用requests</li>
                    <li>3.2.1-基本用法</li>
                    <li>3.2.2-高级用法</li>
                    <li>3.3-正则表达式</li>
                    <li>3.4-抓取猫眼电影排行</li>
                    <li><strong>4-解析库的使用</strong></li>
                    <li>4.1-使用XPath</li>
                    <li>4.2-使用Beautiful Soup</li>
                    <li>4.3-使用pyquery</li>
                    <li><strong>5-数据存储</strong></li>
                    <li>5.1-文件存储</li>
                    <li>5.1.1-TXT文本存储</li>
                    <li>5.1.2-JSON文件存储</li>
                    <li>5.1.3-CSV文件存储</li>
                    <li>5.2-关系型数据库存储</li>
                    <li>5.2.1-MySQL存储</li>
                    <li>5.3-非关系型数据库存储</li>
                    <li>5.3.1-MongoDB存储</li>
                    <li>5.3.2-Redis存储</li>
                    <li><strong>6-Ajax数据爬取</strong></li>
                    <li>6.1-什么是Ajax</li>
                    <li>6.2-Ajax分析方法</li>
                    <li>6.3-Ajax结果提取</li>
                    <li>6.4-分析Ajax爬取今日头条街拍美图</li>
                    <li><strong>7-动态渲染页面爬取</strong></li>
                    <li>7.1-Selenium的使用</li>
                    <li>7.2-Splash的使用</li>
                    <li>7.3-Splash负载均衡配置</li>
                    <li>7.4-使用Selenium爬取淘宝商品</li>
                    <li><strong>8-验证码的识别</strong></li>
                    <li>8.1-图形验证码的识别</li>
                    <li>8.2-极验滑动验证码的识别</li>
                    <li>8.3-点触验证码的识别</li>
                    <li>8.4-微博宫格验证码的识别</li>
                    <li><strong>9-代理的使用</strong></li>
                    <li>9.1-代理的设置</li>
                    <li>9.2-代理池的维护</li>
                    <li>9.3-付费代理的使用</li>
                    <li>9.4-ADSL拨号代理</li>
                    <li>9.5-使用代理爬取微信公众号文章</li>
                    <li><strong>10-模拟登录</strong></li>
                    <li>10.1-模拟登录并爬取GitHub</li>
                    <li>10.2-Cookies池的搭建</li>
                    <li><strong>11-App的爬取</strong></li>
                    <li>11.1-Charles的使用</li>
                    <li>11.2-mitmproxy的使用</li>
                    <li>11.3-mitmdump爬取“得到”App电子书信息</li>
                    <li>11.4-Appium的基本使用</li>
                    <li>11.5-Appium爬取微信朋友圈</li>
                    <li>11.6-Appium+mitmdump爬取京东商品</li>
                    <li><strong>12-pyspider框架的使用</strong></li>
                    <li>12.1-pyspider框架介绍</li>
                    <li>12.2-pyspider的基本使用</li>
                    <li>12.3-pyspider用法详解</li>
                    <li><strong>13-Scrapy框架的使用</strong></li>
                    <li>13.1-Scrapy框架介绍</li>
                    <li>13.2-Scrapy入门</li>
                    <li>13.3-Selector的用法</li>
                    <li>13.4-Spider的用法</li>
                    <li>13.5-Downloader Middleware的用法</li>
                    <li>13.6-Spider Middleware的用法</li>
                    <li>13.7-Item Pipeline的用法</li>
                    <li>13.8-Scrapy对接Selenium</li>
                    <li>13.9-Scrapy对接Splash</li>
                    <li>13.10-Scrapy通用爬虫</li>
                    <li>13.11-Scrapyrt的使用</li>
                    <li>13.12-Scrapy对接Docker</li>
                    <li>13.13-Scrapy爬取新浪微博</li>
                    <li><strong>14-分布式爬虫</strong></li>
                    <li>14.1-分布式爬虫原理</li>
                    <li>14.2-Scrapy-Redis源码解析</li>
                    <li>14.3-Scrapy分布式实现</li>
                    <li>14.4-Bloom Filter的对接</li>
                    <li><strong>15-分布式爬虫的部署</strong></li>
                    <li>15.1-Scrapyd分布式部署</li>
                    <li>15.2-Scrapyd-Client的使用</li>
                    <li>15.3-Scrapyd对接Docker</li>
                    <li>15.4-Scrapyd批量部署</li>
                    <li>15.5-Gerapy分布式管理</li>
                  </ul>
                  <h2 id="购买链接"><a href="#购买链接" class="headerlink" title="购买链接"></a><strong>购买链接</strong></h2>
                  <p>想必很多小伙伴已经等了很久了，之前预售那么久也一直迟迟没有货，发售就有不少网店又售空了，不过现在起不用担心了！</p>
                  <p>书籍现已在京东、天猫、当当等网店上架并全面供应啦，复制链接到浏览器打开或扫描二维码打开即可购买了！</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/06/京东二维码.png" alt=""></p>
                  <p> 京东商城</p>
                  <p><a href="https://item.jd.com/12333540.html" target="_blank" rel="noopener">https://item.jd.com/12333540.html</a></p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/06/天猫二维码.png" alt=""></p>
                  <p> 天猫商城</p>
                  <p><a href="https://detail.tmall.com/item.htm?id=566699703917" target="_blank" rel="noopener">https://detail.tmall.com/item.htm?id=566699703917</a></p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/06/当当二维码.png" alt=""></p>
                  <p>当当网</p>
                  <p><a href="http://product.dangdang.com/25249602.html" target="_blank" rel="noopener">http://product.dangdang.com/25249602.html</a></p>
                  <p>欢迎大家购买，谢谢支持！O(∩_∩)O</p>
                  <h2 id="免费预览"><a href="#免费预览" class="headerlink" title="免费预览"></a><strong>免费预览</strong></h2>
                  <p>不放心？想先看看有些啥，没问题！看这里： 免费章节试读（复制粘贴至浏览器打开）： <a href="https://cuiqingcai.com/5052.html">https://cuiqingcai.com/5052.html</a> 将一直免费开放<strong>前7章节</strong>，欢迎大家试读！</p>
                  <h2 id="视频教程"><a href="#视频教程" class="headerlink" title="视频教程"></a>视频教程</h2>
                  <p>当然除了书籍，也有配套的视频课程，作者同样是崔庆才，二者结合学习效果更佳！限时优惠折扣中！扫描下图中二维码即可了解详情！ <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/06/%E8%AF%BE%E7%A8%8B%E5%AE%A3%E4%BC%A0%E5%9B%BE.png" alt=""> 视频教程链接： <a href="https://edu.hellobi.com/course/157" target="_blank" rel="noopener">https://edu.hellobi.com/course/157</a> <a href="http://study.163.com/course/courseMain.htm?courseId=1003827039" target="_blank" rel="noopener">http://study.163.com/course/courseMain.htm?courseId=1003827039</a> 感谢大家支持！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-05-04 21:36:24" itemprop="dateCreated datePublished" datetime="2018-05-04T21:36:24+08:00">2018-05-04</time>
                </span>
                <span id="/6009.html" class="post-meta-item leancloud_visitors" data-flag-title="《Python3网络爬虫开发实战》来了！" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>3.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5984.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5984.html" class="post-title-link" itemprop="url">Flask 静态文件缓存问题</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h1 id="大家好，今天才发现很多学习Flask的小伙伴都有这么一个问题，清理缓存好麻烦啊，今天就教大家怎么解决。"><a href="#大家好，今天才发现很多学习Flask的小伙伴都有这么一个问题，清理缓存好麻烦啊，今天就教大家怎么解决。" class="headerlink" title="大家好，今天才发现很多学习Flask的小伙伴都有这么一个问题，清理缓存好麻烦啊，今天就教大家怎么解决。"></a>大家好，今天才发现很多学习Flask的小伙伴都有这么一个问题，清理缓存好麻烦啊，今天就教大家怎么解决。</h1>
                  <p>大家在使用Flask静态文件的时候，每次更新，发现CSS或是Js或者其他的文件不会更新。 这是因为浏览器的缓存问题。 普遍大家是这几步解决办法。</p>
                  <ul>
                    <li><strong>清理浏览器缓存</strong></li>
                    <li><strong>设置浏览器不缓存</strong></li>
                    <li>也有以下这么写的</li>
                  </ul>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@app.context_processor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">override_url_for</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> dict(url_for=dated_url_for)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dated_url_for</span><span class="params">(endpoint, **values)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> endpoint == <span class="string">'static'</span>:</span><br><span class="line">        filename = values.get(<span class="string">'filename'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> filename:</span><br><span class="line">        file_path = os.path.join(app.root_path, endpoint, filename)</span><br><span class="line">        values[<span class="string">'q'</span>] = int(os.stat(file_path).st_mtime)</span><br><span class="line">        <span class="keyword">return</span> url_for(endpoint, **values)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果是我，我不会这么做，效率很低。 <img src="https://note.youdao.com/yws/api/personal/file/WEB509e95a33af9869430a40426c0ebf665?method=download&amp;shareKey=be706f1bce4b10e5d615e902e712b2d0" alt=""> 这是 Flask的 <strong><code>config</code></strong> 的源码，里面可以看到，有设置缓存最大时间 <strong><code>SEND_FILE_MAX_AGE_DEFAULT</code></strong> 可以看到，它是一个 <strong>temedelta</strong> 的值 <strong>我们去更改配置。</strong> <img src="https://note.youdao.com/yws/api/personal/file/WEB2929bc40de12a0530fcad5b9bdd8e2bc?method=download&amp;shareKey=72db34d3085f531add452f0ae8517041" alt=""> 第2行: <strong>我们引入了<code>datetime</code>的<code>timedelta</code>对象</strong> 第6行: <strong>我们配置缓存最大时间</strong> <strong>这样就解决了缓存问题，不用去写多余的代码，不用去清理浏览器的缓存。</strong> <strong>一定要学着去看官方文档和框架的源代码！！</strong> </p>
                  <p><strong>有什么问题请联系</strong></p>
                  <p>[caption id=”attachment_5953” align=”aligncenter” width=”320”]<img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/04/WechatIMG1-1-320x320.jpeg" alt=""> 微信二维码[/caption]</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/蒋翔宇" class="author" itemprop="url" rel="index">蒋翔宇</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-04-15 12:19:10" itemprop="dateCreated datePublished" datetime="2018-04-15T12:19:10+08:00">2018-04-15</time>
                </span>
                <span id="/5984.html" class="post-meta-item leancloud_visitors" data-flag-title="Flask 静态文件缓存问题" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>751</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5876.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Linux <i class="label-arrow"></i>
                  </a>
                  <a href="/5876.html" class="post-title-link" itemprop="url">SSH反向隧道搭建过程</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>现在我们有一台内网主机 A，在局域网内是可以访问的，但是如果我们现在不处在局域网内，可以选择 VPN 连接，但这样其实并不太方便，所以本节我们来说明一下利用 SSH 反向隧道来实现访问内网主机的方法。</p>
                  <h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2>
                  <p>首先我们需要有一台公网主机作为跳板，这台主机是可以公网访问的，我们将其命名为 B，它的 IP 假设为 10.10.10.10。 所以两台机器网络配置如下：</p>
                  <h3 id="A-内网机器"><a href="#A-内网机器" class="headerlink" title="A 内网机器"></a>A 内网机器</h3>
                  <ul>
                    <li>IP：192.168.1.2</li>
                    <li>SSH端口： 22</li>
                    <li>用户名：usera</li>
                    <li>密码：passworda</li>
                    <li>内网配置端口：22（即配置 SSH 端口的反向隧道）</li>
                  </ul>
                  <h3 id="B-公网机器"><a href="#B-公网机器" class="headerlink" title="B 公网机器"></a>B 公网机器</h3>
                  <ul>
                    <li>IP：10.10.10.10</li>
                    <li>SSH端口： 22</li>
                    <li>用户名：userb</li>
                    <li>密码：passwordb</li>
                    <li>公网端口：22001（即用 B 的 22001 端口连到 A 的 SSH 22 端口）</li>
                  </ul>
                  <h2 id="配置SSH秘钥"><a href="#配置SSH秘钥" class="headerlink" title="配置SSH秘钥"></a>配置SSH秘钥</h2>
                  <p>首先我们需要在 A 主机上生成 SSH 秘钥，和 B 用 SSH 建立认证。 首先在主机 A 上执行如下命令生成 SSH 秘钥：</p>
                  <figure class="highlight excel">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">ssh-keygen -<span class="built_in">t</span> rsa -C <span class="string">"your@email.com"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>命令里面的邮箱需要自行更换。 然后利用如下命令将 A 的 SSH 秘钥添加到 B 的 authorized_keys 里面：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">ssh-copy-id <span class="symbol">userb@</span><span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行后会提示输入主机 B 的密码，执行完毕之后，我们登录到 B，就发现 authorized_keys 里面就多了 A 的 SSH 公钥了，成功建立 SSH 认证。</p>
                  <h2 id="B-主机配置"><a href="#B-主机配置" class="headerlink" title="B 主机配置"></a>B 主机配置</h2>
                  <p>B 主机需要更改 /etc/ssh/sshd_config 文件，修改如下一行：</p>
                  <figure class="highlight nginx">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">GatewayPorts</span> <span class="literal">yes</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样可以把监听的端口绑定到任意IP 0.0.0.0上，否则只有本机 127.0.0.1 可以访问。 然后重启 sshd 服务：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo<span class="built_in"> service </span>sshd restart</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="A-主机配置"><a href="#A-主机配置" class="headerlink" title="A 主机配置"></a>A 主机配置</h2>
                  <p>主机 A 再安装一个 AutoSSH，以 Ubuntu 为例，命令如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo apt-<span class="builtin-name">get</span> install autossh</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后执行如下命令即可完成反向 SSH 配置：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">auto</span>ssh -M <span class="number">55555</span> -NfR <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">22001</span>:localhost:<span class="number">22</span> <span class="symbol">userb@</span><span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 -M 后面任意填写一个可用端口即可，-N 代表只建立连接，不打开shell ，-f 代表建立成功后在后台运行，-R 代表指定端口映射。 这里是将 A 主机的 22 端口映射到 B 主机的 22001 端口，这样就完成了配置。 主要我们再访问 B 主机的 22001 端口，就会自动转发到 A 主机的 22 端口了，即可以公网访问了。</p>
                  <h2 id="连接测试"><a href="#连接测试" class="headerlink" title="连接测试"></a>连接测试</h2>
                  <p>接下来 SSH 测试连接 A 主机即可：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">ssh <span class="symbol">usera@</span><span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span> -p <span class="number">22001</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输入密码，完成连接。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-26 02:39:00" itemprop="dateCreated datePublished" datetime="2018-03-26T02:39:00+08:00">2018-03-26</time>
                </span>
                <span id="/5876.html" class="post-meta-item leancloud_visitors" data-flag-title="SSH反向隧道搭建过程" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5873.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5873.html" class="post-title-link" itemprop="url">Attention原理及TensorFlow AttentionWrapper源码解析</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节来详细说明一下 Seq2Seq 模型中一个非常有用的 Attention 的机制，并结合 TensorFlow 中的 AttentionWrapper 来剖析一下其代码实现。</p>
                  <h2 id="Seq2Seq"><a href="#Seq2Seq" class="headerlink" title="Seq2Seq"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#seq2seq" target="_blank" rel="noopener"></a>Seq2Seq</h2>
                  <p>首先来简单说明一下 Seq2Seq 模型，如果搞过深度学习，想必一定听说过 Seq2Seq 模型，Seq2Seq 其实就是 Sequence to Sequence，也简称 S2S，也可以称之为 Encoder-Decoder 模型，这个模型的核心就是编码器（Encoder）和解码器（Decoder）组成的，架构雏形是在 2014 年由论文 <a href="https://arxiv.org/abs/1406.1078" target="_blank" rel="noopener">Learning Phrase Representations using RNN Encoder-Decoder for Statistical Machine Translation, Cho et al</a> 提出的，后来 <a href="https://arxiv.org/abs/1409.3215" target="_blank" rel="noopener">Sequence to Sequence Learning with Neural Networks, Sutskever et al</a> 算是比较正式地提出了 Sequence to Sequence 的架构，后来 <a href="https://arxiv.org/abs/1409.0473" target="_blank" rel="noopener">Neural Machine Translation by Jointly Learning to Align and Translate, Bahdanau et al</a> 又提出了 Attention 机制，将 Seq2Seq 模型推上神坛，并横扫了非常多的任务，现在也非常广泛地用于机器翻译、对话生成、文本摘要生成等各种任务上，并取得了非常好的效果。 下面的图示意了 Seq2Seq 模型的基本架构： <a href="https://github.com/Germey/AI/blob/master/assets/2018-03-23-16-34-19.jpg" target="_blank" rel="noopener"><img src="https://github.com/Germey/AI/raw/master/assets/2018-03-23-16-34-19.jpg" alt=""></a> 可以看到图中有一个中间状态 $ c $ 向量，在 $ c $ 向量左侧的我们可以称之为编码器（Encoder），编码器这里示意的是 RNN 序列，另外 RNN 单元还可以使用 LSTM、GRU 等变体， 在编码器下方输入了 $ x_1 $、$ x_2 $、$ x_3 $、$ x_4 $，代表模型的输入内容，例如在翻译模型中可以分别代表“我爱中国”这四个字，这样经过序列处理，它就会得到最后的输出，我们将其表示为 $ c $ 向量，这样编码器的工作就完成了。在图中 $ c $ 向量的右侧部分我们可以称之为解码器（Decoder），它拿到编码器生成的 $ c $ 向量，然后再进行序列解码，得到输出结果 $ y_1 $、$ y_2 $、$ y_3 $，例如刚才输入的“我爱中国”四个字便被解码成了 “I love China”，这样就实现了翻译任务，以上就是最基本的 Seq2Seq 模型原理。 另外还有一种变体，$ c $ 向量在每次解码的时候都会作为解码器的输入，其实原理都是类似的，如图所示： <a href="https://github.com/Germey/AI/blob/master/assets/2018-03-23-19-42-16.jpg" target="_blank" rel="noopener"><img src="https://github.com/Germey/AI/raw/master/assets/2018-03-23-19-42-16.jpg" alt=""></a> 这种模型架构是通用的，所以它的适用场景也非常广泛。如机器翻译、对话生成、文本摘要、阅读理解、语音识别，也可以用在一些趣味场景中，如诗词生成、对联生成、代码生成、评论生成等等，效果都很不错。</p>
                  <h2 id="Attention"><a href="#Attention" class="headerlink" title="Attention"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#attention" target="_blank" rel="noopener"></a>Attention</h2>
                  <p>通过上图我们可以发现，Encoder 把所有的输入序列编码成了一个 $ c $ 向量，然后使用 $ c $ 向量来进行解码，因此，$ c $ 向量中必须包含了原始序列中的所有信息，所以它的压力其实是很大的，而且由于 RNN 容易把前面的信息“忘记”掉，所以基本的 Seq2Seq 模型，对于较短的输入来说，效果还是可以接受的，但是在输入序列比较长的时候，$ c $ 向量存不下那么多信息，就会导致生成效果大大折扣。 Attention 机制解决了这个问题，它可以使得在输入文本长的时候精确率也不会有明显下降，它是怎么做的呢？既然一个 $ c $ 向量存不了，那么就引入多个 $ c $ 向量，称之为 $ c<em>1 $、$ c_2 $、…、$ c_i $，在解码的时候，这里的 $ i $ 对应着 Decoder 的解码位次，每次解码就利用对应的 $ c_i $ 向量来解码，如图所示： <a href="https://github.com/Germey/AI/blob/master/assets/2018-03-23-17-38-45.jpg" target="_blank" rel="noopener"><img src="https://github.com/Germey/AI/raw/master/assets/2018-03-23-17-38-45.jpg" alt=""></a> 这里的每个 $ c_i $ 向量其实包含了当前所输出与输入序列各个部分重要性的相关的信息。不同的 $ c_i $ 向量里面包含的输入信息各部分的权重是不同的，先放一个示意图： <a href="https://github.com/Germey/AI/blob/master/assets/2018-03-23-19-35-28.jpg" target="_blank" rel="noopener"><img src="https://github.com/Germey/AI/raw/master/assets/2018-03-23-19-35-28.jpg" alt=""></a> 还是上面的例子，例如输入信息是“我爱中国”，输出的的理想结果应该是“I love China”，在解码的时候，应该首先需要解码出 “I” 这个字符，这时候会用到 $ c_1 $ 向量，而 $ c_1 $ 向量包含的信息中，“我”这个字的重要性更大，因此它便倾向解码输出 “I”，当解码第二个字的时候，会用到 $ c_2 $ 向量，而 $ c_2 $ 向量包含的信息中，“爱” 这个字的重要性更大，因此会解码输出 “love”，在解码第三个字的时候，会用到 $ c_3 $ 向量，而 $ c_3 $向量包含的信息中，”中国” 这两个字的权重都比较大，因此会解码输出 “China”。所以其实，Attention 注意力机制中的 $ c_i $ 向量记录了不同解码时刻应该更关注于哪部分输入数据，也实现了编码解码过程的对齐。经过实验发现，这种机制可以有效解决输入信息过长时导致信息解码效果不理想的问题，另外解码生成效果同时也有提升。 下面我们以 Bahdanau 提出的 Attention 为例来详细剖析一下 Attention 机制。 在没有引入 Attention 之前，Decoder 在某个时刻解码的时候实际上是依赖于三个部分的，首先我们知道 RNN 中，每次输出结果会依赖于隐层和输入，在 Seq2Seq 模型中，还需要依赖于 $ c $ 向量，所以这里我们设在 $ i $ 时刻，解码器解码的内容是 $ y_i $，上一次解码结果是 $ y</em>{i-1} $，隐层输出是 $ s<em>t $，所以它们满足这样的关系： $$ y_i = g(y</em>{i-1}, s<em>i, c) <script type="math/tex">同时 $ s_i $ 和 $ c $ 还满足这样的关系：</script> s_i = f(s</em>{i-1}, y<em>{i-1}, c) <script type="math/tex">即每次的隐层输出是上一个隐层和上一个输出结果和 $ c $ 向量共同计算得出的。 但是刚才说了，这样会带来一些问题，$ c $ 向量不足以包含输入内容的所有信息，尤其是在输入序列特别长的情况下，所以这里我们不再使用一个 $ c $ 向量，而是每一个解码过程对应一个 $ c_i $ 向量，所以公式改写如下：</script> y_i = g(y</em>{i-1}, s<em>i, c_i) <script type="math/tex">同时 $ s_i $ 的计算方式也变为如下公式：</script> s_i = f(s</em>{i-1}, y<em>{i-1}, c_i) $$ 所以，这里每次解码得出 $ y_i $ 时，都有与之对应的 $ c_i $ 向量。那么这个 $ c_i $ 向量又是怎么来的呢？实际上它是由编码器端每个时刻的隐含状态加权平均得到的，这里假设编码器端的的序列长度为 $ T_x $，序列位次用 $ j $ 来表示，编码器段每个时刻的隐含状态即为 $ h_1 $、$ h_2 $、…、$ h_j $、…、$ h</em>{T<em>x} $，对于解码器的第 $ i $ 时刻，对应的 $ c_i $ 表示如下： $$ c_i = \sum</em>{j=1}^{T<em>x} \alpha</em>{ij}h<em>j $$ 编码器输出的结果中，$ h_j $ 中包含了输入序列中的第 $ j $ 个词及前面的一些信息，如果是用了双向 RNN 的话，则包含的是第 $ j $ 个词即前后的一些词的信息，这里 $ \alpha</em>{ij} $ 代表了分配的权重，这代表在生成第 i 个结果的时候，对于输入信息的各个阶段的 $ hj $ 的注意力分配是不同的。 当 $ a<em>{ij} $ 的值越高，表示第 $ i $ 个输出在第 $ j $ 个输入上分配的注意力越多，这样就会导致在生成第 $ i $ 个输出的时候，受第 $ j $ 个输入的影响也就越大。 那么 $ a</em>{ij} $ 又是怎么得来的呢？其实它就又关系到第 $ i-1 $ 个输出隐藏状态 $ s<em>{i-1} $ 以及输入中的各个隐含状态 $ h_j $，公式表示如下： $$ \alpha</em>{ij} = \frac {exp(e<em>{ij})} {\sum</em>{k=1}^{T<em>x} exp(e</em>{ik})} <script type="math/tex">同时 $ e_{ij} $ 又表示为：</script> e<em>{ij} = a(s</em>{i-1}, h<em>j) = {v_a}^Ttanh(W_as</em>{i-1} + U<em>ah_j) $$ 这也就是说，这个权重就是 $ s</em>{i-1} $ 和 $ h<em>j $ 分别计算得到一个数值，然后再过一个 softmax 函数得到的，结果就是 $ \alpha</em>{ij} $。 因此 $ c<em>i $ 就可以表示为： $$ c_i = \sum</em>{j=1}^{T<em>x} softmax(a(s</em>{i-1}, h_j)) \cdot h_j $$ 以上便是整个 Attention 机制的推导过程。</p>
                  <h2 id="TensorFlow-AttentionWrapper"><a href="#TensorFlow-AttentionWrapper" class="headerlink" title="TensorFlow AttentionWrapper"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#tensorflow-attentionwrapper" target="_blank" rel="noopener"></a>TensorFlow AttentionWrapper</h2>
                  <p>我们了解了基本原理，但真正离程序实现出来其实还是有很大差距的，接下来我们就结合 TensorFlow 框架来了解一下 Attention 的实现机制。 在 TensorFlow 中，Attention 的相关实现代码是在 tensorflow/contrib/seq2seq/python/ops/attention_wrapper.py 文件中，这里面实现了两种 Attention 机制，分别是 BahdanauAttention 和 LuongAttention，其实现论文分别如下：</p>
                  <ul>
                    <li><a href="https://arxiv.org/abs/1409.0473" target="_blank" rel="noopener">Neural Machine Translation by Jointly Learning to Align and Translate, Bahdanau, et al</a></li>
                    <li><a href="https://arxiv.org/abs/1508.04025" target="_blank" rel="noopener">Effective Approaches to Attention-based Neural Machine Translation, Luong, et al</a></li>
                  </ul>
                  <p>整个 attention_wrapper.py 文件中主要包含几个类，我们主要关注其中几个：</p>
                  <ul>
                    <li>AttentionMechanism、_BaseAttentionMechanism、LuongAttention、BahdanauAttention 实现了 Attention 机制的逻辑。<ul>
                        <li>AttentionMechanism 是 Attention 类的父类，继承了 object 类，内部没有任何实现。</li>
                        <li>_BaseAttentionMechanism 继承自 AttentionMechanism 类，定义了 Attention 机制的一些公共方法实现和属性。</li>
                        <li>LuongAttention、BahdanauAttention 均继承 _BaseAttentionMechanism 类，分别实现了上面两篇论文的 Attention 机制。</li>
                      </ul>
                    </li>
                    <li>AttentionWrapperState 用来存储整个计算过程中的 state，和 RNN 中的 state 类似，只不过这里额外还存储了 attention、time 等信息。</li>
                    <li>AttentionWrapper 主要用于对封装 RNNCell，继承自 RNNCell，封装后依然是 RNNCell 的实例，可以构建一个带有 Attention 机制的 Decoder。</li>
                    <li>另外还有一些公共方法，例如 hardmax、safe_cumpord 等。</li>
                  </ul>
                  <p>下面我们以 BahdanauAttention 为例来说明 Attention 机制及 AttentionWrapper 的实现。</p>
                  <h3 id="BahdanauAttention"><a href="#BahdanauAttention" class="headerlink" title="BahdanauAttention"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#bahdanauattention" target="_blank" rel="noopener"></a>BahdanauAttention</h3>
                  <p>首先我们来介绍 BahdanauAttention 类的具体原理。 首先我们来看下它的初始化方法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def __init__(self,</span><br><span class="line">    num_units,</span><br><span class="line">    memory,</span><br><span class="line">    <span class="attribute">memory_sequence_length</span>=None,</span><br><span class="line">    <span class="attribute">normalize</span>=<span class="literal">False</span>,</span><br><span class="line">    <span class="attribute">probability_fn</span>=None,</span><br><span class="line">    <span class="attribute">score_mask_value</span>=None,</span><br><span class="line">    <span class="attribute">dtype</span>=None,</span><br><span class="line">    <span class="attribute">name</span>=<span class="string">"BahdanauAttention"</span>):</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里一共接受八个参数，下面一一进行说明：</p>
                  <ul>
                    <li>num<em>units：神经元节点数，我们知道在计算 $ e</em>{ij} $ 的时候，需要使用 $ s_{i-1} $ 和 $ h_j $ 来进行计算，而二者的维度可能并不是统一的，需要进行变换和统一，所以这里就有了 $ W_a $ 和 $ U_a $ 这两个系数，所以在代码中就是用 num_units 来声明了一个全连接 Dense 网络，用于统一二者的维度，以便于下一步的计算：</li>
                  </ul>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">query_layer</span>=layers_core.Dense(num_units, <span class="attribute">name</span>=<span class="string">"query_layer"</span>, <span class="attribute">use_bias</span>=<span class="literal">False</span>, <span class="attribute">dtype</span>=dtype)</span><br><span class="line"><span class="attribute">memory_layer</span>=layers_core.Dense(num_units, <span class="attribute">name</span>=<span class="string">"memory_layer"</span>, <span class="attribute">use_bias</span>=<span class="literal">False</span>, <span class="attribute">dtype</span>=dtype)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们可以看到声明了一个 query<em>layer 和 memory_layer，分别和 $ s</em>{i-1} $ 及 $ h_j $ 做全连接变换，统一维度。</p>
                  <ul>
                    <li>memory：The memory to query; usually the output of an RNN encoder. 即解码时用到的上文信息，维度需要是 [batch_size, max_time, context_dim]。这时我们观察一下父类 _BaseAttentionMechanism 的初始化方法，实现如下：</li>
                  </ul>
                  <figure class="highlight gml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">with</span> ops.name_scope(</span><br><span class="line">    name, <span class="string">"BaseAttentionMechanismInit"</span>, nest.flatten(memory)):</span><br><span class="line">  <span class="literal">self</span>._values = _prepare_memory(</span><br><span class="line">      memory, memory_sequence_length,</span><br><span class="line">      check_inner_dims_defined=check_inner_dims_defined)</span><br><span class="line">  <span class="literal">self</span>._keys = (</span><br><span class="line">      <span class="literal">self</span>.memory_layer(<span class="literal">self</span>._values) <span class="keyword">if</span> <span class="literal">self</span>.memory_layer</span><br><span class="line">      <span class="keyword">else</span> <span class="literal">self</span>._values)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里通过 _prepare_memory() 方法对 memory 进行处理，然后调用 memory_layer 对 memory 进行全连接维度变换，变换成 [batch_size, max_time, num_units]。</p>
                  <ul>
                    <li>memory_sequence_length：Sequence lengths for the batch entries in memory. 即 memory 变量的长度信息，类似于 dynamic_rnn 中的 sequence_length，被 _prepare_memory() 方法调用处理 memory 变量，进行 mask 操作：</li>
                  </ul>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">seq_len_mask = <span class="built_in">array</span>_ops.sequence_mask(</span><br><span class="line">    memory_sequence_length,</span><br><span class="line">    maxlen=<span class="built_in">array</span>_ops.shape(nest.flatten(memory)[<span class="number">0</span>])[<span class="number">1</span>],</span><br><span class="line">    dtype=nest.flatten(memory)[<span class="number">0</span>].dtype)</span><br><span class="line">seq_len_batch_size = (</span><br><span class="line">    memory_sequence_length.shape[<span class="number">0</span>].value</span><br><span class="line">    <span class="keyword">or</span> <span class="built_in">array</span>_ops.shape(memory_sequence_length)[<span class="number">0</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <ul>
                    <li>normalize：Whether to normalize the energy term. 即是否要实现标准化，方法出自论文：<a href="https://arxiv.org/abs/1602.07868" target="_blank" rel="noopener">Weight Normalization: A Simple Reparameterization to Accelerate Training of Deep Neural Networks, Salimans, et al</a>。</li>
                    <li>probability_fn：A callable function which converts the score to probabilities. 计算概率时的函数，必须是一个可调用的函数，默认使用 softmax()，还可以指定 hardmax() 等函数。</li>
                    <li>score_mask_value：The mask value for score before passing into probability_fn. The default is -inf. Only used if memory_sequence_length is not None. 在使用 probability_fn 计算概率之前，对 score 预先进行 mask 使用的值，默认是负无穷。但这个只有在 memory_sequence_length 参数定义的时候有效。</li>
                    <li>dtype：The data type for the query and memory layers of the attention mechanism. 数据类型，默认是 float32。</li>
                    <li>name：Name to use when creating ops，自定义名称。</li>
                  </ul>
                  <p>接下来类里面定义了一个 <strong>call</strong>() 方法：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def <span class="constructor">__call__(<span class="params">self</span>, <span class="params">query</span>, <span class="params">previous_alignments</span>)</span>:</span><br><span class="line">    <span class="keyword">with</span> variable_scope.variable<span class="constructor">_scope(None, <span class="string">"bahdanau_attention"</span>, [<span class="params">query</span>])</span>:</span><br><span class="line">      processed_query = self.query<span class="constructor">_layer(<span class="params">query</span>)</span> <span class="keyword">if</span> self.query_layer <span class="keyword">else</span> query</span><br><span class="line">      score = <span class="constructor">_bahdanau_score(<span class="params">processed_query</span>, <span class="params">self</span>.<span class="params">_keys</span>, <span class="params">self</span>.<span class="params">_normalize</span>)</span></span><br><span class="line">    alignments = self.<span class="constructor">_probability_fn(<span class="params">score</span>, <span class="params">previous_alignments</span>)</span></span><br><span class="line">    return alignments</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里首先定义了 processed_query，这里也是通过 query_layer 过了一个全连接网络，将最后一维统一成 num_units，然后调用了 bahdanau_score() 方法，这个方法是比较重要的，主要用来计算公式中的 $ e{ij} $，传入的参数是 processed_query 以及上文中提及的 keys 变量，二者一个代表了 $ s{i-1} $，一个代表了 $ h_j $，_bahdanau_score() 方法实现如下：</p>
                  <figure class="highlight nix">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def _bahdanau_score(processed_query, keys, normalize):</span><br><span class="line">    <span class="attr">dtype</span> = processed_query.dtype</span><br><span class="line">    <span class="comment"># Get the number of hidden units from the trailing dimension of keys</span></span><br><span class="line">    <span class="attr">num_units</span> = keys.shape[<span class="number">2</span>].value <span class="literal">or</span> array_ops.shape(keys)[<span class="number">2</span>]</span><br><span class="line">    <span class="comment"># Reshape from [batch_size, ...] to [batch_size, 1, ...] for broadcasting.</span></span><br><span class="line">    <span class="attr">processed_query</span> = array_ops.expand_dims(processed_query, <span class="number">1</span>)</span><br><span class="line">    <span class="attr">v</span> = variable_scope.get_variable(</span><br><span class="line">      <span class="string">"attention_v"</span>, [num_units], <span class="attr">dtype=dtype)</span></span><br><span class="line">    <span class="keyword">if</span> normalize:</span><br><span class="line">        <span class="comment"># Scalar used in weight normalization</span></span><br><span class="line">        <span class="attr">g</span> = variable_scope.get_variable(</span><br><span class="line">            <span class="string">"attention_g"</span>, <span class="attr">dtype=dtype,</span></span><br><span class="line">            <span class="attr">initializer=math.sqrt((1.</span> / num_units)))</span><br><span class="line">        <span class="comment"># Bias added prior to the nonlinearity</span></span><br><span class="line">        <span class="attr">b</span> = variable_scope.get_variable(</span><br><span class="line">            <span class="string">"attention_b"</span>, [num_units], <span class="attr">dtype=dtype,</span></span><br><span class="line">            <span class="attr">initializer=init_ops.zeros_initializer())</span></span><br><span class="line">        <span class="comment"># normed_v = g * v / ||v||</span></span><br><span class="line">        <span class="attr">normed_v</span> = g * v * math_ops.rsqrt(</span><br><span class="line">            math_ops.reduce_sum(math_ops.square(v)))</span><br><span class="line">        return math_ops.reduce_sum(normed_v * math_ops.tanh(keys + processed_query + b), [<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        return math_ops.reduce_sum(v * math_ops.tanh(keys + processed_query), [<span class="number">2</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里其实就是实现了 keys 和 processed<em>query 的加和，如果指定了 normalize 的话还需要进行额外的 normalize，结果就是公式中的 $ e</em>{ij} $，在 TensorFlow 中常用 score 变量表示。 接下来再回到 <strong>call</strong>() 方法中，这里得到了 score 变量，接下来可以对齐求 softmax() 操作，得到 $ \alpha_{ij} $：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">alignments = self.<span class="constructor">_probability_fn(<span class="params">score</span>, <span class="params">previous_alignments</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这就代表了在 $ i $ 时刻，Decoder 的时候对 Encoder 得到的每个 $ hj $ 的权重大小比例，在 TensorFlow 中常用 alignments 变量表示。 所以综上所述，BahdanauAttention 就是初始化时传入 num_units 以及 Encoder Outputs，然后调时传入 query 用即可得到权重变量 alignments。</p>
                  <h3 id="AttentionWrapperState"><a href="#AttentionWrapperState" class="headerlink" title="AttentionWrapperState"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#attentionwrapperstate" target="_blank" rel="noopener"></a>AttentionWrapperState</h3>
                  <p>接下来我们再看下 AttentionWrapperState 这个类，这个类其实比较简单，就是定义了 Attention 过程中可能需要保存的变量，如 cell_state、attention、time、alignments 等内容，同时也便于后期的可视化呈现，代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttentionWrapperState</span><span class="params">(</span></span></span><br><span class="line"><span class="class"><span class="params">    collections.namedtuple<span class="params">(<span class="string">"AttentionWrapperState"</span>,</span></span></span></span><br><span class="line"><span class="class"><span class="params"><span class="params">                           <span class="params">(<span class="string">"cell_state"</span>, <span class="string">"attention"</span>, <span class="string">"time"</span>, <span class="string">"alignments"</span>,</span></span></span></span></span><br><span class="line"><span class="class"><span class="params"><span class="params"><span class="params">                            <span class="string">"alignment_history"</span>)</span>)</span>)</span>:</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可见它就是继承了 namedtuple 这个数据结构，其实整个 AttentionWrapperState 就像声明了一个结构体，可以传入需要的字段生成这个对象。</p>
                  <h3 id="AttentionWrapper"><a href="#AttentionWrapper" class="headerlink" title="AttentionWrapper"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#attentionwrapper" target="_blank" rel="noopener"></a>AttentionWrapper</h3>
                  <p>了解了 Attention 机制及 BahdanauAttention 的原理之后，最后我们再来了解一下 AttentionWrapper，可能你用过很多其他的 Wrapper，如 DropoutWrapper、ResidualWrapper 等等，它们其实都是 RNNCell 的实例，其实 AttentionWrapper 也不例外，它对 RNNCell 进行了封装，封装后依然还是 RNNCell 的实例。一个普通的 RNN 模型，你要加入 Attention，只需要在 RNNCell 外面套一层 AttentionWrapper 并指定 AttentionMechanism 的实例就好了。而且如果要更换 AttentionMechanism，只需要改变 AttentionWrapper 的参数就好了，这可谓对 Attention 的实现架构完全解耦，配置非常灵活，TF 大法好！ 接下来我们首先来看下它的初始化方法，其参数是这样的：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def __init__(self,</span><br><span class="line">    cell,</span><br><span class="line">    attention_mechanism,</span><br><span class="line">    <span class="attribute">attention_layer_size</span>=None,</span><br><span class="line">    <span class="attribute">alignment_history</span>=<span class="literal">False</span>,</span><br><span class="line">    <span class="attribute">cell_input_fn</span>=None,</span><br><span class="line">    <span class="attribute">output_attention</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">initial_cell_state</span>=None,</span><br><span class="line">    <span class="attribute">name</span>=None):</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下面对参数进行一一说明：</p>
                  <ul>
                    <li>cell：An instance of RNNCell. RNNCell 的实例，这里可以是单个的 RNNCell，也可以是多个 RNNCell 组成的 MultiRNNCell。</li>
                    <li>attention_mechanism：即 AttentionMechanism 的实例，如 BahdanauAttention 对象，另外可以是多个 AttentionMechanism 组成的列表。</li>
                    <li>attention_layer_size：是数字或者数字做成的列表，如果是 None（默认），直接使用加权计算后得到的 Attention 作为输出，如果不是 None，那么 Attention 结果还会和 Output 进行拼接并做线性变换再输出。其代码实现如下：</li>
                  </ul>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">if</span> attention_layer_size is not None:</span><br><span class="line">    attention_layer_sizes = tuple(attention_layer_size <span class="keyword">if</span> isinstance(attention_layer_size, (<span class="built_in">list</span>, tuple)) <span class="keyword">else</span> (attention_layer_size,))</span><br><span class="line">    <span class="keyword">if</span> len(attention_layer_sizes) != len(attention_mechanisms):</span><br><span class="line">        raise <span class="constructor">ValueError(<span class="string">"If provided, attention_layer_size must contain exactly one integer per attention_mechanism, saw: %d vs %d"</span> % (<span class="params">len</span>(<span class="params">attention_layer_sizes</span>)</span>, len(attention_mechanisms)))</span><br><span class="line">    self._attention_layers = tuple(layers_core.<span class="constructor">Dense(<span class="params">attention_layer_size</span>, <span class="params">name</span>=<span class="string">"attention_layer"</span>, <span class="params">use_bias</span>=False, <span class="params">dtype</span>=<span class="params">attention_mechanisms</span>[<span class="params">i</span>].<span class="params">dtype</span>)</span> for i, attention_layer_size <span class="keyword">in</span> enumerate(attention_layer_sizes))</span><br><span class="line">    self._attention_layer_size = sum(attention_layer_sizes)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self._attention_layers = None</span><br><span class="line">    self._attention_layer_size = sum(attention_mechanism.values.get<span class="constructor">_shape()</span><span class="literal">[-<span class="number">1</span>]</span>.value for attention_mechanism <span class="keyword">in</span> attention_mechanisms) </span><br><span class="line">    </span><br><span class="line">for i, attention_mechanism <span class="keyword">in</span> enumerate(self._attention_mechanisms):</span><br><span class="line">    attention, alignments = <span class="constructor">_compute_attention(<span class="params">attention_mechanism</span>, <span class="params">cell_output</span>, <span class="params">previous_alignments</span>[<span class="params">i</span>], <span class="params">self</span>.<span class="params">_attention_layers</span>[<span class="params">i</span>] <span class="params">if</span> <span class="params">self</span>.<span class="params">_attention_layers</span> <span class="params">else</span> None)</span></span><br><span class="line">    alignment_history = previous_alignment_history<span class="literal">[<span class="identifier">i</span>]</span>.write(state.time, alignments) <span class="keyword">if</span> self._alignment_history <span class="keyword">else</span> <span class="literal">()</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <ul>
                    <li>alignment_history：即是否将之前的 alignments 存储到 state 中，以便于后期进行可视化展示。</li>
                    <li>cell_input_fn：将 Input 进行处理的方式，默认会将上一步的 Attention 进行 拼接操作，以免造成重复关注同样的内容。代码调用如下：</li>
                  </ul>
                  <figure class="highlight pf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">cell_inputs = <span class="literal">self</span>._cell_input_fn(inputs, <span class="keyword">state</span>.attention)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <ul>
                    <li>output_attention：是否将 Attention 返回，如果是 False 则返回 Output，否则返回 Attention，默认是 True。</li>
                    <li>initial_cell_state：计算时的初始状态。</li>
                    <li>name：自定义名称。</li>
                  </ul>
                  <p>AttentionWrapper 的核心方法在它的 call() 方法，即类似于 RNNCell 的 call() 方法，AttentionWrapper 类对其进行了重载，代码实现如下：</p>
                  <figure class="highlight pf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def call(<span class="literal">self</span>, inputs, <span class="keyword">state</span>):</span><br><span class="line">    <span class="comment"># Step 1</span></span><br><span class="line">    cell_inputs = <span class="literal">self</span>._cell_input_fn(inputs, <span class="keyword">state</span>.attention)</span><br><span class="line">    <span class="comment"># Step 2</span></span><br><span class="line">    cell_state = <span class="keyword">state</span>.cell_state</span><br><span class="line">    cell_output, next_cell_state = <span class="literal">self</span>._cell(cell_inputs, cell_state)</span><br><span class="line">    <span class="comment"># Step 3</span></span><br><span class="line">    if <span class="literal">self</span>._is_multi:</span><br><span class="line">        previous_alignments = <span class="keyword">state</span>.alignments</span><br><span class="line">        previous_alignment_history = <span class="keyword">state</span>.alignment_history</span><br><span class="line">    else:</span><br><span class="line">        previous_alignments = [<span class="keyword">state</span>.alignments]</span><br><span class="line">        previous_alignment_history = [<span class="keyword">state</span>.alignment_history]</span><br><span class="line">    all_alignments = []</span><br><span class="line">    all_attentions = []</span><br><span class="line">    all_histories = []</span><br><span class="line">    <span class="keyword">for</span> i, attention_mechanism <span class="keyword">in</span> enumerate(<span class="literal">self</span>._attention_mechanisms):</span><br><span class="line">        attention, alignments = _compute_attention(attention_mechanism, cell_output, previous_alignments[i], <span class="literal">self</span>._attention_layers[i] if <span class="literal">self</span>._attention_layers else None)</span><br><span class="line">        alignment_history = previous_alignment_history[i].write(<span class="keyword">state</span>.time, alignments) if <span class="literal">self</span>._alignment_history else ()</span><br><span class="line">        all_alignments.append(alignments)</span><br><span class="line">        all_histories.append(alignment_history)</span><br><span class="line">        all_attentions.append(attention)</span><br><span class="line">    <span class="comment"># Step 4</span></span><br><span class="line">    attention = array_ops.concat(all_attentions, <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Step 5</span></span><br><span class="line">    next_state = AttentionWrapperState(</span><br><span class="line">        time=<span class="keyword">state</span>.time + <span class="number">1</span>,</span><br><span class="line">        cell_state=next_cell_state,</span><br><span class="line">        attention=attention,</span><br><span class="line">        alignments=<span class="literal">self</span>._item_or_tuple(all_alignments),</span><br><span class="line">        alignment_history=<span class="literal">self</span>._item_or_tuple(all_histories))</span><br><span class="line">    <span class="comment"># Step 6</span></span><br><span class="line">    if <span class="literal">self</span>._output_attention:</span><br><span class="line">        return attention, next_state</span><br><span class="line">    else:</span><br><span class="line">        return cell_output, next_state</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里将一些异常判断代码去除了，以便于结构看得更清晰。 首先在第一步中，调用了 _cell_input_fn() 方法，对 inputs 和 state.attention 变量进行处理，默认是使用 concat() 函数拼接，作为当前时间步的输入。因为可能前一步的 Attention 可能对当前 Attention 有帮助，以免让模型连续两次将注意力放在同一个地方。 在第二步中，其实就是调用了普通的 RNNCell 的 call() 方法，得到输出和下一步的状态。 第三步中，这时得到的输出其实并没有用上 AttentionMechanism 中的 alignments 信息，所以当前的输出信息中我们并没有跟 Encoder 的信息做 Attention，所以这里还需要调用 _compute_attention() 方法进行权重的计算，其方法实现如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def <span class="constructor">_compute_attention(<span class="params">attention_mechanism</span>, <span class="params">cell_output</span>, <span class="params">previous_alignments</span>, <span class="params">attention_layer</span>)</span>:</span><br><span class="line">    alignments = attention<span class="constructor">_mechanism(<span class="params">cell_output</span>, <span class="params">previous_alignments</span>=<span class="params">previous_alignments</span>)</span></span><br><span class="line">    expanded_alignments = array_ops.expand<span class="constructor">_dims(<span class="params">alignments</span>, 1)</span></span><br><span class="line">    context = math_ops.matmul(expanded_alignments, attention_mechanism.values)</span><br><span class="line">    context = array_ops.squeeze(context, <span class="literal">[<span class="number">1</span>]</span>)</span><br><span class="line">    <span class="keyword">if</span> attention_layer is not None:</span><br><span class="line">        attention = attention<span class="constructor">_layer(<span class="params">array_ops</span>.<span class="params">concat</span>([<span class="params">cell_output</span>, <span class="params">context</span>], 1)</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        attention = context</span><br><span class="line">    return attention, alignments</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个方法接收四个参数，其中 attention<em>mechanism 就是 AttentionMechanism 的实例，cell_output 就是当前 Output，previous_alignments 是上步的 alignments 信息，调用 attention_mechanism 计算之后就会得到当前步的 alignments 信息了，即 $ \alpha</em>{ij} $。接下来再利用 alignments 信息进行加权运算，得到 attention 信息，即 $ c_{i} $，最后将二者返回。 在第四步中，就是将 attention 结果每个时间步进行 concat，得到 attention vector。 第五步中，声明 AttentionWrapperState 作为下一步的状态。 第六步，判断是否要输出 Attention，如果是，输出 Attention 及下一步状态，否则输出 Outputs 及下一步状态。 好，以上便是整个 AttentionWrapper 源码解析过程，了解了源码之后，再做模型优化的话就非常得心应手了。</p>
                  <h2 id="参考来源"><a href="#参考来源" class="headerlink" title="参考来源"></a><a href="https://github.com/Germey/AI/blob/master/Attention%E5%8E%9F%E7%90%86%E5%8F%8ATensorFlow%20AttentionWrapper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md#%E5%8F%82%E8%80%83%E6%9D%A5%E6%BA%90" target="_blank" rel="noopener"></a>参考来源</h2>
                  <ul>
                    <li><a href="https://arxiv.org/abs/1406.1078" target="_blank" rel="noopener">Learning Phrase Representations using RNN Encoder-Decoder for Statistical Machine Translation, Cho et al</a></li>
                    <li><a href="https://arxiv.org/abs/1409.3215" target="_blank" rel="noopener">Sequence to Sequence Learning with Neural Networks, Sutskever et al</a></li>
                    <li><a href="https://arxiv.org/abs/1409.0473" target="_blank" rel="noopener">Neural Machine Translation by Jointly Learning to Align and Translate, Bahdanau et al</a></li>
                    <li><a href="https://arxiv.org/abs/1508.04025" target="_blank" rel="noopener">Effective Approaches to Attention-based Neural Machine Translation, Luong, et al</a></li>
                    <li><a href="https://arxiv.org/abs/1602.07868" target="_blank" rel="noopener">Weight Normalization: A Simple Reparameterization to Accelerate Training of Deep Neural Networks, Salimans, et al</a></li>
                    <li><a href="http://news.ifeng.com/a/20170901/51842411_0.shtml" target="_blank" rel="noopener">http://news.ifeng.com/a/20170901/51842411_0.shtml</a></li>
                    <li><a href="https://blog.csdn.net/qsczse943062710/article/details/79539005" target="_blank" rel="noopener">https://blog.csdn.net/qsczse943062710/article/details/79539005</a></li>
                    <li><a href="https://zhuanlan.zhihu.com/p/34393028" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/34393028</a></li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-25 01:41:33" itemprop="dateCreated datePublished" datetime="2018-03-25T01:41:33+08:00">2018-03-25</time>
                </span>
                <span id="/5873.html" class="post-meta-item leancloud_visitors" data-flag-title="Attention原理及TensorFlow AttentionWrapper源码解析" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>14k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>13 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5846.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5846.html" class="post-title-link" itemprop="url">Requests库作者另一神器Pipenv的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
                  <p>我们在运行 Python 项目的时候经常会遇到一些版本问题，例如 A 项目依赖于 Django 1.5，而 B 项目又依赖 Django 2.0，而我们的系统却只有一个 Python 解释器，我们所有的包都被装在了 Python 安装目录的 site-packages 目录下，所以 Django 只能是某个特定的版本，所以这样就会导致运行的时候导致 A 或 B 项目出现兼容问题。为了解决这个问题，我们可能会使用 virtualenv 来为项目创建一套独立的 Python 运行环境，或者我们可能会使用 Docker 容器来实现不同项目的隔离运行，但总的来说，它们使用起来其实并没有那么方便。另外在进行 Python 包管理时，requirements.txt 这样的包依赖标识文件也显得很鸡肋，在某些情况下可能会带来一些麻烦。为了解决这些问题，一个更加使用方便的包管理工具诞生了，叫做 Pipenv，接下来就让我们一起来了解一下它的用法。</p>
                  <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2>
                  <p>Pipenv，它的项目简介为 Python Development Workflow for Humans，是 Python 著名的 requests 库作者 kennethreitz 写的一个包管理工具，它可以为我们的项目自动创建和管理虚拟环境并非常方便地管理 Python 包，现在它也已经是 Python 官方推荐的包管理工具。 Pipenv 我们可以简单理解为 pip 和 virtualenv 的集合体，它可以为我们的项目自动创建和管理一个虚拟环境。virtualenv 在使用时我们需要手动创建一个虚拟环境然后激活，Pipenv 会自动创建。另外我们之前可能使用 requirements.txt 文件来标识项目所需要的依赖，但是这样会带来一些问题，如有的 requirements.txt 中只是将库名列出来了，没有严格指定版本号，这样就可能会导致不同时间安装的库版本是不同的，如 requirements.txt 文件中对 Django 的依赖只写了一个 django，可能在 2016 年的时候运行安装会安装 Django 的 1.x 版本，到了 2017 年就会安装 Django 的 2.x 版本，所以可能导致一些麻烦。为了解决这个问题，Pipenv 直接弃用了 requirements.txt，会同时它会使用一个叫做 Pipfile 和 Pipfile.lock 的文件来管理项目所需的依赖包，而不再是简单地使用 requirements.txt 文件来记录项目所需要的依赖。 总的来说，Pipenv 可以解决如下问题：</p>
                  <ul>
                    <li>我们不需要再手动创建虚拟环境，Pipenv 会自动为我们创建，它会在某个特定的位置创建一个 virtualenv 环境，然后调用 pipenv shell 命令切换到虚拟环境。</li>
                    <li>使用 requirements.txt 可能会导致一些问题，所以 Pipenv 使用 Pipfile 和 Pipfile.lock 来替代之，而且 Pipfile 如果不存在的话会自动创建，而且在安装、升级、移除依赖包的时候会自动更新 Pipfile 和 Pipfile.lock 文件。</li>
                    <li>广泛使用 Hash 校验，保证安全性。</li>
                    <li>可以更清晰地查看 Python 包及其关系，调用 pipenv graph 即可呈现，结果简单明了。</li>
                    <li>可通过自动加载 .env 读取环境变量，简化开发流程。</li>
                  </ul>
                  <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2>
                  <p>本文内容基于 Python 3.6 说明，默认的 Python 解释器命令为 python3，包管理工具命令为 pip3。 Pipenv 是基于 Python 开发的包，所以可以直接用 pip 来安装，命令如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> pipenv</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外还有多种安装方式，如 Pipsi、Nix、Homebrew，安装方式可以参考：<a href="http://pipenv.readthedocs.io/en/latest/#install-pipenv-today" target="_blank" rel="noopener">http://pipenv.readthedocs.io/en/latest/#install-pipenv-today</a>。</p>
                  <h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2>
                  <p>首先我们可以新建一个项目，例如叫做 PipenvTest，然后新建一个 Python 脚本，例如叫 main.py，内容为：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import django</span><br><span class="line">print(<span class="name">django</span>.get_version())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>直接用系统的 Python3 运行此脚本：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">python3</span> main.<span class="keyword">py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">1.11</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们可以看到系统安装的 Django 版本是 1.11。但是我们想要本项目基于 Django 2.x 开发，当然我们可以选择将系统的 Django 版本升级，但这样又可能会影响其他的项目的运行，所以这并不是一个好的选择。为了不影响系统环境的 Django 版本，所以我们可以用 Pipenv 来创建一个虚拟环境。 在该目录下，输入 pipenv 命令即可查看命令的完整用法：</p>
                  <figure class="highlight">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">Usage</span>: pipenv [OPTIONS] COMMAND [ARGS]...</span><br><span class="line"></span><br><span class="line"><span class="attribute">Options:</span></span><br><span class="line">  --update         Update Pipenv &amp; pip to latest.</span><br><span class="line">  --where          Output project home information.</span><br><span class="line">  --venv           Output virtualenv information.</span><br><span class="line">  --py             Output Python interpreter information.</span><br><span class="line">  --envs           Output Environment Variable options.</span><br><span class="line">  --rm             Remove the virtualenv.</span><br><span class="line">  --bare           Minimal output.</span><br><span class="line">  --completion     Output completion (to be eval'd).</span><br><span class="line">  --man            Display manpage.</span><br><span class="line">  --three / --two  Use Python 3/2 when creating virtualenv.</span><br><span class="line">  --python TEXT    Specify which version of Python virtualenv should use.</span><br><span class="line">  --site-packages  Enable site-packages for the virtualenv.</span><br><span class="line">  --jumbotron      An easter egg, effectively.</span><br><span class="line">  --version        Show the version and exit.</span><br><span class="line">  -h, --help       Show this message and exit.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage Examples:</span><br><span class="line">   Create a new project using Python 3.6, specifically:</span><br><span class="line">   $ pipenv --python 3.6</span><br><span class="line"></span><br><span class="line">   Install all dependencies for a project (including dev):</span><br><span class="line">   $ pipenv install --dev</span><br><span class="line"></span><br><span class="line">   Create a lockfile containing pre-releases:</span><br><span class="line">   $ pipenv lock --pre</span><br><span class="line"></span><br><span class="line">   Show a graph of your installed dependencies:</span><br><span class="line">   $ pipenv graph</span><br><span class="line"></span><br><span class="line">   Check your installed dependencies for security vulnerabilities:</span><br><span class="line">   $ pipenv check</span><br><span class="line"></span><br><span class="line">   Install a local setup.py into your virtual environment/Pipfile:</span><br><span class="line">   $ pipenv install -e .</span><br><span class="line"></span><br><span class="line"><span class="attribute">Commands:</span></span><br><span class="line">  check      Checks for security vulnerabilities and against PEP 508 markers</span><br><span class="line">             provided in Pipfile.</span><br><span class="line">  graph      Displays currently–installed dependency graph information.</span><br><span class="line">  install    Installs provided packages and adds them to Pipfile, or (if none</span><br><span class="line">             is given), installs all packages.</span><br><span class="line">  lock       Generates Pipfile.lock.</span><br><span class="line">  open       View a given module in your editor.</span><br><span class="line">  run        Spawns a command installed into the virtualenv.</span><br><span class="line">  shell      Spawns a shell within the virtualenv.</span><br><span class="line">  uninstall  Un-installs a provided package and removes it from Pipfile.</span><br><span class="line">  update     Uninstalls all packages, and re-installs package(s) in [packages]</span><br><span class="line">             to latest compatible versions.</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来我们首先验证一下当前的项目是没有创建虚拟环境的，调用如下命令：</p>
                  <figure class="highlight ada">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="comment">--venv</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight gradle">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">No virtualenv has been created <span class="keyword">for</span> <span class="keyword">this</span> <span class="keyword">project</span> yet!</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这说明当前的项目尚未创建虚拟环境，接下来我们利用 Pipenv 来创建一个虚拟环境：</p>
                  <figure class="highlight ada">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="comment">--three</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>或</p>
                  <figure class="highlight ada">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="comment">--python 3.6</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>都可以创建一个 Python3 的虚拟环境，—three 代表创建一个 Python3 版本的虚拟环境，—python 则可以指定特定的 Python 版本，当然 —two 则创建一个 Python2 版本的虚拟环境，但前提你的系统必须装有该版本的 Python 才可以。 执行完毕之后，样例输出如下：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Warning: the environment variable LANG is not <span class="keyword">set</span>!</span><br><span class="line">We recommend setting this <span class="keyword">in</span> ~/.profile (<span class="keyword">or</span> equivalent) <span class="keyword">for</span> proper expected behavior.</span><br><span class="line">Creating a virtualenv <span class="keyword">for</span> this <span class="keyword">project</span>…</span><br><span class="line"><span class="keyword">Using</span> /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/python3 <span class="keyword">to</span> <span class="keyword">create</span> virtualenv…</span><br><span class="line">⠋Running virtualenv <span class="keyword">with</span> interpreter /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/python3</span><br><span class="line"><span class="keyword">Using</span> base prefix <span class="string">'/usr/local/Cellar/python3/3.6.1/Frameworks/Python.framework/Versions/3.6'</span></span><br><span class="line"><span class="keyword">New</span> python executable <span class="keyword">in</span> /<span class="keyword">Users</span>/CQC/.local/<span class="keyword">share</span>/virtualenvs/PipenvTest-VSTVh89E/<span class="keyword">bin</span>/python3<span class="number">.6</span></span><br><span class="line">Also creating executable <span class="keyword">in</span> /<span class="keyword">Users</span>/CQC/.local/<span class="keyword">share</span>/virtualenvs/PipenvTest-VSTVh89E/<span class="keyword">bin</span>/python</span><br><span class="line">Installing setuptools, pip, wheel...done.</span><br><span class="line">Virtualenv location: /<span class="keyword">Users</span>/CQC/.local/<span class="keyword">share</span>/virtualenvs/PipenvTest-VSTVh89E</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里显示 Pipenv 利用 /usr/local/bin/python3 作为 virtualenv 的解释器，然后在 /Users/CQC/.local/share/virtualenvs/PipenvTest-VSTVh89E/bin 目录下创建了一个新的 Python3 解释器，同时还创建了两个可执行文件别名 python3.6 和 python，另外我们还可以发现目录下多了一个 Pipfile 文件，这时虚拟环境就创建完成了。 我们切换到 PipenvTest-VSTVh89E/bin 目录查看一下文件结构，可以看到这里面包含了 pip、pip3、pip3.6、python、python3、python3.6 等可执行文件，实际上目录结构和使用 virtualenv 时是完全一样的，只不过文件夹的位置不同而已。 接下来我们可以切换到该虚拟环境下执行命令，执行如下命令即可：</p>
                  <figure class="highlight dockerfile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">shell</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行完毕之后样例输出如下：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Spawning environment shell (/bin/zsh). <span class="keyword">Use</span> <span class="string">'exit'</span> <span class="keyword">to</span> leave.</span><br><span class="line"><span class="keyword">source</span> /<span class="keyword">Users</span>/CQC/.local/<span class="keyword">share</span>/virtualenvs/PipenvTest-VSTVh89E/<span class="keyword">bin</span>/<span class="keyword">activate</span>                                                            </span><br><span class="line">CQC-MAC% <span class="keyword">source</span> /<span class="keyword">Users</span>/CQC/.local/<span class="keyword">share</span>/virtualenvs/PipenvTest-VSTVh89E/<span class="keyword">bin</span>/<span class="keyword">activate</span></span><br><span class="line">(PipenvTest-VSTVh89E) CQC-MAC%</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>实际上这也和 virtualenv 激活的流程一样，也是调用了类似 source venv/bin/activate 方法将这个路径加到全局环境变量最前面，这样就会优先调用该路径下的 python、python3、python3.6 可执行文件了。 这时候我们会发现命令行的样子就变了，前面多了一个 (PipenvTest-VSTVh89E) 的标识，代表当前我们已经切换到了虚拟环境下。 这时我们用 which 或 where 命令查看一下 Python 可执行文件的路径，命令如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(PipenvTest-VSTVh89E) CQC-MAC% which python3</span><br><span class="line"><span class="regexp">/Users/</span>CQC<span class="regexp">/.local/</span>share<span class="regexp">/virtualenvs/</span>PipenvTest-VSTVh89E<span class="regexp">/bin/</span>python3</span><br><span class="line">(PipenvTest-VSTVh89E) CQC-MAC% which python3.<span class="number">6</span></span><br><span class="line"><span class="regexp">/Users/</span>CQC<span class="regexp">/.local/</span>share<span class="regexp">/virtualenvs/</span>PipenvTest-VSTVh89E<span class="regexp">/bin/</span>python3.<span class="number">6</span></span><br><span class="line">(PipenvTest-VSTVh89E) CQC-MAC% which python</span><br><span class="line"><span class="regexp">/Users/</span>CQC<span class="regexp">/.local/</span>share<span class="regexp">/virtualenvs/</span>PipenvTest-VSTVh89E<span class="regexp">/bin/</span>python</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现当前的 Python 可执行路径都被切换到了 PipenvTest-VSTVh89E/bin 目录下，调用的是虚拟环境中的 Python 解释器，这时我们重新执行刚才的脚本，命令如下：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(PipenvTest-VSTVh89E) CQC-MAC% <span class="keyword">python3</span> main.<span class="keyword">py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时我们可以发现报了如下错误：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Traceback (most recent <span class="keyword">call</span> <span class="keyword">last</span>):</span><br><span class="line">  <span class="keyword">File</span> <span class="string">"main.py"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;<span class="keyword">module</span>&gt;</span><br><span class="line">    <span class="keyword">import</span> django</span><br><span class="line">ModuleNotFoundError: <span class="keyword">No</span> <span class="keyword">module</span> named <span class="string">'django'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这其实是因为新的虚拟环境没有安装任何的 Python 第三方包，实际上如果直接使用 virtualenv 时也是这样的结果。这是因为新的虚拟环境是一个全新的 Python 环境，它默认只包含了 Python 内置的包以及 pip、wheel、setuptools 包，其他的第三方包都没有安装。 这时我们可以使用 Pipenv 来安装 django 包，命令如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">install</span> django</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行后输出结果如下：</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Installing</span> <span class="string">django…</span></span><br><span class="line"><span class="attr">Collecting</span> <span class="string">django</span></span><br><span class="line">  <span class="attr">Downloading</span> <span class="string">Django-2.0.2-py3-none-any.whl (7.1MB)</span></span><br><span class="line"><span class="attr">Collecting</span> <span class="string">pytz (from django)</span></span><br><span class="line">  <span class="attr">Downloading</span> <span class="string">pytz-2018.3-py2.py3-none-any.whl (509kB)</span></span><br><span class="line"><span class="attr">Installing</span> <span class="string">collected packages: pytz, django</span></span><br><span class="line"><span class="attr">Successfully</span> <span class="string">installed django-2.0.2 pytz-2018.3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Adding</span> <span class="string">django to Pipfile's [packages]…</span></span><br><span class="line"><span class="attr">Locking</span> <span class="string">[dev-packages] dependencies…</span></span><br><span class="line"><span class="attr">Locking</span> <span class="string">[packages] dependencies…</span></span><br><span class="line"><span class="attr">Updated</span> <span class="string">Pipfile.lock (e101fb)!</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果有这样的输出结果就代表成功安装了 Django，可以看到此时安装的 Django 版本为 2.0，代表我们的虚拟环境成功安装了 Django 2.0 版本。 同时我们还注意到它输出了一句话叫做 Updated Pipfile.lock，这时我们可以发现项目路径下又生成了一个 Pipfile.lock 文件，内容如下：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_meta"</span>: &#123;</span><br><span class="line">        <span class="attr">"hash"</span>: &#123;</span><br><span class="line">            <span class="attr">"sha256"</span>: <span class="string">"7b9623243d9c22b1f333ee710aff70d0cbcdf1dd7e0aac69230dc76855d27270"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"host-environment-markers"</span>: &#123;</span><br><span class="line">            <span class="attr">"implementation_name"</span>: <span class="string">"cpython"</span>,</span><br><span class="line">            <span class="attr">"implementation_version"</span>: <span class="string">"3.6.1"</span>,</span><br><span class="line">            <span class="attr">"os_name"</span>: <span class="string">"posix"</span>,</span><br><span class="line">            <span class="attr">"platform_machine"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">            <span class="attr">"platform_python_implementation"</span>: <span class="string">"CPython"</span>,</span><br><span class="line">            <span class="attr">"platform_release"</span>: <span class="string">"17.4.0"</span>,</span><br><span class="line">            <span class="attr">"platform_system"</span>: <span class="string">"Darwin"</span>,</span><br><span class="line">            <span class="attr">"platform_version"</span>: <span class="string">"Darwin Kernel Version 17.4.0: Sun Dec 17 09:19:54 PST 2017; root:xnu-4570.41.2~1/RELEASE_X86_64"</span>,</span><br><span class="line">            <span class="attr">"python_full_version"</span>: <span class="string">"3.6.1"</span>,</span><br><span class="line">            <span class="attr">"python_version"</span>: <span class="string">"3.6"</span>,</span><br><span class="line">            <span class="attr">"sys_platform"</span>: <span class="string">"darwin"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"pipfile-spec"</span>: <span class="number">6</span>,</span><br><span class="line">        <span class="attr">"requires"</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">"sources"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"pypi"</span>,</span><br><span class="line">                <span class="attr">"url"</span>: <span class="string">"https://pypi.python.org/simple"</span>,</span><br><span class="line">                <span class="attr">"verify_ssl"</span>: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"default"</span>: &#123;</span><br><span class="line">        <span class="attr">"django"</span>: &#123;</span><br><span class="line">            <span class="attr">"hashes"</span>: [</span><br><span class="line">                <span class="string">"sha256:af18618ce3291be5092893d8522fe3919661bf3a1fb60e3858ae74865a4f07c2"</span>,</span><br><span class="line">                <span class="string">"sha256:9614851d4a7ff8cbd32b73c6076441f377c45a5bbff7e771798fb02c43c31f47"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"version"</span>: <span class="string">"==2.0.2"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"pytz"</span>: &#123;</span><br><span class="line">            <span class="attr">"hashes"</span>: [</span><br><span class="line">                <span class="string">"sha256:ed6509d9af298b7995d69a440e2822288f2eca1681b8cce37673dbb10091e5fe"</span>,</span><br><span class="line">                <span class="string">"sha256:f93ddcdd6342f94cea379c73cddb5724e0d6d0a1c91c9bdef364dc0368ba4fda"</span>,</span><br><span class="line">                <span class="string">"sha256:61242a9abc626379574a166dc0e96a66cd7c3b27fc10868003fa210be4bff1c9"</span>,</span><br><span class="line">                <span class="string">"sha256:ba18e6a243b3625513d85239b3e49055a2f0318466e0b8a92b8fb8ca7ccdf55f"</span>,</span><br><span class="line">                <span class="string">"sha256:07edfc3d4d2705a20a6e99d97f0c4b61c800b8232dc1c04d87e8554f130148dd"</span>,</span><br><span class="line">                <span class="string">"sha256:3a47ff71597f821cd84a162e71593004286e5be07a340fd462f0d33a760782b5"</span>,</span><br><span class="line">                <span class="string">"sha256:5bd55c744e6feaa4d599a6cbd8228b4f8f9ba96de2c38d56f08e534b3c9edf0d"</span>,</span><br><span class="line">                <span class="string">"sha256:887ab5e5b32e4d0c86efddd3d055c1f363cbaa583beb8da5e22d2fa2f64d51ef"</span>,</span><br><span class="line">                <span class="string">"sha256:410bcd1d6409026fbaa65d9ed33bf6dd8b1e94a499e32168acfc7b332e4095c0"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"version"</span>: <span class="string">"==2018.3"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"develop"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到里面标识了 Python 环境基本信息，以及依赖包的版本及 hashes 值。 另外我们还可以注意到 Pipfile 文件内容也有更新，[packages] 部分多了一句 django = “<em>“，标识了本项目依赖于 Django，这个其实类似于 requirements.txt 文件。 那么到这里有小伙伴可能就会问了， Pipfile 和 Pipfile.lock 有什么用呢？ Pipfile 其实一个 TOML 格式的文件，标识了该项目依赖包的基本信息，还区分了生产环境和开发环境的包标识，作用上类似 requirements.txt 文件，但是功能更为强大。Pipfile.lock 详细标识了该项目的安装的包的精确版本信息、最新可用版本信息和当前库文件的 hash 值，顾明思义，它起了版本锁的作用，可以注意到当前 Pipfile.lock 文件中的 Django 版本标识为 ==2.0.2，意思是当前我们开发时使用的就是 2.0.2 版本，它可以起到版本锁定的功能。 举个例子，刚才我们安装了 Django 2.0.2 的版本，即目前（2018.2.27）的最新版本。但可能 Django 以后还会有更新，比如某一天 Django 更新到了 2.1 版本，这时如果我们想要重新部署本项目到另一台机器上，假如此时不存在 Pipfile.lock 文件，只存在 Pipfile文件，由于 Pipfile 文件中标识的 Django 依赖为 django = “</em>“，即没有版本限制，它会默认安装最新版本的 Django，即 2.1，但由于 Pipfile.lock 文件的存在，它会根据 Pipfile.lock 来安装，还是会安装 Django 2.0.2，这样就会避免一些库版本更新导致不兼容的问题。 请记住：任何情况下都不要手动修改 Pipfile.lock 文件！ 好，接下来我们再回归正题，现在已经安装好了 Django 了，那么我们重新运行此脚本便可以成功输出 Django 版本信息了：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(PipenvTest-VSTVh89E) CQC-MAC% <span class="keyword">python3</span> main.<span class="keyword">py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2.0</span><span class="number">.2</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就成功安装了 Django 2.x 了，和系统的 Django 1.11 没有任何冲突。 在此模式的命令行下，我们就可以使用虚拟环境下的 Python 解释器，而且所安装的依赖包对外部系统没有任何影响，而且使用 Pipfile 和 Pipfile.lock 来管理项目的依赖更加方便和健壮。 如果想要退出虚拟环境，只需要输入 exit 命令即可：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(PipenvTest-VSTVh89E) CQC-MAC% <span class="keyword">exit</span></span><br><span class="line">➜  PipenvTest python3 main.py </span><br><span class="line"><span class="number">1.11</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输入退出命令之后，我们重新再运行此脚本，就会重新使用系统的 Python 解释器，Django 版本又重新回到了 1.11。 由此可以看来，有了 Pipenv，我们可以使用 Pipfile 和 Pipfile.lock 来方便地管理和维护项目的依赖包，而且可以实现虚拟环境运行，避免了包冲突问题，可谓一举两得。</p>
                  <h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2>
                  <p>上文我们介绍了 Pipenv 的基本操作，下面我们再介绍一下它的一些常用命令。</p>
                  <h3 id="虚拟环境路径"><a href="#虚拟环境路径" class="headerlink" title="虚拟环境路径"></a>虚拟环境路径</h3>
                  <p>我们可以使用 —venv 参数来获得虚拟环境路径：</p>
                  <figure class="highlight ada">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="comment">--venv</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>样例输出如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="regexp">/Users/</span>CQC<span class="regexp">/.local/</span>share<span class="regexp">/virtualenvs/</span>PipenvTest-VSTVh89E</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可见这个路径是一个标准的路径，Pipenv 会把虚拟环境统一放到 virtualenvs 文件夹下，而不是本项目路径下。</p>
                  <h3 id="Python-解释器路径"><a href="#Python-解释器路径" class="headerlink" title="Python 解释器路径"></a>Python 解释器路径</h3>
                  <p>要获取虚拟环境 Python 解释器路径，可以使用 —py 参数：</p>
                  <figure class="highlight ada">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="comment">--py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>样例输出如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="regexp">/Users/</span>CQC<span class="regexp">/.local/</span>share<span class="regexp">/virtualenvs/</span>PipenvTest-VSTVh89E<span class="regexp">/bin/</span>python</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="加载系统-Python-包"><a href="#加载系统-Python-包" class="headerlink" title="加载系统 Python 包"></a>加载系统 Python 包</h3>
                  <p>默认情况下，新创建的虚拟环境是不包含任何第三方包的，但我们也可以开启加载系统 Python 包功能，使用 —site-packages 即可：</p>
                  <figure class="highlight ada">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="comment">--site-packages</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样创建的虚拟环境便可以使用系统已安装的 Python 包了。</p>
                  <h3 id="开启虚拟环境"><a href="#开启虚拟环境" class="headerlink" title="开启虚拟环境"></a>开启虚拟环境</h3>
                  <p>要开启虚拟环境只需要执行如下命令：</p>
                  <figure class="highlight dockerfile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">shell</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就可以进入虚拟环境，此时运行的 python、python3 命令都是虚拟环境下的。</p>
                  <h3 id="安装-Python-包"><a href="#安装-Python-包" class="headerlink" title="安装 Python 包"></a>安装 Python 包</h3>
                  <p>安装 Python 包我们不再需要 pip 来安装，直接使用 Pipenv 也可安装，如安装 requests，命令如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">install</span> requests</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装完成之后会同时更新项目目录下的 Pipfile 和 Pipfile.lock 文件。 有时候一些 Python 包是仅仅开发环境需要的，如 pytest，这时候我们通过添加 —dev 参数即可，命令如下：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">install</span> pytest <span class="comment">--dev</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时候，pytest 的依赖便会记录在 Pipfile 的 [dev-packages] 区域：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="section">[dev-packages]</span></span><br><span class="line"><span class="attr">pytest</span> = <span class="string">"*"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="获取包依赖"><a href="#获取包依赖" class="headerlink" title="获取包依赖"></a>获取包依赖</h3>
                  <p>我们可以使用命令来清晰地呈现出当前安装的 Python 包版本及之间的依赖关系，命令如下：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">pipenv graph</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>样例结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Django==<span class="number">2.0</span><span class="number">.2</span></span><br><span class="line">  - pytz [required: Any, installed: <span class="number">2018.3</span>]</span><br><span class="line">pytest==<span class="number">3.4</span><span class="number">.1</span></span><br><span class="line">  - attrs [required: &gt;=<span class="number">17.2</span><span class="number">.0</span>, installed: <span class="number">17.4</span><span class="number">.0</span>]</span><br><span class="line">  - pluggy [required: &lt;<span class="number">0.7</span>,&gt;=<span class="number">0.5</span>, installed: <span class="number">0.6</span><span class="number">.0</span>]</span><br><span class="line">  - py [required: &gt;=<span class="number">1.5</span><span class="number">.0</span>, installed: <span class="number">1.5</span><span class="number">.2</span>]</span><br><span class="line">  - setuptools [required: Any, installed: <span class="number">38.5</span><span class="number">.1</span>]</span><br><span class="line">  - six [required: &gt;=<span class="number">1.10</span><span class="number">.0</span>, installed: <span class="number">1.11</span><span class="number">.0</span>]</span><br><span class="line">requests==<span class="number">2.18</span><span class="number">.4</span></span><br><span class="line">  - certifi [required: &gt;=<span class="number">2017.4</span><span class="number">.17</span>, installed: <span class="number">2018.1</span><span class="number">.18</span>]</span><br><span class="line">  - chardet [required: &gt;=<span class="number">3.0</span><span class="number">.2</span>,&lt;<span class="number">3.1</span><span class="number">.0</span>, installed: <span class="number">3.0</span><span class="number">.4</span>]</span><br><span class="line">  - idna [required: &lt;<span class="number">2.7</span>,&gt;=<span class="number">2.5</span>, installed: <span class="number">2.6</span>]</span><br><span class="line">  - urllib3 [required: &lt;<span class="number">1.23</span>,&gt;=<span class="number">1.21</span><span class="number">.1</span>, installed: <span class="number">1.22</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到结果非常清晰，Django 当前安装了 2.0.2版本，依赖于 pytz 任何版本，已经安装了 2018.3 版本；pytest 已经安装了 3.4.1 版本，依赖 attrs&gt;=17.2.0 版本，已经安装了 17.4.0 版本，另外还依赖 pluggy、py、setuptools、six 这些库。总之包的依赖关系一目了然。</p>
                  <h3 id="卸载-Python-包"><a href="#卸载-Python-包" class="headerlink" title="卸载 Python 包"></a>卸载 Python 包</h3>
                  <p>卸载 Python 包也非常简单，如卸载 requests 包，命令如下：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">pipenv uninstall requests</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>卸载完成之后，Pipfile 和 Pipfile.lock 文件同样会更新。 如果要卸载全部 Python 包，可以添加 —all 参数：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">uninstall</span> <span class="comment">--all</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="产生-Pipfile-lock"><a href="#产生-Pipfile-lock" class="headerlink" title="产生 Pipfile.lock"></a>产生 Pipfile.lock</h3>
                  <p>有时候可能 Pipfile.lock 文件不存在或被删除了，这时候我们可以使用如下命令生成：</p>
                  <figure class="highlight cos">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pipenv <span class="keyword">lock</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上便是一些常用的 Pipenv 命令，如果要查看更多用法可以参考其官方文档：<a href="https://docs.pipenv.org/#pipenv-usage" target="_blank" rel="noopener">https://docs.pipenv.org/#pipenv-usage</a>。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>本文介绍了 Pipenv 的基本用法，作为 pip 和 virtualenv 的结合体，我们可以利用它更方便地创建和管理 Python 虚拟环境，还可以用更加科学的方式管理 Python 包，一举两得。 嗯，是时候抛弃 virtualenv 和 pip 了！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-15 21:39:41" itemprop="dateCreated datePublished" datetime="2018-03-15T21:39:41+08:00">2018-03-15</time>
                </span>
                <span id="/5846.html" class="post-meta-item leancloud_visitors" data-flag-title="Requests库作者另一神器Pipenv的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>12k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>10 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5844.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5844.html" class="post-title-link" itemprop="url">中文分词原理及工具</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2>
                  <p>中文分词，即 Chinese Word Segmentation，即将一个汉字序列进行切分，得到一个个单独的词。表面上看，分词其实就是那么回事，但分词效果好不好对信息检索、实验结果还是有很大影响的，同时分词的背后其实是涉及各种各样的算法的。 中文分词与英文分词有很大的不同，对英文而言，一个单词就是一个词，而汉语是以字为基本的书写单位，词语之间没有明显的区分标记，需要人为切分。根据其特点，可以把分词算法分为四大类：</p>
                  <ul>
                    <li>基于规则的分词方法</li>
                    <li>基于统计的分词方法</li>
                    <li>基于语义的分词方法</li>
                    <li>基于理解的分词方法</li>
                  </ul>
                  <p>下面我们对这几种方法分别进行总结。</p>
                  <h3 id="基于规则的分词方法"><a href="#基于规则的分词方法" class="headerlink" title="基于规则的分词方法"></a>基于规则的分词方法</h3>
                  <p>这种方法又叫作机械分词方法、基于字典的分词方法，它是按照一定的策略将待分析的汉字串与一个“充分大的”机器词典中的词条进行匹配。若在词典中找到某个字符串，则匹配成功。该方法有三个要素，即分词词典、文本扫描顺序和匹配原则。文本的扫描顺序有正向扫描、逆向扫描和双向扫描。匹配原则主要有最大匹配、最小匹配、逐词匹配和最佳匹配。</p>
                  <ul>
                    <li>最大匹配法（MM）。基本思想是：假设自动分词词典中的最长词条所含汉字的个数为 i，则取被处理材料当前字符串序列中的前 i 个字符作为匹配字段，查找分词词典，若词典中有这样一个 i 字词，则匹配成功，匹配字段作为一个词被切分出来；若词典中找不到这样的一个 i 字词，则匹配失败，匹配字段去掉最后一个汉字，剩下的字符作为新的匹配字段，再进行匹配，如此进行下去，直到匹配成功为止。统计结果表明，该方法的错误率 为 1/169。</li>
                    <li>逆向最大匹配法（RMM）。该方法的分词过程与 MM 法相同，不同的是从句子（或文章）末尾开始处理，每次匹配不成功时去掉的是前面的一个汉字。统计结果表明，该方法的错误率为 1/245。</li>
                    <li>逐词遍历法。把词典中的词按照由长到短递减的顺序逐字搜索整个待处理的材料，一直到把全部的词切分出来为止。不论分词词典多大，被处理的材料多么小，都得把这个分词词典匹配一遍。</li>
                    <li>设立切分标志法。切分标志有自然和非自然之分。自然切分标志是指文章中出现的非文字符号，如标点符号等；非自然标志是利用词缀和不构成词的词（包 括单音词、复音节词以及象声词等）。设立切分标志法首先收集众多的切分标志，分词时先找出切分标志，把句子切分为一些较短的字段，再用 MM、RMM 或其它的方法进行细加工。这种方法并非真正意义上的分词方法，只是自动分词的一种前处理方式而已，它要额外消耗时间扫描切分标志，增加存储空间存放那些非 自然切分标志。</li>
                    <li>最佳匹配法（OM）。此法分为正向的最佳匹配法和逆向的最佳匹配法，其出发点是：在词典中按词频的大小顺序排列词条，以求缩短对分词词典的检索时 间，达到最佳效果，从而降低分词的时间复杂度，加快分词速度。实质上，这种方法也不是一种纯粹意义上的分词方法，它只是一种对分词词典的组织方式。OM 法的分词词典每条词的前面必须有指明长度的数据项，所以其空间复杂度有所增加，对提高分词精度没有影响，分词处理的时间复杂度有所降低。</li>
                  </ul>
                  <p>此种方法优点是简单，易于实现。但缺点有很多：匹配速度慢；存在交集型和组合型歧义切分问题；词本身没有一个标准的定义，没有统一标准的词集；不同词典产生的歧义也不同；缺乏自学习的智能性。</p>
                  <h3 id="基于统计的分词方法"><a href="#基于统计的分词方法" class="headerlink" title="基于统计的分词方法"></a>基于统计的分词方法</h3>
                  <p>该方法的主要思想：词是稳定的组合，因此在上下文中，相邻的字同时出现的次数越多，就越有可能构成一个词。因此字与字相邻出现的概率或频率能较好地反映成词的可信度。可以对训练文本中相邻出现的各个字的组合的频度进行统计，计算它们之间的互现信息。互现信息体现了汉字之间结合关系的紧密程度。当紧密程 度高于某一个阈值时，便可以认为此字组可能构成了一个词。该方法又称为无字典分词。 该方法所应用的主要的统计模型有：N 元文法模型（N-gram）、隐马尔可夫模型（Hiden Markov Model，HMM）、最大熵模型（ME）、条件随机场模型（Conditional Random Fields，CRF）等。 在实际应用中此类分词算法一般是将其与基于词典的分词方法结合起来，既发挥匹配分词切分速度快、效率高的特点，又利用了无词典分词结合上下文识别生词、自动消除歧义的优点。</p>
                  <h3 id="基于语义的分词方法"><a href="#基于语义的分词方法" class="headerlink" title="基于语义的分词方法"></a>基于语义的分词方法</h3>
                  <p>语义分词法引入了语义分析，对自然语言自身的语言信息进行更多的处理，如扩充转移网络法、知识分词语义分析法、邻接约束法、综合匹配法、后缀分词法、特征词库法、矩阵约束法、语法分析法等。</p>
                  <ul>
                    <li>扩充转移网络法。该方法以有限状态机概念为基础。有限状态机只能识别正则语言，对有限状态机作的第一次扩充使其具有递归能力，形成递归转移网络 （RTN）。在RTN 中，弧线上的标志不仅可以是终极符（语言中的单词）或非终极符（词类），还可以调用另外的子网络名字分非终极符（如字或字串的成词条件）。这样，计算机在 运行某个子网络时，就可以调用另外的子网络，还可以递归调用。词法扩充转移网络的使用， 使分词处理和语言理解的句法处理阶段交互成为可能，并且有效地解决了汉语分词的歧义。</li>
                    <li>矩阵约束法。其基本思想是：先建立一个语法约束矩阵和一个语义约束矩阵， 其中元素分别表明具有某词性的词和具有另一词性的词相邻是否符合语法规则， 属于某语义类的词和属于另一词义类的词相邻是否符合逻辑，机器在切分时以之约束分词结果。</li>
                  </ul>
                  <h3 id="基于理解的分词方法"><a href="#基于理解的分词方法" class="headerlink" title="基于理解的分词方法"></a>基于理解的分词方法</h3>
                  <p>基于理解的分词方法是通过让计算机模拟人对句子的理解，达到识别词的效果。其基本思想就是在分词的同时进行句法、语义分析，利用句法信息和语义信息来处理歧义现象。它通常包括三个部分：分词子系统、句法语义子系统、总控部分。在总控部分的协调下，分词子系统可以获得有关词、句子等的句法和语义信息来对分词歧义进行判断，即它模拟了人对句子的理解过程。这种分词方法需要使用大量的语言知识和信息。目前基于理解的分词方法主要有专家系统分词法和神经网络分词法等。</p>
                  <ul>
                    <li>专家系统分词法。从专家系统角度把分词的知识（包括常识性分词知识与消除歧义切分的启发性知识即歧义切分规则）从实现分词过程的推理机中独立出来，使知识库的维护与推理机的实现互不干扰，从而使知识库易于维护和管理。它还具有发现交集歧义字段和多义组合歧义字段的能力和一定的自学习功能。</li>
                    <li>神经网络分词法。该方法是模拟人脑并行，分布处理和建立数值计算模型工作的。它将分词知识所分散隐式的方法存入神经网络内部，通过自学习和训练修改内部权值，以达到正确的分词结果，最后给出神经网络自动分词结果，如使用 LSTM、GRU 等神经网络模型等。</li>
                    <li>神经网络专家系统集成式分词法。该方法首先启动神经网络进行分词，当神经网络对新出现的词不能给出准确切分时，激活专家系统进行分析判断，依据知识库进行推理，得出初步分析，并启动学习机制对神经网络进行训练。该方法可以较充分发挥神经网络与专家系统二者优势，进一步提高分词效率。</li>
                  </ul>
                  <p>以上便是对分词算法的基本介绍，接下来我们再介绍几个比较实用的分词 Python 库及它们的使用方法。</p>
                  <h2 id="分词工具"><a href="#分词工具" class="headerlink" title="分词工具"></a>分词工具</h2>
                  <p>在这里介绍几个比较有代表性的支持分词的 Python 库，主要有：</p>
                  <h3 id="1-jieba"><a href="#1-jieba" class="headerlink" title="1. jieba"></a>1. jieba</h3>
                  <p>专用于分词的 Python 库，GitHub：<a href="https://github.com/fxsjy/jieba" target="_blank" rel="noopener">https://github.com/fxsjy/jieba</a>，分词效果较好。 支持三种分词模式：</p>
                  <ul>
                    <li>精确模式，试图将句子最精确地切开，适合文本分析。</li>
                    <li>全模式，将句子中所有的可能成词的词语都扫描出来，速度非常快，但是不能解决歧义。</li>
                    <li>搜索引擎模式：在精确模式的基础上，对长词再次切分，提高召回率，适用于搜索引擎分词。</li>
                  </ul>
                  <p>另外 jieba 支持繁体分词，支持自定义词典。 其使用的算法是基于统计的分词方法，主要有如下几种：</p>
                  <ul>
                    <li>基于前缀词典实现高效的词图扫描，生成句子中汉字所有可能成词情况所构成的有向无环图 (DAG)</li>
                    <li>采用了动态规划查找最大概率路径, 找出基于词频的最大切分组合</li>
                    <li>对于未登录词，采用了基于汉字成词能力的 HMM 模型，使用了 Viterbi 算法</li>
                  </ul>
                  <h4 id="精确模式分词"><a href="#精确模式分词" class="headerlink" title="精确模式分词"></a>精确模式分词</h4>
                  <p>首先我们来看下精确模式分词，使用 lcut() 方法，类似 cut() 方法，其参数和 cut() 是一致的，只不过返回结果是列表而不是生成器，默认使用精确模式，代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import jieba</span><br><span class="line"><span class="keyword">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line"><span class="built_in">result</span> = jieba.lcut(<span class="keyword">string</span>)</span><br><span class="line">print(<span class="built_in">len</span>(<span class="built_in">result</span>), <span class="string">'/'</span>.join(<span class="built_in">result</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">38</span> 这个<span class="regexp">/把手/</span>该换<span class="regexp">/了/</span>，<span class="regexp">/我/</span>不<span class="regexp">/喜欢/</span>日本<span class="regexp">/和服/</span>，<span class="regexp">/别/</span>把手<span class="regexp">/放在/</span>我<span class="regexp">/的/</span>肩膀<span class="regexp">/上/</span>，<span class="regexp">/工信处/</span>女干事<span class="regexp">/每月/</span>经过<span class="regexp">/下属/</span>科室<span class="regexp">/都/</span>要<span class="regexp">/亲口/</span>交代<span class="regexp">/24/</span>口<span class="regexp">/交换机/</span>等<span class="regexp">/技术性/</span>器件<span class="regexp">/的/</span>安装<span class="regexp">/工作</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可见分词效果还是不错的。</p>
                  <h4 id="全模式分词"><a href="#全模式分词" class="headerlink" title="全模式分词"></a>全模式分词</h4>
                  <p>使用全模式分词需要添加 cut_all 参数，将其设置为 True，代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">result</span> = jieba.lcut(<span class="keyword">string</span>, cut_all=True)</span><br><span class="line">print(<span class="built_in">len</span>(<span class="built_in">result</span>), <span class="string">'/'</span>.join(<span class="built_in">result</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">51</span> 这个<span class="regexp">/把手/</span>该换<span class="regexp">/了/</span><span class="regexp">//</span>我<span class="regexp">/不/</span>喜欢<span class="regexp">/日本/</span>和服<span class="regexp">//</span><span class="regexp">/别/</span>把手<span class="regexp">/放在/</span>我<span class="regexp">/的/</span>肩膀<span class="regexp">/上/</span><span class="regexp">//</span>工信处<span class="regexp">/处女/</span>女干事<span class="regexp">/干事/</span>每月<span class="regexp">/月经/</span>经过<span class="regexp">/下属/</span>科室<span class="regexp">/都/</span>要<span class="regexp">/亲口/</span>口交<span class="regexp">/交代/</span><span class="number">24</span><span class="regexp">/口交/</span>交换<span class="regexp">/交换机/</span>换机<span class="regexp">/等/</span>技术<span class="regexp">/技术性/</span>性器<span class="regexp">/器件/</span>的<span class="regexp">/安装/</span>安装工<span class="regexp">/装工/</span>工作</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="搜索引擎模式分词"><a href="#搜索引擎模式分词" class="headerlink" title="搜索引擎模式分词"></a>搜索引擎模式分词</h4>
                  <p>使用搜索引擎模式分词需要调用 cut_for_search() 方法，代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">result</span> = jieba.lcut_for_search(<span class="keyword">string</span>)</span><br><span class="line">print(<span class="built_in">len</span>(<span class="built_in">result</span>), <span class="string">'/'</span>.join(<span class="built_in">result</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">42</span> 这个<span class="regexp">/把手/</span>该换<span class="regexp">/了/</span>，<span class="regexp">/我/</span>不<span class="regexp">/喜欢/</span>日本<span class="regexp">/和服/</span>，<span class="regexp">/别/</span>把手<span class="regexp">/放在/</span>我<span class="regexp">/的/</span>肩膀<span class="regexp">/上/</span>，<span class="regexp">/工信处/</span>干事<span class="regexp">/女干事/</span>每月<span class="regexp">/经过/</span>下属<span class="regexp">/科室/</span>都<span class="regexp">/要/</span>亲口<span class="regexp">/交代/</span><span class="number">24</span><span class="regexp">/口/</span>交换<span class="regexp">/换机/</span>交换机<span class="regexp">/等/</span>技术<span class="regexp">/技术性/</span>器件<span class="regexp">/的/</span>安装<span class="regexp">/工作</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外可以加入自定义词典，如我们想把 日本和服 作为一个整体，可以把它添加到词典中，代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">jieba.add_word(<span class="string">'日本和服'</span>)</span><br><span class="line"><span class="built_in">result</span> = jieba.lcut(<span class="keyword">string</span>)</span><br><span class="line">print(<span class="built_in">len</span>(<span class="built_in">result</span>), <span class="string">'/'</span>.join(<span class="built_in">result</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">37</span> 这个<span class="regexp">/把手/</span>该换<span class="regexp">/了/</span>，<span class="regexp">/我/</span>不<span class="regexp">/喜欢/</span>日本和服<span class="regexp">/，/</span>别<span class="regexp">/把手/</span>放在<span class="regexp">/我/</span>的<span class="regexp">/肩膀/</span>上<span class="regexp">/，/</span>工信处<span class="regexp">/女干事/</span>每月<span class="regexp">/经过/</span>下属<span class="regexp">/科室/</span>都<span class="regexp">/要/</span>亲口<span class="regexp">/交代/</span><span class="number">24</span><span class="regexp">/口/</span>交换机<span class="regexp">/等/</span>技术性<span class="regexp">/器件/</span>的<span class="regexp">/安装/</span>工作</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到切分结果中，日本和服 四个字就作为一个整体出现在结果中了，分词数量比精确模式少了一个。</p>
                  <h4 id="词性标注"><a href="#词性标注" class="headerlink" title="词性标注"></a>词性标注</h4>
                  <p>另外 jieba 还支持词性标注，可以输出分词后每个词的词性，实例如下：</p>
                  <figure class="highlight applescript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">words</span> = pseg.lcut(<span class="built_in">string</span>)</span><br><span class="line">print(<span class="built_in">list</span>(map(lambda x: <span class="built_in">list</span>(x), <span class="built_in">words</span>)))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[<span class="symbol">'这个</span>', <span class="symbol">'r</span>'], [<span class="symbol">'把手</span>', <span class="symbol">'v</span>'], [<span class="symbol">'该</span>', <span class="symbol">'r</span>'], [<span class="symbol">'换</span>', <span class="symbol">'v</span>'], [<span class="symbol">'了</span>', <span class="symbol">'ul</span>'], [<span class="symbol">'，</span>', <span class="symbol">'x</span>'], [<span class="symbol">'我</span>', <span class="symbol">'r</span>'], [<span class="symbol">'不</span>', <span class="symbol">'d</span>'], [<span class="symbol">'喜欢</span>', <span class="symbol">'v</span>'], [<span class="symbol">'日本和服</span>', <span class="symbol">'x</span>'], [<span class="symbol">'，</span>', <span class="symbol">'x</span>'], [<span class="symbol">'别</span>', <span class="symbol">'r</span>'], [<span class="symbol">'把手</span>', <span class="symbol">'v</span>'], [<span class="symbol">'放在</span>', <span class="symbol">'v</span>'], [<span class="symbol">'我</span>', <span class="symbol">'r</span>'], [<span class="symbol">'的</span>', <span class="symbol">'uj</span>'], [<span class="symbol">'肩膀</span>', <span class="symbol">'n</span>'], [<span class="symbol">'上</span>', <span class="symbol">'f</span>'], [<span class="symbol">'，</span>', <span class="symbol">'x</span>'], [<span class="symbol">'工信处</span>', <span class="symbol">'n</span>'], [<span class="symbol">'女干事</span>', <span class="symbol">'n</span>'], [<span class="symbol">'每月</span>', <span class="symbol">'r</span>'], [<span class="symbol">'经过</span>', <span class="symbol">'p</span>'], [<span class="symbol">'下属</span>', <span class="symbol">'v</span>'], [<span class="symbol">'科室</span>', <span class="symbol">'n</span>'], [<span class="symbol">'都</span>', <span class="symbol">'d</span>'], [<span class="symbol">'要</span>', <span class="symbol">'v</span>'], [<span class="symbol">'亲口</span>', <span class="symbol">'n</span>'], [<span class="symbol">'交代</span>', <span class="symbol">'n</span>'], [<span class="symbol">'24</span>', <span class="symbol">'m</span>'], [<span class="symbol">'口</span>', <span class="symbol">'n</span>'], [<span class="symbol">'交换机</span>', <span class="symbol">'n</span>'], [<span class="symbol">'等</span>', <span class="symbol">'u</span>'], [<span class="symbol">'技术性</span>', <span class="symbol">'n</span>'], [<span class="symbol">'器件</span>', <span class="symbol">'n</span>'], [<span class="symbol">'的</span>', <span class="symbol">'uj</span>'], [<span class="symbol">'安装</span>', <span class="symbol">'v</span>'], [<span class="symbol">'工作</span>', <span class="symbol">'vn</span>']]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>关于词性的说明可以参考：<a href="https://gist.github.com/luw2007/6016931" target="_blank" rel="noopener">https://gist.github.com/luw2007/6016931</a>。</p>
                  <h3 id="2-SnowNLP"><a href="#2-SnowNLP" class="headerlink" title="2. SnowNLP"></a>2. SnowNLP</h3>
                  <p>SnowNLP: Simplified Chinese Text Processing，可以方便的处理中文文本内容，是受到了 TextBlob 的启发而写的，由于现在大部分的自然语言处理库基本都是针对英文的，于是写了一个方便处理中文的类库，并且和 TextBlob 不同的是，这里没有用 NLTK，所有的算法都是自己实现的，并且自带了一些训练好的字典。GitHub地址：<a href="https://github.com/isnowfy/snownlp" target="_blank" rel="noopener">https://github.com/isnowfy/snownlp</a>。</p>
                  <h4 id="分词"><a href="#分词" class="headerlink" title="分词"></a>分词</h4>
                  <p>这里的分词是基于 Character-Based Generative Model 来实现的，论文地址：<a href="http://aclweb.org/anthology//Y/Y09/Y09-2047.pdf" target="_blank" rel="noopener">http://aclweb.org/anthology//Y/Y09/Y09-2047.pdf</a>，我们还是以上面的例子说明，相关使用说明如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">from</span> snownlp import SnowNLP</span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line">s = SnowNLP(<span class="keyword">string</span>)</span><br><span class="line"><span class="built_in">result</span> = s.<span class="keyword">words</span></span><br><span class="line">print(<span class="built_in">len</span>(<span class="built_in">result</span>), <span class="string">'/'</span>.join(<span class="built_in">result</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">40</span> 这个<span class="regexp">/把手/</span>该<span class="regexp">/换/</span>了<span class="regexp">/，/</span>我<span class="regexp">/不/</span>喜欢<span class="regexp">/日本/</span>和<span class="regexp">/服/</span>，<span class="regexp">/别把手/</span>放在<span class="regexp">/我/</span>的<span class="regexp">/肩膀/</span>上<span class="regexp">/，/</span>工<span class="regexp">/信处女/</span>干事<span class="regexp">/每月/</span>经过<span class="regexp">/下属/</span>科室<span class="regexp">/都/</span>要<span class="regexp">/亲口/</span>交代<span class="regexp">/24/</span>口<span class="regexp">/交换机/</span>等<span class="regexp">/技术性/</span>器件<span class="regexp">/的/</span>安装<span class="regexp">/工作</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>经过观察，可以发现分词效果其实不怎么理想，和服 被分开了，工信处 也被分开了，女干事 也被分开了。 另外 SnowNLP 还支持很多功能，例如词性标注（HMM）、情感分析、拼音转换（Trie树）、关键词和摘要生成（TextRank）。 我们简单看一个实例：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">'Tags:'</span>, list(s.tags)</span></span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">'Sentiments:'</span>, s.sentiments)</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">'Pinyin:'</span>, s.pinyin)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">Tags</span>: <span class="selector-attr">[(<span class="string">'这个'</span>, <span class="string">'r'</span>), (<span class="string">'把手'</span>, <span class="string">'Ng'</span>), (<span class="string">'该'</span>, <span class="string">'r'</span>), (<span class="string">'换'</span>, <span class="string">'v'</span>), (<span class="string">'了'</span>, <span class="string">'y'</span>), (<span class="string">'，'</span>, <span class="string">'w'</span>), (<span class="string">'我'</span>, <span class="string">'r'</span>), (<span class="string">'不'</span>, <span class="string">'d'</span>), (<span class="string">'喜欢'</span>, <span class="string">'v'</span>), (<span class="string">'日本'</span>, <span class="string">'ns'</span>), (<span class="string">'和'</span>, <span class="string">'c'</span>), (<span class="string">'服'</span>, <span class="string">'v'</span>), (<span class="string">'，'</span>, <span class="string">'w'</span>), (<span class="string">'别把手'</span>, <span class="string">'ad'</span>), (<span class="string">'放在'</span>, <span class="string">'v'</span>), (<span class="string">'我'</span>, <span class="string">'r'</span>), (<span class="string">'的'</span>, <span class="string">'u'</span>), (<span class="string">'肩膀'</span>, <span class="string">'n'</span>), (<span class="string">'上'</span>, <span class="string">'f'</span>), (<span class="string">'，'</span>, <span class="string">'w'</span>), (<span class="string">'工'</span>, <span class="string">'j'</span>), (<span class="string">'信处女'</span>, <span class="string">'j'</span>), (<span class="string">'干事'</span>, <span class="string">'n'</span>), (<span class="string">'每月'</span>, <span class="string">'r'</span>), (<span class="string">'经过'</span>, <span class="string">'p'</span>), (<span class="string">'下属'</span>, <span class="string">'v'</span>), (<span class="string">'科室'</span>, <span class="string">'n'</span>), (<span class="string">'都'</span>, <span class="string">'d'</span>), (<span class="string">'要'</span>, <span class="string">'v'</span>), (<span class="string">'亲口'</span>, <span class="string">'d'</span>), (<span class="string">'交代'</span>, <span class="string">'v'</span>), (<span class="string">'24'</span>, <span class="string">'m'</span>), (<span class="string">'口'</span>, <span class="string">'q'</span>), (<span class="string">'交换机'</span>, <span class="string">'n'</span>), (<span class="string">'等'</span>, <span class="string">'u'</span>), (<span class="string">'技术性'</span>, <span class="string">'n'</span>), (<span class="string">'器件'</span>, <span class="string">'n'</span>), (<span class="string">'的'</span>, <span class="string">'u'</span>), (<span class="string">'安装'</span>, <span class="string">'vn'</span>), (<span class="string">'工作'</span>, <span class="string">'vn'</span>)]</span></span><br><span class="line"><span class="selector-tag">Sentiments</span>: 0<span class="selector-class">.015678817603646866</span></span><br><span class="line"><span class="selector-tag">Pinyin</span>: <span class="selector-attr">[<span class="string">'zhe'</span>, <span class="string">'ge'</span>, <span class="string">'ba'</span>, <span class="string">'shou'</span>, <span class="string">'gai'</span>, <span class="string">'huan'</span>, <span class="string">'liao'</span>, <span class="string">'，'</span>, <span class="string">'wo'</span>, <span class="string">'bu'</span>, <span class="string">'xi'</span>, <span class="string">'huan'</span>, <span class="string">'ri'</span>, <span class="string">'ben'</span>, <span class="string">'he'</span>, <span class="string">'fu'</span>, <span class="string">'，'</span>, <span class="string">'bie'</span>, <span class="string">'ba'</span>, <span class="string">'shou'</span>, <span class="string">'fang'</span>, <span class="string">'zai'</span>, <span class="string">'wo'</span>, <span class="string">'de'</span>, <span class="string">'jian'</span>, <span class="string">'bang'</span>, <span class="string">'shang'</span>, <span class="string">'，'</span>, <span class="string">'gong'</span>, <span class="string">'xin'</span>, <span class="string">'chu'</span>, <span class="string">'nv'</span>, <span class="string">'gan'</span>, <span class="string">'shi'</span>, <span class="string">'mei'</span>, <span class="string">'yue'</span>, <span class="string">'jing'</span>, <span class="string">'guo'</span>, <span class="string">'xia'</span>, <span class="string">'shu'</span>, <span class="string">'ke'</span>, <span class="string">'shi'</span>, <span class="string">'dou'</span>, <span class="string">'yao'</span>, <span class="string">'qin'</span>, <span class="string">'kou'</span>, <span class="string">'jiao'</span>, <span class="string">'dai'</span>, <span class="string">'24'</span>, <span class="string">'kou'</span>, <span class="string">'jiao'</span>, <span class="string">'huan'</span>, <span class="string">'ji'</span>, <span class="string">'deng'</span>, <span class="string">'ji'</span>, <span class="string">'shu'</span>, <span class="string">'xing'</span>, <span class="string">'qi'</span>, <span class="string">'jian'</span>, <span class="string">'de'</span>, <span class="string">'an'</span>, <span class="string">'zhuang'</span>, <span class="string">'gong'</span>, <span class="string">'zuo'</span>]</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="3-THULAC"><a href="#3-THULAC" class="headerlink" title="3. THULAC"></a>3. THULAC</h3>
                  <p>THULAC（THU Lexical Analyzer for Chinese）由清华大学自然语言处理与社会人文计算实验室研制推出的一套中文词法分析工具包，GitHub 链接：<a href="https://github.com/thunlp/THULAC-Python" target="_blank" rel="noopener">https://github.com/thunlp/THULAC-Python</a>，具有中文分词和词性标注功能。THULAC具有如下几个特点：</p>
                  <ul>
                    <li>能力强。利用集成的目前世界上规模最大的人工分词和词性标注中文语料库（约含5800万字）训练而成，模型标注能力强大。</li>
                    <li>准确率高。该工具包在标准数据集Chinese Treebank（CTB5）上分词的F1值可达97.3％，词性标注的F1值可达到92.9％，与该数据集上最好方法效果相当。</li>
                    <li>速度较快。同时进行分词和词性标注速度为300KB/s，每秒可处理约15万字。只进行分词速度可达到1.3MB/s。</li>
                  </ul>
                  <p>我们用一个实例看一下分词效果：</p>
                  <figure class="highlight go">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> thulac</span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line">t = thulac.thulac()</span><br><span class="line">result = t.cut(<span class="keyword">string</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[<span class="symbol">'这个</span>', <span class="symbol">'r</span>'], [<span class="symbol">'把手</span>', <span class="symbol">'n</span>'], [<span class="symbol">'该</span>', <span class="symbol">'v</span>'], [<span class="symbol">'换</span>', <span class="symbol">'v</span>'], [<span class="symbol">'了</span>', <span class="symbol">'u</span>'], [<span class="symbol">'，</span>', <span class="symbol">'w</span>'], [<span class="symbol">'我</span>', <span class="symbol">'r</span>'], [<span class="symbol">'不</span>', <span class="symbol">'d</span>'], [<span class="symbol">'喜欢</span>', <span class="symbol">'v</span>'], [<span class="symbol">'日本</span>', <span class="symbol">'ns</span>'], [<span class="symbol">'和服</span>', <span class="symbol">'n</span>'], [<span class="symbol">'，</span>', <span class="symbol">'w</span>'], [<span class="symbol">'别把手</span>', <span class="symbol">'n</span>'], [<span class="symbol">'放</span>', <span class="symbol">'v</span>'], [<span class="symbol">'在</span>', <span class="symbol">'p</span>'], [<span class="symbol">'我</span>', <span class="symbol">'r</span>'], [<span class="symbol">'的</span>', <span class="symbol">'u</span>'], [<span class="symbol">'肩膀</span>', <span class="symbol">'n</span>'], [<span class="symbol">'上</span>', <span class="symbol">'f</span>'], [<span class="symbol">'，</span>', <span class="symbol">'w</span>'], [<span class="symbol">'工信处</span>', <span class="symbol">'n</span>'], [<span class="symbol">'女</span>', <span class="symbol">'a</span>'], [<span class="symbol">'干事</span>', <span class="symbol">'n</span>'], [<span class="symbol">'每月</span>', <span class="symbol">'r</span>'], [<span class="symbol">'经过</span>', <span class="symbol">'p</span>'], [<span class="symbol">'下属</span>', <span class="symbol">'v</span>'], [<span class="symbol">'科室</span>', <span class="symbol">'n</span>'], [<span class="symbol">'都</span>', <span class="symbol">'d</span>'], [<span class="symbol">'要</span>', <span class="symbol">'v</span>'], [<span class="symbol">'亲口</span>', <span class="symbol">'d</span>'], [<span class="symbol">'交代</span>', <span class="symbol">'v</span>'], [<span class="symbol">'24</span>', <span class="symbol">'m</span>'], [<span class="symbol">'口</span>', <span class="symbol">'q</span>'], [<span class="symbol">'交换机</span>', <span class="symbol">'n</span>'], [<span class="symbol">'等</span>', <span class="symbol">'u</span>'], [<span class="symbol">'技术性</span>', <span class="symbol">'n</span>'], [<span class="symbol">'器件</span>', <span class="symbol">'n</span>'], [<span class="symbol">'的</span>', <span class="symbol">'u</span>'], [<span class="symbol">'安装</span>', <span class="symbol">'v</span>'], [<span class="symbol">'工作</span>', <span class="symbol">'v</span>']]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="4-NLPIR"><a href="#4-NLPIR" class="headerlink" title="4. NLPIR"></a>4. NLPIR</h3>
                  <p>NLPIR 分词系统，前身为2000年发布的 ICTCLAS 词法分析系统，GitHub 链接：<a href="https://github.com/NLPIR-team/NLPIR" target="_blank" rel="noopener">https://github.com/NLPIR-team/NLPIR</a>，是由北京理工大学张华平博士研发的中文分词系统，经过十余年的不断完善，拥有丰富的功能和强大的性能。NLPIR是一整套对原始文本集进行处理和加工的软件，提供了中间件处理效果的可视化展示，也可以作为小规模数据的处理加工工具。主要功能包括：中文分词，词性标注，命名实体识别，用户词典、新词发现与关键词提取等功能。另外对于分词功能，它有 Python 实现的版本，GitHub 链接：<a href="https://github.com/tsroten/pynlpir" target="_blank" rel="noopener">https://github.com/tsroten/pynlpir</a>。 使用方法如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pynlpir</span><br><span class="line"></span><br><span class="line">pynlpir.<span class="built_in">open</span>()</span><br><span class="line"><span class="keyword">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line"><span class="built_in">result</span> = pynlpir.<span class="keyword">segment</span>(<span class="keyword">string</span>)</span><br><span class="line">print(<span class="built_in">result</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[(<span class="symbol">'这个</span>', <span class="symbol">'pronoun</span>'), (<span class="symbol">'把</span>', <span class="symbol">'preposition</span>'), (<span class="symbol">'手</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'该</span>', <span class="symbol">'pronoun</span>'), (<span class="symbol">'换</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'了</span>', <span class="symbol">'modal</span> particle'), (<span class="symbol">'，</span>', <span class="symbol">'punctuation</span> mark'), (<span class="symbol">'我</span>', <span class="symbol">'pronoun</span>'), (<span class="symbol">'不</span>', <span class="symbol">'adverb</span>'), (<span class="symbol">'喜欢</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'日本</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'和</span>', <span class="symbol">'conjunction</span>'), (<span class="symbol">'服</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'，</span>', <span class="symbol">'punctuation</span> mark'), (<span class="symbol">'别</span>', <span class="symbol">'adverb</span>'), (<span class="symbol">'把</span>', <span class="symbol">'preposition</span>'), (<span class="symbol">'手</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'放</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'在</span>', <span class="symbol">'preposition</span>'), (<span class="symbol">'我</span>', <span class="symbol">'pronoun</span>'), (<span class="symbol">'的</span>', <span class="symbol">'particle</span>'), (<span class="symbol">'肩膀</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'上</span>', <span class="symbol">'noun</span> of locality'), (<span class="symbol">'，</span>', <span class="symbol">'punctuation</span> mark'), (<span class="symbol">'工</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'信</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'处女</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'干事</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'每月</span>', <span class="symbol">'pronoun</span>'), (<span class="symbol">'经过</span>', <span class="symbol">'preposition</span>'), (<span class="symbol">'下属</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'科室</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'都</span>', <span class="symbol">'adverb</span>'), (<span class="symbol">'要</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'亲口</span>', <span class="symbol">'adverb</span>'), (<span class="symbol">'交代</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'24</span>', <span class="symbol">'numeral</span>'), (<span class="symbol">'口</span>', <span class="symbol">'classifier</span>'), (<span class="symbol">'交换机</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'等</span>', <span class="symbol">'particle</span>'), (<span class="symbol">'技术性</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'器件</span>', <span class="symbol">'noun</span>'), (<span class="symbol">'的</span>', <span class="symbol">'particle</span>'), (<span class="symbol">'安装</span>', <span class="symbol">'verb</span>'), (<span class="symbol">'工作</span>', <span class="symbol">'verb</span>')]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 把手 和 和服 也被分开了。</p>
                  <h3 id="5-NLTK"><a href="#5-NLTK" class="headerlink" title="5. NLTK"></a>5. NLTK</h3>
                  <p>NLTK，Natural Language Toolkit，是一个自然语言处理的包工具，各种多种 NLP 处理相关功能，GitHub 链接：<a href="https://github.com/nltk/nltk" target="_blank" rel="noopener">https://github.com/nltk/nltk</a>。 但是 NLTK 对于中文分词是不支持的，示例如下：</p>
                  <figure class="highlight isbl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">from</span> <span class="variable">nltk</span> <span class="variable">import</span> <span class="variable">word_tokenize</span></span><br><span class="line"></span><br><span class="line"><span class="variable">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line"><span class="variable"><span class="class">result</span></span> = <span class="function"><span class="title">word_tokenize</span>(<span class="variable">string</span>)</span></span><br><span class="line"><span class="function"><span class="title">print</span>(<span class="variable"><span class="class">result</span></span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果要用中文分词的话，可以使用 FoolNLTK，它使用 Bi-LSTM 训练而成，包含分词、词性标注、实体识别等功能，同时支持自定义词典，可以训练自己的模型，可以进行批量处理。 使用方法如下：</p>
                  <figure class="highlight go">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> fool</span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line">result = fool.cut(<span class="keyword">string</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[<span class="symbol">'这个</span>', <span class="symbol">'把手</span>', <span class="symbol">'该</span>', <span class="symbol">'换</span>', <span class="symbol">'了</span>', <span class="symbol">'，</span>', <span class="symbol">'我</span>', <span class="symbol">'不</span>', <span class="symbol">'喜欢</span>', <span class="symbol">'日本</span>', <span class="symbol">'和服</span>', <span class="symbol">'，</span>', <span class="symbol">'别</span>', <span class="symbol">'把</span>', <span class="symbol">'手</span>', <span class="symbol">'放</span>', <span class="symbol">'在</span>', <span class="symbol">'我</span>', <span class="symbol">'的</span>', <span class="symbol">'肩膀</span>', <span class="symbol">'上</span>', <span class="symbol">'，</span>', <span class="symbol">'工信处</span>', <span class="symbol">'女</span>', <span class="symbol">'干事</span>', <span class="symbol">'每月</span>', <span class="symbol">'经过</span>', <span class="symbol">'下属</span>', <span class="symbol">'科室</span>', <span class="symbol">'都</span>', <span class="symbol">'要</span>', <span class="symbol">'亲</span>', <span class="symbol">'口</span>', <span class="symbol">'交代</span>', <span class="symbol">'24</span>', <span class="symbol">'口</span>', <span class="symbol">'交换机</span>', <span class="symbol">'等</span>', <span class="symbol">'技术性</span>', <span class="symbol">'器件</span>', <span class="symbol">'的</span>', <span class="symbol">'安装</span>', <span class="symbol">'工作</span>']]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到这个分词效果还是不错的。 另外还可以进行词性标注，实体识别：</p>
                  <figure class="highlight gauss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">result = fool.pos_cut(<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">print</span>(result)</span><br><span class="line">_, ners = fool.analysis(<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">print</span>(ners)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[(<span class="symbol">'这个</span>', <span class="symbol">'r</span>'), (<span class="symbol">'把手</span>', <span class="symbol">'n</span>'), (<span class="symbol">'该</span>', <span class="symbol">'r</span>'), (<span class="symbol">'换</span>', <span class="symbol">'v</span>'), (<span class="symbol">'了</span>', <span class="symbol">'y</span>'), (<span class="symbol">'，</span>', <span class="symbol">'wd</span>'), (<span class="symbol">'我</span>', <span class="symbol">'r</span>'), (<span class="symbol">'不</span>', <span class="symbol">'d</span>'), (<span class="symbol">'喜欢</span>', <span class="symbol">'vi</span>'), (<span class="symbol">'日本</span>', <span class="symbol">'ns</span>'), (<span class="symbol">'和服</span>', <span class="symbol">'n</span>'), (<span class="symbol">'，</span>', <span class="symbol">'wd</span>'), (<span class="symbol">'别</span>', <span class="symbol">'d</span>'), (<span class="symbol">'把</span>', <span class="symbol">'pba</span>'), (<span class="symbol">'手</span>', <span class="symbol">'n</span>'), (<span class="symbol">'放</span>', <span class="symbol">'v</span>'), (<span class="symbol">'在</span>', <span class="symbol">'p</span>'), (<span class="symbol">'我</span>', <span class="symbol">'r</span>'), (<span class="symbol">'的</span>', <span class="symbol">'ude</span>'), (<span class="symbol">'肩膀</span>', <span class="symbol">'n</span>'), (<span class="symbol">'上</span>', <span class="symbol">'f</span>'), (<span class="symbol">'，</span>', <span class="symbol">'wd</span>'), (<span class="symbol">'工信处</span>', <span class="symbol">'ns</span>'), (<span class="symbol">'女</span>', <span class="symbol">'b</span>'), (<span class="symbol">'干事</span>', <span class="symbol">'n</span>'), (<span class="symbol">'每月</span>', <span class="symbol">'r</span>'), (<span class="symbol">'经过</span>', <span class="symbol">'p</span>'), (<span class="symbol">'下属</span>', <span class="symbol">'v</span>'), (<span class="symbol">'科室</span>', <span class="symbol">'n</span>'), (<span class="symbol">'都</span>', <span class="symbol">'d</span>'), (<span class="symbol">'要</span>', <span class="symbol">'v</span>'), (<span class="symbol">'亲</span>', <span class="symbol">'a</span>'), (<span class="symbol">'口</span>', <span class="symbol">'n</span>'), (<span class="symbol">'交代</span>', <span class="symbol">'v</span>'), (<span class="symbol">'24</span>', <span class="symbol">'m</span>'), (<span class="symbol">'口</span>', <span class="symbol">'q</span>'), (<span class="symbol">'交换机</span>', <span class="symbol">'n</span>'), (<span class="symbol">'等</span>', <span class="symbol">'udeng</span>'), (<span class="symbol">'技术性</span>', <span class="symbol">'n</span>'), (<span class="symbol">'器件</span>', <span class="symbol">'n</span>'), (<span class="symbol">'的</span>', <span class="symbol">'ude</span>'), (<span class="symbol">'安装</span>', <span class="symbol">'n</span>'), (<span class="symbol">'工作</span>', <span class="symbol">'n</span>')]]</span><br><span class="line">[[(<span class="name">12</span>, <span class="number">15</span>, <span class="symbol">'location</span>', <span class="symbol">'日本</span>')]]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="6-LTP"><a href="#6-LTP" class="headerlink" title="6. LTP"></a>6. LTP</h3>
                  <p>语言技术平台（Language Technology Platform，LTP）是哈工大社会计算与信息检索研究中心历时十年开发的一整套中文语言处理系统。LTP制定了基于XML的语言处理结果表示，并在此基础上提供了一整套自底向上的丰富而且高效的中文语言处理模块（包括词法、句法、语义等6项中文处理核心技术），以及基于动态链接库（Dynamic Link Library, DLL）的应用程序接口、可视化工具，并且能够以网络服务（Web Service）的形式进行使用。 LTP 有 Python 版本，GitHub地址：<a href="https://github.com/HIT-SCIR/pyltp" target="_blank" rel="noopener">https://github.com/HIT-SCIR/pyltp</a>，另外运行的时候需要下载模型，模型还比较大，下载地址：<a href="http://ltp.ai/download.html" target="_blank" rel="noopener">http://ltp.ai/download.html</a>。 示例代码如下：</p>
                  <figure class="highlight isbl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">from</span> <span class="variable">pyltp</span> <span class="variable">import</span> <span class="variable">Segmentor</span></span><br><span class="line"></span><br><span class="line"><span class="variable">string</span> = <span class="string">'这个把手该换了，我不喜欢日本和服，别把手放在我的肩膀上，工信处女干事每月经过下属科室都要亲口交代24口交换机等技术性器件的安装工作'</span></span><br><span class="line"><span class="variable">segmentor</span> = <span class="function"><span class="title">Segmentor</span>()</span></span><br><span class="line"><span class="variable">segmentor.load</span>(<span class="string">'./cws.model'</span>)</span><br><span class="line"><span class="variable"><span class="class">result</span></span> = <span class="function"><span class="title">list</span>(<span class="variable">segmentor.segment</span>(<span class="variable">string</span>))</span></span><br><span class="line"><span class="variable">segmentor.release</span>()</span><br><span class="line"><span class="function"><span class="title">print</span>(<span class="variable"><span class="class">result</span></span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">41</span> 这个<span class="regexp">/把手/</span>该<span class="regexp">/换/</span>了<span class="regexp">/，/</span>我<span class="regexp">/不/</span>喜欢<span class="regexp">/日本/</span>和服<span class="regexp">/，/</span>别<span class="regexp">/把/</span>手<span class="regexp">/放在/</span>我<span class="regexp">/的/</span>肩膀<span class="regexp">/上/</span>，<span class="regexp">/工信/</span>处女<span class="regexp">/干事/</span>每月<span class="regexp">/经过/</span>下属<span class="regexp">/科室/</span>都<span class="regexp">/要/</span>亲口<span class="regexp">/交代/</span><span class="number">24</span><span class="regexp">/口/</span>交换机<span class="regexp">/等/</span>技术性<span class="regexp">/器件/</span>的<span class="regexp">/安装/</span>工作</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现 工信处、女干事 没有正确分开。 以上便是一些分词库的基本使用，个人比较推荐的有 jieba、THULAC、FoolNLTK。</p>
                  <h2 id="参考来源"><a href="#参考来源" class="headerlink" title="参考来源"></a>参考来源</h2>
                  <ul>
                    <li><a href="http://m635674608.iteye.com/blog/2298833" target="_blank" rel="noopener">http://m635674608.iteye.com/blog/2298833</a></li>
                    <li><a href="http://blog.csdn.net/flysky1991/article/details/73948971" target="_blank" rel="noopener">http://blog.csdn.net/flysky1991/article/details/73948971</a></li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-15 21:32:47" itemprop="dateCreated datePublished" datetime="2018-03-15T21:32:47+08:00">2018-03-15</time>
                </span>
                <span id="/5844.html" class="post-meta-item leancloud_visitors" data-flag-title="中文分词原理及工具" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>11k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>10 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5822.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5822.html" class="post-title-link" itemprop="url">深度学习 GPU环境 Ubuntu 16.04 + Nvidia GTX 1080 + Python 3.6 + CUDA 9.0 + cuDNN 7.1 + TensorFlow 1.6 环境配置</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节详细说明一下深度学习环境配置，Ubuntu 16.04 + Nvidia GTX 1080 + Python 3.6 + CUDA 9.0 + cuDNN 7.1 + TensorFlow 1.6。</p>
                  <h2 id="Python-3-6"><a href="#Python-3-6" class="headerlink" title="Python 3.6"></a>Python 3.6</h2>
                  <p>首先安装 Python 3.6，这里使用 Anaconda 3 来安装，下载地址：<a href="https://www.anaconda.com/download/#linux" target="_blank" rel="noopener">https://www.anaconda.com/download/#linux</a>，点击 Download 按钮下载即可，这里下载的是 Anaconda 3-5.1 版本，如果下载速度过慢可以选择使用清华镜像：<a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/</a>。 下载下来之后目录下会出现一个 Anaconda3-5.1.0-Linux-x86_64.sh 文件，然后直接执行即可安装：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">bash</span> <span class="selector-tag">Anaconda3-5</span><span class="selector-class">.1</span><span class="selector-class">.0-Linux-x86_64</span><span class="selector-class">.sh</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行完毕之后按照默认设置走下来即可完成安装。 这里默认它会安装到用户目录下，如果想全局安装，可以在这一步输入你要安装的地址：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Anaconda3 will now be installed into <span class="keyword">this</span> <span class="string">location:</span></span><br><span class="line"><span class="regexp">/home/</span>cqc/anaconda3</span><br><span class="line"></span><br><span class="line">  - Press ENTER to confirm the location</span><br><span class="line">  - Press CTRL-C to abort the installation</span><br><span class="line">  - Or specify a different location below</span><br><span class="line"></span><br><span class="line">[<span class="regexp">/home/</span>cqc<span class="regexp">/anaconda3] &gt;&gt;&gt; /</span>usr<span class="regexp">/local/</span>anaconda3</span><br><span class="line">PREFIX=<span class="regexp">/usr/</span>local/anaconda3</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我指定了将其安装到 /usr/local/anaconda3 目录下，全局安装，所有用户共享，当然如果只想本用户使用的话使用默认配置即可。 安装完成之后添加 python3 和 pip3 的软链接：</p>
                  <figure class="highlight dts">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo ln -s <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/anaconda3/</span>bin/python3 <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/sbin/</span>python3</span><br><span class="line">sudo ln -s <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/anaconda3/</span>bin/pip <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/sbin/</span>pip3</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里是将软连接其添加到 /usr/local/sbin 目录下了，它默认会存在于环境变量中，因此可以直接调用。 当然也可以选择把 /usr/local/anaconda3/bin 目录添加到环境变量中，可以修改 ~/.bashrc 文件，添加如下内容：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=/usr/local/anaconda3/bin$&#123;PATH:+:<span class="variable">$&#123;PATH&#125;</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后执行：</p>
                  <figure class="highlight bash">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>即可生效，下次登录时也会默认执行 ~/.bashrc 文件，也会生效。 接下来我们验证下 python3、pip3 命令是否都来自 Anaconda，命令如下：</p>
                  <figure class="highlight crystal">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 -V</span><br><span class="line">pip <span class="number">9.0</span>.<span class="number">1</span> from /usr/local/anaconda3/<span class="class"><span class="keyword">lib</span>/<span class="title">python3</span>.6/<span class="title">site</span>-<span class="title">packages</span> (<span class="title">python</span> 3.6)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">which python3</span><br><span class="line">/usr/local/anaconda3/bin/python3</span><br><span class="line">python3</span><br><span class="line">Python 3.6.4 |Anaconda, Inc.| (default, Jan 16 2018, 18:10:19) </span><br><span class="line">[GCC 7.2.0] on linux</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果输入 pip3 和 python3 命令能出现如上类似结果，路径都在 /usr/local/anaconda3，就证明 Python 3 安装成功了。</p>
                  <h2 id="安装驱动"><a href="#安装驱动" class="headerlink" title="安装驱动"></a>安装驱动</h2>
                  <p>首先查看一下自己的电脑需要怎样的驱动，我们可以先到 <a href="http://www.nvidia.com/Download/index.aspx" target="_blank" rel="noopener">http://www.nvidia.com/Download/index.aspx</a> 查询下我们需要的是怎样的驱动，这里我的显卡是 GTX 1080，所以以此为例说明，勾选好对应的配置： <img src="https://germey.gitbooks.io/ai/content/assets/2018-03-11-18-46-41.jpg" alt=""> 点击 Search，可以看到查询结果如下所示：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Version:</span>    <span class="number">390.25</span></span><br><span class="line"><span class="attr">Release Date:</span>    <span class="number">2018.1</span><span class="number">.29</span></span><br><span class="line"><span class="attr">Operating System:</span>    <span class="string">Linux</span> <span class="number">64</span><span class="string">-bit</span></span><br><span class="line"><span class="attr">Language:</span>    <span class="string">English</span> <span class="string">(US)</span></span><br><span class="line"><span class="attr">File Size:</span>    <span class="number">77.48</span> <span class="string">MB</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里说明我们需要的版本是 390.25。 接下来如果我们之前安装了驱动的话，可以重新安装一下，如果当前已经安装好了就不必了。 如果要重装，需要首先卸载掉之前的显卡驱动：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo apt-<span class="builtin-name">get</span> <span class="builtin-name">remove</span> –purge nvidia*</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行之后 NVIDIA 的一些驱动就被卸载了。 这时候 nvidia-smi 等命令已经不能用了，这就证明显卡驱动已经被卸载了。 然后接下来添加一个 PPA 源，命令如下：</p>
                  <figure class="highlight smali">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:graphics-drivers/ppa</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后更新一下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo apt-<span class="keyword">get</span> <span class="keyword">update</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>随后重新安装显卡驱动：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo apt-<span class="builtin-name">get</span> install nvidia-390</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>注意这里的 390 就是刚才我们查询出来的版本，以实际查询出来的版本为准。</p>
                  <h2 id="CUDA-9-0"><a href="#CUDA-9-0" class="headerlink" title="CUDA 9.0"></a>CUDA 9.0</h2>
                  <p>如果存在之前的旧版本，可以选择先卸载，以免和新的 CUDA 版本产生冲突，在 /usr/local/cuda/bin 目录下有一个 uninstallcuda*.pl 文件，可以直接运行卸载，命令如下：</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo <span class="string">./uninstall_cuda_</span>*<span class="string">.pl</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样即可将 CUDA 全部卸载。 接下来我们再下载 CUDA 9.0，注意 TensorFlow 1.5 和 1.6 版本依然只是兼容 CUDA 9.0，没有兼容 CUDA 9.1，所以不要下载 9.1，CUDA 9.0 的下载地址是：<a href="https://developer.nvidia.com/cuda-90-download-archive" target="_blank" rel="noopener">https://developer.nvidia.com/cuda-90-download-archive</a>，然后依次勾选好系统的版本，如图所示： <img src="https://germey.gitbooks.io/ai/content/assets/2018-03-11-23-37-55.jpg" alt=""> 这里我们选择 Linux-x86_64-Ubuntu-16.04-runfile 的配置，然后点击 Base Installer 部分的 Download 按钮，下载 CUDA 9.0 安装包。 对应的下载命令是：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">wget https:<span class="regexp">//</span>developer.nvidia.com<span class="regexp">/compute/</span>cuda<span class="regexp">/9.0/</span>Prod<span class="regexp">/local_installers/</span>cuda_9.<span class="number">0.176</span>_384.<span class="number">81</span>_linux-run</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行此命令，等待下载完成即可。 接下来执行安装，运行如下命令：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo bash cuda_9<span class="number">.0</span><span class="number">.176</span>_384<span class="number">.81</span>_linux-run</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装过程需要输入一些确认选项，过程如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Description</span><br><span class="line"></span><br><span class="line">The NVIDIA CUDA Toolkit provides command-line <span class="keyword">and</span> graphical</span><br><span class="line">tools <span class="keyword">for</span> building, debugging <span class="keyword">and</span> optimizing the performance</span><br><span class="line"><span class="keyword">Do</span> you accept the previously read EULA?</span><br><span class="line">accept/decline/quit: accept</span><br><span class="line"></span><br><span class="line">Install NVIDIA Accelerated Graphics Driver <span class="keyword">for</span> Linux-x86_64 384.81?</span><br><span class="line">(y)es/(n)o/(q)uit: n</span><br><span class="line"></span><br><span class="line">Install the CUDA 9.0 Toolkit?</span><br><span class="line">(y)es/(n)o/(q)uit: y</span><br><span class="line"></span><br><span class="line">Enter Toolkit Location</span><br><span class="line"> [<span class="built_in"> default </span>is /usr/local/cuda-9.0 ]: </span><br><span class="line"></span><br><span class="line"><span class="keyword">Do</span> you want <span class="keyword">to</span> install a symbolic link at /usr/local/cuda?</span><br><span class="line">(y)es/(n)o/(q)uit: y</span><br><span class="line"></span><br><span class="line">Install the CUDA 9.0 Samples?</span><br><span class="line">(y)es/(n)o/(q)uit: y</span><br><span class="line"></span><br><span class="line">Enter CUDA Samples Location</span><br><span class="line"> [<span class="built_in"> default </span>is /home/cqc ]: </span><br><span class="line"></span><br><span class="line">Installing the CUDA Toolkit <span class="keyword">in</span> /usr/local/cuda-9.0 <span class="built_in">..</span>.</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后如果出现这样的提示，就证明 CUDA 安装好了：</p>
                  <figure class="highlight">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">Driver</span>:   Not Selected</span><br><span class="line"><span class="attribute">Toolkit</span>:  Installed in /usr/local/cuda-9.0</span><br><span class="line"><span class="attribute">Samples</span>:  Installed in /home/cqc, but missing recommended libraries</span><br><span class="line"></span><br><span class="line">Please make sure that</span><br><span class="line"> -   PATH includes /usr/local/cuda-9.0/bin</span><br><span class="line"> -   LD_LIBRARY_PATH includes /usr/local/cuda-9.0/lib64, or, add /usr/local/cuda-9.0/lib64 to /etc/ld.so.conf and run ldconfig as root</span><br><span class="line"></span><br><span class="line">To uninstall the CUDA Toolkit, run the uninstall script in /usr/local/cuda-9.0/bin</span><br><span class="line"></span><br><span class="line">Please see CUDA_Installation_Guide_Linux.pdf in /usr/local/cuda-9.0/doc/pdf for detailed information on setting up CUDA.</span><br><span class="line"></span><br><span class="line">***WARNING: Incomplete installation! This installation did not install the CUDA Driver. A driver of version at least 384.00 is required for CUDA 9.0 functionality to work.</span><br><span class="line">To install the driver using this installer, run the following command, replacing &lt;CudaInstaller&gt; with the name of this run file:</span><br><span class="line">    sudo &lt;CudaInstaller&gt;.run -silent -driver</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后我们需要配置一下环境变量，更改 ~/.bashrc 文件，添加如下几行：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=/usr/local/cuda/bin$&#123;PATH:+:<span class="variable">$&#123;PATH&#125;</span>&#125;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">LD_LIBRARY_PATH</span>=/usr/local/cuda/lib64$&#123;LD_LIBRARY_PATH:+:<span class="variable">$&#123;LD_LIBRARY_PATH&#125;</span>&#125;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">CUDA_HOME</span>=/usr/local/cuda</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>修改完毕之后执行一下使其生效：</p>
                  <figure class="highlight bash">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时我们输出 CUDA_HOME、LD_LIBRARY_PATH 就可以看到对应的输出了：</p>
                  <figure class="highlight bash">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">echo</span> <span class="variable">$CUDA_HOME</span></span><br><span class="line">/usr/<span class="built_in">local</span>/cuda</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">/usr/<span class="built_in">local</span>/cuda/lib64</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就代表环境变量生效了，CUDA 安装完成。</p>
                  <h2 id="cuDNN-7-1"><a href="#cuDNN-7-1" class="headerlink" title="cuDNN 7.1"></a>cuDNN 7.1</h2>
                  <p>cuDNN 的全称是 The NVIDIA CUDA® Deep Neural Network library，是专门用来对深度学习加速的库，它支持 Caffe2, MATLAB, Microsoft Cognitive Toolkit, TensorFlow, Theano 及 PyTorch 等深度学习的加速优化，目前最新版本是 cuDNN 7.1，接下来我们来看下它的安装方式。 下载链接：<a href="https://developer.nvidia.com/rdp/cudnn-download" target="_blank" rel="noopener">https://developer.nvidia.com/rdp/cudnn-download</a>，需要注册之后才能打开，这里我们选择 cuDNN v7.1.1 (Feb 28, 2018), for CUDA 9.0，然后选择 cuDNN v7.1.1 Library for Linux，如图所示： <img src="https://germey.gitbooks.io/ai/content/assets/2018-03-11-23-49-17.jpg" alt=""> 下载下来之后解压安装即可：</p>
                  <figure class="highlight dts">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">tar -zxvf cudnn<span class="number">-9.0</span>-linux-x64-v7<span class="number">.1</span>.tgz</span><br><span class="line">sudo cp cuda<span class="meta-keyword">/include/</span>cudnn.h <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/cuda/</span>include/</span><br><span class="line">sudo cp cuda<span class="meta-keyword">/lib64/</span>libcudnn* <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/cuda/</span>lib64/ -d</span><br><span class="line">sudo chmod a+r <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/cuda/</span>include/cudnn.h</span><br><span class="line">sudo chmod a+r <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/cuda/</span>lib64/libcudnn*</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行完如上命令之后，cuDNN 就安装好了，这时我们可以发现在 /usr/local/cuda/include 目录下就多了 cudnn.h 头文件。</p>
                  <h2 id="TensorFlow-1-6"><a href="#TensorFlow-1-6" class="headerlink" title="TensorFlow 1.6"></a>TensorFlow 1.6</h2>
                  <p>到现在为止 Python 3.6、CUDA 9.0 和 cuDNN 7.1 就已经安装好了，而且环境变量也配置好了，接下来我们直接安装 TensorFlow 1.6 即可，TensorFlow 1.6 版本针对 CUDA 9 和 cuDNN 7 做了优化，可以预构建二进制文件。 这里需要安装的是 TensorFlow 的 GPU 版本，命令如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 install tensorflow-gpu==<span class="number">1.6</span><span class="number">.0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装完成之后验证一下：</p>
                  <figure class="highlight elm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> tensorflow</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果没有报错，那就证明全部环境配置都成功了。 以上便是 Ubuntu 16.04 + Nvidia GTX 1080 + Python 3.6 + CUDA 9.0 + cuDNN 7.1 + TensorFlow 1.6 完整环境配置过程。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-12 15:45:41" itemprop="dateCreated datePublished" datetime="2018-03-12T15:45:41+08:00">2018-03-12</time>
                </span>
                <span id="/5822.html" class="post-meta-item leancloud_visitors" data-flag-title="深度学习 GPU环境 Ubuntu 16.04 + Nvidia GTX 1080 + Python 3.6 + CUDA 9.0 + cuDNN 7.1 + TensorFlow 1.6 环境配置" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5806.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Linux <i class="label-arrow"></i>
                  </a>
                  <a href="/5806.html" class="post-title-link" itemprop="url">Linux常用命令总结</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h2>
                  <p>查看系统版本：</p>
                  <figure class="highlight stata">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">cat</span> /proc/<span class="keyword">version</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>实例结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Linux version <span class="number">4.4</span><span class="number">.0</span><span class="number">-112</span>-generic (<span class="symbol">buildd@</span>lgw01-amd64<span class="number">-010</span>) (gcc version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6</span>ubuntu1~<span class="number">16.04</span><span class="number">.5</span>) ) #<span class="number">135</span>-Ubuntu SMP Fri Jan <span class="number">19</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">36</span> UTC <span class="number">2018</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2>
                  <p>查看CPU信息：</p>
                  <figure class="highlight armasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">cat</span> /<span class="meta">proc</span>/cpuinfo</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">processor       :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">vendor_id       :</span> <span class="string">GenuineIntel</span></span><br><span class="line"><span class="attr">cpu family      :</span> <span class="number">6</span></span><br><span class="line"><span class="attr">model           :</span> <span class="number">63</span></span><br><span class="line"><span class="attr">model name      :</span> <span class="string">Intel(R)</span> <span class="string">Xeon(R)</span> <span class="string">CPU</span> <span class="string">E5-2673</span> <span class="string">v3</span> <span class="string">@</span> <span class="number">2.</span><span class="string">40GHz</span></span><br><span class="line"><span class="attr">stepping        :</span> <span class="number">2</span></span><br><span class="line"><span class="attr">microcode       :</span> <span class="number">0x3a</span></span><br><span class="line"><span class="attr">cpu MHz         :</span> <span class="number">1200.000</span></span><br><span class="line"><span class="attr">cache size      :</span> <span class="number">30720</span> <span class="string">KB</span></span><br><span class="line"><span class="attr">physical id     :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">siblings        :</span> <span class="number">24</span></span><br><span class="line"><span class="attr">core id         :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">cpu cores       :</span> <span class="number">12</span></span><br><span class="line"><span class="attr">apicid          :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">initial apicid  :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">fpu             :</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">fpu_exception   :</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">cpuid level     :</span> <span class="number">15</span></span><br><span class="line"><span class="attr">wp              :</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">flags           :</span> <span class="string">fpu</span> <span class="string">vme</span> <span class="string">de</span> <span class="string">pse</span> <span class="string">tsc</span> <span class="string">msr</span> <span class="string">pae</span> <span class="string">mce</span> <span class="string">cx8</span> <span class="string">apic</span> <span class="string">sep</span> <span class="string">mtrr</span> <span class="string">pge</span> <span class="string">mca</span> <span class="string">cmov</span> <span class="string">pat</span> <span class="string">pse36</span> <span class="string">clflush</span> <span class="string">dts</span> <span class="string">acpi</span> <span class="string">mmx</span> <span class="string">fxsr</span> <span class="string">sse</span> <span class="string">sse2</span> <span class="string">ss</span> <span class="string">ht</span> <span class="string">tm</span> <span class="string">pbe</span> <span class="string">syscall</span> <span class="string">nx</span> <span class="string">pdpe1gb</span> <span class="string">rdtscp</span> <span class="string">lm</span> <span class="string">constant_tsc</span> <span class="string">arch_perfmon</span> <span class="string">pebs</span> <span class="string">bts</span> <span class="string">rep_good</span> <span class="string">nopl</span> <span class="string">xtopology</span> <span class="string">nonstop_tsc</span> <span class="string">aperfmperf</span> <span class="string">eagerfpu</span> <span class="string">pni</span> <span class="string">pclmulqdq</span> <span class="string">dtes64</span> <span class="string">monitor</span> <span class="string">ds_cpl</span> <span class="string">vmx</span> <span class="string">smx</span> <span class="string">est</span> <span class="string">tm2</span> <span class="string">ssse3</span> <span class="string">sdbg</span> <span class="string">fma</span> <span class="string">cx16</span> <span class="string">xtpr</span> <span class="string">pdcm</span> <span class="string">pcid</span> <span class="string">dca</span> <span class="string">sse4_1</span> <span class="string">sse4_2</span> <span class="string">x2apic</span> <span class="string">movbe</span> <span class="string">popcnt</span> <span class="string">tsc_deadline_timer</span> <span class="string">aes</span> <span class="string">xsave</span> <span class="string">avx</span> <span class="string">f16c</span> <span class="string">rdrand</span> <span class="string">lahf_lm</span> <span class="string">abm</span> <span class="string">epb</span> <span class="string">invpcid_single</span> <span class="string">kaiser</span> <span class="string">tpr_shadow</span> <span class="string">vnmi</span> <span class="string">flexpriority</span> <span class="string">ept</span> <span class="string">vpid</span> <span class="string">fsgsbase</span> <span class="string">tsc_adjust</span> <span class="string">bmi1</span> <span class="string">avx2</span> <span class="string">smep</span> <span class="string">bmi2</span> <span class="string">erms</span> <span class="string">invpcid</span> <span class="string">cqm</span> <span class="string">xsaveopt</span> <span class="string">cqm_llc</span> <span class="string">cqm_occup_llc</span> <span class="string">dtherm</span> <span class="string">ida</span> <span class="string">arat</span> <span class="string">pln</span> <span class="string">pts</span></span><br><span class="line"><span class="attr">bugs            :</span></span><br><span class="line"><span class="attr">bogomips        :</span> <span class="number">4800.24</span></span><br><span class="line"><span class="attr">clflush size    :</span> <span class="number">64</span></span><br><span class="line"><span class="attr">cache_alignment :</span> <span class="number">64</span></span><br><span class="line"><span class="attr">address sizes   :</span> <span class="number">46</span> <span class="string">bits</span> <span class="string">physical,</span> <span class="number">48</span> <span class="string">bits</span> <span class="string">virtual</span></span><br><span class="line"><span class="attr">power management:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processor       :</span> <span class="number">1</span></span><br><span class="line"><span class="attr">vendor_id       :</span> <span class="string">GenuineIntel</span></span><br><span class="line"><span class="attr">cpu family      :</span> <span class="number">6</span></span><br><span class="line"><span class="attr">model           :</span> <span class="number">63</span></span><br><span class="line"><span class="attr">model name      :</span> <span class="string">Intel(R)</span> <span class="string">Xeon(R)</span> <span class="string">CPU</span> <span class="string">E5-2673</span> <span class="string">v3</span> <span class="string">@</span> <span class="number">2.</span><span class="string">40GHz</span></span><br><span class="line"><span class="attr">stepping        :</span> <span class="number">2</span></span><br><span class="line"><span class="attr">microcode       :</span> <span class="number">0x3a</span></span><br><span class="line"><span class="attr">cpu MHz         :</span> <span class="number">1207.687</span></span><br><span class="line"><span class="attr">cache size      :</span> <span class="number">30720</span> <span class="string">KB</span></span><br><span class="line"><span class="attr">physical id     :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">siblings        :</span> <span class="number">24</span></span><br><span class="line"><span class="attr">core id         :</span> <span class="number">1</span></span><br><span class="line"><span class="attr">cpu cores       :</span> <span class="number">12</span></span><br><span class="line"><span class="attr">apicid          :</span> <span class="number">2</span></span><br><span class="line"><span class="attr">initial apicid  :</span> <span class="number">2</span></span><br><span class="line"><span class="attr">fpu             :</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">fpu_exception   :</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">cpuid level     :</span> <span class="number">15</span></span><br><span class="line"><span class="attr">wp              :</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">flags           :</span> <span class="string">fpu</span> <span class="string">vme</span> <span class="string">de</span> <span class="string">pse</span> <span class="string">tsc</span> <span class="string">msr</span> <span class="string">pae</span> <span class="string">mce</span> <span class="string">cx8</span> <span class="string">apic</span> <span class="string">sep</span> <span class="string">mtrr</span> <span class="string">pge</span> <span class="string">mca</span> <span class="string">cmov</span> <span class="string">pat</span> <span class="string">pse36</span> <span class="string">clflush</span> <span class="string">dts</span> <span class="string">acpi</span> <span class="string">mmx</span> <span class="string">fxsr</span> <span class="string">sse</span> <span class="string">sse2</span> <span class="string">ss</span> <span class="string">ht</span> <span class="string">tm</span> <span class="string">pbe</span> <span class="string">syscall</span> <span class="string">nx</span> <span class="string">pdpe1gb</span> <span class="string">rdtscp</span> <span class="string">lm</span> <span class="string">constant_tsc</span> <span class="string">arch_perfmon</span> <span class="string">pebs</span> <span class="string">bts</span> <span class="string">rep_good</span> <span class="string">nopl</span> <span class="string">xtopology</span> <span class="string">nonstop_tsc</span> <span class="string">aperfmperf</span> <span class="string">eagerfpu</span> <span class="string">pni</span> <span class="string">pclmulqdq</span> <span class="string">dtes64</span> <span class="string">monitor</span> <span class="string">ds_cpl</span> <span class="string">vmx</span> <span class="string">smx</span> <span class="string">est</span> <span class="string">tm2</span> <span class="string">ssse3</span> <span class="string">sdbg</span> <span class="string">fma</span> <span class="string">cx16</span> <span class="string">xtpr</span> <span class="string">pdcm</span> <span class="string">pcid</span> <span class="string">dca</span> <span class="string">sse4_1</span> <span class="string">sse4_2</span> <span class="string">x2apic</span> <span class="string">movbe</span> <span class="string">popcnt</span> <span class="string">tsc_deadline_timer</span> <span class="string">aes</span> <span class="string">xsave</span> <span class="string">avx</span> <span class="string">f16c</span> <span class="string">rdrand</span> <span class="string">lahf_lm</span> <span class="string">abm</span> <span class="string">epb</span> <span class="string">invpcid_single</span> <span class="string">kaiser</span> <span class="string">tpr_shadow</span> <span class="string">vnmi</span> <span class="string">flexpriority</span> <span class="string">ept</span> <span class="string">vpid</span> <span class="string">fsgsbase</span> <span class="string">tsc_adjust</span> <span class="string">bmi1</span> <span class="string">avx2</span> <span class="string">smep</span> <span class="string">bmi2</span> <span class="string">erms</span> <span class="string">invpcid</span> <span class="string">cqm</span> <span class="string">xsaveopt</span> <span class="string">cqm_llc</span> <span class="string">cqm_occup_llc</span> <span class="string">dtherm</span> <span class="string">ida</span> <span class="string">arat</span> <span class="string">pln</span> <span class="string">pts</span></span><br><span class="line"><span class="attr">bugs            :</span></span><br><span class="line"><span class="attr">bogomips        :</span> <span class="number">4800.24</span></span><br><span class="line"><span class="attr">clflush size    :</span> <span class="number">64</span></span><br><span class="line"><span class="attr">cache_alignment :</span> <span class="number">64</span></span><br><span class="line"><span class="attr">address sizes   :</span> <span class="number">46</span> <span class="string">bits</span> <span class="string">physical,</span> <span class="number">48</span> <span class="string">bits</span> <span class="string">virtual</span></span><br><span class="line"><span class="attr">power management:</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2>
                  <p>查看内存及用量（M为单位）：</p>
                  <figure class="highlight cpp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">free</span> -m</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">              <span class="string">total</span>        <span class="string">used</span>        <span class="string">free</span>      <span class="string">shared</span>  <span class="string">buff/cache</span>   <span class="string">available</span></span><br><span class="line"><span class="attr">Mem:</span>         <span class="number">128806</span>        <span class="number">7115</span>      <span class="number">115910</span>          <span class="number">77</span>        <span class="number">5780</span>      <span class="number">120877</span></span><br><span class="line"><span class="attr">Swap:</span>             <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>查看内存及用量（G为单位）：</p>
                  <figure class="highlight cpp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">free</span> -g</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">              <span class="string">total</span>        <span class="string">used</span>        <span class="string">free</span>      <span class="string">shared</span>  <span class="string">buff/cache</span>   <span class="string">available</span></span><br><span class="line"><span class="attr">Mem:</span>            <span class="number">125</span>           <span class="number">6</span>         <span class="number">113</span>           <span class="number">0</span>           <span class="number">5</span>         <span class="number">118</span></span><br><span class="line"><span class="attr">Swap:</span>             <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="硬盘用量"><a href="#硬盘用量" class="headerlink" title="硬盘用量"></a>硬盘用量</h2>
                  <p>查看各分区使用情况：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">df -h</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev             <span class="number">63</span>G     <span class="number">0</span>   <span class="number">63</span>G   <span class="number">0</span>% /dev</span><br><span class="line">tmpfs            <span class="number">13</span>G   <span class="number">66</span>M   <span class="number">13</span>G   <span class="number">1</span>% /run</span><br><span class="line">/dev/sda1       <span class="number">224</span>G  <span class="number">101</span>G  <span class="number">113</span>G  <span class="number">48</span>% /</span><br><span class="line">tmpfs            <span class="number">63</span>G  <span class="number">352</span>K   <span class="number">63</span>G   <span class="number">1</span>% /dev/shm</span><br><span class="line">tmpfs           <span class="number">5.0</span>M  <span class="number">4.0</span>K  <span class="number">5.0</span>M   <span class="number">1</span>% /run/lock</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>查看当前目录文件及文件夹大小：</p>
                  <figure class="highlight mipsasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">du -<span class="keyword">sh </span>*</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">6.9</span>G    anaconda3</span><br><span class="line"><span class="number">213</span>M    cuda_samples</span><br><span class="line"><span class="number">7.9</span>M    Desktop</span><br><span class="line"><span class="number">8.0</span>K    Documents</span><br><span class="line"><span class="number">7.1</span>G    Downloads</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h2>
                  <p>查看 GPU 使用情况：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">nvidia-smi</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Sun Mar 11 15:34:14 2018       </span><br><span class="line"><span class="code">+-----------------------------------------------------------------------------+</span></span><br><span class="line">| NVIDIA-SMI 384.111                Driver Version: 384.111                   |</span><br><span class="line">|-------------------------------<span class="code">+----------------------+</span>----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================<span class="code">+======================+</span>======================|</span><br><span class="line">|   0  GeForce GTX 1080    Off  | 00000000:02:00.0  On |                  N/A |</span><br><span class="line">|  0%   36C    P8    15W / 320W |    224MiB /  8105MiB |      0%      Default |</span><br><span class="line"><span class="code">+-------------------------------+</span>----------------------<span class="code">+----------------------+</span></span><br><span class="line"><span class="code">                                                                               </span></span><br><span class="line"><span class="code">+-----------------------------------------------------------------------------+</span></span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0      1322      G   /usr/lib/xorg/Xorg                           178MiB |</span><br><span class="line">|    0      1880      G   compiz                                        43MiB |</span><br><span class="line"><span class="code">+-----------------------------------------------------------------------------+</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2>
                  <p>查看所有进程：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">ps -ef</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">root         <span class="number">1</span>     <span class="number">0</span>  <span class="number">0</span> Feb09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">15</span> /sbin/init splash</span><br><span class="line">root         <span class="number">2</span>     <span class="number">0</span>  <span class="number">0</span> Feb09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> [kthreadd]</span><br><span class="line">root         <span class="number">3</span>     <span class="number">2</span>  <span class="number">0</span> Feb09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">05</span> [ksoftirqd/<span class="number">0</span>]</span><br><span class="line">root         <span class="number">5</span>     <span class="number">2</span>  <span class="number">0</span> Feb09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> [kworker/<span class="number">0</span>:<span class="number">0</span>H]</span><br><span class="line">root         <span class="number">6</span>     <span class="number">2</span>  <span class="number">0</span> Feb09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> [kworker/u96:<span class="number">0</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>筛选进程：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> <span class="keyword">python</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>示例结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">chen      <span class="number">6466</span> <span class="number">44495</span>  <span class="number">0</span> Mar09 ?        <span class="number">00</span>:<span class="number">01</span>:<span class="number">56</span> /usr/bin/python2 -m ipykernel_launcher -f /run/user/<span class="number">1000</span>/jupyter/kernel<span class="number">-218926</span>a1-f3b9<span class="number">-4410</span>-bffb<span class="number">-1</span>de1341732be.json</span><br><span class="line">chen     <span class="number">11630</span> <span class="number">44495</span>  <span class="number">0</span> Mar09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">13</span> /home/chen/anaconda3/bin/python -m ipykernel_launcher -f /run/user/<span class="number">1000</span>/jupyter/kernel-c2942b7d-d73c<span class="number">-420</span>a-b6be<span class="number">-78f</span>0169e68c9.json</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>根据名称强制杀死进程：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">ps -ef | grep python | cut -c <span class="number">9</span><span class="number">-15</span> | xargs kill <span class="number">-9</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2>
                  <p>添加用户：</p>
                  <figure class="highlight armasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">sudo</span> <span class="keyword">adduser </span>username</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>添加用户并设置目录：</p>
                  <figure class="highlight arduino">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo adduser username --<span class="built_in">home</span> /<span class="built_in">home</span>/username</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>将用户设置超级用户组（如添加到 sudo 用户组）：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">sudo usermod -aG sudo username</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>查看所有用户组：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">groups</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>查看某个用户组下所有用户：</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">sudo</span> <span class="string">apt-get install members</span></span><br><span class="line"><span class="attr">members</span> <span class="string">sudo</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-11 15:35:40" itemprop="dateCreated datePublished" datetime="2018-03-11T15:35:40+08:00">2018-03-11</time>
                </span>
                <span id="/5806.html" class="post-meta-item leancloud_visitors" data-flag-title="Linux常用命令总结" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5788.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5788.html" class="post-title-link" itemprop="url">正则表达式中零宽断言的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>了解了正则表达式，想必一般情况下的匹配都不会出现什么问题，但是如果一些特殊情况，可能需要用到一些更高级的正则表达式匹配操作，本节我们来说明一下正则表达式的一个较常用又比较重要的知识点——零宽断言。</p>
                  <h2 id="实例引入"><a href="#实例引入" class="headerlink" title="实例引入"></a>实例引入</h2>
                  <p>首先我们来看一个例子，这里有一段问答对话：</p>
                  <blockquote>
                    <p>问：我用的是Windows XP+Service Pack 2，为什么无法安装输入卡号和密码的控件？ 答：在Windows XP+Service Pack 2、Windows 2003等操作系统中，用户可以自己选择是否安装控件。 问：为什么我看到的卡号输入框显示为*符号？ 答：您的浏览器禁止下载执行ActiveX控件 , 对于这种情况 , 您必须打开浏览器的ActiveX的相关权限。 操作方法：在浏览器菜单中选择“工具”|“Internet选项”，在弹出的对话框中选择”安全” |”Internet”|”自定义级别”，在弹出的对话框中选择”重置为 安全级-中” , 点”重置”按钮，确定。 问：看了以上几个问题，还是不能登录，怎么办？ 答：您的浏览器由于其他原因不能安装招商银行登录控件， 请下载并安装招商银行登录控件下载版。 问：无法出现个人网上银行大众版登录界面。 答：这种情况是由于您的机器无法和我行服务器建立安全连接，通常是因为代理服务器设置错误引起。如果您是拨号上网，请不要使用代理服务器；如果您过去安装过我行SSL安全代理，请调用“添加-删除程序”删除SSL安全代理；如果您是经过代理访问Internet，请联系您所在网的网络管理员设置代理服务器。IE5.0浏览器设置代理服务器的步骤： Internet选项—&gt;连接—&gt;局域网设置—&gt;使用代理服务器—&gt;高级。 问：我在输入账号和卡号时，总出错，该怎样输？ 答：存折账号为10位，按存折本上的账号输入， 密码为6位。如果一卡通是12位卡号的，只需输入地区码后面的8位卡号，不需要输入前面4位的地区码，密码为6位。如果一卡通是16位卡号的，请将16位卡号全部输入，密码为6位。 问：我的存折没有设密码，怎样在个人网上银行大众版中查询余额？ 答：存折必须设有密码方可在 个人网上银行大众版 中查询，因此请您到存折开户行给您的存折设置密码。 注：网上个人银行是招商银行为个人客户提供的网上银行。 本页面内容仅供参考，部分业务以当地网点的公告与具体规定为准。</p>
                  </blockquote>
                  <p>我们需要将这段对话中的问题和答案对提取出来，即提取出如下内容：</p>
                  <blockquote>
                    <p>Q：我用的是Windows XP+Service Pack 2，为什么无法安装输入卡号和密码的控件？ A：在Windows XP+Service Pack 2、Windows 2003等操作系统中，用户可以自己选择是否安装控件。 Q：为什么我看到的卡号输入框显示为*符号？ A：您的浏览器禁止下载执行ActiveX控件 , 对于这种情况 , 您必须打开浏览器的ActiveX的相关权限。 操作方法：在浏览器菜单中选择“工具”|“Internet选项”，在弹出的对话框中选择”安全” |”Internet”|”自定义级别”，在弹出的对话框中选择”重置为 安全级-中” , 点”重置”按钮，确定。 …</p>
                  </blockquote>
                  <p>如果要用 Python 实现的话，那么我们很可能自然而然想到 split() 或 findall() 方法，如果用 split() 方法，我们可能会这么写：</p>
                  <figure class="highlight perl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line">results = re.<span class="keyword">split</span>(<span class="string">'问：| 答：'</span>, text)</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">index</span>, result in enumerate(results[<span class="number">1</span>:]):</span><br><span class="line">    <span class="keyword">print</span>((<span class="string">'Q'</span> <span class="keyword">if</span> <span class="keyword">index</span>%2 == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'A'</span>) + <span class="string">': '</span> + result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 split() 方法的第一个参数传入了 <code>问：| 答：</code> 这个正则表达式，意思是将这段话用 <code>问：</code> 或者 <code>答：</code> 分开，这个功能是正则表达式对字符串进行分割的方法，相比直接字符串的 split() 方法功能更为强大。这里其实得到的结果是一个列表，长度是一个奇数，如果我们把 results 打印出来，结果是这样的：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">['', <span class="symbol">'我用的是Windows</span> XP+Service Pack <span class="number">2</span>，为什么无法安装输入卡号和密码的控件？', <span class="symbol">'在Windows</span> XP+Service Pack <span class="number">2</span>、Windows <span class="number">2003</span>等操作系统中，用户可以自己选择是否安装控件。 ', <span class="symbol">'为什么我看到的卡号输入框显示为*符号？</span>', <span class="symbol">'您的浏览器禁止下载执行ActiveX控件</span> , 对于这种情况 , 您必须打开浏览器的ActiveX的相关权限。 操作方法：在浏览器菜单中选择“工具”|“Internet选项”，在弹出的对话框中选择<span class="string">"安全"</span> |<span class="string">"Internet"</span>|<span class="string">"自定义级别"</span>，在弹出的对话框中选择<span class="string">"重置为 安全级-中"</span> , 点<span class="string">"重置"</span>按钮，确定。 ', <span class="symbol">'看了以上几个问题，还是不能登录，怎么办？</span>', <span class="symbol">'您的浏览器由于其他原因不能安装招商银行登录控件，</span> 请下载并安装招商银行登录控件下载版。 ', <span class="symbol">'无法出现个人网上银行大众版登录界面。</span>', <span class="symbol">'这种情况是由于您的机器无法和我行服务器建立安全连接，通常是因为代理服务器设置错误引起。如果您是拨号上网，请不要使用代理服务器；如果您过去安装过我行SSL安全代理，请调用“添加-删除程序”删除SSL安全代理；如果您是经过代理访问Internet，请联系您所在网的网络管理员设置代理服务器。IE5.0浏览器设置代理服务器的步骤：</span> Internet选项--&gt;连接--&gt;局域网设置--&gt;使用代理服务器--&gt;高级。 ', <span class="symbol">'我在输入账号和卡号时，总出错，该怎样输？</span>', <span class="symbol">'存折账号为10位，按存折本上的账号输入，</span> 密码为6位。如果一卡通是12位卡号的，只需输入地区码后面的8位卡号，不需要输入前面4位的地区码，密码为6位。如果一卡通是16位卡号的，请将16位卡号全部输入，密码为6位。 ', <span class="symbol">'我的存折没有设密码，怎样在个人网上银行大众版中查询余额？</span>', <span class="symbol">'存折必须设有密码方可在</span> 个人网上银行大众版 中查询，因此请您到存折开户行给您的存折设置密码。 注：网上个人银行是招商银行为个人客户提供的网上银行。 本页面内容仅供参考，部分业务以当地网点的公告与具体规定为准。 ']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这是因为我们分割使用的字符本身就处于整个文本的字符，所以一上来就找到了分割的标志 <code>问：</code>，所以它左侧的结果就是空字符串了，所以最终得到的结果第一个内容就是空字符串，后续的内容便是正常的一问一答的短句。所以这里我们还需要对结果进行切片操作，去除第一个元素，然后将其遍历打印输出，最终结果如下：</p>
                  <figure class="highlight avrasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">Q:</span> 我用的是Windows XP+Service Pack <span class="number">2</span>，为什么无法安装输入卡号和密码的控件？</span><br><span class="line"><span class="symbol">A:</span> 在Windows XP+Service Pack <span class="number">2</span>、Windows <span class="number">2003</span>等操作系统中，用户可以自己选择是否安装控件。 </span><br><span class="line"><span class="symbol">Q:</span> 为什么我看到的卡号输入框显示为*符号？</span><br><span class="line"><span class="symbol">A:</span> 您的浏览器禁止下载执行ActiveX控件 , 对于这种情况 , 您必须打开浏览器的ActiveX的相关权限。 操作方法：在浏览器菜单中选择“工具”|“Internet选项”，在弹出的对话框中选择<span class="string">"安全"</span> |<span class="string">"Internet"</span>|<span class="string">"自定义级别"</span>，在弹出的对话框中选择<span class="string">"重置为 安全级-中"</span> , 点<span class="string">"重置"</span>按钮，确定。 </span><br><span class="line"><span class="symbol">Q:</span> 看了以上几个问题，还是不能登录，怎么办？</span><br><span class="line"><span class="symbol">A:</span> 您的浏览器由于其他原因不能安装招商银行登录控件， 请下载并安装招商银行登录控件下载版。 </span><br><span class="line"><span class="symbol">Q:</span> 无法出现个人网上银行大众版登录界面。</span><br><span class="line"><span class="symbol">A:</span> 这种情况是由于您的机器无法和我行服务器建立安全连接，通常是因为代理服务器设置错误引起。如果您是拨号上网，请不要使用代理服务器；如果您过去安装过我行SSL安全代理，请调用“添加-删除程序”删除SSL安全代理；如果您是经过代理访问Internet，请联系您所在网的网络管理员设置代理服务器。IE5<span class="number">.0</span>浏览器设置代理服务器的步骤： Internet选项--&gt;连接--&gt;局域网设置--&gt;使用代理服务器--&gt;高级。 </span><br><span class="line"><span class="symbol">Q:</span> 我在输入账号和卡号时，总出错，该怎样输？</span><br><span class="line"><span class="symbol">A:</span> 存折账号为<span class="number">10</span>位，按存折本上的账号输入， 密码为<span class="number">6</span>位。如果一卡通是<span class="number">12</span>位卡号的，只需输入地区码后面的<span class="number">8</span>位卡号，不需要输入前面<span class="number">4</span>位的地区码，密码为<span class="number">6</span>位。如果一卡通是<span class="number">16</span>位卡号的，请将<span class="number">16</span>位卡号全部输入，密码为<span class="number">6</span>位。 </span><br><span class="line"><span class="symbol">Q:</span> 我的存折没有设密码，怎样在个人网上银行大众版中查询余额？</span><br><span class="line"><span class="symbol">A:</span> 存折必须设有密码方可在 个人网上银行大众版 中查询，因此请您到存折开户行给您的存折设置密码。 注：网上个人银行是招商银行为个人客户提供的网上银行。 本页面内容仅供参考，部分业务以当地网点的公告与具体规定为准。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样确实没问题，我们可以顺利地提取出来，但是总感觉这个解法并不那么优雅，因为我们这里是将问题和答案的内容都单独切出来了，并没有将问答对一块提取，而且 split() 方法返回的结果的第一个元素还不是我们想要的结果，所以还需要进行一些切片操作来去除，所以整个写法感觉实现起来并不完美。 所以我们又想到了 findall() 方法，这时我们会这么写：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line">results = re.findall(<span class="string">'问：(.*?) 答：(.*?)'</span>, <span class="keyword">text</span>, re.S)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">result</span> <span class="keyword">in</span> results:</span><br><span class="line">    print(<span class="string">'Q: '</span> + <span class="built_in">result</span>[<span class="number">0</span>], <span class="string">'A: '</span> + <span class="built_in">result</span>[<span class="number">1</span>], sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>表面上看似乎是把问题答案对用正则表示出来了，而且使用了非贪婪匹配，但是很明显，在末尾我们并没有指定匹配的终点，所以整个的结果就会导致回答是完全匹配不到的，运行结果如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Q:</span> <span class="string">我用的是Windows</span> <span class="string">XP+Service</span> <span class="string">Pack</span> <span class="number">2</span><span class="string">，为什么无法安装输入卡号和密码的控件？</span></span><br><span class="line"><span class="attr">A:</span> </span><br><span class="line"><span class="attr">Q:</span> <span class="string">为什么我看到的卡号输入框显示为*符号？</span></span><br><span class="line"><span class="attr">A:</span> </span><br><span class="line"><span class="attr">Q:</span> <span class="string">看了以上几个问题，还是不能登录，怎么办？</span></span><br><span class="line"><span class="attr">A:</span> </span><br><span class="line"><span class="attr">Q:</span> <span class="string">无法出现个人网上银行大众版登录界面。</span></span><br><span class="line"><span class="attr">A:</span> </span><br><span class="line"><span class="attr">Q:</span> <span class="string">我在输入账号和卡号时，总出错，该怎样输？</span></span><br><span class="line"><span class="attr">A:</span> </span><br><span class="line"><span class="attr">Q:</span> <span class="string">我的存折没有设密码，怎样在个人网上银行大众版中查询余额？</span></span><br><span class="line"><span class="attr">A:</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好，那么我们加上匹配的终点吧，以下一个的 <code>问：</code> 作为我们正则表达式匹配的终点总可以了吧？所以我们可能会改写成这样子：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line">results = re.findall(<span class="string">'问：(.*?) 答：(.*?)问：'</span>, <span class="keyword">text</span>, re.S)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">result</span> <span class="keyword">in</span> results:</span><br><span class="line">    print(<span class="string">'Q: '</span> + <span class="built_in">result</span>[<span class="number">0</span>], <span class="string">'A: '</span> + <span class="built_in">result</span>[<span class="number">1</span>], sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样写似乎看起来是可以了，但结果却是这样的：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Q: 我用的是Windows XP+Service Pack <span class="number">2</span>，为什么无法安装输入卡号和密码的控件？</span><br><span class="line">A: 在Windows XP+Service Pack <span class="number">2</span>、Windows <span class="number">2003</span>等操作系统中，用户可以自己选择是否安装控件。 </span><br><span class="line">Q: 看了以上几个问题，还是不能登录，怎么办？</span><br><span class="line">A: 您的浏览器由于其他原因不能安装招商银行登录控件， 请下载并安装招商银行登录控件下载版。 </span><br><span class="line">Q: 我在输入账号和卡号时，总出错，该怎样输？</span><br><span class="line">A: 存折账号为<span class="number">10</span>位，按存折本上的账号输入， 密码为<span class="number">6</span>位。如果一卡通是<span class="number">12</span>位卡号的，只需输入地区码后面的<span class="number">8</span>位卡号，不需要输入前面<span class="number">4</span>位的地区码，密码为<span class="number">6</span>位。如果一卡通是<span class="number">16</span>位卡号的，请将<span class="number">16</span>位卡号全部输入，密码为<span class="number">6</span>位。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果只剩三个问题答案对了，有三个问答对被“吃”掉了，其实这是因为我们的正则表达式最后加了 <code>问:</code>的缘故，findall() 方法它会查找所有符合正则表达式的结果，但其中匹配的时候它内部也是有一个查找索引在扫描的。在查找第一个符合要求的结果时，由于我们是根据正则表达式结尾的 <code>问：</code>来作为结束标志，所以在找到第一个符合要求的结果时，我们的查找索引就已经移动到了第二个问答对开头的 <code>问：</code> 上面，即查找索引就已经进入到了第二个问答对的位置了，而在下一次查找符合要求的结果时，索引会继续往后移动进行扫描，所以它是从第二个问答对的 <code>问：</code> 后面继续扫描的，所以对于第二个问答对，实际上已经被割裂了，所以它只能查找到第三个问答对的时候才可以发现符合正则表达式的内容。因此，我们可以观察到，返回的结果只是第一、三、五三个问答对。 所以，如果我们想要用该方法找到完整的留个问答对，就需要用到零宽断言了。 解法如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line">results = re.findall(<span class="string">'问：(.*?) 答：(.*?)(?=问：|\Z)'</span>, <span class="keyword">text</span>, re.S)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">result</span> <span class="keyword">in</span> results:</span><br><span class="line">    print(<span class="string">'Q: '</span> + <span class="built_in">result</span>[<span class="number">0</span>], <span class="string">'A: '</span> + <span class="built_in">result</span>[<span class="number">1</span>], sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight avrasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">Q:</span> 我用的是Windows XP+Service Pack <span class="number">2</span>，为什么无法安装输入卡号和密码的控件？</span><br><span class="line"><span class="symbol">A:</span> 在Windows XP+Service Pack <span class="number">2</span>、Windows <span class="number">2003</span>等操作系统中，用户可以自己选择是否安装控件。 </span><br><span class="line"><span class="symbol">Q:</span> 为什么我看到的卡号输入框显示为*符号？</span><br><span class="line"><span class="symbol">A:</span> 您的浏览器禁止下载执行ActiveX控件 , 对于这种情况 , 您必须打开浏览器的ActiveX的相关权限。 操作方法：在浏览器菜单中选择“工具”|“Internet选项”，在弹出的对话框中选择<span class="string">"安全"</span> |<span class="string">"Internet"</span>|<span class="string">"自定义级别"</span>，在弹出的对话框中选择<span class="string">"重置为 安全级-中"</span> , 点<span class="string">"重置"</span>按钮，确定。 </span><br><span class="line"><span class="symbol">Q:</span> 看了以上几个问题，还是不能登录，怎么办？</span><br><span class="line"><span class="symbol">A:</span> 您的浏览器由于其他原因不能安装招商银行登录控件， 请下载并安装招商银行登录控件下载版。 </span><br><span class="line"><span class="symbol">Q:</span> 无法出现个人网上银行大众版登录界面。</span><br><span class="line"><span class="symbol">A:</span> 这种情况是由于您的机器无法和我行服务器建立安全连接，通常是因为代理服务器设置错误引起。如果您是拨号上网，请不要使用代理服务器；如果您过去安装过我行SSL安全代理，请调用“添加-删除程序”删除SSL安全代理；如果您是经过代理访问Internet，请联系您所在网的网络管理员设置代理服务器。IE5<span class="number">.0</span>浏览器设置代理服务器的步骤： Internet选项--&gt;连接--&gt;局域网设置--&gt;使用代理服务器--&gt;高级。 </span><br><span class="line"><span class="symbol">Q:</span> 我在输入账号和卡号时，总出错，该怎样输？</span><br><span class="line"><span class="symbol">A:</span> 存折账号为<span class="number">10</span>位，按存折本上的账号输入， 密码为<span class="number">6</span>位。如果一卡通是<span class="number">12</span>位卡号的，只需输入地区码后面的<span class="number">8</span>位卡号，不需要输入前面<span class="number">4</span>位的地区码，密码为<span class="number">6</span>位。如果一卡通是<span class="number">16</span>位卡号的，请将<span class="number">16</span>位卡号全部输入，密码为<span class="number">6</span>位。 </span><br><span class="line"><span class="symbol">Q:</span> 我的存折没有设密码，怎样在个人网上银行大众版中查询余额？</span><br><span class="line"><span class="symbol">A:</span> 存折必须设有密码方可在 个人网上银行大众版 中查询，因此请您到存折开户行给您的存折设置密码。 注：网上个人银行是招商银行为个人客户提供的网上银行。 本页面内容仅供参考，部分业务以当地网点的公告与具体规定为准。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们实际上是使用了 <code>(?=)</code>这样的形式来构建了整个表达式，等号后面的内容是 <code>问：</code>或者结束符 <code>\\Z</code>，这样其实就保证了在匹配的时候，查找索引不会继续向后移，但这也同时标志了结束标志，因此它就可以查找到完整的内容了。</p>
                  <h2 id="零宽断言"><a href="#零宽断言" class="headerlink" title="零宽断言"></a>零宽断言</h2>
                  <p>零宽断言，顾名思义，是一种零宽度的匹配，它匹配的内容不会保存到匹配结果中，表达式的匹配内容只是代表了一个位置而已，如标明某个字符的右边界是怎样的构造。 在前面我们使用了 <code>?=</code>来进行了实例讲解，这是其中一个用法，另外还有 <code>?&lt;=</code>、<code>?!</code>、<code>?&lt;!</code>，下面我们来依次进行讲解说明。</p>
                  <ul>
                    <li><code>?=</code>代表零宽度正预测先行断言，它断言自身出现的位置的后面可以匹配后面跟的表达式。</li>
                    <li><code>?&lt;=</code>代表零宽度正回顾后发断言，它断言自身出现的位置的前面可以匹配后面跟的表达式。</li>
                    <li><code>?!</code>代表零宽度负预测先行断言，它断言自身出现的位置的后面不可以匹配后面跟的表达式。</li>
                    <li><code>?&lt;!</code>代表零宽度负回顾后发断言，它断言自身出现的位置的后面不可以匹配后面跟的表达式。</li>
                  </ul>
                  <h3 id=""><a href="#" class="headerlink" title="?="></a>?=</h3>
                  <p>首先我们来看下 <code>?=</code>的用法，它断言自身出现的位置的后面可以匹配后面跟的表达式。 比如我们这里有这样的一个字符串：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们想把我的个人邮箱这句话和个人邮箱单独摘出来，假如我们不使用零宽断言的话，我们需要给个人邮箱后面这一句加一个结束标识符或者单独匹配邮箱作为标识符，我们可能会这么写：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line"><span class="keyword">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br><span class="line">result = re.search(<span class="string">'我的个人邮箱是(.*?)，个人博客'</span>, <span class="keyword">str</span>)</span><br><span class="line">print(<span class="string">'整句结果：'</span> + result.<span class="keyword">group</span>(), <span class="string">'第一个匹配结果：'</span> + result.<span class="keyword">group</span>(<span class="number">1</span>), sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在正则表达式的最后我们加了<code>，个人博客</code>作为匹配的结束符，然后邮箱部分用非贪婪匹配的模式进行匹配，我们看下运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">整句结果：我的个人邮箱是<span class="symbol">cqc@</span>cuiqingcai.com，个人博客</span><br><span class="line">第一个匹配结果：<span class="symbol">cqc@</span>cuiqingcai.com</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们可以看到第一个匹配结果成功得到了邮箱信息，但是我们看整句结果缺并不理想，它多匹配了我们加入的结尾标识，并没有得到正常的一句话。 这时候如果我们改用 <code>?=</code>来匹配，结果就不会带有此标识符了，改写如下：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line"><span class="keyword">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br><span class="line">result = re.search(<span class="string">'我的个人邮箱是(.*?)(?=，个人博客)'</span>, <span class="keyword">str</span>)</span><br><span class="line">print(<span class="string">'整句结果：'</span> + result.<span class="keyword">group</span>(), <span class="string">'第一个匹配结果：'</span> + result.<span class="keyword">group</span>(<span class="number">1</span>), sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们将结尾标识符改成了 <code>(?=，个人博客)</code> ，这样就将此部分内容作为零宽度匹配，它代表后面需要跟 <code>，个人博客</code>，但是它不会出现在匹配结果中。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">整句结果：我的个人邮箱是<span class="symbol">cqc@</span>cuiqingcai.com</span><br><span class="line">第一个匹配结果：<span class="symbol">cqc@</span>cuiqingcai.com</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到整句结果中已经没有无用的后缀字符了。</p>
                  <h3 id="lt"><a href="#lt" class="headerlink" title="?&lt;="></a>?&lt;=</h3>
                  <p>接下来我们再看下 <code>?&lt;=</code>的用法，它代表零宽度正回顾后发断言，其实就是匹配前面的标识，比如这里我们还是以上面的例子为例，匹配出个人博客这句话，代码如下：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line"><span class="keyword">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br><span class="line">result = re.search(<span class="string">'(?&lt;=，)个人博客是(.*?)(?=，)'</span>, <span class="keyword">str</span>)</span><br><span class="line">print(<span class="string">'整句结果：'</span> + result.<span class="keyword">group</span>(), <span class="string">'第一个匹配结果：'</span> + result.<span class="keyword">group</span>(<span class="number">1</span>), sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们在<code>个人博客</code> 前面加了一个零宽断言的逗号符号作为开头，使用的就是 <code>?&lt;=</code>，句子结尾是用的 <code>?=</code>，这样前后的标识都不会匹配到了，运行结果如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">整句结果：个人博客是<span class="selector-tag">cuiqingcai</span><span class="selector-class">.com</span></span><br><span class="line">第一个匹配结果：<span class="selector-tag">cuiqingcai</span><span class="selector-class">.com</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到得到的整句结果也是完整的一句话。</p>
                  <h3 id="-1"><a href="#-1" class="headerlink" title="?!"></a>?!</h3>
                  <p><code>?!</code>代表代表零宽度负预测先行断言，它断言自身出现的位置的后面不可以匹配后面跟的表达式。也是用来匹配后面的文本，但这里是取反，它指定了后面出现的内容不匹配该标识，我们在前面的例子基础上修改如下：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line"><span class="keyword">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br><span class="line">result = re.search(<span class="string">'我的个人邮箱是(.*?)(?!，个人公众号)(?=，个人博客)'</span>, <span class="keyword">str</span>)</span><br><span class="line">print(<span class="string">'整句结果：'</span> + result.<span class="keyword">group</span>(), <span class="string">'第一个匹配结果：'</span> + result.<span class="keyword">group</span>(<span class="number">1</span>), sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>本来是 <code>(?=，个人博客)</code>的标识符，不过这里我们使用 <code>?!</code>来指定了另一个标识符<code>，个人公众号</code>，这就代表这句话后面跟的需要是<code>(?=，个人博客)</code>而不是<code>，个人公众号</code>，运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">整句结果：我的个人邮箱是<span class="symbol">cqc@</span>cuiqingcai.com</span><br><span class="line">第一个匹配结果：<span class="symbol">cqc@</span>cuiqingcai.com</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="lt-1"><a href="#lt-1" class="headerlink" title="?&lt;!"></a>?&lt;!</h3>
                  <p><code>?&lt;!</code>代表零宽度负回顾后发断言，它断言自身出现的位置的后面不可以匹配后面跟的表达式。我们在前面的例子基础上加以修改：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re</span><br><span class="line"><span class="keyword">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br><span class="line">result = re.search(<span class="string">'(?&lt;=，)(?&lt;!。)个人博客是(.*?)(?=，)'</span>, <span class="keyword">str</span>)</span><br><span class="line">print(<span class="string">'整句结果：'</span> + result.<span class="keyword">group</span>(), <span class="string">'第一个匹配结果：'</span> + result.<span class="keyword">group</span>(<span class="number">1</span>), sep=<span class="string">'\n'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们写了 <code>?&lt;!</code>标识符，后面跟了一个句号，这代表前面不应该出现句号。 运行结果如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">整句结果：个人博客是<span class="selector-tag">cuiqingcai</span><span class="selector-class">.com</span></span><br><span class="line">第一个匹配结果：<span class="selector-tag">cuiqingcai</span><span class="selector-class">.com</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="常用用法"><a href="#常用用法" class="headerlink" title="常用用法"></a>常用用法</h2>
                  <p>其实上面的示例中我们使用了 search() 方法进行了内容匹配，其实这并不常用，因为一般我们更关注的是匹配分组结果的内容，其实更多的用法是用在了 findall() 方法上，它用来匹配多个结果，也就类似于我们一开始的实例一样，这里我们还是以刚才的字符串为例，来输出一下个人邮箱、个人博客、个人公众号三个内容，代码如下：</p>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="built_in">str</span> = <span class="string">'我的个人邮箱是cqc@cuiqingcai.com，个人博客是cuiqingcai.com，个人公众号是进击的Coder'</span></span><br><span class="line">results = re.findall(<span class="string">'个人(.*?)是(.*?)(?=，|\Z)'</span>, <span class="built_in">str</span>)</span><br><span class="line"><span class="keyword">for</span> result in results:</span><br><span class="line">    <span class="built_in">print</span>(result[<span class="number">0</span>] + <span class="string">': '</span> + result[<span class="number">1</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们匹配了<code>个人</code>二字，然后后面跟了非贪婪匹配，然后加了一个<code>是</code>字，最关键的是结尾标识符，这里必须要使用零宽断言才可以匹配出三个结果，这里匹配的内容是 <code>，|\\Z</code>，意思是匹配逗号或结束符。 运行结果如下：</p>
                  <figure class="highlight makefile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="section">邮箱: cqc@cuiqingcai.com</span></span><br><span class="line"><span class="section">博客: cuiqingcai.com</span></span><br><span class="line"><span class="section">公众号: 进击的Coder</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就成功输出了邮箱、博客及公众号的内容了，匹配非常顺利方便。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>通过本节，我们应该大体可以了解了正则表达式中零宽断言的基本用法和适用场景，相信理解了零宽断言之后，我们再做正则匹配时会更加得心应手。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-03 05:42:18" itemprop="dateCreated datePublished" datetime="2018-03-03T05:42:18+08:00">2018-03-03</time>
                </span>
                <span id="/5788.html" class="post-meta-item leancloud_visitors" data-flag-title="正则表达式中零宽断言的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>9.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5771.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5771.html" class="post-title-link" itemprop="url">机器学习主要术语</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>什么是（监督式）机器学习？简单来说，它的定义如下：</p>
                  <ul>
                    <li>机器学习系统通过学习如何组合输入信息来对从未见过的数据做出有用的预测。</li>
                  </ul>
                  <p>下面我们来了解一下机器学习的基本术语。</p>
                  <h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2>
                  <p>在简单线性回归中，标签是我们要预测的事物，即 y 变量。标签可以是小麦未来的价格、图片中显示的动物品种、音频剪辑的含义或任何事物。</p>
                  <h2 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h2>
                  <p>在简单线性回归中，特征是输入变量，即 x 变量。简单的机器学习项目可能会使用单个特征，而比较复杂的机器学习项目可能会使用数百万个特征，按如下方式指定：</p>
                  <p>{x1,x2,…xN}</p>
                  <p>在垃圾邮件检测器示例中，特征可能包括：</p>
                  <ul>
                    <li>电子邮件文本中的字词</li>
                    <li>发件人的地址</li>
                    <li>发送电子邮件的时段</li>
                    <li>电子邮件中包含“一种奇怪的把戏”这样的短语。</li>
                  </ul>
                  <h2 id="样本"><a href="#样本" class="headerlink" title="样本"></a>样本</h2>
                  <p>样本是指数据的特定实例：x。（我们采用粗体 x 表示它是一个矢量。）我们将样本分为以下两类：</p>
                  <ul>
                    <li>有标签样本</li>
                    <li>无标签样本</li>
                  </ul>
                  <p>有标签样本同时包含特征和标签。即：</p>
                  <figure class="highlight dockerfile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">  labeled examples: &#123;features, <span class="keyword">label</span><span class="bash">&#125;: (x, y)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们使用有标签样本来训练模型。在我们的垃圾邮件检测器示例中，有标签样本是用户明确标记为“垃圾邮件”或“非垃圾邮件”的各个电子邮件。 例如，下表显示了从包含加利福尼亚州房价信息的<a href="https://developers.google.cn/machine-learning/crash-course/california-housing-data-description" target="_blank" rel="noopener">数据集</a>中抽取的 5 个有标签样本：</p>
                  <p>housingMedianAge （特征）</p>
                  <p>totalRooms （特征）</p>
                  <p>totalBedrooms （特征）</p>
                  <p>medianHouseValue （标签）</p>
                  <p>15</p>
                  <p>5612</p>
                  <p>1283</p>
                  <p>66900</p>
                  <p>19</p>
                  <p>7650</p>
                  <p>1901</p>
                  <p>80100</p>
                  <p>17</p>
                  <p>720</p>
                  <p>174</p>
                  <p>85700</p>
                  <p>14</p>
                  <p>1501</p>
                  <p>337</p>
                  <p>73400</p>
                  <p>20</p>
                  <p>1454</p>
                  <p>326</p>
                  <p>65500</p>
                  <p>无标签样本包含特征，但不包含标签。即：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">  unlabeled <span class="string">examples:</span> &#123;features, ?&#125;: (x, ?)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在使用有标签样本训练了我们的模型之后，我们会使用该模型来预测无标签样本的标签。在垃圾邮件检测器示例中，无标签样本是用户尚未添加标签的新电子邮件。</p>
                  <h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2>
                  <p>模型定义了特征与标签之间的关系。例如，垃圾邮件检测模型可能会将某些特征与“垃圾邮件”紧密联系起来。我们来重点介绍一下模型生命周期的两个阶段：</p>
                  <ul>
                    <li>训练表示创建或学习模型。也就是说，您向模型展示有标签样本，让模型逐渐学习特征与标签之间的关系。</li>
                    <li>推断表示将训练后的模型应用于无标签样本。也就是说，您使用训练后的模型来做出有用的预测 (y’)。例如，在推断期间，您可以针对新的无标签样本预测 medianHouseValue。</li>
                  </ul>
                  <h2 id="回归与分类"><a href="#回归与分类" class="headerlink" title="回归与分类"></a>回归与分类</h2>
                  <p>回归模型可预测连续值。例如，回归模型做出的预测可回答如下问题：</p>
                  <ul>
                    <li>加利福尼亚州一栋房产的价值是多少？</li>
                    <li>用户点击此广告的概率是多少？</li>
                  </ul>
                  <p>分类模型可预测离散值。例如，分类模型做出的预测可回答如下问题：</p>
                  <ul>
                    <li>某个指定电子邮件是垃圾邮件还是非垃圾邮件？</li>
                    <li>这是一张狗、猫还是仓鼠图片？</li>
                  </ul>
                  <h2 id="原文地址"><a href="#原文地址" class="headerlink" title="原文地址"></a>原文地址</h2>
                  <p>本节原文地址：<a href="https://developers.google.cn/machine-learning/crash-course/framing/ml-terminology" target="_blank" rel="noopener">问题构建 (Framing)：机器学习主要术语</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-03-01 17:34:10" itemprop="dateCreated datePublished" datetime="2018-03-01T17:34:10+08:00">2018-03-01</time>
                </span>
                <span id="/5771.html" class="post-meta-item leancloud_visitors" data-flag-title="机器学习主要术语" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5737.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Paper <i class="label-arrow"></i>
                  </a>
                  <a href="/5737.html" class="post-title-link" itemprop="url">[论文笔记] Learning Phrase Representations using RNN Encoder–Decoder for Statistical Machine Translation</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>我们知道，Seq2Seq 现在已经成为了机器翻译、对话聊天、文本摘要等工作的重要模型，真正提出 Seq2Seq 的文章是《Sequence to Sequence Learning with Neural Networks》，但本篇《Learning Phrase Representations using RNN Encoder–Decoder for Statistical Machine Translation》比前者更早使用了 Seq2Seq 模型来解决机器翻译的问题，本文是该篇论文的概述。</p>
                  <h2 id="发布信息"><a href="#发布信息" class="headerlink" title="发布信息"></a>发布信息</h2>
                  <p><a href="https://arxiv.org/abs/1406.1078" target="_blank" rel="noopener">Learning Phrase Representations using RNN Encoder–Decoder for Statistical Machine Translation</a> 2014 年 6 月发布于 Arxiv 上，一作是 Kyunghyun Cho，当时来自蒙特利尔大学，现在在纽约大学任教。</p>
                  <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2>
                  <p>这篇论文中提出了一种新的模型，叫做 RNN Encoder-Decoder， 并将它用来进行机器翻译和比较不同语言的短语/词组之间的语义近似程度。这个模型由两个 RNN 组成，其中 Encoder 用来将输入的序列表示成一个固定长度的向量，Decoder 则使用这个向量重建出目标序列，另外该论文提出了 GRU 的基本结构，为后来的研究奠定了基础。 因此本文的主要贡献是：</p>
                  <ul>
                    <li>提出了一种类似于 LSTM 的 GRU 结构，并且具有比 LSTM 更少的参数，更不容易过拟合。</li>
                    <li>较早地将 Seq2Seq 应用在了机器翻译领域，并且取得了不错的效果。</li>
                  </ul>
                  <h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2>
                  <p>本文提出的模型结构如下图所示： <img src="https://ws1.sinaimg.cn/large/006tNc79gy1foubbvos97j30iw0i8q4m.jpg" alt=""></p>
                  <p>这里首先对输入上文 x 走一遍 RNN，然后得到一个固定长度的向量 c，作为 Encoder，然后接下来再根据 c 和后续隐状态和输入状态来得到后续状态，Encoder 的行为比较简单，重点在 Decoder 上。</p>
                  <p>Decoder 中 t 时刻的内部状态的 ht 为:</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-003503@2x.png" alt=""></p>
                  <p>该时刻的输出概率则为: <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-003613@2x.png" alt=""> 模型训练时则去最大化给定输入序列 x 时输出序列为 y 的条件概率: <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-003657@2x.png" alt=""> 以上便是核心的公式，上面的这个就是该模型的优化目标。 在机器翻译上，作者用 Moses (一个 SMT 系统) 建立了一个 phrase based 的翻译模型作为 baseline system ，然后对比了以下四个模型的 BLEU 值</p>
                  <ol>
                    <li>Baseline configuration</li>
                    <li>Baseline + RNN</li>
                    <li>Baseline + CSLM + RNN</li>
                    <li>Baseline + CSLM + RNN + Word penalty</li>
                  </ol>
                  <p>四种不同的模型的 BLEU 值如下表所示：</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-005725@2x.png" alt=""></p>
                  <p>phrase pair 打分的结果如下： <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-005736@2x.png" alt=""> 其中第一栏是输入的英语 phrase ，第二栏是用传统的模型得到的最近似的三个法语 phrase，第三栏是用 Encoder-Decoder 模型得到的最近似的三个 phrase。 另外作者还说明该模型可以学习到一个比较好的效果的 Word Embedding 结果，附图如下： <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-003954@2x.png" alt=""> 左上角的图代表全局的 Embedding 结果，另外三个图是局部结果，可以看到类似的名词都被聚到了一起。</p>
                  <h2 id="GRU"><a href="#GRU" class="headerlink" title="GRU"></a>GRU</h2>
                  <p>另外本文的一个主要贡献是提出了 GRU 的门结构，相比 LSTM 更加简洁，而且效果不输 LSTM，关于它的详细公式推导，可以直接参考论文的最后的附录部分，有详细的介绍，在此截图如下： <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-004500@2x.png" alt=""> <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-004518@2x.png" alt=""> <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/WX20180227-004547@2x.png" alt=""></p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>本篇论文算是为 Seq2Seq 的研究开了先河，而且其提出的 GRU 结构也为后来的研究做好了铺垫，得到了广泛应用，非常值得一读。</p>
                  <h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2>
                  <ul>
                    <li><a href="http://www.zmonster.me/notes/phrase_representation_using_rnn_encoder_decoder.html" target="_blank" rel="noopener">http://www.zmonster.me/notes/phrase_representation_using_rnn_encoder_decoder.html</a></li>
                    <li><a href="https://yq.aliyun.com/articles/175467" target="_blank" rel="noopener">https://yq.aliyun.com/articles/175467</a></li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-02-27 00:52:07" itemprop="dateCreated datePublished" datetime="2018-02-27T00:52:07+08:00">2018-02-27</time>
                </span>
                <span id="/5737.html" class="post-meta-item leancloud_visitors" data-flag-title="[论文笔记] Learning Phrase Representations using RNN Encoder–Decoder for Statistical Machine Translation" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5715.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5715.html" class="post-title-link" itemprop="url">TensorFlow layers模块用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>TensorFlow 中的 layers 模块提供用于深度学习的更高层次封装的 API，利用它我们可以轻松地构建模型，这一节我们就来看下这个模块的 API 的具体用法。</p>
                  <h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2>
                  <p>layers 模块的路径写法为 tf.layers，这个模块定义在 tensorflow/python/layers/layers.py，其官方文档地址为：<a href="https://www.tensorflow.org/api_docs/python/tf/layers" target="_blank" rel="noopener">https://www.tensorflow.org/api_docs/python/tf/layers</a>，TensorFlow 版本为 1.5。 这里面提供了多个类和方法以供使用，下面我们分别予以介绍。</p>
                  <h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2>
                  <p>tf.layers 模块提供的方法有：</p>
                  <ul>
                    <li>Input(…): 用于实例化一个输入 Tensor，作为神经网络的输入。</li>
                    <li>average_pooling1d(…): 一维平均池化层</li>
                    <li>average_pooling2d(…): 二维平均池化层</li>
                    <li>average_pooling3d(…): 三维平均池化层</li>
                    <li>batch_normalization(…): 批量标准化层</li>
                    <li>conv1d(…): 一维卷积层</li>
                    <li>conv2d(…): 二维卷积层</li>
                    <li>conv2d_transpose(…): 二维反卷积层</li>
                    <li>conv3d(…): 三维卷积层</li>
                    <li>conv3d_transpose(…): 三维反卷积层</li>
                    <li>dense(…): 全连接层</li>
                    <li>dropout(…): Dropout层</li>
                    <li>flatten(…): Flatten层，即把一个 Tensor 展平</li>
                    <li>max_pooling1d(…): 一维最大池化层</li>
                    <li>max_pooling2d(…): 二维最大池化层</li>
                    <li>max_pooling3d(…): 三维最大池化层</li>
                    <li>separable_conv2d(…): 二维深度可分离卷积层</li>
                  </ul>
                  <h3 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h3>
                  <p>tf.layers.Input() 这个方法是用于输入数据的方法，其实类似于 tf.placeholder，相当于一个占位符的作用，当然也可以通过传入 tensor 参数来进行赋值。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Input(</span><br><span class="line">    <span class="attribute">shape</span>=None,</span><br><span class="line">    <span class="attribute">batch_size</span>=None,</span><br><span class="line">    <span class="attribute">name</span>=None,</span><br><span class="line">    <span class="attribute">dtype</span>=tf.float32,</span><br><span class="line">    <span class="attribute">sparse</span>=<span class="literal">False</span>,</span><br><span class="line">    <span class="attribute">tensor</span>=None</span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>shape：可选，默认 None，是一个数字组成的元组或列表，但是这个 shape 比较特殊，它不包含 batch_size，比如传入的 shape 为 [32]，那么它会将 shape 转化为 [?, 32]，这里一定需要注意。</li>
                    <li>batch_size：可选，默认 None，代表输入数据的 batch size，可以是数字或者 None。</li>
                    <li>name：可选，默认 None，输入层的名称。</li>
                    <li>dtype：可选，默认 tf.float32，元素的类型。</li>
                    <li>sparse：可选，默认 False，指定是否以稀疏矩阵的形式来创建 placeholder。</li>
                    <li>tensor：可选，默认 None，如果指定，那么创建的内容便不再是一个 placeholder，会用此 Tensor 初始化。</li>
                  </ul>
                  <p>返回值： 返回一个包含历史 Meta Data 的 Tensor。 我们用一个实例来感受一下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf<span class="selector-class">.layers</span>.Input(shape=[<span class="number">32</span>])</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(x)</span></span></span><br><span class="line">y = tf<span class="selector-class">.layers</span>.dense(x, <span class="number">16</span>, activation=tf<span class="selector-class">.nn</span>.softmax)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(y)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先我们用 Input() 方法初始化了一个 placeholder，这时我们没有传入 tensor 参数，然后调用了 dense() 方法构建了一个全连接网络，激活函数使用 softmax，然后将二者输出，结果如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"input_layer_1:0"</span>, shape=(?, <span class="number">32</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"dense/Softmax:0"</span>, shape=(?, <span class="number">16</span>)</span></span>, dtype=float32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时我们发现，shape 它给我们做了转化，本来是 [32]，结果它给转化成了 [?, 32]，即第一维代表 batch_size，所以我们需要注意，在调用此方法的时候不需要去关心 batch_size 这一维。 如果我们在初始化的时候传入一个已有 Tensor，例如：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">data</span> = tf.constant([1, 2, 3])</span></span><br><span class="line"><span class="title">x</span> = tf.layers.<span class="type">Input</span>(tensor=<span class="class"><span class="keyword">data</span>)</span></span><br><span class="line"><span class="title">print</span>(x)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="constructor">Tensor(<span class="string">"Const:0"</span>, <span class="params">shape</span>=(3,)</span>, dtype=<span class="built_in">int32</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到它可以自动计算出其 shape 和 dtype。</p>
                  <h3 id="batch-normalization"><a href="#batch-normalization" class="headerlink" title="batch_normalization"></a>batch_normalization</h3>
                  <p>此方法是批量标准化的方法，经过处理之后可以加速训练速度，其定义在 tensorflow/python/layers/normalization.py，论文可以参考：<a href="http://arxiv.org/abs/1502.03167" target="_blank" rel="noopener">http://arxiv.org/abs/1502.03167</a> “Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift”。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">batch_normalization(</span><br><span class="line">    inputs,</span><br><span class="line">    <span class="attribute">axis</span>=-1,</span><br><span class="line">    <span class="attribute">momentum</span>=0.99,</span><br><span class="line">    <span class="attribute">epsilon</span>=0.001,</span><br><span class="line">    <span class="attribute">center</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">scale</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">beta_initializer</span>=tf.zeros_initializer(),</span><br><span class="line">    <span class="attribute">gamma_initializer</span>=tf.ones_initializer(),</span><br><span class="line">    <span class="attribute">moving_mean_initializer</span>=tf.zeros_initializer(),</span><br><span class="line">    <span class="attribute">moving_variance_initializer</span>=tf.ones_initializer(),</span><br><span class="line">    <span class="attribute">beta_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">gamma_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">beta_constraint</span>=None,</span><br><span class="line">    <span class="attribute">gamma_constraint</span>=None,</span><br><span class="line">    <span class="attribute">training</span>=<span class="literal">False</span>,</span><br><span class="line">    <span class="attribute">trainable</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">name</span>=None,</span><br><span class="line">    <span class="attribute">reuse</span>=None,</span><br><span class="line">    <span class="attribute">renorm</span>=<span class="literal">False</span>,</span><br><span class="line">    <span class="attribute">renorm_clipping</span>=None,</span><br><span class="line">    <span class="attribute">renorm_momentum</span>=0.99,</span><br><span class="line">    <span class="attribute">fused</span>=None,</span><br><span class="line">    <span class="attribute">virtual_batch_size</span>=None,</span><br><span class="line">    <span class="attribute">adjustment</span>=None</span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>inputs：必需，即输入数据。</li>
                    <li>axis：可选，默认 -1，即进行标注化操作时操作数据的哪个维度。</li>
                    <li>momentum：可选，默认 0.99，即动态均值的动量。</li>
                    <li>epsilon：可选，默认 0.01，大于0的小浮点数，用于防止除0错误。</li>
                    <li>center：可选，默认 True，若设为True，将会将 beta 作为偏置加上去，否则忽略参数 beta</li>
                    <li>scale：可选，默认 True，若设为True，则会乘以gamma，否则不使用gamma。当下一层是线性的时，可以设False，因为scaling的操作将被下一层执行。</li>
                    <li>beta_initializer：可选，默认 zeros_initializer，即 beta 权重的初始方法。</li>
                    <li>gamma_initializer：可选，默认 ones_initializer，即 gamma 的初始化方法。</li>
                    <li>moving_mean_initializer：可选，默认 zeros_initializer，即动态均值的初始化方法。</li>
                    <li>moving_variance_initializer：可选，默认 ones_initializer，即动态方差的初始化方法。</li>
                    <li>beta_regularizer: 可选，默认None，beta 的正则化方法。</li>
                    <li>gamma_regularizer: 可选，默认None，gamma 的正则化方法。</li>
                    <li>beta_constraint: 可选，默认None，加在 beta 上的约束项。</li>
                    <li>gamma_constraint: 可选，默认None，加在 gamma 上的约束项。</li>
                    <li>training：可选，默认 False，返回结果是 training 模式。</li>
                    <li>trainable：可选，默认为 True，布尔类型，如果为 True，则将变量添加 GraphKeys.TRAINABLE_VARIABLES 中。</li>
                    <li>name：可选，默认 None，层名称。</li>
                    <li>reuse：可选，默认 None，根据层名判断是否重复利用。</li>
                    <li>renorm：可选，默认 False，是否要用 Batch Renormalization (<a href="https://arxiv.org/abs/1702.03275" target="_blank" rel="noopener">https://arxiv.org/abs/1702.03275</a>)</li>
                    <li>renorm_clipping：可选，默认 None，是否要用 rmax、rmin、dmax 来 scalar Tensor。</li>
                    <li>renorm_momentum，可选，默认 0.99，用来更新动态均值和标准差的 Momentum 值。</li>
                    <li>fused，可选，默认 None，是否使用一个更快的、融合的实现方法。</li>
                    <li>virtual_batch_size，可选，默认 None，是一个 int 数字，指定一个虚拟 batch size。</li>
                    <li>adjustment，可选，默认 None，对标准化后的结果进行适当调整的方法。</li>
                  </ul>
                  <p>最后的一些参数说明不够详尽，更详细的用法参考：<a href="https://www.tensorflow.org/api_docs/python/tf/layers/batch_normalization" target="_blank" rel="noopener">https://www.tensorflow.org/api_docs/python/tf/layers/batch_normalization</a>。 其用法很简单，在输入数据后面加一层 batch_normalization() 即可：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">x</span> = tf.layers.Input(shape=[<span class="number">32</span>])</span><br><span class="line"><span class="attr">x</span> = tf.layers.batch_normalization(x)</span><br><span class="line"><span class="attr">y</span> = tf.layers.dense(x, <span class="number">20</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="dense"><a href="#dense" class="headerlink" title="dense"></a>dense</h3>
                  <p>dense，即全连接网络，layers 模块提供了一个 dense() 方法来实现此操作，定义在 tensorflow/python/layers/core.py 中，下面我们来说明一下它的用法。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">dense(</span><br><span class="line">    inputs,</span><br><span class="line">    units,</span><br><span class="line">    <span class="attribute">activation</span>=None,</span><br><span class="line">    <span class="attribute">use_bias</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">kernel_initializer</span>=None,</span><br><span class="line">    <span class="attribute">bias_initializer</span>=tf.zeros_initializer(),</span><br><span class="line">    <span class="attribute">kernel_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">bias_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">activity_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">kernel_constraint</span>=None,</span><br><span class="line">    <span class="attribute">bias_constraint</span>=None,</span><br><span class="line">    <span class="attribute">trainable</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">name</span>=None,</span><br><span class="line">    <span class="attribute">reuse</span>=None</span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>inputs：必需，即需要进行操作的输入数据。</li>
                    <li>units：必须，即神经元的数量。</li>
                    <li>activation：可选，默认为 None，如果为 None 则是线性激活。</li>
                    <li>use_bias：可选，默认为 True，是否使用偏置。</li>
                    <li>kernel_initializer：可选，默认为 None，即权重的初始化方法，如果为 None，则使用默认的 Xavier 初始化方法。</li>
                    <li>bias_initializer：可选，默认为零值初始化，即偏置的初始化方法。</li>
                    <li>kernel_regularizer：可选，默认为 None，施加在权重上的正则项。</li>
                    <li>bias_regularizer：可选，默认为 None，施加在偏置上的正则项。</li>
                    <li>activity_regularizer：可选，默认为 None，施加在输出上的正则项。</li>
                    <li>kernel_constraint，可选，默认为 None，施加在权重上的约束项。</li>
                    <li>bias_constraint，可选，默认为 None，施加在偏置上的约束项。</li>
                    <li>trainable：可选，默认为 True，布尔类型，如果为 True，则将变量添加到 GraphKeys.TRAINABLE_VARIABLES 中。</li>
                    <li>name：可选，默认为 None，卷积层的名称。</li>
                    <li>reuse：可选，默认为 None，布尔类型，如果为 True，那么如果 name 相同时，会重复利用。</li>
                  </ul>
                  <p>返回值： 全连接网络处理后的 Tensor。 下面我们用一个实例来感受一下它的用法：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf<span class="selector-class">.layers</span>.Input(shape=[<span class="number">32</span>])</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(x)</span></span></span><br><span class="line">y1 = tf<span class="selector-class">.layers</span>.dense(x, <span class="number">16</span>, activation=tf<span class="selector-class">.nn</span>.relu)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(y1)</span></span></span><br><span class="line">y2 = tf<span class="selector-class">.layers</span>.dense(y1, <span class="number">5</span>, activation=tf<span class="selector-class">.nn</span>.sigmoid)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(y2)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先我们用 Input 定义了 [?, 32] 的输入数据，然后经过第一层全连接网络，此时指定了神经元个数为 16，激活函数为 relu，接着输出结果经过第二层全连接网络，此时指定了神经元个数为 5，激活函数为 sigmoid，最后输出，结果如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"input_layer_1:0"</span>, shape=(?, <span class="number">32</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"dense/Relu:0"</span>, shape=(?, <span class="number">16</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"dense_2/Sigmoid:0"</span>, shape=(?, <span class="number">5</span>)</span></span>, dtype=float32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到输出结果的最后一维度就等于神经元的个数，这是非常容易理解的。</p>
                  <h3 id="convolution"><a href="#convolution" class="headerlink" title="convolution"></a>convolution</h3>
                  <p>convolution，即卷积，这里提供了多个卷积方法，如 conv1d()、conv2d()、conv3d()，分别代表一维、二维、三维卷积，另外还有 conv2d_transpose()、conv3d_transpose()，分别代表二维和三维反卷积，还有 separable_conv2d() 方法代表二维深度可分离卷积。它们定义在 tensorflow/python/layers/convolutional.py 中，其用法都是类似的，在这里以 conv2d() 方法为例进行说明。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">conv2d(</span><br><span class="line">    inputs,</span><br><span class="line">    filters,</span><br><span class="line">    kernel_size,</span><br><span class="line">    strides=(1, 1),</span><br><span class="line">    <span class="attribute">padding</span>=<span class="string">'valid'</span>,</span><br><span class="line">    <span class="attribute">data_format</span>=<span class="string">'channels_last'</span>,</span><br><span class="line">    dilation_rate=(1, 1),</span><br><span class="line">    <span class="attribute">activation</span>=None,</span><br><span class="line">    <span class="attribute">use_bias</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">kernel_initializer</span>=None,</span><br><span class="line">    <span class="attribute">bias_initializer</span>=tf.zeros_initializer(),</span><br><span class="line">    <span class="attribute">kernel_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">bias_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">activity_regularizer</span>=None,</span><br><span class="line">    <span class="attribute">kernel_constraint</span>=None,</span><br><span class="line">    <span class="attribute">bias_constraint</span>=None,</span><br><span class="line">    <span class="attribute">trainable</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">name</span>=None,</span><br><span class="line">    <span class="attribute">reuse</span>=None</span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>inputs：必需，即需要进行操作的输入数据。</li>
                    <li>filters：必需，是一个数字，代表了输出通道的个数，即 output_channels。</li>
                    <li>kernel_size：必需，卷积核大小，必须是一个数字（高和宽都是此数字）或者长度为 2 的列表（分别代表高、宽）。</li>
                    <li>strides：可选，默认为 (1, 1)，卷积步长，必须是一个数字（高和宽都是此数字）或者长度为 2 的列表（分别代表高、宽）。</li>
                    <li>padding：可选，默认为 valid，padding 的模式，有 valid 和 same 两种，大小写不区分。</li>
                    <li>data_format：可选，默认 channels_last，分为 channels_last 和 channels_first 两种模式，代表了输入数据的维度类型，如果是 channels_last，那么输入数据的 shape 为 (batch, height, width, channels)，如果是 channels_first，那么输入数据的 shape 为 (batch, channels, height, width)。</li>
                    <li>dilation_rate：可选，默认为 (1, 1)，卷积的扩张率，如当扩张率为 2 时，卷积核内部就会有边距，3x3 的卷积核就会变成 5x5。</li>
                    <li>activation：可选，默认为 None，如果为 None 则是线性激活。</li>
                    <li>use_bias：可选，默认为 True，是否使用偏置。</li>
                    <li>kernel_initializer：可选，默认为 None，即权重的初始化方法，如果为 None，则使用默认的 Xavier 初始化方法。</li>
                    <li>bias_initializer：可选，默认为零值初始化，即偏置的初始化方法。</li>
                    <li>kernel_regularizer：可选，默认为 None，施加在权重上的正则项。</li>
                    <li>bias_regularizer：可选，默认为 None，施加在偏置上的正则项。</li>
                    <li>activity_regularizer：可选，默认为 None，施加在输出上的正则项。</li>
                    <li>kernel_constraint，可选，默认为 None，施加在权重上的约束项。</li>
                    <li>bias_constraint，可选，默认为 None，施加在偏置上的约束项。</li>
                    <li>trainable：可选，默认为 True，布尔类型，如果为 True，则将变量添加到 GraphKeys.TRAINABLE_VARIABLES 中。</li>
                    <li>name：可选，默认为 None，卷积层的名称。</li>
                    <li>reuse：可选，默认为 None，布尔类型，如果为 True，那么如果 name 相同时，会重复利用。</li>
                  </ul>
                  <p>返回值： 卷积后的 Tensor。 下面我们用实例感受一下它的用法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[20, 20, 3])</span><br><span class="line">y = tf.layers.conv2d(x, <span class="attribute">filters</span>=6, <span class="attribute">kernel_size</span>=2, <span class="attribute">padding</span>=<span class="string">'same'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们首先声明了一个 [?, 20, 20, 3] 的输入 x，然后将其传给 conv2d() 方法，filters 设定为 6，即输出通道为 6，kernel_size 为 2，即卷积核大小为 2 x 2，padding 方式设置为 same，那么输出结果的宽高和原来一定是相同的，但是输出通道就变成了 6，结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Tensor(<span class="string">"conv2d/BiasAdd:0"</span>, shape=(?, <span class="number">20</span>, <span class="number">20</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>但如果我们将 padding 方式不传入，使用默认的 valid 模式，代码改写如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[20, 20, 3])</span><br><span class="line">y = tf.layers.conv2d(x, <span class="attribute">filters</span>=6, <span class="attribute">kernel_size</span>=2)</span><br><span class="line"><span class="builtin-name">print</span>(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Tensor(<span class="string">"conv2d/BiasAdd:0"</span>, shape=(?, <span class="number">19</span>, <span class="number">19</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果就变成了 [?, 19, 19, 6]，这是因为步长默认为 1，卷积核大小为 2 x 2，所以得到的结果的高宽即为 (20 - (2 - 1)) x (20 - (2 - 1)) = 19 x 19。 当然卷积核我们也可以变换大小，传入一个列表形式：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[<span class="number">20</span>, <span class="number">20</span>, <span class="number">3</span>])</span><br><span class="line">y = tf.layers.conv2d(x, filters=<span class="number">6</span>, kernel_size=[<span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">print(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时我们的卷积核大小变成了 2 x 3，即高为 2，宽为 3，结果就变成了 [?, 19, 18, 6]，这是因为步长默认为 1，卷积核大小为 2 x 2，所以得到的结果的高宽即为 (20 - (2 - 1)) x (20 - (3 - 1)) = 19 x 18。 如果我们将步长也设置一下，也传入列表形式：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[<span class="number">20</span>, <span class="number">20</span>, <span class="number">3</span>])</span><br><span class="line">y = tf.layers.conv2d(x, filters=<span class="number">6</span>, kernel_size=[<span class="number">2</span>, <span class="number">3</span>], strides=[<span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">print(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时卷积核大小变成了 2 x 3，步长变成了 2 x 2，所以结果的高宽为 ceil(20 - (2- 1)) / 2 x ceil(20 - (3- 1)) / 2 = 10 x 9，得到的结果即为 [?, 10, 9, 6]。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Tensor(<span class="string">"conv2d_4/BiasAdd:0"</span>, shape=(?, <span class="number">10</span>, <span class="number">9</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外我们还可以传入激活函数，或者禁用 bias 等操作，实例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[20, 20, 3])</span><br><span class="line">y = tf.layers.conv2d(x, <span class="attribute">filters</span>=6, <span class="attribute">kernel_size</span>=2, <span class="attribute">activation</span>=tf.nn.relu, <span class="attribute">use_bias</span>=<span class="literal">False</span>)</span><br><span class="line"><span class="builtin-name">print</span>(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就将激活函数改成了 relu，同时禁用了 bias，运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Tensor(<span class="string">"conv2d_5/Relu:0"</span>, shape=(?, <span class="number">19</span>, <span class="number">19</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外还有反卷积操作，反卷积顾名思义即卷积的反向操作，即输入卷积的结果，得到卷积前的结果，其参数用法是完全一样的，例如：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[20, 20, 3])</span><br><span class="line">y = tf.layers.conv2d_transpose(x, <span class="attribute">filters</span>=6, <span class="attribute">kernel_size</span>=2, <span class="attribute">strides</span>=2)</span><br><span class="line"><span class="builtin-name">print</span>(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>例如此处输入的图像高宽为 20 x 20，经过卷积核为 2，步长为 2 的反卷积处理，得到的结果高宽就变为了 40 x 40，结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Tensor(<span class="string">"conv2d_transpose/BiasAdd:0"</span>, shape=(?, <span class="number">40</span>, <span class="number">40</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="pooling"><a href="#pooling" class="headerlink" title="pooling"></a>pooling</h3>
                  <p>pooling，即池化，layers 模块提供了多个池化方法，这几个池化方法都是类似的，包括 max_pooling1d()、max_pooling2d()、max_pooling3d()、average_pooling1d()、average_pooling2d()、average_pooling3d()，分别代表一维二维三维最大和平均池化方法，它们都定义在 tensorflow/python/layers/pooling.py 中，这里以 max_pooling2d() 方法为例进行介绍。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">max_pooling2d(</span><br><span class="line">    inputs,</span><br><span class="line">    pool_size,</span><br><span class="line">    strides,</span><br><span class="line">    <span class="attribute">padding</span>=<span class="string">'valid'</span>,</span><br><span class="line">    <span class="attribute">data_format</span>=<span class="string">'channels_last'</span>,</span><br><span class="line">    <span class="attribute">name</span>=None</span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>inputs: 必需，即需要池化的输入对象，必须是 4 维的。</li>
                    <li>pool_size：必需，池化窗口大小，必须是一个数字（高和宽都是此数字）或者长度为 2 的列表（分别代表高、宽）。</li>
                    <li>strides：必需，池化步长，必须是一个数字（高和宽都是此数字）或者长度为 2 的列表（分别代表高、宽）。</li>
                    <li>padding：可选，默认 valid，padding 的方法，valid 或者 same，大小写不区分。</li>
                    <li>data_format：可选，默认 channels_last，分为 channels_last 和 channels_first 两种模式，代表了输入数据的维度类型，如果是 channels_last，那么输入数据的 shape 为 (batch, height, width, channels)，如果是 channels_first，那么输入数据的 shape 为 (batch, channels, height, width)。</li>
                    <li>name：可选，默认 None，池化层的名称。</li>
                  </ul>
                  <p>返回值： 经过池化处理后的 Tensor。 下面我们用一个实例来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.Input(shape=[20, 20, 3])</span><br><span class="line"><span class="builtin-name">print</span>(x)</span><br><span class="line">y = tf.layers.conv2d(x, <span class="attribute">filters</span>=6, <span class="attribute">kernel_size</span>=3, <span class="attribute">padding</span>=<span class="string">'same'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(y)</span><br><span class="line">p = tf.layers.max_pooling2d(y, <span class="attribute">pool_size</span>=2, <span class="attribute">strides</span>=2)</span><br><span class="line"><span class="builtin-name">print</span>(p)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们首先指定了输入 x，shape 为 [20, 20, 3]，然后对其进行了卷积计算，然后池化，最后得到池化后的结果。结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Tensor(<span class="string">"input_layer_1:0"</span>, shape=(?, <span class="number">20</span>, <span class="number">20</span>, <span class="number">3</span>), dtype=<span class="built_in">float</span>32)</span><br><span class="line">Tensor(<span class="string">"conv2d/BiasAdd:0"</span>, shape=(?, <span class="number">20</span>, <span class="number">20</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br><span class="line">Tensor(<span class="string">"max_pooling2d/MaxPool:0"</span>, shape=(?, <span class="number">10</span>, <span class="number">10</span>, <span class="number">6</span>), dtype=<span class="built_in">float</span>32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到这里池化窗口用的是 2，步长也是 2，所以原本卷积后 shape 为 [?, 20, 20, 6] 的结果就变成了 [?, 10, 10, 6]。</p>
                  <h3 id="dropout"><a href="#dropout" class="headerlink" title="dropout"></a>dropout</h3>
                  <p>dropout 是指在深度学习网络的训练过程中，对于神经网络单元，按照一定的概率将其暂时从网络中丢弃，可以用来防止过拟合，layers 模块中提供了 dropout() 方法来实现这一操作，定义在 tensorflow/python/layers/core.py。下面我们来说明一下它的用法。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">dropout(</span><br><span class="line">    inputs,</span><br><span class="line">    <span class="attribute">rate</span>=0.5,</span><br><span class="line">    <span class="attribute">noise_shape</span>=None,</span><br><span class="line">    <span class="attribute">seed</span>=None,</span><br><span class="line">    <span class="attribute">training</span>=<span class="literal">False</span>,</span><br><span class="line">    <span class="attribute">name</span>=None</span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>inputs：必须，即输入数据。</li>
                    <li>rate：可选，默认为 0.5，即 dropout rate，如设置为 0.1，则意味着会丢弃 10% 的神经元。</li>
                    <li>noise_shape：可选，默认为 None，int32 类型的一维 Tensor，它代表了 dropout mask 的 shape，dropout mask 会与 inputs 相乘对 inputs 做转换，例如 inputs 的 shape 为 (batch_size, timesteps, features)，但我们想要 droput mask 在所有 timesteps 都是相同的，我们可以设置 noise_shape=[batch_size, 1, features]。</li>
                    <li>seed：可选，默认为 None，即产生随机熟的种子值。</li>
                    <li>training：可选，默认为 False，布尔类型，即代表了是否标志位 training 模式。</li>
                    <li>name：可选，默认为 None，dropout 层的名称。</li>
                  </ul>
                  <p>返回： 经过 dropout 层之后的 Tensor。 我们用一个实例来感受一下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf<span class="selector-class">.layers</span>.Input(shape=[<span class="number">32</span>])</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(x)</span></span></span><br><span class="line">y = tf<span class="selector-class">.layers</span>.dense(x, <span class="number">16</span>, activation=tf<span class="selector-class">.nn</span>.softmax)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(y)</span></span></span><br><span class="line">d = tf<span class="selector-class">.layers</span>.dropout(y, rate=<span class="number">0.2</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(d)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"input_layer_1:0"</span>, shape=(?, <span class="number">32</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"dense/Softmax:0"</span>, shape=(?, <span class="number">16</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"dropout/Identity:0"</span>, shape=(?, <span class="number">16</span>)</span></span>, dtype=float32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们使用 dropout() 方法实现了 droput 操作，并制定 dropout rate 为 0.2，最后输出结果的 shape 和原来是一致的。</p>
                  <h3 id="flatten"><a href="#flatten" class="headerlink" title="flatten"></a>flatten</h3>
                  <p>flatten() 方法可以对 Tensor 进行展平操作，定义在 tensorflow/python/layers/core.py。</p>
                  <figure class="highlight fortran">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">flatten(</span><br><span class="line">    inputs,</span><br><span class="line">    <span class="keyword">name</span>=<span class="keyword">None</span></span><br><span class="line">)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明如下：</p>
                  <ul>
                    <li>inputs：必需，即输入数据。</li>
                    <li>name：可选，默认为 None，即该层的名称。</li>
                  </ul>
                  <p>返回结果： 展平后的 Tensor。 下面我们用一个实例来感受一下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf<span class="selector-class">.layers</span>.Input(shape=[<span class="number">5</span>, <span class="number">6</span>])</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(x)</span></span></span><br><span class="line">y = tf<span class="selector-class">.layers</span>.flatten(x)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(y)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"input_layer_1:0"</span>, shape=(?, <span class="number">5</span>, <span class="number">6</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"flatten/Reshape:0"</span>, shape=(?, <span class="number">30</span>)</span></span>, dtype=float32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里输入数据的 shape 为 [?, 5, 6]，经过 flatten 层之后，就会变成 [?, 30]，即将除了第一维的数据维度相乘，对原 Tensor 进行展平。 假如第一维是一个已知的数的话，它依然还是同样的处理，示例如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.placeholder(shape=[<span class="number">5</span>, <span class="number">6</span>, <span class="number">2</span>], dtype=tf.float32)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(x)</span></span></span><br><span class="line">y = tf<span class="selector-class">.layers</span>.flatten(x)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(y)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"Placeholder:0"</span>, shape=(<span class="number">5</span>, <span class="number">6</span>, <span class="number">2</span>)</span></span>, dtype=float32)</span><br><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"flatten_2/Reshape:0"</span>, shape=(<span class="number">5</span>, <span class="number">12</span>)</span></span>, dtype=float32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2>
                  <p>除了如上的方法，其实我们还可以直接使用类来进行操作，实际上看方法的实现就是实例化了其对应的类，下面我们首先说明一下有哪些类可以使用：</p>
                  <ul>
                    <li>class AveragePooling1D: 一维平均池化层类</li>
                    <li>class AveragePooling2D: 二维平均池化层类</li>
                    <li>class AveragePooling3D: 三维平均池化层类</li>
                    <li>class BatchNormalization: 批量标准化层类</li>
                    <li>class Conv1D: 一维卷积层类</li>
                    <li>class Conv2D: 二维卷积层类</li>
                    <li>class Conv2DTranspose: 二维反卷积层类</li>
                    <li>class Conv3D: 三维卷积层类</li>
                    <li>class Conv3DTranspose: 三维反卷积层类</li>
                    <li>class Dense: 全连接层类</li>
                    <li>class Dropout: Dropout 层类</li>
                    <li>class Flatten: Flatten 层类</li>
                    <li>class InputSpec: Input 层类</li>
                    <li>class Layer: 基类、父类</li>
                    <li>class MaxPooling1D: 一维最大池化层类</li>
                    <li>class MaxPooling2D: 二维最大池化层类</li>
                    <li>class MaxPooling3D: 三维最大池化层类</li>
                    <li>class SeparableConv2D: 二维深度可分离卷积层类</li>
                  </ul>
                  <p>其实类这些类都和上文介绍的方法是一一对应的，关于它的用法我们可以在方法的源码实现里面找到，下面我们以 Dense 类的用法为例来说明一下这些类的具体调用方法：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.layers.<span class="constructor">Input(<span class="params">shape</span>=[32])</span></span><br><span class="line">dense = tf.layers.<span class="constructor">Dense(16, <span class="params">activation</span>=<span class="params">tf</span>.<span class="params">nn</span>.<span class="params">relu</span>)</span></span><br><span class="line">y = dense.apply(x)</span><br><span class="line">print(y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们初始化了一个 Dense 类，它只接受一个必须参数，那就是 units，相比 dense() 方法来说它没有了 inputs，因此这个实例化的类和 inputs 是无关的，这样就相当于创建了一个 16 个神经元的全连接层。 但创建了不调用是没有用的，我们要将这个层构建到网络之中，需要调用它的 apply() 方法，而 apply() 方法就接收 inputs 这个参数，返回计算结果，运行结果如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">Tensor</span><span class="params">(<span class="string">"dense/Relu:0"</span>, shape=(?, <span class="number">16</span>)</span></span>, dtype=float32)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>因此我们可以发现，这些类在初始化的时候实际上是比其对应的方法少了 inputs 参数，其他的参数都是完全一致的，另外需要调用 apply() 方法才可以应用该层并将其构建到模型中。 所以其他的类的用法在此就不一一赘述了，初始化的参数可以类比其对应的方法，实例化类之后，调用 apply() 方法，可以达到同样的构建模型的效果。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>以上便是 TensorFlow layers 模块的详细用法说明，更加详细的用法可以参考官方文档：<a href="https://www.tensorflow.org/api_docs/python/tf/layers" target="_blank" rel="noopener">https://www.tensorflow.org/api_docs/python/tf/layers</a>。 本节代码地址：<a href="https://github.com/AIDeepLearning/TensorFlowLayers" target="_blank" rel="noopener">https://github.com/AIDeepLearning/TensorFlowLayers</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-02-23 03:42:58" itemprop="dateCreated datePublished" datetime="2018-02-23T03:42:58+08:00">2018-02-23</time>
                </span>
                <span id="/5715.html" class="post-meta-item leancloud_visitors" data-flag-title="TensorFlow layers模块用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>13k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>12 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5709.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5709.html" class="post-title-link" itemprop="url">TensorFlow验证码识别</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节我们来用 TensorFlow 来实现一个深度学习模型，用来实现验证码识别的过程，这里我们识别的验证码是图形验证码，首先我们会用标注好的数据来训练一个模型，然后再用模型来实现这个验证码的识别。</p>
                  <h2 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h2>
                  <p>首先我们来看下验证码是怎样的，这里我们使用 Python 的 captcha 库来生成即可，这个库默认是没有安装的，所以这里我们需要先安装这个库，另外我们还需要安装 pillow 库，使用 pip3 即可：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> captcha pillow</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装好之后，我们就可以用如下代码来生成一个简单的图形验证码了：</p>
                  <figure class="highlight sqf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> captcha.<span class="built_in">image</span> import ImageCaptcha</span><br><span class="line"><span class="keyword">from</span> PIL import <span class="built_in">Image</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">text</span> = <span class="string">'1234'</span></span><br><span class="line"><span class="built_in">image</span> = ImageCaptcha()</span><br><span class="line">captcha = <span class="built_in">image</span>.generate(<span class="built_in">text</span>)</span><br><span class="line">captcha_image = <span class="built_in">Image</span>.open(captcha)</span><br><span class="line">captcha_image.show()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行之后便会弹出一张图片，结果如下： <img src="https://germey.gitbooks.io/ai/content/assets/2018-02-20-23-03-18.jpg" alt=""> 可以看到图中的文字正是我们所定义的 text 内容，这样我们就可以得到一张图片和其对应的真实文本，这样我们就可以用它来生成一批训练数据和测试数据了。</p>
                  <h2 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h2>
                  <p>在训练之前肯定是要进行数据预处理了，现在我们首先定义好了要生成的验证码文本内容，这就相当于已经有了 label 了，然后我们再用它来生成验证码，就可以得到输入数据 x 了，在这里我们首先定义好我们的输入词表，由于大小写字母加数字的词表比较庞大，设想我们用含有大小写字母和数字的验证码，一个验证码四个字符，那么一共可能的组合是 (26 + 26 + 10) ^ 4 = 14776336 种组合，这个数量训练起来有点大，所以这里我们精简一下，只使用纯数字的验证码来训练，这样其组合个数就变为 10 ^ 4 = 10000 种，显然少了很多。 所以在这里我们先定义一个词表和其长度变量：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">VOCAB</span> = [<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>]</span><br><span class="line"><span class="attr">CAPTCHA_LENGTH</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">VOCAB_LENGTH</span> = len(VOCAB)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 VOCAB 就是词表的内容，即 0 到 9 这 10 个数字，验证码的字符个数即 CAPTCHA_LENGTH 是 4，词表长度是 VOCAB 的长度，即 10。 接下来我们定义一个生成验证码数据的方法，流程类似上文，只不过这里我们将返回的数据转为了 Numpy 形式的数组：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> captcha.image <span class="keyword">import</span> ImageCaptcha</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_captcha</span><span class="params">(captcha_text)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get captcha text and np array</span></span><br><span class="line"><span class="string">    :param captcha_text: source text</span></span><br><span class="line"><span class="string">    :return: captcha image and array</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    image = ImageCaptcha()</span><br><span class="line">    captcha = image.generate(captcha_text)</span><br><span class="line">    captcha_image = Image.open(captcha)</span><br><span class="line">    captcha_array = np.array(captcha_image)</span><br><span class="line">    <span class="keyword">return</span> captcha_array</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样调用此方法，我们就可以得到一个 Numpy 数组了，这个其实是把验证码转化成了每个像素的 RGB，我们调用一下这个方法试试：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">captcha = generate_captcha(<span class="string">'1234'</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(captcha, captcha.shape)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>内容如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[[<span class="number">239</span> <span class="number">244</span> <span class="number">244</span>]</span><br><span class="line">  [<span class="number">239</span> <span class="number">244</span> <span class="number">244</span>]</span><br><span class="line">  [<span class="number">239</span> <span class="number">244</span> <span class="number">244</span>]</span><br><span class="line">  ..., </span><br><span class="line">  ..., </span><br><span class="line">  [<span class="number">239</span> <span class="number">244</span> <span class="number">244</span>]</span><br><span class="line">  [<span class="number">239</span> <span class="number">244</span> <span class="number">244</span>]</span><br><span class="line">  [<span class="number">239</span> <span class="number">244</span> <span class="number">244</span>]]] </span><br><span class="line">(<span class="number">60</span>, <span class="number">160</span>, <span class="number">3</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到它的 shape 是 (60, 160, 3)，这其实代表验证码图片的高度是 60，宽度是 160，是 60 x 160 像素的验证码，每个像素都有 RGB 值，所以最后一维即为像素的 RGB 值。 接下来我们需要定义 label，由于我们需要使用深度学习模型进行训练，所以这里我们的 label 数据最好使用 One-Hot 编码，即如果验证码文本是 1234，那么应该词表索引位置置 1，总共的长度是 40，我们用程序实现一下 One-Hot 编码和文本的互相转换：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text2vec</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    text to one-hot vector</span></span><br><span class="line"><span class="string">    :param text: source text</span></span><br><span class="line"><span class="string">    :return: np array</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> len(text) &gt; CAPTCHA_LENGTH:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    vector = np.zeros(CAPTCHA_LENGTH * VOCAB_LENGTH)</span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> enumerate(text):</span><br><span class="line">        index = i * VOCAB_LENGTH + VOCAB.index(c)</span><br><span class="line">        vector[index] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> vector</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vec2text</span><span class="params">(vector)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    vector to captcha text</span></span><br><span class="line"><span class="string">    :param vector: np array</span></span><br><span class="line"><span class="string">    :return: text</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(vector, np.ndarray):</span><br><span class="line">        vector = np.asarray(vector)</span><br><span class="line">    vector = np.reshape(vector, [CAPTCHA_LENGTH, <span class="number">-1</span>])</span><br><span class="line">    text = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> vector:</span><br><span class="line">        text += VOCAB[np.argmax(item)]</span><br><span class="line">    <span class="keyword">return</span> text</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 text2vec() 方法就是将真实文本转化为 One-Hot 编码，vec2text() 方法就是将 One-Hot 编码转回真实文本。 例如这里调用一下这两个方法，我们将 1234 文本转换为 One-Hot 编码，然后在将其转回来：</p>
                  <figure class="highlight mel">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">vector</span> = text2vec(<span class="string">'1234'</span>)</span><br><span class="line"><span class="keyword">text</span> = vec2text(<span class="keyword">vector</span>)</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">vector</span>, <span class="keyword">text</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[ <span class="number">0.</span>  <span class="number">1.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">1.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span></span><br><span class="line">  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">1.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">1.</span>  <span class="number">0.</span></span><br><span class="line">  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>  <span class="number">0.</span>]</span><br><span class="line"><span class="number">1234</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就可以实现文本到 One-Hot 编码的互转了。 接下来我们就可以构造一批数据了，x 数据就是验证码的 Numpy 数组，y 数据就是验证码的文本的 One-Hot 编码，生成内容如下：</p>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> <span class="built_in">random</span></span><br><span class="line">from os.path <span class="keyword">import</span> <span class="built_in">join</span>, exists</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> numpy as np</span><br><span class="line">from os <span class="keyword">import</span> makedirs</span><br><span class="line"></span><br><span class="line">DATA_LENGTH = <span class="number">10000</span></span><br><span class="line">DATA_PATH = <span class="string">'data'</span></span><br><span class="line"></span><br><span class="line">def get_random_text():</span><br><span class="line">    <span class="built_in">text</span> = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i in range(CAPTCHA_LENGTH):</span><br><span class="line">        <span class="built_in">text</span> += <span class="built_in">random</span>.choice(VOCAB)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">text</span></span><br><span class="line"></span><br><span class="line">def generate_data():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Generating Data...'</span>)</span><br><span class="line">    data_x, data_y = [], []</span><br><span class="line"></span><br><span class="line">    # generate data x and y</span><br><span class="line">    <span class="keyword">for</span> i in range(DATA_LENGTH):</span><br><span class="line">        <span class="built_in">text</span> = get_random_text()</span><br><span class="line">        # <span class="built_in">get</span> captcha array</span><br><span class="line">        captcha_array = generate_captcha(<span class="built_in">text</span>)</span><br><span class="line">        # <span class="built_in">get</span> vector</span><br><span class="line">        vector = text2vec(<span class="built_in">text</span>)</span><br><span class="line">        data_x.<span class="built_in">append</span>(captcha_array)</span><br><span class="line">        data_y.<span class="built_in">append</span>(vector)</span><br><span class="line"></span><br><span class="line">    # write data to pickle</span><br><span class="line">    <span class="keyword">if</span> not exists(DATA_PATH):</span><br><span class="line">        makedirs(DATA_PATH)</span><br><span class="line"></span><br><span class="line">    x = np.asarray(data_x, np.float32)</span><br><span class="line">    y = np.asarray(data_y, np.float32)</span><br><span class="line">    with <span class="built_in">open</span>(<span class="built_in">join</span>(DATA_PATH, <span class="string">'data.pkl'</span>), <span class="string">'wb'</span>) as f:</span><br><span class="line">        pickle.dump(x, f)</span><br><span class="line">        pickle.dump(y, f)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们定义了一个 get_random_text() 方法，可以随机生成验证码文本，然后接下来再利用这个随机生成的文本来产生对应的 x、y 数据，然后我们再将数据写入到 pickle 文件里，这样就完成了预处理的操作。</p>
                  <h2 id="构建模型"><a href="#构建模型" class="headerlink" title="构建模型"></a>构建模型</h2>
                  <p>有了数据之后，我们就开始构建模型吧，这里我们还是利用 train_test_split() 方法将数据分为三部分，训练集、开发集、验证集：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">with</span> <span class="keyword">open</span>('data.pkl', 'rb') <span class="keyword">as</span> f:</span><br><span class="line">    data_x = pickle.load(f)</span><br><span class="line">    data_y = pickle.load(f)</span><br><span class="line">    return standardize(data_x), data_y</span><br><span class="line"></span><br><span class="line">train_x, test_x, train_y, test_y = train<span class="constructor">_test_split(<span class="params">data_x</span>, <span class="params">data_y</span>, <span class="params">test_size</span>=0.4, <span class="params">random_state</span>=40)</span></span><br><span class="line">dev_x, test_x, dev_y, test_y, = train<span class="constructor">_test_split(<span class="params">test_x</span>, <span class="params">test_y</span>, <span class="params">test_size</span>=0.5, <span class="params">random_state</span>=40)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来我们使用者三个数据集构建三个 Dataset 对象：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># train <span class="keyword">and</span> dev dataset</span><br><span class="line">train_dataset = tf.data.<span class="module-access"><span class="module"><span class="identifier">Dataset</span>.</span></span>from<span class="constructor">_tensor_slices((<span class="params">train_x</span>, <span class="params">train_y</span>)</span>).shuffle(<span class="number">10000</span>)</span><br><span class="line">train_dataset = train_dataset.batch(<span class="module-access"><span class="module"><span class="identifier">FLAGS</span>.</span></span>train_batch_size)</span><br><span class="line"></span><br><span class="line">dev_dataset = tf.data.<span class="module-access"><span class="module"><span class="identifier">Dataset</span>.</span></span>from<span class="constructor">_tensor_slices((<span class="params">dev_x</span>, <span class="params">dev_y</span>)</span>)</span><br><span class="line">dev_dataset = dev_dataset.batch(<span class="module-access"><span class="module"><span class="identifier">FLAGS</span>.</span></span>dev_batch_size)</span><br><span class="line"></span><br><span class="line">test_dataset = tf.data.<span class="module-access"><span class="module"><span class="identifier">Dataset</span>.</span></span>from<span class="constructor">_tensor_slices((<span class="params">test_x</span>, <span class="params">test_y</span>)</span>)</span><br><span class="line">test_dataset = test_dataset.batch(<span class="module-access"><span class="module"><span class="identifier">FLAGS</span>.</span></span>test_batch_size)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后初始化一个迭代器，并绑定到这个数据集上：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># a reinitializable iterator</span><br><span class="line">iterator = tf.data.<span class="module-access"><span class="module"><span class="identifier">Iterator</span>.</span></span>from<span class="constructor">_structure(<span class="params">train_dataset</span>.<span class="params">output_types</span>, <span class="params">train_dataset</span>.<span class="params">output_shapes</span>)</span></span><br><span class="line">train_initializer = iterator.make<span class="constructor">_initializer(<span class="params">train_dataset</span>)</span></span><br><span class="line">dev_initializer = iterator.make<span class="constructor">_initializer(<span class="params">dev_dataset</span>)</span></span><br><span class="line">test_initializer = iterator.make<span class="constructor">_initializer(<span class="params">test_dataset</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来就是关键的部分了，在这里我们使用三层卷积和两层全连接网络进行构造，在这里为了简化写法，直接使用 TensorFlow 的 layers 模块：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># input Layer</span></span><br><span class="line">with tf.variable_scope(<span class="string">'inputs'</span>):</span><br><span class="line">    # x.shape = [-1, 60, 160, 3]</span><br><span class="line">    x, y_label = iterator.get_next()</span><br><span class="line">keep_prob = tf.placeholder(tf.float32, [])</span><br><span class="line">y = tf.cast(x, tf.float32)</span><br><span class="line"><span class="comment"># 3 CNN layers</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(3):</span><br><span class="line">    y = tf.layers.conv2d(y, <span class="attribute">filters</span>=32, <span class="attribute">kernel_size</span>=3, <span class="attribute">padding</span>=<span class="string">'same'</span>, <span class="attribute">activation</span>=tf.nn.relu)</span><br><span class="line">    y = tf.layers.max_pooling2d(y, <span class="attribute">pool_size</span>=2, <span class="attribute">strides</span>=2, <span class="attribute">padding</span>=<span class="string">'same'</span>)</span><br><span class="line">    # y = tf.layers.dropout(y, <span class="attribute">rate</span>=keep_prob)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 dense layers</span></span><br><span class="line">y = tf.layers.flatten(y)</span><br><span class="line">y = tf.layers.dense(y, 1024, <span class="attribute">activation</span>=tf.nn.relu)</span><br><span class="line">y = tf.layers.dropout(y, <span class="attribute">rate</span>=keep_prob)</span><br><span class="line">y = tf.layers.dense(y, VOCAB_LENGTH)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里卷积核大小为 3，padding 使用 SAME 模式，激活函数使用 relu。 经过全连接网络变换之后，y 的 shape 就变成了 [batch_size, n_classes]，我们的 label 是 CAPTCHA_LENGTH 个 One-Hot 向量拼合而成的，在这里我们想使用交叉熵来计算，但是交叉熵计算的时候，label 参数向量最后一维各个元素之和必须为 1，不然计算梯度的时候会出现问题。详情参见 TensorFlow 的官方文档：<a href="https://www.tensorflow.org/api_docs/python/tf/nn/softmax_cross_entropy_with_logits" target="_blank" rel="noopener">https://www.tensorflow.org/api_docs/python/tf/nn/softmax_cross_entropy_with_logits</a>：</p>
                  <blockquote>
                    <p>NOTE: While the classes are mutually exclusive, their probabilities need not be. All that is required is that each row of labels is a valid probability distribution. If they are not, the computation of the gradient will be incorrect.</p>
                  </blockquote>
                  <p>但是现在的 label 参数是 CAPTCHA_LENGTH 个 One-Hot 向量拼合而成，所以这里各个元素之和为 CAPTCHA_LENGTH，所以我们需要重新 reshape 一下，确保最后一维各个元素之和为 1：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">y_reshape</span> = tf.reshape(y, [-<span class="number">1</span>, VOCAB_LENGTH])</span><br><span class="line"><span class="attr">y_label_reshape</span> = tf.reshape(y_label, [-<span class="number">1</span>, VOCAB_LENGTH])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就可以确保最后一维是 VOCAB_LENGTH 长度，而它就是一个 One-Hot 向量，所以各元素之和必定为 1。 然后 Loss 和 Accuracy 就好计算了：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># loss</span><br><span class="line">cross_entropy = tf.reduce<span class="constructor">_sum(<span class="params">tf</span>.<span class="params">nn</span>.<span class="params">softmax_cross_entropy_with_logits</span>(<span class="params">logits</span>=<span class="params">y_reshape</span>, <span class="params">labels</span>=<span class="params">y_label_reshape</span>)</span>)</span><br><span class="line"># accuracy</span><br><span class="line">max_index_predict = tf.argmax(y_reshape, axis=-<span class="number">1</span>)</span><br><span class="line">max_index_label = tf.argmax(y_label_reshape, axis=-<span class="number">1</span>)</span><br><span class="line">correct_predict = tf.equal(max_index_predict, max_index_label)</span><br><span class="line">accuracy = tf.reduce<span class="constructor">_mean(<span class="params">tf</span>.<span class="params">cast</span>(<span class="params">correct_predict</span>, <span class="params">tf</span>.<span class="params">float32</span>)</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>再接下来执行训练即可：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># train</span></span><br><span class="line">train_op = tf.train.RMSPropOptimizer(FLAGS.learning_rate).minimize(cross_entropy, <span class="attribute">global_step</span>=global_step)</span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> range(FLAGS.epoch_num):</span><br><span class="line">    tf.train.global_step(sess, <span class="attribute">global_step_tensor</span>=global_step)</span><br><span class="line">    # train</span><br><span class="line">    sess.<span class="builtin-name">run</span>(train_initializer)</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">step</span> <span class="keyword">in</span> range(int(train_steps)):</span><br><span class="line">        loss, acc, gstep, _ = sess.<span class="builtin-name">run</span>([cross_entropy, accuracy, global_step, train_op],</span><br><span class="line">                                       feed_dict=&#123;keep_prob: FLAGS.keep_prob&#125;)</span><br><span class="line">        # <span class="builtin-name">print</span> log</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">step</span> % FLAGS.steps_per_print == 0:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'Global Step'</span>, gstep, <span class="string">'Step'</span>, <span class="keyword">step</span>, <span class="string">'Train Loss'</span>, loss, <span class="string">'Accuracy'</span>, acc)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> epoch % FLAGS.epochs_per_dev == 0:</span><br><span class="line">        # dev</span><br><span class="line">        sess.<span class="builtin-name">run</span>(dev_initializer)</span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">step</span> <span class="keyword">in</span> range(int(dev_steps)):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">step</span> % FLAGS.steps_per_print == 0:</span><br><span class="line">                <span class="builtin-name">print</span>(<span class="string">'Dev Accuracy'</span>, sess.<span class="builtin-name">run</span>(accuracy, feed_dict=&#123;keep_prob: 1&#125;), <span class="string">'Step'</span>, <span class="keyword">step</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们首先初始化 train_initializer，将 iterator 绑定到 Train Dataset 上，然后执行 train_op，获得 loss、acc、gstep 等结果并输出。</p>
                  <h2 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h2>
                  <p>运行训练过程，结果类似如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">...</span><br><span class="line">Dev Accuracy <span class="number">0.9580078</span> Step <span class="number">0</span></span><br><span class="line">Dev Accuracy <span class="number">0.9472656</span> Step <span class="number">2</span></span><br><span class="line">Dev Accuracy <span class="number">0.9501953</span> Step <span class="number">4</span></span><br><span class="line">Dev Accuracy <span class="number">0.9658203</span> Step <span class="number">6</span></span><br><span class="line">Global Step <span class="number">3243</span> Step <span class="number">0</span> Train Loss <span class="number">1.1920928e-06</span> Accuracy <span class="number">1.0</span></span><br><span class="line">Global Step <span class="number">3245</span> Step <span class="number">2</span> Train Loss <span class="number">1.5497207e-06</span> Accuracy <span class="number">1.0</span></span><br><span class="line">Global Step <span class="number">3247</span> Step <span class="number">4</span> Train Loss <span class="number">1.1920928e-06</span> Accuracy <span class="number">1.0</span></span><br><span class="line">Global Step <span class="number">3249</span> Step <span class="number">6</span> Train Loss <span class="number">1.7881392e-06</span> Accuracy <span class="number">1.0</span></span><br><span class="line">...</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>验证集准确率 95% 以上。</p>
                  <h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2>
                  <p>训练过程我们还可以每隔几个 Epoch 保存一下模型：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># save model</span><br><span class="line"><span class="keyword">if</span> epoch % <span class="module-access"><span class="module"><span class="identifier">FLAGS</span>.</span></span>epochs_per_save<span class="operator"> == </span><span class="number">0</span>:</span><br><span class="line">    saver.save(sess, <span class="module-access"><span class="module"><span class="identifier">FLAGS</span>.</span></span>checkpoint_dir, global_step=gstep)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>当然也可以取验证集上准确率最高的模型进行保存。 验证时我们可以重新 Reload 一下模型，然后进行验证：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># load model</span></span><br><span class="line">ckpt = tf.train.get_checkpoint_state(<span class="string">'ckpt'</span>)</span><br><span class="line"><span class="keyword">if</span> ckpt:</span><br><span class="line">    saver.restore(sess, ckpt.model_checkpoint_path)</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'Restore from'</span>, ckpt.model_checkpoint_path)</span><br><span class="line">    sess.<span class="builtin-name">run</span>(test_initializer)</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">step</span> <span class="keyword">in</span> range(int(test_steps)):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">step</span> % FLAGS.steps_per_print == 0:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'Test Accuracy'</span>, sess.<span class="builtin-name">run</span>(accuracy, feed_dict=&#123;keep_prob: 1&#125;), <span class="string">'Step'</span>, <span class="keyword">step</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'No Model Found'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>验证之后其准确率基本是差不多的。 如果要进行新的 Inference 的话，可以替换下 test_x 即可。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>以上便是使用 TensorFlow 进行验证码识别的过程，代码见：<a href="https://github.com/AIDeepLearning/CrackCaptcha" target="_blank" rel="noopener">https://github.com/AIDeepLearning/CrackCaptcha</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-02-21 15:05:35" itemprop="dateCreated datePublished" datetime="2018-02-21T15:05:35+08:00">2018-02-21</time>
                </span>
                <span id="/5709.html" class="post-meta-item leancloud_visitors" data-flag-title="TensorFlow验证码识别" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>8.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5696.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5696.html" class="post-title-link" itemprop="url">利用python库twilio来免费发送短信</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="大家好，我是四毛，最近开通了个人公众号“用Python来编程”，欢迎大家“关注”，这样您就可以收到优质的文章了。"><a href="#大家好，我是四毛，最近开通了个人公众号“用Python来编程”，欢迎大家“关注”，这样您就可以收到优质的文章了。" class="headerlink" title="大家好，我是四毛，最近开通了个人公众号“用Python来编程”，欢迎大家“关注”，这样您就可以收到优质的文章了。"></a>大家好，我是四毛，最近开通了个人公众号<strong>“用Python来编程”</strong>，欢迎大家“<strong>关注”</strong>，这样您就可以收到优质的文章了。</h2>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/201802111155445124jhQyer.yasuotu.gif" alt=""></p>
                  <pre><code>         今天跟大家分享的主题是利用python库twilio来免费发送短信。

         先放一张成品图
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/webwxgetmsgimg-10-180x320.png" alt=""></p>
                  <pre><code>    代码放在了本文最后的地址中，欢迎有需要的自取，有任何也可以在评论或者后台直接私聊我。
</code></pre>
                  <p><strong>正文</strong></p>
                  <pre><code>    眼尖的小伙伴已经发现了上面的短信的前缀显示这个短信来自于一个叫Twilio的免费的账户，今天我们用到的库就是twilio，既然是免费的账户，那么肯定是有一些限制的，这个会在后面提到。
</code></pre>
                  <p>另外要注意的是这个网站从国内访问的时候，可能会因为一些你懂得原因没法访问，那就只好学习一下怎么科学上网了。</p>
                  <p><strong>1.Twilio</strong></p>
                  <pre><code>    Twilio是一个做成开放插件的电话跟踪服务（call-tracking service）。美国当地时间2016年6月23日，云通讯公司Twilio在纽约证券交易所上市（来自于百度百科）
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_064-320x237.png" alt=""></p>
                  <p><strong>2. 安装</strong></p>
                  <pre><code>    官方文档地址：https://www.twilio.com/docs/libraries/python

    同时官方还提供对以下语言的支持
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_071.png" alt=""></p>
                  <pre><code>    可以看到，还是很丰富的。

    最简单的方式就是通过pip，执行如下命令：
</code></pre>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip <span class="keyword">install</span> twilio</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><strong>3.注册账号</strong></p>
                  <pre><code>    安装好库以后，就需要到官方的网页上进行注册了。

    进入官网：https://www.twilio.com
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_065.png" alt=""></p>
                  <pre><code>    然后进入注册页面
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_066.png" alt=""></p>
                  <pre><code>    接着通过了人机认证以后，就会对你的手机号码进行认证，这个就不发图片了。
</code></pre>
                  <p><strong>4.</strong> <strong>进入console</strong></p>
                  <pre><code>    注册好了以后，就可以进入我们自己的面板了
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_067.png" alt=""></p>
                  <pre><code>    图中箭头所指的两个参数是我们代码中需要的， 可以把两个都复制一下；

    既然是发短信，那么肯定是有一个接收者和一个发送者，发送者的号码可不是我们自己刚刚填的号码，而且twilio给我们分配的一个号码，因为我也是前段时间搞好了，所以不太记得这个号码是不是一开始进去就有的了，如果没有的话，那么就点击Get Stared。

    现在我们点击Manage Numbers
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_068.png" alt=""></p>
                  <pre><code>    这个时候就可以看到我们的号码了，这是重点，记下来
</code></pre>
                  <p><strong>5. 写代码</strong></p>
                  <pre><code>    根据文档的内容，我们编写了下面的代码：
</code></pre>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : ShiMeng</span></span><br><span class="line"><span class="comment"># @File    : send_sms.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"><span class="keyword">from</span> twilio.rest import Client</span><br><span class="line"><span class="comment"># Your Account SID from twilio.com/console</span></span><br><span class="line">account_sid = <span class="string">"your account sid"</span></span><br><span class="line"><span class="comment"># Your Auth Token from twilio.com/console</span></span><br><span class="line">auth_token  = <span class="string">"your token"</span></span><br><span class="line">client = Client(account_sid, auth_token)</span><br><span class="line">message = client.messages.create(</span><br><span class="line"><span class="comment"># 这里中国的号码前面需要加86</span></span><br><span class="line"><span class="attribute">to</span>=<span class="string">"+接收者的号码"</span>,</span><br><span class="line"><span class="attribute">from_</span>=<span class="string">"+twilio给你的号码 "</span>,</span><br><span class="line"><span class="attribute">body</span>=<span class="string">"Hello from Python!"</span>)</span><br><span class="line"><span class="builtin-name">print</span>(message.sid)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <pre><code>    然后执行程序，你应该会碰到下面的错误
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_069.png" alt=""></p>
                  <pre><code>    可以从报错信息中明显的看到，提示我们说这个号码没有验证，我们可以到验证的网址上验证一下，也可以购买一个高级别的账号来给未验证的号码发送信息。

    而这个就是我一开始提到的免费账号的限制，在这个限制下面如果你想发送信息给一个接收者，这个接收者的号码必须通过验证，语音验证或者短信验证都可以。如果你是想大批量的发那种垃圾信息，那么你不用往下面看了。下面我们就来对号码进行验证。
</code></pre>
                  <p><strong>6. 验证号码</strong></p>
                  <pre><code>    验证网址：https://www.twilio.com/console/phone-numbers/verified
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_070.png" alt=""></p>
                  <p><strong>7.重新执行代码</strong></p>
                  <pre><code>    这个时候重新执行我们的代码，没有报错的话，接收者就应该收到你的消息了，就像我一开始放的成品图一样。
</code></pre>
                  <p>但是，在我们发送的信息前面，有一段前缀，我查了一下官方的文档，说这个免费的账户，这个前缀是去不掉的。。。。。。</p>
                  <p><strong>8.查看用量</strong></p>
                  <pre><code>    在面板中，点击Usage即可看到我们的用量， 如下图所示
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_073.png" alt=""></p>
                  <pre><code>    可以看到我们的用量以及花费，这个花费是不需要我们真正的付钱的，官方的解释是：
</code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/Selection_072.png" alt=""></p>
                  <p><strong>9.打电话</strong></p>
                  <pre><code>    打电话的代码也很简单
</code></pre>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># Download the Python helper library from twilio.com/docs/python/install</span></span><br><span class="line"><span class="keyword">from</span> twilio.rest import Client</span><br><span class="line"><span class="comment"># Your Account Sid and Auth Token from twilio.com/user/account</span></span><br><span class="line">account_sid = <span class="string">"AC8a9ba33072b6a05f2b81126e3e6609b7"</span></span><br><span class="line">auth_token = <span class="string">"f0150d603c1886d93b9d45ff15d84f24"</span></span><br><span class="line">client = Client(account_sid, auth_token)</span><br><span class="line">call = client.calls.create(</span><br><span class="line"><span class="attribute">to</span>=<span class="string">"+接收者号码"</span>,</span><br><span class="line"><span class="attribute">from_</span>=<span class="string">"+你的twilio号码"</span>,</span><br><span class="line"><span class="attribute">url</span>=<span class="string">"http://demo.twilio.com/docs/voice.xml"</span>,</span><br><span class="line"><span class="attribute">method</span>=<span class="string">"GET"</span>,</span><br><span class="line"><span class="attribute">status_callback</span>=<span class="string">"https://www.myapp.com/events"</span>,</span><br><span class="line"><span class="attribute">status_callback_method</span>=<span class="string">"POST"</span>,</span><br><span class="line">status_callback_event=[<span class="string">"initiated"</span>, <span class="string">"ringing"</span>, <span class="string">"answered"</span>, <span class="string">"completed"</span>]</span><br><span class="line">)</span><br><span class="line"><span class="builtin-name">print</span>(call.sid)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <pre><code>    执行程序后，电话也可以接通，但是里面的人会提示你升级账号。。。。。
</code></pre>
                  <p><strong>总结</strong></p>
                  <pre><code>    好了，到这里我们就可以免费的发送短信了。

    通过这个库，我们可以：

    （1）对线上或者线下后台跑的程序进行监控，并及时发送短信报警

    （2）结合树莓派玩一下，可以实现对超多场景的监测

    代码被放在了这里：https://github.com/xiaosimao/wx_code/tree/master/send_sms
</code></pre>
                  <p> <strong>有问题的可以在评论中指出，或者直接在后台发消息给我。</strong></p>
                  <p> <strong>欢迎大家关注我。</strong></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/四毛" class="author" itemprop="url" rel="index">四毛</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-02-12 16:25:53" itemprop="dateCreated datePublished" datetime="2018-02-12T16:25:53+08:00">2018-02-12</time>
                </span>
                <span id="/5696.html" class="post-meta-item leancloud_visitors" data-flag-title="利用python库twilio来免费发送短信" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5678.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5678.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 后续章节</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本书此部分内容属进阶内容，暂不开放。 如需查看更多可以购买书籍查看。 购买地址： <a href="https://item.jd.com/26114674847.html" target="_blank" rel="noopener">https://item.jd.com/26114674847.html</a> <a href="https://item.jd.com/26124473455.html" target="_blank" rel="noopener">https://item.jd.com/26124473455.html</a> 本书由图灵教育-人民邮电出版社出版发行。 作者：崔庆才 视频学习资源：</p>
                  <ul>
                    <li><a href="https://edu.hellobi.com/course/157" target="_blank" rel="noopener">自己动手，丰衣足食！Python3网络爬虫实战案例</a></li>
                    <li><a href="https://edu.hellobi.com/course/156" target="_blank" rel="noopener">Python3爬虫三大案例实战分享</a></li>
                  </ul>
                  <p>全书预览图： <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/01/Python-3%E7%BD%91%E6%A0%BC%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E7%AB%8B%E4%BD%93%E5%9B%BE-857x1100.jpg" alt=""></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-02-07 11:34:30" itemprop="dateCreated datePublished" datetime="2018-02-07T11:34:30+08:00">2018-02-07</time>
                </span>
                <span id="/5678.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 后续章节" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>191</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5657.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5657.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 7.4-使用Selenium爬取淘宝商品</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在前一章中，我们已经成功尝试分析Ajax来抓取相关数据，但是并不是所有页面都可以通过分析Ajax来完成抓取。比如，淘宝，它的整个页面数据确实也是通过Ajax获取的，但是这些Ajax接口参数比较复杂，可能会包含加密密钥等，所以如果想自己构造Ajax参数，还是比较困难的。对于这种页面，最方便快捷的抓取方法就是通过Selenium。本节中，我们就用Selenium来模拟浏览器操作，抓取淘宝的商品信息，并将结果保存到MongoDB。</p>
                  <h2 id="1-本节目标"><a href="#1-本节目标" class="headerlink" title="1. 本节目标"></a>1. 本节目标</h2>
                  <p>本节中，我们要利用Selenium抓取淘宝商品并用pyquery解析得到商品的图片、名称、价格、购买人数、店铺名称和店铺所在地信息，并将其保存到MongoDB。</p>
                  <h2 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h2>
                  <p>本节中，我们首先以Chrome为例来讲解Selenium的用法。在开始之前，请确保已经正确安装好Chrome浏览器并配置好了ChromeDriver；另外，还需要正确安装Python的Selenium库；最后，还对接了PhantomJS和Firefox，请确保安装好PhantomJS和Firefox并配置好了GeckoDriver。如果环境没有配置好，可参考第1章。</p>
                  <h2 id="3-接口分析"><a href="#3-接口分析" class="headerlink" title="3. 接口分析"></a>3. 接口分析</h2>
                  <p>首先，我们来看下淘宝的接口，看看它比一般Ajax多了怎样的内容。</p>
                  <p>打开淘宝页面，搜索商品，比如iPad，此时打开开发者工具，截获Ajax请求，我们可以发现获取商品列表的接口，如图7-19所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-19.png" alt="">图7-19 列表接口</p>
                  <p>它的链接包含了几个GET参数，如果要想构造Ajax链接，直接请求再好不过了，它的返回内容是JSON格式，如图7-20所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-20.jpg" alt="">图7-20 JSON数据</p>
                  <p>但是这个Ajax接口包含几个参数，其中<code>_ksTS</code>、<code>rn</code>参数不能直接发现其规律，如果要去探寻它的生成规律，也不是做不到，但这样相对会比较烦琐，所以如果直接用Selenium来模拟浏览器的话，就不需要再关注这些接口参数了，只要在浏览器里面可以看到的，都可以爬取。这也是我们选用Selenium爬取淘宝的原因。</p>
                  <h2 id="4-页面分析"><a href="#4-页面分析" class="headerlink" title="4. 页面分析"></a>4. 页面分析</h2>
                  <p>本节的目标是爬取商品信息。图7-21是一个商品条目，其中包含商品的基本信息，包括商品图片、名称、价格、购买人数、店铺名称和店铺所在地，我们要做的就是将这些信息都抓取下来。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-21.jpg" alt="">图7-21 商品条目</p>
                  <p>抓取入口就是淘宝的搜索页面，这个链接可以通过直接构造参数访问。例如，如果搜索iPad，就可以直接访问<a href="https://s.taobao.com/search?q=iPad" target="_blank" rel="noopener">https://s.taobao.com/search?q=iPad</a>，呈现的就是第一页的搜索结果，如图7-22所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-22.png" alt="">图7-22 搜索结果</p>
                  <p>在页面下方，有一个分页导航，其中既包括前5页的链接，也包括下一页的链接，同时还有一个输入任意页码跳转的链接，如图7-23所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-23-1.jpg" alt="">图7-23 分页导航</p>
                  <p>这里商品的搜索结果一般最大都为100页，要获取每一页的内容，只需要将页码从1到100顺序遍历即可，页码数是确定的。所以，直接在页面跳转文本框中输入要跳转的页码，然后点击“确定”按钮即可跳转到页码对应的页面。</p>
                  <p>这里不直接点击“下一页”的原因是：一旦爬取过程中出现异常退出，比如到50页退出了，此时点击“下一页”时，就无法快速切换到对应的后续页面了。此外，在爬取过程中，也需要记录当前的页码数，而且一旦点击“下一页”之后页面加载失败，还需要做异常检测，检测当前页面是加载到了第几页。整个流程相对比较复杂，所以这里我们直接用跳转的方式来爬取页面。</p>
                  <p>当我们成功加载出某一页商品列表时，利用Selenium即可获取页面源代码，然后再用相应的解析库解析即可。这里我们选用pyquery进行解析。下面我们用代码来实现整个抓取过程。</p>
                  <h2 id="5-获取商品列表"><a href="#5-获取商品列表" class="headerlink" title="5. 获取商品列表"></a>5. 获取商品列表</h2>
                  <p>首先，需要构造一个抓取的URL：<a href="https://s.taobao.com/search?q=iPad" target="_blank" rel="noopener">https://s.taobao.com/search?q=iPad</a>。这个URL非常简洁，参数<code>q</code>就是要搜索的关键字。只要改变这个参数，即可获取不同商品的列表。这里我们将商品的关键字定义成一个变量，然后构造出这样的一个URL。</p>
                  <p>然后，就需要用Selenium进行抓取了。我们实现如下抓取列表页的方法：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line">KEYWORD = <span class="string">'iPad'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span><span class="params">(page)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    抓取索引页</span></span><br><span class="line"><span class="string">    :param page: 页码</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print(<span class="string">'正在爬取第'</span>, page, <span class="string">'页'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = <span class="string">'https://s.taobao.com/search?q='</span> + quote(KEYWORD)</span><br><span class="line">        browser.get(url)</span><br><span class="line">        <span class="keyword">if</span> page &gt; <span class="number">1</span>:</span><br><span class="line">            input = wait.until(</span><br><span class="line">                EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">'#mainsrp-pager div.form &gt; input'</span>)))</span><br><span class="line">            submit = wait.until(</span><br><span class="line">                EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">'#mainsrp-pager div.form &gt; span.btn.J_Submit'</span>)))</span><br><span class="line">            input.clear()</span><br><span class="line">            input.send_keys(page)</span><br><span class="line">            submit.click()</span><br><span class="line">        wait.until(</span><br><span class="line">            EC.text_to_be_present_in_element((By.CSS_SELECTOR, <span class="string">'#mainsrp-pager li.item.active &gt; span'</span>), str(page)))</span><br><span class="line">        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">'.m-itemlist .items .item'</span>)))</span><br><span class="line">        get_products()</span><br><span class="line">    <span class="keyword">except</span> TimeoutException:</span><br><span class="line">        index_page(page)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里首先构造了一个<code>WebDriver</code>对象，使用的浏览器是Chrome，然后指定一个关键词，如iPad，接着定义了<code>index_page()</code>方法，用于抓取商品列表页。</p>
                  <p>在该方法里，我们首先访问了搜索商品的链接，然后判断了当前的页码，如果大于1，就进行跳页操作，否则等待页面加载完成。</p>
                  <p>等待加载时，我们使用了<code>WebDriverWait</code>对象，它可以指定等待条件，同时指定一个最长等待时间，这里指定为最长10秒。如果在这个时间内成功匹配了等待条件，也就是说页面元素成功加载出来了，就立即返回相应结果并继续向下执行，否则到了最大等待时间还没有加载出来时，就直接抛出超时异常。</p>
                  <p>比如，我们最终要等待商品信息加载出来，就指定了<code>presence_of_element_located</code>这个条件，然后传入了<code>.m-itemlist .items .item</code>这个选择器，而这个选择器对应的页面内容就是每个商品的信息块，可以到网页里面查看一下。如果加载成功，就会执行后续的<code>get_products()</code>方法，提取商品信息。</p>
                  <p>关于翻页操作，这里首先获取页码输入框，赋值为<code>input</code>，然后获取“确定”按钮，赋值为<code>submit</code>，分别是图7-24中的两个元素。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-24-1.jpg" alt="">图7-24 跳转选项</p>
                  <p>首先，我们清空了输入框，此时调用<code>clear()</code>方法即可。随后，调用<code>send_keys()</code>方法将页码填充到输入框中，然后点击“确定”按钮即可。</p>
                  <p>那么，怎样知道有没有跳转到对应的页码呢？我们可以注意到，成功跳转某一页后，页码都会高亮显示，如图7-25所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-25-1.jpg" alt="">图7-25 页码高亮显示</p>
                  <p>我们只需要判断当前高亮的页码数是当前的页码数即可，所以这里使用了另一个等待条件<code>text_to_be_present_in_element</code>，它会等待指定的文本出现在某一个节点里面时即返回成功。这里我们将高亮的页码节点对应的CSS选择器和当前要跳转的页码通过参数传递给这个等待条件，这样它就会检测当前高亮的页码节点是不是我们传过来的页码数，如果是，就证明页面成功跳转到了这一页，页面跳转成功。</p>
                  <p>这样刚才实现的<code>index_page()</code>方法就可以传入对应的页码，待加载出对应页码的商品列表后，再去调用<code>get_products()</code>方法进行页面解析。</p>
                  <h2 id="6-解析商品列表"><a href="#6-解析商品列表" class="headerlink" title="6. 解析商品列表"></a>6. 解析商品列表</h2>
                  <p>接下来，我们就可以实现<code>get_products()</code>方法来解析商品列表了。这里我们直接获取页面源代码，然后用pyquery进行解析，实现如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> pyquery import PyQuery as pq</span><br><span class="line">def get_products():</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    提取商品数据</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    html = browser.page_source</span><br><span class="line">    doc = pq(html)</span><br><span class="line">    items = doc(<span class="string">'#mainsrp-itemlist .items .item'</span>).items()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        product = &#123;</span><br><span class="line">            <span class="string">'image'</span>: item.<span class="builtin-name">find</span>(<span class="string">'.pic .img'</span>).attr(<span class="string">'data-src'</span>),</span><br><span class="line">            <span class="string">'price'</span>: item.<span class="builtin-name">find</span>(<span class="string">'.price'</span>).text(),</span><br><span class="line">            <span class="string">'deal'</span>: item.<span class="builtin-name">find</span>(<span class="string">'.deal-cnt'</span>).text(),</span><br><span class="line">            <span class="string">'title'</span>: item.<span class="builtin-name">find</span>(<span class="string">'.title'</span>).text(),</span><br><span class="line">            <span class="string">'shop'</span>: item.<span class="builtin-name">find</span>(<span class="string">'.shop'</span>).text(),</span><br><span class="line">            <span class="string">'location'</span>: item.<span class="builtin-name">find</span>(<span class="string">'.location'</span>).text()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="builtin-name">print</span>(product)</span><br><span class="line">        save_to_mongo(product)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先，调用<code>page_source</code>属性获取页码的源代码，然后构造了PyQuery解析对象，接着提取了商品列表，此时使用的CSS选择器是<code>#mainsrp-itemlist .items .item</code>，它会匹配整个页面的每个商品。它的匹配结果是多个，所以这里我们又对它进行了一次遍历，用<code>for</code>循环将每个结果分别进行解析，每次循环把它赋值为<code>item</code>变量，每个<code>item</code>变量都是一个<code>PyQuery</code>对象，然后再调用它的<code>find()</code>方法，传入CSS选择器，就可以获取单个商品的特定内容了。</p>
                  <p>比如，查看一下商品信息的源码，如图7-26所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-26-1.jpg" alt="">图7-26 商品信息源码</p>
                  <p>可以发现，它是一个<code>img</code>节点，包含<code>id</code>、<code>class</code>、<code>data-src</code>、<code>alt</code>和<code>src</code>等属性。这里之所以可以看到这张图片，是因为它的<code>src</code>属性被赋值为图片的URL。把它的<code>src</code>属性提取出来，就可以获取商品的图片了。不过我们还注意<code>data-src</code>属性，它的内容也是图片的URL，观察后发现此URL是图片的完整大图，而<code>src</code>是压缩后的小图，所以这里抓取<code>data-src</code>属性来作为商品的图片。</p>
                  <p>因此，我们需要先利用<code>find()</code>方法找到图片的这个节点，然后再调用<code>attr()</code>方法获取商品的<code>data-src</code>属性，这样就成功提取了商品图片链接。然后用同样的方法提取商品的价格、成交量、名称、店铺和店铺所在地等信息，接着将所有提取结果赋值为一个字典<code>product</code>，随后调用<code>save_to_mongo()</code>将其保存到MongoDB即可。</p>
                  <h2 id="7-保存到MongoDB"><a href="#7-保存到MongoDB" class="headerlink" title="7. 保存到MongoDB"></a>7. 保存到MongoDB</h2>
                  <p>接下来，我们将商品信息保存到MongoDB，实现代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">MONGO_URL = <span class="string">'localhost'</span></span><br><span class="line">MONGO_DB = <span class="string">'taobao'</span></span><br><span class="line">MONGO_COLLECTION = <span class="string">'products'</span></span><br><span class="line">client = pymongo.MongoClient(MONGO_URL)</span><br><span class="line">db = client[MONGO_DB]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span><span class="params">(result)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    保存至MongoDB</span></span><br><span class="line"><span class="string">    :param result: 结果</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> db[MONGO_COLLECTION].insert(result):</span><br><span class="line">            print(<span class="string">'存储到MongoDB成功'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        print(<span class="string">'存储到MongoDB失败'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里首先创建了一个MongoDB的连接对象，然后指定了数据库，随后指定了Collection的名称，接着直接调用<code>insert()</code>方法将数据插入到MongoDB。此处的<code>result</code>变量就是在<code>get_products()</code>方法里传来的<code>product</code>，包含单个商品的信息。</p>
                  <h2 id="8-遍历每页"><a href="#8-遍历每页" class="headerlink" title="8. 遍历每页"></a>8. 遍历每页</h2>
                  <p>刚才我们所定义的<code>get_index()</code>方法需要接收参数<code>page</code>，<code>page</code>代表页码。这里我们实现页码遍历即可，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">MAX_PAGE = <span class="number">100</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    遍历每一页</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, MAX_PAGE + <span class="number">1</span>):</span><br><span class="line">        index_page(i)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其实现非常简单，只需要调用一个<code>for</code>循环即可。这里定义最大的页码数为100，<code>range()</code>方法的返回结果就是1到100的列表，顺序遍历，调用<code>index_page()</code>方法即可。</p>
                  <p>这样我们的淘宝商品爬虫就完成了，最后调用<code>main()</code>方法即可运行。</p>
                  <h2 id="9-运行"><a href="#9-运行" class="headerlink" title="9. 运行"></a>9. 运行</h2>
                  <p>运行代码，可以发现首先会弹出一个Chrome浏览器，然后会访问淘宝页面，接着控制台便会输出相应的提取结果，如图7-27所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-27-1.jpg" alt="">图7-27 运行结果</p>
                  <p>可以发现，这些商品信息的结果都是字典形式，它们被存储到MongoDB里面。</p>
                  <p>再看一下MongoDB中的结果，如图7-28所示。</p>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2018/02/7-28-1.jpg" alt="">图7-28 保存结果</p>
                  <p>可以看到，所有的信息都保存到MongoDB里了，这说明爬取成功。</p>
                  <h2 id="10-Chrome-Headless模式"><a href="#10-Chrome-Headless模式" class="headerlink" title="10. Chrome Headless模式"></a>10. Chrome Headless模式</h2>
                  <p>从Chrome 59版本开始，已经开始支持Headless模式，也就是无界面模式，这样爬取的时候就不会弹出浏览器了。如果要使用此模式，请把Chrome升级到59版本及以上。启用Headless模式的方式如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">chrome_options = webdriver.<span class="constructor">ChromeOptions()</span></span><br><span class="line">chrome_options.add<span class="constructor">_argument('--<span class="params">headless</span>')</span></span><br><span class="line">browser = webdriver.<span class="constructor">Chrome(<span class="params">chrome_options</span>=<span class="params">chrome_options</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先，创建<code>ChromeOptions</code>对象，接着添加<code>headless</code>参数，然后在初始化Chrome对象的时候通过<code>chrome_options</code>传递这个<code>ChromeOptions</code>对象，这样我们就可以成功启用Chrome的Headless模式了。</p>
                  <h2 id="11-对接Firefox"><a href="#11-对接Firefox" class="headerlink" title="11. 对接Firefox"></a>11. 对接Firefox</h2>
                  <p>要对接Firefox浏览器，非常简单，只需要更改一处即可：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">browser</span> = webdriver.Firefox()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里更改了<code>browser</code>对象的创建方式，这样爬取的时候就会使用Firefox浏览器了。</p>
                  <h2 id="12-对接PhantomJS"><a href="#12-对接PhantomJS" class="headerlink" title="12. 对接PhantomJS"></a>12. 对接PhantomJS</h2>
                  <p>如果不想使用Chrome的Headless模式，还可以使用PhantomJS（它是一个无界面浏览器）来抓取。抓取时，同样不会弹出窗口，还是只需要将<code>WebDriver</code>的声明修改一下即可：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">browser</span> = webdriver.PhantomJS()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外，它还支持命令行配置。比如，可以设置缓存和禁用图片加载的功能，进一步提高爬取效率：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">SERVICE_ARGS</span> = [<span class="string">'--load-images=false'</span>, <span class="string">'--disk-cache=true'</span>]</span><br><span class="line"><span class="attr">browser</span> = webdriver.PhantomJS(service_args=SERVICE_ARGS)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后，给出本节的代码地址：<a href="https://github.com/Python3WebSpider/TaobaoProduct" target="_blank" rel="noopener">https://github.com/Python3WebSpider/TaobaoProduct</a>。</p>
                  <p>本节中，我们用Selenium演示了淘宝页面的抓取。利用它，我们不用去分析Ajax请求，真正做到可见即可爬。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-01-31 22:10:36" itemprop="dateCreated datePublished" datetime="2018-01-31T22:10:36+08:00">2018-01-31</time>
                </span>
                <span id="/5657.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 7.4-使用Selenium爬取淘宝商品" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.6k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/5654.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/5654.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 7.3-Splash负载均衡配置</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>用Splash做页面抓取时，如果爬取的量非常大，任务非常多，用一个Splash服务来处理的话，未免压力太大了，此时可以考虑搭建一个负载均衡器来把压力分散到各个服务器上。这相当于多台机器多个服务共同参与任务的处理，可以减小单个Splash服务的压力。</p>
                  <h2 id="1-配置Splash服务"><a href="#1-配置Splash服务" class="headerlink" title="1. 配置Splash服务"></a>1. 配置Splash服务</h2>
                  <p>要搭建Splash负载均衡，首先要有多个Splash服务。假如这里在4台远程主机的8050端口上都开启了Splash服务，它们的服务地址分别为41.159.27.223:8050、41.159.27.221:8050、41.159.27.9:8050和41.159.117.119:8050，这4个服务完全一致，都是通过Docker的Splash镜像开启的。访问其中任何一个服务时，都可以使用Splash服务。</p>
                  <h2 id="2-配置负载均衡"><a href="#2-配置负载均衡" class="headerlink" title="2. 配置负载均衡"></a>2. 配置负载均衡</h2>
                  <p>接下来，可以选用任意一台带有公网IP的主机来配置负载均衡。首先，在这台主机上装好Nginx，然后修改Nginx的配置文件nginx.conf，添加如下内容：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">http &#123;</span><br><span class="line">    upstream splash &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.27</span><span class="number">.223</span>:<span class="number">8050</span>;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.27</span><span class="number">.221</span>:<span class="number">8050</span>;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.27</span><span class="number">.9</span>:<span class="number">8050</span>;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.117</span><span class="number">.119</span>:<span class="number">8050</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen <span class="number">8050</span>;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//splash;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们通过<code>upstream</code>字段定义了一个名字叫作<code>splash</code>的服务集群配置。其中<code>least_conn</code>代表最少链接负载均衡，它适合处理请求处理时间长短不一造成服务器过载的情况。</p>
                  <p>当然，我们也可以不指定配置，具体如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">upstream splash &#123;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.223:8050;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.221:8050;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.9:8050;</span><br><span class="line">   <span class="built_in"> server </span>41.159.117.119:8050;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样默认以轮询策略实现负载均衡，每个服务器的压力相同。此策略适合服务器配置相当、无状态且短平快的服务使用。</p>
                  <p>另外，我们还可以指定权重，配置如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">upstream splash &#123;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.223:8050 <span class="attribute">weight</span>=4;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.221:8050 <span class="attribute">weight</span>=2;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.9:8050 <span class="attribute">weight</span>=2;</span><br><span class="line">   <span class="built_in"> server </span>41.159.117.119:8050 <span class="attribute">weight</span>=1;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里<code>weight</code>参数指定各个服务的权重，权重越高，分配到处理的请求越多。假如不同的服务器配置差别比较大的话，可以使用此种配置。</p>
                  <p>最后，还有一种IP散列负载均衡，配置如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">upstream splash &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.223:8050;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.221:8050;</span><br><span class="line">   <span class="built_in"> server </span>41.159.27.9:8050;</span><br><span class="line">   <span class="built_in"> server </span>41.159.117.119:8050;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>服务器根据请求客户端的IP地址进行散列计算，确保使用同一个服务器响应请求，这种策略适合有状态的服务，比如用户登录后访问某个页面的情形。对于Splash来说，不需要应用此设置。</p>
                  <p>我们可以根据不同的情形选用不同的配置，配置完成后重启一下Nginx服务：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">sudo nginx -s reload</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样直接访问Nginx所在服务器的8050端口，即可实现负载均衡了。</p>
                  <h2 id="3-配置认证"><a href="#3-配置认证" class="headerlink" title="3. 配置认证"></a>3. 配置认证</h2>
                  <p>现在Splash是可以公开访问的，如果不想让其公开访问，还可以配置认证，这仍然借助于Nginx。可以在<code>server</code>的<code>location</code>字段中添加<code>auth_basic</code>和<code>auth_basic_user_file</code>字段，具体配置如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">http &#123;</span><br><span class="line">    upstream splash &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.27</span><span class="number">.223</span>:<span class="number">8050</span>;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.27</span><span class="number">.221</span>:<span class="number">8050</span>;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.27</span><span class="number">.9</span>:<span class="number">8050</span>;</span><br><span class="line">        server <span class="number">41.159</span><span class="number">.117</span><span class="number">.119</span>:<span class="number">8050</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen <span class="number">8050</span>;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//splash;</span></span><br><span class="line">            auth_basic <span class="string">"Restricted"</span>;</span><br><span class="line">            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里使用的用户名和密码配置放置在/etc/nginx/conf.d目录下，我们需要使用<code>htpasswd</code>命令创建。例如，创建一个用户名为<code>admin</code>的文件，相关命令如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">htpasswd</span> <span class="selector-tag">-c</span> <span class="selector-class">.htpasswd</span> <span class="selector-tag">admin</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来就会提示我们输入密码，输入两次之后，就会生成密码文件，其内容如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">cat</span> <span class="selector-class">.htpasswd</span> </span><br><span class="line"><span class="selector-tag">admin</span><span class="selector-pseudo">:5ZBxQr0rCqwbc</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>配置完成后，重启一下Nginx服务：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">sudo nginx -s reload</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样访问认证就成功配置好了。</p>
                  <h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h2>
                  <p>最后，我们可以用代码来测试一下负载均衡的配置，看看到底是不是每次请求会切换IP。利用<a href="http://httpbin.org/get" target="_blank" rel="noopener">http://httpbin.org/get</a>测试即可，实现代码如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse import quote</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">lua = <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">function main(splash, args)</span></span><br><span class="line"><span class="string">  local treat = require("treat")</span></span><br><span class="line"><span class="string">  local response = splash:http_get("http://httpbin.org/get")</span></span><br><span class="line"><span class="string">  return treat.as_string(response.body)</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://splash:8050/execute?lua_source='</span> + quote(lua)</span><br><span class="line">response = requests.<span class="builtin-name">get</span>(url, auth=(<span class="string">'admin'</span>, <span class="string">'admin'</span>))</span><br><span class="line">ip = re.search(<span class="string">'(\d+\.\d+\.\d+\.\d+)'</span>, response.text).group(1)</span><br><span class="line"><span class="builtin-name">print</span>(ip)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里URL中的splash字符串请自行替换成自己的Nginx服务器IP。这里我修改了Hosts，设置了splash为Nginx服务器IP。</p>
                  <p>多次运行代码之后，可以发现每次请求的IP都会变化，比如第一次的结果：</p>
                  <figure class="highlight accesslog">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">41.159.27.223</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第二次的结果：</p>
                  <figure class="highlight accesslog">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">41.159.27.9</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这就说明负载均衡已经成功实现了。</p>
                  <p>本节中，我们成功实现了负载均衡的配置。配置负载均衡后，可以多个Splash服务共同合作，减轻单个服务的负载，这还是比较有用的。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2018-01-31 22:07:31" itemprop="dateCreated datePublished" datetime="2018-01-31T22:07:31+08:00">2018-01-31</time>
                </span>
                <span id="/5654.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 7.3-Splash负载均衡配置" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <script>
              document.querySelectorAll('.random').forEach(item => item.src = "https://picsum.photos/id/" + Math.floor(Math.random() * Math.floor(300)) + "/200/133")

            </script>
            <nav class="pagination">
              <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
            </nav>
          </div>
          <script>
            window.addEventListener('tabs:register', () =>
            {
              let
              {
                activeClass
              } = CONFIG.comments;
              if (CONFIG.comments.storage)
              {
                activeClass = localStorage.getItem('comments_active') || activeClass;
              }
              if (activeClass)
              {
                let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
                if (activeTab)
                {
                  activeTab.click();
                }
              }
            });
            if (CONFIG.comments.storage)
            {
              window.addEventListener('tabs:click', event =>
              {
                if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
                let commentClass = event.target.classList[1];
                localStorage.setItem('comments_active', commentClass);
              });
            }

          </script>
        </div>
        <div class="toggle sidebar-toggle">
          <span class="toggle-line toggle-line-first"></span>
          <span class="toggle-line toggle-line-middle"></span>
          <span class="toggle-line toggle-line-last"></span>
        </div>
        <aside class="sidebar">
          <div class="sidebar-inner">
            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc"> 文章目录 </li>
              <li class="sidebar-nav-overview"> 站点概览 </li>
            </ul>
            <!--noindex-->
            <div class="post-toc-wrap sidebar-panel">
            </div>
            <!--/noindex-->
            <div class="site-overview-wrap sidebar-panel">
              <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <img class="site-author-image" itemprop="image" alt="崔庆才" src="/images/avatar.png">
                <p class="site-author-name" itemprop="name">崔庆才</p>
                <div class="site-description" itemprop="description">崔庆才的个人站点，记录生活的瞬间，分享学习的心得。</div>
              </div>
              <div class="site-state-wrap motion-element">
                <nav class="site-state">
                  <div class="site-state-item site-state-posts">
                    <a href="/archives/">
                      <span class="site-state-item-count">518</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>
                  <div class="site-state-item site-state-categories">
                    <a href="/categories/">
                      <span class="site-state-item-count">21</span>
                      <span class="site-state-item-name">分类</span></a>
                  </div>
                  <div class="site-state-item site-state-tags">
                    <a href="/tags/">
                      <span class="site-state-item-count">121</span>
                      <span class="site-state-item-name">标签</span></a>
                  </div>
                </nav>
              </div>
              <div class="links-of-author motion-element">
                <span class="links-of-author-item">
                  <a href="https://github.com/Germey" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Germey" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
                </span>
                <span class="links-of-author-item">
                  <a href="mailto:cqc@cuiqingcai.com.com" title="邮件 → mailto:cqc@cuiqingcai.com.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>邮件</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://weibo.com/cuiqingcai" title="微博 → https:&#x2F;&#x2F;weibo.com&#x2F;cuiqingcai" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>微博</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/Germey" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Germey" rel="noopener" target="_blank"><i class="fa fa-magic fa-fw"></i>知乎</a>
                </span>
              </div>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://www.abuyun.com/http-proxy/introduce.html" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/88au8.jpg" style=" width: 100%;">
              </a>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://tutorial.lengyue.video/?coupon=12ef4b1a-a3db-11ea-bb37-0242ac130002_cqx_850" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/bco2a.png" style=" width: 100%;">
              </a>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://luminati-china.io/?affiliate=ref_5fbbaaa9647883f5c6f77095" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/ikkq9.jpg" style=" width: 100%;">
              </a>
            </div>
            <div class="sidebar-panel sidebar-panel-tags sidebar-panel-active">
              <h4 class="name"> 标签云 </h4>
              <div class="content">
                <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/599/" style="font-size: 10px;">599</a> <a href="/tags/Bootstrap/" style="font-size: 11.25px;">Bootstrap</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CQC/" style="font-size: 10px;">CQC</a> <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/CSS-%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">CSS 反爬虫</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Eclipse/" style="font-size: 11.25px;">Eclipse</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/GitHub/" style="font-size: 11.25px;">GitHub</a> <a href="/tags/HTML5/" style="font-size: 10px;">HTML5</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/IT/" style="font-size: 10px;">IT</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/LOGO/" style="font-size: 10px;">LOGO</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MIUI/" style="font-size: 10px;">MIUI</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/PHP/" style="font-size: 11.25px;">PHP</a> <a href="/tags/PS/" style="font-size: 10px;">PS</a> <a href="/tags/Pathlib/" style="font-size: 10px;">Pathlib</a> <a href="/tags/PhantomJS/" style="font-size: 10px;">PhantomJS</a> <a href="/tags/PySpider/" style="font-size: 10px;">PySpider</a> <a href="/tags/Python/" style="font-size: 16.25px;">Python</a> <a href="/tags/Python3/" style="font-size: 12.5px;">Python3</a> <a href="/tags/Pythonic/" style="font-size: 10px;">Pythonic</a> <a href="/tags/QQ/" style="font-size: 10px;">QQ</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SAE/" style="font-size: 10px;">SAE</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SVG/" style="font-size: 10px;">SVG</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/Scrapy-redis/" style="font-size: 10px;">Scrapy-redis</a> <a href="/tags/Scrapy%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">Scrapy分布式</a> <a href="/tags/Selenium/" style="font-size: 10px;">Selenium</a> <a href="/tags/TKE/" style="font-size: 10px;">TKE</a> <a href="/tags/Ubuntu/" style="font-size: 11.25px;">Ubuntu</a> <a href="/tags/Vue/" style="font-size: 11.25px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Winpcap/" style="font-size: 10px;">Winpcap</a> <a href="/tags/WordPress/" style="font-size: 13.75px;">WordPress</a> <a href="/tags/object-Object/" style="font-size: 10px;">[object Object]</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/cocos2d-x/" style="font-size: 10px;">cocos2d-x</a> <a href="/tags/e6/" style="font-size: 10px;">e6</a> <a href="/tags/fitvids/" style="font-size: 10px;">fitvids</a> <a href="/tags/git/" style="font-size: 11.25px;">git</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/js%E9%80%86%E5%90%91/" style="font-size: 10px;">js逆向</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/logging/" style="font-size: 10px;">logging</a> <a href="/tags/matlab/" style="font-size: 11.25px;">matlab</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/pywin32/" style="font-size: 10px;">pywin32</a> <a href="/tags/style/" style="font-size: 10px;">style</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/uwsgi/" style="font-size: 10px;">uwsgi</a> <a href="/tags/validate-cert/" style="font-size: 10px;">validate_cert</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/wamp/" style="font-size: 10px;">wamp</a> <a href="/tags/wineQQ/" style="font-size: 10px;">wineQQ</a> <a href="/tags/%E4%B8%83%E7%89%9B/" style="font-size: 11.25px;">七牛</a> <a href="/tags/%E4%B8%8A%E6%B5%B7/" style="font-size: 10px;">上海</a> <a href="/tags/%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99/" style="font-size: 10px;">个人网站</a> <a href="/tags/%E4%B8%BB%E9%A2%98/" style="font-size: 10px;">主题</a> <a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 10px;">云存储</a> <a href="/tags/%E4%BA%AC%E4%B8%9C%E4%BA%91/" style="font-size: 10px;">京东云</a> <a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 10px;">人工智能</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 10px;">代理</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" style="font-size: 10px;">代码</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size: 10px;">位运算</a> <a href="/tags/%E5%88%86%E4%BA%AB/" style="font-size: 10px;">分享</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">分布式</a> <a href="/tags/%E5%88%9B%E4%B8%9A/" style="font-size: 10px;">创业</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 11.25px;">前端</a> <a href="/tags/%E5%8E%9F%E7%94%9FAPP/" style="font-size: 10px;">原生APP</a> <a href="/tags/%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 12.5px;">反爬虫</a> <a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 10px;">命令</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80/" style="font-size: 10px;">响应式布局</a> <a href="/tags/%E5%9F%9F%E5%90%8D%E7%BB%91%E5%AE%9A/" style="font-size: 10px;">域名绑定</a> <a href="/tags/%E5%A4%A7%E4%BC%97%E7%82%B9%E8%AF%84/" style="font-size: 10px;">大众点评</a> <a href="/tags/%E5%AD%97%E4%BD%93%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">字体反爬虫</a> <a href="/tags/%E5%AE%9E%E7%94%A8/" style="font-size: 10px;">实用</a> <a href="/tags/%E5%B4%94%E5%BA%86%E6%89%8D/" style="font-size: 18.75px;">崔庆才</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%89%8B%E6%9C%BA%E8%AE%BF%E9%97%AE/" style="font-size: 10px;">手机访问</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%97%85%E6%B8%B8/" style="font-size: 10px;">旅游</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 10px;">日志</a> <a href="/tags/%E6%9D%9C%E5%85%B0%E7%89%B9/" style="font-size: 10px;">杜兰特</a> <a href="/tags/%E6%A1%8C%E9%9D%A2/" style="font-size: 10px;">桌面</a> <a href="/tags/%E6%B1%9F%E5%8D%97/" style="font-size: 10px;">江南</a> <a href="/tags/%E6%B8%B8%E6%88%8F/" style="font-size: 10px;">游戏</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 15px;">爬虫</a> <a href="/tags/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" style="font-size: 10px;">环境变量</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">生活笔记</a> <a href="/tags/%E7%99%BB%E5%BD%95/" style="font-size: 10px;">登录</a> <a href="/tags/%E7%9F%A5%E4%B9%8E/" style="font-size: 10px;">知乎</a> <a href="/tags/%E7%9F%AD%E4%BF%A1/" style="font-size: 10px;">短信</a> <a href="/tags/%E7%BA%B8%E5%BC%A0/" style="font-size: 10px;">纸张</a> <a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 10px;">网站</a> <a href="/tags/%E8%82%89%E5%A4%B9%E9%A6%8D/" style="font-size: 10px;">肉夹馍</a> <a href="/tags/%E8%A5%BF%E5%B0%91%E7%88%B7/" style="font-size: 10px;">西少爷</a> <a href="/tags/%E8%A7%86%E9%A2%91/" style="font-size: 10px;">视频</a> <a href="/tags/%E8%BF%9C%E7%A8%8B/" style="font-size: 10px;">远程</a> <a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 10px;">逆向</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 10px;">配置</a> <a href="/tags/%E9%87%8D%E8%A3%85/" style="font-size: 10px;">重装</a> <a href="/tags/%E9%9D%99%E8%A7%85/" style="font-size: 17.5px;">静觅</a> <a href="/tags/%E9%A2%A0%E8%A6%86/" style="font-size: 10px;">颠覆</a> <a href="/tags/%E9%A3%9E%E4%BF%A1/" style="font-size: 10px;">飞信</a>
              </div>
              <script>
                const tagsColors = ['#00a67c', '#5cb85c', '#d9534f', '#567e95', '#b37333', '#f4843d', '#15a287']
                const tagsElements = document.querySelectorAll('.sidebar-panel-tags .content a')
                tagsElements.forEach((item) =>
                {
                  item.style.backgroundColor = tagsColors[Math.floor(Math.random() * tagsColors.length)]
                })

              </script>
            </div>
            <div class="sidebar-panel sidebar-panel-categories sidebar-panel-active">
              <h4 class="name"> 分类 </h4>
              <div class="content">
                <ul class="category-list">
                  <li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">23</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><span class="category-list-count">13</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">26</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">15</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Net/">Net</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a><span class="category-list-count">38</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">27</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Paper/">Paper</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">256</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E5%B1%95%E7%A4%BA/">个人展示</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/">个人日记</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/">个人随笔</a><span class="category-list-count">10</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/">技术杂谈</a><span class="category-list-count">74</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/">生活笔记</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A6%8F%E5%88%A9%E4%B8%93%E5%8C%BA/">福利专区</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%81%8C%E4%BD%8D%E6%8E%A8%E8%8D%90/">职位推荐</a><span class="category-list-count">2</span></li>
                </ul>
              </div>
            </div>
            <div class="sidebar-panel sidebar-panel-friends sidebar-panel-active">
              <h4 class="name"> 友情链接 </h4>
              <ul class="friends">
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/j2dub.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.findhao.net/" target="_blank" rel="noopener">FindHao</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ou6mm.jpg">
                  </span>
                  <span class="link">
                    <a href="https://diygod.me/" target="_blank" rel="noopener">DIYgod</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/6apxu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.51dev.com/" target="_blank" rel="noopener">IT技术社区</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.jankl.com/img/titleshu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.jankl.com/" target="_blank" rel="noopener">liberalist</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/bqlbs.png">
                  </span>
                  <span class="link">
                    <a href="http://www.urselect.com/" target="_blank" rel="noopener">优社电商</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/8s88c.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yuanrenxue.com/" target="_blank" rel="noopener">猿人学</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/4i7yf.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lizenghai.com/" target="_blank" rel="noopener">Python量化投资</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/2wgg5.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yunlifang.cn/" target="_blank" rel="noopener">云立方</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/shwr6.png">
                  </span>
                  <span class="link">
                    <a href="http://lanbing510.info/" target="_blank" rel="noopener">冰蓝</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/blvoh.jpg">
                  </span>
                  <span class="link">
                    <a href="https://lengyue.me/" target="_blank" rel="noopener">冷月</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="http://qianxunclub.com/favicon.png">
                  </span>
                  <span class="link">
                    <a href="http://qianxunclub.com/" target="_blank" rel="noopener">千寻啊千寻</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/0044u.jpg">
                  </span>
                  <span class="link">
                    <a href="http://kodcloud.com/" target="_blank" rel="noopener">可道云</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ygnpn.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.kunkundashen.cn/" target="_blank" rel="noopener">坤坤大神</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/22uv1.png">
                  </span>
                  <span class="link">
                    <a href="http://www.cenchong.com/" target="_blank" rel="noopener">岑冲博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ev9kl.png">
                  </span>
                  <span class="link">
                    <a href="http://www.zxiaoji.com/" target="_blank" rel="noopener">张小鸡</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.chrafz.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.chrafz.com/" target="_blank" rel="noopener">张弦先生</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.503error.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.503error.com/" target="_blank" rel="noopener">张志明个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://seofangfa.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://seofangfa.com/" target="_blank" rel="noopener">方法SEO</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/x714o.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.hubwiz.com/" target="_blank" rel="noopener">汇智网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/lfmj3.png">
                  </span>
                  <span class="link">
                    <a href="http://frankchen.xyz/" target="_blank" rel="noopener">不正经数据科学家</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/129d8.png">
                  </span>
                  <span class="link">
                    <a href="https://www.bysocket.com/" target="_blank" rel="noopener">泥瓦匠BYSocket</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.xiongge.club/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.xiongge.club/" target="_blank" rel="noopener">熊哥club</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/3w4fe.png">
                  </span>
                  <span class="link">
                    <a href="https://zerlong.com/" target="_blank" rel="noopener">知语</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/262r1.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.ysir308.com/" target="_blank" rel="noopener">程序员虾说</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/44hxf.png">
                  </span>
                  <span class="link">
                    <a href="http://redstonewill.com/" target="_blank" rel="noopener">红色石头</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/8g1fk.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.laodong.me/" target="_blank" rel="noopener">老董博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/wkaus.jpg">
                  </span>
                  <span class="link">
                    <a href="https://zhaoshuai.me/" target="_blank" rel="noopener">碎念</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/pgo0r.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.chenwenguan.com/" target="_blank" rel="noopener">陈文管的博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/kk82a.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lxlinux.net/" target="_blank" rel="noopener">良许Linux教程网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/lj0t2.jpg">
                  </span>
                  <span class="link">
                    <a href="https://tanqingbo.cn/" target="_blank" rel="noopener">IT码农</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/i8cdr.png">
                  </span>
                  <span class="link">
                    <a href="https://junyiseo.com/" target="_blank" rel="noopener">均益个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/chwv2.png">
                  </span>
                  <span class="link">
                    <a href="https://brucedone.com/" target="_blank" rel="noopener">大鱼的鱼塘</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/2y43o.png">
                  </span>
                  <span class="link">
                    <a href="http://bbs.nightteam.cn/" target="_blank" rel="noopener">夜幕爬虫安全论坛</a>
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </aside>
        <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span>
          <span class="with-love">
            <i class="fa fa-heart"></i>
          </span>
          <span class="author" itemprop="copyrightHolder">崔庆才丨静觅</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-chart-area"></i>
          </span>
          <span title="站点总字数">2.5m</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-coffee"></i>
          </span>
          <span title="站点阅读时长">37:31</span>
        </div>
        <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动 </div>
        <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18015597号-1 </a>
        </div>
        <script>
          (function ()
          {
            function leancloudSelector(url)
            {
              url = encodeURI(url);
              return document.getElementById(url).querySelector('.leancloud-visitors-count');
            }

            function addCount(Counter)
            {
              var visitors = document.querySelector('.leancloud_visitors');
              var url = decodeURI(visitors.id);
              var title = visitors.dataset.flagTitle;
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                if (results.length > 0)
                {
                  var counter = results[0];
                  leancloudSelector(url).innerText = counter.time + 1;
                  Counter('put', '/classes/Counter/' + counter.objectId,
                  {
                    time:
                    {
                      '__op': 'Increment',
                      'amount': 1
                    }
                  }).catch(error =>
                  {
                    console.error('Failed to save visitor count', error);
                  });
                }
                else
                {
                  Counter('post', '/classes/Counter',
                  {
                    title,
                    url,
                    time: 1
                  }).then(response => response.json()).then(() =>
                  {
                    leancloudSelector(url).innerText = 1;
                  }).catch(error =>
                  {
                    console.error('Failed to create', error);
                  });
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }

            function showTime(Counter)
            {
              var visitors = document.querySelectorAll('.leancloud_visitors');
              var entries = [...visitors].map(element =>
              {
                return decodeURI(element.id);
              });
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url:
                {
                  '$in': entries
                }
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                for (let url of entries)
                {
                  let target = results.find(item => item.url === url);
                  leancloudSelector(url).innerText = target ? target.time : 0;
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }
            let
            {
              app_id,
              app_key,
              server_url
            } = {
              "enable": true,
              "app_id": "6X5dRQ0pnPWJgYy8SXOg0uID-gzGzoHsz",
              "app_key": "ziLDVEy73ne5HtFTiGstzHMS",
              "server_url": null,
              "security": false
            };

            function fetchData(api_server)
            {
              var Counter = (method, url, data) =>
              {
                return fetch(`${api_server}/1.1${url}`,
                {
                  method,
                  headers:
                  {
                    'X-LC-Id': app_id,
                    'X-LC-Key': app_key,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data)
                });
              };
              if (CONFIG.page.isPost)
              {
                if (CONFIG.hostname !== location.hostname) return;
                addCount(Counter);
              }
              else if (document.querySelectorAll('.post-title-link').length >= 1)
              {
                showTime(Counter);
              }
            }
            let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;
            if (api_server)
            {
              fetchData(api_server);
            }
            else
            {
              fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id).then(response => response.json()).then((
              {
                api_server
              }) =>
              {
                fetchData('https://' + api_server);
              });
            }
          })();

        </script>
      </div>
      <div class="footer-stat">
        <span id="cnzz_stat_icon_1279355174"></span>
        <script type="text/javascript">
          document.write(unescape("%3Cspan id='cnzz_stat_icon_1279355174'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279355174%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));

        </script>
      </div>
    </footer>
  </div>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/.js"></script>
  <script src="/js/schemes/pisces.js"></script>
  <script src="/.js"></script>
  <script src="/js/next-boot.js"></script>
  <script src="/.js"></script>
  <script>
    (function ()
    {
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x = document.getElementsByTagName("link");
      //Find the last canonical URL
      if (x.length > 0)
      {
        for (i = 0; i < x.length; i++)
        {
          if (x[i].rel.toLowerCase() == 'canonical' && x[i].href)
          {
            canonicalURL = x[i].href;
          }
        }
      }
      //Get protocol
      if (!canonicalURL)
      {
        curProtocol = window.location.protocol.split(':')[0];
      }
      else
      {
        curProtocol = canonicalURL.split(':')[0];
      }
      //Get current URL if the canonical URL does not exist
      if (!canonicalURL) canonicalURL = window.location.href;
      //Assign script content. Replace current URL with the canonical URL
      ! function ()
      {
        var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,
          r = canonicalURL,
          t = document.referrer;
        if (!e.test(r))
        {
          var n = (String(curProtocol).toLowerCase() === 'https') ? "https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif" : "//api.share.baidu.com/s.gif";
          t ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
          var i = new Image;
          i.src = n
        }
      }(window);
    })();

  </script>
  <script src="/js/local-search.js"></script>
  <script src="/.js"></script>
</body>

</html>
