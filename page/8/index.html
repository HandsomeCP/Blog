<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
  <meta name="theme-color" content="#222">
  <meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>
  <script id="hexo-configurations">
    var NexT = window.NexT ||
    {};
    var CONFIG = {
      "hostname": "cuiqingcai.com",
      "root": "/",
      "scheme": "Pisces",
      "version": "7.8.0",
      "exturl": false,
      "sidebar":
      {
        "position": "right",
        "width": 360,
        "display": "post",
        "padding": 18,
        "offset": 12,
        "onmobile": false,
        "widgets": [
          {
            "type": "image",
            "name": "阿布云",
            "enable": true,
            "url": "https://www.abuyun.com/http-proxy/introduce.html",
            "src": "https://qiniu.cuiqingcai.com/88au8.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "天验",
            "enable": true,
            "url": "https://tutorial.lengyue.video/?coupon=12ef4b1a-a3db-11ea-bb37-0242ac130002_cqx_850",
            "src": "https://qiniu.cuiqingcai.com/bco2a.png",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "华为云",
            "enable": false,
            "url": "https://activity.huaweicloud.com/2020_618_promotion/index.html?bpName=5f9f98a29e2c40b780c1793086f29fe2&bindType=1&salesID=wangyubei",
            "src": "https://qiniu.cuiqingcai.com/y42ik.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "张小鸡",
            "enable": false,
            "url": "http://www.zxiaoji.com/",
            "src": "https://qiniu.cuiqingcai.com/fm72f.png",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "Luminati",
            "src": "https://qiniu.cuiqingcai.com/ikkq9.jpg",
            "url": "https://luminati-china.io/?affiliate=ref_5fbbaaa9647883f5c6f77095",
            "width": "100%",
            "enable": true
      },
          {
            "type": "tags",
            "name": "标签云",
            "enable": true
      },
          {
            "type": "categories",
            "name": "分类",
            "enable": true
      },
          {
            "type": "friends",
            "name": "友情链接",
            "enable": true
      },
          {
            "type": "hot",
            "name": "猜你喜欢",
            "enable": true
      }]
      },
      "copycode":
      {
        "enable": true,
        "show_result": true,
        "style": "mac"
      },
      "back2top":
      {
        "enable": true,
        "sidebar": false,
        "scrollpercent": true
      },
      "bookmark":
      {
        "enable": false,
        "color": "#222",
        "save": "auto"
      },
      "fancybox": false,
      "mediumzoom": false,
      "lazyload": false,
      "pangu": true,
      "comments":
      {
        "style": "tabs",
        "active": "gitalk",
        "storage": true,
        "lazyload": false,
        "nav": null,
        "activeClass": "gitalk"
      },
      "algolia":
      {
        "hits":
        {
          "per_page": 10
        },
        "labels":
        {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      },
      "localsearch":
      {
        "enable": true,
        "trigger": "auto",
        "top_n_per_article": 10,
        "unescape": false,
        "preload": false
      },
      "motion":
      {
        "enable": false,
        "async": false,
        "transition":
        {
          "post_block": "bounceDownIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      "path": "search.xml"
    };

  </script>
  <meta name="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
  <meta property="og:type" content="website">
  <meta property="og:title" content="静觅">
  <meta property="og:url" content="https://cuiqingcai.com/page/8/index.html">
  <meta property="og:site_name" content="静觅">
  <meta property="og:description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
  <meta property="og:locale" content="zh_CN">
  <meta property="article:author" content="崔庆才">
  <meta property="article:tag" content="崔庆才">
  <meta property="article:tag" content="静觅">
  <meta property="article:tag" content="PHP">
  <meta property="article:tag" content="Java">
  <meta property="article:tag" content="Python">
  <meta property="article:tag" content="Spider">
  <meta property="article:tag" content="爬虫">
  <meta property="article:tag" content="Web">
  <meta property="article:tag" content="Kubernetes">
  <meta property="article:tag" content="深度学习">
  <meta property="article:tag" content="机器学习">
  <meta property="article:tag" content="数据分析">
  <meta property="article:tag" content="网络">
  <meta property="article:tag" content="IT">
  <meta property="article:tag" content="技术">
  <meta property="article:tag" content="博客">
  <meta name="twitter:card" content="summary">
  <link rel="canonical" href="https://cuiqingcai.com/page/8/">
  <script id="page-configurations">
    // https://hexo.io/docs/variables.html
    CONFIG.page = {
      sidebar: "",
      isHome: true,
      isPost: false,
      lang: 'zh-CN'
    };

  </script>
  <title>静觅丨崔庆才的个人站点</title>
  <meta name="google-site-verification" content="p_bIcnvirkFzG2dYKuNDivKD8-STet5W7D-01woA2fc" />
  <noscript>
    <style>
      .use-motion .brand,
      .use-motion .menu-item,
      .sidebar-inner,
      .use-motion .post-block,
      .use-motion .pagination,
      .use-motion .comments,
      .use-motion .post-header,
      .use-motion .post-body,
      .use-motion .collection-header
      {
        opacity: initial;
      }

      .use-motion .site-title,
      .use-motion .site-subtitle
      {
        opacity: initial;
        top: initial;
      }

      .use-motion .logo-line-before i
      {
        left: initial;
      }

      .use-motion .logo-line-after i
      {
        right: initial;
      }

    </style>
  </noscript>
  <link rel="alternate" href="/atom.xml" title="静觅" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-container">
          <div class="site-nav-toggle">
            <div class="toggle" aria-label="切换导航栏">
              <span class="toggle-line toggle-line-first"></span>
              <span class="toggle-line toggle-line-middle"></span>
              <span class="toggle-line toggle-line-last"></span>
            </div>
          </div>
          <div class="site-meta">
            <a href="/" class="brand" rel="start">
              <span class="logo-line-before"><i></i></span>
              <h1 class="site-title">静觅 <span class="site-subtitle"> 崔庆才的个人站点 </span>
              </h1>
              <span class="logo-line-after"><i></i></span>
            </a>
          </div>
          <div class="site-nav-right">
            <div class="toggle popup-trigger">
              <i class="fa fa-search fa-fw fa-lg"></i>
            </div>
          </div>
        </div>
        <nav class="site-nav">
          <ul id="menu" class="main-menu menu">
            <li class="menu-item menu-item-home">
              <a href="/" rel="section">首页</a>
            </li>
            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">文章列表</a>
            </li>
            <li class="menu-item menu-item-tags">
              <a href="/tags/" rel="section">文章标签</a>
            </li>
            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">文章分类</a>
            </li>
            <li class="menu-item menu-item-about">
              <a href="/about/" rel="section">关于博主</a>
            </li>
            <li class="menu-item menu-item-message">
              <a href="/message/" rel="section">给我留言</a>
            </li>
            <li class="menu-item menu-item-search">
              <a role="button" class="popup-trigger">搜索 </a>
            </li>
          </ul>
        </nav>
        <div class="search-pop-overlay">
          <div class="popup search-popup">
            <div class="search-header">
              <span class="search-icon">
                <i class="fa fa-search"></i>
              </span>
              <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
              </div>
              <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
              </span>
            </div>
            <div id="search-result">
              <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span>0%</span>
    </div>
    <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content index posts-expand">
            <div class="carousel">
              <div id="wowslider-container">
                <div class="ws_images">
                  <ul>
                    <li><a target="_blank" href="https://cuiqingcai.com/5052.html"><img title="Python3网络爬虫开发实战教程" src="https://qiniu.cuiqingcai.com/ipy96.jpg" /></a></li>
                    <li><a target="_blank" href="https://t.lagou.com/fRCBRsRCSN6FA"><img title="52讲轻松搞定网络爬虫" src="https://qiniu.cuiqingcai.com/fqq5e.png" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/4320.html"><img title="Python3网络爬虫开发视频教程" src="https://qiniu.cuiqingcai.com/bjrny.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/1052.html"><img title="Python2爬虫学习系列教程" src="https://qiniu.cuiqingcai.com/uyl5v.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/5094.html"><img title="爬虫代理哪家强？十大付费代理详细对比评测出炉！" src="https://qiniu.cuiqingcai.com/nifs6.jpg" /></a></li>
                  </ul>
                </div>
                <div class="ws_thumbs">
                  <div>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/ipy96.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/fqq5e.png" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/bjrny.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/uyl5v.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/nifs6.jpg" /></a>
                  </div>
                </div>
                <div class="ws_shadow"></div>
              </div>
            </div>
            <link rel="stylesheet" href="/lib/wowslide/slide.css">
            <script src="/lib/wowslide/jquery.min.js"></script>
            <script src="/lib/wowslide/slider.js"></script>
            <script>
              jQuery("#wowslider-container").wowSlider(
              {
                effect: "cube",
                prev: "",
                next: "",
                duration: 20 * 100,
                delay: 20 * 100,
                width: 716,
                height: 297,
                autoPlay: true,
                playPause: true,
                stopOnHover: false,
                loop: false,
                bullets: 0,
                caption: true,
                captionEffect: "slide",
                controls: true,
                onBeforeStep: 0,
                images: 0
              });

            </script>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7071.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7071.html" class="post-title-link" itemprop="url">Python 中 typing 模块和类型注解的使用</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="实例引入"><a href="#实例引入" class="headerlink" title="实例引入"></a>实例引入</h2>
                  <p>我们知道 Python 是一种动态语言，在声明一个变量时我们不需要显式地声明它的类型，例如下面的例子：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">a</span> = <span class="number">2</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">'1 + a ='</span>, <span class="number">1</span> + a)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight basic">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">1 </span>+ a = <span class="number">3</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们首先声明了一个变量 <code>a</code>，并将其赋值为了 2，然后将最后的结果打印出来，程序输出来了正确的结果。但在这个过程中，我们没有声明它到底是什么类型。 但如果这时候我们将 <code>a</code> 变成一个字符串类型，结果会是怎样的呢？改写如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">a</span> = <span class="string">'2'</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">'1 + a ='</span>, <span class="number">1</span> + a)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight scala">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="type">TypeError</span>: unsupported operand <span class="class"><span class="keyword">type</span>(<span class="params">s</span>) <span class="title">for</span> <span class="title">+</span></span>: <span class="symbol">'in</span>t' and <span class="symbol">'st</span>r'</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>直接报错了，错误原因是我们进行了字符串类型的变量和数值类型变量的加和，两种数据类型不同，是无法进行相加的。 如果我们将上面的语句改写成一个方法定义：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里定义了一个方法，传入一个参数，然后将其加 1 并返回。 如果这时候如果用下面的方式调用，传入的参数是一个数值类型：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">add</span><span class="params">(<span class="number">2</span>)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>则可以正常输出结果 3。但如果我们传入的参数并不是我们期望的类型，比如传入一个字符类型，那么就会同样报刚才类似的错误。 但又由于 Python 的特性，很多情况下我们并不用去声明它的类型，因此从方法定义上面来看，我们实际上是不知道一个方法的参数到底应该传入什么类型的。 这样其实就造成了很多不方便的地方，在某些情况下一些复杂的方法，如果不借助于一些额外的说明，我们是不知道参数到底是什么类型的。 因此，Python 中的类型注解就显得比较重要了。</p>
                  <h2 id="类型注解"><a href="#类型注解" class="headerlink" title="类型注解"></a>类型注解</h2>
                  <p>在 Python 3.5 中，Python PEP 484 引入了类型注解（type hints），在 Python 3.6 中，PEP 526 又进一步引入了变量注解（Variable Annotations），所以上面的代码我们改写成如下写法：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">a:</span> <span class="keyword">int</span> = <span class="number">2</span></span><br><span class="line"><span class="keyword">print</span>(<span class="string">'5 + a ='</span>, <span class="number">5</span> + <span class="keyword">a</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(<span class="variable">a:</span> <span class="keyword">int</span>) -&gt; in<span class="variable">t:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">a</span> + <span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>具体的语法是可以归纳为两点：</p>
                  <ul>
                    <li>在声明变量时，变量的后面可以加一个冒号，后面再写上变量的类型，如 int、list 等等。</li>
                    <li>在声明方法返回值的时候，可以在方法的后面加一个箭头，后面加上返回值的类型，如 int、list 等等。</li>
                  </ul>
                  <p>在 <a href="https://www.python.org/dev/peps/pep-0008/#other-recommendations" target="_blank" rel="noopener">PEP 8</a> 中，具体的格式是这样规定的：</p>
                  <ul>
                    <li>在声明变量类型时，变量后方紧跟一个冒号，冒号后面跟一个空格，再跟上变量的类型。</li>
                    <li>在声明方法返回值的时候，箭头左边是方法定义，箭头右边是返回值的类型，箭头左右两边都要留有空格。</li>
                  </ul>
                  <p>有了这样的声明，以后我们如果看到这个方法的定义，我们就知道传入的参数类型了，如调用 add 方法的时候，我们就知道传入的需要是一个数值类型的变量，而不是字符串类型，非常直观。 但值得注意的是，这种类型和变量注解实际上只是一种类型提示，对运行实际上是没有影响的，比如调用 add 方法的时候，我们传入的不是 int 类型，而是一个 float 类型，它也不会报错，也不会对参数进行类型转换，如：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">add</span><span class="params">(<span class="number">1.5</span>)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们传入的是一个 float 类型的数值 1.5，看下运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2.5</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，运行结果正常输出，而且 1.5 并没有经过强制类型转换变成 1，否则结果会变成 2。 因此，类型和变量注解只是提供了一种提示，对于运行实际上没有任何影响。 不过有了类型注解，一些 IDE 是可以识别出来并提示的，比如 PyCharm 就可以识别出来在调用某个方法的时候参数类型不一致，会提示 WARNING。 比如上面的调用，如果在 PyCharm 中，就会有如下提示内容：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Expected<span class="built_in"> type </span><span class="string">'int'</span>, got <span class="string">'float'</span> instead</span><br><span class="line">This inspection detects<span class="built_in"> type </span>errors <span class="keyword">in</span> function call expressions. Due <span class="keyword">to</span> dynamic dispatch <span class="keyword">and</span> duck typing, this is possible <span class="keyword">in</span> a limited but useful number of cases. Types of function parameters can be specified <span class="keyword">in</span> docstrings <span class="keyword">or</span> <span class="keyword">in</span> Python 3 function annotations.</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外也有一些库是支持类型检查的，比如 mypy，安装之后，利用 mypy 即可检查出 Python 脚本中不符合类型注解的调用情况。 上面只是用一个简单的 int 类型做了实例，下面我们再看下一些相对复杂的数据结构，例如列表、元组、字典等类型怎么样来声明。 可想而知了，列表用 list 表示，元组用 tuple 表示，字典用 dict 来表示，那么很自然地，在声明的时候我们就很自然地写成这样了：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">names:</span> <span class="string">list</span> <span class="string">=</span> <span class="string">['Germey',</span> <span class="string">'Guido'</span><span class="string">]</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">tuple</span> <span class="string">=</span> <span class="string">(3,</span> <span class="number">7</span><span class="string">,</span> <span class="number">4</span><span class="string">)</span></span><br><span class="line"><span class="attr">operations:</span> <span class="string">dict</span> <span class="string">=</span> <span class="string">&#123;'show':</span> <span class="literal">False</span><span class="string">,</span> <span class="attr">'sort':</span> <span class="literal">True</span><span class="string">&#125;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这么看上去没有问题，确实声明为了对应的类型，但实际上并不能反映整个列表、元组的结构，比如我们只通过类型注解是不知道 names 里面的元素是什么类型的，只知道 names 是一个列表 list 类型，实际上里面都是字符串 str 类型。我们也不知道 version 这个元组的每一个元素是什么类型的，实际上是 int 类型。但这些信息我们都无从得知。因此说，仅仅凭借 list、tuple 这样的声明是非常“弱”的，我们需要一种更强的类型声明。 这时候我们就需要借助于 typing 模块了，它提供了非常“强“的类型支持，比如 <code>List[str]</code>、<code>Tuple[int, int, int]</code> 则可以表示由 str 类型的元素组成的列表和由 int 类型的元素组成的长度为 3 的元组。所以上文的声明写法可以改写成下面的样子：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List, Tuple, Dict</span><br><span class="line"></span><br><span class="line">names: List[str] = [<span class="string">'Germey'</span>, <span class="string">'Guido'</span>]</span><br><span class="line"><span class="keyword">version</span>: Tuple[<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>] = (<span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>)</span><br><span class="line">operations: Dict[str, <span class="type">bool</span>] = &#123;<span class="string">'show'</span>: <span class="keyword">False</span>, <span class="string">'sort'</span>: <span class="keyword">True</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样一来，变量的类型便可以非常直观地体现出来了。 目前 typing 模块也已经被加入到 Python 标准库中，不需要安装第三方模块，我们就可以直接使用了。</p>
                  <h2 id="typing"><a href="#typing" class="headerlink" title="typing"></a>typing</h2>
                  <p>下面我们再来详细看下 typing 模块的具体用法，这里主要会介绍一些常用的注解类型，如 List、Tuple、Dict、Sequence 等等，了解了每个类型的具体使用方法，我们可以得心应手的对任何变量进行声明了。 在引入的时候就直接通过 typing 模块引入就好了，例如：</p>
                  <figure class="highlight capnproto">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="built_in">List</span>, Tuple</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3>
                  <p>List、列表，是 list 的泛型，基本等同于 list，其后紧跟一个方括号，里面代表了构成这个列表的元素类型，如由数字构成的列表可以声明为：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">var: List[<span class="built_in">int</span> <span class="keyword">or</span> <span class="built_in">float</span>] = [<span class="number">2</span>, <span class="number">3.5</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外还可以嵌套声明都是可以的：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">var: List[List[<span class="built_in">int</span>]] = [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">2</span>, <span class="number">3</span>]]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="Tuple、NamedTuple"><a href="#Tuple、NamedTuple" class="headerlink" title="Tuple、NamedTuple"></a>Tuple、NamedTuple</h3>
                  <p>Tuple、元组，是 tuple 的泛型，其后紧跟一个方括号，方括号中按照顺序声明了构成本元组的元素类型，如 <code>Tuple[X, Y]</code> 代表了构成元组的第一个元素是 X 类型，第二个元素是 Y 类型。 比如想声明一个元组，分别代表姓名、年龄、身高，三个数据类型分别为 str、int、float，那么可以这么声明：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">person: Tuple[str, <span class="built_in">int</span>, <span class="built_in">float</span>] = (<span class="string">'Mike'</span>, <span class="number">22</span>, <span class="number">1.75</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>同样地也可以使用类型嵌套。 NamedTuple，是 collections.namedtuple 的泛型，实际上就和 namedtuple 用法完全一致，但个人其实并不推荐使用 NamedTuple，推荐使用 attrs 这个库来声明一些具有表征意义的类。</p>
                  <h3 id="Dict、Mapping、MutableMapping"><a href="#Dict、Mapping、MutableMapping" class="headerlink" title="Dict、Mapping、MutableMapping"></a>Dict、Mapping、MutableMapping</h3>
                  <p>Dict、字典，是 dict 的泛型；Mapping，映射，是 collections.abc.Mapping 的泛型。根据官方文档，Dict 推荐用于注解返回类型，Mapping 推荐用于注解参数。它们的使用方法都是一样的，其后跟一个中括号，中括号内分别声明键名、键值的类型，如：</p>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def <span class="built_in">size</span>(<span class="built_in">rect</span>: Mapping[<span class="built_in">str</span>, <span class="built_in">int</span>]) -&gt; Dict[<span class="built_in">str</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'width'</span>: <span class="built_in">rect</span>[<span class="string">'width'</span>] + <span class="number">100</span>, <span class="string">'height'</span>: <span class="built_in">rect</span>[<span class="string">'width'</span>] + <span class="number">100</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里将 Dict 用作了返回值类型注解，将 Mapping 用作了参数类型注解。 MutableMapping 则是 Mapping 对象的子类，在很多库中也经常用 MutableMapping 来代替 Mapping。</p>
                  <h3 id="Set、AbstractSet"><a href="#Set、AbstractSet" class="headerlink" title="Set、AbstractSet"></a>Set、AbstractSet</h3>
                  <p>Set、集合，是 set 的泛型；AbstractSet、是 collections.abc.Set 的泛型。根据官方文档，Set 推荐用于注解返回类型，AbstractSet 用于注解参数。它们的使用方法都是一样的，其后跟一个中括号，里面声明集合中元素的类型，如：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def <span class="keyword">describe</span>(s: AbstractSet[<span class="built_in">int</span>]) -&gt; <span class="keyword">Set</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">set</span>(s)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里将 Set 用作了返回值类型注解，将 AbstractSet 用作了参数类型注解。</p>
                  <h3 id="Sequence"><a href="#Sequence" class="headerlink" title="Sequence"></a>Sequence</h3>
                  <p>Sequence，是 collections.abc.Sequence 的泛型，在某些情况下，我们可能并不需要严格区分一个变量或参数到底是列表 list 类型还是元组 tuple 类型，我们可以使用一个更为泛化的类型，叫做 Sequence，其用法类似于 List，如：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">def</span> square(<span class="string">elements:</span> Sequence[<span class="keyword">float</span>]) -&gt; List[<span class="keyword">float</span>]:</span><br><span class="line">    <span class="keyword">return</span> [x ** <span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> elements]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="NoReturn"><a href="#NoReturn" class="headerlink" title="NoReturn"></a>NoReturn</h3>
                  <p>NoReturn，当一个方法没有返回结果时，为了注解它的返回类型，我们可以将其注解为 NoReturn，例如：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span> -&gt; NoReturn:</span></span><br><span class="line">    print(<span class="string">'hello'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="Any"><a href="#Any" class="headerlink" title="Any"></a>Any</h3>
                  <p>Any，是一种特殊的类型，它可以代表所有类型，静态类型检查器的所有类型都与 Any 类型兼容，所有的无参数类型注解和返回类型注解的都会默认使用 Any 类型，也就是说，下面两个方法的声明是完全等价的：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a: Any)</span> -&gt; Any:</span></span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>原理类似于 object，所有的类型都是 object 的子类。但如果我们将参数声明为 object 类型，静态参数类型检查便会抛出错误，而 Any 则不会，具体可以参考官方文档的说明：<a href="https://docs.python.org/zh-cn/3/library/typing.html?highlight=typing#the-any-type" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3/library/typing.html?highlight=typing#the-any-type</a>。</p>
                  <h3 id="TypeVar"><a href="#TypeVar" class="headerlink" title="TypeVar"></a>TypeVar</h3>
                  <p>TypeVar，我们可以借助它来自定义兼容特定类型的变量，比如有的变量声明为 int、float、None 都是符合要求的，实际就是代表任意的数字或者空内容都可以，其他的类型则不可以，比如列表 list、字典 dict 等等，像这样的情况，我们可以使用 TypeVar 来表示。 例如一个人的身高，便可以使用 int 或 float 或 None 来表示，但不能用 dict 来表示，所以可以这么声明：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">height = <span class="number">1.75</span></span><br><span class="line">Height = TypeVar(<span class="string">'Height'</span>, int, float, <span class="literal">None</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_height</span><span class="params">()</span> -&gt; Height:</span></span><br><span class="line">    <span class="keyword">return</span> height</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们使用 TypeVar 声明了一个 Height 类型，然后将其用于注解方法的返回结果。</p>
                  <h3 id="NewType"><a href="#NewType" class="headerlink" title="NewType"></a>NewType</h3>
                  <p>NewType，我们可以借助于它来声明一些具有特殊含义的类型，例如像 Tuple 的例子一样，我们需要将它表示为 Person，即一个人的含义，但但从表面上声明为 Tuple 并不直观，所以我们可以使用 NewType 为其声明一个类型，如：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Person</span> = NewType(<span class="string">'Person'</span>, Tuple[str, int, float])</span><br><span class="line"><span class="attr">person</span> = Person((<span class="string">'Mike'</span>, <span class="number">22</span>, <span class="number">1.75</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里实际上 person 就是一个 tuple 类型，我们可以对其像 tuple 一样正常操作。</p>
                  <h3 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h3>
                  <p>Callable，可调用类型，它通常用来注解一个方法，比如我们刚才声明了一个 add 方法，它就是一个 Callable 类型：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">print(<span class="name">Callable</span>, type(<span class="name">add</span>), isinstance(<span class="name">add</span>, Callable))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">typing.Callable &lt;<span class="keyword">class</span> '<span class="symbol">function</span>'&gt; <span class="symbol">True</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里虽然二者 add 利用 type 方法得到的结果是 function，但实际上利用 isinstance 方法判断确实是 True。 Callable 在声明的时候需要使用 <code>Callable[[Arg1Type, Arg2Type, ...], ReturnType]</code> 这样的类型注解，将参数类型和返回值类型都要注解出来，例如：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">def</span> date(<span class="string">year:</span> <span class="keyword">int</span>, <span class="string">month:</span> <span class="keyword">int</span>, <span class="string">day:</span> <span class="keyword">int</span>) -&gt; <span class="string">str:</span></span><br><span class="line">    <span class="keyword">return</span> f<span class="string">'&#123;year&#125;-&#123;month&#125;-&#123;day&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> get_date_fn() -&gt; Callable[[<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>], str]:</span><br><span class="line">    <span class="keyword">return</span> date</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里首先声明了一个方法 date，接收三个 int 参数，返回一个 str 结果，get_date_fn 方法返回了这个方法本身，它的返回值类型就可以标记为 Callable，中括号内分别标记了返回的方法的参数类型和返回值类型。</p>
                  <h3 id="Union"><a href="#Union" class="headerlink" title="Union"></a>Union</h3>
                  <p>Union，联合类型，<code>Union[X, Y]</code> 代表要么是 X 类型，要么是 Y 类型。 联合类型的联合类型等价于展平后的类型：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">Union</span>[<span class="keyword">Union</span>[<span class="type">int</span>, str], <span class="type">float</span>] == <span class="keyword">Union</span>[<span class="type">int</span>, str, <span class="type">float</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>仅有一个参数的联合类型会坍缩成参数自身，比如：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">Union</span>[<span class="type">int</span>] == <span class="type">int</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>多余的参数会被跳过，比如：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Union[<span class="keyword">int</span>, <span class="keyword">str</span>, <span class="keyword">int</span>] == Union[<span class="keyword">int</span>, <span class="keyword">str</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在比较联合类型的时候，参数顺序会被忽略，比如：</p>
                  <figure class="highlight axapta">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Union[<span class="keyword">int</span>, <span class="keyword">str</span>] == Union[<span class="keyword">str</span>, <span class="keyword">int</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个在一些方法参数声明的时候比较有用，比如一个方法，要么传一个字符串表示的方法名，要么直接把方法传过来：</p>
                  <figure class="highlight armasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">def</span> process(<span class="meta">fn</span>: Union[<span class="keyword">str, </span>Callable]):</span><br><span class="line">    <span class="meta">if</span> isinstance(<span class="meta">fn</span>, <span class="keyword">str):</span></span><br><span class="line"><span class="keyword"> </span>       # <span class="keyword">str2fn </span><span class="keyword">and </span>process</span><br><span class="line">        pass</span><br><span class="line">    <span class="meta">elif</span> isinstance(<span class="meta">fn</span>, Callable):</span><br><span class="line">        <span class="meta">fn</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样的声明在一些类库方法定义的时候十分常见。</p>
                  <h3 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h3>
                  <p>Optional，意思是说这个参数可以为空或已经声明的类型，即 <code>Optional[X]</code> 等价于 <code>Union[X, None]</code>。 但值得注意的是，这个并不等价于可选参数，当它作为参数类型注解的时候，不代表这个参数可以不传递了，而是说这个参数可以传为 None。 如当一个方法执行结果，如果执行完毕就不返回错误信息， 如果发生问题就返回错误信息，则可以这么声明：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge</span><span class="params">(result: bool)</span> -&gt; Optional[str]:</span></span><br><span class="line">    <span class="keyword">if</span> result: <span class="keyword">return</span> <span class="string">'Error Occurred'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h3>
                  <p>如果想代表一个生成器类型，可以使用 Generator，它的声明比较特殊，其后的中括号紧跟着三个参数，分别代表 YieldType、SendType、ReturnType，如：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo_round</span><span class="params">()</span> -&gt; Generator[int, float, str]:</span></span><br><span class="line">    sent = <span class="keyword">yield</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> sent &gt;= <span class="number">0</span>:</span><br><span class="line">        sent = <span class="keyword">yield</span> round(sent)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Done'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里 yield 关键字后面紧跟的变量的类型就是 YieldType，yield 返回的结果的类型就是 SendType，最后生成器 return 的内容就是 ReturnType。 当然很多情况下，生成器往往只需要 yield 内容就够了，我们是不需要 SendType 和 ReturnType 的，可以将其设置为空，如：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">infinite_stream</span><span class="params">(start: int)</span> -&gt; Generator[int, <span class="keyword">None</span>, <span class="keyword">None</span>]:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> start</span><br><span class="line">        start += <span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="案例实战"><a href="#案例实战" class="headerlink" title="案例实战"></a>案例实战</h2>
                  <p>接下来让我们看一个实际的项目，看看经常用到的类型一般是怎么使用的。 这里我们看的库是 requests-html，是由 Kenneth Reitz 所开发的，其 GitHub 地址为：<a href="https://github.com/psf/requests-html" target="_blank" rel="noopener">https://github.com/psf/requests-html</a>，下面我们主要看看它的源代码中一些类型是如何声明的。 这个库的源代码其实就一个文件，那就是 <a href="https://github.com/psf/requests-html/blob/master/requests_html.py" target="_blank" rel="noopener">https://github.com/psf/requests-html/blob/master/requests_html.py</a>，我们看一下它里面的一些 typing 的定义和方法定义。 首先 Typing 的定义部分如下：</p>
                  <figure class="highlight sqf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> typing import <span class="built_in">Set</span>, Union, <span class="built_in">List</span>, MutableMapping, Optional</span><br><span class="line"></span><br><span class="line"><span class="variable">_Find</span> = Union[<span class="built_in">List</span>[<span class="string">'Element'</span>], <span class="string">'Element'</span>]</span><br><span class="line"><span class="variable">_XPath</span> = Union[<span class="built_in">List</span>[<span class="built_in">str</span>], <span class="built_in">List</span>[<span class="string">'Element'</span>], <span class="built_in">str</span>, <span class="string">'Element'</span>]</span><br><span class="line"><span class="variable">_Result</span> = Union[<span class="built_in">List</span>[<span class="string">'Result'</span>], <span class="string">'Result'</span>]</span><br><span class="line"><span class="variable">_HTML</span> = Union[<span class="built_in">str</span>, bytes]</span><br><span class="line"><span class="variable">_BaseHTML</span> = <span class="built_in">str</span></span><br><span class="line"><span class="variable">_UserAgent</span> = <span class="built_in">str</span></span><br><span class="line"><span class="variable">_DefaultEncoding</span> = <span class="built_in">str</span></span><br><span class="line"><span class="variable">_URL</span> = <span class="built_in">str</span></span><br><span class="line"><span class="variable">_RawHTML</span> = bytes</span><br><span class="line"><span class="variable">_Encoding</span> = <span class="built_in">str</span></span><br><span class="line"><span class="variable">_LXML</span> = HtmlElement</span><br><span class="line"><span class="variable">_Text</span> = <span class="built_in">str</span></span><br><span class="line"><span class="variable">_Search</span> = Result</span><br><span class="line"><span class="variable">_Containing</span> = Union[<span class="built_in">str</span>, <span class="built_in">List</span>[<span class="built_in">str</span>]]</span><br><span class="line"><span class="variable">_Links</span> = <span class="built_in">Set</span>[<span class="built_in">str</span>]</span><br><span class="line"><span class="variable">_Attrs</span> = MutableMapping</span><br><span class="line"><span class="variable">_Next</span> = Union[<span class="string">'HTML'</span>, <span class="built_in">List</span>[<span class="built_in">str</span>]]</span><br><span class="line"><span class="variable">_NextSymbol</span> = <span class="built_in">List</span>[<span class="built_in">str</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里可以看到主要用到的类型有 Set、Union、List、MutableMapping、Optional，这些在上文都已经做了解释，另外这里使用了多次 Union 来声明了一些新的类型，如 <code>_Find</code> 则要么是是 Element 对象的列表，要么是单个 Element 对象，<code>_Result</code> 则要么是 Result 对象的列表，要么是单个 Result 对象。另外 <code>_Attrs</code> 其实就是字典类型，这里用 MutableMapping 来表示了，没有用 Dict，也没有用 Mapping。 接下来再看一个 Element 类的声明：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Element</span><span class="params">(BaseParser)</span>:</span></span><br><span class="line">    <span class="string">"""An element of HTML.</span></span><br><span class="line"><span class="string">    :param element: The element from which to base the parsing upon.</span></span><br><span class="line"><span class="string">    :param url: The URL from which the HTML originated, used for ``absolute_links``.</span></span><br><span class="line"><span class="string">    :param default_encoding: Which encoding to default to.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    __slots__ = [</span><br><span class="line">        <span class="string">'element'</span>, <span class="string">'url'</span>, <span class="string">'skip_anchors'</span>, <span class="string">'default_encoding'</span>, <span class="string">'_encoding'</span>,</span><br><span class="line">        <span class="string">'_html'</span>, <span class="string">'_lxml'</span>, <span class="string">'_pq'</span>, <span class="string">'_attrs'</span>, <span class="string">'session'</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *, element, url: _URL, default_encoding: _DefaultEncoding = None)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        super(Element, self).__init__(element=element, url=url, default_encoding=default_encoding)</span><br><span class="line">        self.element = element</span><br><span class="line">        self.tag = element.tag</span><br><span class="line">        self.lineno = element.sourceline</span><br><span class="line">        self._attrs = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        attrs = [<span class="string">'&#123;&#125;=&#123;&#125;'</span>.format(attr, repr(self.attrs[attr])) <span class="keyword">for</span> attr <span class="keyword">in</span> self.attrs]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;Element &#123;&#125; &#123;&#125;&gt;"</span>.format(repr(self.element.tag), <span class="string">' '</span>.join(attrs))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">attrs</span><span class="params">(self)</span> -&gt; _Attrs:</span></span><br><span class="line">        <span class="string">"""Returns a dictionary of the attributes of the :class:`Element &lt;Element&gt;`</span></span><br><span class="line"><span class="string">        (`learn more &lt;https://www.w3schools.com/tags/ref_attributes.asp&gt;`_).</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self._attrs <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._attrs = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> self.element.items()&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Split class and rel up, as there are ussually many of them:</span></span><br><span class="line">            <span class="keyword">for</span> attr <span class="keyword">in</span> [<span class="string">'class'</span>, <span class="string">'rel'</span>]:</span><br><span class="line">                <span class="keyword">if</span> attr <span class="keyword">in</span> self._attrs:</span><br><span class="line">                    self._attrs[attr] = tuple(self._attrs[attr].split())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self._attrs</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 <code>__init__</code> 方法接收非常多的参数，同时使用 <code>_URL</code> 、<code>_DefaultEncoding</code> 进行了参数类型注解，另外 attrs 方法使用了 <code>_Attrs</code> 进行了返回结果类型注解。 整体看下来，每个参数的类型、返回值都进行了清晰地注解，代码可读性大大提高。 以上便是类型注解和 typing 模块的详细介绍。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-04 20:28:17" itemprop="dateCreated datePublished" datetime="2019-08-04T20:28:17+08:00">2019-08-04</time>
                </span>
                <span id="/7071.html" class="post-meta-item leancloud_visitors" data-flag-title="Python 中 typing 模块和类型注解的使用" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>9.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7051.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7051.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 9.3-付费讯代理、阿布云代理的使用</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>相对免费代理来说，付费代理的稳定性相对更高一点，本节介绍一下爬虫付费代理的相关使用过程。</p>
                  <h3 id="1-付费代理分类"><a href="#1-付费代理分类" class="headerlink" title="1. 付费代理分类"></a>1. 付费代理分类</h3>
                  <p>在这里将付费代理分为两类：</p>
                  <ul>
                    <li>提供接口获取海量代理，按天或者按量付费，如讯代理</li>
                    <li>搭建了代理隧道，直接设置固定域名代理，如阿布云</li>
                  </ul>
                  <p>本节讲解一下这两种代理的使用方法，分别以两家代表性的代理网站为例进行讲解。</p>
                  <h3 id="2-讯代理"><a href="#2-讯代理" class="headerlink" title="2. 讯代理"></a>2. 讯代理</h3>
                  <p>讯代理个人使用过代理有效率还是蛮高的，此处非广告，其官网为：<a href="http://www.xdaili.cn/" target="_blank" rel="noopener">http://www.xdaili.cn/</a>，如图 9-5 所示： <img src="./assets/9-5.png" alt=""> 图 9-5 讯代理官网 有多种类别的代理可供选购，摘抄其官网的各类别代理介绍如下：</p>
                  <ul>
                    <li>优质代理： 适合对代理IP需求量非常大，但能接受代理有效时长较短（10~30分钟)，小部分不稳定的客户</li>
                    <li>独享动态： 适合对代理IP稳定性要求非常高，且可以自主控制的客户，支持地区筛选。</li>
                    <li>独享秒切： 适合对代理IP稳定性要求非常高，且可以自主控制的客户，快速获取IP，地区随机分配</li>
                    <li>动态混拨： 适合对代理IP需求量大，代理IP使用时效短（3分钟），切换快的客户</li>
                    <li>优质定制： 如果优质代理的套餐不能满足您的需求，请使用定制服务</li>
                  </ul>
                  <p>一般选择第一类别优质代理即可，代理量比较大，但是代理的稳定性没那么高，有一些代理也是不可用的，所以这种代理的使用方式就需要借助于上一节所说的代理池，我们自己再做一次筛选，确保代理可用。 可以购买一天的试一下效果，购买之后会提供一个 API 来提取代理，如图 9-6 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060609.jpg" alt=""> 图 9-6 提取页面 比如在这里我的提取 API 为：<a href="http://www.xdaili.cn/ipagent/greatRecharge/getGreatIp?spiderId=da289b78fec24f19b392e04106253f2a&amp;orderno=YZ20177140586mTTnd7&amp;returnType=2&amp;count=20" target="_blank" rel="noopener">http://www.xdaili.cn/ipagent/greatRecharge/getGreatIp?spiderId=da289b78fec24f19b392e04106253f2a&amp;orderno=YZ20177140586mTTnd7&amp;returnType=2&amp;count=20</a>，可能已过期，在此仅做演示。 在这里指定了提取数量为 20，提取格式为 Json，直接访问链接即可提取代理，结果如图 9-7 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060621.jpg" alt=""> 图 9-7 提取结果 接下来我们要做的就是解析这个 Json，然后将其放入我们的代理池中。 当然如果信赖讯代理的话也可以不做代理池筛选，直接使用，不过我个人还是推荐再使用代理池筛选一遍，提高可用几率。 根据上一节代理池的写法，我们只需要在 Crawler 中再加入一个 crawl 开头的方法即可。 方法实现如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def crawl_xdaili(self):</span><br><span class="line">        <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        获取讯代理</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        url = <span class="string">'http://www.xdaili.cn/ipagent/greatRecharge/getGreatIp?spiderId=da289b78fec24f19b392e04106253f2a&amp;orderno=YZ20177140586mTTnd7&amp;returnType=2&amp;count=20'</span></span><br><span class="line">        html = get_page(url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            result = json.loads(html)</span><br><span class="line">            proxies = result.<span class="builtin-name">get</span>(<span class="string">'RESULT'</span>)</span><br><span class="line">            <span class="keyword">for</span><span class="built_in"> proxy </span><span class="keyword">in</span> proxies:</span><br><span class="line">                yield proxy.<span class="builtin-name">get</span>(<span class="string">'ip'</span>) + <span class="string">':'</span> + proxy.<span class="builtin-name">get</span>(<span class="string">'port'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就在代理池中接入了讯代理，获取讯代理的结果之后，解析 Json，返回代理即可。 这样代理池运行之后就会抓取和检测该接口返回的代理了，如果可用，那么就会被设为 100，通过代理池接口即可获取到。 以上以讯代理为例说明了此种批量提取代理的使用方法。</p>
                  <h3 id="3-阿布云代理"><a href="#3-阿布云代理" class="headerlink" title="3. 阿布云代理"></a>3. 阿布云代理</h3>
                  <p>阿布云代理提供了代理隧道，代理速度快而且非常稳定，此处依然非广告，其官网为：<a href="https://www.abuyun.com/" target="_blank" rel="noopener">https://www.abuyun.com/</a>，如图 9-8 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060629.png" alt=""> 图 9-8 阿布云官网 阿布云的代理主要分为两种，专业版和动态版，另外还有定制版，摘抄官网的介绍如下：</p>
                  <ul>
                    <li>专业版，多个请求锁定一个代理 IP，海量 IP 资源池需求，近 300 个区域全覆盖，代理 IP 可连续使用1分钟，适用于请求 IP 连续型业务</li>
                    <li>动态版，每个请求一个随机代理 IP，海量 IP 资源池需求，近 300 个区域全覆盖，适用于爬虫类业务</li>
                    <li>定制版，灵活按照需求定制，定制 IP 区域，定制 IP 使用时长，定制 IP 每秒请求数</li>
                  </ul>
                  <p>关于专业版和动态版的更多介绍可以查看官网：<a href="https://www.abuyun.com/http-proxy/dyn-intro.html" target="_blank" rel="noopener">https://www.abuyun.com/http-proxy/dyn-intro.html</a>。 对于爬虫来说，推荐使用动态版，购买之后可以在后台看到代理隧道的用户名和密码，如图 9-9 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060650.jpg" alt=""> 图 9-9 阿布云代理后台 可以发现整个代理的连接域名为 proxy.abuyun.com，端口为 9020，均是固定的，但是使用之后每次的 IP 都会更改，这其实就是利用了代理隧道实现。 其官网原理介绍如下：</p>
                  <ul>
                    <li>云代理通过代理隧道的形式提供高匿名代理服务，支持 HTTP/HTTPS 协议。</li>
                    <li>云代理在云端维护一个全局 IP 池供代理隧道使用，池中的 IP 会不间断更新，以保证同一时刻 IP 池中有几十到几百个可用代理IP。</li>
                    <li>需要注意的是代理IP池中有部分 IP 可能会在当天重复出现多次。</li>
                    <li>动态版HTTP代理隧道会为每个请求从 IP 池中挑选一个随机代理 IP。</li>
                    <li>无须切换代理 IP，每一个请求一个随机代理IP。</li>
                    <li>HTTP代理隧道有并发请求限制，默认每秒只允许 5 个请求。如果需要更多请求数，请额外购买。</li>
                  </ul>
                  <p>注意默认套餐的并发请求是 5 个，如果需要更多需要另外购买。 使用的教程在官网也有，链接为：<a href="https://www.abuyun.com/http-proxy/dyn-manual-python.html" target="_blank" rel="noopener">https://www.abuyun.com/http-proxy/dyn-manual-python.html</a>，提供了 Requests、Urllib、Scrapy 的接入方式。 以 Requests 为例，接入示例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://httpbin.org/get'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器</span></span><br><span class="line">proxy_host = <span class="string">'proxy.abuyun.com'</span></span><br><span class="line">proxy_port = <span class="string">'9020'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理隧道验证信息</span></span><br><span class="line">proxy_user = <span class="string">'H01234567890123D'</span></span><br><span class="line">proxy_pass = <span class="string">'0123456789012345'</span></span><br><span class="line"></span><br><span class="line">proxy_meta = <span class="string">'http://%(user)s:%(pass)s@%(host)s:%(port)s'</span> % &#123;</span><br><span class="line">    <span class="string">'host'</span>: proxy_host,</span><br><span class="line">    <span class="string">'port'</span>: proxy_port,</span><br><span class="line">    <span class="string">'user'</span>: proxy_user,</span><br><span class="line">    <span class="string">'pass'</span>: proxy_pass,</span><br><span class="line">&#125;</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: proxy_meta,</span><br><span class="line">    <span class="string">'https'</span>: proxy_meta,</span><br><span class="line">&#125;</span><br><span class="line">response = requests.<span class="builtin-name">get</span>(url, <span class="attribute">proxies</span>=proxies)</span><br><span class="line"><span class="builtin-name">print</span>(response.status_code)</span><br><span class="line"><span class="builtin-name">print</span>(response.text)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里其实就是使用了代理认证，在前面我们也提到过类似的设置方法，运行结果如下：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">200</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"*/*"</span>, </span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"python-requests/2.18.1"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"60.207.237.111"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出结果的 origin 即为代理IP的实际地址，可以多次运行测试，可以发现每次请求 origin 都会在变化，这就是动态版代理的效果。 这种效果其实跟我们之前的代理池的随机代理效果类似，都是随机取出了一个当前可用代理。 但是此服务相比于维护代理池来说，使用更加方便，配置简单，省时省力，在价格可以接受的情况下，个人推荐此种代理。</p>
                  <h3 id="4-结语"><a href="#4-结语" class="headerlink" title="4. 结语"></a>4. 结语</h3>
                  <p>以上便是付费代理的相关使用方法，稳定性相比免费代理更高，可以自行选购合适的代理。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 14:07:57" itemprop="dateCreated datePublished" datetime="2019-08-02T14:07:57+08:00">2019-08-02</time>
                </span>
                <span id="/7051.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 9.3-付费讯代理、阿布云代理的使用" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>3.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7048.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7048.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 9.2-代理池的维护</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>我们在上一节了解了代理的设置方法，利用代理我们可以解决目标网站封 IP 的问题，而在网上又有大量公开的免费代理，其中有一部分可以拿来使用，或者我们也可以购买付费的代理 IP，价格也不贵。但是不论是免费的还是付费的，都不能保证它们每一个都是可用的，毕竟可能其他人也可能在用此 IP 爬取同样的目标站点而被封禁，或者代理服务器突然出故障或网络繁忙。一旦我们选用了一个不可用的代理，势必会影响我们爬虫的工作效率。 所以说，在用代理时，我们需要提前做一下筛选，将不可用的代理剔除掉，保留下可用代理，接下来在获取代理时从可用代理里面取出直接使用就好了。 所以本节我们来搭建一个高效易用的代理池。</p>
                  <h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h3>
                  <p>要实现代理池我们首先需要成功安装好了 Redis 数据库并启动服务，另外还需要安装 Aiohttp、Requests、RedisPy、PyQuery、Flask 库，如果没有安装可以参考第一章的安装说明。</p>
                  <h3 id="2-代理池的目标"><a href="#2-代理池的目标" class="headerlink" title="2. 代理池的目标"></a>2. 代理池的目标</h3>
                  <p>代理池要做到易用、高效，我们一般需要做到下面的几个目标：</p>
                  <ul>
                    <li>基本模块分为四块，获取模块、存储模块、检查模块、接口模块。</li>
                    <li>获取模块需要定时去各大代理网站抓取代理，代理可以是免费公开代理也可以是付费代理，代理的形式都是 IP 加端口，尽量从不同来源获取，尽量抓取高匿代理，抓取完之后将可用代理保存到数据库中。</li>
                    <li>存储模块负责存储抓取下来的代理。首先我们需要保证代理不重复，另外我们还需要标识代理的可用情况，而且需要动态实时处理每个代理，所以说，一种比较高效和方便的存储方式就是使用 Redis 的 Sorted Set，也就是有序集合。</li>
                    <li>检测模块需要定时将数据库中的代理进行检测，在这里我们需要设置一个检测链接，最好是爬取哪个网站就检测哪个网站，这样更加有针对性，如果要做一个通用型的代理，那可以设置百度等链接来检测。另外我们需要标识每一个代理的状态，如设置分数标识，100 分代表可用，分数越少代表越不可用，检测一次如果可用，我们可以将其立即设置为100 满分，也可以在原基础上加 1 分，当不可用，可以将其减 1 分，当减到一定阈值后就直接从数据库移除。通过这样的标识分数，我们就可以区分出代理的可用情况，选用的时候会更有针对性。</li>
                    <li>接口模块需要用 API 来提供对外服务的接口，其实我们可以直接连数据库来取，但是这样就需要知道数据库的连接信息，不太安全，而且需要配置连接，所以一个比较安全和方便的方式就是提供一个 Web API 接口，通过访问接口即可拿到可用代理。另外由于可用代理可能有多个，我们可以提供随机返回一个可用代理的接口，这样保证每个可用代理都可以取到，实现负载均衡。</li>
                  </ul>
                  <p>以上便是设计代理的一些基本思路，那么接下来我们就设计一下整体的架构，然后用代码该实现代理池。</p>
                  <h3 id="3-代理池的架构"><a href="#3-代理池的架构" class="headerlink" title="3. 代理池的架构"></a>3. 代理池的架构</h3>
                  <p>根据上文的描述，代理池的架构可以是这样的，如图 9-1 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060342.jpg" alt=""> 图 9-1 代理池架构 代理池分为四个部分，获取模块、存储模块、检测模块、接口模块。</p>
                  <ul>
                    <li>存储模块使用Redis的有序集合，用以代理的去重和状态标识，同时它也是中心模块和基础模块，将其他模块串联起来。</li>
                    <li>获取模块定时从代理网站获取代理，将获取的代理传递给存储模块，保存到数据库。</li>
                    <li>检测模块定时通过存储模块获取所有代理，并对其进行检测，根据不同的检测结果对代理设置不同的标识。</li>
                    <li>接口模块通过 Web API 提供服务接口，其内部还是连接存储模块，获取可用的代理。</li>
                  </ul>
                  <h3 id="4-代理池的实现"><a href="#4-代理池的实现" class="headerlink" title="4. 代理池的实现"></a>4. 代理池的实现</h3>
                  <p>接下来我们分别用代码来实现一下这四个模块。</p>
                  <h4 id="存储模块"><a href="#存储模块" class="headerlink" title="存储模块"></a>存储模块</h4>
                  <p>存储在这里我们使用 Redis 的有序集合，集合的每一个元素都是不重复的，对于代理代理池来说，集合的元素就变成了一个个代理，也就是 IP 加端口的形式，如 60.207.237.111:8888，这样的一个代理就是集合的一个元素。另外有序集合的每一个元素还都有一个分数字段，分数是可以重复的，是一个浮点数类型，也可以是整数类型。该集合会根据每一个元素的分数对集合进行排序，数值小的排在前面，数值大的排在后面，这样就可以实现集合元素的排序了。 对于代理池来说，这个分数可以作为我们判断一个代理可用不可用的标志，我们将 100 设为最高分，代表可用，0 设为最低分，代表不可用。从代理池中获取代理的时候会随机获取分数最高的代理，注意这里是随机，这样可以保证每个可用代理都会被调用到。 分数是我们判断代理稳定性的重要标准，在这里我们设置分数规则如下：</p>
                  <ul>
                    <li>分数 100 为可用，检测器会定时循环检测每个代理可用情况，一旦检测到有可用的代理就立即置为 100，检测到不可用就将分数减 1，减至 0 后移除。</li>
                    <li>新获取的代理添加时将分数置为 10，当测试可行立即置 100，不可行分数减 1，减至 0 后移除。</li>
                  </ul>
                  <p>这是一种解决方案，当然可能还有更合理的方案。此方案的设置有一定的原因，在此总结如下：</p>
                  <ul>
                    <li>当检测到代理可用时立即置为 100，这样可以保证所有可用代理有更大的机会被获取到。你可能会说为什么不直接将分数加 1 而是直接设为最高 100 呢？设想一下，我们有的代理是从各大免费公开代理网站获取的，如果一个代理并没有那么稳定，平均五次请求有两次成功，三次失败，如果按照这种方式来设置分数，那么这个代理几乎不可能达到一个高的分数，也就是说它有时是可用的，但是我们筛选是筛选的分数最高的，所以这样的代理就几乎不可能被取到，当然如果想追求代理稳定性的化可以用这种方法，这样可确保分数最高的一定是最稳定可用的。但是在这里我们采取可用即设置 100 的方法，确保只要可用的代理都可以被使用到。</li>
                    <li>当检测到代理不可用时，将分数减 1，减至 0 后移除，一共 100 次机会，也就是说当一个可用代理接下来如果尝试了 100 次都失败了，就一直减分直到移除，一旦成功就重新置回 100，尝试机会越多代表将这个代理拯救回来的机会越多，这样不容易将曾经的一个可用代理丢弃，因为代理不可用的原因可能是网络繁忙或者其他人用此代理请求太过频繁，所以在这里设置为 100 级。</li>
                    <li>新获取的代理分数设置为 10，检测如果不可用就减 1，减到 0 就移除，如果可用就置 100。由于我们很多代理是从免费网站获取的，所以新获取的代理无效的可能性是非常高的，可能不足 10%，所以在这里我们将其设置为 10，检测的机会没有可用代理 100 次那么多，这也可以适当减少开销。</li>
                  </ul>
                  <p>以上便是代理分数的一个设置思路，不一定是最优思路，但个人实测实用性还是比较强的。 所以我们就需要定义一个类来操作数据库的有序集合，定义一些方法来实现分数的设置，代理的获取等等。 实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">MAX_SCORE = <span class="number">100</span></span><br><span class="line">MIN_SCORE = <span class="number">0</span></span><br><span class="line">INITIAL_SCORE = <span class="number">10</span></span><br><span class="line">REDIS_HOST = <span class="string">'localhost'</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line">REDIS_PASSWORD = <span class="literal">None</span></span><br><span class="line">REDIS_KEY = <span class="string">'proxies'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisClient</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化</span></span><br><span class="line"><span class="string">        :param host: Redis 地址</span></span><br><span class="line"><span class="string">        :param port: Redis 端口</span></span><br><span class="line"><span class="string">        :param password: Redis密码</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.db = redis.StrictRedis(host=host, port=port, password=password, decode_responses=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, proxy, score=INITIAL_SCORE)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        添加代理，设置分数为最高</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :param score: 分数</span></span><br><span class="line"><span class="string">        :return: 添加结果</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.db.zscore(REDIS_KEY, proxy):</span><br><span class="line">            <span class="keyword">return</span> self.db.zadd(REDIS_KEY, score, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        随机获取有效代理，首先尝试获取最高分数代理，如果不存在，按照排名获取，否则异常</span></span><br><span class="line"><span class="string">        :return: 随机代理</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        result = self.db.zrangebyscore(REDIS_KEY, MAX_SCORE, MAX_SCORE)</span><br><span class="line">        <span class="keyword">if</span> len(result):</span><br><span class="line">            <span class="keyword">return</span> choice(result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result = self.db.zrevrange(REDIS_KEY, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">if</span> len(result):</span><br><span class="line">                <span class="keyword">return</span> choice(result)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> PoolEmptyError</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrease</span><span class="params">(self, proxy)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        代理值减一分，小于最小值则删除</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 修改后的代理分数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        score = self.db.zscore(REDIS_KEY, proxy)</span><br><span class="line">        <span class="keyword">if</span> score <span class="keyword">and</span> score &gt; MIN_SCORE:</span><br><span class="line">            print(<span class="string">'代理'</span>, proxy, <span class="string">'当前分数'</span>, score, <span class="string">'减1'</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zincrby(REDIS_KEY, proxy, <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'代理'</span>, proxy, <span class="string">'当前分数'</span>, score, <span class="string">'移除'</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zrem(REDIS_KEY, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exists</span><span class="params">(self, proxy)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        判断是否存在</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 是否存在</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> self.db.zscore(REDIS_KEY, proxy) == <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">max</span><span class="params">(self, proxy)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        将代理设置为MAX_SCORE</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 设置结果</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        print(<span class="string">'代理'</span>, proxy, <span class="string">'可用，设置为'</span>, MAX_SCORE)</span><br><span class="line">        <span class="keyword">return</span> self.db.zadd(REDIS_KEY, MAX_SCORE, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取数量</span></span><br><span class="line"><span class="string">        :return: 数量</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.db.zcard(REDIS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">all</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取全部代理</span></span><br><span class="line"><span class="string">        :return: 全部代理列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.db.zrangebyscore(REDIS_KEY, MIN_SCORE, MAX_SCORE)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先定义了一些常量，如 MAX_SCORE、MIN_SCORE、INITIAL_SCORE 分别代表最大分数、最小分数、初始分数。REDIS_HOST、REDIS_PORT、REDIS_PASSWORD 分别代表了 Redis 的连接信息，即地址、端口、密码。REDIS_KEY 是有序集合的键名，可以通过它来获取代理存储所使用的有序集合。 接下来定义了一个 RedisClient 类，用以操作 Redis 的有序集合，其中定义了一些方法来对集合中的元素进行处理，主要功能如下：</p>
                  <ul>
                    <li><strong>init</strong>() 方法是初始化的方法，参数是Redis的连接信息，默认的连接信息已经定义为常量，在 <strong>init</strong>() 方法中初始化了一个 StrictRedis 的类，建立 Redis 连接。这样当 RedisClient 类初始化的时候就建立了Redis的连接。</li>
                    <li>add() 方法向数据库添加代理并设置分数，默认的分数是 INITIAL_SCORE 也就是 10，返回结果是添加的结果。</li>
                    <li>random() 方法是随机获取代理的方法，首先获取 100 分的代理，然后随机选择一个返回，如果不存在 100 分的代理，则按照排名来获取，选取前 100 名，然后随机选择一个返回，否则抛出异常。</li>
                    <li>decrease() 方法是在代理检测无效的时候设置分数减 1 的方法，传入代理，然后将此代理的分数减 1，如果达到最低值，那么就删除。</li>
                    <li>exists() 方法判断代理是否存在集合中</li>
                    <li>max() 方法是将代理的分数设置为 MAX_SCORE，即 100，也就是当代理有效时的设置。</li>
                    <li>count() 方法返回当前集合的元素个数。</li>
                    <li>all() 方法返回所有的代理列表，供检测使用。</li>
                  </ul>
                  <p>定义好了这些方法，我们可以在后续的模块中调用此类来连接和操作数据库，非常方便。如我们想要获取随机可用的代理，只需要调用 random() 方法即可，得到的就是随机的可用代理。</p>
                  <h4 id="获取模块"><a href="#获取模块" class="headerlink" title="获取模块"></a>获取模块</h4>
                  <p>获取模块的逻辑相对简单，首先需要定义一个 Crawler 来从各大网站抓取代理，示例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import json</span><br><span class="line"><span class="keyword">from</span> .utils import get_page</span><br><span class="line"><span class="keyword">from</span> pyquery import PyQuery as pq</span><br><span class="line"></span><br><span class="line">class ProxyMetaclass(type):</span><br><span class="line">    def __new__(cls, name, bases, attrs):</span><br><span class="line">        count = 0</span><br><span class="line">        attrs[<span class="string">'__CrawlFunc__'</span>] = []</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'crawl_'</span> <span class="keyword">in</span> k:</span><br><span class="line">                attrs[<span class="string">'__CrawlFunc__'</span>].append(k)</span><br><span class="line">                count += 1</span><br><span class="line">        attrs[<span class="string">'__CrawlFuncCount__'</span>] = count</span><br><span class="line">        return type.__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line">class Crawler(object, <span class="attribute">metaclass</span>=ProxyMetaclass):</span><br><span class="line">    def get_proxies(self, callback):</span><br><span class="line">        proxies = []</span><br><span class="line">        <span class="keyword">for</span><span class="built_in"> proxy </span><span class="keyword">in</span> eval(<span class="string">"self.&#123;&#125;()"</span>.format(callback)):</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'成功获取到代理'</span>, proxy)</span><br><span class="line">            proxies.append(proxy)</span><br><span class="line">        return proxies</span><br><span class="line"></span><br><span class="line">    def crawl_daili66(self, <span class="attribute">page_count</span>=4):</span><br><span class="line">        <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        获取代理66</span></span><br><span class="line"><span class="string">        :param page_count: 页码</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        start_url = <span class="string">'http://www.66ip.cn/&#123;&#125;.html'</span></span><br><span class="line">        urls = [start_url.format(page) <span class="keyword">for</span><span class="built_in"> page </span><span class="keyword">in</span> range(1, page_count + 1)]</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'Crawling'</span>, url)</span><br><span class="line">            html = get_page(url)</span><br><span class="line">            <span class="keyword">if</span> html:</span><br><span class="line">                doc = pq(html)</span><br><span class="line">                trs = doc(<span class="string">'.containerbox table tr:gt(0)'</span>).items()</span><br><span class="line">                <span class="keyword">for</span> tr <span class="keyword">in</span> trs:</span><br><span class="line">                   <span class="built_in"> ip </span>= tr.<span class="builtin-name">find</span>(<span class="string">'td:nth-child(1)'</span>).text()</span><br><span class="line">                   <span class="built_in"> port </span>= tr.<span class="builtin-name">find</span>(<span class="string">'td:nth-child(2)'</span>).text()</span><br><span class="line">                    yield <span class="string">':'</span>.join([ip, port])</span><br><span class="line"></span><br><span class="line">    def crawl_proxy360(self):</span><br><span class="line">        <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        获取Proxy360</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        start_url = <span class="string">'http://www.proxy360.cn/Region/China'</span></span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">'Crawling'</span>, start_url)</span><br><span class="line">        html = get_page(start_url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            doc = pq(html)</span><br><span class="line">            lines = doc(<span class="string">'div[name="list_proxy_ip"]'</span>).items()</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">               <span class="built_in"> ip </span>= line.<span class="builtin-name">find</span>(<span class="string">'.tbBottomLine:nth-child(1)'</span>).text()</span><br><span class="line">               <span class="built_in"> port </span>= line.<span class="builtin-name">find</span>(<span class="string">'.tbBottomLine:nth-child(2)'</span>).text()</span><br><span class="line">                yield <span class="string">':'</span>.join([ip, port])</span><br><span class="line"></span><br><span class="line">    def crawl_goubanjia(self):</span><br><span class="line">        <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        获取Goubanjia</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        start_url = <span class="string">'http://www.goubanjia.com/free/gngn/index.shtml'</span></span><br><span class="line">        html = get_page(start_url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            doc = pq(html)</span><br><span class="line">            tds = doc(<span class="string">'td.ip'</span>).items()</span><br><span class="line">            <span class="keyword">for</span> td <span class="keyword">in</span> tds:</span><br><span class="line">                td.<span class="builtin-name">find</span>(<span class="string">'p'</span>).<span class="builtin-name">remove</span>()</span><br><span class="line">                yield td.text().replace(<span class="string">' '</span>, <span class="string">''</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>为了实现灵活，在这里我们将获取代理的一个个方法统一定义一个规范，如统一定义以 crawl 开头，这样扩展的时候只需要添加 crawl 开头的方法即可。 在这里实现了几个示例，如抓取代理 66、Proxy360、Goubanjia 三个免费代理网站，这些方法都定义成了生成器，通过 yield 返回一个个代理。首先将网页获取，然后用PyQuery 解析，解析出IP加端口的形式的代理然后返回。 然后定义了一个 get_proxies() 方法，将所有以 crawl 开头的方法调用一遍，获取每个方法返回的代理并组合成列表形式返回。 你可能会想知道是怎样获取了所有以 crawl 开头的方法名称的。其实这里借助于元类来实现，定义了一个 ProxyMetaclass，Crawl 类将它设置为元类，元类中实现了 <strong>new</strong>() 方法，这个方法有固定的几个参数，其中第四个参数 attrs 中包含了类的一些属性，这其中就包含了类中方法的一些信息，我们可以遍历 attrs 这个变量即可获取类的所有方法信息。所以在这里我们在 <strong>new</strong>() 方法中遍历了 attrs 的这个属性，就像遍历一个字典一样，键名对应的就是方法的名称，接下来判断其开头是否是 crawl，如果是，则将其加入到 <strong>CrawlFunc</strong> 属性中，这样我们就成功将所有以 crawl 开头的方法定义成了一个属性，就成功动态地获取到所有以 crawl 开头的方法列表了。 所以说，如果要做扩展的话，我们只需要添加一个以 crawl开头的方法，例如抓取快代理，我们只需要在 Crawler 类中增加 crawl_kuaidaili() 方法，仿照其他的几个方法将其定义成生成器，抓取其网站的代理，然后通过 yield 返回代理即可，所以这样我们可以非常方便地扩展，而不用关心类其他部分的实现逻辑。 代理网站的添加非常灵活，不仅可以添加免费代理，也可以添加付费代理，一些付费代理的提取方式其实也类似，也是通过 Web 的形式获取，然后进行解析，解析方式可能更加简单，如解析纯文本或 Json，解析之后以同样的方式返回即可，在此不再添加，可以自行扩展。 既然定义了这个 Crawler 类，我们就要调用啊，所以在这里再定义一个 Getter 类，动态地调用所有以 crawl 开头的方法，然后获取抓取到的代理，将其加入到数据库存储起来。</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> crawler <span class="keyword">import</span> Crawler</span><br><span class="line"></span><br><span class="line">POOL_UPPER_THRESHOLD = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Getter</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">        self.crawler = Crawler()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_over_threshold</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        判断是否达到了代理池限制</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.redis.count() &gt;= POOL_UPPER_THRESHOLD:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'获取器开始执行'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_over_threshold():</span><br><span class="line">            <span class="keyword">for</span> callback_label <span class="keyword">in</span> range(self.crawler.__CrawlFuncCount__):</span><br><span class="line">                callback = self.crawler.__CrawlFunc__[callback_label]</span><br><span class="line">                proxies = self.crawler.get_proxies(callback)</span><br><span class="line">                <span class="keyword">for</span> proxy <span class="keyword">in</span> proxies:</span><br><span class="line">                    self.redis.add(proxy)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Getter 类就是获取器类，这其中定义了一个变量 POOL_UPPER_THRESHOLD 表示代理池的最大数量，这个数量可以灵活配置，然后定义了 is_over_threshold() 方法判断代理池是否已经达到了容量阈值，它就是调用了 RedisClient 的 count() 方法获取代理的数量，然后加以判断，如果数量达到阈值则返回 True，否则 False。如果不想加这个限制可以将此方法永久返回 True。 接下来定义了 run() 方法，首先判断了代理池是否达到阈值，然后在这里就调用了 Crawler 类的 <strong>CrawlFunc</strong> 属性，获取到所有以 crawl 开头的方法列表，依次通过 get_proxies() 方法调用，得到各个方法抓取到的代理，然后再利用 RedisClient 的 add() 方法加入数据库，这样获取模块的工作就完成了。</p>
                  <h4 id="检测模块"><a href="#检测模块" class="headerlink" title="检测模块"></a>检测模块</h4>
                  <p>在获取模块中，我们已经成功将各个网站的代理获取下来了，然后就需要一个检测模块来对所有的代理进行一轮轮的检测，检测可用就设置为 100，不可用就分数减 1，这样就可以实时改变每个代理的可用情况，在获取有效代理的时候只需要获取分数高的代理即可。 由于代理的数量非常多，为了提高代理的检测效率，我们在这里使用异步请求库 Aiohttp 来进行检测。 Requests 作为一个同步请求库，我们在发出一个请求之后需要等待网页加载完成之后才能继续执行程序。也就是这个过程会阻塞在等待响应这个过程，如果服务器响应非常慢，比如一个请求等待十几秒，那么我们使用 Requests 完成一个请求就会需要十几秒的时间，中间其实就是一个等待响应的过程，程序也不会继续往下执行，而这十几秒的时间其实完全可以去做其他的事情，比如调度其他的请求或者进行网页解析等等。 异步请求库就解决了这个问题，它类似 JavaScript 中的回调，意思是说在请求发出之后，程序可以继续接下去执行去做其他的事情，当响应到达时，会通知程序再去处理这个响应，这样程序就没有被阻塞，充分把时间和资源利用起来，大大提高效率。 对于响应速度比较快的网站，可能 Requests 同步请求和 Aiohttp 异步请求的效果差距没那么大，可对于检测代理这种事情，一般是需要十多秒甚至几十秒的时间，这时候使用 Aiohttp 异步请求库的优势就大大体现出来了，效率可能会提高几十倍不止。 所以在这里我们的代理检测使用异步请求库 Aiohttp，实现示例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">VALID_STATUS_CODES = [200]</span><br><span class="line">TEST_URL = <span class="string">'http://www.baidu.com'</span></span><br><span class="line">BATCH_TEST_SIZE = 100</span><br><span class="line"></span><br><span class="line">class Tester(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line"></span><br><span class="line">    async def test_single_proxy(self, proxy):</span><br><span class="line">        <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        测试单个代理</span></span><br><span class="line"><span class="string">        :param proxy: 单个代理</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        conn = aiohttp.TCPConnector(<span class="attribute">verify_ssl</span>=<span class="literal">False</span>)</span><br><span class="line">        async with aiohttp.ClientSession(<span class="attribute">connector</span>=conn) as session:</span><br><span class="line">            try:</span><br><span class="line">                <span class="keyword">if</span> isinstance(proxy, bytes):</span><br><span class="line">                   <span class="built_in"> proxy </span>= proxy.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">                real_proxy = <span class="string">'http://'</span> + proxy</span><br><span class="line">                <span class="builtin-name">print</span>(<span class="string">'正在测试'</span>, proxy)</span><br><span class="line">                async with session.<span class="builtin-name">get</span>(TEST_URL, <span class="attribute">proxy</span>=real_proxy, <span class="attribute">timeout</span>=15) as response:</span><br><span class="line">                    <span class="keyword">if</span> response.status <span class="keyword">in</span> VALID_STATUS_CODES:</span><br><span class="line">                        self.redis.max(proxy)</span><br><span class="line">                        <span class="builtin-name">print</span>(<span class="string">'代理可用'</span>, proxy)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.redis.decrease(proxy)</span><br><span class="line">                        <span class="builtin-name">print</span>(<span class="string">'请求响应码不合法'</span>, proxy)</span><br><span class="line">            except (ClientError, ClientConnectorError, TimeoutError, AttributeError):</span><br><span class="line">                self.redis.decrease(proxy)</span><br><span class="line">                <span class="builtin-name">print</span>(<span class="string">'代理请求失败'</span>, proxy)</span><br><span class="line"></span><br><span class="line">    def <span class="builtin-name">run</span>(self):</span><br><span class="line">        <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        测试主函数</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">'测试器开始运行'</span>)</span><br><span class="line">        try:</span><br><span class="line">            proxies = self.redis.all()</span><br><span class="line">            loop = asyncio.get_event_loop()</span><br><span class="line">            # 批量测试</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(0, len(proxies), BATCH_TEST_SIZE):</span><br><span class="line">                test_proxies = proxies[i:i + BATCH_TEST_SIZE]</span><br><span class="line">                tasks = [self.test_single_proxy(proxy) <span class="keyword">for</span><span class="built_in"> proxy </span><span class="keyword">in</span> test_proxies]</span><br><span class="line">                loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">                time.sleep(5)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'测试器发生错误'</span>, e.args)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里定义了一个类 Tester，<strong>init</strong>() 方法中建立了一个 RedisClient 对象，供类中其他方法使用。接下来定义了一个 test_single_proxy() 方法，用来检测单个代理的可用情况，其参数就是被检测的代理，注意这个方法前面加了 async 关键词，代表这个方法是异步的，方法内部首先创建了 Aiohttp 的 ClientSession 对象，此对象类似于 Requests 的 Session 对象，可以直接调用该对象的 get() 方法来访问页面，在这里代理的设置方式是通过 proxy 参数传递给 get() 方法，请求方法前面也需要加上 async 关键词标明是异步请求，这也是 Aiohttp 使用时的常见写法。 测试的链接在这里定义常量为 TEST_URL，如果针对某个网站有抓取需求，建议将 TEST_URL 设置为目标网站的地址，因为在抓取的过程中，可能代理本身是可用的，但是该代理的 IP 已经被目标网站封掉了。例如，如要抓取知乎，可能其中某些代理是可以正常使用，比如访问百度等页面是完全没有问题的，但是可能对知乎来说可能就被封了，所以可以将 TEST_URL 设置为知乎的某个页面的链接，当请求失败时，当代理被封时，分数自然会减下来，就不会被取到了。 如果想做一个通用的代理池，则不需要专门设置 TEST_URL，可以设置为一个不会封 IP 的网站，也可以设置为百度这类响应稳定的网站。 另外我们还定义了 VALID_STATUS_CODES 变量，是一个列表形式，包含了正常的状态码，如可以定义成 [200]，当然对于某些检测目标网站可能会出现其他的状态码也是正常的，可以自行配置。 获取 Response 后需要判断响应的状态，如果状态码在 VALID_STATUS_CODES 这个列表里，则代表代理可用，调用 RedisClient 的 max() 方法将代理分数设为 100，否则调用 decrease() 方法将代理分数减 1，如果出现异常也同样将代理分数减 1。 另外在测试的时候设置了批量测试的最大值 BATCH_TEST_SIZE 为 100，也就是一批测试最多测试 100个，这可以避免当代理池过大时全部测试导致内存开销过大的问题。 随后在 run() 方法里面获取了所有的代理列表，使用 Aiohttp 分配任务，启动运行，这样就可以进行异步检测了，写法可以参考 Aiohttp 的官方示例：<a href="http://aiohttp.readthedocs.io/" target="_blank" rel="noopener">http://aiohttp.readthedocs.io/</a>。 这样测试模块的逻辑就完成了。</p>
                  <h4 id="接口模块"><a href="#接口模块" class="headerlink" title="接口模块"></a>接口模块</h4>
                  <p>通过上述三个模块我们已经可以做到代理的获取、检测和更新了，数据库中就会以有序集合的形式存储各个代理还有对应的分数，分数 100 代表可用，分数越小代表越不可用。 但是我们怎样来方便地获取可用代理呢？用 RedisClient 类来直接连接 Redis 然后调用 random() 方法获取当然没问题，这样做效率很高，但是有这么几个弊端：</p>
                  <ul>
                    <li>需要知道 Redis 的用户名和密码，如果这个代理池是给其他人使用的就需要告诉他连接的用户名和密码信息，这样是很不安全的。</li>
                    <li>代理池如果想持续运行需要部署在远程服务器上运行，如果远程服务器的 Redis 是只允许本地连接的，那么就没有办法远程直连 Redis 获取代理了。</li>
                    <li>如果爬虫所在的主机没有连接 Redis 的模块，或者爬虫不是由 Python 语言编写的，那么就无法使用 RedisClient 来获取代理了。</li>
                    <li>如果 RedisClient 类或者数据库结构有更新，那么在爬虫端还需要去同步这些更新。</li>
                  </ul>
                  <p>综上考虑，为了使得代理池可以作为一个独立服务运行，我们最好增加一个接口模块，以 Web API 的形式暴露可用代理。 这样获取代理只需要请求一下接口即可，以上的几个缺点弊端可以解决。 我们在这里使用一个比较轻量级的库 Flask 来实现这个接口模块，实现示例如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'app'</span>]</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(g, <span class="string">'redis'</span>):</span><br><span class="line">        g.redis = RedisClient()</span><br><span class="line">    <span class="keyword">return</span> g.redis</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/random')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取随机可用代理</span></span><br><span class="line"><span class="string">    :return: 随机代理</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> conn.random()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/count')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_counts</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取代理池总量</span></span><br><span class="line"><span class="string">    :return: 代理池总量</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> str(conn.count())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们声明了一个 Flask 对象，定义了三个接口，分别是首页、随机代理页、获取数量页。 运行之后 Flask 会启动一个 Web 服务，我们只需要访问对应的接口即可获取到可用代理。</p>
                  <h4 id="调度模块"><a href="#调度模块" class="headerlink" title="调度模块"></a>调度模块</h4>
                  <p>这个模块其实就是调用以上所定义的三个模块，将以上三个模块通过多进程的形式运行起来，示例如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">TESTER_CYCLE = <span class="number">20</span></span><br><span class="line">GETTER_CYCLE = <span class="number">20</span></span><br><span class="line">TESTER_ENABLED = <span class="literal">True</span></span><br><span class="line">GETTER_ENABLED = <span class="literal">True</span></span><br><span class="line">API_ENABLED = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> getter <span class="keyword">import</span> Getter</span><br><span class="line"><span class="keyword">from</span> tester <span class="keyword">import</span> Tester</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">schedule_tester</span><span class="params">(self, cycle=TESTER_CYCLE)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        定时测试代理</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        tester = Tester()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            print(<span class="string">'测试器开始运行'</span>)</span><br><span class="line">            tester.run()</span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">schedule_getter</span><span class="params">(self, cycle=GETTER_CYCLE)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        定时获取代理</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        getter = Getter()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            print(<span class="string">'开始抓取代理'</span>)</span><br><span class="line">            getter.run()</span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">schedule_api</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        开启API</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        app.run(API_HOST, API_PORT)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'代理池开始运行'</span>)</span><br><span class="line">        <span class="keyword">if</span> TESTER_ENABLED:</span><br><span class="line">            tester_process = Process(target=self.schedule_tester)</span><br><span class="line">            tester_process.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> GETTER_ENABLED:</span><br><span class="line">            getter_process = Process(target=self.schedule_getter)</span><br><span class="line">            getter_process.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> API_ENABLED:</span><br><span class="line">            api_process = Process(target=self.schedule_api)</span><br><span class="line">            api_process.start()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里还有三个常量，TESTER_ENABLED、GETTER_ENABLED、API_ENABLED 都是布尔类型，True 或者 False。标明了测试模块、获取模块、接口模块的开关，如果为 True，则代表模块开启。 启动入口是 run() 方法，其分别判断了三个模块的开关，如果开启的话，就新建一个 Process 进程，设置好启动目标，然后调用 start() 方法运行，这样三个进程就可以并行执行，互不干扰。 三个调度方法结构也非常清晰，比如 schedule_tester() 方法，这是用来调度测试模块的方法，首先声明一个 Tester 对象，然后进入死循环不断循环调用其 run() 方法，执行完一轮之后就休眠一段时间，休眠结束之后重新再执行。在这里休眠时间也定义为一个常量，如 20 秒，这样就会每隔 20 秒进行一次代理检测。 最后整个代理池的运行只需要调用 Scheduler 的 run() 方法即可启动。 以上便是整个代理池的架构和相应实现逻辑。</p>
                  <h3 id="5-运行"><a href="#5-运行" class="headerlink" title="5. 运行"></a>5. 运行</h3>
                  <p>接下来我们将代码整合一下，将代理运行起来，运行之后的输出结果如图 9-2 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060356.png" alt=""> 图 9-2 运行结果 以上是代理池的控制台输出，可以看到可用代理设置为 100，不可用代理分数减 1。 接下来我们再打开浏览器，当前配置了运行在 5555 端口，所以打开：<a href="http://127.0.0.1:5555" target="_blank" rel="noopener">http://127.0.0.1:5555</a>，即可看到其首页，如图 9-3 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060403.jpg" alt=""> 图 9-3 首页页面 再访问：<a href="http://127.0.0.1:5555/random" target="_blank" rel="noopener">http://127.0.0.1:5555/random</a>，即可获取随机可用代理，如图 9-4 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-060410.jpg" alt=""> 图 9-4 获取代理页面 所以后面我们只需要访问此接口即可获取一个随机可用代理，非常方便。 获取代理的代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PROXY_POOL_URL = <span class="string">'http://localhost:5555/random'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(PROXY_POOL_URL)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">except</span> ConnectionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>获取下来之后便是一个字符串类型的代理，可以按照上一节所示的方法设置代理，如 Requests 的使用方法如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">proxy = get_proxy()</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line">try:</span><br><span class="line">    response = requests.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>, <span class="attribute">proxies</span>=proxies)</span><br><span class="line">    <span class="builtin-name">print</span>(response.text)</span><br><span class="line">except requests.exceptions.ConnectionError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'Error'</span>, e.args)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>有了代理池之后，我们再取出代理即可有效防止IP被封禁的情况。</p>
                  <h3 id="6-本节代码"><a href="#6-本节代码" class="headerlink" title="6. 本节代码"></a>6. 本节代码</h3>
                  <p>本节代码地址为：<a href="https://github.com/Python3WebSpider/ProxyPool" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool</a>。</p>
                  <h3 id="7-结语"><a href="#7-结语" class="headerlink" title="7. 结语"></a>7. 结语</h3>
                  <p>本节我们实现了一个比较高效的代理池来获取随机可用的代理，整个内容比较多，需要好好理解一下。 在后文我们会利用代理池来实现数据的抓取。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 14:05:09" itemprop="dateCreated datePublished" datetime="2019-08-02T14:05:09+08:00">2019-08-02</time>
                </span>
                <span id="/7048.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 9.2-代理池的维护" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>15k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>13 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7045.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7045.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 9.1-代理的设置</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在前面我们介绍了多种请求库，如 Requests、Urllib、Selenium 等。我们接下来首先贴近实战，了解一下代理怎么使用，为后面了解代理池、ADSL 拨号代理的使用打下基础。 下面我们来梳理一下这些库的代理的设置方法。</p>
                  <h3 id="1-获取代理"><a href="#1-获取代理" class="headerlink" title="1. 获取代理"></a>1. 获取代理</h3>
                  <p>在做测试之前，我们需要先获取一个可用代理，搜索引擎搜索“代理”关键字，就可以看到有许多代理服务网站，在网站上会有很多免费代理，比如西刺：<a href="http://www.xicidaili.com/" target="_blank" rel="noopener">http://www.xicidaili.com/</a>，这里列出了很多免费代理，但是这些免费代理大多数情况下都是不好用的，所以比较靠谱的方法是购买付费代理，很多网站都有售卖，数量不用多，买一个稳定可用的即可，可以自行选购。 或者如果我们本机有相关代理软件的话，软件一般会在本机创建 HTTP 或 SOCKS 代理服务，直接使用此代理也可以。 在这里我的本机安装了一部代理软件，它会在本地 9743 端口上创建 HTTP 代理服务，也就是代理为 127.0.0.1:9743，另外还会在 9742 端口创建 SOCKS 代理服务，也就是代理为 127.0.0.1:9742，我只要设置了这个代理就可以成功将本机 IP 切换到代理软件连接的服务器的 IP了。 所以本节下面的示例里我使用上述代理来演示其设置方法，你可以自行替换成自己的可用代理，设置代理后测试的网址是：<a href="http://httpbin.org/get" target="_blank" rel="noopener">http://httpbin.org/get</a>，访问该站点可以得到请求的一些相关信息，其中 origin 字段就是客户端的 IP，我们可以根据它来判断代理是否设置成功，也就是是否成功伪装了IP。 下面我们来看下各个库的代理设置方式。</p>
                  <h3 id="2-Urllib"><a href="#2-Urllib" class="headerlink" title="2. Urllib"></a>2. Urllib</h3>
                  <p>首先我们以最基础的 Urllib 为例，来看一下代理的设置方法，代码如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> urllib.<span class="builtin-name">error</span> import URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request import ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:9743'</span></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://'</span> + proxy</span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br><span class="line">try:</span><br><span class="line">    response = opener.open(<span class="string">'http://httpbin.org/get'</span>)</span><br><span class="line">    <span class="builtin-name">print</span>(response.read().decode(<span class="string">'utf-8'</span>))</span><br><span class="line">except URLError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(e.reason)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"identity"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Python-urllib/3.6"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.185.45.153"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们需要借助于 ProxyHandler 设置代理，参数是字典类型，键名为协议类型，键值是代理，注意此处代理前面需要加上协议，即 http 或者 https，此处设置了 http 和 https 两种代理，当我们请求的链接是 http 协议的时候，它会调用 http 代理，当请求的链接是 https 协议的时候，它会调用https代理，所以此处生效的代理是：<a href="http://127.0.0.1:9743" target="_blank" rel="noopener">http://127.0.0.1:9743</a>。 创建完 ProxyHandler 对象之后，我们需要利用 build_opener() 方法传入该对象来创建一个 Opener，这样就相当于此 Opener 已经设置好代理了，接下来直接调用它的 open() 方法即可使用此代理访问我们所想要的链接。 运行输出结果是一个 Json，它有一个字段 origin，标明了客户端的 IP，此处的 IP 验证一下，确实为代理的 IP，而并不是我们真实的 IP，所以这样我们就成功设置好代理，并可以隐藏真实 IP 了。 如果遇到需要认证的代理，我们可以用如下的方法设置：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> urllib.<span class="builtin-name">error</span> import URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request import ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'username:password@127.0.0.1:9743'</span></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://'</span> + proxy</span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br><span class="line">try:</span><br><span class="line">    response = opener.open(<span class="string">'http://httpbin.org/get'</span>)</span><br><span class="line">    <span class="builtin-name">print</span>(response.read().decode(<span class="string">'utf-8'</span>))</span><br><span class="line">except URLError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(e.reason)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里改变的只是 proxy 变量，只需要在代理前面加入代理认证的用户名密码即可，其中 username 就是用户名，password 为密码，例如 username 为foo，密码为 bar，那么代理就是 foo:bar@127.0.0.1:9743。 如果代理是 SOCKS5 类型，那么可以用如下方式设置代理：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import socks</span><br><span class="line">import socket</span><br><span class="line"><span class="keyword">from</span> urllib import request</span><br><span class="line"><span class="keyword">from</span> urllib.<span class="builtin-name">error</span> import URLError</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">'127.0.0.1'</span>, 9742)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line">try:</span><br><span class="line">    response = request.urlopen(<span class="string">'http://httpbin.org/get'</span>)</span><br><span class="line">    <span class="builtin-name">print</span>(response.read().decode(<span class="string">'utf-8'</span>))</span><br><span class="line">except URLError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(e.reason)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>此处需要一个 Socks 模块，可以通过如下命令安装：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> PySocks</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>本地我有一个 SOCKS5 代理，运行在 9742 端口，运行成功之后和上文 HTTP 代理输出结果是一样的：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"identity"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Python-urllib/3.6"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.185.45.153"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果的 origin 字段同样为代理的 IP，设置代理成功。</p>
                  <h3 id="3-Requests"><a href="#3-Requests" class="headerlink" title="3. Requests"></a>3. Requests</h3>
                  <p>对于 Requests 来说，代理设置更加简单，我们只需要传入 proxies 参数即可。 还是以上例中的代理为例，我们来看下 Requests 的代理的设置：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:9743'</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line">try:</span><br><span class="line">    response = requests.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>, <span class="attribute">proxies</span>=proxies)</span><br><span class="line">    <span class="builtin-name">print</span>(response.text)</span><br><span class="line">except requests.exceptions.ConnectionError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'Error'</span>, e.args)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"*/*"</span>, </span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"python-requests/2.18.1"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.185.45.153"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现 Requests 的代理设置比 Urllib 简单很多，只需要构造代理字典即可，然后通过 proxies 参数即可设置代理，不需要重新构建 Opener。 可以发现其运行结果的 origin 也是代理的 IP，证明代理已经设置成功。 如果代理需要认证，同样在代理的前面加上用户名密码即可，代理的写法就变成：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">proxy</span> = <span class="string">'username:password@127.0.0.1:9743'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>和 Urllib 一样，只需要将 username 和 password 替换即可。 如果需要使用 SOCKS5 代理，则可以使用如下方式：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:9742'</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'socks5://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'socks5://'</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line">try:</span><br><span class="line">    response = requests.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>, <span class="attribute">proxies</span>=proxies)</span><br><span class="line">    <span class="builtin-name">print</span>(response.text)</span><br><span class="line">except requests.exceptions.ConnectionError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'Error'</span>, e.args)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里需要额外安装一个 Socks 模块，命令如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> <span class="string">"requests[socks]"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果是完全相同的：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"*/*"</span>, </span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"python-requests/2.18.1"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.185.45.153"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外还有一种设置方式，和 Urllib 中的方法相同，使用 socks 模块，也需要像上文一样安装该库，设置方法如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line">import socks</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">'127.0.0.1'</span>, 9742)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line">try:</span><br><span class="line">    response = requests.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>)</span><br><span class="line">    <span class="builtin-name">print</span>(response.text)</span><br><span class="line">except requests.exceptions.ConnectionError as e:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'Error'</span>, e.args)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样也可以设置 SOCKS5 代理，运行结果完全相同，相比第一种方法，此方法是全局设置，不同情况可以选用不同的方法。</p>
                  <h3 id="4-Selenium"><a href="#4-Selenium" class="headerlink" title="4. Selenium"></a>4. Selenium</h3>
                  <p>Selenium 同样也可以设置代理，在这里分两种介绍，一个是有界面浏览器，以 Chrome 为例介绍，另一种是无界面浏览器，以 PhantomJS 为例介绍。</p>
                  <h4 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h4>
                  <p>对于 Chrome 来说，用 Selenium 设置代理的方法也非常简单，设置方法如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> selenium import webdriver</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:9743'</span></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">'--proxy-server=http://'</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(<span class="attribute">chrome_options</span>=chrome_options)</span><br><span class="line">browser.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们通过 ChromeOptions 来设置代理，在创建 Chrome 对象的时候通过 chrome_options 参数传递即可。 这样在运行之后便会弹出一个 Chrome 浏览器，访问目标链接之后输出结果如下：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8"</span>, </span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, </span><br><span class="line">    <span class="attr">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.8"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.185.45.153"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到 origin 同样为代理 IP 的地址，代理设置成功。 如果代理是认证代理，则设置方法相对比较麻烦，方法如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> selenium import webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options import Options</span><br><span class="line">import zipfile</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = 9743</span><br><span class="line">username = <span class="string">'foo'</span></span><br><span class="line">password = <span class="string">'bar'</span></span><br><span class="line"></span><br><span class="line">manifest_json = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "</span>version<span class="string">": "</span>1.0.0<span class="string">",</span></span><br><span class="line"><span class="string">    "</span>manifest_version<span class="string">": 2,</span></span><br><span class="line"><span class="string">    "</span>name<span class="string">": "</span>Chrome Proxy<span class="string">",</span></span><br><span class="line"><span class="string">    "</span>permissions<span class="string">": [</span></span><br><span class="line"><span class="string">        "</span>proxy<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>tabs<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>unlimitedStorage<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>storage<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>&lt;all_urls&gt;<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>webRequest<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>webRequestBlocking<span class="string">"</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "</span>background<span class="string">": &#123;</span></span><br><span class="line"><span class="string">        "</span>scripts<span class="string">": ["</span>background.js<span class="string">"]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">background_js = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">var config = &#123;</span></span><br><span class="line"><span class="string">        mode: "</span>fixed_servers<span class="string">",</span></span><br><span class="line"><span class="string">        rules: &#123;</span></span><br><span class="line"><span class="string">          singleProxy: &#123;</span></span><br><span class="line"><span class="string">            scheme: "</span>http<span class="string">",</span></span><br><span class="line"><span class="string">            host: "</span>%(ip)s<span class="string">",</span></span><br><span class="line"><span class="string">            port: %(port)s</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.proxy.settings.set(&#123;value: config, scope: "</span>regular<span class="string">"&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">        authCredentials: &#123;</span></span><br><span class="line"><span class="string">            username: "</span>%(username)s<span class="string">",</span></span><br><span class="line"><span class="string">            password: "</span>%(password)s<span class="string">"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">            callbackFn,</span></span><br><span class="line"><span class="string">            &#123;urls: ["</span>&lt;all_urls&gt;<span class="string">"]&#125;,</span></span><br><span class="line"><span class="string">            ['blocking']</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span> % &#123;<span class="string">'ip'</span>: ip, <span class="string">'port'</span>: port, <span class="string">'username'</span>: username, <span class="string">'password'</span>: password&#125;</span><br><span class="line"></span><br><span class="line">plugin_file = <span class="string">'proxy_auth_plugin.zip'</span></span><br><span class="line">with zipfile.ZipFile(plugin_file, <span class="string">'w'</span>) as zp:</span><br><span class="line">    zp.writestr(<span class="string">"manifest.json"</span>, manifest_json)</span><br><span class="line">    zp.writestr(<span class="string">"background.js"</span>, background_js)</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">"--start-maximized"</span>)</span><br><span class="line">chrome_options.add_extension(plugin_file)</span><br><span class="line">browser = webdriver.Chrome(<span class="attribute">chrome_options</span>=chrome_options)</span><br><span class="line">browser.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里需要在本地创建一个 manifest.json 配置文件和 background.js 脚本来设置认证代理，运行之后本地会生成一个 proxy_auth_plugin.zip 文件保存配置。 运行结果和上例一致，origin 同样为代理 IP。</p>
                  <h4 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h4>
                  <p>对于 PhantomJS，代理设置方法可以借助于 service_args 参数，也就是命令行参数，代理设置方法如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> selenium import webdriver</span><br><span class="line"></span><br><span class="line">service_args = [</span><br><span class="line">    <span class="string">'--proxy=127.0.0.1:9743'</span>,</span><br><span class="line">    <span class="string">'--proxy-type=http'</span></span><br><span class="line">]</span><br><span class="line">browser = webdriver.PhantomJS(<span class="attribute">service_args</span>=service_args)</span><br><span class="line">browser.<span class="builtin-name">get</span>(<span class="string">'http://httpbin.org/get'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(browser.page_source)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们只需要使用 service_args 参数，将命令行的一些参数定义为列表，在初始化的时候传递即可。 运行结果：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>, </span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, </span><br><span class="line">    <span class="attr">"Accept-Language"</span>: <span class="string">"zh-CN,en,*"</span>, </span><br><span class="line">    <span class="attr">"Connection"</span>: <span class="string">"close"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.0 Safari/538.1"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.185.45.153"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果的 origin 同样为代理的 IP，设置代理成功。 如果需要认证，那么只需要再加入 —proxy-auth 选项即可，这样参数就改为：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">service_args</span> = [</span><br><span class="line">    <span class="string">'--proxy=127.0.0.1:9743'</span>,</span><br><span class="line">    <span class="string">'--proxy-type=http'</span>,</span><br><span class="line">    <span class="string">'--proxy-auth=username:password'</span></span><br><span class="line">]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>将 username 和 password 替换为认证所需的用户名和密码即可。</p>
                  <h3 id="5-本节代码"><a href="#5-本节代码" class="headerlink" title="5. 本节代码"></a>5. 本节代码</h3>
                  <p>本节代码地址为：<a href="https://github.com/Python3WebSpider/ProxySettings" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxySettings</a>。</p>
                  <h3 id="6-结语"><a href="#6-结语" class="headerlink" title="6. 结语"></a>6. 结语</h3>
                  <p>本节介绍了前文所介绍的请求库的代理设置方法，稍作了解即可，后面我们会使用这些方法来搭建代理池和爬取网站，进一步加深印象。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 14:03:32" itemprop="dateCreated datePublished" datetime="2019-08-02T14:03:32+08:00">2019-08-02</time>
                </span>
                <span id="/7045.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 9.1-代理的设置" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>8.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7043.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7043.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 9-代理的使用</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>我们在做爬虫的过程中经常会遇到这样的情况，最初爬虫正常运行，正常抓取数据，一切看起来都是那么的美好，然而一杯茶的功夫可能就会出现错误，比如 403 Forbidden，这时候打开网页一看，可能会看到“您的 IP 访问频率太高”这样的提示，或者跳出一个验证码让我们输入，输入之后才可能解封，但是输入之后过一会儿就又这样了。 出现这样的现象的原因是网站采取了一些反爬虫的措施，比如服务器会检测某个 IP 在单位时间内的请求次数，如果超过了这个阈值，那么会直接拒绝服务，返回一些错误信息，这种情况可以称之为封 IP，于是乎就成功把我们的爬虫禁掉了。 既然服务器检测的是某个 IP 单位时间的请求次数，那么我们借助某种方式来伪装我们的 IP，让服务器识别不出是由我们本机发起的请求，不就可以成功防止封 IP 了吗？ 所以这时候代理就派上用场了，本章我们会详细介绍一下代理的基本知识及各种代理的使用方式，帮助爬虫脱离封 IP 的苦海。 本章接下来会介绍代理的设置、代理池的维护、付费代理的使用、ADSL拨号代理的搭建方法。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 14:02:17" itemprop="dateCreated datePublished" datetime="2019-08-02T14:02:17+08:00">2019-08-02</time>
                </span>
                <span id="/7043.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 9-代理的使用" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>438</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7041.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7041.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 8.4-微博宫格验证码的识别</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节我们来介绍一下新浪微博宫格验证码的识别，此验证码是一种新型交互式验证码，每个宫格之间会有一条指示连线，指示了我们应该的滑动轨迹，我们需要按照滑动轨迹依次从起始宫格一直滑动到终止宫格才可以完成验证，如图 8-24 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055351.png" alt=""> 图 8-24 验证码示例 鼠标滑动后的轨迹会以黄色的连线来标识，如图 8-25 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055407.jpg" alt=""> 图 8-25 滑动过程 我们可以访问新浪微博移动版登录页面就可以看到如上验证码，链接为：<a href="https://passport.weibo.cn/signin/login" target="_blank" rel="noopener">https://passport.weibo.cn/signin/login</a>，当然也不是每次都会出现验证码，一般当频繁登录或者账号存在安全风险的时候会出现。 接下来我们就来试着识别一下此类验证码。</p>
                  <h3 id="1-本节目标"><a href="#1-本节目标" class="headerlink" title="1. 本节目标"></a>1. 本节目标</h3>
                  <p>本节我们的目标是用程序来识别并通过微博宫格验证码的验证。</p>
                  <h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h3>
                  <p>本次我们使用的 Python 库是 Selenium，使用的浏览器为 Chrome，在此之前请确保已经正确安装好了 Selenium 库、Chrome浏览器并配置好了 ChromeDriver，相关流程可以参考第一章的说明。</p>
                  <h3 id="3-识别思路"><a href="#3-识别思路" class="headerlink" title="3. 识别思路"></a>3. 识别思路</h3>
                  <p>要识别首先要从探寻规律入手，那么首先我们找到的规律就是此验证码的四个宫格一定是有连线经过的，而且每一条连线上都会相应的指示箭头，连线的形状多样，如C型、Z型、X型等等，如图 8-26、8-27、8-28 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055423.png" alt=""> 图 8-26 C 型 <img src="https://qiniu.cuiqingcai.com/2019-08-02-055430.png" alt=""> 图 8-27 Z 型 <img src="https://qiniu.cuiqingcai.com/2019-08-02-055434.png" alt=""> 图 8-28 X 型 而同时我们发现同一种类型它的连线轨迹是相同的，唯一不同的就是连线的方向，如图 8-29、8-30 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055441.png" alt=""> 图 8-29 反向连线 <img src="https://qiniu.cuiqingcai.com/2019-08-02-055457.png" alt=""> 图 8-30 正向连线 这两种验证码的连线轨迹是相同的，但是由于连线上面的指示箭头不同导致滑动的宫格顺序就有所不同。 所以要完全识别滑动宫格顺序的话就需要具体识别出箭头的朝向，而观察一下整个验证码箭头朝向一共可能有 8 种，而且会出现在不同的位置，如果要写一个箭头方向识别算法的话需要都考虑到不同箭头所在的位置，我们需要找出各个位置的箭头的像素点坐标，同时识别算法还需要计算其像素点变化规律，这个工作量就变得比较大。 这时我们可以考虑用模板匹配的方法，模板匹配的意思就是将一些识别目标提前保存下来并做好标记，称作模板，在这里我们就可以获取验证码图片并做好拖动顺序的标记当做模板。在匹配的时候来对比要新识别的目标和每一个模板哪个是匹配的，如果找到匹配的模板，则被匹配到的模板就和新识别的目标是相同的，这样就成功识别出了要新识别的目标了。模板匹配在图像识别中也是非常常用的一种方法，实现简单而且易用性好。 模板匹配方法如果要效果好的话，我们必须要收集到足够多的模板才可以，而对于微博宫格验证码来说，宫格就 4 个，验证码的样式最多就是 4 <em> 3 </em> 2 * 1 = 24种，所以我们可以直接将所有模板都收集下来。 所以接下来我们需要考虑的就是用何种模板来进行匹配，是只匹配箭头还是匹配整个验证码全图呢？我们来权衡一下这两种方式的匹配精度和工作量：</p>
                  <ul>
                    <li>首先是精度问题。如果要匹配箭头的话，我们比对的目标只有几个像素点范围的箭头，而且我们需要精确知道各个箭头所在的像素点，一旦像素点有所偏差，那么匹配模板的时候会直接错位，导致匹配结果大打折扣。如果匹配全图，我们无需关心箭头所在位置，同时还有连线帮助辅助匹配，所以匹配精度上显然是全图匹配精度更高。</li>
                    <li>其次是工作量的问题。如果要匹配箭头的话，我们需要将所有不同朝向的箭头模板都保存下来，而相同位置箭头的朝向可能不一，相同朝向的箭头位置可能不一，这时候我们需要都算出各个箭头的位置并将其逐个截出来保存成模板，同时在匹配的时候也需要依次去探寻验证码对应位置是否有匹配模板。如果匹配全图的话，我们不需要关心每个箭头的位置和朝向，只需要将验证码全图保存下来即可，在匹配的时候也不需要再去计算箭头的位置，所以工作量上明显是匹配全图更小。</li>
                  </ul>
                  <p>所以综上考虑，我们选用全图匹配的方式来进行识别。 所以到此为止，我们就可以使用全图模板匹配的方法来识别这个宫格验证码了，找到匹配的模板之后，我们就可以得到事先为模板定义的拖动顺序，然后模拟拖动即可。</p>
                  <h3 id="4-获取模板"><a href="#4-获取模板" class="headerlink" title="4. 获取模板"></a>4. 获取模板</h3>
                  <p>在开始之前，我们需要做一下准备工作，先将 24 张验证码全图保存下来，保存工作难道需要手工来做吗？当然不是的，因为验证码是随机的，一共有 24 种，所以我们可以写一段程序来批量保存一些验证码图片，然后从中筛选出需要的图片就好了，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">''</span></span><br><span class="line">PASSWORD = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CrackWeiboSlide</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'https://passport.weibo.cn/signin/login'</span></span><br><span class="line">        self.browser = webdriver.Chrome()</span><br><span class="line">        self.wait = WebDriverWait(self.browser, <span class="number">20</span>)</span><br><span class="line">        self.username = USERNAME</span><br><span class="line">        self.password = PASSWORD</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.browser.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        打开网页输入用户名密码并点击</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.browser.get(self.url)</span><br><span class="line">        username = self.wait.until(EC.presence_of_element_located((By.ID, <span class="string">'loginName'</span>)))</span><br><span class="line">        password = self.wait.until(EC.presence_of_element_located((By.ID, <span class="string">'loginPassword'</span>)))</span><br><span class="line">        submit = self.wait.until(EC.element_to_be_clickable((By.ID, <span class="string">'loginAction'</span>)))</span><br><span class="line">        username.send_keys(self.username)</span><br><span class="line">        password.send_keys(self.password)</span><br><span class="line">        submit.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_position</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取验证码位置</span></span><br><span class="line"><span class="string">        :return: 验证码位置元组</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            img = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">'patt-shadow'</span>)))</span><br><span class="line">        <span class="keyword">except</span> TimeoutException:</span><br><span class="line">            print(<span class="string">'未出现验证码'</span>)</span><br><span class="line">            self.open()</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        location = img.location</span><br><span class="line">        size = img.size</span><br><span class="line">        top, bottom, left, right = location[<span class="string">'y'</span>], location[<span class="string">'y'</span>] + size[<span class="string">'height'</span>], location[<span class="string">'x'</span>], location[<span class="string">'x'</span>] + size[<span class="string">'width'</span>]</span><br><span class="line">        <span class="keyword">return</span> (top, bottom, left, right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_screenshot</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取网页截图</span></span><br><span class="line"><span class="string">        :return: 截图对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        screenshot = self.browser.get_screenshot_as_png()</span><br><span class="line">        screenshot = Image.open(BytesIO(screenshot))</span><br><span class="line">        <span class="keyword">return</span> screenshot</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_image</span><span class="params">(self, name=<span class="string">'captcha.png'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取验证码图片</span></span><br><span class="line"><span class="string">        :return: 图片对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        top, bottom, left, right = self.get_position()</span><br><span class="line">        print(<span class="string">'验证码位置'</span>, top, bottom, left, right)</span><br><span class="line">        screenshot = self.get_screenshot()</span><br><span class="line">        captcha = screenshot.crop((left, top, right, bottom))</span><br><span class="line">        captcha.save(name)</span><br><span class="line">        <span class="keyword">return</span> captcha</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        批量获取验证码</span></span><br><span class="line"><span class="string">        :return: 图片对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            self.open()</span><br><span class="line">            self.get_image(str(count) + <span class="string">'.png'</span>)</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    crack = CrackWeiboSlide()</span><br><span class="line">    crack.main()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其中这里需要将 USERNAME 和 PASSWORD 修改为自己微博的用户名密码，运行一段时间后便可以发现在本地多了很多以数字命名的验证码，如图 8-31 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055514.jpg" alt=""> 图 8-31 获取结果 在这里我们只需要挑选出不同的24张验证码图片并命名保存就好了，名称可以直接取作宫格的滑动的顺序，如某张验证码图片如图 8-32 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055525.png" alt=""> 图 8-32 验证码示例 我们将其命名为 4132.png 即可，也就是代表滑动顺序为 4-1-3-2，按照这样的规则，我们将验证码整理为如下 24 张图，如图 8-33 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055531.jpg" alt=""> 图 8-33 整理结果 如上的 24 张图就是我们的模板，接下来我们在识别的时候只需要遍历模板进行匹配即可。</p>
                  <h3 id="5-模板匹配"><a href="#5-模板匹配" class="headerlink" title="5. 模板匹配"></a>5. 模板匹配</h3>
                  <p>上面的代码已经实现了将验证码保存下来的功能，通过调用 get_image() 方法我们便可以得到验证码图片对象，得到验证码对象之后我们就需要对其进行模板匹配了，定义如下的方法进行匹配：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detect_image</span><span class="params">(self, image)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    匹配图片</span></span><br><span class="line"><span class="string">    :param image: 图片</span></span><br><span class="line"><span class="string">    :return: 拖动顺序</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> template_name <span class="keyword">in</span> listdir(TEMPLATES_FOLDER):</span><br><span class="line">        print(<span class="string">'正在匹配'</span>, template_name)</span><br><span class="line">        template = Image.open(TEMPLATES_FOLDER + template_name)</span><br><span class="line">        <span class="keyword">if</span> self.same_image(image, template):</span><br><span class="line">            <span class="comment"># 返回顺序</span></span><br><span class="line">            numbers = [int(number) <span class="keyword">for</span> number <span class="keyword">in</span> list(template_name.split(<span class="string">'.'</span>)[<span class="number">0</span>])]</span><br><span class="line">            print(<span class="string">'拖动顺序'</span>, numbers)</span><br><span class="line">            <span class="keyword">return</span> numbers</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里 TEMPLATES_FOLDER 就是模板所在的文件夹，在这里我们用 listdir() 方法将所有模板的文件名称获取出来，然后对其进行遍历，通过 same_image() 方法对验证码和模板进行比对，如果成功匹配，那么就将匹配到的模板文件名转为列表，如匹配到了 3124.png，则返回结果 [3, 1, 2, 4]。 比对的方法实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_pixel_equal</span><span class="params">(self, image1, image2, x, y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    判断两个像素是否相同</span></span><br><span class="line"><span class="string">    :param image1: 图片1</span></span><br><span class="line"><span class="string">    :param image2: 图片2</span></span><br><span class="line"><span class="string">    :param x: 位置x</span></span><br><span class="line"><span class="string">    :param y: 位置y</span></span><br><span class="line"><span class="string">    :return: 像素是否相同</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 取两个图片的像素点</span></span><br><span class="line">    pixel1 = image1.load()[x, y]</span><br><span class="line">    pixel2 = image2.load()[x, y]</span><br><span class="line">    threshold = <span class="number">20</span></span><br><span class="line">    <span class="keyword">if</span> abs(pixel1[<span class="number">0</span>] - pixel2[<span class="number">0</span>]) &lt; threshold <span class="keyword">and</span> abs(pixel1[<span class="number">1</span>] - pixel2[<span class="number">1</span>]) &lt; threshold <span class="keyword">and</span> abs(</span><br><span class="line">            pixel1[<span class="number">2</span>] - pixel2[<span class="number">2</span>]) &lt; threshold:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">same_image</span><span class="params">(self, image, template)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    识别相似验证码</span></span><br><span class="line"><span class="string">    :param image: 待识别验证码</span></span><br><span class="line"><span class="string">    :param template: 模板</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 相似度阈值</span></span><br><span class="line">    threshold = <span class="number">0.99</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(image.width):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> range(image.height):</span><br><span class="line">            <span class="comment"># 判断像素是否相同</span></span><br><span class="line">            <span class="keyword">if</span> self.is_pixel_equal(image, template, x, y):</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">    result = float(count) / (image.width * image.height)</span><br><span class="line">    <span class="keyword">if</span> result &gt; threshold:</span><br><span class="line">        print(<span class="string">'成功匹配'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里比对图片也是利用了遍历像素的方法，same_image() 方法接收两个参数，image 为待检测的验证码图片对象，template 是模板对象，由于二者大小是完全一致的，所以在这里我们遍历了图片的所有像素点，比对二者同一位置的像素点是否相同，如果相同就计数加 1，最后计算一下相同的像素点占总像素的比例，如果该比例超过一定阈值那就判定为图片完全相同，匹配成功。在这里设定阈值为 0.99，即如果二者有 0.99 以上的相似比则代表匹配成功。 这样通过上面的方法，依次匹配 24 个模板，如果验证码图片正常，总能找到一个匹配的模板，这样最后就可以得到宫格的滑动顺序了。</p>
                  <h3 id="6-模拟拖动"><a href="#6-模拟拖动" class="headerlink" title="6. 模拟拖动"></a>6. 模拟拖动</h3>
                  <p>得到了滑动顺序之后，我们接下来就是根据滑动顺序来拖动鼠标连接各个宫格了，方法实现如下：</p>
                  <figure class="highlight perl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def move(self, numbers):</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    根据顺序拖动</span></span><br><span class="line"><span class="string">    :param numbers:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    <span class="comment"># 获得四个按点</span></span><br><span class="line">    circles = self.browser.find_elements_by_css_selector(<span class="string">'.patt-wrap .patt-circ'</span>)</span><br><span class="line">    dx = dy = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">index</span> in range(<span class="number">4</span>):</span><br><span class="line">        circle = circles[numbers[<span class="keyword">index</span>] - <span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 如果是第一次循环</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">index</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 点击第一个按点</span></span><br><span class="line">            ActionChains(self.browser) </span><br><span class="line">                .move_to_element_with_offset(circle, circle.size[<span class="string">'width'</span>] / <span class="number">2</span>, circle.size[<span class="string">'height'</span>] / <span class="number">2</span>) </span><br><span class="line">                .click_and_hold().perform()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 小幅移动次数</span></span><br><span class="line">            <span class="keyword">times</span> = <span class="number">30</span></span><br><span class="line">            <span class="comment"># 拖动</span></span><br><span class="line">            <span class="keyword">for</span> i in range(<span class="keyword">times</span>):</span><br><span class="line">                ActionChains(self.browser).move_by_offset(dx / <span class="keyword">times</span>, dy / <span class="keyword">times</span>).perform()</span><br><span class="line">                time.sleep(<span class="number">1</span> / <span class="keyword">times</span>)</span><br><span class="line">        <span class="comment"># 如果是最后一次循环</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">index</span> == <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># 松开鼠标</span></span><br><span class="line">            ActionChains(self.browser).release().perform()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 计算下一次偏移</span></span><br><span class="line">            dx = circles[numbers[<span class="keyword">index</span> + <span class="number">1</span>] - <span class="number">1</span>].location[<span class="string">'x'</span>] - circle.location[<span class="string">'x'</span>]</span><br><span class="line">            dy = circles[numbers[<span class="keyword">index</span> + <span class="number">1</span>] - <span class="number">1</span>].location[<span class="string">'y'</span>] - circle.location[<span class="string">'y'</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里方法接收的参数就是宫格的点按顺序，如 [3, 1, 2, 4]。首先我们利用 find_elements_by_css_selector() 方法获取到四个宫格元素，是一个列表形式，每个元素代表一个宫格，接下来我们遍历了宫格的点按顺序，再做一系列对应操作。 其中如果是第一个宫格，那就直接鼠标点击并保持动作，否则移动到下一个宫格。如果是最后一个宫格，那就松开鼠标，否则计算移动到下一个宫格的偏移量。 通过四次循环，我们便可以成功操作浏览器完成宫格验证码的拖拽填充，松开鼠标之后即可识别成功。 运行效果如图 8-34 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055449.png" alt=""> 图 8-34 运行效果 鼠标会慢慢的从起始位置移动到终止位置，最后一个宫格松开之后便完成了验证码的识别。 至此，微博宫格验证码的识别就全部完成了。 识别完成之后验证码窗口会自动关闭，接下来直接点击登录按钮即可完成微博登录。</p>
                  <h3 id="7-本节代码"><a href="#7-本节代码" class="headerlink" title="7. 本节代码"></a>7. 本节代码</h3>
                  <p>本节代码地址为：<a href="https://github.com/Python3WebSpider/CrackWeiboSlide" target="_blank" rel="noopener">https://github.com/Python3WebSpider/CrackWeiboSlide</a>。</p>
                  <h3 id="8-结语"><a href="#8-结语" class="headerlink" title="8. 结语"></a>8. 结语</h3>
                  <p>本节我们介绍了一种常用的模板匹配识别图片的方式来识别验证码，并模拟了鼠标拖拽动作来实现验证码的识别。如果遇到类似的验证码，可以采用同样的思路进行识别。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 13:56:40" itemprop="dateCreated datePublished" datetime="2019-08-02T13:56:40+08:00">2019-08-02</time>
                </span>
                <span id="/7041.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 8.4-微博宫格验证码的识别" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7039.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7039.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 8.3-点触点选验证码的识别</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>上一节我们实现了极验验证码的识别，但是除了极验其实还有另一种常见的且应用广泛的验证码，比较有代表性的就是点触验证码。 可能你对这个名字比较陌生，但是肯定见过类似的验证码，比如 12306，这就是一种典型的点触验证码，如图 8-18 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055135.jpg" alt=""> 图 8-18 12306 验证码 我们需要直接点击图中符合要求的图，如果所有答案均正确才会验证成功，如果有一个答案错误，验证就会失败，这种验证码就可以称之为点触验证码。 另外还有一个专门提供点触验证码服务的站点，叫做 TouClick，其官方网站为：<a href="https://www.touclick.com/" target="_blank" rel="noopener">https://www.touclick.com/</a>，本节就以它为例讲解一下此类验证码的识别过程。</p>
                  <h3 id="1-本节目标"><a href="#1-本节目标" class="headerlink" title="1. 本节目标"></a>1. 本节目标</h3>
                  <p>本节我们的目标是用程序来识别并通过点触验证码的验证。</p>
                  <h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h3>
                  <p>本次我们使用的 Python 库是 Selenium，使用的浏览器为 Chrome，在此之前请确保已经正确安装好了 Selenium 库、Chrome浏览器并配置好了 ChromeDriver，相关流程可以参考第一章的说明。</p>
                  <h3 id="3-了解点触验证码"><a href="#3-了解点触验证码" class="headerlink" title="3. 了解点触验证码"></a>3. 了解点触验证码</h3>
                  <p>TouClick 官方网站的验证码样式如图 8-19 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055138.jpg" alt=""> 图 8-19 验证码样式 和 12306 站点有相似之处，不过这次是点击图片中的文字，不是图片了，另外还有各种形形色色的点触验证码，其交互形式可能略有不同，但基本原理都是类似的。 接下来我们就来统一实现一下此类点触验证码的识别过程。</p>
                  <h3 id="4-识别思路"><a href="#4-识别思路" class="headerlink" title="4. 识别思路"></a>4. 识别思路</h3>
                  <p>此种验证码的如果依靠图像识别的话识别难度非常之大。 例如就 12306 来说，其识别难点有两个点，第一点是文字识别，如图 8-20 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055142.jpg" alt=""> 图 8-20 12306 验证码 如点击图中所有的漏斗，“漏斗”二字其实都经过变形、放缩、模糊处理了，如果要借助于前面我们讲的 OCR 技术来识别，识别的精准度会大打折扣，甚至得不到任何结果。第二点是图像的识别，我们需要将图像重新转化文字，可以借助于各种识图接口，可经我测试识别正确结果的准确率非常低，经常会出现匹配不正确或匹配不出结果的情况，而且图片本身的的清晰度也不够，所以识别难度会更大，更何况需要同时识别出八张图片的结果，且其中几个答案需要完全匹配正确才能验证通过，综合来看，此种方法基本是不可行的。 再拿 TouClick 来说，如图 8-21 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055147.jpg" alt=""> 图 8-21 验证码示例 我们需要从这幅图片中识别出植株二字，但是图片的背景或多或少会有干扰，导致 OCR 几乎不会识别出结果，有人会说，直接识别白色的文字不就好了吗？但是如果换一张验证码呢？如图 8-22 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055153.jpg" alt=""> 图 8-22 验证码示例 这张验证码图片的文字又变成了蓝色，而且还又有白色阴影，识别的难度又会大大增加。 那么此类验证码就没法解了吗？答案当然是有，靠什么？靠人。 靠人解决？那还要程序做什么？不要急，这里说的人并不是我们自己去解，在互联网上存在非常多的验证码服务平台，平台 7x24 小时提供验证码识别服务，一张图片几秒就会获得识别结果，准确率可达 90% 以上，但是就需要花点钱来购买服务了，毕竟平台都是需要盈利的，不过不用担心，识别一个验证码只需要几分钱。 在这里我个人比较推荐的一个平台是超级鹰，其官网为：<a href="https://www.chaojiying.com" target="_blank" rel="noopener">https://www.chaojiying.com</a>，非广告。 其提供的服务种类非常广泛，可识别的验证码类型非常多，其中就包括此类点触验证码。 另外超级鹰平台同样支持简单的图形验证码识别，如果 OCR 识别有难度，同样可以用本节相同的方法借助此平台来识别，下面是此平台提供的一些服务：</p>
                  <ul>
                    <li>英文数字，提供最多20位英文数字的混合识别</li>
                    <li>中文汉字，提供最多7个汉字的识别</li>
                    <li>纯英文，提供最多12位的英文的识别</li>
                    <li>纯数字，提供最多11位的数字的识别</li>
                    <li>任意特殊字符，提供不定长汉字英文数字、拼音首字母、计算题、成语混合、 集装箱号等字符的识别</li>
                    <li>坐标选择识别，如复杂计算题、选择题四选一、问答题、点击相同的字、物品、动物等返回多个坐标的识别</li>
                  </ul>
                  <p>具体如有变动以官网为准：<a href="https://www.chaojiying.com/price.html" target="_blank" rel="noopener">https://www.chaojiying.com/price.html</a>。 而本节我们需要解决的就是属于最后一类，坐标多选识别的情况，我们需要做的就是将验证码图片提交给平台，然后平台会返回识别结果在图片中的坐标位置，接下来我们再解析坐标模拟点击就好了。 原理非常简单，下面我们就来实际用程序来实验一下。</p>
                  <h3 id="5-注册账号"><a href="#5-注册账号" class="headerlink" title="5. 注册账号"></a>5. 注册账号</h3>
                  <p>在开始之前，我们需要先注册一个超级鹰账号并申请一个软件ID，注册页面链接为：<a href="https://www.chaojiying.com/user/reg/" target="_blank" rel="noopener">https://www.chaojiying.com/user/reg/</a>，注册完成之后还需要在后台开发商中心添加一个软件ID，最后一件事就是充值一些题分，充值多少可以根据价格和识别量自行决定。</p>
                  <h3 id="6-获取API"><a href="#6-获取API" class="headerlink" title="6. 获取API"></a>6. 获取API</h3>
                  <p>做好上面的准备工作之后我们就可以开始用程序来对接验证码的识别了。 首先我们可以到官方网站下载对应的 Python API，链接为：<a href="https://www.chaojiying.com/api-14.html" target="_blank" rel="noopener">https://www.chaojiying.com/api-14.html</a>，但是此 API 是Python2 版本的，是用 Requests 库来实现的，我们可以简单更改几个地方即可将其修改为 Python3 版本。 修改之后的API如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chaojiying</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, username, password, soft_id)</span>:</span></span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = md5(password.encode(<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line">        self.soft_id = soft_id</span><br><span class="line">        self.base_params = &#123;</span><br><span class="line">            <span class="string">'user'</span>: self.username,</span><br><span class="line">            <span class="string">'pass2'</span>: self.password,</span><br><span class="line">            <span class="string">'softid'</span>: self.soft_id,</span><br><span class="line">        &#125;</span><br><span class="line">        self.headers = &#123;</span><br><span class="line">            <span class="string">'Connection'</span>: <span class="string">'Keep-Alive'</span>,</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)'</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post_pic</span><span class="params">(self, im, codetype)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        im: 图片字节</span></span><br><span class="line"><span class="string">        codetype: 题目类型 参考 http://www.chaojiying.com/price.html</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">'codetype'</span>: codetype,</span><br><span class="line">        &#125;</span><br><span class="line">        params.update(self.base_params)</span><br><span class="line">        files = &#123;<span class="string">'userfile'</span>: (<span class="string">'ccc.jpg'</span>, im)&#125;</span><br><span class="line">        r = requests.post(<span class="string">'http://upload.chaojiying.net/Upload/Processing.php'</span>, data=params, files=files, headers=self.headers)</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">report_error</span><span class="params">(self, im_id)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        im_id:报错题目的图片ID</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">'id'</span>: im_id,</span><br><span class="line">        &#125;</span><br><span class="line">        params.update(self.base_params)</span><br><span class="line">        r = requests.post(<span class="string">'http://upload.chaojiying.net/Upload/ReportError.php'</span>, data=params, headers=self.headers)</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里定义了一个 Chaojiying 类，其构造函数接收三个参数，分别是超级鹰的用户名、密码以及软件ID，保存好以备使用。 接下来是最重要的一个方法叫做 post_pic()，这里需要传入图片对象和验证码的代号，该方法会将图片对象和相关信息发给超级鹰的后台进行识别，然后将识别成功的 Json 返回回来。 另一个方法叫做 report_error()，这个是发生错误的时候的回调，如果验证码识别错误，调用此方法会返还相应的题分。 接下来我们以 TouClick 的官网为例来进行演示点触验证码的识别过程，链接为：<a href="http://admin.touclick.com/" target="_blank" rel="noopener">http://admin.touclick.com/</a>，如果没有注册账号可以先注册一个。</p>
                  <h3 id="7-初始化"><a href="#7-初始化" class="headerlink" title="7. 初始化"></a>7. 初始化</h3>
                  <p>首先我们需要初始化一些变量，如 WebDriver、Chaojiying对象等等，代码实现如下：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">EMAIL = <span class="string">'cqc@cuiqingcai.com'</span></span><br><span class="line">PASSWORD = <span class="string">''</span></span><br><span class="line"><span class="comment"># 超级鹰用户名、密码、软件ID、验证码类型</span></span><br><span class="line">CHAOJIYING_USERNAME = <span class="string">'Germey'</span></span><br><span class="line">CHAOJIYING_PASSWORD = <span class="string">''</span></span><br><span class="line">CHAOJIYING_SOFT_ID = <span class="number">893590</span></span><br><span class="line">CHAOJIYING_KIND = <span class="number">9102</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CrackTouClick</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.url = <span class="string">'http://admin.touclick.com/login.html'</span></span><br><span class="line">        <span class="keyword">self</span>.browser = webdriver.Chrome()</span><br><span class="line">        <span class="keyword">self</span>.wait = WebDriverWait(<span class="keyword">self</span>.browser, <span class="number">20</span>)</span><br><span class="line">        <span class="keyword">self</span>.email = EMAIL</span><br><span class="line">        <span class="keyword">self</span>.password = PASSWORD</span><br><span class="line">        <span class="keyword">self</span>.chaojiying = Chaojiying(CHAOJIYING_USERNAME, CHAOJIYING_PASSWORD, CHAOJIYING_SOFT_ID)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里的账号和密码请自行修改。</p>
                  <h3 id="8-获取验证码"><a href="#8-获取验证码" class="headerlink" title="8. 获取验证码"></a>8. 获取验证码</h3>
                  <p>接下来的第一步就是完善相关表单，然后模拟点击呼出验证码，此步非常简单，代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    打开网页输入用户名密码</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    self.browser.get(self.url)</span><br><span class="line">    email = self.wait.until(EC.presence_of_element_located((By.ID, <span class="string">'email'</span>)))</span><br><span class="line">    password = self.wait.until(EC.presence_of_element_located((By.ID, <span class="string">'password'</span>)))</span><br><span class="line">    email.send_keys(self.email)</span><br><span class="line">    password.send_keys(self.password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_touclick_button</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取初始验证按钮</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    button = self.wait.until(EC.element_to_be_clickable((By.CLASS_NAME, <span class="string">'touclick-hod-wrap'</span>)))</span><br><span class="line">    <span class="keyword">return</span> button</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里 open() 方法负责填写表单，get_touclick_button() 方法则是获取验证码按钮，随后触发点击即可。 接下来我们需要类似上一节极验验证码图像获取一样，首先获取验证码图片的位置和大小，随后从网页截图里面截取相应的验证码图片就好了。代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_touclick_element</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取验证图片对象</span></span><br><span class="line"><span class="string">    :return: 图片对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    element = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">'touclick-pub-content'</span>)))</span><br><span class="line">    <span class="keyword">return</span> element</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_position</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取验证码位置</span></span><br><span class="line"><span class="string">    :return: 验证码位置元组</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    element = self.get_touclick_element()</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    location = element.location</span><br><span class="line">    size = element.size</span><br><span class="line">    top, bottom, left, right = location[<span class="string">'y'</span>], location[<span class="string">'y'</span>] + size[<span class="string">'height'</span>], location[<span class="string">'x'</span>], location[<span class="string">'x'</span>] + size[</span><br><span class="line">        <span class="string">'width'</span>]</span><br><span class="line">    <span class="keyword">return</span> (top, bottom, left, right)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_screenshot</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取网页截图</span></span><br><span class="line"><span class="string">    :return: 截图对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    screenshot = self.browser.get_screenshot_as_png()</span><br><span class="line">    screenshot = Image.open(BytesIO(screenshot))</span><br><span class="line">    <span class="keyword">return</span> screenshot</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_touclick_image</span><span class="params">(self, name=<span class="string">'captcha.png'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取验证码图片</span></span><br><span class="line"><span class="string">    :return: 图片对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    top, bottom, left, right = self.get_position()</span><br><span class="line">    print(<span class="string">'验证码位置'</span>, top, bottom, left, right)</span><br><span class="line">    screenshot = self.get_screenshot()</span><br><span class="line">    captcha = screenshot.crop((left, top, right, bottom))</span><br><span class="line">    <span class="keyword">return</span> captcha</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里 get_touclick_image() 方法即为从网页截图中截取对应的验证码图片，其中验证码图片的相对位置坐标由 get_position() 方法返回得到，最后我们得到的是一个 Image 对象。</p>
                  <h3 id="9-识别验证码"><a href="#9-识别验证码" class="headerlink" title="9. 识别验证码"></a>9. 识别验证码</h3>
                  <p>随后我们调用 Chaojiying 对象的 post_pic() 方法即可把图片发送给超级鹰后台，在这里发送的图像是字节流格式，代码实现如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">image = self.get_touclick_image()</span><br><span class="line">bytes_array = BytesIO()</span><br><span class="line">image.save(bytes_array, <span class="attribute">format</span>=<span class="string">'PNG'</span>)</span><br><span class="line"><span class="comment"># 识别验证码</span></span><br><span class="line">result = self.chaojiying.post_pic(bytes_array.getvalue(), CHAOJIYING_KIND)</span><br><span class="line"><span class="builtin-name">print</span>(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样运行之后 result 变量就是超级鹰后台的识别结果，可能运行需要等待几秒，毕竟后台还有人工来完成识别。 返回的结果是一个 Json，如果识别成功后一个典型的返回结果类似如下：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;'err_no': <span class="number">0</span>, 'err_str': 'OK', 'pic_id': '<span class="number">60020013809492</span><span class="number">0000</span>1', 'pic_str': '132,127|56,77', 'md5': '1f8e1d4bef8b<span class="number">1148</span>4cb1f1f<span class="number">34299865</span>b'&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其中 pic_str 就是识别的文字的坐标，是以字符串形式返回的，每个坐标都以 | 分隔，所以接下来我们只需要将其解析之后再模拟点击即可，代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_points</span><span class="params">(self, captcha_result)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    解析识别结果</span></span><br><span class="line"><span class="string">    :param captcha_result: 识别结果</span></span><br><span class="line"><span class="string">    :return: 转化后的结果</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    groups = captcha_result.get(<span class="string">'pic_str'</span>).split(<span class="string">'|'</span>)</span><br><span class="line">    locations = [[int(number) <span class="keyword">for</span> number <span class="keyword">in</span> group.split(<span class="string">','</span>)] <span class="keyword">for</span> group <span class="keyword">in</span> groups]</span><br><span class="line">    <span class="keyword">return</span> locations</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">touch_click_words</span><span class="params">(self, locations)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    点击验证图片</span></span><br><span class="line"><span class="string">    :param locations: 点击位置</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> location <span class="keyword">in</span> locations:</span><br><span class="line">        print(location)</span><br><span class="line">        ActionChains(self.browser).move_to_element_with_offset(self.get_touclick_element(), location[<span class="number">0</span>], location[<span class="number">1</span>]).click().perform()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们用 get_points() 方法将识别结果变成了列表的形式，最后 touch_click_words() 方法则通过调用 move_to_element_with_offset() 方法依次传入解析后的坐标，然后点击即可。 这样我们就可以模拟完成坐标的点选了，运行效果如图 8-23 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055241.jpg" alt=""> 图 8-23 点选效果 最后我们需要做的就是点击提交验证的按钮等待验证通过，再点击登录按钮即可成功登录，后续实现在此不再赘述。 这样我们就借助于在线验证码平台完成了点触验证码的识别，此种方法也是一种通用方法，用此方法来识别 12306 等验证码也是完全相同的原理。</p>
                  <h3 id="10-本节代码"><a href="#10-本节代码" class="headerlink" title="10. 本节代码"></a>10. 本节代码</h3>
                  <p>本节代码地址为：<a href="https://github.com/Python3WebSpider/CrackTouClick" target="_blank" rel="noopener">https://github.com/Python3WebSpider/CrackTouClick</a>。</p>
                  <h3 id="11-结语"><a href="#11-结语" class="headerlink" title="11. 结语"></a>11. 结语</h3>
                  <p>本节我们通过在线打码平台辅助完成了验证码的识别，这种识别方法非常强大，几乎任意的验证码都可以识别，如果遇到难题，借助于打码平台无疑是一个极佳的选择。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 13:53:42" itemprop="dateCreated datePublished" datetime="2019-08-02T13:53:42+08:00">2019-08-02</time>
                </span>
                <span id="/7039.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 8.3-点触点选验证码的识别" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7037.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7037.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 8.2-极验滑动验证码的识别</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>上节我们了解了图形验证码的识别，简单的图形验证码我们可以直接利用 Tesserocr 来识别，但是近几年又出现了一些新型验证码，如滑动验证码，比较有代表性的就是极验验证码，它需要拖动拼合滑块才可以完成验证，相对图形验证码来说识别难度上升了几个等级，本节来讲解下极验验证码的识别过程。</p>
                  <h3 id="1-本节目标"><a href="#1-本节目标" class="headerlink" title="1. 本节目标"></a>1. 本节目标</h3>
                  <p>本节我们的目标是用程序来识别并通过极验验证码的验证，其步骤有分析识别思路、识别缺口位置、生成滑块拖动路径，最后模拟实现滑块拼合通过验证。</p>
                  <h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h3>
                  <p>本次我们使用的 Python 库是 Selenium，使用的浏览器为 Chrome，在此之前请确保已经正确安装好了 Selenium 库、Chrome浏览器并配置好了 ChromeDriver，相关流程可以参考第一章的说明。</p>
                  <h3 id="3-了解极验验证码"><a href="#3-了解极验验证码" class="headerlink" title="3. 了解极验验证码"></a>3. 了解极验验证码</h3>
                  <p>极验验证码其官网为：<a href="http://www.geetest.com/" target="_blank" rel="noopener">http://www.geetest.com/</a>，它是一个专注于提供验证安全的系统，主要验证方式是拖动滑块拼合图像，若图像完全拼合，则验证成功，即可以成功提交表单，否则需要重新验证，样例如图8-5 和 8-6 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054905.jpg" alt=""> 图 8-5 验证码示例 <img src="https://qiniu.cuiqingcai.com/2019-08-02-054908.jpg" alt=""> 图 8-6 验证码示例 现在极验验证码已经更新到了 3.0 版本，截至 2017 年 7 月全球已有十六万家企业正在使用极验，每天服务响应超过四亿次，广泛应用于直播视频、金融服务、电子商务、游戏娱乐、政府企业等各大类型网站，下面是斗鱼、魅族的登录页面，可以看到其都对接了极验验证码，如图 8-7 和 8-8 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054908.jpg" alt=""> 图 8-7 斗鱼登录页面 <img src="https://qiniu.cuiqingcai.com/2019-08-02-054912.jpg" alt=""> 图 8-8 魅族登录页面</p>
                  <h3 id="4-极验验证码的特点"><a href="#4-极验验证码的特点" class="headerlink" title="4. 极验验证码的特点"></a>4. 极验验证码的特点</h3>
                  <p>这种验证码相较于图形验证码来说识别难度更大，极验验证码首先需要在前台验证通过，对于极验 3.0，我们首先需要点击按钮进行智能验证，如果验证不通过，则会弹出滑动验证的窗口，随后需要拖动滑块拼合图像进行验证，验证之后会生成三个加密参数，参数随后通过表单提交到后台，后台还会进行一次验证。 另外极验还增加了机器学习的方法来识别拖动轨迹，官方网站的安全防护说明如下：</p>
                  <ul>
                    <li>三角防护之防模拟</li>
                  </ul>
                  <p>恶意程序模仿人类行为轨迹对验证码进行识别。针对模拟，极验拥有超过 4000 万人机行为样本的海量数据。利用机器学习和神经网络构建线上线下的多重静态、动态防御模型。识别模拟轨迹，界定人机边界。</p>
                  <ul>
                    <li>三角防护之防伪造</li>
                  </ul>
                  <p>恶意程序通过伪造设备浏览器环境对验证码进行识别。针对伪造，极验利用设备基因技术。深度分析浏览器的实际性能来辨识伪造信息。同时根据伪造事件不断更新黑名单，大幅提高防伪造能力。</p>
                  <ul>
                    <li>三角防护之防暴力</li>
                  </ul>
                  <p>恶意程序短时间内进行密集的攻击，对验证码进行暴力识别 针对暴力，极验拥有多种验证形态，每一种验证形态都有利用神经网络生成的海量图库储备，每一张图片都是独一无二的，且图库不断更新，极大程度提高了暴力识别的成本。 另外极验的验证相对于普通验证方式更加方便，体验更加友好，其官方网站说明如下：</p>
                  <ul>
                    <li>点击一下，验证只需要 0.4 秒</li>
                  </ul>
                  <p>极验始终专注于去验证化实践，让验证环节不再打断产品本身的交互流程，最终达到优化用户体验和提高用户转化率的效果。</p>
                  <ul>
                    <li>全平台兼容，适用各种交互场景</li>
                  </ul>
                  <p>极验兼容所有主流浏览器甚至古老的IE6，也可以轻松应用在iOS和Android移动端平台，满足各种业务需求，保护网站资源不被滥用和盗取。</p>
                  <ul>
                    <li>面向未来，懂科技，更懂人性</li>
                  </ul>
                  <p>极验在保障安全同时不断致力于提升用户体验，精雕细琢的验证面板，流畅顺滑的验证动画效果，让验证过程不再枯燥乏味。 因此，相较于一般验证码，极验的验证安全性和易用性有了非常大的提高。</p>
                  <h3 id="5-识别思路"><a href="#5-识别思路" class="headerlink" title="5. 识别思路"></a>5. 识别思路</h3>
                  <p>但是对于应用了极验验证码的网站，识别并不是没有办法的。如果我们直接模拟表单提交的话，加密参数的构造是个问题，参数构造有问题服务端就会校验失败，所以在这里我们采用直接模拟浏览器动作的方式来完成验证，在 Python 中我们就可以使用 Selenium 来通过完全模拟人的行为的方式来完成验证，此验证成本相对于直接去识别加密算法容易不少。 首先我们找到一个带有极验验证的网站，最合适的当然为极验官方后台了，链接为：<a href="https://account.geetest.com/login" target="_blank" rel="noopener">https://account.geetest.com/login</a>，首先可以看到在登录按钮上方有一个极验验证按钮，如图 8-9 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054921.jpg" alt=""> 图 8-9 验证按钮 此按钮为智能验证按钮，点击一下即可智能验证，一般来说如果是同一个 Session，一小段时间内第二次登录便会直接通过验证，如果智能识别不通过，则会弹出滑动验证窗口，我们便需要拖动滑块来拼合图像完成二步验证，如图 8-10 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054919.jpg" alt=""> 图 8-10 拖动示例 验证成功后验证按钮便会变成如下状态，如图 8-11 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-54922.jpg" alt=""> 图 8-11 验证成功结果 接下来我们便可以进行表单提交了。 所以在这里我们要识别验证需要做的有三步：</p>
                  <ul>
                    <li>模拟点击验证按钮</li>
                    <li>识别滑动缺口的位置</li>
                    <li>模拟拖动滑块</li>
                  </ul>
                  <p>第一步操作是最简单的，我们可以直接用 Selenium 模拟点击按钮即可。 第二步操作识别缺口的位置比较关键，需要用到图像的相关处理方法，那缺口怎么找呢？首先来观察一下缺口的样子，如图 8-12 和 8-13 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054942.jpg" alt=""> 图 8-12 缺口示例 <img src="https://qiniu.cuiqingcai.com/2019-08-02-054944.jpg" alt=""> 图 8-13 缺口示例 可以看到缺口的四周边缘有明显的断裂边缘，而且边缘和边缘周围有明显的区别，我们可以实现一个边缘检测算法来找出缺口的位置。对于极验来说，我们可以利用和原图对比检测的方式来识别缺口的位置，因为在没有滑动滑块之前，缺口其实是没有呈现的，如图 8-14 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054940.jpg" alt=""> 图 8-14 初始状态 所以我们可以同时获取两张图片，设定一个对比阈值，然后遍历两张图片找出相同位置像素 RGB 差距超过此阈值的像素点位置，那么此位置就是缺口的位置。 第三步操作看似简单，但是其中的坑比较多，极验验证码增加了机器轨迹识别，匀速移动、随机速度移动等方法都是不行的，只有完全模拟人的移动轨迹才可以通过验证，而人的移动轨迹一般是先加速后减速的，这又涉及到物理学中加速度的相关问题，我们需要模拟这个过程才能成功。 有了基本的思路之后就让我们用程序来实现一下它的识别过程吧。</p>
                  <h3 id="6-初始化"><a href="#6-初始化" class="headerlink" title="6. 初始化"></a>6. 初始化</h3>
                  <p>首先这次我们选定的链接为：<a href="https://account.geetest.com/login" target="_blank" rel="noopener">https://account.geetest.com/login</a>，也就是极验的管理后台登录页面，在这里我们首先初始化一些配置，如 Selenium 对象的初始化及一些参数的配置：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">EMAIL = <span class="string">'test@test.com'</span></span><br><span class="line">PASSWORD = <span class="string">'123456'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CrackGeetest</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.url = <span class="string">'https://account.geetest.com/login'</span></span><br><span class="line">        <span class="keyword">self</span>.browser = webdriver.Chrome()</span><br><span class="line">        <span class="keyword">self</span>.wait = WebDriverWait(<span class="keyword">self</span>.browser, <span class="number">20</span>)</span><br><span class="line">        <span class="keyword">self</span>.email = EMAIL</span><br><span class="line">        <span class="keyword">self</span>.password = PASSWORD</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其中 EMAIL 和 PASSWORD 就是登录极验需要的用户名和密码，如果没有的话可以先注册一下。</p>
                  <h3 id="7-模拟点击"><a href="#7-模拟点击" class="headerlink" title="7. 模拟点击"></a>7. 模拟点击</h3>
                  <p>随后我们需要实现第一步的操作，也就是模拟点击初始的验证按钮，所以我们定义一个方法来获取这个按钮，利用显式等待的方法来实现：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_geetest_button</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取初始验证按钮</span></span><br><span class="line"><span class="string">    :return: 按钮对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    button = self.wait.until(EC.element_to_be_clickable((By.CLASS_NAME, <span class="string">'geetest_radar_tip'</span>)))</span><br><span class="line">    <span class="keyword">return</span> button</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>获取之后就会获取一个 WebElement 对象，调用它的 click() 方法即可模拟点击，代码如下：</p>
                  <figure class="highlight armasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># 点击验证按钮</span><br><span class="line"><span class="keyword">button </span>= <span class="keyword">self.get_geetest_button()</span></span><br><span class="line"><span class="keyword">button.click()</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>到这里我们第一步的工作就完成了。</p>
                  <h3 id="8-识别缺口"><a href="#8-识别缺口" class="headerlink" title="8. 识别缺口"></a>8. 识别缺口</h3>
                  <p>接下来我们需要识别缺口的位置，首先我们需要将前后的两张比对图片获取下来，然后比对二者的不一致的地方即为缺口。首先我们需要获取不带缺口的图片，利用 Selenium 选取图片元素，然后得到其所在位置和宽高，随后获取整个网页的截图，再从截图中裁切出来即可，代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_position</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取验证码位置</span></span><br><span class="line"><span class="string">    :return: 验证码位置元组</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    img = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">'geetest_canvas_img'</span>)))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    location = img.location</span><br><span class="line">    size = img.size</span><br><span class="line">    top, bottom, left, right = location[<span class="string">'y'</span>], location[<span class="string">'y'</span>] + size[<span class="string">'height'</span>], location[<span class="string">'x'</span>], location[<span class="string">'x'</span>] + size[</span><br><span class="line">        <span class="string">'width'</span>]</span><br><span class="line">    <span class="keyword">return</span> (top, bottom, left, right)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_geetest_image</span><span class="params">(self, name=<span class="string">'captcha.png'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取验证码图片</span></span><br><span class="line"><span class="string">    :return: 图片对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    top, bottom, left, right = self.get_position()</span><br><span class="line">    print(<span class="string">'验证码位置'</span>, top, bottom, left, right)</span><br><span class="line">    screenshot = self.get_screenshot()</span><br><span class="line">    captcha = screenshot.crop((left, top, right, bottom))</span><br><span class="line">    <span class="keyword">return</span> captcha</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里 get_position() 函数首先获取了图片对象，然后获取了它的位置和宽高，随后返回了其左上角和右下角的坐标。而 get_geetest_image() 方法则是获取了网页截图，然后调用了 crop() 方法将图片再裁切出来，返回的是 Image 对象。 随后我们需要获取第二张图片，也就是带缺口的图片，要使得图片出现缺口，我们只需要点击一下下方的滑块即可，触发这个动作之后，图片中的缺口就会显现，实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_slider</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取滑块</span></span><br><span class="line"><span class="string">    :return: 滑块对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    slider = self.wait.until(EC.element_to_be_clickable((By.CLASS_NAME, <span class="string">'geetest_slider_button'</span>)))</span><br><span class="line">    <span class="keyword">return</span> slider</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>利用 get_slider() 方法获取滑块对象，接下来调用其 click() 方法即可触发点击，缺口图片即可呈现：</p>
                  <figure class="highlight crystal">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 点按呼出缺口</span></span><br><span class="line">slider = <span class="keyword">self</span>.get_slider()</span><br><span class="line">slider.click()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>随后还是调用 get_geetest_image() 方法将第二张图片获取下来即可。 到现在我们就已经得到了两张图片对象了，分别赋值给变量 image1 和 image2，接下来对比图片获取缺口即可。要对比图片的不同之处，我们在这里遍历图片的每个坐标点，获取两张图片对应像素点的 RGB 数据，然后判断二者的 RGB 数据差异，如果差距超过在一定范围内，那就代表两个像素相同，继续比对下一个像素点，如果差距超过一定范围，则判断像素点不同，当前位置即为缺口位置，代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_pixel_equal</span><span class="params">(self, image1, image2, x, y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    判断两个像素是否相同</span></span><br><span class="line"><span class="string">    :param image1: 图片1</span></span><br><span class="line"><span class="string">    :param image2: 图片2</span></span><br><span class="line"><span class="string">    :param x: 位置x</span></span><br><span class="line"><span class="string">    :param y: 位置y</span></span><br><span class="line"><span class="string">    :return: 像素是否相同</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 取两个图片的像素点</span></span><br><span class="line">    pixel1 = image1.load()[x, y]</span><br><span class="line">    pixel2 = image2.load()[x, y]</span><br><span class="line">    threshold = <span class="number">60</span></span><br><span class="line">    <span class="keyword">if</span> abs(pixel1[<span class="number">0</span>] - pixel2[<span class="number">0</span>]) &lt; threshold <span class="keyword">and</span> abs(pixel1[<span class="number">1</span>] - pixel2[<span class="number">1</span>]) &lt; threshold <span class="keyword">and</span> abs(</span><br><span class="line">            pixel1[<span class="number">2</span>] - pixel2[<span class="number">2</span>]) &lt; threshold:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_gap</span><span class="params">(self, image1, image2)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取缺口偏移量</span></span><br><span class="line"><span class="string">    :param image1: 不带缺口图片</span></span><br><span class="line"><span class="string">    :param image2: 带缺口图片</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    left = <span class="number">60</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(left, image1.size[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(image1.size[<span class="number">1</span>]):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.is_pixel_equal(image1, image2, i, j):</span><br><span class="line">                left = i</span><br><span class="line">                <span class="keyword">return</span> left</span><br><span class="line">    <span class="keyword">return</span> left</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>get_gap() 方法即为获取缺口位置的方法，此方法的参数为两张图片，一张为带缺口图片，另一张为不带缺口图片，在这里遍历两张图片的每个像素，然后利用 is_pixel_equal() 方法判断两张图片同一位置的像素是否相同，比对的时候比较了两张图 RGB 的绝对值是否均小于定义的阈值 threshold，如果均在阈值之内，则像素点相同，继续遍历，否则遇到不相同的像素点就是缺口的位置。 在这里比如两张对比图片如下，如图 8-15 和 8-16 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054959.png" alt=""> 图 8-15 初始状态 <img src="https://qiniu.cuiqingcai.com/2019-08-02-055003.jpg" alt=""> 图 8-16 后续状态 两张图片其实有两处明显不同的地方，一个就是待拼合的滑块，一个就是缺口，但是滑块的位置会出现在左边位置，缺口会出现在与滑块同一水平线的位置，所以缺口一般会在滑块的右侧，所以要寻找缺口的话，我们直接从滑块右侧寻找即可，所以在遍历的时候我们直接设置了遍历的起始横坐标为 60，也就是在滑块的右侧开始识别，这样识别出的结果就是缺口的位置了。 到现在为止，我们就可以获取缺口的位置了，剩下最后一步模拟拖动就可以完成验证了。</p>
                  <h3 id="9-模拟拖动"><a href="#9-模拟拖动" class="headerlink" title="9. 模拟拖动"></a>9. 模拟拖动</h3>
                  <p>模拟拖动的这个过程说复杂并不复杂，只是其中的坑比较多。现在我们已经获取到了缺口的位置，接下来只需要调用拖动的相关函数将滑块拖动到对应位置不就好了吗？然而事实很残酷，如果匀速拖动，极验必然会识别出来这是程序的操作，因为人是无法做到完全匀速拖动的，极验利用机器学习模型筛选出此类数据，归类为机器操作，验证码识别失败。 随后我又尝试了分段模拟，将拖动过程划分几段，每段设置一个平均速度，同时速度围绕该平均速度小幅度随机抖动，同样无法完成验证。 最后尝试了完全模拟加速减速的过程通过了验证，在前段滑块需要做匀加速运动，后面需要做匀减速运动，在这里利用物理学的加速度公式即可完成。 设滑块滑动的加速度用 a 来表示，当前速度用 v 表示，初速度用 v0 表示，位移用 x 表示，所需时间用 t 表示，则它们之间满足如下关系：</p>
                  <figure class="highlight excel">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = <span class="symbol">v0</span> * <span class="built_in">t</span> + <span class="number">0.5</span> * a * <span class="built_in">t</span> * <span class="built_in">t</span> </span><br><span class="line">v = <span class="symbol">v0</span> + a * <span class="built_in">t</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来我们利用两个公式可以构造一个轨迹移动算法，计算出先加速后减速的运动轨迹，代码实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_track</span><span class="params">(self, distance)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据偏移量获取移动轨迹</span></span><br><span class="line"><span class="string">    :param distance: 偏移量</span></span><br><span class="line"><span class="string">    :return: 移动轨迹</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 移动轨迹</span></span><br><span class="line">    track = []</span><br><span class="line">    <span class="comment"># 当前位移</span></span><br><span class="line">    current = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 减速阈值</span></span><br><span class="line">    mid = distance * <span class="number">4</span> / <span class="number">5</span></span><br><span class="line">    <span class="comment"># 计算间隔</span></span><br><span class="line">    t = <span class="number">0.2</span></span><br><span class="line">    <span class="comment"># 初速度</span></span><br><span class="line">    v = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> current &lt; distance:</span><br><span class="line">        <span class="keyword">if</span> current &lt; mid:</span><br><span class="line">            <span class="comment"># 加速度为正2</span></span><br><span class="line">            a = <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 加速度为负3</span></span><br><span class="line">            a = <span class="number">-3</span></span><br><span class="line">        <span class="comment"># 初速度v0</span></span><br><span class="line">        v0 = v</span><br><span class="line">        <span class="comment"># 当前速度v = v0 + at</span></span><br><span class="line">        v = v0 + a * t</span><br><span class="line">        <span class="comment"># 移动距离x = v0t + 1/2 * a * t^2</span></span><br><span class="line">        move = v0 * t + <span class="number">1</span> / <span class="number">2</span> * a * t * t</span><br><span class="line">        <span class="comment"># 当前位移</span></span><br><span class="line">        current += move</span><br><span class="line">        <span class="comment"># 加入轨迹</span></span><br><span class="line">        track.append(round(move))</span><br><span class="line">    <span class="keyword">return</span> track</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们定义了 get_track() 方法，传入的参数为移动的总距离，返回的是运动轨迹，用 track 表示，它是一个列表，列表的每个元素代表每次移动多少距离。 首先定义了一个变量 mid，即减速的阈值，也就是加速到什么位置就开始减速，在这里定义为 4/5，即模拟前 4/5 路程是加速过程，后 1/5 是减速过程。 随后定义了当前位移的距离变量 current，初始为 0，随后进入 while 循环，循环的条件是当前位移小于总距离。在循环里我们分段定义了加速度，其中加速过程加速度定义为2，减速过程加速度定义为 -3，随后再套用位移公式计算出某个时间段内的位移，同时将当前位移更新并记录到轨迹里即可。 这样直到运动轨迹达到总距离时即终止循环，最后得到的 track 即记录了每个时间间隔移动了多少位移，这样滑块的运动轨迹就得到了。 最后我们只需要按照该运动轨迹拖动滑块即可，方法实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move_to_gap</span><span class="params">(self, slider, tracks)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    拖动滑块到缺口处</span></span><br><span class="line"><span class="string">    :param slider: 滑块</span></span><br><span class="line"><span class="string">    :param tracks: 轨迹</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ActionChains(self.browser).click_and_hold(slider).perform()</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> tracks:</span><br><span class="line">        ActionChains(self.browser).move_by_offset(xoffset=x, yoffset=<span class="number">0</span>).perform()</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ActionChains(self.browser).release().perform()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里传入的参数为滑块对象和运动轨迹，首先调用ActionChains 的 click_and_hold() 方法按住拖动底部滑块，随后遍历运动轨迹获取每小段位移距离，调用 move_by_offset() 方法移动此位移，最后移动完成之后调用 release() 方法松开鼠标即可。 这样再经过测试，验证就通过了，识别完成，效果图 8-17 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-055006.jpg" alt=""> 图 8-17 识别成功结果 最后，我们只需要将表单完善，模拟点击登录按钮即可完成登录，成功登录后即跳转到后台。 至此，极验验证码的识别工作即全部完成，此识别方法同样适用于其他使用极验3.0的网站，原理都是相同的。</p>
                  <h3 id="10-本节代码"><a href="#10-本节代码" class="headerlink" title="10. 本节代码"></a>10. 本节代码</h3>
                  <p>本节代码地址为：<a href="https://github.com/Python3WebSpider/CrackGeetest" target="_blank" rel="noopener">https://github.com/Python3WebSpider/CrackGeetest</a>。</p>
                  <h3 id="11-结语"><a href="#11-结语" class="headerlink" title="11. 结语"></a>11. 结语</h3>
                  <p>本节我们分析并实现了极验验证码的识别，其关键在于识别的思路，如怎样识别缺口位置，怎样生成运动轨迹等，学会了这些思路后以后我们再遇到类似原理的验证码同样可以完成识别过程。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 13:51:17" itemprop="dateCreated datePublished" datetime="2019-08-02T13:51:17+08:00">2019-08-02</time>
                </span>
                <span id="/7037.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 8.2-极验滑动验证码的识别" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7035.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7035.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 8.1-图形验证码的识别</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节我们首先来尝试识别最简单的一种验证码，图形验证码，这种验证码出现的最早，现在也很常见，一般是四位字母或者数字组成的，例如中国知网的注册页面就有类似的验证码，链接为：<a href="http://my.cnki.net/elibregister/commonRegister.aspx" target="_blank" rel="noopener">http://my.cnki.net/elibregister/commonRegister.aspx</a>，页面如图 8-1 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054718.png" alt=""> 图 8-1 知网注册页面 表单的最后一项就是图形验证码，我们必须完全输入正确图中的字符才可以完成注册。</p>
                  <h3 id="1-本节目标"><a href="#1-本节目标" class="headerlink" title="1. 本节目标"></a>1. 本节目标</h3>
                  <p>本节我们就以知网的验证码为例，讲解一下利用 OCR 技术识别此种图形验证码的方法。</p>
                  <h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h3>
                  <p>识别图形验证码需要的库有 Tesserocr，如果没有安装可以参考第一章的安装说明。</p>
                  <h3 id="3-获取验证码"><a href="#3-获取验证码" class="headerlink" title="3. 获取验证码"></a>3. 获取验证码</h3>
                  <p>为了便于实验，我们先将验证码的图片保存到本地，以供测试。 打开开发者工具，找到验证码元素，可以看到这是一张图片，它的 src 属性是 CheckCode.aspx，在这里我们直接将这个链接打开：<a href="http://my.cnki.net/elibregister/CheckCode.aspx" target="_blank" rel="noopener">http://my.cnki.net/elibregister/CheckCode.aspx</a>，就可以看到一个验证码，直接右键保存下来即可，将名称命名为 code.jpg，如图 8-2 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054745.jpg" alt=""> 图 8-2 验证码 这样我们就可以得到一张验证码图片供下面测试识别使用了。</p>
                  <h3 id="4-识别测试"><a href="#4-识别测试" class="headerlink" title="4. 识别测试"></a>4. 识别测试</h3>
                  <p>接下来我们新建一个项目，将验证码图片放到项目根目录下，用 Tesserocr 库来识别一下该验证码试试，代码如下：</p>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line">from PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="built_in">image</span> = Image.<span class="built_in">open</span>(<span class="string">'code.jpg'</span>)</span><br><span class="line">result = tesserocr.image_to_text(<span class="built_in">image</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们首先新建了一个 Image 对象，然后调用了 Tesserocr 的 image_to_text() 方法，传入该 Image 对象即可完成识别，实现过程非常简单，识别结果如下：</p>
                  <figure class="highlight plain">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">JR42</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外 Tesserocr 还有一个更加简单的方法直接将图片文件转为字符串可以达到同样的效果，代码如下：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import tesserocr</span><br><span class="line">print(<span class="name">tesserocr</span>.file_to_text('image.png'))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>不过经测试此种方法的识别效果不如上一种方法好。</p>
                  <h3 id="5-验证码处理"><a href="#5-验证码处理" class="headerlink" title="5. 验证码处理"></a>5. 验证码处理</h3>
                  <p>如上的图片识别基本没有难度，只是新建一个 Image 对象，然后调用 image_to_text() 方法即可得出图片的识别结果。 接下来我们换一个验证码试一下，命名为 code2.jpg，如图 8-3 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054722.jpg" alt=""> 图 8-3 验证码 重新用下面的代码测试一下：</p>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line">from PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="built_in">image</span> = Image.<span class="built_in">open</span>(<span class="string">'code2.jpg'</span>)</span><br><span class="line">result = tesserocr.image_to_text(<span class="built_in">image</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时可以看到如下输出结果：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">FFKT</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>发现这次识别和实际的结果有所偏差，这是因为验证码内的多余线条干扰了图片的识别。 对于这种情况，我们还需要做一下额外的处理，如转灰度、二值化等操作。 我们可以利用 Image 对象的 convert() 方法参数传入 L 即可将图片转化为灰度图像，代码如下：</p>
                  <figure class="highlight maxima">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">image</span> = <span class="built_in">image</span>.<span class="built_in">convert</span>('L')</span><br><span class="line"><span class="built_in">image</span>.<span class="built_in">show</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>传入 1 即可将图片进行二值化处理：</p>
                  <figure class="highlight maxima">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">image</span> = <span class="built_in">image</span>.<span class="built_in">convert</span>('<span class="number">1</span>')</span><br><span class="line"><span class="built_in">image</span>.<span class="built_in">show</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外我们还可以指定二值化的阈值，上面的方法采用的是默认阈值127，不过我们不能用原图直接转化，可以先转为灰度图像，然后再指定二值化阈值转化，代码如下：</p>
                  <figure class="highlight maxima">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">image</span> = <span class="built_in">image</span>.<span class="built_in">convert</span>('L')</span><br><span class="line">threshold = <span class="number">80</span></span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; threshold:</span><br><span class="line">        table.<span class="built_in">append</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table.<span class="built_in">append</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">image</span> = <span class="built_in">image</span>.point(table, '<span class="number">1</span>')</span><br><span class="line"><span class="built_in">image</span>.<span class="built_in">show</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们指定了一个变量 threshold 代表二值化阈值，阈值设置为 80，处理之后我们看一下结果，如图 8-4 所示： <img src="https://qiniu.cuiqingcai.com/2019-08-02-054728.jpg" alt=""> 图 8-4 处理结果 经过处理之后我们发现原来的验证码中的线条已经被去除了，而且整个验证码变得黑白分明，这时重新识别验证码，代码如下：</p>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line">from PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="built_in">image</span> = Image.<span class="built_in">open</span>(<span class="string">'code2.jpg'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">image</span> = <span class="built_in">image</span>.convert(<span class="string">'L'</span>)</span><br><span class="line">threshold = <span class="number">127</span></span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; threshold:</span><br><span class="line">        table.<span class="built_in">append</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table.<span class="built_in">append</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">image</span> = <span class="built_in">image</span>.<span class="built_in">point</span>(table, <span class="string">'1'</span>)</span><br><span class="line">result = tesserocr.image_to_text(<span class="built_in">image</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>即可发现运行结果变成了：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">PFRT</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>识别正确。 可见对于一些有干扰的图片，我们做一些灰度和二值化处理，会提高其识别正确率。</p>
                  <h3 id="6-本节代码"><a href="#6-本节代码" class="headerlink" title="6. 本节代码"></a>6. 本节代码</h3>
                  <p>本节代码地址为：<a href="https://github.com/Python3WebSpider/CrackImageCode" target="_blank" rel="noopener">https://github.com/Python3WebSpider/CrackImageCode</a>。</p>
                  <h3 id="7-结语"><a href="#7-结语" class="headerlink" title="7. 结语"></a>7. 结语</h3>
                  <p>本节我们了解了利用 Tesserocr 识别验证码的过程，对于简单的图形验证码我们可以直接用它来得到结果，如果要提高识别的准确度还可以对验证码图片做一下预处理。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 13:48:53" itemprop="dateCreated datePublished" datetime="2019-08-02T13:48:53+08:00">2019-08-02</time>
                </span>
                <span id="/7035.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 8.1-图形验证码的识别" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/7032.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/7032.html" class="post-title-link" itemprop="url">[Python3网络爬虫开发实战] 8-验证码的识别</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>当今时代，许多网站为了反爬虫采用了各种各样的措施，其中之一便是使用验证码，随着技术的发展，验证码的花样也越来越多，最初可能是几个数字组合的简单的图形验证码，后来加入了英文字母和混淆曲线使得验证码更加复杂，有的网站还可能看到中文字符的验证码，使得识别愈发困难。 而后来 12306 验证码的出现又开辟了验证码的新纪元，用过 12306 的肯定多少为它的验证码头疼过，它需要我们去识别文字，然后再点击文字描述相符的图片，只有完全正确才可以验证通过。现在这种交互式验证码越来越多，如极验滑动验证码需要滑动拼合滑块才可以完成验证，点触的验证码需要完全点击正确的结果才可以完成验证，另外还有一些滑动宫格验证码，计算题验证码等等五花八门。 验证码变得越来越复杂，爬虫的工作也变得愈发艰难，有时候我们必须通过验证码的验证才可以访问页面，所以本章专门来针对验证码的识别做一下统一的讲解。 本章涉及的验证码有普通图形验证码、极验滑动验证码、点触验证码、微博宫格验证码，识别的方式和思路各有不同，了解了这几个验证码的识别方式之后，我们可以举一反三，用类似的方法识别其他类型的验证码。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-08-02 13:45:53" itemprop="dateCreated datePublished" datetime="2019-08-02T13:45:53+08:00">2019-08-02</time>
                </span>
                <span id="/7032.html" class="post-meta-item leancloud_visitors" data-flag-title="[Python3网络爬虫开发实战] 8-验证码的识别" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>474</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6978.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 生活笔记 <i class="label-arrow"></i>
                  </a>
                  <a href="/6978.html" class="post-title-link" itemprop="url">人生数10载，你已度过几个10年？</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>人生一共就是由几个10年组成的，每个10年都有不同的经历，不同的心境，每个10年追求的东西都不一样。 鱼与熊掌不可兼得，在追求的过程中你总要有取舍，该取什么?该舍什么?</p>
                  <h2 id="10岁时"><a href="#10岁时" class="headerlink" title="10岁时"></a><strong><strong>10岁时</strong></strong></h2>
                  <p>应该不再计较家里给的零花钱多少，不和别人家的孩子比较穿名牌服装；少不更事，和人家比吃穿，还情有可原，年纪到了整数就该懂事了。</p>
                  <h2 id="20岁时"><a href="#20岁时" class="headerlink" title="20岁时"></a><strong><strong>20岁时</strong></strong></h2>
                  <p>不再计较自己的家庭出身，不再计较父母的职业十几岁时，会和别的孩子比较家庭出身，比爹娘官大官小，恨不得都投生帝王之家、将相之门，也是人之常情。 但如果到了“弱冠”之年，还弱不禁风，尚无自立之志，出身贫寒的还为家庭自卑，老觉得抬不起头来;出身富豪的还处处依靠父母，在家庭荫护下养尊处优，那就会一辈子都没出息。</p>
                  <h2 id="30岁时"><a href="#30岁时" class="headerlink" title="30岁时"></a><strong><strong>30岁时</strong></strong></h2>
                  <p>已成家立业，为父为母，有了几年家庭生活的经验。大丈夫该不再计较妻子的容貌，深知贤惠比美貌更重要，会过日子的媳妇比会打扮的媳妇更让人待见； 老婆该不再计较老公的身高，明白能力比身高更有作用，没有谋生能力的老公，纵然长成丈二金刚，还不如卖炊饼的大郎。</p>
                  <h2 id="40岁时"><a href="#40岁时" class="headerlink" title="40岁时"></a><strong><strong>40岁时</strong></strong></h2>
                  <p>不再计较别人的议论，谁爱说啥就说啥，自己想咋过就咋过。 人言可畏，想想上世纪30年代的阮玲玉还成如今的明星，一星期听不到他的绯闻轶事没人对他议论纷纷，他就急得火烧火燎的。 咱们虽然没有明星那高深道行，但不会再轻易被别人议论左右，这点本事应该有的，否则也对不起“不惑”这两个字啊。</p>
                  <h2 id="50岁时"><a href="#50岁时" class="headerlink" title="50岁时"></a><strong><strong>50岁时</strong></strong></h2>
                  <p>不再计较无处不在的不平之事，不再计较别人的成功对自己的压力，不再眼红他人的财。 半百之年，曾经沧海，阋人无数，见惯秋月春风，不再大惊小怪;历尽是非成败，不再愤愤不平看新贵飞扬跋扈，可不动声色;看大款挥金如土，也气定神闲，耐住性子。</p>
                  <h2 id="60岁时"><a href="#60岁时" class="headerlink" title="60岁时"></a><strong><strong>60岁时</strong></strong></h2>
                  <p>如果从政，该不再计较官大官小，退了体，官大官小一个样，都是退体干部。 如果经商，该不再计较利大利小，钱是挣不完的，再能花也是有限的，心态平和对自己身体有好处。 如果舞文弄墨，当不再计较文名大小，文坛座次。</p>
                  <h2 id="70岁时"><a href="#70岁时" class="headerlink" title="70岁时"></a><strong><strong>70岁时</strong></strong></h2>
                  <p>人到古稀，该不再计较的东西更多，看淡的事情更广。 年轻时争得你死我活的东西，现在只会淡然一笑。 中年时费尽心机格外计较的东西，如今看来已无关紧要。一生多少事，“都付笑谈中”。 这个岁数的老人，要有三样特别积极健康的身体、和谐的家庭、良好的名声。 人生在世，如果计较的东西太多，名利地位，金钱美色，样样都不肯放手，那就会如牛重负，活得很累。 反之，什么都不计较，什么都马马虎虎，什么都可以凑合，那也未免太对不起自己，活得没啥意思。 <strong><strong>人生智慧</strong></strong> <strong><strong>聪明的人，有生活智慧的人，会有所为，有所不为。他们只计较对自己最重要的东西，</strong></strong> <strong><strong>并且知道什么年龄该计较什么，不该计较什么，有取有舍，收放自如。</strong></strong></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/a385962416" class="author" itemprop="url" rel="index">a385962416</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-29 01:37:44" itemprop="dateCreated datePublished" datetime="2019-07-29T01:37:44+08:00">2019-07-29</time>
                </span>
                <span id="/6978.html" class="post-meta-item leancloud_visitors" data-flag-title="人生数10载，你已度过几个10年？" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6982.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6982.html" class="post-title-link" itemprop="url">你还在用 os.path？快来感受一下 pathlib 给你带来的便捷吧！</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <blockquote>
                    <p>相比常用的 os.path而言，pathlib 对于目录路径的操作更简介也更贴近 Pythonic。但是它不单纯是为了简化操作，还有更大的用途</p>
                  </blockquote>
                  <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1>
                  <p>pathlib 是Python内置库，Python 文档给它的定义是 Object-oriented filesystem paths（面向对象的文件系统路径）。pathlib 提供表示文件系统路径的类，其语义适用于不同的操作系统。路径类在纯路径之间划分，纯路径提供纯粹的计算操作而没有I / O，以及具体路径，它继承纯路径但也提供I / O操作。 听起来有点绕？那就对了，毕竟这是直译过来的，但这并不影响我们喜爱它。 我们通过几个例子来了解它吧</p>
                  <h1 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h1>
                  <p>相对于 os 模块的 path 方法，Python3 标准库 pathlib 模块的 Path 对路径的操作会更简单。</p>
                  <h2 id="获取当前文件路径"><a href="#获取当前文件路径" class="headerlink" title="获取当前文件路径"></a>获取当前文件路径</h2>
                  <p>使用 os 模块时，有两种方法可以直接获取当前文件路径：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">value1 = os<span class="selector-class">.path</span>.dirname(__file__)</span><br><span class="line">value2 = os.getcwd()</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(value1)</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(value2)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f1a91bbe4553?w=1408&amp;h=512&amp;f=png&amp;s=79211" alt=""> pathlib 获取当前文件路径应该怎么写呢？ 官方文档给出了建议 <a href="https://docs.python.org/3/library/pathlib.html#methods" target="_blank" rel="noopener">插眼传送</a> <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f1e078abc837?w=863&amp;h=235&amp;f=png&amp;s=26250" alt=""> 动手试一试</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pathlib</span><br><span class="line"></span><br><span class="line">value1 = pathlib<span class="selector-class">.Path</span>.cwd()</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(value1)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f1f1d4cb8275?w=1490&amp;h=501&amp;f=png&amp;s=71717" alt=""></p>
                  <h3 id="它是如何实现的"><a href="#它是如何实现的" class="headerlink" title="它是如何实现的"></a>它是如何实现的</h3>
                  <p>文档中有介绍，它以 os.getcwd() 的形式将路径返回。我们去源码中一探究竟（Pycharm 编辑器快捷键 ctrl+鼠标左键点击即可跟进指定对象） <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f227b220c55b?w=983&amp;h=214&amp;f=png&amp;s=23854" alt=""> 原来它是对 os 模块中一些对象进行了封装，看 cwd 的注释： <code>Return a new path pointing to the current working directory</code> 意为：返回指向当前工作目录的新路径。 看起来也没什么特别的，但是为什么官方特意将它推出呢？</p>
                  <h3 id="其他的封装"><a href="#其他的封装" class="headerlink" title="其他的封装"></a>其他的封装</h3>
                  <p>pathlib 封装了很多的 os path ，文档中有写明，如：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># 关系说明</span><br><span class="line"> <span class="selector-tag">os</span><span class="selector-class">.path</span><span class="selector-class">.expanduser</span>() <span class="selector-tag">--</span>&gt; <span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.home</span>()</span><br><span class="line"></span><br><span class="line"> <span class="selector-tag">os</span><span class="selector-class">.path</span><span class="selector-class">.expanduser</span>() <span class="selector-tag">--</span>&gt; <span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.expanduser</span>()</span><br><span class="line"></span><br><span class="line"> <span class="selector-tag">os</span><span class="selector-class">.stat</span>() <span class="selector-tag">--</span>&gt; <span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.stat</span>()</span><br><span class="line"></span><br><span class="line"> <span class="selector-tag">os</span><span class="selector-class">.chmod</span>() <span class="selector-tag">--</span>&gt; <span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.chmod</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>官网文档截图： <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f2f489ba95c7?w=1268&amp;h=675&amp;f=png&amp;s=81475" alt=""> 详细请查看官方文档:<a href="https://docs.python.org/3/library/pathlib.html#methods" target="_blank" rel="noopener">插眼传送</a></p>
                  <h2 id="再举几个栗子"><a href="#再举几个栗子" class="headerlink" title="再举几个栗子"></a>再举几个栗子</h2>
                  <p>刚才的案例并不能说明什么，只是让我们了解到 pathlib 的构成，接下来让我们感受一下它带给我们的便捷。</p>
                  <h3 id="获取上层-上层目录"><a href="#获取上层-上层目录" class="headerlink" title="获取上层/上层目录"></a>获取上层/上层目录</h3>
                  <p>也就是获取它爷爷的名字 <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f7ac5fcfc394?w=1197&amp;h=438&amp;f=png&amp;s=28570" alt=""> os 模块的写法为：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">print(<span class="name">os</span>.path.dirname(<span class="name">os</span>.path.dirname(<span class="name">os</span>.getcwd())))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f37dca2cee03?w=1702&amp;h=461&amp;f=png&amp;s=59217" alt=""> 如果用 pathlib 来实现：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">pathlib</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">print</span>(<span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.cwd</span>()<span class="selector-class">.parent</span><span class="selector-class">.parent</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f3907795c105?w=1493&amp;h=383&amp;f=png&amp;s=57514" alt=""> parent 就完事了，这是不是更贴近 Pythonic ？ 像写英语一样写代码。 如果你只需要找到它爸爸，那就使用一次：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">pathlib</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">print</span>(<span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.cwd</span>()<span class="selector-class">.parent</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>你还可以继续往祖辈上找：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">pathlib</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">print</span>(<span class="selector-tag">pathlib</span><span class="selector-class">.Path</span><span class="selector-class">.cwd</span>()<span class="selector-class">.parent</span><span class="selector-class">.parent</span><span class="selector-class">.parent</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f3ce29deae54?w=1422&amp;h=363&amp;f=png&amp;s=53634" alt=""> 相对与之前 os 模块使用的多层 os.path.dirname，使用 parent 是不是便捷很多？</p>
                  <h3 id="路径拼接"><a href="#路径拼接" class="headerlink" title="路径拼接"></a>路径拼接</h3>
                  <p>如果你要在它爷爷辈那里拼接路径，那么你需要写这么长一串代码：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">print(<span class="name">os</span>.path.join(<span class="name">os</span>.path.dirname(<span class="name">os</span>.path.dirname(<span class="name">os</span>.getcwd())), <span class="string">"关注"</span>, <span class="string">"微信公众号"</span>, <span class="string">"【进击的"</span>, <span class="string">"Coder】"</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f610d27e5947?w=1799&amp;h=398&amp;f=png&amp;s=56070" alt=""> 当你用 pathlib 的时候，你一定能够感受到快乐：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pathlib</span><br><span class="line"></span><br><span class="line">parts = [<span class="string">"关注"</span>, <span class="string">"微信公众号"</span>, <span class="string">"【进击的"</span>, <span class="string">"Coder】"</span>]</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(pathlib.Path.cwd()</span></span><span class="selector-class">.parent</span><span class="selector-class">.parent</span>.joinpath(*parts))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>而且你还可以通过增加或减少 parent 的数量，来实现它祖辈的调节，美哉。</p>
                  <h1 id="PurePath"><a href="#PurePath" class="headerlink" title="PurePath"></a>PurePath</h1>
                  <p>上面的操作大部分都通过 pathlib 中的 Path 实现，其实它还有另一个模块 PurePath。</p>
                  <blockquote>
                    <p>PurePath 是一个纯路径对象，纯路径对象提供了实际上不访问文件系统的路径处理操作。有三种方法可以访问这些类，我们也称之为flavor。</p>
                  </blockquote>
                  <p>上面这句话来自于官方文档，听起来还是有点绕，我们还是通过栗子来了解它吧</p>
                  <h3 id="PurePath-match"><a href="#PurePath-match" class="headerlink" title="PurePath.match"></a>PurePath.match</h3>
                  <p>让我们来判断一下，当前文件路径是否有符合 ‘*.py’ 规则的文件</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pathlib</span><br><span class="line"></span><br><span class="line">print(<span class="name">pathlib</span>.PurePath(<span class="name">__file__</span>).match('*.py'))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f9dfde47ae14?w=1476&amp;h=326&amp;f=png&amp;s=34765" alt=""> 很显然，我们编写代码的 coder.py 就符合规则，所以输出是 True。 为什么我要拿这个来举例呢？再深入想一下 pathlib.PurePath 后面能够跟着 match，那说明它应该是个对象，而不是一个路径字符串。为了验证这个想法，把代码改一改：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pathlib</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">os_path = os<span class="selector-class">.path</span>.dirname(__file__)</span><br><span class="line">pure_path = pathlib.PurePath(__file__)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(os_path, type(os_path)</span></span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(pure_path, type(pure_path)</span></span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(pathlib.PurePath(__file__)</span></span>.match(<span class="string">'*.py'</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fa51dc777a36?w=1526&amp;h=540&amp;f=png&amp;s=74413" alt=""> 打印通过 os.path 获取当前路径的结果，得出一个路径字符串；而通过 pathlib.Pure 则获得的是一个 <strong>PurePosixPath</strong> 对象，并且得到的路径包括了当前文件 coder.py。 这就有点悬疑了， PurePosixPath 究竟是什么？ pathlib 可以操作两种文件系统的路径，一种是 Windows 文件系统，另一种称为非 Windows 文件系统，对应的对象是 <a href="PureWindowsPath">pathlib.PurePosixPath</a> 和 <a href="PureWindowsPath">PureWindowsPath</a>，不过不用担心，这些类并非是指定在某些操作系统上运行才能够使用，无论你运行的是哪个系统，都可以实例化所有这些类，因为它们不提供任何进行系统调用的操作。 不提供任何进行系统调用的操作，这又是什么？真是越听越深了 文档在最开始给出了这么一段描述:</p>
                  <blockquote>
                    <p>Pure paths are useful in some special cases; for example: If you want to manipulate Windows paths on a Unix machine (or vice versa). You cannot instantiate a WindowsPath when running on Unix, but you can instantiate PureWindowsPath. You want to make sure that your code only manipulates paths without actually accessing the OS. In this case, instantiating one of the pure classes may be useful since those simply don’t have any OS-accessing operations. 翻译：纯路径在某些特殊情况下很有用; 例如： 如果要在Unix计算机上操作Windows路径（反之亦然）。WindowsPath在Unix上运行时无法实例化，但可以实例化PureWindowsPath。 您希望确保您的代码仅操作路径而不实际访问操作系统。在这种情况下，实例化其中一个纯类可能很有用，因为那些只是没有任何操作系统访问操作。</p>
                  </blockquote>
                  <p>还附上了一张图： <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fae4d58d74a5?w=538&amp;h=495&amp;f=png&amp;s=18221" alt=""> 一下子也不是很理解，这是什么意思。不要紧，继续往下看。</p>
                  <h1 id="对应关系"><a href="#对应关系" class="headerlink" title="对应关系"></a>对应关系</h1>
                  <p>通过以上的例子我们可以感受到，它不仅封装了 os.path 相关常用方法，还集成了 os 的其他模块，比如创建文件夹 Path.mkdir。 如果你担心记不住，没关系的，文档一直都在。并且文档给我们列出了对应关系表 <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f6944714cd2f?w=800&amp;h=637&amp;f=png&amp;s=56688" alt=""></p>
                  <h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3>
                  <p>Path.iterdir()　　# 遍历目录的子目录或者文件 Path.is_dir()　　# 判断是否是目录 Path.glob()　　# 过滤目录(返回生成器) Path.resolve()　　# 返回绝对路径 Path.exists()　　# 判断路径是否存在 Path.open()　　# 打开文件(支持with) Path.unlink()　　# 删除文件或目录(目录非空触发异常)</p>
                  <h3 id="基本属性"><a href="#基本属性" class="headerlink" title="基本属性"></a>基本属性</h3>
                  <p>Path.parts　　# 分割路径 类似os.path.split(), 不过返回元组 Path.drive　　# 返回驱动器名称 Path.root　　# 返回路径的根目录 Path.anchor　　# 自动判断返回drive或root Path.parents　　# 返回所有上级目录的列表</p>
                  <h3 id="改变路径"><a href="#改变路径" class="headerlink" title="改变路径"></a>改变路径</h3>
                  <p>Path.with_name()　　# 更改路径名称, 更改最后一级路径名 Path.with_suffix()　　# 更改路径后缀</p>
                  <h3 id="拼接路径"><a href="#拼接路径" class="headerlink" title="拼接路径"></a>拼接路径</h3>
                  <p>Path.joinpath()　　# 拼接路径 Path.relative_to()　　# 计算相对路径</p>
                  <h3 id="测试路径"><a href="#测试路径" class="headerlink" title="测试路径"></a>测试路径</h3>
                  <p>Path.match()　　# 测试路径是否符合pattern Path.is_dir()　　# 是否是文件 Path.is_absolute()　　# 是否是绝对路径 Path.is_reserved()　　# 是否是预留路径 Path.exists()　　# 判断路径是否真实存在</p>
                  <h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3>
                  <p>Path.cwd()　　# 返回当前目录的路径对象 Path.home()　　# 返回当前用户的home路径对象 Path.stat()　　# 返回路径信息, 同os.stat() Path.chmod()　　# 更改路径权限, 类似os.chmod() Path.expanduser()　　# 展开~返回完整路径对象 Path.mkdir()　　# 创建目录 Path.rename()　　# 重命名路径 Path.rglob()　　# 递归遍历所有子目录的文件</p>
                  <h1 id="pathlib-回顾"><a href="#pathlib-回顾" class="headerlink" title="pathlib 回顾"></a>pathlib 回顾</h1>
                  <p>通过上面的几个例子，我们对 pathlib 应该有一个大体的了解，接下来再回顾一下官方给 pathlib 库的定义：</p>
                  <blockquote>
                    <p>This module offers classes representing filesystem paths with semantics appropriate for different operating systems. Path classes are divided between pure paths, which provide purely computational operations without I/O, and concrete paths, which inherit from pure paths but also provide I/O operations. 释义：pathlib 提供表示文件系统路径的类，其语义适用于不同的操作系统。路径类在纯路径之间划分，纯路径提供纯粹的计算操作而没有I / O，以及具体路径，它继承纯路径但也提供I / O操作。</p>
                  </blockquote>
                  <p>回顾刚才这张图，重新理解 pathlib <img src="https://user-gold-cdn.xitu.io/2018/11/23/1673f6c43bcae0eb?w=538&amp;h=495&amp;f=png&amp;s=18074" alt=""> 如果你以前从未使用过这个模块，或者只是不确定哪个类适合您的任务，那么Path很可能就是您所需要的。它为代码运行的平台实例化一个具体路径。 <strong>总结：pathlib 不单纯是对 os 中一些模块或方法进行封装，而是为了兼容不同的操作系统，它为每类操作系统定义了接口。你希望在UNIX机器上操作Windows的路径，然而直接操作是做不到的，所以为你创建了一套接口 PurePath，你可以通过接口来实现你的目的（反之亦然）</strong></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-27 10:30:18" itemprop="dateCreated datePublished" datetime="2019-07-27T10:30:18+08:00">2019-07-27</time>
                </span>
                <span id="/6982.html" class="post-meta-item leancloud_visitors" data-flag-title="你还在用 os.path？快来感受一下 pathlib 给你带来的便捷吧！" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6970.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/6970.html" class="post-title-link" itemprop="url">5G时代谁领风骚：先看看2G、3G、4G时代都崛起了哪些公司？</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>6月6日工信部正式向中国电信、中国移动、中国联通、中国广电发放5G商用牌照。自此，中国正式进入5G商用元年。 就中国而讲，2G时代门户网站林立、社交软件初起，3G时代智能手机大战、社交类软件成为王者，4G时代直播与短视频风光无二、信息流成热话题，那5G时代谁能独领风骚？ 在5G还未全面普及之前，我们回顾一下并不遥远的昨天，在2G、3G、4G的兴起时，哪些公司应运而生，成为巨头，哪些巨头又轰然倒塌，成为历史的一部分。 <strong>2G时代，QQ崛起，阿里京东起家，门户网站林立</strong> 中国互联网的发展至今也只20年有余，自20世纪90年代末，中国人从1G时代代表性手机大哥大（摩托罗拉）手机换成了2G时代代表性手机诺基亚，彼时手机不只是接打电话，增加了发短信甚至邮件的功能。 20世纪90年代末期中国，还处在纸媒、广播和电视一统天下的传统媒体时代，但经济的迅猛发展已经造成信息饥渴，彼时媒体所提供的信息无论从丰富程度还是传播速度上都很难满足用户需求。 一个从美国麻省理工学院（MIT）攻读博士学位归来的“天之骄子”带回了一个新鲜事物，由于被美国互联网的发展深深震撼，张朝阳回国创建了中国第一家门户网站——搜狐。那是在1998年，阿里巴巴还没诞生，马化腾的QQ也未问世，李彦宏还在美国硅谷，中国互联网的舞台上，也只有张朝阳和他的搜狐。 竞争对手还未成长，搜狐独享巨大的互联网红利，2000年就上市，占据着中国门户网站头部企业的位置。 同样1998年，在搜狐成立后不到10个月，王志东的新浪网于年底成立，当时的口号是在互联网上建立全球最大的华人网站。以体育新闻传播为起点的新浪迅速扩张，进阶成为综合性新闻门户。 当时中国门户网站受资本青睐的程度，以及上市的速度堪称一个时代的奇迹，新浪网虽成立晚了搜狐10个月，但却比搜狐早了3个月在纳斯达克敲钟。 与搜狐新浪以门户网站起家不同，网易1997年成立之初以搜索引擎和免费邮箱系统立身，赶上门户网站热潮席卷中国，1998年丁磊带领网易挥师北上，落户北京，公司战略也从“系统集成商”正式转向“互联网服务提供商”。自此，网易与搜狐、新浪成为中国三大门户网站。 在张朝阳、丁磊等都借互联网东风大搞门户网站捞第一波红利的时候，在深圳创业的马化腾开始琢磨做社交。马化腾与大学同学合伙成立腾讯，当时主要做“无线网络寻呼系统”，就是将互联网和寻呼机结合，使得寻呼机可以收到互联网的传唤，并且可以收看新闻乃至电子邮件等功能。 但不可逆的是当时寻呼机业务已处于颓势，1998年，身处2G时代，手机在市场上肆意生长。马化腾当机立断，转头做IM（即时通讯软件），OICQ应运而生，OICQ1999年2月10日发布了第一个版本——OICQ 99 beta build 0210，就此，颠覆未来20年中文互联网的明星产品QQ诞生了。 此后腾讯围绕QQ延展出多款产品，包括QQ宠物、QQ空间、QQ游戏等，这为腾讯带来盈利的同时留存了海量互联网用户。QQ在中国整个2G时代都占据着社交软件第一把交椅，为腾讯后续布局游戏等可以提供天然入口，这让腾讯的产品可以轻而易举地碾压竞品。 而之后改变中国互联网格局的阿里巴巴也是在2G时代诞生的。1999年，马云带领下的18为创始人创建阿里巴巴集团。2003年，淘宝网创立，作为新生事物的淘宝网出奇制胜——没和ebay易趣争抢既有的存量市场，而是收割疯狂生长的增量市场；仅仅通过1年时间，这家“倒过来看世界”的互联网公司，就成了中国网络购物市场的领军企业。 而2004年，支付宝创立，中国第三方支付模式雏形初现。值得一提的是，同年诞生的淘宝旺旺将即时聊天工具和网络购物相联系起来，是阿里巴巴做网上零售的法宝。这时候的淘宝旺旺并没有和QQ对标，还处在阿里腾讯之间还是各自领域狂奔的时代。 在2005年淘宝的成交额就突破80亿元，甚至超越了沃尔玛。 在马云创立淘宝网，大搞电商之时，在中关村卖了几年光盘的刘强东坐不住了，2004年，京东多媒体网正式开通。或许与刘强东卖3C产品起家有关，京东电子商务平台是主打3C产品，与淘宝对标的同时又有自己清晰的定位，虽然都是做电商，但同质化并不严重。 <strong>3G时代，智能手机展露头角，巨头大战社交</strong> 整个2G时代其实属于PC端互联网，2G的手机只能打电话发短信，上网很困难。但3G通信标准将信息传输率提高了一个数量级，这是一个飞跃，3G时代真正意义上而言是移动互联网的开端，从此手机打电话的功能降到了次要的位置，而数据通信，也就是上网，成为了主要功能。 乔布斯2007年拿着一款智能手机iPhone1出现，宣布苹果主宰移动互联网时代的开始。从此手机不再以功能为主，而是以应用软件（APP）为主，APP store 更是一个划时代产品，让用户可以轻而易举地购买下载所需的应用。 中国的3G时代稍晚于美国，2009年1月，工信部为中国移动、联通、电信发布3G牌照，中国从此进入3G时代。 在智能手机初探中国市场的时间节点，三星、诺基亚、HTC等占据了巨大部分江山，而中国2G时代的功能机科健、波导、海尔等相继淡出市场，国产的智能机中兴、华为、酷派、联想等完全靠三大运营商的销售渠道生存，打着性价比旗号的合约机始终比不上价格更高的三星、HTC的中低端手机。 但2011年小米的横空出世打破了这个壁垒。3G网络在中国越来越普及，彼时在国外品牌占据中国市场，而国产智能手机厂商仅能依附三大运营商销售，而当苹果手机最具冲击力的一代iPhone4席卷全球时，一个叫雷军的人拿出了他的第一代产品——小米1，冲进中国智能手机市场。 三星与HTC主流机型定价4000元，而小米1999的超高性价比＋饥饿营销，搅动了中国智能手机市场，成为3G时代崛起的手机巨头，2012年2月，“屌丝”一词横空出世，有人说它是为屌丝而生，谁能想到日后它更是成为世界最年轻的500强？ 如果说QQ的问世是一个偶然，那微信出道是无数竞争的结果。 移动互联网兴起，当然PC端依然沉淀着大量用户，彼时的QQ为了顾及PC端的用户，界面、功能更照顾PC端，以至于没能及时赶上移动互联网的浪潮，但一个叫张小龙的人彻底颠覆了社交。 2011年1月，微信横空出世，这款主打IM的应用程序契合3G时代的特点，可以发送文字、语音、图片、视频等，一出现就借助QQ的天然优势，并打通通信录，迅速推广，以至于后续发展成为国民软件，腾讯也借此拿到了通向移动互联网第一张门票，腾讯能成为今天的巨头公司，而且地位难以撼动，微信功不可没。 其实在腾讯布局社交之时，2G时代崛起的门户大咖搜狐、新浪也瞄准了社交这个大蛋糕。只不过新浪瞄准的是信息即时分享，而搜狐一直在拾人牙慧。新浪微博自2009年一经问世便牢牢掌控着微博头把交椅的位置，就连腾讯微博的冲击也未动摇半分。 搜狐看QQ火爆便做了搜Q，见微博火爆便做了搜狐微博，还做了社区社交“白社会”，但无一例外遭遇失败。连张朝阳本人都说，“微信微博左右扇了我两个耳光。”最近张朝阳又推出“狐友”，硬要推着石头上山的张朝阳不知还有没有气力。 而前面提到2G时代阿里推出淘宝旺旺却忙着做电商，没有正面硬刚QQ，但此时看到微信在庞大的社交领域带来的巨大流量时，马云坐不住了。2013年，阿里巴巴推出了来往，这是阿里推出的即时通讯软件，也是阿里第一款独立于电商业务之外的社交产品，其核心功能是实现熟人之间的社交。 原因是马云认为腾讯已经“侵入”了阿里的地盘，要用来往去砸微信的场子，但结果大家都知晓了。但马云并不灰心，之后用支付宝做社交还是失败，只是钉钉的成功才稍找回点面子。 另外值得一提的是，3G时代，LBS应用于地图等会对4G时代滴滴、共享单车等的崛起起到推手的作用。 <strong>4G时代，团购直播视频手游异军突起，共享出行风口正盛，巨头布局信息流</strong> 如果说1G到2G是划时代的进步，而3G的短暂存在只是一个过渡，因为短短几年后，网速产生质的飞跃的4G时代迅速到来。 3G传播速度相对2G较快，可以较好满足手机上网等需求，只是播放高清视频还是比较困难。而4G的速度几乎满足无线用户所有需求。 彼时移动互联网光速发展，大面积吞噬PC互联网流量和用户。比PC端更加便捷的移动端生活服务类应用风靡中国，O2O模式成了风口上的猪。巨头们纷纷布局，阿里有口碑网，腾讯有微团购，百度则买来糯米网，但谁也不曾想最后的赢家不是巨头而是王兴的美团网，2015年，美团网与大众点评合并，重构了O2O模式。 美团成为4G时代崛起的巨头，而腾讯依靠着微信的社交流量巨大入口也不会败，阿里则有支付宝这个生活服务类的大平台，甚至日后提出新零售概念取代O2O成为新的风口，这场大战里，仿佛只有百度掉队了，从PC互联网时代跨到移动互联网时代，百度要做的产品是在抢夺自己PC端的用户，这让百度似乎有点手足无措。 网速加快受益最大的无疑是直播与视频。2016年前后，资本涌入直播赛道，以斗鱼、虎牙、YY、熊猫、全民等为首的游戏直播平台，纷纷宣布获得融资，疯狂烧钱抢夺主播和用户，以映客、花椒等移动端为主的直播也趁势而起。 彼时直播行业一片混乱，违法违规直播大行其道，随着监管力度加大，资本退场，直播赛道也一地鸡毛，也只是留下虎牙、斗鱼等直播巨头。 4G时代网速加快的同时，运营商提速降费，这让依靠文字和图片获取信息的用户越来越不满足，短视频有着天时地利人和，在用户需求之下诞生。其中以抖音、快手为代表的的社交媒体类短视频最为火爆，而以秒拍、西瓜为代表的的新闻资讯类也广受媒体和用户欢迎，以B站为首的BBS类更是抓住了细分市场。 今年年初Vlog的流行也只是吹了一阵，现已没有当时的热度，看起来短视频的风还会继续吹下去。 2G时代的三大门户巨头搜狐新浪和网易，如今搜狐和新浪的体量与网易已不是一个级别的，新浪尚有微博撑着场面，搜狐却实实在在地掉队了，网易又是如何始终保持盈利的呢？其中一个很重要的支撑点就是网易的游戏帝国，而4G时代更让网易如虎添翼。 曾经风靡全国的PC端回合制游戏“梦幻西游”，手机版一经上线便俘获众多老玩家，这个游戏特点之一就是烧钱。一位玩梦幻的朋友告诉盒饭财经，这个游戏里，充值几万也只是低端玩家而已，动辄砸百万的大有人在，而广受女性玩家喜爱的手游阴阳师也是一个人民币玩家的游戏。 从网易公布的财报不难看出，近几年网易游戏收入占每季度总收入都超过6成，与还靠着新闻资讯的新浪搜狐不同，网易应4G时代实现业务重心迁徙，还能算是互联网一线巨头。 守着微信这个巨大流量入口的腾讯布局游戏更显得理所当然，从PC端的QQ衍生出的众多小游戏为起点，到英雄联盟的大火，3G时代的天天酷跑，再到4G移动互联网时代手游吃鸡（和平精英）、王者荣耀，腾讯在每个时代都在游戏产业上走得很稳。 目前，腾讯游戏占中国游戏市场规模的5成以上，不过与网易不同的是，腾讯一直追求的是薄利多销策略。游戏内道具价格相比网易较为低廉，能取得超过千亿的年收入，全靠用户基数众多。 在PC端流量急剧下降，移动端用户暴涨之时，广告投放方也开始思考有的放矢，PC端时代是买广告位，而4G大数据时代就是买用户，这也称为信息流广告。 信息流广告最大的优势是不浪费资源，运用大数据针对性投放，既然有利可图，便成为各大巨头争先布局的板块，而这其中最为突出的就是今日头条和百度。 说起今日头条，这个曾经“小而美”的公司今年内发展成为TMD（头条、美团、滴滴）的首字母巨头，核心是张一鸣，但也得益于4G时代的浪潮。 今日头条的大获成功最引以为傲的是算法，虽然是新闻资讯类产品，但张一鸣的主创团队全是技术，不需要文字编辑。他们只做一件事，用纯技术算法手段从海量的内容中去搜索挖掘有价值的内容，最关键的是这些内容可以根据客户的需要进行“定制化”推送。这在信息爆炸时代，人们可以摆脱浩瀚无垠的信息海洋，只读取精准定制的有价值信息。 而依靠着强大的算法，什么火他做什么。微博火，做微头条，知乎火，做悟空问答，短视频直播时代到来，做火山小视频、西瓜视频、抖音，头条系产品依靠其强大的算法打造着一个又一个爆款。 2G时代，两大电商平台阿里和京东相争，虽然不是一个体量级，但是淘宝假货风行，一度让阿里痛下决心清理商家，而这些商家顺势被一个叫黄峥的人收走了，2015年，主打社交电商的拼多多应运而生。对了，这个黄峥还跟着别人和巴菲特吃过午餐。 而拼多多背后除了创始人黄峥，腾讯是第二大股东，而微信的天然社交入口让拼多多尝够了甜头，短短三年便上市，如今月活量已超过京东直逼淘宝。很显然，腾讯非常乐见有一家公司能威胁到阿里的主业务。 前文提到，LBS的应用为4G时代的滴滴发展起到推手的作用，2012年滴滴成立以来直至2014年都是缓慢上升期。但是自2014年以后，4G手机进一步普及，滴滴迅猛发展，短短一年便成为出行当之无愧的No.1，而滴滴2014年接入微信，这为滴滴提供了天然的流量入口。 但滴滴的竞品快的接入支付宝，此时阿里与腾讯在各个重合的领域相争已是司空见惯。但当时占领市场只有一个秘诀——烧钱，各种补贴各种红包雨，滴滴快的的烧钱战略持续了相当长一段时间，直到2015年滴滴快的的合并，让出行市场成为一家独大。 如果说滴滴是划时代的出行产品，那共享单车的出现引领了一个共享经济时代。 2004年，一个年轻人连同4个校友，提出“以共享经济+智能硬件，解决最后一公里出行问题”的经营理念，创立ofo共享单车项目，起先他们通过定制，将自行车通过车身号、机械锁绑定APP的方式，提供密码解锁用车的方式，在北京大学推出这一项目。这个项目的创始人叫戴威，北京大学光华管理学院的毕业生。 2015年1月27日，做媒体出身的胡玮炜和运营大牛王晓峰，在北京成立了一家名为“北京摩拜科技有限公司“的公司，他们的愿景是“让自行车回归生活”。 自此，共享单车风口吹起，共享单车“颜色大战”一触即发。而中国互联网创投倒贴钱抢市场，等日后一家独大再赚钱的逻辑，再一次在共享单车上体现的淋漓尽致。当时也就ofo和摩拜两家独大，但风口过得似乎有些快，风口过后，一地鸡毛。摩拜卖身美团，ofo深陷押金风波半死不活，老三哈罗单车如今倒是坐收渔翁之利。 <strong>5G时代，谁又能领风骚？</strong> 2G、3G、4G时代，随着互联网的发展，一些巨头应时代而生，而一些公司没能及时跟上时代的发展而掉队，还有像腾讯阿里等长盛不衰而又相互掣肘。2G、3G已然开始退网，4G时代方兴未艾，而5G时代紧赶着来了。 5G会直接加速万物互联的进程，改变我们与世界的交互界面。除了VR游戏、无人驾驶、智能物联等应用外，移动办公、会议直播、视频监控、智能城市等都会在5G的大网络下运行。智能手机厂商忙着推出5G手机，而互联网科技巨头在推出5G应用，虽然用户还未感觉到5G的速度，但这个赛道已经热得发烫。 阿里腾讯继续两强争霸？还是迷途的百度能否东山再起？是否还有头条、美团一样突然崛起的巨头？5G时代，一切皆有可能。 来源：<a href="https://www.chinaventure.com.cn/news/83-20190726-346438.html" target="_blank" rel="noopener">https://www.chinaventure.com.cn/news/83-20190726-346438.html</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-26 11:37:43" itemprop="dateCreated datePublished" datetime="2019-07-26T11:37:43+08:00">2019-07-26</time>
                </span>
                <span id="/6970.html" class="post-meta-item leancloud_visitors" data-flag-title="5G时代谁领风骚：先看看2G、3G、4G时代都崛起了哪些公司？" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6942.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/6942.html" class="post-title-link" itemprop="url">Python 爬虫利器之 Pyppeteer 的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>如果大家对 Python 爬虫有所了解的话，想必你应该听说过 Selenium 这个库，这实际上是一个自动化测试工具，现在已经被广泛用于网络爬虫中来应对 JavaScript 渲染的页面的抓取。 但 Selenium 用的时候有个麻烦事，就是环境的相关配置，得安装好相关浏览器，比如 Chrome、Firefox 等等，然后还要到官方网站去下载对应的驱动，最重要的还需要安装对应的 Python Selenium 库，确实是不是很方便，另外如果要做大规模部署的话，环境配置的一些问题也是个头疼的事情。 那么本节就介绍另一个类似的替代品，叫做 Pyppeteer。注意，是叫做 Pyppeteer，不是 Puppeteer。Puppeteer 是 Google 基于 Node.js 开发的一个工具，有了它我们可以通过 JavaScript 来控制 Chrome 浏览器的一些操作，当然也可以用作网络爬虫上，其 API 极其完善，功能非常强大。 而 Pyppeteer 又是什么呢？它实际上是 Puppeteer 的 Python 版本的实现，但他不是 Google 开发的，是一位来自于日本的工程师依据 Puppeteer 的一些功能开发出来的非官方版本。 在 Pyppetter 中，实际上它背后也是有一个类似 Chrome 浏览器的 Chromium 浏览器在执行一些动作进行网页渲染，首先说下 Chrome 浏览器和 Chromium 浏览器的渊源。</p>
                  <blockquote>
                    <p>Chromium 是谷歌为了研发 Chrome 而启动的项目，是完全开源的。二者基于相同的源代码构建，Chrome 所有的新功能都会先在 Chromium 上实现，待验证稳定后才会移植，因此 Chromium 的版本更新频率更高，也会包含很多新的功能，但作为一款独立的浏览器，Chromium 的用户群体要小众得多。两款浏览器“同根同源”，它们有着同样的 Logo，但配色不同，Chrome 由蓝红绿黄四种颜色组成，而 Chromium 由不同深度的蓝色构成。</p>
                  </blockquote>
                  <p><img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190325031516968.png" alt=""> 总的来说，两款浏览器的内核是一样的，实现方式也是一样的，可以认为是开发版和正式版的区别，功能上基本是没有太大区别的。 Pyppeteer 就是依赖于 Chromium 这个浏览器来运行的。那么有了 Pyppeteer 之后，我们就可以免去那些繁琐的环境配置等问题。如果第一次运行的时候，Chromium 浏览器没有安全，那么程序会帮我们自动安装和配置，就免去了繁琐的环境配置等工作。另外 Pyppeteer 是基于 Python 的新特性 async 实现的，所以它的一些执行也支持异步操作，效率相对于 Selenium 来说也提高了。 那么下面就让我们来一起了解下 Pyppeteer 的相关用法吧。</p>
                  <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2>
                  <p>首先就是安装问题了，由于 Pyppeteer 采用了 Python 的 async 机制，所以其运行要求的 Python 版本为 3.5 及以上。 安装方式非常简单：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> pyppeteer</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了，安装完成之后我们命令行下测试下：</p>
                  <figure class="highlight elm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">\&gt;&gt;&gt; <span class="keyword">import</span> pyppeteer</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果没有报错，那么就证明安装成功了。</p>
                  <h2 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h2>
                  <p>接下来我们测试下基本的页面渲染操作，这里我们选用的网址为：<a href="http://quotes.toscrape.com/js/，这个页面是" target="_blank" rel="noopener">http://quotes.toscrape.com/js/，这个页面是</a> JavaScript 渲染而成的，用基本的 requests 库请求得到的 HTML 结果里面是不包含页面中所见的条目内容的。 为了证明 requests 无法完成正常的抓取，我们可以先用如下代码来测试一下：</p>
                  <figure class="highlight perl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line">from pyquery import PyQuery as pq</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://quotes.toscrape.com/js/'</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line">doc = p<span class="string">q(response.text)</span></span><br><span class="line"><span class="keyword">print</span>(<span class="string">'Quotes:'</span>, doc(<span class="string">'.quote'</span>).length)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里首先使用 requests 来请求网页内容，然后使用 pyquery 来解析页面中的每一个条目。观察源码之后我们发现每个条目的 class 名为 quote，所以这里选用了 .quote 这个 CSS 选择器来选择，最后输出条目数量。 运行结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Quotes:</span> <span class="number">0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果是 0，这就证明使用 requests 是无法正常抓取到相关数据的。因为什么？因为这个页面是 JavaScript 渲染而成的，我们所看到的内容都是网页加载后又执行了 JavaScript 之后才呈现出来的，因此这些条目数据并不存在于原始 HTML 代码中，而 requests 仅仅抓取的是原始 HTML 代码。 好的，所以遇到这种类型的网站我们应该怎么办呢？ 其实答案有很多：</p>
                  <ul>
                    <li>分析网页源代码数据，如果数据是隐藏在 HTML 中的其他地方，以 JavaScript 变量的形式存在，直接提取就好了。</li>
                    <li>分析 Ajax，很多数据可能是经过 Ajax 请求时候获取的，所以可以分析其接口。</li>
                    <li>模拟 JavaScript 渲染过程，直接抓取渲染后的结果。</li>
                  </ul>
                  <p>而 Pyppeteer 和 Selenium 就是用的第三种方法，下面我们再用 Pyppeteer 来试试，如果用 Pyppeteer 实现如上页面的抓取的话，代码就可以写为如下形式：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch()</span><br><span class="line">    page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'http://quotes.toscrape.com/js/'</span>)</span><br><span class="line">    doc = pq(<span class="keyword">await</span> page.content())</span><br><span class="line">    print(<span class="string">'Quotes:'</span>, doc(<span class="string">'.quote'</span>).length)</span><br><span class="line">    <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Quotes:</span> <span class="number">10</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>看运行结果，这说明我们就成功匹配出来了 class 为 quote 的条目，总数为 10 条，具体的内容可以进一步使用 pyquery 解析查看。 那么这里面的过程发生了什么？ 实际上，Pyppeteer 整个流程就完成了浏览器的开启、新建页面、页面加载等操作。另外 Pyppeteer 里面进行了异步操作，所以需要配合 async/await 关键词来实现。 首先， launch 方法会新建一个 Browser 对象，然后赋值给 browser，然后调用 newPage 方法相当于浏览器中新建了一个选项卡，同时新建了一个 Page 对象。然后 Page 对象调用了 goto 方法就相当于在浏览器中输入了这个 URL，浏览器跳转到了对应的页面进行加载，加载完成之后再调用 content 方法，返回当前浏览器页面的源代码。然后进一步地，我们用 pyquery 进行同样地解析，就可以得到 JavaScript 渲染的结果了。 另外其他的一些方法如调用 asyncio 的 get_event_loop 等方法的相关操作则属于 Python 异步 async 相关的内容了，大家如果不熟悉可以了解下 Python 的 async/await 的相关知识。 好，通过上面的代码，我们就可以完成 JavaScript 渲染页面的爬取了。 在这个过程中，我们没有配置 Chrome 浏览器，没有配置浏览器驱动，免去了一些繁琐的步骤，同样达到了 Selenium 的效果，还实现了异步抓取，爽歪歪！ 接下来我们再看看另外一个例子，这个例子可以模拟网页截图，保存 PDF，另外还可以执行自定义的 JavaScript 获得特定的内容，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch()</span><br><span class="line">    page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'http://quotes.toscrape.com/js/'</span>)</span><br><span class="line">    <span class="keyword">await</span> page.screenshot(path=<span class="string">'example.png'</span>)</span><br><span class="line">    <span class="keyword">await</span> page.pdf(path=<span class="string">'example.pdf'</span>)</span><br><span class="line">    dimensions = <span class="keyword">await</span> page.evaluate(<span class="string">'''() =&gt; &#123;</span></span><br><span class="line"><span class="string">        return &#123;</span></span><br><span class="line"><span class="string">            width: document.documentElement.clientWidth,</span></span><br><span class="line"><span class="string">            height: document.documentElement.clientHeight,</span></span><br><span class="line"><span class="string">            deviceScaleFactor: window.devicePixelRatio,</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;'''</span>)</span><br><span class="line"></span><br><span class="line">    print(dimensions)</span><br><span class="line">    <span class="comment"># &gt;&gt;&gt; &#123;'width': 800, 'height': 600, 'deviceScaleFactor': 1&#125;</span></span><br><span class="line">    <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们又用到了几个新的 API，完成了网页截图保存、网页导出 PDF 保存、执行 JavaScript 并返回对应数据。 首先 screenshot 方法可以传入保存的图片路径，另外还可以指定保存格式 type、清晰度 quality、是否全屏 fullPage、裁切 clip 等各个参数实现截图。 截图的样例如下： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190325095645072.png" alt=""> 可以看到它返回的就是 JavaScript 渲染后的页面。 pdf 方法也是类似的，只不过页面保存格式不一样，最后得到一个多页的 pdf 文件，样例如下： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190325095759738.png" alt=""> 可见其内容也是 JavaScript 渲染后的内容，另外这个方法还可以指定放缩大小 scale、页码范围 pageRanges、宽高 width 和 height、方向 landscape 等等参数，导出定制化的 pdf 用这个方法就十分方便。 最后我们又调用了 evaluate 方法执行了一些 JavaScript，JavaScript 传入的是一个函数，使用 return 方法返回了网页的宽高、像素大小比率三个值，最后得到的是一个 JSON 格式的对象，内容如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="string">&#123;'width':</span> <span class="number">800</span><span class="string">,</span> <span class="attr">'height':</span> <span class="number">600</span><span class="string">,</span> <span class="attr">'deviceScaleFactor':</span> <span class="number">1</span><span class="string">&#125;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>OK，实例就先感受到这里，还有太多太多的功能还没提及。 总之利用 Pyppeteer 我们可以控制浏览器执行几乎所有动作，想要的操作和功能基本都可以实现，用它来自由地控制爬虫当然就不在话下了。</p>
                  <h2 id="详细用法"><a href="#详细用法" class="headerlink" title="详细用法"></a>详细用法</h2>
                  <p>了解了基本的实例之后，我们再来梳理一下 Pyppeteer 的一些基本和常用操作。Pyppeteer 的几乎所有功能都能在其官方文档的 API Reference 里面找到，链接为：<a href="https://miyakogi.github.io/pyppeteer/reference.html，用到哪个方法就来这里查询就好了，参数不必死记硬背，即用即查就好" target="_blank" rel="noopener">https://miyakogi.github.io/pyppeteer/reference.html，用到哪个方法就来这里查询就好了，参数不必死记硬背，即用即查就好</a>。</p>
                  <h3 id="开启浏览器"><a href="#开启浏览器" class="headerlink" title="开启浏览器"></a>开启浏览器</h3>
                  <p>使用 Pyppeteer 的第一步便是启动浏览器，首先我们看下怎样启动一个浏览器，其实就相当于我们点击桌面上的浏览器图标一样，把它开起来。用 Pyppeteer 完成同样的操作，只需要调用 launch 方法即可。 我们先看下 launch 方法的 API，链接为：<a href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.launcher.launch" target="_blank" rel="noopener">https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.launcher.launch</a>，其方法定义如下：</p>
                  <figure class="highlight less">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">pyppeteer</span><span class="selector-class">.launcher</span><span class="selector-class">.launch</span>(<span class="attribute">options</span>: dict = None, **kwargs) → <span class="selector-tag">pyppeteer</span><span class="selector-class">.browser</span><span class="selector-class">.Browser</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到它处于 launcher 模块中，参数没有在声明中特别指定，返回类型是 browser 模块中的 Browser 对象，另外观察源码发现这是一个 async 修饰的方法，所以调用它的时候需要使用 await。 接下来看看它的参数：</p>
                  <ul>
                    <li>ignoreHTTPSErrors (bool): 是否要忽略 HTTPS 的错误，默认是 False。</li>
                    <li>headless (bool): 是否启用 Headless 模式，即无界面模式，如果 devtools 这个参数是 True 的话，那么该参数就会被设置为 False，否则为 True，即默认是开启无界面模式的。</li>
                    <li>executablePath (str): 可执行文件的路径，如果指定之后就不需要使用默认的 Chromium 了，可以指定为已有的 Chrome 或 Chromium。</li>
                    <li>slowMo (int|float): 通过传入指定的时间，可以减缓 Pyppeteer 的一些模拟操作。</li>
                    <li>args (List[str]): 在执行过程中可以传入的额外参数。</li>
                    <li>ignoreDefaultArgs (bool): 不使用 Pyppeteer 的默认参数，如果使用了这个参数，那么最好通过 args 参数来设定一些参数，否则可能会出现一些意想不到的问题。这个参数相对比较危险，慎用。</li>
                    <li>handleSIGINT (bool): 是否响应 SIGINT 信号，也就是可以使用 Ctrl + C 来终止浏览器程序，默认是 True。</li>
                    <li>handleSIGTERM (bool): 是否响应 SIGTERM 信号，一般是 kill 命令，默认是 True。</li>
                    <li>handleSIGHUP (bool): 是否响应 SIGHUP 信号，即挂起信号，比如终端退出操作，默认是 True。</li>
                    <li>dumpio (bool): 是否将 Pyppeteer 的输出内容传给 process.stdout 和 process.stderr 对象，默认是 False。</li>
                    <li>userDataDir (str): 即用户数据文件夹，即可以保留一些个性化配置和操作记录。</li>
                    <li>env (dict): 环境变量，可以通过字典形式传入。</li>
                    <li>devtools (bool): 是否为每一个页面自动开启调试工具，默认是 False。如果这个参数设置为 True，那么 headless 参数就会无效，会被强制设置为 False。</li>
                    <li>logLevel (int|str): 日志级别，默认和 root logger 对象的级别相同。</li>
                    <li>autoClose (bool): 当一些命令执行完之后，是否自动关闭浏览器，默认是 True。</li>
                    <li>loop (asyncio.AbstractEventLoop): 时间循环对象。</li>
                  </ul>
                  <p>好了，知道这些参数之后，我们可以先试试看。 首先可以试用下最常用的参数 headless，如果我们将它设置为 True 或者默认不设置它，在启动的时候我们是看不到任何界面的，如果把它设置为 False，那么在启动的时候就可以看到界面了，一般我们在调试的时候会把它设置为 False，在生产环境上就可以设置为 True，我们先尝试一下关闭 headless 模式：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">await</span> launch(headless=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行之后看不到任何控制台输出，但是这时候就会出现一个空白的 Chromium 界面了： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416075926432.png" alt=""> 但是可以看到这就是一个光秃秃的浏览器而已，看一下相关信息： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416080103093.png" alt=""> 看到了，这就是 Chromium，上面还写了开发者内部版本，可以认为是开发版的 Chrome 浏览器就好。 另外我们还可以开启调试模式，比如在写爬虫的时候会经常需要分析网页结构还有网络请求，所以开启调试工具还是很有必要的，我们可以将 devtools 参数设置为 True，这样每开启一个界面就会弹出一个调试窗口，非常方便，示例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer import launch</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    browser = await launch(<span class="attribute">devtools</span>=<span class="literal">True</span>)</span><br><span class="line">   <span class="built_in"> page </span>= await browser.newPage()</span><br><span class="line">    await page.goto(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">    await asyncio.sleep(100)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>刚才说过 devtools 这个参数如果设置为了 True，那么 headless 就会被关闭了，界面始终会显现出来。在这里我们新建了一个页面，打开了百度，界面运行效果如下： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416081010098.png" alt=""> 这时候我们可以看到上面的一条提示：”Chrome 正受到自动测试软件的控制”，这个提示条有点烦，那咋关闭呢？这时候就需要用到 args 参数了，禁用操作如下：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">browser</span> = await launch(headless=<span class="literal">False</span>, args=[<span class="string">'--disable-infobars'</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里就不再写完整代码了，就是在 launch 方法中，args 参数通过 list 形式传入即可，这里使用的是 —disable-infobars 的参数。 另外有人就说了，这里你只是把提示关闭了，有些网站还是会检测到是 webdriver 吧，比如淘宝检测到是 webdriver 就会禁止登录了，我们可以试试：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer import launch</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    browser = await launch(<span class="attribute">headless</span>=<span class="literal">False</span>)</span><br><span class="line">   <span class="built_in"> page </span>= await browser.newPage()</span><br><span class="line">    await page.goto(<span class="string">'https://www.taobao.com'</span>)</span><br><span class="line">    await asyncio.sleep(100)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行时候进行一下登录，然后就会弹出滑块，自己手动拖动一下，然后就报错了，界面如下： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416085103827.png" alt=""> 爬虫的时候看到这界面是很让人崩溃的吧，而且这时候我们还发现了页面的 bug，整个浏览器窗口比显示的内容窗口要大，这个是某些页面会出现的情况，让人看起来很不爽。 我们可以先解决一下这个显示的 bug，需要设置下 window-size 还有 viewport，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">width, height = <span class="number">1366</span>, <span class="number">768</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch(headless=<span class="literal">False</span>,</span><br><span class="line">                           args=[<span class="string">f'--window-size=<span class="subst">&#123;width&#125;</span>,<span class="subst">&#123;height&#125;</span>'</span>])</span><br><span class="line">    page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">    <span class="keyword">await</span> page.setViewport(&#123;<span class="string">'width'</span>: width, <span class="string">'height'</span>: height&#125;)</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.taobao.com'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样整个界面就正常了： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416090302627.png" alt=""> OK，那刚才所说的 webdriver 检测问题怎样来解决呢？其实淘宝主要通过 window.navigator.webdriver 来对 webdriver 进行检测，所以我们只需要使用 JavaScript 将它设置为 false 即可，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch(headless=<span class="literal">False</span>, args=[<span class="string">'--disable-infobars'</span>])</span><br><span class="line">    page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://login.taobao.com/member/login.jhtml?redirectURL=https://www.taobao.com/'</span>)</span><br><span class="line">    <span class="keyword">await</span> page.evaluate(</span><br><span class="line">        <span class="string">'''() =&gt;&#123; Object.defineProperties(navigator,&#123; webdriver:&#123; get: () =&gt; false &#125; &#125;) &#125;'''</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里没加输入用户名密码的代码，当然后面可以自行添加，下面打开之后，我们点击输入用户名密码，然后这时候会出现一个滑动条，这里滑动的话，就可以通过了，如图所示： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416205859048.png" alt=""> OK，这样的话我们就成功规避了 webdriver 的检测，使用鼠标拖动模拟就可以完成淘宝的登录了。 还有另一种方法可以进一步免去淘宝登录的烦恼，那就是设置用户目录。平时我们已经注意到，当我们登录淘宝之后，如果下次再次打开浏览器发现还是登录的状态。这是因为淘宝的一些关键 Cookies 已经保存到本地了，下次登录的时候可以直接读取并保持登录状态。 那么这些信息保存在哪里了呢？其实就是保存在用户目录下了，里面不仅包含了浏览器的基本配置信息，还有一些 Cache、Cookies 等各种信息都在里面，如果我们能在浏览器启动的时候读取这些信息，那么启动的时候就可以恢复一些历史记录甚至一些登录状态信息了。 这也就解决了一个问题：很多朋友在每次启动 Selenium 或 Pyppeteer 的时候总是是一个全新的浏览器，那就是没有设置用户目录，如果设置了它，每次打开就不再是一个全新的浏览器了，它可以恢复之前的历史记录，也可以恢复很多网站的登录信息。 那么这个怎么来做呢？很简单，在启动的时候设置 userDataDir 就好了，示例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer import launch</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    browser = await launch(<span class="attribute">headless</span>=<span class="literal">False</span>, <span class="attribute">userDataDir</span>=<span class="string">'./userdata'</span>, args=[<span class="string">'--disable-infobars'</span>])</span><br><span class="line">   <span class="built_in"> page </span>= await browser.newPage()</span><br><span class="line">    await page.goto(<span class="string">'https://www.taobao.com'</span>)</span><br><span class="line">    await asyncio.sleep(100)</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好，这里就是加了一个 userDataDir 的属性，值为 userdata，即当前目录的 userdata 文件夹。我们可以首先运行一下，然后登录一次淘宝，这时候我们同时可以观察到在当前运行目录下又多了一个 userdata 的文件夹，里面的结构是这样子的： <img src="https://qiniu.cuiqingcai.com/2019-07-26-image-20190416211340444.png" alt=""> 具体的介绍可以看官方的一些说明，如：<a href="https://chromium.googlesource.com/chromium/src/+/master/docs/user_data_dir.md" target="_blank" rel="noopener">https://chromium.googlesource.com/chromium/src/+/master/docs/user_data_dir.md</a>，这里面介绍了 userdatadir 的相关内容。 再次运行上面的代码，这时候可以发现现在就已经是登录状态了，不需要再次登录了，这样就成功跳过了登录的流程。当然可能时间太久了，Cookies 都过期了，那还是需要登录的。 好了，本想把 Pyppeteer 的用法详细介绍完的，结果只 launch 的方法就介绍这么多了，后面的内容放到其他文章来介绍了，其他的内容后续文章会陆续放出，谢谢。</p>
                  <h2 id="本节代码获取"><a href="#本节代码获取" class="headerlink" title="本节代码获取"></a>本节代码获取</h2>
                  <p>公众号”进击的Coder”回复”Pyppeteer”即可获取本节全部代码。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-26 10:46:18" itemprop="dateCreated datePublished" datetime="2019-07-26T10:46:18+08:00">2019-07-26</time>
                </span>
                <span id="/6942.html" class="post-meta-item leancloud_visitors" data-flag-title="Python 爬虫利器之 Pyppeteer 的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>9.6k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>9 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6924.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/6924.html" class="post-title-link" itemprop="url">程序员开发必知必会之正则表达式学习资料</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="正则表达式30分钟入门教程（https-deerchao-net-tutorials-regex-regex-htm）"><a href="#正则表达式30分钟入门教程（https-deerchao-net-tutorials-regex-regex-htm）" class="headerlink" title="正则表达式30分钟入门教程（https://deerchao.net/tutorials/regex/regex.htm）"></a>正则表达式30分钟入门教程（<a href="https://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">https://deerchao.net/tutorials/regex/regex.htm</a>）</h2>
                  <p><img src="https://qiniu.cuiqingcai.com/2019-07-25-232029.png" alt=""></p>
                  <blockquote>
                    <p>本教程目标：30分钟内让你明白正则表达式是什么，并对它有一些基本的了解，让你可以在自己的程序或网页里使用它。</p>
                  </blockquote>
                  <h2 id="正则表达式-必知必会（https-www-zybuluo-com-Yano-note-475174）"><a href="#正则表达式-必知必会（https-www-zybuluo-com-Yano-note-475174）" class="headerlink" title="正则表达式 必知必会（https://www.zybuluo.com/Yano/note/475174）"></a>正则表达式 必知必会（<a href="https://www.zybuluo.com/Yano/note/475174" target="_blank" rel="noopener">https://www.zybuluo.com/Yano/note/475174</a>）</h2>
                  <p><img src="https://qiniu.cuiqingcai.com/2019-07-25-232021.png" alt=""></p>
                  <h2 id="Zjmainstay学习笔记-正则表达式（http-www-zjmainstay-cn-regexp）"><a href="#Zjmainstay学习笔记-正则表达式（http-www-zjmainstay-cn-regexp）" class="headerlink" title="Zjmainstay学习笔记 | 正则表达式（http://www.zjmainstay.cn/regexp）"></a>Zjmainstay学习笔记 | 正则表达式（<a href="http://www.zjmainstay.cn/regexp" target="_blank" rel="noopener">http://www.zjmainstay.cn/regexp</a>）</h2>
                  <p><img src="https://qiniu.cuiqingcai.com/2019-07-25-232013.png" alt=""></p>
                  <h2 id="《精通正则表达式-第三版》"><a href="#《精通正则表达式-第三版》" class="headerlink" title="《精通正则表达式 第三版》"></a>《精通正则表达式 第三版》</h2>
                  <ol>
                    <li>最后，推荐一本动物书《精通正则表达式 第三版》</li>
                  </ol>
                  <blockquote>
                    <p><strong>【顺手提供】</strong>精通正则表达式：第三版 PDF (高清-中文-带标签)</p>
                    <p>关注本公众号<strong>【离不开的网】</strong>，后台回复 “ <strong>正则pdf</strong> ” 即可。</p>
                  </blockquote>
                  <p><img src="https://qiniu.cuiqingcai.com/2019-07-25-231906.png" alt=""></p>
                  <h2 id="相关好文推荐"><a href="#相关好文推荐" class="headerlink" title="相关好文推荐"></a>相关好文推荐</h2>
                  <ol>
                    <li>
                      <p>想精通正则表达式 这几个正则表达式学习资料及工具你必须有 ：<a href="https://www.cnblogs.com/3rocks/p/11212724.html" target="_blank" rel="noopener">https://www.cnblogs.com/3rocks/p/11212724.html</a></p>
                    </li>
                    <li>
                      <p>菜鸟教程-正则表达式 ：<a href="https://www.runoob.com/regexp/regexp-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/regexp/regexp-tutorial.html</a></p>
                    </li>
                    <li>
                      <p>正则表达式速查表 ：<a href="https://www.jb51.net/article/67634.htm" target="_blank" rel="noopener">https://www.jb51.net/article/67634.htm</a></p>
                    </li>
                    <li>
                      <p>细说python正则表达式 ：<a href="https://www.jianshu.com/p/147fab022566" target="_blank" rel="noopener">https://www.jianshu.com/p/147fab022566</a></p>
                    </li>
                    <li>
                      <p>路人甲的关于正则表达式 ：<a href="https://zhuanlan.zhihu.com/p/21341872?refer=passer" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/21341872?refer=passer</a></p>
                    </li>
                    <li>
                      <p>最全的常用正则表达式大全——包括校验数字、字符、一些特殊的需求等等 ：<a href="http://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html" target="_blank" rel="noopener">http://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html</a></p>
                    </li>
                    <li>
                      <p>深入理解正则表达式 ：<a href="https://www.cnblogs.com/China3S/archive/2013/11/30/3451971.html" target="_blank" rel="noopener">https://www.cnblogs.com/China3S/archive/2013/11/30/3451971.html</a></p>
                    </li>
                  </ol>
                  <blockquote>
                    <p>原文链接：<a href="https://mp.weixin.qq.com/s/CGSUJntKtvOrV1o-R2GrRw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/CGSUJntKtvOrV1o-R2GrRw</a> 来源公众号：离不开的网</p>
                  </blockquote>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-26 07:22:47" itemprop="dateCreated datePublished" datetime="2019-07-26T07:22:47+08:00">2019-07-26</time>
                </span>
                <span id="/6924.html" class="post-meta-item leancloud_visitors" data-flag-title="程序员开发必知必会之正则表达式学习资料" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>845</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6921.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6921.html" class="post-title-link" itemprop="url">一看就懂，Python 日志 logging 模块详解及应用</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="日志概述"><a href="#日志概述" class="headerlink" title="日志概述"></a>日志概述</h2>
                  <p><strong>百度百科的日志概述</strong>： Windows网络操作系统都设计有各种各样的日志文件，如应用程序日志，安全日志、系统日志、Scheduler服务日志、FTP日志、WWW日志、DNS服务器日志等等，这些根据你的系统开启的服务的不同而有所不同。我们在系统上进行一些操作时，这些日志文件通常会记录下我们操作的一些相关内容，这些内容对系统安全工作人员相当有用。比如说有人对系统进行了IPC探测，系统就会在安全日志里迅速地记下探测者探测时所用的IP、时间、用户名等，用FTP探测后，就会在FTP日志中记下IP、时间、探测所用的用户名等。 <strong>我映像中的日志</strong>： 查看日志是开发人员日常获取信息、排查异常、发现问题的最好途径，日志记录中通常会标记有异常产生的原因、发生时间、具体错误行数等信息，这极大的节省了我们的排查时间，无形中提高了编码效率。</p>
                  <h2 id="日志分类"><a href="#日志分类" class="headerlink" title="日志分类"></a>日志分类</h2>
                  <p>我们可以按照输出终端进行分类，也可以按照日志级别进行分类。输出终端指的是将日志在控制台输出显示和将日志存入文件；日志级别指的是 Debug、Info、WARNING、ERROR以及CRITICAL等严重等级进行划分。</p>
                  <h2 id="Python-的-logging"><a href="#Python-的-logging" class="headerlink" title="Python 的 logging"></a>Python 的 logging</h2>
                  <p>logging提供了一组便利的日志函数，它们分别是：debug()、 info()、 warning()、 error() 和 critical()。logging函数根据它们用来跟踪的事件的级别或严重程度来命名。标准级别及其适用性描述如下（以严重程度递增排序）： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672b380840b4fa6?w=853&amp;h=229&amp;f=png&amp;s=38748" alt=""> 每个级别对应的数字值为 CRITICAL：50，ERROR：40，WARNING：30，INFO：20，DEBUG：10，NOTSET：0。 Python 中日志的默认等级是 WARNING，DEBUG 和 INFO 级别的日志将不会得到显示，在 logging 中更改设置。</p>
                  <h2 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h2>
                  <h3 id="输出到控制台"><a href="#输出到控制台" class="headerlink" title="输出到控制台"></a>输出到控制台</h3>
                  <p>使用 logging 在控制台打印日志，这里我们用 Pycharm 编辑器来观察：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.<span class="builtin-name">debug</span>(<span class="string">'崔庆才丨静觅、韦世东丨奎因'</span>)</span><br><span class="line">logging.<span class="builtin-name">warning</span>(<span class="string">'邀请你关注微信公众号【进击的 Coder】'</span>)</span><br><span class="line">logging.<span class="builtin-name">info</span>(<span class="string">'和大佬一起coding、共同进步'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bb018ec815a3?w=1206&amp;h=455&amp;f=png&amp;s=103466" alt=""> 从上图运行的结果来看，的确只显示了 WARNING 级别的信息，验证了上面的观点。同时也在控制台输出了日志内容，默认情况下 Python 中使用 logging 模块中的函数打印日志，日志只会在控制台输出，而不会保存到日文件。 <strong>有什么办法可以改变默认的日志级别呢？</strong> 当然是有的，logging 中提供了 basicConfig 让使用者可以适时调节默认日志级别，我们可以将上面的代码改为：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="attribute">level</span>=logging.DEBUG)</span><br><span class="line">logging.<span class="builtin-name">debug</span>(<span class="string">'崔庆才丨静觅、韦世东丨奎因'</span>)</span><br><span class="line">logging.<span class="builtin-name">warning</span>(<span class="string">'邀请你关注微信公众号【进击的 Coder】'</span>)</span><br><span class="line">logging.<span class="builtin-name">info</span>(<span class="string">'和大佬一起coding、共同进步'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bb0f460bc73c?w=1154&amp;h=488&amp;f=png&amp;s=128578" alt=""> 在 basicConfig 中设定 level 参数的级别即可。 思考：如果设定级别为 logging.INFO，那 DEBUG 信息能够显示么？</p>
                  <h3 id="保存到文件"><a href="#保存到文件" class="headerlink" title="保存到文件"></a>保存到文件</h3>
                  <p>刚才演示了如何在控制台输出日志内容，并且自由设定日志的级别，那现在就来看看如何将日志保存到文件。依旧是强大的 basicConfig，我们再将上面的代码改为：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(<span class="attribute">level</span>=logging.DEBUG, <span class="attribute">filename</span>=<span class="string">'coder.log'</span>, <span class="attribute">filemode</span>=<span class="string">'a'</span>)</span><br><span class="line">logging.<span class="builtin-name">debug</span>(<span class="string">'崔庆才丨静觅、韦世东丨奎因'</span>)</span><br><span class="line">logging.<span class="builtin-name">warning</span>(<span class="string">'邀请你关注微信公众号【进击的 Coder】'</span>)</span><br><span class="line">logging.<span class="builtin-name">info</span>(<span class="string">'和大佬一起coding、共同进步'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bb1abdf6b05b?w=1320&amp;h=412&amp;f=png&amp;s=100828" alt=""> 在配置中填写 filename （指定文件名） 和 filemode （文件写入方式），控制台的日志输出就不见了，那么 coder.log 会生成么？ <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bb2629d9df1a?w=991&amp;h=236&amp;f=png&amp;s=47054" alt=""> 在 .py 文件的同级目录生成了名为 coder.log 的日志。 通过简单的代码设置，我们就完成了日志文件在控制台和文件中的输出。那既在控制台显示又能保存到文件中呢？</p>
                  <h2 id="强大的-logging"><a href="#强大的-logging" class="headerlink" title="强大的 logging"></a>强大的 logging</h2>
                  <p>logging所提供的模块级别的日志记录函数是对logging日志系统相关类的封装 logging 模块提供了两种记录日志的方式：</p>
                  <ul>
                    <li>使用logging提供的模块级别的函数</li>
                    <li>使用Logging日志系统的四大组件</li>
                  </ul>
                  <p>这里提到的级别函数就是上面所用的 DEBGE、ERROR 等级别，而四大组件则是指 loggers、handlers、filters 和 formatters 这几个组件，下图简单明了的阐述了它们各自的作用： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bb8e26053d22?w=599&amp;h=210&amp;f=png&amp;s=38081" alt=""> 日志器（logger）是入口，真正工作的是处理器（handler），处理器（handler）还可以通过过滤器（filter）和格式器（formatter）对要输出的日志内容做过滤和格式化等处理操作。</p>
                  <h3 id="四大组件"><a href="#四大组件" class="headerlink" title="四大组件"></a>四大组件</h3>
                  <p>下面介绍下与logging四大组件相关的类：Logger, Handler, Filter, Formatter。 <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bd8de061fc84?w=686&amp;h=620&amp;f=png&amp;s=6905" alt=""> <strong>Logger类</strong> Logger 对象有3个工作要做：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">1</span>）向应用程序代码暴露几个方法，使应用程序可以在运行时记录日志消息；</span><br><span class="line"><span class="number">2</span>）基于日志严重等级（默认的过滤设施）或filter对象来决定要对哪些日志进行后续处理；</span><br><span class="line"><span class="number">3</span>）将日志消息传送给所有感兴趣的日志handlers。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Logger对象最常用的方法分为两类：配置方法 和 消息发送方法 最常用的配置方法如下： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bbaf86c3a29d?w=620&amp;h=167&amp;f=png&amp;s=29759" alt=""> 关于Logger.setLevel()方法的说明： 内建等级中，级别最低的是DEBUG，级别最高的是CRITICAL。例如setLevel(logging.INFO)，此时函数参数为INFO，那么该logger将只会处理INFO、WARNING、ERROR和CRITICAL级别的日志，而DEBUG级别的消息将会被忽略/丢弃。 logger对象配置完成后，可以使用下面的方法来创建日志记录： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bbbf3d172a74?w=689&amp;h=234&amp;f=png&amp;s=34940" alt=""> 那么，怎样得到一个Logger对象呢？一种方式是通过Logger类的实例化方法创建一个Logger类的实例，但是我们通常都是用第二种方式—logging.getLogger()方法。 logging.getLogger()方法有一个可选参数name，该参数表示将要返回的日志器的名称标识，如果不提供该参数，则其值为’root’。若以相同的name参数值多次调用getLogger()方法，将会返回指向同一个logger对象的引用。</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">关于logger的层级结构与有效等级的说明：</span><br><span class="line"></span><br><span class="line">    logger的名称是一个以<span class="string">'.'</span>分割的层级结构，每个<span class="string">'.'</span>后面的logger都是<span class="string">'.'</span>前面的logger的children，例如，有一个名称为 foo 的logger，其它名称分别为 foo.bar, foo.bar.baz 和 foo.bam都是 foo 的后代。</span><br><span class="line">    logger有一个"有效等级（effective level）"的概念。如果一个logger上没有被明确设置一个<span class="keyword">level</span>，那么该logger就是使用它parent的<span class="keyword">level</span>;如果它的parent也没有明确设置<span class="keyword">level</span>则继续向上查找parent的parent的有效<span class="keyword">level</span>，依次类推，直到找到个一个明确设置了<span class="keyword">level</span>的祖先为止。需要说明的是，root logger总是会有一个明确的<span class="keyword">level</span>设置（默认为 <span class="built_in">WARNING</span>）。当决定是否去处理一个已发生的事件时，logger的有效等级将会被用来决定是否将该事件传递给该logger的handlers进行处理。</span><br><span class="line">    child loggers在完成对日志消息的处理后，默认会将日志消息传递给与它们的祖先loggers相关的handlers。因此，我们不必为一个应用程序中所使用的所有loggers定义和配置handlers，只需要为一个顶层的logger配置handlers，然后按照需要创建child loggers就可足够了。我们也可以通过将一个logger的propagate属性设置为<span class="keyword">False</span>来关闭这种传递机制。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><strong>Handler</strong> Handler对象的作用是（基于日志消息的level）将消息分发到handler指定的位置（文件、网络、邮件等）。Logger对象可以通过addHandler()方法为自己添加0个或者更多个handler对象。比如，一个应用程序可能想要实现以下几个日志需求：</p>
                  <figure class="highlight lsl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">1</span>）把所有日志都发送到一个日志文件中；</span><br><span class="line"><span class="number">2</span>）把所有严重级别大于等于error的日志发送到stdout（标准输出）；</span><br><span class="line"><span class="number">3</span>）把所有严重级别为critical的日志发送到一个<span class="section">email</span>邮件地址。</span><br><span class="line">这种场景就需要<span class="number">3</span>个不同的handlers，每个handler复杂发送一个特定严重级别的日志到一个特定的位置。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>一个handler中只有非常少数的方法是需要应用开发人员去关心的。对于使用内建handler对象的应用开发人员来说，似乎唯一相关的handler方法就是下面这几个配置方法： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bbcf0837d1f2?w=608&amp;h=169&amp;f=png&amp;s=27138" alt=""> 需要说明的是，应用程序代码不应该直接实例化和使用Handler实例。因为Handler是一个基类，它只定义了素有handlers都应该有的接口，同时提供了一些子类可以直接使用或覆盖的默认行为。下面是一些常用的Handler： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bbd41c2102cc?w=691&amp;h=433&amp;f=png&amp;s=82087" alt=""> <strong>Formater</strong> Formater对象用于配置日志信息的最终顺序、结构和内容。与logging.Handler基类不同的是，应用代码可以直接实例化Formatter类。另外，如果你的应用程序需要一些特殊的处理行为，也可以实现一个Formatter的子类来完成。 Formatter类的构造方法定义如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">logging.Formatter.__init__(<span class="attribute">fmt</span>=None, <span class="attribute">datefmt</span>=None, <span class="attribute">style</span>=<span class="string">'%'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>该构造方法接收3个可选参数：</p>
                  <ul>
                    <li>fmt：指定消息格式化字符串，如果不指定该参数则默认使用message的原始值</li>
                    <li>datefmt：指定日期格式字符串，如果不指定该参数则默认使用”%Y-%m-%d %H:%M:%S”</li>
                    <li>style：Python 3.2新增的参数，可取值为 ‘%’, ‘{‘和 ‘$’，如果不指定该参数则默认使用’%’</li>
                  </ul>
                  <p><strong>Filter</strong> Filter可以被Handler和Logger用来做比level更细粒度的、更复杂的过滤功能。Filter是一个过滤器基类，它只允许某个logger层级下的日志事件通过过滤。该类定义如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">class</span> logging.<span class="keyword">Filter</span>(<span class="type">name</span>=<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">filter</span>(<span class="type">record</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>比如，一个filter实例化时传递的name参数值为’A.B’，那么该filter实例将只允许名称为类似如下规则的loggers产生的日志记录通过过滤：’A.B’，’A.B,C’，’A.B.C.D’，’A.B.D’，而名称为’A.BB’, ‘B.A.B’的loggers产生的日志则会被过滤掉。如果name的值为空字符串，则允许所有的日志事件通过过滤。 filter方法用于具体控制传递的record记录是否能通过过滤，如果该方法返回值为0表示不能通过过滤，返回值为非0表示可以通过过滤。</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">说明：</span><br><span class="line"></span><br><span class="line">    如果有需要，也可以在<span class="keyword">filter</span>(<span class="type">record</span>)方法内部改变该<span class="type">record</span>，比如添加、删除或修改一些属性。</span><br><span class="line">    我们还可以通过<span class="keyword">filter</span>做一些统计工作，比如可以计算下被一个特殊的logger或<span class="keyword">handler</span>所处理的<span class="type">record</span>数量等。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="实战演练"><a href="#实战演练" class="headerlink" title="实战演练"></a>实战演练</h2>
                  <p>上面文绉绉的说了(复制/粘贴)那么多，现在应该动手实践了。 <strong>现在我需要既将日志输出到控制台、又能将日志保存到文件，我应该怎么办？</strong> 利用刚才所学的知识，我们可以构思一下： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bcba03047ac6?w=806&amp;h=150&amp;f=png&amp;s=11198" alt=""> 看起来好像也不难，挺简单的样子，但是实际如此吗？ 在实际的工作或应用中，我们或许还需要指定文件存放路径、用随机数作为日志文件名、显示具体的信息输出代码行数、日志信息输出日期和日志写入方式等内容。再构思一下： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bd3489169e73?w=1079&amp;h=391&amp;f=png&amp;s=23173" alt=""> 具体代码如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import os</span><br><span class="line">import logging</span><br><span class="line">import uuid</span><br><span class="line"><span class="keyword">from</span><span class="built_in"> logging </span>import Handler, FileHandler, StreamHandler</span><br><span class="line"></span><br><span class="line">class PathFileHandler(FileHandler):</span><br><span class="line">    def __init__(self, path, filename, <span class="attribute">mode</span>=<span class="string">'a'</span>, <span class="attribute">encoding</span>=None, <span class="attribute">delay</span>=<span class="literal">False</span>):</span><br><span class="line"></span><br><span class="line">        filename = os.fspath(filename)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            os.mkdir(path)</span><br><span class="line">        self.baseFilename = os.path.join(path, filename)</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.encoding = encoding</span><br><span class="line">        self.delay = delay</span><br><span class="line">        <span class="keyword">if</span> delay:</span><br><span class="line">            Handler.__init__(self)</span><br><span class="line">            self.stream = None</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            StreamHandler.__init__(self, self._open())</span><br><span class="line"></span><br><span class="line">class Loggers(object):</span><br><span class="line">    # 日志级别关系映射</span><br><span class="line">    level_relations = &#123;</span><br><span class="line">        <span class="string">'debug'</span>: logging.DEBUG, <span class="string">'info'</span>: logging.INFO, <span class="string">'warning'</span>: logging.WARNING,</span><br><span class="line">        <span class="string">'error'</span>: logging.ERROR, <span class="string">'critical'</span>: logging.CRITICAL</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def __init__(self, <span class="attribute">filename</span>=<span class="string">'&#123;uid&#125;.log'</span>.format(uid=uuid.uuid4()), <span class="attribute">level</span>=<span class="string">'info'</span>, <span class="attribute">log_dir</span>=<span class="string">'log'</span>,</span><br><span class="line">                 <span class="attribute">fmt</span>=<span class="string">'%(asctime)s - %(filename)s[line:%(lineno)d] - %(levelname)s: %(message)s'</span>):</span><br><span class="line">        self.logger = logging.getLogger(filename)</span><br><span class="line">        abspath = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        self.directory = os.path.join(abspath, log_dir)</span><br><span class="line">        format_str = logging.Formatter(fmt)  # 设置日志格式</span><br><span class="line">        self.logger.setLevel(self.level_relations.<span class="builtin-name">get</span>(level))  # 设置日志级别</span><br><span class="line">        stream_handler = logging.StreamHandler()  # 往屏幕上输出</span><br><span class="line">        stream_handler.setFormatter(format_str)</span><br><span class="line">        file_handler = PathFileHandler(<span class="attribute">path</span>=self.directory, <span class="attribute">filename</span>=filename, <span class="attribute">mode</span>=<span class="string">'a'</span>)</span><br><span class="line">        file_handler.setFormatter(format_str)</span><br><span class="line">        self.logger.addHandler(stream_handler)</span><br><span class="line">        self.logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    txt = <span class="string">"关注公众号【进击的 Coder】，回复『日志代码』可以领取文章中完整的代码以及流程图"</span></span><br><span class="line">    log = Loggers(<span class="attribute">level</span>=<span class="string">'debug'</span>)</span><br><span class="line">    log.logger.<span class="builtin-name">info</span>(4)</span><br><span class="line">    log.logger.<span class="builtin-name">info</span>(5)</span><br><span class="line">    log.logger.<span class="builtin-name">info</span>(txt)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>文件保存后运行，运行结果如下图所示： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bc4eb81ba291?w=1437&amp;h=602&amp;f=png&amp;s=153201" alt=""> 日志确实在控制台输出了，再来看一下目录内是否生成有指定的文件和文件夹： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bc654930ee3f?w=1152&amp;h=161&amp;f=png&amp;s=35731" alt=""> 文件打开后可以看到里面输出的内容： <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bc6cd9fa316a" alt=""> <strong>正确的学习方式是什么</strong> 是一步步的看着文章介绍，等待博主结论？ 是拿着代码运行，跑一遍？ 都不是，应该是一边看着文章，一边拿着示例代码琢磨和研究，到底哪里可以改进、哪里可以设计得更好。如果你需要文章中所用到的示例代码和流程图，那么关注微信公众号【进击的 Coder】，回复『日志代码』就可以领取文章中完整的代码以及流程图。毕竟，学习是一件勤劳的事。 <img src="https://user-gold-cdn.xitu.io/2018/11/19/1672bd719ead7e24" alt=""> 参考资料： <a href="https://www.cnblogs.com/yyds/p/6901864.html" target="_blank" rel="noopener">云游道士博文</a> <a href="https://www.cnblogs.com/nancyzhu/p/8551506.html" target="_blank" rel="noopener">nancy05博文</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-25 14:53:35" itemprop="dateCreated datePublished" datetime="2019-07-25T14:53:35+08:00">2019-07-25</time>
                </span>
                <span id="/6921.html" class="post-meta-item leancloud_visitors" data-flag-title="一看就懂，Python 日志 logging 模块详解及应用" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6841.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/6841.html" class="post-title-link" itemprop="url">七分钟全面了解位运算</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>位运算是我们在编程中常会遇到的操作，但仍然有很多开发者并不了解位运算，这就导致在遇到位运算时会“打退堂鼓”。实际上，位运算并没有那么复杂，只要我们了解其运算基础和运算符的运算规则，就能够掌握位运算的知识。接下来，我们一起学习位运算的相关知识。 程序中的数在计算机内存中都是以二进制的形式存在的，位运算就是直接对整数在内存中对应的二进制位进行操作。</p>
                  <blockquote>
                    <p>注意：本文只讨论整数运算，小数运算不在本文研究之列</p>
                  </blockquote>
                  <h2 id="位运算的基础"><a href="#位运算的基础" class="headerlink" title="位运算的基础"></a>位运算的基础</h2>
                  <p>我们常用的 <code>3</code>， <code>5</code> 等数字是十进制表示，而位运算的基础是二进制。即人类采用十进制，机器采用的是二进制，要深入了解位运算，就需要了解十进制和二进制的转换方法和对应关系。</p>
                  <h3 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h3>
                  <p>十进制转二进制时，采用“除 2 取余，逆序排列”法：</p>
                  <ol>
                    <li>用 2 整除十进制数，得到商和余数;</li>
                    <li>再用 2 整除商，得到新的商和余数;</li>
                    <li>重复第 1 和第 2 步，直到商为 0;</li>
                    <li>将先得到的余数作为二进制数的高位，后得到的余数作为二进制数的低位，依次排序;</li>
                  </ol>
                  <p>排序结果就是该十进制数的二进制表示。例如十进制数 <code>101</code> 转换为二进制数的计算过程如下：</p>
                  <figure class="highlight basic">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">101 </span>% <span class="number">2</span> = <span class="number">50</span> 余 <span class="number">1</span></span><br><span class="line"><span class="symbol">50 </span>% <span class="number">2</span> = <span class="number">25</span> 余 <span class="number">0</span></span><br><span class="line"><span class="symbol">25 </span>% <span class="number">2</span> = <span class="number">12</span> 余 <span class="number">1</span></span><br><span class="line"><span class="symbol">12 </span>% <span class="number">2</span> = <span class="number">6</span> 余 <span class="number">0</span></span><br><span class="line"><span class="symbol">6 </span>% <span class="number">2</span> = <span class="number">3</span> 余 <span class="number">0</span></span><br><span class="line"><span class="symbol">3 </span>% <span class="number">2</span> = <span class="number">1</span> 余 <span class="number">1</span></span><br><span class="line"><span class="symbol">1 </span>% <span class="number">2</span> = <span class="number">0</span> 余 <span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>逆序排列即二进制中的从高位到低位排序，得到 <code>7</code> 位二进制数为 <code>1100101</code>，如果要转换为 <code>8</code> 位二进制数，就需要在最高位补 <code>0</code>。即十进制数的 <code>8</code> 位二进制数为 <code>01100101</code>。 其完整过程如下图所示： <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42ccba578426?w=448&amp;h=206&amp;f=png&amp;s=15358" alt=""> 有网友整理了常见的进制与 ASCII 码对照表，表内容如下： ASCII 控制字符 <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42d124cccad8?w=716&amp;h=858&amp;f=png&amp;s=110314" alt=""> ASCII 可显示字符 <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42d36b70664e?w=720&amp;h=836&amp;f=png&amp;s=106105" alt=""></p>
                  <h3 id="补码"><a href="#补码" class="headerlink" title="补码"></a>补码</h3>
                  <p>现在，我们已经了解到二进制与十进制的换算方法，并拥有了进制对照表。但在开始学习位运算符之前，我们还需要了解补码的知识。 数值有正负之分，那么仅有 <code>0</code> 和 <code>1</code> 的二进制如何表示正负呢？ 人们设定，二进制中最高位为 <code>0</code> 代表正，为 <code>1</code> 则代表负。例如 <code>0000 1100</code> 对应的十进制为 <code>12</code>，而 <code>1000 1100</code> 对应的十进制为 <code>\-12</code>。这种表示被称作原码。但新的问题出现了，原本二进制的最高位始终为 <code>0</code>，为了表示正负又多出了 <code>1</code>，在执行运算时就会出错。举个例子，<code>1 + (-2)</code> 的二进制运算如下：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">0000 0001 + 1000 0010 </span><br><span class="line"><span class="section">= 1000 0011</span></span><br><span class="line"><span class="section">= -3</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这显然是有问题的，问题就处在这个代表正负的最高位。接着，人们又弄出了反码（二进制各位置的 <code>0</code> 与 <code>1</code> 互换，例如 <code>0000 1100</code> 的反码为 <code>1111 0011</code>）。此时，运算就会变成这样：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">0000 0001 + 1111 1101</span><br><span class="line"><span class="section">= 1111 1110</span></span><br><span class="line"># 在转换成十进制前，需要再次反码</span><br><span class="line"><span class="section">= 1000 0001 </span></span><br><span class="line"><span class="section">= -1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这次好像正确了。但它仍然有例外，我们来看一下 <code>1 + (-1)</code>：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">0000 0001 <span class="code">+ 1111 +</span> 1110</span><br><span class="line"><span class="section">= 1111 1111</span></span><br><span class="line"><span class="section">= 1000 0000</span></span><br><span class="line"><span class="section">= -0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>零是没有正负之分的，为了解决这个问题，就搞出了补码的概念。补码是为了让负数变成能够加的正数，所以 <code>负数的补码= 负数的绝对值取反 + 1</code>，例如 <code>\-1</code> 的补码为：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">\-1 的绝对值 1</span><br><span class="line"><span class="section">= 0000 0001 # 1 的二进制原码</span></span><br><span class="line"><span class="section">= 1111 1110 # 原码取反</span></span><br><span class="line"><span class="section">= 1111 1111 # +1 后得到补码</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><code>\-1</code> 补码推导的完整过程如下图所示： <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42de18183539?w=480&amp;h=152&amp;f=png&amp;s=14842" alt=""> 反过来，由补码推导原码的过程为 <code>原码 = 补码 - 1，再求反</code>。要注意的是，反码过程中，最高位的值不变，这样才能够保证结果的正负不会出错。例如 <code>1 + (-6)</code> 和 <code>1 + (-9)</code> 的运算过程如下：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># 1 的补码 + -6 的补码</span><br><span class="line">0000 0001 + 1111 1010</span><br><span class="line"><span class="section">= 1111 1011 # 补码运算结果</span></span><br><span class="line"><span class="section">= 1111 1010 # 对补码减 1，得到反码</span></span><br><span class="line"><span class="section">= 1000 0101 # 反码取反，得到原码</span></span><br><span class="line"><span class="section">= -5 # 对应的十进制</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># 1 的补码 + -9 的补码</span><br><span class="line">0000 0001 + 1111 0111</span><br><span class="line"><span class="section">= 1111 1000 # 补码运算结果</span></span><br><span class="line"><span class="section">= 1111 0111 # 对补码减 1，得到反码</span></span><br><span class="line"><span class="section">= 1000 1000 # 反码取反，得到原码</span></span><br><span class="line"><span class="section">= -8 # 对应的十进制</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>要注意的是，正数的补码与原码相同，不需要额外运算。也可以说，补码的出现就是为了解决负数运算时的符号问题。</p>
                  <blockquote>
                    <p>人生苦短 我用 Python。 崔庆才|静觅 邀请你关注微信公众号：进击的Coder</p>
                  </blockquote>
                  <h2 id="运算符介绍"><a href="#运算符介绍" class="headerlink" title="运算符介绍"></a>运算符介绍</h2>
                  <p>位运算分为 6 种，它们是：</p>
                  <p>名称</p>
                  <p>符号</p>
                  <p>按位与</p>
                  <p>&amp;</p>
                  <p>按位或</p>
                  <p>|</p>
                  <p>按位异或</p>
                  <p>^</p>
                  <p>按位取反</p>
                  <p>~</p>
                  <p>左移运算</p>
                  <p>&lt;&lt;</p>
                  <p>右移运算</p>
                  <p>>&gt;</p>
                  <h3 id="按位与"><a href="#按位与" class="headerlink" title="按位与"></a>按位与</h3>
                  <p>按位与运算将参与运算的两数对应的二进制位相与，当对应的二进制位均为 <code>1</code> 时，结果位为 <code>1</code>，否则结果位为 <code>0</code>。按位与运算的运算符为 <code>&amp;</code>，参与运算的数以补码方式出现。举个例子，将数字 <code>5</code> 和数字 <code>8</code> 进行按位与运算，其实是将数字 <code>5</code> 对应的二进制 <code>0000 0101</code> 和数字 <code>8</code> 对应的二进制 <code>0000 1000</code> 进行按位与运算，即：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0000</span> <span class="number">0101</span></span><br><span class="line">&amp;</span><br><span class="line"><span class="number">0000</span> <span class="number">1000</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>根据按位与的规则，将各个位置的数进行比对。运算过程如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0000</span> <span class="number">0101</span></span><br><span class="line">&amp;</span><br><span class="line"><span class="number">0000</span> <span class="number">1000</span></span><br><span class="line">---- ----</span><br><span class="line"><span class="number">0000</span> <span class="number">0000</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>由于它们对应位置中没有“均为 <code>1</code> ”的情况，所以得到的结果是 <code>0000 0000</code>。数字 <code>5</code> 和 <code>8</code> 按位与运算的完整过程如下图： <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42e0ef065859?w=745&amp;h=290&amp;f=png&amp;s=27444" alt=""> 将结果换算成十进制，得到 <code>0</code>，即 <code>5&amp;8 = 0</code>。</p>
                  <h3 id="按位或"><a href="#按位或" class="headerlink" title="按位或"></a>按位或</h3>
                  <p>按位或运算将参与运算的两数对应的二进制位相或，只要对应的二进制位中有 <code>1</code>，结果位为 <code>1</code>，否则结果位为 <code>0</code>。按位或运算的运算符为 <code>|</code>，参与运算的数以补码方式出现。举个例子，将数字 <code>3</code> 和数字 <code>7</code> 进行按位或运算，其实是将数字 <code>3</code> 对应的二进制 <code>0000 0011</code>和数字 <code>7</code> 对应的二进制 <code>0000 0111</code> 进行按位或运算，即：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0000</span> <span class="number">0011</span></span><br><span class="line">|</span><br><span class="line"><span class="number">0000</span> <span class="number">0111</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>根据按位或的规则，将各个位置的数进行比对。运算过程如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0000</span> <span class="number">0011</span></span><br><span class="line">|</span><br><span class="line"><span class="number">0000</span> <span class="number">0111</span></span><br><span class="line">---- ----</span><br><span class="line"><span class="number">0000</span> <span class="number">0111</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最终得到的结果为 <code>0000 0111</code>。将结果换算成十进制，得到 <code>7</code>，即 <code>3|7 = 7</code>。</p>
                  <h3 id="按位异或"><a href="#按位异或" class="headerlink" title="按位异或"></a>按位异或</h3>
                  <p>按位异或运算将参与运算的两数对应的二进制位相异或，当对应的二进制位值不同时，结果位为 <code>1</code>，否则结果位为 <code>0</code>。按位异或的运算符为 <code>^</code>，参与运算的数以补码方式出现。举个例子，将数字 <code>12</code> 和数字 <code>7</code> 进行按位异或运算，其实是将数字 <code>12</code> 对应的二进制 <code>0000 1100</code> 和数字 <code>7</code> 对应的二进制 <code>0000 0111</code> 进行按位异或运算，即：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0000</span> <span class="number">1100</span></span><br><span class="line">^</span><br><span class="line"><span class="number">0000</span> <span class="number">0111</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>根据按位异或的规则，将各个位置的数进行比对。运算过程如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">0000</span> <span class="number">1100</span></span><br><span class="line">^</span><br><span class="line"><span class="number">0000</span> <span class="number">0111</span></span><br><span class="line">---- ----</span><br><span class="line"><span class="number">0000</span> <span class="number">1011</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最终得到的结果为 <code>0000 1011</code>。将结果换算成十进制，得到 <code>11</code>，即 <code>12^7 = 11</code>。</p>
                  <h3 id="按位取反"><a href="#按位取反" class="headerlink" title="按位取反"></a>按位取反</h3>
                  <p>按位取反运算将二进制数的每一个位上面的 <code>0</code> 换成 <code>1</code>，<code>1</code> 换成 <code>0</code>。按位取反的运算符为 <code>~</code>，参与运算的数以补码方式出现。举个例子，对数字 <code>9</code> 进行按位取反运算，其实是将数字 <code>9</code> 对应的二进制 <code>0000 1001</code> 进行按位取反运算，即：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">～0000 1001</span><br><span class="line"><span class="section">= 0000 1001 # 补码，正数补码即原码</span></span><br><span class="line"><span class="section">= 1111 1010 # 取反</span></span><br><span class="line"><span class="section">= -10</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最终得到的结果为 <code>\-10</code>。再来看一个例子，<code>\-20</code> 按位取反的过程如下：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">～0001 0100</span><br><span class="line"><span class="section">= 1110 1100 # 补码</span></span><br><span class="line"><span class="section">= 0001 0011 # 取反</span></span><br><span class="line"><span class="section">= 19</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最终得到的结果为 <code>19</code>。我们从示例中找到了规律，按位取反的结果用数学公式表示： <script type="math/tex">～x = -(x + 1)</script> 我们可以将其套用在 <code>9</code> 和 <code>\-20</code> 上：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">～<span class="number">9</span> = -(<span class="number">9</span> + <span class="number">1</span>) = <span class="number">-10</span></span><br><span class="line">~(<span class="number">-20</span>) = -((<span class="number">-20</span>) + <span class="number">1</span>) = <span class="number">19</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个规律也可以作用于数字 <code>0</code> 上，即 <code>~0 = -(0 + 1) = -1</code>。</p>
                  <h3 id="左移运算"><a href="#左移运算" class="headerlink" title="左移运算"></a>左移运算</h3>
                  <p>左移运算将数对应的二进位全部向左移动若干位，高位丢弃，低位补 <code>0</code>。左移运算的运算符为 <code>&lt;&lt;</code>。举个例子，将数字 <code>5</code> 左移 <code>4</code> 位，其实是将数字 <code>5</code> 对应的二进制 <code>0000 0101</code> 中的二进位向左移动 <code>4</code> 位，即：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">5 &lt;&lt; 4</span><br><span class="line"><span class="section">= 0000 0101 &lt;&lt; 4</span></span><br><span class="line"><span class="section">= 0101 0000 # 高位丢弃，低位补 0</span></span><br><span class="line"><span class="section">= 80</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>数字 <code>5</code> 左移 <code>4</code> 位的完整运算过程如下图： <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42e6eddfc892?w=530&amp;h=293&amp;f=png&amp;s=17694" alt=""> 最终结果为 <code>80</code>。这等效于: <script type="math/tex">5 _ (2) ^4</script> 也就是说，左移运算的规律为： <script type="math/tex">x << n = x _ (2) ^ n</script>
                  </p>
                  <h3 id="右移运算"><a href="#右移运算" class="headerlink" title="右移运算"></a>右移运算</h3>
                  <p>右移运算将数对应的二进位全部向右移动若干位。对于左边的空位，如果是正数则补 <code>0</code>，负数可能补 <code>0</code> 或 <code>1</code> （Turbo C 和很多编译器选择补 <code>1</code>）。右移运算的运算符为 <code>\&gt;&gt;</code>。举个例子，将数字 <code>80</code> 右移 <code>4</code> 位，其实是将数字 <code>80</code> 对应的二进制 <code>0101 0000</code> 中的二进位向右移动 <code>4</code> 位，即：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">80 &gt;&gt; 4</span><br><span class="line"><span class="section">= 0101 0000 &gt;&gt; 4</span></span><br><span class="line"><span class="section">= 0000 0101 # 正数补0，负数补1 </span></span><br><span class="line"><span class="section">= 5</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最终结果为 <code>5</code>。这等效于： <script type="math/tex">80 \\div (2)^4</script> 也就是说，右移运算的规律为： <script type="math/tex">x >> n = x \\div (2) ^ n</script> 要注意的是，不能整除时，取整数。这中除法取整的规则类似于 <code>PYTHON</code> 语言中的地板除。</p>
                  <blockquote>
                    <p>超酷人生 我用 Rust 韦世东|奎因 邀请你关注微信公众号：Rust之禅</p>
                  </blockquote>
                  <h2 id="位运算的应用"><a href="#位运算的应用" class="headerlink" title="位运算的应用"></a>位运算的应用</h2>
                  <p>在掌握了位运算的知识后，我们可以在开发中尝试使用它。坊间一直流传着位运算的效率高，速度快，但从未见过文献证明，所以本文不讨论效率和速度的问题。如果正在阅读文章的你有相关文献，请留言告知，谢谢。 <strong>判断数字奇偶</strong> 通常，我们会通过取余来判断数字是奇数还是偶数。例如判断 <code>101</code> 的奇偶用的方法是：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="keyword">if</span> 101 % 2:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'偶数'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'奇数'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们也可以通过位运算中的按位与来实现奇偶判断，例如：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="keyword">if</span> 101 &amp; 1:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'奇数'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'偶数'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这是因为奇数的二进制最低位始终为 <code>1</code>，而偶数的二进制最低为始终为 <code>0</code>。所以，无论任何奇数与 <code>1</code> 即 <code>0000 0001</code> 相与得到的都是 <code>1</code>，任何偶数与其相与得到的都是 <code>0</code>。 <strong>变量交换</strong> 在 C 语言中，两个变量的交换必须通过第三个变量来实现。伪代码如下：</p>
                  <figure class="highlight asciidoc">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># 伪代码</span><br><span class="line">a = 3, b = 5</span><br><span class="line">c = a</span><br><span class="line">a = b</span><br><span class="line">b = a</span><br><span class="line">--------</span><br><span class="line">a = 5, b = 3</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在 PYTHON 语言中并没有这么麻烦，可以直接交换。对应的 PYTHON 代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="keyword">a</span>, b = <span class="number">3</span>, <span class="number">5</span></span><br><span class="line"><span class="keyword">a</span>, b = b, <span class="keyword">a</span></span><br><span class="line">print(<span class="keyword">a</span>, b)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码运行结果为 <code>5 3</code>。但大部分编程语言都不支持 PYTHON 这种写法，在这种情况下我们可以通过位运算中的按位异或来实现变量的交换。对应的伪代码如下：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 伪代码</span></span><br><span class="line"><span class="attr">a</span> = <span class="number">3</span>, b = <span class="number">5</span></span><br><span class="line"><span class="attr">a</span> = a ^ b</span><br><span class="line"><span class="attr">b</span> = a ^ b</span><br><span class="line"><span class="attr">a</span> = a ^ b</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后，<code>a = 5, b = 3</code>。我们可以用 C 语言和 PYTHON 语言进行验证，对应的 PYTHON 代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="keyword">a</span>, b = <span class="number">3</span>, <span class="number">5</span></span><br><span class="line"><span class="keyword">a</span> = <span class="keyword">a</span> ^ b</span><br><span class="line">b = <span class="keyword">a</span> ^ b</span><br><span class="line"><span class="keyword">a</span> = <span class="keyword">a</span> ^ b</span><br><span class="line">print(<span class="keyword">a</span>, b)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码运行结果为 <code>5 3</code>，说明变量交换成功。对应的 C 代码如下：</p>
                  <figure class="highlight cpp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">3</span>, b = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"交换前：a=%d , b=%dn"</span>,a,b);</span><br><span class="line">    a = a^b;</span><br><span class="line">    b = a^b;</span><br><span class="line">    a = a^b;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"交换后：a=%d , b=%dn"</span>,a, b);           </span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码运行结果如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">交换前：<span class="attribute">a</span>=3 , <span class="attribute">b</span>=5</span><br><span class="line">交换后：<span class="attribute">a</span>=5 , <span class="attribute">b</span>=3</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这说明变量交换成功。 <strong>求 x 与 2 的 n 次方乘积</strong> 设一个数为 <code>x</code>，求 <code>x</code> 与 <code>2</code> 的 <code>n</code> 次方乘积。这用数学来计算都是非常简单的： <script type="math/tex">x * (2) ^ n</script> 在位运算中，要实现这个需求只需要用到左移运算，即 <code>x &lt;&lt; n</code>。 <strong>取 x 的第 k 位</strong> 即取数字 <code>x</code> 对应的二进制的第 <code>k</code> 位上的二进制值。假设数字为 <code>5</code>，其对应的二进制为 <code>0000 0101</code>，取第 <code>k</code> 位二进制值的位运算为 <code>x &gt;&gt; k &amp; 1</code>。我们可以用 PYTHON 代码进行验证：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># python</span><br><span class="line">x = <span class="number">5</span>  # <span class="number">0000</span> <span class="number">0101</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    print(x &gt;&gt; i &amp; <span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这说明位运算的算法是正确的，可以满足我们的需求。 <strong>判断赋值</strong></p>
                  <figure class="highlight gml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">if</span> a == <span class="symbol">x</span>:</span><br><span class="line">    <span class="symbol">x</span> = b</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="symbol">x</span> = a</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>等效于 <code>x = a ^ b ^ x</code>。我们可以通过 PYTHON 代码来验证：</p>
                  <figure class="highlight sas">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># python</span><br><span class="line">a, b, <span class="meta">x</span> = 6, 9, 6</span><br><span class="line"><span class="meta">if</span> a == <span class="meta">x</span>:</span><br><span class="line">    <span class="meta">x</span> = b</span><br><span class="line"><span class="meta">else</span>:</span><br><span class="line">    <span class="meta">x</span> = a</span><br><span class="line">p<span class="meta">rint(</span>a, b, <span class="meta">x</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码运行结果为 <code>699</code>，与之等效的代码如下：</p>
                  <figure class="highlight sas">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># python</span><br><span class="line">a, b, <span class="meta">x</span> = 6, 9, 6</span><br><span class="line"><span class="meta">x</span> = a ^ b ^ <span class="meta">x</span></span><br><span class="line">p<span class="meta">rint(</span>a, b, <span class="meta">x</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就省去了 <code>if else</code> 的判断语句。 <strong>代替地板除</strong> 二分查找是最常用的算法之一，但它有一定的前提条件：二分查找的目标必须采用顺序存储结构，且元素有序排列。例如 PYTHON 中的有序列表。二分查找的最优复杂度为 <code>O(1)</code>，最差时间复杂度为 <code>O(log n)</code>。举个例子，假设我们需要从列表 <code>[1, 3, 5, 6, 7, 8, 12, 22, 23, 43, 65, 76, 90, 543]</code> 中找到指定元素的下标，对应的 PYTHON 代码如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="string">def</span> <span class="string">search(lis:</span> <span class="string">list,</span> <span class="attr">x:</span> <span class="string">int)</span> <span class="string">-&gt;</span> <span class="attr">int:</span></span><br><span class="line">    <span class="string">""</span><span class="string">"非递归二分查找</span></span><br><span class="line"><span class="string">    返回指定元素在列表中的索引</span></span><br><span class="line"><span class="string">    -1 代表不存在"</span><span class="string">""</span></span><br><span class="line">    <span class="string">mix_index</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line">    <span class="string">max_index</span> <span class="string">=</span> <span class="string">len(lis)</span> <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="string">while</span> <span class="string">mix_index</span> <span class="string">&lt;=</span> <span class="attr">max_index:</span></span><br><span class="line">        <span class="string">midpoint</span> <span class="string">=</span> <span class="string">(mix_index</span> <span class="string">+</span> <span class="string">max_index)</span> <span class="string">//</span> <span class="number">2</span></span><br><span class="line">        <span class="string">if</span> <span class="string">lis[midpoint]</span> <span class="string">&lt;</span> <span class="attr">x:</span></span><br><span class="line">            <span class="string">mix_index</span> <span class="string">=</span> <span class="string">mix_index</span> <span class="string">+</span> <span class="number">1</span></span><br><span class="line">        <span class="string">elif</span> <span class="string">lis[midpoint]</span> <span class="string">&gt;</span> <span class="attr">x:</span></span><br><span class="line">            <span class="string">max_index</span> <span class="string">=</span> <span class="string">max_index</span> <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">else:</span></span><br><span class="line">            <span class="string">return</span> <span class="string">midpoint</span></span><br><span class="line">    <span class="string">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="string">lists</span> <span class="string">=</span> <span class="string">[1,</span> <span class="number">3</span><span class="string">,</span> <span class="number">5</span><span class="string">,</span> <span class="number">6</span><span class="string">,</span> <span class="number">7</span><span class="string">,</span> <span class="number">8</span><span class="string">,</span> <span class="number">12</span><span class="string">,</span> <span class="number">22</span><span class="string">,</span> <span class="number">23</span><span class="string">,</span> <span class="number">43</span><span class="string">,</span> <span class="number">65</span><span class="string">,</span> <span class="number">76</span><span class="string">,</span> <span class="number">90</span><span class="string">,</span> <span class="number">543</span><span class="string">]</span></span><br><span class="line"><span class="string">res</span> <span class="string">=</span> <span class="string">search(lists,</span> <span class="number">76</span><span class="string">)</span></span><br><span class="line"><span class="string">print(res)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在取列表中间值时使用的语句是 <code>midpoint = (mix_index + max_index) // 2</code>，即地板除，我们可以将其替换为 <code>midpoint = (mix_index + max_index) &gt;&gt; 1</code> 最终得到的结果是相同的。这是因为左移 <code>1</code>位 等效于乘以 <code>2</code>，而右移 <code>1</code> 位等效于除以 <code>2</code>。这样的案例还有很多，此处不再赘述。 至此，我们已经对位运算有了一定的了解，希望你在工作中使用位运算。更多 <code>Saoperation</code> 和知识请扫描下方二维码。 <img src="https://user-gold-cdn.xitu.io/2019/7/12/16be42f3a7eae3fa?w=608&amp;h=304&amp;f=jpeg&amp;s=73490" alt=""></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-12 12:15:17" itemprop="dateCreated datePublished" datetime="2019-07-12T12:15:17+08:00">2019-07-12</time>
                </span>
                <span id="/6841.html" class="post-meta-item leancloud_visitors" data-flag-title="七分钟全面了解位运算" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6829.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/6829.html" class="post-title-link" itemprop="url">Python3 模拟登录并爬取表格数据</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节主要内容有：</p>
                  <ul>
                    <li>通过requests库模拟表单提交</li>
                    <li>通过pandas库提取网页表格</li>
                  </ul>
                  <p>上周五，大师兄发给我一个网址，哭哭啼啼地求我：“去！把这个网页上所有年所有县所有作物的数据全爬下来，存到Access里！” 我看他可怜，勉为其难地挥挥手说：“好嘞，马上就开始！”</p>
                  <h2 id="目标分析"><a href="#目标分析" class="headerlink" title="目标分析"></a>目标分析</h2>
                  <p>大师兄给我的网址是这个：<a href="https://www.ctic.org/crm?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://www.ctic.org/crm?tdsourcetag=s_pctim_aiomsg</a> 打开长这样： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175155.png" alt=""> 根据我学爬虫并不久的经验，通常只要把年月日之类的参数附加到url里面去，然后用<code>requests.get</code>拿到<code>response</code>解析html就完了，所以这次应该也差不多——除了要先想办法获得具体有哪些年份、地名、作物名称，其他部分拿以前的代码稍微改改就能用了，毫无挑战性工作，生活真是太无聊了 点击 <code>View Summary</code> 后出现目标网页长这样 <img src="https://qiniu.cuiqingcai.com/2019-07-08-175159.png" alt=""> 那个大表格的数据就是目标数据了，好像没什么了不起的—— 有点不对劲 目标数据所在网页的网址是这样的：<a href="https://www.ctic.org/crm/?action=result" target="_blank" rel="noopener">https://www.ctic.org/crm/?action=result</a> ，刚刚选择的那些参数并没有作为url的参数啊！网址网页都变了，所以也不是ajax 这和我想象的情况有巨大差别啊</p>
                  <h2 id="尝试获取目标页面"><a href="#尝试获取目标页面" class="headerlink" title="尝试获取目标页面"></a>尝试获取目标页面</h2>
                  <p>让我来康康点击<code>View Summary</code>这个按钮时到底发生了啥：右键<code>View Summary</code>检查是这样： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175219.png" alt=""> 实话说，这是我第一次遇到要提交表单的活儿。以前可能是上天眷顾我，统统<code>get</code>就能搞定，今天终于让我碰上一个<code>post</code>了。 点击<code>View Summary</code>，到DevTools里找network第一条： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175223.png" alt=""> 不管三七二十一，<code>post</code>一下试试看</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://www.ctic.org/crm?tdsourcetag=s_pctim_aiomsg'</span></span><br><span class="line">headers = &#123;<span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) '</span></span><br><span class="line">           <span class="string">'AppleWebKit/537.36 (KHTML, like Gecko) '</span></span><br><span class="line">           <span class="string">'Chrome/74.0.3729.131 Safari/537.36'</span>,</span><br><span class="line">           <span class="string">'Host'</span>: <span class="string">'www.ctic.org'</span>&#125;</span><br><span class="line">data = &#123;<span class="string">'_csrf'</span>: <span class="string">'SjFKLWxVVkkaSRBYQWYYCA1TMG8iYR8ReUYcSj04Jh4EBzIdBGwmLw=='</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[year]'</span>: <span class="string">'2011'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[format]'</span>: <span class="string">'Acres'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[area]'</span>: <span class="string">'County'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[region]'</span>: <span class="string">'Midwest'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[state]'</span>: <span class="string">'IL'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[county]'</span>: <span class="string">'Adams'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[crop_type]'</span>: <span class="string">'All'</span>,</span><br><span class="line">        <span class="string">'summary'</span>: <span class="string">'county'</span>&#125;</span><br><span class="line">response = requests.post(url, <span class="attribute">data</span>=data, <span class="attribute">headers</span>=headers)</span><br><span class="line"><span class="builtin-name">print</span>(response.status_code)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>果不其然，输出<code>400</code>……我猜这就是传说中的<code>cookies</code>在搞鬼吗？《Python3网络爬虫实战》只看到第6章的我不禁有些心虚跃跃欲试呢！ 首先，我搞不清<code>cookies</code>具体是啥，只知道它是用来维持会话的，应该来自于第一次<code>get</code>，搞出来看看先：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">response1 = requests.<span class="builtin-name">get</span>(url, <span class="attribute">headers</span>=headers)</span><br><span class="line"><span class="keyword">if</span> response1.status_code == 200:</span><br><span class="line">    cookies = response1.cookies</span><br><span class="line">    <span class="builtin-name">print</span>(cookies)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出：</p>
                  <figure class="highlight fsharp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&lt;RequestsCookieJar<span class="meta">[&lt;Cookie PHPSESSID=52asgghnqsntitqd7c8dqesgh6 for www.ctic.org/&gt;, &lt;Cookie _csrf=2571c72a4ca9699915ea4037b967827150715252de98ea2173b162fa376bad33s%3A32%3A%22TAhjwgNo5ElZzV55k3DMeFoc5TWrEmXj%22%3B for www.ctic.org/&gt;]</span>&gt;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Nah，看不懂，不看不管，直接把它放到<code>post</code>里试试</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">response2 = requests.post(url, <span class="attribute">data</span>=data, <span class="attribute">headers</span>=headers, <span class="attribute">cookies</span>=cookies)</span><br><span class="line"><span class="builtin-name">print</span>(response2.status_code)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>还是<code>400</code>，气氛突然变得有些焦灼，我给你<code>cookies</code>了啊，你还想要啥？！ 突然，我发现一件事：<code>post</code>请求所带的<code>data</code>中那个一开始就显得很可疑的<code>_csrf</code>我仿佛在哪儿见过？ 那个我完全看不懂的<code>cookies</code>里好像就有一个<code>_csrf</code>啊！但是两个<code>_csrf</code>的值很明显结构不一样，试了一下把<code>data</code>里的<code>_csrf</code>换成<code>cookies</code>里的<code>_csrf</code>确实也不行。 但是我逐渐有了一个想法：这个两个<code>_csrf</code>虽然不相等，但是应该是匹配的，我刚刚的<code>data</code>来自浏览器，<code>cookies</code>来自python程序，所以不匹配！ 于是我又点开浏览器的DevTools，Ctrl+F搜索了一下，嘿嘿，发现了： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175237.png" alt=""> 和 <img src="https://qiniu.cuiqingcai.com/2019-07-08-175242.png" alt=""> 这三处。 第一处那里的下一行的<code>csrf_token</code>很明显就是<code>post</code>请求所带的<code>data</code>里的<code>_csrf</code>，另外两个是js里的函数，虽然js没好好学但也能看出来这俩是通过<code>post</code>请求获得州名和县名的，Binggo！一下子解决两个问题。 为了验证我的猜想，我打算先直接用requests获取点击<code>View Summary</code>前的页面的HTML和<code>cookies</code>，将从HTML中提取的<code>csrf_token</code>值作为点击<code>View Summary</code>时<code>post</code>请求的<code>data</code>里的<code>_csrf</code>值，同时附上<code>cookies</code>，这样两处<code>_csrf</code>就应该是匹配的了：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> lxml import etree</span><br><span class="line">response1 = requests.<span class="builtin-name">get</span>(url, <span class="attribute">headers</span>=headers)</span><br><span class="line">cookies = response1.cookies</span><br><span class="line">html = etree.HTML(response1.text)</span><br><span class="line">csrf_token = html.xpath(<span class="string">'/html/head/meta[3]/@content'</span>)[0]</span><br><span class="line">data.update(&#123;<span class="string">'_csrf'</span>: csrf_token&#125;)</span><br><span class="line">response2 = requests.post(url, <span class="attribute">data</span>=data, <span class="attribute">headers</span>=headers, <span class="attribute">cookies</span>=cookies)</span><br><span class="line"><span class="builtin-name">print</span>(response2.status_code)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出<code>200</code>，虽然和Chrome显示的<code>302</code>不一样，但是也表示成功，那就不管了。把<code>response2.text</code>写入html文件打开看是这样： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175252.png" alt=""> Yeah，数据都在！说明我的猜想是对的！那一会再试试我从没用过的<code>requests.Session()</code>维持会话，自动处理<code>cookies</code>。</p>
                  <h2 id="尝试pandas库提取网页表格"><a href="#尝试pandas库提取网页表格" class="headerlink" title="尝试pandas库提取网页表格"></a>尝试pandas库提取网页表格</h2>
                  <p>现在既然已经拿到了目标页面的HTML，那在获取所有年、地区、州名、县名之前，先测试一下<code>pandas.read_html</code>提取网页表格的功能。 <code>pandas.read_html</code>这个函数时在写代码时IDE自动补全下拉列表里瞄到的，一直想试试来着，今天乘机拉出来溜溜：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.read<span class="constructor">_html(<span class="params">response2</span>.<span class="params">text</span>)</span><span class="literal">[<span class="number">0</span>]</span></span><br><span class="line">print(df)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175300.png" alt=""> Yeah！拿到了，确实比自己手写提取方便，而且数值字符串自动转成数值，优秀！</p>
                  <h2 id="准备所有参数"><a href="#准备所有参数" class="headerlink" title="准备所有参数"></a>准备所有参数</h2>
                  <p>接下来要获取所有年、地区、州名、县名。年份和地区是写死在HTML里的，直接xpath获取： <img src="https://qiniu.cuiqingcai.com/2019-07-08-175307.png" alt=""> 州名、县名根据之前发现的两个js函数，要用<code>post</code>请求来获得，其中州名要根据地区名获取，县名要根据州名获取，套两层循环就行</p>
                  <figure class="highlight pf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def new():</span><br><span class="line">    session = requests.Session()</span><br><span class="line">    response = session.get(url=url, headers=headers)</span><br><span class="line">    html = etree.HTML(response.text)</span><br><span class="line">    return session, html</span><br><span class="line"></span><br><span class="line">session, html = new()</span><br><span class="line">years = html.xpath('//*[@id=<span class="string">"crmsearchform-year"</span>]/option/text()')</span><br><span class="line">regions = html.xpath('//*[@id=<span class="string">"crmsearchform-region"</span>]/option/text()')</span><br><span class="line">_csrf = html.xpath('/html/head/meta[<span class="number">3</span>]/@content')[<span class="number">0</span>]</span><br><span class="line">region_state = &#123;&#125;</span><br><span class="line">state_county = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">    data = &#123;'region': region, '_csrf': _csrf&#125;</span><br><span class="line">    response = session.post(url_state, data=data)</span><br><span class="line">    html = etree.HTML(response.json())</span><br><span class="line">    region_state[region] = &#123;x: y <span class="keyword">for</span> x, y <span class="keyword">in</span></span><br><span class="line">                            zip(html.xpath('//option/@value'),</span><br><span class="line">                                html.xpath('//option/text()'))&#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">state</span> <span class="keyword">in</span> region_state[region]:</span><br><span class="line">        data = &#123;'<span class="keyword">state</span>': <span class="keyword">state</span>, '_csrf': _csrf&#125;</span><br><span class="line">        response = session.post(url_county, data=data)</span><br><span class="line">        html = etree.HTML(response.json())</span><br><span class="line">        state_county[<span class="keyword">state</span>] = html.xpath('//option/@value')</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>啧啧，使用<code>requests.Session</code>就完全不需要自己管理<code>cookies</code>了，方便！具体获得的州名县名就不放出来了，实在太多了。然后把所有年、地区、州名、县名的可能组合先整理成csv文件，一会直接从csv里读取并构造<code>post</code>请求的<code>data</code>字典：</p>
                  <figure class="highlight pf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">remain = [[str(year), str(region), str(<span class="keyword">state</span>), str(county)] </span><br><span class="line">         <span class="keyword">for</span> year <span class="keyword">in</span> years <span class="keyword">for</span> region <span class="keyword">in</span> regions</span><br><span class="line">         <span class="keyword">for</span> <span class="keyword">state</span> <span class="keyword">in</span> region_state[region] <span class="keyword">for</span> county <span class="keyword">in</span> state_county[<span class="keyword">state</span>]]</span><br><span class="line">remain = pd.DataFrame(remain, columns=['CRMSearchForm[year]',</span><br><span class="line">                                       'CRMSearchForm[region]',</span><br><span class="line">                                       'CRMSearchForm[<span class="keyword">state</span>]',</span><br><span class="line">                                       'CRMSearchForm[county]'])</span><br><span class="line">remain.to_csv('remain.csv', index=False)</span><br><span class="line"><span class="comment"># 由于州名有缩写和全称，也本地保存一份</span></span><br><span class="line">import json</span><br><span class="line">with open('region_state.json', 'w') as json_file:</span><br><span class="line">        json.dump(region_state, json_file, indent=<span class="number">4</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我看了一下，一共49473行——也就是说至少要发送49473个<code>post</code>请求才能爬完全部数据，纯手工获取的话大概要点击十倍这个数字的次数……</p>
                  <h2 id="正式开始"><a href="#正式开始" class="headerlink" title="正式开始"></a>正式开始</h2>
                  <p>那么开始爬咯</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import pyodbc</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">open</span>(<span class="string">"region_state.json"</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">    region_state = json.load(json_file)</span><br><span class="line"><span class="keyword">data</span> = pd.read_csv(<span class="string">'remain.csv'</span>)</span><br><span class="line"><span class="comment"># 读取已经爬取的</span></span><br><span class="line">cnxn = pyodbc.connect(<span class="string">'DRIVER=&#123;Microsoft Access Driver (*.mdb, *.accdb)&#125;;'</span></span><br><span class="line">                      <span class="string">'DBQ=./ctic_crm.accdb'</span>)</span><br><span class="line">crsr = cnxn.cursor()</span><br><span class="line">crsr.execute(<span class="string">'select Year_, Region, State, County from ctic_crm'</span>)</span><br><span class="line">done = crsr.fetchall()</span><br><span class="line">done = [<span class="keyword">list</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> done]</span><br><span class="line">done = pd.DataFrame([<span class="keyword">list</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> done], <span class="keyword">columns</span>=[<span class="string">'CRMSearchForm[year]'</span>,</span><br><span class="line">                                                      <span class="string">'CRMSearchForm[region]'</span>,</span><br><span class="line">                                                      <span class="string">'CRMSearchForm[state]'</span>,</span><br><span class="line">                                                      <span class="string">'CRMSearchForm[county]'</span>])</span><br><span class="line">done[<span class="string">'CRMSearchForm[year]'</span>] = done[<span class="string">'CRMSearchForm[year]'</span>].astype(<span class="string">'int64'</span>)</span><br><span class="line">state2st = &#123;y: x <span class="keyword">for</span> z <span class="keyword">in</span> region_state.values() <span class="keyword">for</span> x, y <span class="keyword">in</span> z.items()&#125;</span><br><span class="line">done[<span class="string">'CRMSearchForm[state]'</span>] = [state2st[x]</span><br><span class="line">                                <span class="keyword">for</span> x <span class="keyword">in</span> done[<span class="string">'CRMSearchForm[state]'</span>]]</span><br><span class="line"><span class="comment"># 排除已经爬取的</span></span><br><span class="line">remain = data.append(done)</span><br><span class="line">remain = remain.drop_duplicates(<span class="keyword">keep</span>=<span class="literal">False</span>)</span><br><span class="line">total = <span class="keyword">len</span>(remain)</span><br><span class="line">print(f<span class="string">'&#123;total&#125; left.n'</span>)</span><br><span class="line">del <span class="keyword">data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line">remain[<span class="string">'CRMSearchForm[year]'</span>] = remain[<span class="string">'CRMSearchForm[year]'</span>].astype(<span class="string">'str'</span>)</span><br><span class="line"><span class="keyword">columns</span> = [<span class="string">'Crop'</span>,</span><br><span class="line">           <span class="string">'Total_Planted_Acres'</span>,</span><br><span class="line">           <span class="string">'Conservation_Tillage_No_Till'</span>,</span><br><span class="line">           <span class="string">'Conservation_Tillage_Ridge_Till'</span>,</span><br><span class="line">           <span class="string">'Conservation_Tillage_Mulch_Till'</span>,</span><br><span class="line">           <span class="string">'Conservation_Tillage_Total'</span>,</span><br><span class="line">           <span class="string">'Other_Tillage_Practices_Reduced_Till15_30_Residue'</span>,</span><br><span class="line">           <span class="string">'Other_Tillage_Practices_Conventional_Till0_15_Residue'</span>]</span><br><span class="line"><span class="keyword">fields</span> = [<span class="string">'Year_'</span>, <span class="string">'Units'</span>, <span class="string">'Area'</span>, <span class="string">'Region'</span>, <span class="string">'State'</span>, <span class="string">'County'</span>] + <span class="keyword">columns</span></span><br><span class="line"><span class="keyword">data</span> = &#123;<span class="string">'CRMSearchForm[format]'</span>: <span class="string">'Acres'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[area]'</span>: <span class="string">'County'</span>,</span><br><span class="line">        <span class="string">'CRMSearchForm[crop_type]'</span>: <span class="string">'All'</span>,</span><br><span class="line">        <span class="string">'summary'</span>: <span class="string">'county'</span>&#125;</span><br><span class="line">headers = &#123;<span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) '</span></span><br><span class="line">           <span class="string">'AppleWebKit/537.36 (KHTML, like Gecko) '</span></span><br><span class="line">           <span class="string">'Chrome/74.0.3729.131 Safari/537.36'</span>,</span><br><span class="line">           <span class="string">'Host'</span>: <span class="string">'www.ctic.org'</span>,</span><br><span class="line">           <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">           <span class="string">'DNT'</span>: <span class="string">'1'</span>,</span><br><span class="line">           <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>&#125;</span><br><span class="line"><span class="keyword">url</span> = <span class="string">'https://www.ctic.org/crm?tdsourcetag=s_pctim_aiomsg'</span></span><br><span class="line">headers2 = headers.copy()</span><br><span class="line">headers2 = headers2.update(&#123;<span class="string">'Referer'</span>: <span class="keyword">url</span>,</span><br><span class="line">                            <span class="string">'Origin'</span>: <span class="string">'https://www.ctic.org'</span>&#125;)</span><br><span class="line"><span class="keyword">def</span> <span class="keyword">new</span>():</span><br><span class="line">    <span class="keyword">session</span> = requests.Session()</span><br><span class="line">    response = session.get(<span class="keyword">url</span>=<span class="keyword">url</span>, headers=headers)</span><br><span class="line">    html = etree.HTML(response.text)</span><br><span class="line">    _csrf = html.xpath(<span class="string">'/html/head/meta[3]/@content'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">session</span>, _csrf</span><br><span class="line"><span class="keyword">session</span>, _csrf = <span class="keyword">new</span>()</span><br><span class="line"><span class="keyword">for</span> _, <span class="keyword">row</span> <span class="keyword">in</span> remain.iterrows():</span><br><span class="line">    temp = dict(<span class="keyword">row</span>)</span><br><span class="line">    data.update(temp)</span><br><span class="line">    data.update(&#123;<span class="string">'_csrf'</span>: _csrf&#125;)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        try:</span><br><span class="line">            response = session.post(<span class="keyword">url</span>, <span class="keyword">data</span>=<span class="keyword">data</span>, headers=headers2, <span class="keyword">timeout</span>=<span class="number">15</span>)</span><br><span class="line">            break</span><br><span class="line">        <span class="keyword">except</span> <span class="keyword">Exception</span> <span class="keyword">as</span> e:</span><br><span class="line">            session.close()</span><br><span class="line">            print(e)</span><br><span class="line">            print(<span class="string">'nSleep 30s.n'</span>)</span><br><span class="line">            time.sleep(<span class="number">30</span>)</span><br><span class="line">            <span class="keyword">session</span>, _csrf = <span class="keyword">new</span>()</span><br><span class="line">            data.update(&#123;<span class="string">'_csrf'</span>: _csrf&#125;)</span><br><span class="line"></span><br><span class="line">    df = pd.read_html(response.text)[<span class="number">0</span>].dropna(how=<span class="string">'all'</span>)</span><br><span class="line">    df.columns = <span class="keyword">columns</span></span><br><span class="line">    df[<span class="string">'Year_'</span>] = <span class="built_in">int</span>(temp[<span class="string">'CRMSearchForm[year]'</span>])</span><br><span class="line">    df[<span class="string">'Units'</span>] = <span class="string">'Acres'</span></span><br><span class="line">    df[<span class="string">'Area'</span>] = <span class="string">'County'</span></span><br><span class="line">    df[<span class="string">'Region'</span>] = temp[<span class="string">'CRMSearchForm[region]'</span>]</span><br><span class="line">    df[<span class="string">'State'</span>] = region_state[temp[<span class="string">'CRMSearchForm[region]'</span>]][temp[<span class="string">'CRMSearchForm[state]'</span>]]</span><br><span class="line">    df[<span class="string">'County'</span>] = temp[<span class="string">'CRMSearchForm[county]'</span>]</span><br><span class="line">    df = df.reindex(<span class="keyword">columns</span>=<span class="keyword">fields</span>)</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">record</span> <span class="keyword">in</span> df.itertuples(<span class="keyword">index</span>=<span class="literal">False</span>):</span><br><span class="line">        tuple_record = tuple(<span class="built_in">record</span>)</span><br><span class="line">        sql_insert = f<span class="string">'INSERT INTO ctic_crm VALUES &#123;tuple_record&#125;'</span></span><br><span class="line">        sql_insert = sql_insert.replace(<span class="string">', nan,'</span>, <span class="string">', null,'</span>)</span><br><span class="line">        crsr.execute(sql_insert)</span><br><span class="line">        crsr.commit()</span><br><span class="line">    print(total, row.to_list())</span><br><span class="line">    total -= <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Done!'</span>)</span><br><span class="line">    crsr.close()</span><br><span class="line">    cnxn.close()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>注意中间有个<code>try...except..</code>语句，是因为不定时会发生<code>Connection aborted</code>的错误，有时9000次才断一次，有时一次就断，这也是我加上了<code>读取已经爬取的</code>和<code>排除已经爬取的</code>原因，而且担心被识别出爬虫，把<code>headers</code>写的丰富了一些（好像并没有什么卵用），并且每次断开都暂停个30s并重新开一个会话 <img src="https://qiniu.cuiqingcai.com/2019-07-08-175315.png" alt=""> 然后把程序开着过了一个周末，命令行里终于打出了<code>Done!</code>，到Access里一看有816288条记录，心想：下次试试多线程（进程）和代理池。</p>
                  <hr>
                  <p>周一，我把跑出来的数据发给大师兄，大师兄回我：“好的”。 隔着屏幕我都能感受到滔滔不绝的敬仰和感激之情， 一直到现在，大师兄都感动地说不出话来。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/墨大宝" class="author" itemprop="url" rel="index">墨大宝</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-09 01:55:30" itemprop="dateCreated datePublished" datetime="2019-07-09T01:55:30+08:00">2019-07-09</time>
                </span>
                <span id="/6829.html" class="post-meta-item leancloud_visitors" data-flag-title="Python3 模拟登录并爬取表格数据" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>8.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6808.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> JavaScript <i class="label-arrow"></i>
                  </a>
                  <a href="/6808.html" class="post-title-link" itemprop="url">JavaScript API 设计原则详解</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
                  <p>本篇博文来自一次公司内部的前端分享，从多个方面讨论了在设计接口时遵循的原则，总共包含了七个大块。系卤煮自己总结的一些经验和教训。本篇博文同时也参考了其他一些文章，相关地址会在后面贴出来。很难做到详尽充实，如果有好的建议或者不对的地方，还望不吝赐教斧正。</p>
                  <h2 id="一、接口的流畅性"><a href="#一、接口的流畅性" class="headerlink" title="一、接口的流畅性"></a>一、接口的流畅性</h2>
                  <p>好的接口是流畅易懂的，他主要体现如下几个方面： 1.简单 操作某个元素的css属性，下面是原生的方法:</p>
                  <figure class="highlight dart">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">document</span>.<span class="built_in">querySelector</span>(<span class="string">'#id'</span>).style.color = <span class="string">'red'</span>;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>封装之后</p>
                  <figure class="highlight oxygene">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span><span class="params">(<span class="keyword">selector</span>, color)</span> <span class="comment">&#123;</span></span></span><br><span class="line"><span class="function"><span class="comment">  document.querySelector(selector).style.color = color</span></span></span><br><span class="line"><span class="function"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="function"><span class="title">a</span><span class="params">(<span class="string">'#a'</span>, <span class="string">'red'</span>)</span>;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>从几十个字母长长的一行到简简单单的一个函数调用，体现了api设计原则之一：简单易用。 2.可阅读性 a(‘#a’, ‘red’)是个好函数，帮助我们简单实用地改变某个元素，但问题来了，如果第一次使用该函数的人来说会比较困惑，a函数是啥函数，没有人告诉他。开发接口有必要知道一点，大多数人都是懒惰的（包括卤煮自己），从颜色赋值这个函数来说，虽然少写了代码，但是增加了单词字母的个数，使得它不再好记。每次做这件事情的时候都需要有映射关系： a—-&gt;color. 如果是简单的几个api倒是无所谓，但是通常一套框架都有几十甚至上百的api，映射成本增加会使得<a href="http://www.codeceo.com/" target="_blank" rel="noopener" title="程序员">程序员</a>哥哥崩溃。 我们需要的就是使得接口名称有意义，下面我们改写一下a函数：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">function</span> <span class="keyword">let</span><span class="constructor">SomeElementChangeColor(<span class="params">selector</span>, <span class="params">color</span>)</span> &#123;</span><br><span class="line">  document.query<span class="constructor">SelectorAll(<span class="params">selector</span>, <span class="params">color</span>)</span>.style.color = color; &#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>letSomeElementChangeColor相对于a来说被赋予了现实语言上的意义，任何人都不需要看说明也能知道它的功能。 3.减少记忆成本 我们刚刚的函数太长了，letSomeElementChangeColor虽然减少了映射成本，有了语言上的意义，但是毫无疑问增加了记忆成本。要知道，包括学霸在内，任何人都不喜欢背单词。不仅仅在此处，原生获取dom的api也同样有这个问题： document.getElementsByClassName； document.getElementsByName; document.querySelectorAll;这些api给人的感觉就是单词太长了，虽然他给出的意义是很清晰，然而这种做法是建立在牺牲简易性和简忆性的基础上进行的。于是我们又再次改写这个之前函数</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">function</span> set<span class="constructor">Color(<span class="params">selector</span>, <span class="params">color</span>)</span> &#123;</span><br><span class="line"> xxxxxxxxxxxx</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在语言意义不做大的变化前提下，缩减函数名称。使得它易读易记易用。 4.可延伸 所谓延伸就是指函数的使用像流水一样按照书写的顺序执行形成执行链条:</p>
                  <figure class="highlight coffeescript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'id'</span>).style.color = <span class="string">'red'</span>;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'id'</span>).style.fontSize = <span class="string">'12px'</span>;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'id'</span>).style.backgourdColor = <span class="string">'pink'</span>;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果我们需要实现像以上有强关联性的业务时，用我们之前的之前的方法是再次封装两个函数 setFontSize, setbackgroundColor; 然后执行它们 setColor(‘id’, ‘red’);setFontSiez(‘id’, ’12px’); setbackgroundColor(‘id’, ‘pink’); 显然，这样的做法没有懒出境界来；id元素每次都需要重新获取，影响性能，失败；每次都需要添加新的方法，失败； 每次还要调用这些方法，还是失败。下面我们将其改写为可以延伸的函数 首先将获取id方法封装成对象,然后再对象的每个方法中返回这个对象：</p>
                  <figure class="highlight qml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getElement</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.style = <span class="built_in">document</span>.querySelecotrAll(selector).style;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getElement.prototype.color = <span class="function"><span class="keyword">function</span>(<span class="params">color</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.style.color = <span class="built_in">color</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">getElement.prototype.background = <span class="function"><span class="keyword">function</span>(<span class="params">bg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.style.backgroundColor = bg;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">getElement.prototype.fontSize = <span class="function"><span class="keyword">function</span>(<span class="params">size</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.style.fontSize = <span class="built_in">size</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="keyword">var</span> el = <span class="keyword">new</span> getElement(<span class="string">'#id'</span>)</span><br><span class="line">el.color(<span class="string">'red'</span>).background(<span class="string">'pink'</span>).fontSize(<span class="string">'12px'</span>);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>简单、流畅、易读，它们看起来就像行云流水一样，即在代码性能上得到了提升优化，又在视觉上悦目。后面我们会在参数里面讲到如何继续优化。 所以，大家都比较喜欢用jquery的api，虽然一个$符号并不代表任何现实意义，但简单的符号有利于我们的使用。它体现了以上的多种原则，简单，易读，易记，链式写法，多参处理。 nightmare:</p>
                  <figure class="highlight coffeescript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'id'</span>).style.color = <span class="string">'red'</span>;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'id'</span>).style.fontSize = <span class="string">'12px'</span>;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'id'</span>).style.backgourdColor = <span class="string">'pink'</span>;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>dream:</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">$(<span class="string">'id'</span>).css(&#123;<span class="string">color:</span><span class="string">'red'</span>, <span class="string">fontSize:</span><span class="string">'12px'</span>, <span class="string">backgroundColor:</span><span class="string">'pink'</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="二、一致性"><a href="#二、一致性" class="headerlink" title="二、一致性"></a>二、一致性</h2>
                  <p>1.接口的一致性 相关的接口保持一致的风格，一整套 API 如果传递一种熟悉和舒适的感觉，会大大减轻开发者对新工具的适应性。 命名这点事：既要短，又要自描述，最重要的是保持一致性 “在计算机科学界只有两件头疼的事：缓存失效和命名问题” — Phil Karlton 选择一个你喜欢的措辞，然后持续使用。选择一种风格，然后保持这种风格。 Nightmare:</p>
                  <figure class="highlight autohotkey">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">setColor,</span></span><br><span class="line">letBackGround</span><br><span class="line">changefontSize</span><br><span class="line">makedisplay</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>dream:</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">set</span>Color;</span><br><span class="line"><span class="keyword">set</span>Background;</span><br><span class="line"><span class="keyword">set</span>FontSize</span><br><span class="line"><span class="keyword">set</span>.<span class="string">........</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>尽量地保持代码风格和命名风格，使别人读你的代码像是阅读同一个人写的文章一样。</p>
                  <h2 id="三、参数的处理"><a href="#三、参数的处理" class="headerlink" title="三、参数的处理"></a>三、参数的处理</h2>
                  <p>1.参数的类型 判断参数的类型为你的程序提供稳定的保障</p>
                  <figure class="highlight qml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//我们规定，color接受字符串类型</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setColor</span>(<span class="params">color</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">color</span> !== <span class="string">'string'</span>) <span class="keyword">return</span>;</span><br><span class="line">dosomething</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>2.使用json方式传参 使用json的方式传值很多好处，它可以给参数命名，可以忽略参数的具体位置，可以给参数默认值等等 比如下面这种糟糕的情况:</p>
                  <figure class="highlight actionscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span><span class="params">(param1, param2<span class="rest_arg">...............paramN</span>)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>你必须对应地把每一个参数按照顺序传入，否则你的方法就会偏离你预期去执行，正确的方法是下面的做法。</p>
                  <figure class="highlight actionscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span><span class="params">(json)</span> </span>&#123;</span><br><span class="line"><span class="comment">//为必须的参数设置默认值</span></span><br><span class="line">   <span class="keyword">var</span> <span class="keyword">default</span> = extend(&#123;</span><br><span class="line">    param: <span class="string">'default'</span>,</span><br><span class="line">    param1: <span class="string">'default'</span></span><br><span class="line">    ......</span><br><span class="line">   &#125;,json)</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这段函数代码，即便你不传任何参数进来，他也会预期运行。因为在声明的时候，你会根据具体的业务预先决定参数的缺省值。</p>
                  <h2 id="四、可扩展性"><a href="#四、可扩展性" class="headerlink" title="四、可扩展性"></a>四、可扩展性</h2>
                  <p>软件设计最重要的原则之一：永远不修改接口，而是去扩展它！可扩展性同时会要求接口的职责单一，多职责的接口很难扩展。 举个栗子：</p>
                  <figure class="highlight qml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//需要同时改变某个元素的字体和背景</span></span><br><span class="line"><span class="comment">// Nightmare:</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">selector, color</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">document</span>.querySelectroAll(selector).style.color = <span class="built_in">color</span>;</span><br><span class="line">  <span class="built_in">document</span>.querySelectroAll(selector).style.backgroundColor = <span class="built_in">color</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//无法扩展改函数，如果需要再次改变字体的大小的话，只能修改此函数，在函数后面填加改变字体大小的代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Dream</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">selector, color</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> el = <span class="built_in">document</span>.querySelectroAll(selector);</span><br><span class="line">  el.style.color = <span class="built_in">color</span>;</span><br><span class="line">  el.style.backgroundColor = <span class="built_in">color</span>;</span><br><span class="line">  <span class="keyword">return</span> el;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//需要设置字体、背景颜色和大小</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setAgain</span> (<span class="params">selector, color, px</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> el = set(selector, <span class="built_in">color</span>)</span><br><span class="line">  el.style.fontSize = px;</span><br><span class="line">  <span class="keyword">return</span> el;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上只是简单的添加颜色，业务复杂而代码又不是你写的时候，你就必须去阅读之前的代码再修改它，显然是不符合开放-封闭原则的。修改后的function是返回了元素对象，使得下次需要改变时再次得到返回值做处理。 2.this的运用 可扩展性还包括对this的以及call和apply方法的灵活运用：</p>
                  <figure class="highlight actionscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayBonjour</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  alert(<span class="keyword">this</span>.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br><span class="line">obj.say = sayBonjour;</span><br><span class="line">obj.say();<span class="comment">//1</span></span><br><span class="line"><span class="comment">//or</span></span><br><span class="line">sayBonjour.call||apply(obj);<span class="comment">//1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="五、对错误的处理"><a href="#五、对错误的处理" class="headerlink" title="五、对错误的处理"></a>五、对错误的处理</h2>
                  <p>1.预见错误 可以用 类型检测 typeof 或者try…catch。 typeof 会强制检测对象不抛出错误，对于未定义的变量尤其有用。 2.抛出错误 大多数开发者不希望出错了还需要自己去找带对应得代码，最好方式是直接在console中输出，告诉用户发生了什么事情。我们可以用到浏览器为我们提供的api输出这些信息:console.log/warn/error。你还可以为自己的程序留些后路: try…catch。</p>
                  <figure class="highlight javascript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span> (<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> a !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'param a must be type of string'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// some code excucete here maybe throw wrong</span></span><br><span class="line">  &#125;<span class="keyword">catch</span>(ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.wran(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="六、可预见性"><a href="#六、可预见性" class="headerlink" title="六、可预见性"></a>六、可预见性</h2>
                  <p>可预见性味程序接口提供健壮性，为保证你的代码顺利执行，必须为它考虑到非正常预期的情况。我们看下不可以预见的代码和可预见的代码的区别用之前的setColor</p>
                  <figure class="highlight javascript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//nighware</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">selector, color</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">document</span>.getElementById(selector).style.color = color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//dream</span></span><br><span class="line">zepto.init = <span class="function"><span class="keyword">function</span>(<span class="params">selector, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dom</span><br><span class="line">  <span class="comment">// If nothing given, return an empty Zepto collection</span></span><br><span class="line">  <span class="keyword">if</span> (!selector) <span class="keyword">return</span> zepto.Z()</span><br><span class="line">  <span class="comment">// Optimize for string selectors</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> selector == <span class="string">'string'</span>) &#123;</span><br><span class="line">    selector = selector.trim()</span><br><span class="line">    <span class="comment">// If it's a html fragment, create nodes from it</span></span><br><span class="line">    <span class="comment">// Note: In both Chrome 21 and Firefox 15, DOM error 12</span></span><br><span class="line">    <span class="comment">// is thrown if the fragment doesn't begin with &lt;</span></span><br><span class="line">    <span class="keyword">if</span> (selector[<span class="number">0</span>] == <span class="string">'&lt;'</span> &amp;&amp; fragmentRE.test(selector))</span><br><span class="line">      dom = zepto.fragment(selector, <span class="built_in">RegExp</span>.$<span class="number">1</span>, context), selector = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// If there's a context, create a collection on that context first, and select</span></span><br><span class="line">    <span class="comment">// nodes from there</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (context !== <span class="literal">undefined</span>) <span class="keyword">return</span> $(context).find(selector)</span><br><span class="line">    <span class="comment">// If it's a CSS selector, use it to select nodes.</span></span><br><span class="line">    <span class="keyword">else</span> dom = zepto.qsa(<span class="built_in">document</span>, selector)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If a function is given, call it when the DOM is ready</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (isFunction(selector)) <span class="keyword">return</span> $(<span class="built_in">document</span>).ready(selector)</span><br><span class="line">  <span class="comment">// If a Zepto collection is given, just return it</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (zepto.isZ(selector)) <span class="keyword">return</span> selector</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// normalize array if an array of nodes is given</span></span><br><span class="line">    <span class="keyword">if</span> (isArray(selector)) dom = compact(selector)</span><br><span class="line">    <span class="comment">// Wrap DOM nodes.</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isObject(selector))</span><br><span class="line">      dom = [selector], selector = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// If it's a html fragment, create nodes from it</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fragmentRE.test(selector))</span><br><span class="line">      dom = zepto.fragment(selector.trim(), <span class="built_in">RegExp</span>.$<span class="number">1</span>, context), selector = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// If there's a context, create a collection on that context first, and select</span></span><br><span class="line">    <span class="comment">// nodes from there</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (context !== <span class="literal">undefined</span>) <span class="keyword">return</span> $(context).find(selector)</span><br><span class="line">    <span class="comment">// And last but no least, if it's a CSS selector, use it to select nodes.</span></span><br><span class="line">    <span class="keyword">else</span> dom = zepto.qsa(<span class="built_in">document</span>, selector)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// create a new Zepto collection from the nodes found</span></span><br><span class="line">  <span class="keyword">return</span> zepto.Z(dom, selector)</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上是zepto的源码，可以看见，作者在预见传入的参数时做了很多的处理。其实可预见性是为程序提供了若干的入口，无非是一些逻辑判断而已。zepto在这里使用了很多的是非判断，这样做的好处当然是代码比之前更健壮，但同时导致了代码的冗长，不适合阅读。总之，可预见性真正需要你做的事多写一些对位置实物的参数。把外部的检测改为内部检测。是的使用的人用起来舒心放心开心。呐！做人嘛最重要的就是海森啦。</p>
                  <h2 id="七、注释和文档的可读性"><a href="#七、注释和文档的可读性" class="headerlink" title="七、注释和文档的可读性"></a>七、注释和文档的可读性</h2>
                  <p>一个最好的接口是不需要文档我们也会使用它，但是往往接口量一多和业务增加，接口使用起来也会有些费劲。所以接口文档和注释是需要认真书写的。注释遵循简单扼要地原则，给多年后的自己也给后来者看：</p>
                  <figure class="highlight actionscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">//注释接口，为了演示PPT用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commentary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//如果你定义一个没有字面意义的变量时，最好为它写上注释：a：没用的变量，可以删除</span></span><br><span class="line">  <span class="keyword">var</span> a;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//在关键和有歧义的地方写上注释，犹如画龙点睛：路由到hash界面后将所有的数据清空结束函数</span></span><br><span class="line">  <span class="keyword">return</span> go.Navigate(<span class="string">'hash'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    data.clear();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2>
                  <p>推荐markdown语法书写API文档，github御用文档编写语法。简单、快速，代码高亮、话不多说上图 <img src="http://static.codeceo.com/images/2017/06/f0839dcb3fe291d221540d9aef8c89d1.png" alt=""> 卤煮在此也推荐几个在线编辑的网站。诸君可自行前往练习使用。 <a href="https://www.zybuluo.com/mdeditor" target="_blank" rel="noopener">https://www.zybuluo.com/mdeditor</a> <a href="http://mahua.jser.me/" target="_blank" rel="noopener">http://mahua.jser.me/</a></p>
                  <h2 id="参考博文"><a href="#参考博文" class="headerlink" title="参考博文"></a>参考博文</h2>
                  <p><a href="http://top.css88.com/archives/814" target="_blank" rel="noopener">前端头条-javascript的api设计原则</a> 原文：<a href="http://www.cnblogs.com/constantince/p/5580003.html" target="_blank" rel="noopener">http://www.cnblogs.com/constantince/p/5580003.html</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-08 03:25:55" itemprop="dateCreated datePublished" datetime="2019-07-08T03:25:55+08:00">2019-07-08</time>
                </span>
                <span id="/6808.html" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript API 设计原则详解" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/6806.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> JavaScript <i class="label-arrow"></i>
                  </a>
                  <a href="/6806.html" class="post-title-link" itemprop="url">介绍 5 个实用的 Ajax 库</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在这篇文章中，我们将介绍一些用于AJAX调用的最好的JS库，包括jQuery，Axios和Fetch。欢迎查看代码示例！ AJAX是用来对服务器进行异步HTTP调用的一系列web开发技术客户端框架。 AJAX即Asynchronous JavaScript and XML（异步JavaScript和XML）。AJAX曾是web开发界的一个常见名称，许多流行的JavaScript小部件都是使用AJAX构建的。例如，有些特定的用户交互（如按下按钮）会异步调用到服务器，服务器会检索数据并将其返回给客户端——所有这些都不需要重新加载网页。 <img src="http://static.codeceo.com/images/2018/03/ajax-logo.jpg" alt="" title="ajax-logo"></p>
                  <h2 id="AJAX的现代化重新引入"><a href="#AJAX的现代化重新引入" class="headerlink" title="AJAX的现代化重新引入"></a>AJAX的现代化重新引入</h2>
                  <p>JavaScript已经进化了，现在我们使用前端库和/或如React、Angular、Vue等框架构建了动态的网站。AJAX的概念也经历了重大变化，因为现代异步JavaScript调用涉及检索JSON而不是XML。有很多库允许你从客户端应用程序对服务器进行异步调用。有些进入到浏览器标准，有些则有很大的用户基础，因为它们不但灵活而且易于使用。有些支持promises，有些则使用回调。在本文中，我将介绍用于从服务器获取数据的前5个AJAX库。</p>
                  <h2 id="Fetch-API"><a href="#Fetch-API" class="headerlink" title="Fetch API"></a>Fetch API</h2>
                  <p>Fetch API是XMLHttpRequest的现代替代品，用于从服务器检索资源。与XMLHttpRequest不同的是，它具有更强大的功能集和更有意义的命名。基于其语法和结构，Fetch不但灵活而且易于使用。但是，与其他AJAX HTTP库区别开来的是，它具有所有现代Web浏览器的支持。Fetch遵循请求-响应的方法，也就是说，Fetch提出请求并返回解析到Response对象的promise。 你可以传递Request对象来获取，或者，也可以仅传递要获取的资源的URL。下面的示例演示了使用Fetch创建简单的GET请求。</p>
                  <figure class="highlight javascript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">fetch(<span class="string">'https://www.example.com'</span>, &#123;</span><br><span class="line">        method: <span class="string">'get'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">    .then(<span class="function"><span class="params">jsonData</span> =&gt;</span> <span class="built_in">console</span>.log(jsonData))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//error block</span></span><br><span class="line">     &#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>正如你所看到的，Fetch的then方法返回了一个响应对象，你可以使用一系列的then 进行进一步的操作。我使用.json() 方法将响应转换为JSON并将其输出到控制台。 假如你需要POST表单数据或<a href="https://cloudinary.com/blog/file_upload_with_ajax" target="_blank" rel="noopener">使用Fetch创建AJAX文件上传</a>，将会怎么样？此时，除了Fetch之外，你还需要一个输入表单，并使用FormData库来存储表单对象。</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">var</span> input = document.querySelector('input[<span class="class"><span class="keyword">type</span>="file"]')</span></span><br><span class="line"><span class="title">var</span> <span class="class"><span class="keyword">data</span> = new <span class="type">FormData</span>()</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>.append('<span class="title">file'</span>, <span class="title">input</span>.<span class="title">files</span>[0])</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>.append('<span class="title">user'</span>, '<span class="title">blizzerand'</span>)</span></span><br><span class="line"><span class="title">fetch</span>('/avatars', &#123;</span><br><span class="line">    method: '<span class="type">POST'</span>,</span><br><span class="line">    body: <span class="class"><span class="keyword">data</span></span></span><br><span class="line">&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>你可以在官方的<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank" rel="noopener">Mozilla web文档</a>中阅读更多关于Fetch API的信息。</p>
                  <h2 id="Axios"><a href="#Axios" class="headerlink" title="Axios"></a>Axios</h2>
                  <p><a href="https://github.com/axios/axios" target="_blank" rel="noopener">Axios</a>是一个基于XMLHttpRequest而构建的现代JavaScript库，用于进行AJAX调用。它允许你从浏览器和服务器发出HTTP请求。此外，它还支持ES6原生的Promise API。Axios的其他突出特点包括：</p>
                  <ul>
                    <li>拦截请求和响应。</li>
                    <li>使用promise转换请求和响应数据。</li>
                    <li>自动转换JSON数据。</li>
                    <li>取消实时请求。</li>
                  </ul>
                  <p>要使用Axios，你需要先安装它。</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">npm <span class="keyword">install</span> axios</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下面是一个演示Axios行动的基本例子。</p>
                  <figure class="highlight scilab">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">// Make a request for a user with a given ID</span></span><br><span class="line">axios.get(<span class="string">'/user?ID=12345'</span>)</span><br><span class="line">  .<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span> <span class="params">(response)</span> &#123;</span></span><br><span class="line">    console.<span class="built_in">log</span>(response);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span> <span class="params">(error)</span> &#123;</span></span><br><span class="line">    console.<span class="built_in">log</span>(<span class="built_in">error</span>);</span><br><span class="line">  &#125;);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>与Fetch相比，Axios的语法更简单。让我们做一些更复杂的事情，比如我们之前使用Fetch创建的AJAX文件上传器。</p>
                  <figure class="highlight lua">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">var data = new FormData();</span><br><span class="line">   data.append(<span class="string">'foo'</span>, <span class="string">'bar'</span>);</span><br><span class="line">   data.append(<span class="string">'file'</span>, document.getElementById(<span class="string">'file'</span>).files[<span class="number">0</span>]);</span><br><span class="line">   var <span class="built_in">config</span> = &#123;</span><br><span class="line">        onUploadProgress: <span class="function"><span class="keyword">function</span><span class="params">(progressEvent)</span></span> &#123;</span><br><span class="line">          var percentCompleted = Math.round( (progressEvent.<span class="built_in">loaded</span> * <span class="number">100</span>) / progressEvent.total );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    axios.put(<span class="string">'/upload/server'</span>, data, <span class="built_in">config</span>)</span><br><span class="line">      .<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span> <span class="params">(res)</span></span> &#123;</span><br><span class="line">        <span class="built_in">output</span>.className = <span class="string">'container'</span>;</span><br><span class="line">        <span class="built_in">output</span>.innerHTML = res.data;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span></span> &#123;</span><br><span class="line">        <span class="built_in">output</span>.className = <span class="string">'container text-danger'</span>;</span><br><span class="line">        <span class="built_in">output</span>.innerHTML = err.message;</span><br><span class="line">      &#125;);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Axios更具可读性。Axios也非常受React和Vue等现代库的欢迎。</p>
                  <h2 id="jQuery"><a href="#jQuery" class="headerlink" title="jQuery"></a>jQuery</h2>
                  <p>jQuery曾经是JavaScript中的一个前线库，用于处理从AJAX调用到操纵DOM内容的所有事情。虽然随着其他前端库的“冲击”，其相关性有所降低，但你仍然可以使用jQuery来进行异步调用。 如果你之前使用过jQuery，那么这可能是最简单的解决方案。但是，你将不得不导入整个jQuery库以使用$.ajax方法。虽然这个库有特定于域的方法，例如$.getJSON，$.get和$.post，但是其语法并不像其他的AJAX库那么简单。以下代码用于编写基本的GET请求。</p>
                  <figure class="highlight javascript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">$.ajax(&#123;</span><br><span class="line">  url: <span class="string">'/users'</span>,</span><br><span class="line">  type: <span class="string">"GET"</span>,</span><br><span class="line">  dataType: <span class="string">"json"</span>,</span><br><span class="line">  success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;</span><br><span class="line">  fail: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Encountered an error"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>jQuery好的地方在于，如果你有疑问，那么你可以找到大量的支持和文档。我发现了很多使用FormData()和jQuery进行AJAX文件上传的例子。下面是最简单的方法：</p>
                  <figure class="highlight javascript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">formData.append(<span class="string">'file'</span>, $(<span class="string">'#file'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">       url : <span class="string">'upload.php'</span>,</span><br><span class="line">       type : <span class="string">'POST'</span>,</span><br><span class="line">       data : formData,</span><br><span class="line">       processData: <span class="literal">false</span>,  <span class="comment">// tell jQuery not to process the data</span></span><br><span class="line">       contentType: <span class="literal">false</span>,  <span class="comment">// tell jQuery not to set contentType</span></span><br><span class="line">       success : <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(data);</span><br><span class="line">           alert(data);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="SuperAgent"><a href="#SuperAgent" class="headerlink" title="SuperAgent"></a>SuperAgent</h2>
                  <p>SuperAgent是一个轻量级和渐进式的AJAX库，更侧重于可读性和灵活性。SuperAgent还拥有一个温和的学习曲线，不像其他库。它有一个针对Node.js API相同的模块。SuperAgent有一个接受GET、POST、PUT、DELETE和HEAD等方法的请求对象。然后你可以调用.then()，.end()或新的.await()方法来处理响应。例如，以下代码为使用SuperAgent的简单GET请求。</p>
                  <figure class="highlight less">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">request</span></span><br><span class="line">   <span class="selector-class">.post</span>(<span class="string">'/api/pet'</span>)</span><br><span class="line">   <span class="selector-class">.send</span>(&#123; <span class="attribute">name</span>: <span class="string">'Manny'</span>, <span class="attribute">species</span>: <span class="string">'cat'</span> &#125;)</span><br><span class="line">   <span class="selector-class">.set</span>(<span class="string">'X-API-Key'</span>, <span class="string">'foobar'</span>)</span><br><span class="line">   <span class="selector-class">.set</span>(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">   <span class="selector-class">.then</span>(function(res) &#123;</span><br><span class="line">      <span class="selector-tag">alert</span>(<span class="string">'yay got '</span> + JSON.stringify(res.body));</span><br><span class="line">   &#125;);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果你想要做更多的事情，比如使用此AJAX库上传文件，那该怎么做呢？ 同样超级easy。</p>
                  <figure class="highlight less">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">request</span></span><br><span class="line">   <span class="selector-class">.post</span>(<span class="string">'/upload'</span>)</span><br><span class="line">   <span class="selector-class">.field</span>(<span class="string">'user[name]'</span>, <span class="string">'Tobi'</span>)</span><br><span class="line">   <span class="selector-class">.field</span>(<span class="string">'user[email]'</span>, <span class="string">'tobi@learnboost.com'</span>)</span><br><span class="line">   <span class="selector-class">.field</span>(<span class="string">'friends[]'</span>, [<span class="string">'loki'</span>, <span class="string">'jane'</span>])</span><br><span class="line">   <span class="selector-class">.attach</span>(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line">   <span class="selector-class">.then</span>(callback);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果你有兴趣了解更多<a href="https://visionmedia.github.io/superagent/" target="_blank" rel="noopener">关于SuperAgent的信息</a>，那么它们有一系列很不错的文档来帮助你开始这个旅程。</p>
                  <h2 id="Request——简化的HTTP客户端"><a href="#Request——简化的HTTP客户端" class="headerlink" title="Request——简化的HTTP客户端"></a>Request——简化的HTTP客户端</h2>
                  <p><a href="https://github.com/request/request" target="_blank" rel="noopener">Request库</a>是进行HTTP调用最简单的方法之一。结构和语法与在Node.js中处理请求的方式非常相似。目前，该项目在GitHub上有18K个星，值得一提的是，它是可用的最流行的HTTP库之一。 下面是一个例子：</p>
                  <figure class="highlight javascript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</span><br><span class="line">request(<span class="string">'http://www.google.com'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, response, body</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'error:'</span>, error); <span class="comment">// Print the error if one occurred</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'statusCode:'</span>, response &amp;&amp; response.statusCode); <span class="comment">// Print the response status code if a response was received</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'body:'</span>, body); <span class="comment">// Print the HTML for the Google homepage.</span></span><br><span class="line">&#125;);</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2>
                  <p>从客户端进行HTTP调用在十年前可不是一件容易的事。前端开发人员不得不依赖于难以使用和实现的XMLHttpRequest。现代的库和HTTP客户端使得用户交互、动画、异步文件上传等前端功能变得更加简单。 我个人最喜欢的是Axios，因为我觉得它更易读更赏心悦目。你也可以忠于Fetch，因为它文档化良好且有标准化的解决方案。 你个人最喜欢的AJAX库是哪个？ 欢迎各位分享你的看法。</p>
                  <ul>
                    <li>译文链接：<a href="http://www.codeceo.com/article/5-javascript-ajax-libs.html" target="_blank" rel="noopener">http://www.codeceo.com/article/5-javascript-ajax-libs.html</a></li>
                    <li>英文原文：<a href="https://dzone.com/articles/top-javascript-libraries-for-making-ajax-calls" target="_blank" rel="noopener">Top JavaScript Libraries for Making AJAX Calls</a></li>
                    <li>翻译作者：<a href="http://www.codeceo.com/" target="_blank" rel="noopener">码农网</a> – 小峰</li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-07-08 01:23:09" itemprop="dateCreated datePublished" datetime="2019-07-08T01:23:09+08:00">2019-07-08</time>
                </span>
                <span id="/6806.html" class="post-meta-item leancloud_visitors" data-flag-title="介绍 5 个实用的 Ajax 库" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <script>
              document.querySelectorAll('.random').forEach(item => item.src = "https://picsum.photos/id/" + Math.floor(Math.random() * Math.floor(300)) + "/200/133")

            </script>
            <nav class="pagination">
              <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
            </nav>
          </div>
          <script>
            window.addEventListener('tabs:register', () =>
            {
              let
              {
                activeClass
              } = CONFIG.comments;
              if (CONFIG.comments.storage)
              {
                activeClass = localStorage.getItem('comments_active') || activeClass;
              }
              if (activeClass)
              {
                let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
                if (activeTab)
                {
                  activeTab.click();
                }
              }
            });
            if (CONFIG.comments.storage)
            {
              window.addEventListener('tabs:click', event =>
              {
                if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
                let commentClass = event.target.classList[1];
                localStorage.setItem('comments_active', commentClass);
              });
            }

          </script>
        </div>
        <div class="toggle sidebar-toggle">
          <span class="toggle-line toggle-line-first"></span>
          <span class="toggle-line toggle-line-middle"></span>
          <span class="toggle-line toggle-line-last"></span>
        </div>
        <aside class="sidebar">
          <div class="sidebar-inner">
            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc"> 文章目录 </li>
              <li class="sidebar-nav-overview"> 站点概览 </li>
            </ul>
            <!--noindex-->
            <div class="post-toc-wrap sidebar-panel">
            </div>
            <!--/noindex-->
            <div class="site-overview-wrap sidebar-panel">
              <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <img class="site-author-image" itemprop="image" alt="崔庆才" src="/images/avatar.png">
                <p class="site-author-name" itemprop="name">崔庆才</p>
                <div class="site-description" itemprop="description">崔庆才的个人站点，记录生活的瞬间，分享学习的心得。</div>
              </div>
              <div class="site-state-wrap motion-element">
                <nav class="site-state">
                  <div class="site-state-item site-state-posts">
                    <a href="/archives/">
                      <span class="site-state-item-count">518</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>
                  <div class="site-state-item site-state-categories">
                    <a href="/categories/">
                      <span class="site-state-item-count">21</span>
                      <span class="site-state-item-name">分类</span></a>
                  </div>
                  <div class="site-state-item site-state-tags">
                    <a href="/tags/">
                      <span class="site-state-item-count">121</span>
                      <span class="site-state-item-name">标签</span></a>
                  </div>
                </nav>
              </div>
              <div class="links-of-author motion-element">
                <span class="links-of-author-item">
                  <a href="https://github.com/Germey" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Germey" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
                </span>
                <span class="links-of-author-item">
                  <a href="mailto:cqc@cuiqingcai.com.com" title="邮件 → mailto:cqc@cuiqingcai.com.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>邮件</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://weibo.com/cuiqingcai" title="微博 → https:&#x2F;&#x2F;weibo.com&#x2F;cuiqingcai" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>微博</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/Germey" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Germey" rel="noopener" target="_blank"><i class="fa fa-magic fa-fw"></i>知乎</a>
                </span>
              </div>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://www.abuyun.com/http-proxy/introduce.html" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/88au8.jpg" style=" width: 100%;">
              </a>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://tutorial.lengyue.video/?coupon=12ef4b1a-a3db-11ea-bb37-0242ac130002_cqx_850" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/bco2a.png" style=" width: 100%;">
              </a>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://luminati-china.io/?affiliate=ref_5fbbaaa9647883f5c6f77095" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/ikkq9.jpg" style=" width: 100%;">
              </a>
            </div>
            <div class="sidebar-panel sidebar-panel-tags sidebar-panel-active">
              <h4 class="name"> 标签云 </h4>
              <div class="content">
                <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/599/" style="font-size: 10px;">599</a> <a href="/tags/Bootstrap/" style="font-size: 11.25px;">Bootstrap</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CQC/" style="font-size: 10px;">CQC</a> <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/CSS-%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">CSS 反爬虫</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Eclipse/" style="font-size: 11.25px;">Eclipse</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/GitHub/" style="font-size: 11.25px;">GitHub</a> <a href="/tags/HTML5/" style="font-size: 10px;">HTML5</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/IT/" style="font-size: 10px;">IT</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/LOGO/" style="font-size: 10px;">LOGO</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MIUI/" style="font-size: 10px;">MIUI</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/PHP/" style="font-size: 11.25px;">PHP</a> <a href="/tags/PS/" style="font-size: 10px;">PS</a> <a href="/tags/Pathlib/" style="font-size: 10px;">Pathlib</a> <a href="/tags/PhantomJS/" style="font-size: 10px;">PhantomJS</a> <a href="/tags/PySpider/" style="font-size: 10px;">PySpider</a> <a href="/tags/Python/" style="font-size: 16.25px;">Python</a> <a href="/tags/Python3/" style="font-size: 12.5px;">Python3</a> <a href="/tags/Pythonic/" style="font-size: 10px;">Pythonic</a> <a href="/tags/QQ/" style="font-size: 10px;">QQ</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SAE/" style="font-size: 10px;">SAE</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SVG/" style="font-size: 10px;">SVG</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/Scrapy-redis/" style="font-size: 10px;">Scrapy-redis</a> <a href="/tags/Scrapy%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">Scrapy分布式</a> <a href="/tags/Selenium/" style="font-size: 10px;">Selenium</a> <a href="/tags/TKE/" style="font-size: 10px;">TKE</a> <a href="/tags/Ubuntu/" style="font-size: 11.25px;">Ubuntu</a> <a href="/tags/Vue/" style="font-size: 11.25px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Winpcap/" style="font-size: 10px;">Winpcap</a> <a href="/tags/WordPress/" style="font-size: 13.75px;">WordPress</a> <a href="/tags/object-Object/" style="font-size: 10px;">[object Object]</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/cocos2d-x/" style="font-size: 10px;">cocos2d-x</a> <a href="/tags/e6/" style="font-size: 10px;">e6</a> <a href="/tags/fitvids/" style="font-size: 10px;">fitvids</a> <a href="/tags/git/" style="font-size: 11.25px;">git</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/js%E9%80%86%E5%90%91/" style="font-size: 10px;">js逆向</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/logging/" style="font-size: 10px;">logging</a> <a href="/tags/matlab/" style="font-size: 11.25px;">matlab</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/pywin32/" style="font-size: 10px;">pywin32</a> <a href="/tags/style/" style="font-size: 10px;">style</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/uwsgi/" style="font-size: 10px;">uwsgi</a> <a href="/tags/validate-cert/" style="font-size: 10px;">validate_cert</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/wamp/" style="font-size: 10px;">wamp</a> <a href="/tags/wineQQ/" style="font-size: 10px;">wineQQ</a> <a href="/tags/%E4%B8%83%E7%89%9B/" style="font-size: 11.25px;">七牛</a> <a href="/tags/%E4%B8%8A%E6%B5%B7/" style="font-size: 10px;">上海</a> <a href="/tags/%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99/" style="font-size: 10px;">个人网站</a> <a href="/tags/%E4%B8%BB%E9%A2%98/" style="font-size: 10px;">主题</a> <a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 10px;">云存储</a> <a href="/tags/%E4%BA%AC%E4%B8%9C%E4%BA%91/" style="font-size: 10px;">京东云</a> <a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 10px;">人工智能</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 10px;">代理</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" style="font-size: 10px;">代码</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size: 10px;">位运算</a> <a href="/tags/%E5%88%86%E4%BA%AB/" style="font-size: 10px;">分享</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">分布式</a> <a href="/tags/%E5%88%9B%E4%B8%9A/" style="font-size: 10px;">创业</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 11.25px;">前端</a> <a href="/tags/%E5%8E%9F%E7%94%9FAPP/" style="font-size: 10px;">原生APP</a> <a href="/tags/%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 12.5px;">反爬虫</a> <a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 10px;">命令</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80/" style="font-size: 10px;">响应式布局</a> <a href="/tags/%E5%9F%9F%E5%90%8D%E7%BB%91%E5%AE%9A/" style="font-size: 10px;">域名绑定</a> <a href="/tags/%E5%A4%A7%E4%BC%97%E7%82%B9%E8%AF%84/" style="font-size: 10px;">大众点评</a> <a href="/tags/%E5%AD%97%E4%BD%93%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">字体反爬虫</a> <a href="/tags/%E5%AE%9E%E7%94%A8/" style="font-size: 10px;">实用</a> <a href="/tags/%E5%B4%94%E5%BA%86%E6%89%8D/" style="font-size: 18.75px;">崔庆才</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%89%8B%E6%9C%BA%E8%AE%BF%E9%97%AE/" style="font-size: 10px;">手机访问</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%97%85%E6%B8%B8/" style="font-size: 10px;">旅游</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 10px;">日志</a> <a href="/tags/%E6%9D%9C%E5%85%B0%E7%89%B9/" style="font-size: 10px;">杜兰特</a> <a href="/tags/%E6%A1%8C%E9%9D%A2/" style="font-size: 10px;">桌面</a> <a href="/tags/%E6%B1%9F%E5%8D%97/" style="font-size: 10px;">江南</a> <a href="/tags/%E6%B8%B8%E6%88%8F/" style="font-size: 10px;">游戏</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 15px;">爬虫</a> <a href="/tags/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" style="font-size: 10px;">环境变量</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">生活笔记</a> <a href="/tags/%E7%99%BB%E5%BD%95/" style="font-size: 10px;">登录</a> <a href="/tags/%E7%9F%A5%E4%B9%8E/" style="font-size: 10px;">知乎</a> <a href="/tags/%E7%9F%AD%E4%BF%A1/" style="font-size: 10px;">短信</a> <a href="/tags/%E7%BA%B8%E5%BC%A0/" style="font-size: 10px;">纸张</a> <a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 10px;">网站</a> <a href="/tags/%E8%82%89%E5%A4%B9%E9%A6%8D/" style="font-size: 10px;">肉夹馍</a> <a href="/tags/%E8%A5%BF%E5%B0%91%E7%88%B7/" style="font-size: 10px;">西少爷</a> <a href="/tags/%E8%A7%86%E9%A2%91/" style="font-size: 10px;">视频</a> <a href="/tags/%E8%BF%9C%E7%A8%8B/" style="font-size: 10px;">远程</a> <a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 10px;">逆向</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 10px;">配置</a> <a href="/tags/%E9%87%8D%E8%A3%85/" style="font-size: 10px;">重装</a> <a href="/tags/%E9%9D%99%E8%A7%85/" style="font-size: 17.5px;">静觅</a> <a href="/tags/%E9%A2%A0%E8%A6%86/" style="font-size: 10px;">颠覆</a> <a href="/tags/%E9%A3%9E%E4%BF%A1/" style="font-size: 10px;">飞信</a>
              </div>
              <script>
                const tagsColors = ['#00a67c', '#5cb85c', '#d9534f', '#567e95', '#b37333', '#f4843d', '#15a287']
                const tagsElements = document.querySelectorAll('.sidebar-panel-tags .content a')
                tagsElements.forEach((item) =>
                {
                  item.style.backgroundColor = tagsColors[Math.floor(Math.random() * tagsColors.length)]
                })

              </script>
            </div>
            <div class="sidebar-panel sidebar-panel-categories sidebar-panel-active">
              <h4 class="name"> 分类 </h4>
              <div class="content">
                <ul class="category-list">
                  <li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">23</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><span class="category-list-count">13</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">26</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">15</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Net/">Net</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a><span class="category-list-count">38</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">27</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Paper/">Paper</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">256</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E5%B1%95%E7%A4%BA/">个人展示</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/">个人日记</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/">个人随笔</a><span class="category-list-count">10</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/">技术杂谈</a><span class="category-list-count">74</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/">生活笔记</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A6%8F%E5%88%A9%E4%B8%93%E5%8C%BA/">福利专区</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%81%8C%E4%BD%8D%E6%8E%A8%E8%8D%90/">职位推荐</a><span class="category-list-count">2</span></li>
                </ul>
              </div>
            </div>
            <div class="sidebar-panel sidebar-panel-friends sidebar-panel-active">
              <h4 class="name"> 友情链接 </h4>
              <ul class="friends">
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/j2dub.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.findhao.net/" target="_blank" rel="noopener">FindHao</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ou6mm.jpg">
                  </span>
                  <span class="link">
                    <a href="https://diygod.me/" target="_blank" rel="noopener">DIYgod</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/6apxu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.51dev.com/" target="_blank" rel="noopener">IT技术社区</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.jankl.com/img/titleshu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.jankl.com/" target="_blank" rel="noopener">liberalist</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/bqlbs.png">
                  </span>
                  <span class="link">
                    <a href="http://www.urselect.com/" target="_blank" rel="noopener">优社电商</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/8s88c.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yuanrenxue.com/" target="_blank" rel="noopener">猿人学</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/4i7yf.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lizenghai.com/" target="_blank" rel="noopener">Python量化投资</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/2wgg5.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yunlifang.cn/" target="_blank" rel="noopener">云立方</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/shwr6.png">
                  </span>
                  <span class="link">
                    <a href="http://lanbing510.info/" target="_blank" rel="noopener">冰蓝</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/blvoh.jpg">
                  </span>
                  <span class="link">
                    <a href="https://lengyue.me/" target="_blank" rel="noopener">冷月</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="http://qianxunclub.com/favicon.png">
                  </span>
                  <span class="link">
                    <a href="http://qianxunclub.com/" target="_blank" rel="noopener">千寻啊千寻</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/0044u.jpg">
                  </span>
                  <span class="link">
                    <a href="http://kodcloud.com/" target="_blank" rel="noopener">可道云</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ygnpn.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.kunkundashen.cn/" target="_blank" rel="noopener">坤坤大神</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/22uv1.png">
                  </span>
                  <span class="link">
                    <a href="http://www.cenchong.com/" target="_blank" rel="noopener">岑冲博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ev9kl.png">
                  </span>
                  <span class="link">
                    <a href="http://www.zxiaoji.com/" target="_blank" rel="noopener">张小鸡</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.chrafz.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.chrafz.com/" target="_blank" rel="noopener">张弦先生</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.503error.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.503error.com/" target="_blank" rel="noopener">张志明个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://seofangfa.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://seofangfa.com/" target="_blank" rel="noopener">方法SEO</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/x714o.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.hubwiz.com/" target="_blank" rel="noopener">汇智网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/lfmj3.png">
                  </span>
                  <span class="link">
                    <a href="http://frankchen.xyz/" target="_blank" rel="noopener">不正经数据科学家</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/129d8.png">
                  </span>
                  <span class="link">
                    <a href="https://www.bysocket.com/" target="_blank" rel="noopener">泥瓦匠BYSocket</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.xiongge.club/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.xiongge.club/" target="_blank" rel="noopener">熊哥club</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/3w4fe.png">
                  </span>
                  <span class="link">
                    <a href="https://zerlong.com/" target="_blank" rel="noopener">知语</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/262r1.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.ysir308.com/" target="_blank" rel="noopener">程序员虾说</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/44hxf.png">
                  </span>
                  <span class="link">
                    <a href="http://redstonewill.com/" target="_blank" rel="noopener">红色石头</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/8g1fk.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.laodong.me/" target="_blank" rel="noopener">老董博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/wkaus.jpg">
                  </span>
                  <span class="link">
                    <a href="https://zhaoshuai.me/" target="_blank" rel="noopener">碎念</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/pgo0r.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.chenwenguan.com/" target="_blank" rel="noopener">陈文管的博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/kk82a.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lxlinux.net/" target="_blank" rel="noopener">良许Linux教程网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/lj0t2.jpg">
                  </span>
                  <span class="link">
                    <a href="https://tanqingbo.cn/" target="_blank" rel="noopener">IT码农</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/i8cdr.png">
                  </span>
                  <span class="link">
                    <a href="https://junyiseo.com/" target="_blank" rel="noopener">均益个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/chwv2.png">
                  </span>
                  <span class="link">
                    <a href="https://brucedone.com/" target="_blank" rel="noopener">大鱼的鱼塘</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/2y43o.png">
                  </span>
                  <span class="link">
                    <a href="http://bbs.nightteam.cn/" target="_blank" rel="noopener">夜幕爬虫安全论坛</a>
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </aside>
        <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span>
          <span class="with-love">
            <i class="fa fa-heart"></i>
          </span>
          <span class="author" itemprop="copyrightHolder">崔庆才丨静觅</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-chart-area"></i>
          </span>
          <span title="站点总字数">2.5m</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-coffee"></i>
          </span>
          <span title="站点阅读时长">37:31</span>
        </div>
        <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动 </div>
        <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18015597号-1 </a>
        </div>
        <script>
          (function ()
          {
            function leancloudSelector(url)
            {
              url = encodeURI(url);
              return document.getElementById(url).querySelector('.leancloud-visitors-count');
            }

            function addCount(Counter)
            {
              var visitors = document.querySelector('.leancloud_visitors');
              var url = decodeURI(visitors.id);
              var title = visitors.dataset.flagTitle;
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                if (results.length > 0)
                {
                  var counter = results[0];
                  leancloudSelector(url).innerText = counter.time + 1;
                  Counter('put', '/classes/Counter/' + counter.objectId,
                  {
                    time:
                    {
                      '__op': 'Increment',
                      'amount': 1
                    }
                  }).catch(error =>
                  {
                    console.error('Failed to save visitor count', error);
                  });
                }
                else
                {
                  Counter('post', '/classes/Counter',
                  {
                    title,
                    url,
                    time: 1
                  }).then(response => response.json()).then(() =>
                  {
                    leancloudSelector(url).innerText = 1;
                  }).catch(error =>
                  {
                    console.error('Failed to create', error);
                  });
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }

            function showTime(Counter)
            {
              var visitors = document.querySelectorAll('.leancloud_visitors');
              var entries = [...visitors].map(element =>
              {
                return decodeURI(element.id);
              });
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url:
                {
                  '$in': entries
                }
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                for (let url of entries)
                {
                  let target = results.find(item => item.url === url);
                  leancloudSelector(url).innerText = target ? target.time : 0;
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }
            let
            {
              app_id,
              app_key,
              server_url
            } = {
              "enable": true,
              "app_id": "6X5dRQ0pnPWJgYy8SXOg0uID-gzGzoHsz",
              "app_key": "ziLDVEy73ne5HtFTiGstzHMS",
              "server_url": null,
              "security": false
            };

            function fetchData(api_server)
            {
              var Counter = (method, url, data) =>
              {
                return fetch(`${api_server}/1.1${url}`,
                {
                  method,
                  headers:
                  {
                    'X-LC-Id': app_id,
                    'X-LC-Key': app_key,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data)
                });
              };
              if (CONFIG.page.isPost)
              {
                if (CONFIG.hostname !== location.hostname) return;
                addCount(Counter);
              }
              else if (document.querySelectorAll('.post-title-link').length >= 1)
              {
                showTime(Counter);
              }
            }
            let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;
            if (api_server)
            {
              fetchData(api_server);
            }
            else
            {
              fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id).then(response => response.json()).then((
              {
                api_server
              }) =>
              {
                fetchData('https://' + api_server);
              });
            }
          })();

        </script>
      </div>
      <div class="footer-stat">
        <span id="cnzz_stat_icon_1279355174"></span>
        <script type="text/javascript">
          document.write(unescape("%3Cspan id='cnzz_stat_icon_1279355174'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279355174%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));

        </script>
      </div>
    </footer>
  </div>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/.js"></script>
  <script src="/js/schemes/pisces.js"></script>
  <script src="/.js"></script>
  <script src="/js/next-boot.js"></script>
  <script src="/.js"></script>
  <script>
    (function ()
    {
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x = document.getElementsByTagName("link");
      //Find the last canonical URL
      if (x.length > 0)
      {
        for (i = 0; i < x.length; i++)
        {
          if (x[i].rel.toLowerCase() == 'canonical' && x[i].href)
          {
            canonicalURL = x[i].href;
          }
        }
      }
      //Get protocol
      if (!canonicalURL)
      {
        curProtocol = window.location.protocol.split(':')[0];
      }
      else
      {
        curProtocol = canonicalURL.split(':')[0];
      }
      //Get current URL if the canonical URL does not exist
      if (!canonicalURL) canonicalURL = window.location.href;
      //Assign script content. Replace current URL with the canonical URL
      ! function ()
      {
        var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,
          r = canonicalURL,
          t = document.referrer;
        if (!e.test(r))
        {
          var n = (String(curProtocol).toLowerCase() === 'https') ? "https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif" : "//api.share.baidu.com/s.gif";
          t ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
          var i = new Image;
          i.src = n
        }
      }(window);
    })();

  </script>
  <script src="/js/local-search.js"></script>
  <script src="/.js"></script>
</body>

</html>
