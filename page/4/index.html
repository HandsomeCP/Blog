<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
  <meta name="theme-color" content="#222">
  <meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>
  <script id="hexo-configurations">
    var NexT = window.NexT ||
    {};
    var CONFIG = {
      "hostname": "cuiqingcai.com",
      "root": "/",
      "scheme": "Pisces",
      "version": "7.8.0",
      "exturl": false,
      "sidebar":
      {
        "position": "right",
        "width": 360,
        "display": "post",
        "padding": 18,
        "offset": 12,
        "onmobile": false,
        "widgets": [
          {
            "type": "image",
            "name": "阿布云",
            "enable": true,
            "url": "https://www.abuyun.com/http-proxy/introduce.html",
            "src": "https://qiniu.cuiqingcai.com/88au8.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "天验",
            "enable": true,
            "url": "https://tutorial.lengyue.video/?coupon=12ef4b1a-a3db-11ea-bb37-0242ac130002_cqx_850",
            "src": "https://qiniu.cuiqingcai.com/bco2a.png",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "华为云",
            "enable": false,
            "url": "https://activity.huaweicloud.com/2020_618_promotion/index.html?bpName=5f9f98a29e2c40b780c1793086f29fe2&bindType=1&salesID=wangyubei",
            "src": "https://qiniu.cuiqingcai.com/y42ik.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "张小鸡",
            "enable": false,
            "url": "http://www.zxiaoji.com/",
            "src": "https://qiniu.cuiqingcai.com/fm72f.png",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "Luminati",
            "src": "https://qiniu.cuiqingcai.com/ikkq9.jpg",
            "url": "https://luminati-china.io/?affiliate=ref_5fbbaaa9647883f5c6f77095",
            "width": "100%",
            "enable": true
      },
          {
            "type": "tags",
            "name": "标签云",
            "enable": true
      },
          {
            "type": "categories",
            "name": "分类",
            "enable": true
      },
          {
            "type": "friends",
            "name": "友情链接",
            "enable": true
      },
          {
            "type": "hot",
            "name": "猜你喜欢",
            "enable": true
      }]
      },
      "copycode":
      {
        "enable": true,
        "show_result": true,
        "style": "mac"
      },
      "back2top":
      {
        "enable": true,
        "sidebar": false,
        "scrollpercent": true
      },
      "bookmark":
      {
        "enable": false,
        "color": "#222",
        "save": "auto"
      },
      "fancybox": false,
      "mediumzoom": false,
      "lazyload": false,
      "pangu": true,
      "comments":
      {
        "style": "tabs",
        "active": "gitalk",
        "storage": true,
        "lazyload": false,
        "nav": null,
        "activeClass": "gitalk"
      },
      "algolia":
      {
        "hits":
        {
          "per_page": 10
        },
        "labels":
        {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      },
      "localsearch":
      {
        "enable": true,
        "trigger": "auto",
        "top_n_per_article": 10,
        "unescape": false,
        "preload": false
      },
      "motion":
      {
        "enable": false,
        "async": false,
        "transition":
        {
          "post_block": "bounceDownIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      "path": "search.xml"
    };

  </script>
  <meta name="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
  <meta property="og:type" content="website">
  <meta property="og:title" content="静觅">
  <meta property="og:url" content="https://cuiqingcai.com/page/4/index.html">
  <meta property="og:site_name" content="静觅">
  <meta property="og:description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
  <meta property="og:locale" content="zh_CN">
  <meta property="article:author" content="崔庆才">
  <meta property="article:tag" content="崔庆才">
  <meta property="article:tag" content="静觅">
  <meta property="article:tag" content="PHP">
  <meta property="article:tag" content="Java">
  <meta property="article:tag" content="Python">
  <meta property="article:tag" content="Spider">
  <meta property="article:tag" content="爬虫">
  <meta property="article:tag" content="Web">
  <meta property="article:tag" content="Kubernetes">
  <meta property="article:tag" content="深度学习">
  <meta property="article:tag" content="机器学习">
  <meta property="article:tag" content="数据分析">
  <meta property="article:tag" content="网络">
  <meta property="article:tag" content="IT">
  <meta property="article:tag" content="技术">
  <meta property="article:tag" content="博客">
  <meta name="twitter:card" content="summary">
  <link rel="canonical" href="https://cuiqingcai.com/page/4/">
  <script id="page-configurations">
    // https://hexo.io/docs/variables.html
    CONFIG.page = {
      sidebar: "",
      isHome: true,
      isPost: false,
      lang: 'zh-CN'
    };

  </script>
  <title>静觅丨崔庆才的个人站点</title>
  <meta name="google-site-verification" content="p_bIcnvirkFzG2dYKuNDivKD8-STet5W7D-01woA2fc" />
  <noscript>
    <style>
      .use-motion .brand,
      .use-motion .menu-item,
      .sidebar-inner,
      .use-motion .post-block,
      .use-motion .pagination,
      .use-motion .comments,
      .use-motion .post-header,
      .use-motion .post-body,
      .use-motion .collection-header
      {
        opacity: initial;
      }

      .use-motion .site-title,
      .use-motion .site-subtitle
      {
        opacity: initial;
        top: initial;
      }

      .use-motion .logo-line-before i
      {
        left: initial;
      }

      .use-motion .logo-line-after i
      {
        right: initial;
      }

    </style>
  </noscript>
  <link rel="alternate" href="/atom.xml" title="静觅" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-container">
          <div class="site-nav-toggle">
            <div class="toggle" aria-label="切换导航栏">
              <span class="toggle-line toggle-line-first"></span>
              <span class="toggle-line toggle-line-middle"></span>
              <span class="toggle-line toggle-line-last"></span>
            </div>
          </div>
          <div class="site-meta">
            <a href="/" class="brand" rel="start">
              <span class="logo-line-before"><i></i></span>
              <h1 class="site-title">静觅 <span class="site-subtitle"> 崔庆才的个人站点 </span>
              </h1>
              <span class="logo-line-after"><i></i></span>
            </a>
          </div>
          <div class="site-nav-right">
            <div class="toggle popup-trigger">
              <i class="fa fa-search fa-fw fa-lg"></i>
            </div>
          </div>
        </div>
        <nav class="site-nav">
          <ul id="menu" class="main-menu menu">
            <li class="menu-item menu-item-home">
              <a href="/" rel="section">首页</a>
            </li>
            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">文章列表</a>
            </li>
            <li class="menu-item menu-item-tags">
              <a href="/tags/" rel="section">文章标签</a>
            </li>
            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">文章分类</a>
            </li>
            <li class="menu-item menu-item-about">
              <a href="/about/" rel="section">关于博主</a>
            </li>
            <li class="menu-item menu-item-message">
              <a href="/message/" rel="section">给我留言</a>
            </li>
            <li class="menu-item menu-item-search">
              <a role="button" class="popup-trigger">搜索 </a>
            </li>
          </ul>
        </nav>
        <div class="search-pop-overlay">
          <div class="popup search-popup">
            <div class="search-header">
              <span class="search-icon">
                <i class="fa fa-search"></i>
              </span>
              <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
              </div>
              <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
              </span>
            </div>
            <div id="search-result">
              <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span>0%</span>
    </div>
    <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content index posts-expand">
            <div class="carousel">
              <div id="wowslider-container">
                <div class="ws_images">
                  <ul>
                    <li><a target="_blank" href="https://cuiqingcai.com/5052.html"><img title="Python3网络爬虫开发实战教程" src="https://qiniu.cuiqingcai.com/ipy96.jpg" /></a></li>
                    <li><a target="_blank" href="https://t.lagou.com/fRCBRsRCSN6FA"><img title="52讲轻松搞定网络爬虫" src="https://qiniu.cuiqingcai.com/fqq5e.png" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/4320.html"><img title="Python3网络爬虫开发视频教程" src="https://qiniu.cuiqingcai.com/bjrny.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/1052.html"><img title="Python2爬虫学习系列教程" src="https://qiniu.cuiqingcai.com/uyl5v.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/5094.html"><img title="爬虫代理哪家强？十大付费代理详细对比评测出炉！" src="https://qiniu.cuiqingcai.com/nifs6.jpg" /></a></li>
                  </ul>
                </div>
                <div class="ws_thumbs">
                  <div>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/ipy96.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/fqq5e.png" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/bjrny.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/uyl5v.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://qiniu.cuiqingcai.com/nifs6.jpg" /></a>
                  </div>
                </div>
                <div class="ws_shadow"></div>
              </div>
            </div>
            <link rel="stylesheet" href="/lib/wowslide/slide.css">
            <script src="/lib/wowslide/jquery.min.js"></script>
            <script src="/lib/wowslide/slider.js"></script>
            <script>
              jQuery("#wowslider-container").wowSlider(
              {
                effect: "cube",
                prev: "",
                next: "",
                duration: 20 * 100,
                delay: 20 * 100,
                width: 716,
                height: 297,
                autoPlay: true,
                playPause: true,
                stopOnHover: false,
                loop: false,
                bullets: 0,
                caption: true,
                captionEffect: "slide",
                controls: true,
                onBeforeStep: 0,
                images: 0
              });

            </script>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9200.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/9200.html" class="post-title-link" itemprop="url">利用深度学习 PyTorch 识别滑动验证码缺口</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在前面写过一篇文章介绍深度学习识别滑动验证码缺口的文章，在这篇文章里，我们使用华为云 ModelArts 轻松完成了滑动验证码缺口的识别。但是那种实现方案依赖于 ModelArts，是华为云提供的深度学习平台所搭建的识别模型，其实其内部是用的深度学习的某种目标检测算法实现的，如果利用平台的话，我们无需去申请 GPU、无需去了解其内部的基本原理究竟是怎么回事，它提供了一系列标注、训练、部署的流程。 但用上述方法是有一定的弊端的，比如使用会一直收费，另外不好调优、不好更好地定制自己的一些需求等等。所以这里再发一篇文章来介绍一下直接使用 Python 的深度学习模型来实现滑动验证码缺口识别的方法。</p>
                  <h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2>
                  <p>目前可以做到只需要几百张缺口标注图片即可训练出精度高的识别模型，并且可扩展修改为其他任何样式的缺口识别，识别效果样例： <img src="https://qiniu.cuiqingcai.com/2020-04-18-135131.png" alt="样例"> 只需要给模型输入一张带缺口的验证码图片，模型就能输出缺口的轮廓和边界信息。 感兴趣的可以继续向下看具体的实现流程。</p>
                  <h2 id="基础了解"><a href="#基础了解" class="headerlink" title="基础了解"></a>基础了解</h2>
                  <p>缺口识别属于目标检测问题，关于什么是目标检测这里就不再赘述了，可以参考之前写的这篇文章。 当前做目标检测的算法主要有两种路子，有一阶段式和两阶段式，英文叫做 One stage 和 Two stage，简述如下：</p>
                  <ul>
                    <li>Two Stage：算法首先生成一系列目标所在位置的候选框，然后再对这些框选出来的结果进行样本分类，即先找出来在哪，然后再分出来是啥，俗话说叫「看两眼」，这种算法有 R-CNN、Fast R-CNN、Faster R-CNN 等，这些算法架构相对复杂，但准确率上有优势。</li>
                    <li>One Stage：不需要产生候选框，直接将目标定位和分类的问题转化为回归问题，俗话说叫「看一眼」，这种算法有 YOLO、SSD，这些算法虽然准确率上不及 Two stage，但架构相对简单，检测速度更快。</li>
                  </ul>
                  <p>所以这次我们选用 One Stage 的有代表性的目标检测算法 YOLO 来实现滑动验证码缺口的识别。 YOLO，英文全称叫做 You Only Look Once，取了它们的首字母就构成了算法名， 目前 YOLO 算法最新的版本是 V3 版本，这里算法的具体流程我们就不过多介绍了，感兴趣的可以搜一下相关资料了解下，另外也可以了解下 YOLO V1-V3 版本的不同和改进之处，这里列几个参考链接。</p>
                  <ul>
                    <li>YOLO V3 论文：<a href="https://pjreddie.com/media/files/papers/YOLOv3.pdf" target="_blank" rel="noopener">https://pjreddie.com/media/files/papers/YOLOv3.pdf</a></li>
                    <li>YOLO V3 介绍：<a href="https://zhuanlan.zhihu.com/p/34997279" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/34997279</a></li>
                    <li>YOLO V1-V3 对比介绍：<a href="https://www.cnblogs.com/makefile/p/yolov3.html" target="_blank" rel="noopener">https://www.cnblogs.com/makefile/p/yolov3.html</a></li>
                  </ul>
                  <h2 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h2>
                  <p>回归我们本节的主题，我们要做的是缺口的位置识别，那么第一步应该做什么呢？ 我们的目标是要训练深度学习模型，训练模型，那我们总得需要让模型知道要学点什么东西吧，这次我们做缺口识别，那么我们需要让模型学的就是这个缺口在哪里。由于一张验证码图片只有一个缺口，要分类就是一类，所以我们只需要找到缺口位置就行了。 好，那模型要学缺口在哪里，那我们就得提供点样本数据让模型来学习才行。数据怎样的呢？那数据就得有带缺口的验证码图片以及我们自己标注的缺口位置。只有把这两部分都告诉模型，模型才能去学习。等模型学好了，等我们再给个新的验证码，那就能检测出缺口在哪里了，这就是一个成功的模型。 OK，那我们就开始准备数据和缺口标注结果吧。 数据这里用的是网易盾的验证码，验证码图片可以自行收集，写个脚本批量保存下来就行。标注的工具可以使用 LabelImg，GitHub 链接为：<a href="https://github.com/tzutalin/labelImg，利用它我们可以方便地进行检测目标位置的标注和类别的标注，如这里验证码和标注示例如下" target="_blank" rel="noopener">https://github.com/tzutalin/labelImg，利用它我们可以方便地进行检测目标位置的标注和类别的标注，如这里验证码和标注示例如下</a>： <img src="https://qiniu.cuiqingcai.com/2020-04-18-131850.png" alt="标注效果"> 标注完了会生成一系列 xml 文件，你需要解析 xml 文件把位置的坐标和类别等处理一下，转成训练模型需要的数据。 在这里我先把我整理的数据集放出来吧，完整 GitHub 链接为：<a href="https://github.com/Python3WebSpider/DeepLearningSlideCaptcha，我标注了" target="_blank" rel="noopener">https://github.com/Python3WebSpider/DeepLearningSlideCaptcha，我标注了</a> 200 多张图片，然后处理了 xml 文件，变成训练 YOLO 模型需要的数据格式，验证码图片和标注结果见 data/captcha 文件夹。 如果要训练自己的数据，数据格式准备见：<a href="https://github.com/eriklindernoren/PyTorch-YOLOv3#train-on-custom-dataset" target="_blank" rel="noopener">https://github.com/eriklindernoren/PyTorch-YOLOv3#train-on-custom-dataset</a>。</p>
                  <h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2>
                  <p>上一步我已经把标注好的数据处理好了，可以直接拿来训练了。 由于 YOLO 模型相对比较复杂，所以这个项目我就直接基于开源的 PyTorch-YOLOV3 项目来修改了，模型使用的深度学习框架为 PyTorch，具体的 YOLO V3 模型的实现这里不再阐述了。 另外推荐使用 GPU 训练，不然拿 CPU 直接训练速度很慢。我的 GPU 是 P100，几乎十几秒就训练完一轮。 下面就直接把代码克隆下来吧。 由于本项目我把训练好的模型也放上去了，使用了 Git LFS，所以克隆时间较长，克隆命令如下：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/Python3WebSpider/DeepLearningSlideCaptcha.git</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果想加速克隆，暂时先跳过大文件模型下载，可以执行命令：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">GIT_LFS_SKIP_SMUDGE=</span><span class="number">1</span> git <span class="keyword">clone</span> <span class="title">https</span>://github.com/Python3WebSpider/DeepLearningSlideCaptcha.git</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2>
                  <p>代码克隆下载之后，我们还需要下载一些预训练模型。 YOLOV3 的训练要加载预训练模型才能有不错的训练效果，预训练模型下载命令如下：</p>
                  <figure class="highlight arduino">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">bash <span class="built_in">prepare</span>.sh</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行这个脚本，就能下载 YOLO V3 模型的一些权重文件，包括 yolov3 和 weights 还有 darknet 的 weights，在训练之前我们需要用这些权重文件初始化 YOLO V3 模型。</p>
                  <blockquote>
                    <p>注意：Windows 下建议使用 Git Bash 来运行上述命令。</p>
                  </blockquote>
                  <p>另外还需要安装一些必须的库，如 PyTorch、TensorBoard 等，建议使用 Python 虚拟环境，运行命令如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> -r requirements.txt</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这些库都安装好了之后，就可以开始训练了。</p>
                  <h2 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h2>
                  <p>本项目已经提供了标注好的数据集，在 data/captcha，可以直接使用。 当前数据训练脚本：</p>
                  <figure class="highlight armasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">bash </span>train.sh</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>实测 P100 训练时长约 15 秒一个 epoch，大约几分钟即可训练出较好效果。 训练差不多了，我们可以使用 TensorBoard 来看看 loss 和 mAP 的变化，运行 TensorBoard：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">tensorboard --logdir=<span class="string">'logs'</span> --port=<span class="number">6006</span> --host <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>loss_1 变化如下： <img src="https://qiniu.cuiqingcai.com/2020-04-18-134019.png" alt="loss 变化"> val_mAP 变化如下： <img src="https://qiniu.cuiqingcai.com/2020-04-18-134051.png" alt="mAP 变化"> 可以看到 loss 从最初的非常高下降到了很低，准确率也逐渐接近 100%。 另外训练过程中还能看到如下的输出结果：</p>
                  <figure class="highlight gherkin">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">\---- [Epoch 99/100, Batch 27/29] ----</span><br><span class="line">+------------+--------------+--------------+--------------+</span><br><span class="line">|<span class="string"> Metrics    </span>|<span class="string"> YOLO Layer 0 </span>|<span class="string"> YOLO Layer 1 </span>|<span class="string"> YOLO Layer 2 </span>|</span><br><span class="line">+------------+--------------+--------------+--------------+</span><br><span class="line">|<span class="string"> grid_size  </span>|<span class="string"> 14           </span>|<span class="string"> 28           </span>|<span class="string"> 56           </span>|</span><br><span class="line">|<span class="string"> loss       </span>|<span class="string"> 0.028268     </span>|<span class="string"> 0.046053     </span>|<span class="string"> 0.043745     </span>|</span><br><span class="line">|<span class="string"> x          </span>|<span class="string"> 0.002108     </span>|<span class="string"> 0.005267     </span>|<span class="string"> 0.008111     </span>|</span><br><span class="line">|<span class="string"> y          </span>|<span class="string"> 0.004561     </span>|<span class="string"> 0.002016     </span>|<span class="string"> 0.009047     </span>|</span><br><span class="line">|<span class="string"> w          </span>|<span class="string"> 0.001284     </span>|<span class="string"> 0.004618     </span>|<span class="string"> 0.000207     </span>|</span><br><span class="line">|<span class="string"> h          </span>|<span class="string"> 0.000594     </span>|<span class="string"> 0.000528     </span>|<span class="string"> 0.000946     </span>|</span><br><span class="line">|<span class="string"> conf       </span>|<span class="string"> 0.019700     </span>|<span class="string"> 0.033624     </span>|<span class="string"> 0.025432     </span>|</span><br><span class="line">|<span class="string"> cls        </span>|<span class="string"> 0.000022     </span>|<span class="string"> 0.000001     </span>|<span class="string"> 0.000002     </span>|</span><br><span class="line">|<span class="string"> cls_acc    </span>|<span class="string"> 100.00%      </span>|<span class="string"> 100.00%      </span>|<span class="string"> 100.00%      </span>|</span><br><span class="line">|<span class="string"> recall50   </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|</span><br><span class="line">|<span class="string"> recall75   </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|</span><br><span class="line">|<span class="string"> precision  </span>|<span class="string"> 1.000000     </span>|<span class="string"> 0.800000     </span>|<span class="string"> 0.666667     </span>|</span><br><span class="line">|<span class="string"> conf_obj   </span>|<span class="string"> 0.994271     </span>|<span class="string"> 0.999249     </span>|<span class="string"> 0.997762     </span>|</span><br><span class="line">|<span class="string"> conf_noobj </span>|<span class="string"> 0.000126     </span>|<span class="string"> 0.000158     </span>|<span class="string"> 0.000140     </span>|</span><br><span class="line">+------------+--------------+--------------+--------------+</span><br><span class="line">Total loss 0.11806630343198776</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里显示了训练过程中各个指标的变化情况，如 loss、recall、precision、confidence 等，分别代表训练过程的损失（越小越好）、召回率（能识别出的结果占应该识别出结果的比例，越高越好）、精确率（识别出的结果中正确的比率，越高越好）、置信度（模型有把握识别对的概率，越高越好），可以作为参考。</p>
                  <h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2>
                  <p>训练完毕之后会在 checkpoints 文件夹生成 pth 文件，可直接使用模型来预测生成标注结果。 如果你没有训练自己的模型的话，这里我已经把训练好的模型放上去了，可以直接使用我训练好的模型来测试。如之前跳过了 Git LFS 文件下载，则可以使用如下命令下载 Git LFS 文件：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">git lfs pull</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>此时 checkpoints 文件夹会生成训练好的 pth 文件。 测试脚本：</p>
                  <figure class="highlight stata">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">sh</span> detect.<span class="keyword">sh</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>该脚本会读取 captcha 下的 test 文件夹所有图片，并将处理后的结果输出到 result 文件夹。 运行结果样例：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Performing object detection:</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">0</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.044223</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">1</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.028566</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">2</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.029764</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">3</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.032430</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">4</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.033373</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">5</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.027861</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">6</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.031444</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">7</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.032110</span></span><br><span class="line">        <span class="string">+</span> <span class="string">Batch</span> <span class="number">8</span><span class="string">,</span> <span class="attr">Inference Time:</span> <span class="number">0</span><span class="string">:00:00.029131</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Saving images:</span></span><br><span class="line"><span class="string">(0)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4497.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99999</span></span><br><span class="line"><span class="string">(1)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4498.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99999</span></span><br><span class="line"><span class="string">(2)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4499.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99997</span></span><br><span class="line"><span class="string">(3)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4500.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99999</span></span><br><span class="line"><span class="string">(4)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4501.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99997</span></span><br><span class="line"><span class="string">(5)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4502.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99999</span></span><br><span class="line"><span class="string">(6)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4503.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99997</span></span><br><span class="line"><span class="string">(7)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4504.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99998</span></span><br><span class="line"><span class="string">(8)</span> <span class="attr">Image:</span> <span class="string">'data/captcha/test/captcha_4505.png'</span></span><br><span class="line">        <span class="string">+</span> <span class="attr">Label:</span> <span class="string">target,</span> <span class="attr">Conf:</span> <span class="number">0.99998</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>拿几个样例结果看下： <img src="https://qiniu.cuiqingcai.com/2020-04-18-140149.png" alt=""> <img src="https://qiniu.cuiqingcai.com/2020-04-18-140204.png" alt=""> <img src="https://qiniu.cuiqingcai.com/2020-04-18-140219.png" alt=""> 这里我们可以看到，利用训练好的模型我们就成功识别出缺口的位置了，另外程序还会打印输出这个边框的中心点和宽高信息。 有了这个边界信息，我们再利用某些手段拖动滑块即可通过验证了。本节不再展开讲解。</p>
                  <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
                  <p>本篇文章我们介绍了使用深度学习识别滑动验证码缺口的方法，包括标注、训练、测试等环节都进行了阐述。 GitHub 代码：<a href="https://github.com/Python3WebSpider/DeepLearningSlideCaptcha" target="_blank" rel="noopener">https://github.com/Python3WebSpider/DeepLearningSlideCaptcha</a>。 欢迎 Star、Folk，如果遇到问题，可以在 GitHub Issue 留言。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-04-21 12:45:04" itemprop="dateCreated datePublished" datetime="2020-04-21T12:45:04+08:00">2020-04-21</time>
                </span>
                <span id="/9200.html" class="post-meta-item leancloud_visitors" data-flag-title="利用深度学习 PyTorch 识别滑动验证码缺口" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9160.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/9160.html" class="post-title-link" itemprop="url">LaGou招聘，整一下？</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><strong>声明</strong>：本文由一位知名的不知名Payne原创，转载请注明出处！ 首先说一下这个有啥用?要说有用也没啥用,要说没用吧，既然能拿到这些数据，拿来做数据分析。能有效的得到职位信息，薪资信息等。也能为找工作更加简单吧，且能够比较有选择性的相匹配的职位及公司 本章节源码仓库为：<a href="https://github.com/Payne-Wu/PythonScrape" target="_blank" rel="noopener">https://github.com/Payne-Wu/PythonScrape</a> 一言不合直接上代码！具体教程及思路总代码后！ 所用解释器为Python3.7.1，编辑器为Pycharm 2018.3.5. 本着虚心求学，孜孜不倦，逼逼赖赖来这里虚心求学，孜孜不倦，逼逼赖赖，不喜勿喷，嘴下手下脚下都请留情。 本节所涉：Request基本使用、Request高级使用-会话维持、Cookies、Ajax、JSON数据格式 Request更多详情请参考Request官方文档： <a href="http://2.python-requests.org/zh_CN/latest/user/quickstart.html" target="_blank" rel="noopener">轻松入门中文版</a> <a href="http://2.python-requests.org/zh_CN/latest/user/advanced.html#advanced" target="_blank" rel="noopener">高级使用中文版</a> Cookie：有时也用其复数形式 <a href="https://baike.baidu.com/item/Cookies/187064" target="_blank" rel="noopener">Cookies</a>。类型为“<strong>小型文本文件</strong>”，是某些网站为了辨别用户身份，进行<a href="https://baike.baidu.com/item/Session/479100" target="_blank" rel="noopener">Session</a>跟踪而储存在用户本地终端上的数据（通常经过加密），由用户<a href="https://baike.baidu.com/item/%E5%AE%A2%E6%88%B7%E7%AB%AF/101081" target="_blank" rel="noopener">客户端</a>计算机暂时或永久保存的信息 具体Cookies详情请参考：<a href="https://baike.baidu.com/item/cookie/1119?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/cookie/1119?fr=aladdin</a></p>
                  <p>Ajax 即“Asynchronous Javascript And XML”（异步 JavaScript 和 XML），是指一种创建交互式、快速动态<a href="https://baike.baidu.com/item/%E7%BD%91%E9%A1%B5/99347" target="_blank" rel="noopener">网页</a>应用的网页开发技术，无需重新加载整个网页的情况下，能够更新部分网页的技术。</p>
                  <p>通过在后台与服务器进行少量数据交换，Ajax 可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。</p>
                  <p><strong>JSON</strong>(JavaScript Object Notation)： 是一种轻量级的数据交换格式。 易于人阅读和编写。同时也易于机器解析和生成。 它基于<a href="http://www.crockford.com/javascript" target="_blank" rel="noopener">JavaScript Programming Language</a>, <a href="http://www.ecma-international.org/publications/files/ecma-st/ECMA-262.pdf" target="_blank" rel="noopener">Standard ECMA-262 3rd Edition - December 1999</a>的一个子集。 JSON采用<strong>完全独立于语言的文本格式</strong>，但是也使用了类似于C语言家族的习惯（包括C, C++, C#, Java, JavaScript, Perl, Python等）。 这些特性使JSON成为理想的数据交换语言。</p>
                  <p><em><strong>首先介绍一下关于本章代码的基本思路：</strong></em> <em><strong>四步走（发起请求、得到响应、解析响应得到数据、保存数据）</strong></em> <em><strong>四步中准确来说是三步，（发起请求，得到响应、解析响应，提取数据、保存数据）</strong></em></p>
                  <ul>
                    <li>
                      <h2 id="请求网页-在搜索框中输入所查询的岗位-lt-例如：Python-gt-，得到BASE-URL，"><a href="#请求网页-在搜索框中输入所查询的岗位-lt-例如：Python-gt-，得到BASE-URL，" class="headerlink" title="请求网页(在搜索框中输入所查询的岗位&lt;例如：Python&gt;，得到BASE_URL，)"></a>请求网页(在搜索框中输入所查询的岗位&lt;例如：Python&gt;，得到<a href="https://www.lagou.com/jobs/list_Python?labelWords=&amp;fromSearch=true&amp;suginput=" target="_blank" rel="noopener">BASE_URL</a>，)</h2>
                      <ul>
                        <li>BASE_URL:<a href="https://www.lagou.com/jobs/list_Python?labelWords=&amp;fromSearch=true&amp;suginput=" target="_blank" rel="noopener">https://www.lagou.com/jobs/list_Python?labelWords=&amp;fromSearch=true&amp;suginput=</a></li>
                        <li>加入请求头(注意加Cookies)，请求BASE_URL[gallery columns=”1” size=”full” ids=”9164”]</li>
                        <li>观察响应信息以及<a href="http://view-source:https://www.lagou.com/jobs/list_Python/p-city_0?&amp;cl=false&amp;fromSearch=true&amp;labelWords=&amp;suginput=">本网页源码</a>观察浏览器网页源码，对比发现其中并没有我们所需要的信息：发现Ajax的痕迹。<img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/NetworkPicture1.png" alt=""></li>
                        <li>经过一系列操作发现<a href="https://www.lagou.com/jobs/positionAjax.json?needAddtionalResult=false" target="_blank" rel="noopener">Ajax网页</a>地址(在这里直接请求此链接并不能访问)：<img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/NetworkPicture.png" alt=""></li>
                        <li>
                          <p>多次请求过后，发现错误。错误的缘由是由于Cookies限制，并且网页以动态检测，且时间间隔小。</p>
                          <ul>
                            <li>经过前言的学习，已经学会了。会话维持。动态得到Cookies，这样不就可以把这个“反爬”彻底绕过了呢？答案肯定是滴</li>
                            <li>
                              <p>哪让我们做一下会话维持，并动态提取Cookies吧。<img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/DemoPicture1.png" alt=""></p>
                            </li>
                            <li>
                              <p>易混淆点：cookies的维持为什么是维持BASE_URL的而不是Ajax_URL?下面按照个人理解对于本Ajax给出以下解释：结合Ajax原理可知，Ajax其基本原理就是在网页中插入异步触发的。说到底他还是在这个页面，并没有转到其他页面。只是需要特定条件触发即可插入本网页</p>
                              <ul>
                                <li>```<br>def Get_cookies(header):
                                  <pre><code>&quot;&quot;&quot;
Get cookies
@param header:
@return: cookies
&quot;&quot;&quot;
with requests.Session() as s:
    s.get(cookies_url, headers=header)
    cookies = s.cookies
# cookies = requests.get(cookies_url, headers=header).cookies
return cookies
</code></pre>
                                </li>
                              </ul>
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                  </ul>
                  <pre><code>            <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                  </td>
                  <td class="code">
                    <pre><span class="line"><span class="code">                </span></span><br><span class="line"><span class="bullet">        *   </span>万事俱备、只欠东风：请求Ajax_URL 即可得到以下![](https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/DemoPicture2-Ajax-1.png)</span><br><span class="line"><span class="bullet">        *   </span>得到响应:经过以上操作已经请求完成了。并能够保障请求稳定性。(当然在此并没有做异常捕获，如果加上，将会更稳)</span><br><span class="line"><span class="bullet">*   </span>## 解析响应：如果上述步骤没有错的话，到此已经能得到网页数据了（如上图）：</span><br><span class="line"><span class="code">    </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>*   我用的提取代码如下 ：</span><br></pre>
                  </td>
                  </tr>
                  </table>
                  </figure> def parse(message): industryField = message[&#39;industryField&#39;] # company_message positionName = message[&#39;positionName&#39;] companyFullName = message[&#39;companyFullName&#39;] companySize = message[&#39;companySize&#39;] financeStage = message[&#39;financeStage&#39;] # companyLabelList = message[&#39;companyLabelList&#39;] companyLabelList = &#39;|&#39;.join(message[&#39;companyLabelList&#39;]) Type = &quot;|&quot;.join([message[&#39;firstType&#39;], message[&#39;secondType&#39;], message[&#39;thirdType&#39;]]) Address = &#39;&#39;.join([message[&#39;city&#39;], message[&#39;district&#39;], ]) salary = message[&#39;salary&#39;] positionAdvantage = message[&#39;positionAdvantage&#39;] # limitation factor workYear = message[&#39;workYear&#39;] jobNature = message[&#39;jobNature&#39;] education = message[&#39;education&#39;] items = f&quot;{positionName}, {companyFullName}, {companySize}, {financeStage}, {companyLabelList}, {industryField}, &quot; \ f&quot;{Type}, {salary}, {jobNature}, {education}&quot; # items = &quot;&quot;.join(str( # [positionName, companyFullName, companySize, financeStage, companyLabelList, industryField, Type, salary, # jobNature, education])) if items: # print(items) logging.info(items) # return items.replace(&#39;[&#39;, &#39;&#39;).replace(&#39;]&#39;, &#39;&#39;) return items.replace(&#39;(&#39;, &#39;&#39;).replace(&#39;)&#39;, &#39;&#39;) <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">        </span><br><span class="line">    *   此时只需提取相关数据，即可。得到：![](https:<span class="comment">//qiniu.cuiqingcai.com/wp-content/uploads/2020/04/DemoPicture3-json.png)</span></span><br><span class="line">*   ## 保存数据：</span><br><span class="line">    </span><br><span class="line">    *   ## 常规保存：(保存到本地)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  </code></pre>
                  <p>def save_message(item):<br> with open(‘lg3.csv’, ‘a+’, encoding=’gbk’) as f:<br> f.write(item + ‘\n’)<br> thread_lock.release()</p>
                  <figure class="highlight markdown">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"></span><br><span class="line"><span class="bullet">*   </span>## 数据入库：（保存到数据库）</span><br><span class="line"><span class="code">    </span></span><br><span class="line"></span><br><span class="line"><span class="section">## 在这里我选择的为Mongo，接下来，那咱们操作一下吧。Mongo的安装便不在此处赘述。与mongo相关的文章，在这里比较推荐才哥和东哥的几篇文章(以本文来看，比较建议看看这几篇文章。并没说其他不好啊，不，我没有，我没说哦)，地址如下：</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">*   </span>### [<span class="string">如何学好 MongoDB</span>](<span class="link">https://cuiqingcai.com/7121.html</span>)</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="bullet">*   </span>### [<span class="string">[Python3网络爬虫开发实战</span>] 1.4.2-MongoDB安装](https://cuiqingcai.com/5205.html)</span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="bullet">*   </span>### [<span class="string">[Python3网络爬虫开发实战</span>] 1.5.2-PyMongo的安装](https://cuiqingcai.com/5230.html)</span><br><span class="line"><span class="code">    </span></span><br><span class="line"></span><br><span class="line"><span class="section">##   前方高能预警，造！！！：(此时的你已安装了Mongo，并能正常使用mongo。剩下的交给我，我教你好了)</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.  </span>### 安装pymongo</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <pre><code>pip install pymongo
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                  </td>
                  <td class="code">
                    <pre><span class="line">    </span><br><span class="line"><span class="number">2.</span>  ### 建立连接：在原有的代码基础上改写，添加类似于如下的代码：</span><br></pre>
                  </td>
                  </tr>
                  </table>
                  </figure> MONGO_CONNECTION_STRING = &#39;mongodb://localhost:27017&#39; # MONGO_DB_NAME = &#39;Jobs&#39; # MONGO_COLLECTION_NAME = &#39;Jobs&#39; client = pymongo.MongoClient(MONGO_CONNECTION_STRING) db = client[&#39;Jobs&#39;] collection = db[&#39;Jobs&#39;] <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">    </span><br><span class="line">    ![](https:<span class="comment">//qiniu.cuiqingcai.com/wp-content/uploads/2020/04/Annotation-2020-04-23-101932.png)</span></span><br><span class="line"><span class="number">3.</span>  ### 新增存储方法：</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure> def save_data(self, date): &quot;&quot;&quot; save to mongodb :param date: :return: &quot;&quot;&quot; collection.update_one({ &#39;name&#39;: date.get(&#39;companyShortName&#39;) }, { &#39;$set&#39;: date }, upsert=True) <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">    </span><br><span class="line">    ![](https:<span class="comment">//qiniu.cuiqingcai.com/wp-content/uploads/2020/04/微信图片_20200423102245.png)</span></span><br><span class="line"><span class="number">4.</span>  ### 调用此方法：</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure> def main(): p = LaGou() for page in range(1, 31): content = p.scrape(page) data = p.parseResponse(content) download = p.save_data(data) ``` </code></pre>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/微信图片_20200423102818.png" alt=""></p>
                  <h2 id="注意：由于mongo的存储格式为key-：value形式，所以咱们提取到的数据返回也必须是key-：value形式："><a href="#注意：由于mongo的存储格式为key-：value形式，所以咱们提取到的数据返回也必须是key-：value形式：" class="headerlink" title="注意：由于mongo的存储格式为key ：value形式，所以咱们提取到的数据返回也必须是key ：value形式："></a>注意：由于mongo的存储格式为key ：value形式，所以咱们提取到的数据返回也必须是key ：value形式：</h2>
                  <p>看我看我，怎么搞的，我是这样搞的：<img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/微信图片_20200423103526.png" alt=""></p>
                  <h2 id="左手叉腰，右手摇，Over！"><a href="#左手叉腰，右手摇，Over！" class="headerlink" title="左手叉腰，右手摇，Over！"></a>左手叉腰，右手摇，Over！</h2>
                  <p><img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/微信图片_20200423104337.png" alt=""> <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/04/微信图片_20200423104334.png" alt=""></p>
                  <h3 id="光看文章的话，就算是我自己写的文章单单仅仅看文章也是会云里雾里，建议与源码一起阅读。祝学习进步，心想事成。加油"><a href="#光看文章的话，就算是我自己写的文章单单仅仅看文章也是会云里雾里，建议与源码一起阅读。祝学习进步，心想事成。加油" class="headerlink" title="光看文章的话，就算是我自己写的文章单单仅仅看文章也是会云里雾里，建议与源码一起阅读。祝学习进步，心想事成。加油~"></a>光看文章的话，就算是我自己写的文章单单仅仅看文章也是会云里雾里，建议与源码一起阅读。祝学习进步，心想事成。加油~</h3>
                  <h2 id="写到最后：既然能读到这儿，那么我相信不是白嫖成为习惯的人，说明也或多或少想自己搞一搞。整一整？下次也出来吹吹牛皮，拉钩晓得不，反爬难吧？我会了（虽然对于大佬来说，都可能算不上反扒，和玩似的，这个确实也是的。不过吧，对于新手来说，已经算很难了。）我也是搞过拉勾的男人。找工作就找我，啊哈哈哈。"><a href="#写到最后：既然能读到这儿，那么我相信不是白嫖成为习惯的人，说明也或多或少想自己搞一搞。整一整？下次也出来吹吹牛皮，拉钩晓得不，反爬难吧？我会了（虽然对于大佬来说，都可能算不上反扒，和玩似的，这个确实也是的。不过吧，对于新手来说，已经算很难了。）我也是搞过拉勾的男人。找工作就找我，啊哈哈哈。" class="headerlink" title="写到最后：既然能读到这儿，那么我相信不是白嫖成为习惯的人，说明也或多或少想自己搞一搞。整一整？下次也出来吹吹牛皮，拉钩晓得不，反爬难吧？我会了（虽然对于大佬来说，都可能算不上反扒，和玩似的，这个确实也是的。不过吧，对于新手来说，已经算很难了。）我也是搞过拉勾的男人。找工作就找我，啊哈哈哈。"></a><strong>写到最后：既然能读到这儿，那么我相信不是白嫖成为习惯的人，说明也或多或少想自己搞一搞。整一整？下次也出来吹吹牛皮，拉钩晓得不，反爬难吧？我会了（虽然对于大佬来说，都可能算不上反扒，和玩似的，这个确实也是的。不过吧，对于新手来说，已经算很难了。）我也是搞过拉勾的男人。找工作就找我，啊哈哈哈。</strong></h2>
                  <p>单一的案例终究只会让你局限于本次案例，如果拉钩反爬又更新了。那么这个就会失效。虽然授之以渔了，但终究是“这条小溪”，更大的海洋还需要更加刻苦努力的学习。个人比较建议学习一下</p>
                  <ul>
                    <li>感谢阅读与支持，谢谢</li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-04-15 02:19:58" itemprop="dateCreated datePublished" datetime="2020-04-15T02:19:58+08:00">2020-04-15</time>
                </span>
                <span id="/9160.html" class="post-meta-item leancloud_visitors" data-flag-title="LaGou招聘，整一下？" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9142.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/9142.html" class="post-title-link" itemprop="url">meizi图会爬么？不会那我教你好了</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h1 id="meizi图会爬么？不会那我教你好了"><a href="#meizi图会爬么？不会那我教你好了" class="headerlink" title="meizi图会爬么？不会那我教你好了"></a>meizi图会爬么？不会那我教你好了</h1>
                  <p><strong>声明</strong>：本文由一位知名的不知名Payne原创，转载请注明出处！后优化代码为52讲轻松搞定网络爬虫第一次实战课程为本节代码思路为基础，后自作聪明，书写。 本章节源码仓库为：<a href="https://github.com/Payne-Wu/PythonScrape" target="_blank" rel="noopener">https://github.com/Payne-Wu/PythonScrape</a> 写在最前面：本章适用于新手小白，代码规范化思路。 一言不合直接上代码！具体教程及思路总代码后！ 所用解释器为Python3.7.1，编辑器为Pycharm 2018.3.5. 本着虚心求学，孜孜不倦，逼逼赖赖来这里虚心求学，孜孜不倦，逼逼赖赖，不喜勿喷，嘴下手下脚下都留情。</p>
                  <h1 id="基础源码（我刚自学Python时候写的代码）"><a href="#基础源码（我刚自学Python时候写的代码）" class="headerlink" title="基础源码（我刚自学Python时候写的代码）"></a>基础源码（我刚自学Python时候写的代码）</h1>
                  <p>要爬就爬全站的，一两张一两个还不如另存为来的更加实际。啊哈哈哈</p>
                  <ol>
                    <li>那咱们先来说说Meizitu的基本思路：</li>
                  </ol>
                  <p>个人总结（四步法）：发送请求，　得到响应，　解析数据，　保存数据（比较宏观的概念）</p>
                  <ul>
                    <li>众所周知啊（其实是个人理解）：爬虫本质为模拟浏览器发送请求 ，倒推过来思考 既然是模拟请求，请求地址(URI)总得晓得吧。那么本次请求的URI为以下（单个图册）：<ul>
                        <li>MAIN_URL：<a href="https://www.mzitu.com/" target="_blank" rel="noopener">https://www.mzitu.com/</a></li>
                        <li>Atlas URL：<a href="https://www.mzitu.com/226469" target="_blank" rel="noopener">https://www.mzitu.com/226469</a></li>
                        <li>Specific URL： <a href="https://www.mzitu.com/226469/1" target="_blank" rel="noopener">https://www.mzitu.com/226469/1</a></li>
                      </ul>
                    </li>
                    <li>
                      <p>模拟请求，既然是模拟请求怎么也得，模拟一下吧？被站长大大晓得了那不就被关在门外了。（站长“菇凉”说：“我家是给帅气的小哥哥用户访问的，你个程序来凑一凑不太好吧？”在我脑壳后面敲了敲，后就把我拒之门外，头也不会，扬长而去）经过我苦思冥想，仿佛得到了前所未有的启发，要不我们走走后门，让这个程序做个人？如此甚好。妙哉，妙哉。。。</p>
                      <ul>
                        <li>请求头一带谁都不爱。大叫一声还有谁，于是我就上啊。然而结果确实如此</li>
                        <li>
                          <p>```<br>url = ‘<a href="https://www.mzitu.com/" target="_blank" rel="noopener">https://www.mzitu.com/</a>‘<br>header =<br>{<br>“User-Agent”: “Mozilla/5.0 (Windows NT 10.0; WOW64; rv:66.0) Gecko/20100101 Firefox/66.0”<br>}</p>
                          <p>response = requests.get(url, headers=header) # 请求网页<br>print(response)</p>
                          <figure class="highlight pgsql">
                            <table>
                              <tr>
                                <td class="gutter">
                                  <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                </td>
                                <td class="code">
                                  <pre><span class="line">        </span><br><span class="line">        reponse&lt;<span class="number">200</span>&gt;</span><br><span class="line">    *   经过我请求，他回应，他回应了爱你你（<span class="number">200</span>），最后咱们握手了。菇凉，咱们还不够了解。需要多了解了解。我还没有成为无敌的男ying，我得多学习学习，争取早日娶你过门。（论一个渣男的锻炼与养成）</span><br><span class="line">    *   好不容易进来了，本着虚心求教，好好学习，天天向上，不谈儿女私情的我，怎么也得有所收获吧。这是？？？渣男的修炼养成计划？这是宝贝啊！！！我得看看，学习学习。</span><br><span class="line">    *   [gallery size="full" <span class="keyword">columns</span>="1" ids="9144"]</span><br><span class="line">    *   这还上锁啦？，这个可不香了。经过研究，一笑  你有你的的张良计，我有我的万能钥匙，Refer钥匙。配置Refer。走着。还不乖乖的。小意思啦。。。。就这样。</span><br><span class="line">    *   [gallery size="full" <span class="keyword">columns</span>="1" ids="9145"]</span><br><span class="line"></span><br><span class="line">虽然不是用的同一张图片，BUT，有无图片是这Refer防盗链作祟的。 **ok，nice。** 各位看官，到这儿咱们也得进入真正的 说了这么多，让我们进入造的环节把，基础四步走，发起请求，得到响应，解析数据，保存！打完收工。 首先咱们是定义了一个自定义的用户代理，优点稳定、简单易于操作，但缺点是比较繁琐。 为什么不用<span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent 这个主要还是因为这个模块不大稳定，我用的时候经常出错。不晓得是不是我。。。 至少我用的不太爽。而且既然自己阔以造轮子，为何不试着造一造呢？ 说说<span class="keyword">User</span>-Agent构造思路，首先是定义了一个<span class="keyword">User</span>-Agent列表,然后从里面随机取一，作为相对本次<span class="keyword">User</span>—Agent。 优化后的代码是直接定义了一个请求函数，这样如果需要请求是阔以直接调用这个函数，避免代码臃肿。无脑写requests。既不提升效率，也不简洁。还看着懵。有好的自然就要给好的，有时候对自己得好点。 注意请不要忽略异常捕获哦，这样会使咱们的爬虫小伙计更加健壮。爬虫的Strong在于考虑细致，全方面。这样成为一只成年的爬虫，虽然我也不晓得谁说的，我感觉还是蛮有道理的，如果真的没有人说，那就是我吧。。。。 这里是直接定义了一个请求方法，方便需要请求的时候直接调用。即可获得请求的效果</span><br></pre>
                                </td>
                              </tr>
                            </table>
                          </figure>
                          <p>def scrape_page(url):<br>logging.info(‘scraping %s…’, url)</p>
                          <h1 id="header-User-Agent-page"><a href="#header-User-Agent-page" class="headerlink" title="header = User_Agent(page)"></a>header = User_Agent(page)</h1>
                          <p>print(header)<br>try:<br>response = requests.get(url, headers=header)<br>return response.text<br>except TimeoutError as a:<br>logging.error(f”Error time is Out:{a}”)<br>except ReadTimeout as b:<br>logging.error(f”Error ReadTimeout: {b}”)<br>except HTTPError as c:<br>logging.error(f”Error HTTPError: {c}”)<br>except ConnectionError as d:<br>logging.error(f”Error ConnectionError: {d}”)</p>
                          <figure class="highlight plain">
                            <table>
                              <tr>
                                <td class="gutter">
                                  <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                </td>
                                <td class="code">
                                  <pre><span class="line"></span><br><span class="line"></span><br></pre>
                                </td>
                              </tr>
                            </table>
                          </figure>
                          <p>def scrape_index(page):<br>index_url = f”{BASE_URL}/page/{page}/“<br>return scrape_page(index_url)</p>
                        </li>
                      </ul>
                    </li>
                  </ul>
                  <p>2.1 解析数据（获得图册的URN）</p>
                  <p>def parse<em>index(html):<br> doc = pq(html)<br> links = doc(‘.postlist #pins &gt; li &gt; span:nth-child(2) &gt; a’)<br> for link in links.items():<br> detail<em>url = link.attr(‘href’)<br> logging.info(‘Got detail<em>url %s’, detail<em>url)<br> yield detail_url<br>def scrape_detail(url):<br> return scrape_page(url)<br>
                            <figure class="highlight vim">
                              <table>
                                <tr>
                                  <td class="gutter">
                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                  </td>
                                  <td class="code">
                                    <pre><span class="line"></span><br><span class="line">做个简单的小结： ```<span class="keyword">python</span> def main(page): User_Agent(page) index_html = scrape_index(page) detail_urls = parse_index(index_html) # 循环遍历提取出URI <span class="keyword">for</span> detail_url in detail_urls： 这样就可以得到所有的URI了： ... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">396</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">206355</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">703</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">212891</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">703</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">212891</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">863</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">225494</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">863</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">225494</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">992</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">226142</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">42</span>,<span class="number">992</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">226142</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">43</span>,<span class="number">172</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">226078</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">43</span>,<span class="number">173</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">226078</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">43</span>,<span class="number">661</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">210338</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">43</span>,<span class="number">661</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">210338</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">43</span>,<span class="number">838</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">225958</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">43</span>,<span class="number">839</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">225958</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">44</span>,<span class="number">003</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">225784</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">44</span>,<span class="number">004</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">225784</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">44</span>,<span class="number">163</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">218827</span> <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">44</span>,<span class="number">163</span> - INFO: scraping http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">218827</span>... <span class="number">2020</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">44</span>,<span class="number">402</span> - INFO: Got detail_url http<span class="variable">s:</span>//www.mzitu.<span class="keyword">com</span>/<span class="number">213225</span> ... 然后就没有然后了呗 经过发现每个图集里面是后面加上page就是第几张图片，并且张数是不一样的，那怎么样解决呢？ [gallery columns=<span class="string">"1"</span> size=<span class="string">"full"</span> ids=<span class="string">"9146"</span>] [gallery columns=<span class="string">"1"</span> size=<span class="string">"full"</span> ids=<span class="string">"9147"</span>] 多观察几个发现它只显示<span class="number">8</span>个，第七个就是最大的页码数了， 那咱们把他提取出来，作为图集的page，放入循环不就可以拿到任意图集的所有了嘛！经过验证这是可行的。 既然这些又有了，那咱们请求它，存就好啦</span><br></pre>
                                  </td>
                                </tr>
                              </table>
                            </figure><br>if __name
                          </em></em> == ‘__main</em></em>‘:<br>for page in range(1, 2):<br>main(page)<br>
                  <figure class="highlight plain">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"></span><br><span class="line">  最后加入多进程加快速度 改写源码如下</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure><br>import multiprocessing</p>
                  <h1 id="TOTAL-PAGE-为所爬取页数"><a href="#TOTAL-PAGE-为所爬取页数" class="headerlink" title="TOTAL_PAGE 为所爬取页数"></a>TOTAL_PAGE 为所爬取页数</h1>
                  <p>if <strong>name</strong> == ‘<strong>main</strong>‘:<br>pool = multiprocessing.Pool()<br>pages = range(1, TOTAL_PAGE + 1)<br>pool.map(main, pages)<br>pool.close()<br>```</p>
                  <p> <strong>写到最后： 能看到这里，我相信你是非常想学的，</strong>单单看到这里是不可能学会的了，那么如果要去做，阔以尝试着与本章源码一起阅读。希望你能有所收获。 如果想要更好的运用到实际生活中，以爬虫为兴趣，以此为工作。阔以学习崔老师的52讲轻松搞定网络爬虫。祝生活愉快，完事顺心。期待我们下次见面 有问题，有疑问，欢迎在评论区留言，我将知无言，言无不尽。评论区期待你的出现 -Payne</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-04-11 03:31:45" itemprop="dateCreated datePublished" datetime="2020-04-11T03:31:45+08:00">2020-04-11</time>
                </span>
                <span id="/9142.html" class="post-meta-item leancloud_visitors" data-flag-title="meizi图会爬么？不会那我教你好了" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.6k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9136.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/9136.html" class="post-title-link" itemprop="url">一行代码让网站变成灰色 CSS filter 的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>今天是 2020 年 4 月 4 日，星期六，清明节。 想必大家对今年发生的疫情有目共睹，很多英雄为了救助他人在病魔前倒下，更有很多烈士英雄保卫人民的安危遇难，今天全国下降半旗，北京时间 10 点全国默哀三分钟，来致敬英雄们。同时今天一切公共娱乐活动也都会停止，包括直播、综艺、影视、游戏等等。 我也在这里也向全国抗击新冠肺炎疫情斗争牺牲的烈士和逝世的同胞表达深切的哀悼，向所有在抗战在疫情前线的工作和医护人员致敬。</p>
                  <h2 id="网站变灰"><a href="#网站变灰" class="headerlink" title="网站变灰"></a>网站变灰</h2>
                  <p>今天大家可以看到很多很多网站包括主页和内容也都已经变成了灰色，比如百度、B 站、爱奇艺、CSDN 等等。 <img src="https://qiniu.cuiqingcai.com/2020-04-04-044643.png" alt="CSDN"> <img src="https://qiniu.cuiqingcai.com/2020-04-04-044651.png" alt="爱奇艺"> <img src="https://qiniu.cuiqingcai.com/2020-04-04-044830.png" alt="百度"> 大家可以看到全站的内容都变成灰色了，包括按钮、图片等等。这时候我们可能会好奇这是怎么做到的呢？ 有人会以为所有的内容都统一换了一个 CSS 样式，图片也全换成灰色的了，按钮等样式也统一换成了灰色样式。但你想想这个成本也太高了，而且万一某个控件忘记加灰色样式了岂不是太突兀了。 其实，解决方案很简单，只需要几行代码就能搞定了。</p>
                  <h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2>
                  <p>我们选择一个网站，比如 B 站吧，打开浏览器开发者工具。 审查一下网页的源代码，我们可以发现在 html 的这个地方多了一个疑似的 class，叫做 gray，gray 中文即灰色。 <img src="https://qiniu.cuiqingcai.com/2020-04-04-045630.png" alt="变灰效果"> 其 CSS 内容为：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">html</span><span class="selector-class">.gray</span> &#123;</span><br><span class="line">    <span class="attribute">-webkit-filter</span>: <span class="built_in">grayscale</span>(.<span class="number">95</span>);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们将其取消，就能发现网站的颜色就能重新还原回来了。 <img src="https://qiniu.cuiqingcai.com/2020-04-04-045725.png" alt="还原效果"> 果然是这个样式在起作用，而且是全局的效果，因为它是作用在了 html 这个节点之上的。 另外看看 CSDN，它也是用的这个 CSS 样式，其内容为：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">html</span> &#123;</span><br><span class="line">    <span class="attribute">-webkit-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">-moz-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">-ms-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">-o-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">filter</span>: progid:DXImageTransform.Microsoft.<span class="built_in">BasicImage</span>(grayscale=<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个实现看起来兼容性会更好一些。 因此我们可以确定，通过一个全局的 CSS 样式就能将整个网站变成灰色效果。</p>
                  <h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2>
                  <p>那么这里我们就来详细了解一下这究竟是一个什么样的 CSS 样式。 这个样式名叫做 filter，搜下 MDN 的官方介绍，其链接为：<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/filter" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/CSS/filter</a>。 官方介绍内容如下：</p>
                  <blockquote>
                    <p><strong><code>filter</code></strong> CSS 属性将模糊或颜色偏移等图形效果应用于元素。滤镜通常用于调整图像，背景和边框的渲染。 CSS 标准里包含了一些已实现预定义效果的函数。你也可以参考一个 SVG 滤镜，通过一个 URL 链接到 SVG 滤镜元素 (<a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/filter" target="_blank" rel="noopener">SVG filter element</a>)。</p>
                  </blockquote>
                  <p>其实就是一个滤镜的意思。 官方有一个 Demo，可以看下效果，如图所示。 <img src="https://qiniu.cuiqingcai.com/2020-04-04-052329.gif" alt="Demo"> 比如这里通过 filter 样式改变了图片、颜色、模糊、对比度等等信息。 其所有用法示例如下：</p>
                  <figure class="highlight scss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">/* URL to SVG filter */</span></span><br><span class="line"><span class="attribute">filter</span>: url(<span class="string">"filters.svg#filter-id"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &lt;filter-function&gt; values */</span></span><br><span class="line"><span class="attribute">filter</span>: blur(<span class="number">5px</span>);</span><br><span class="line"><span class="attribute">filter</span>: brightness(<span class="number">0.4</span>);</span><br><span class="line"><span class="attribute">filter</span>: contrast(<span class="number">200%</span>);</span><br><span class="line"><span class="attribute">filter</span>: drop-shadow(<span class="number">16px</span> <span class="number">16px</span> <span class="number">20px</span> blue);</span><br><span class="line"><span class="attribute">filter</span>: grayscale(<span class="number">50%</span>);</span><br><span class="line"><span class="attribute">filter</span>: hue-rotate(<span class="number">90deg</span>);</span><br><span class="line"><span class="attribute">filter</span>: invert(<span class="number">75%</span>);</span><br><span class="line"><span class="attribute">filter</span>: opacity(<span class="number">25%</span>);</span><br><span class="line"><span class="attribute">filter</span>: saturate(<span class="number">30%</span>);</span><br><span class="line"><span class="attribute">filter</span>: sepia(<span class="number">60%</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Multiple filters */</span></span><br><span class="line"><span class="attribute">filter</span>: contrast(<span class="number">175%</span>) brightness(<span class="number">3%</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global values */</span></span><br><span class="line"><span class="attribute">filter</span>: inherit;</span><br><span class="line"><span class="attribute">filter</span>: initial;</span><br><span class="line"><span class="attribute">filter</span>: unset;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>各个用法介绍大家可以参考官方的文档说明：<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/filter" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/CSS/filter</a> 比如这里如果我们可以使用 blur 设置高斯模糊，用法如下：</p>
                  <figure class="highlight isbl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">filter</span>: <span class="function"><span class="title">blur</span>(<span class="variable">radius</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>给图像设置高斯模糊。radius 一值设定高斯函数的标准差，或者是屏幕上以多少像素融在一起，所以值越大越模糊；如果没有设定值，则默认是 0；这个参数可设置绝对像素值，但不接受百分比值。 可以达成这样的效果： <img src="https://qiniu.cuiqingcai.com/2020-04-04-052851.png" alt="效果"> 再说回刚才的灰色图像，这里其实就是设置了 grayscale，其用法如下：</p>
                  <figure class="highlight isbl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">filter</span>: <span class="function"><span class="title">grayscale</span>(<span class="variable">percent</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>将图像转换为灰度图像。值定义转换的比例。percent 值为 100% 则完全转为灰度图像，值为 0% 图像无变化。值在 0% 到 100% 之间，则是效果的线性乘子。若未设置，值默认是 0。另外除了传递百分比，还可以传递浮点数，效果是一样的。 如：</p>
                  <figure class="highlight mel">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">filter</span>: grayscale(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">filter</span>: grayscale(<span class="number">100</span>%)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>都可以将节点转化为 100% 的灰度模式。 所以一切到这里就清楚了，如果我们想要把全站变成灰色，再考虑到各浏览器兼容写法，可以参考下 CSDN 的写法：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-class">.gray</span> &#123;</span><br><span class="line">    <span class="attribute">-webkit-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">-moz-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">-ms-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">-o-filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">filter</span>: <span class="built_in">grayscale</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">filter</span>: progid:DXImageTransform.Microsoft.<span class="built_in">BasicImage</span>(grayscale=<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样想要变灰的节点只需要加上 gray 这个 class 就好了，比如加到 html 节点上就可以全站变灰了。 最后呢，看一下浏览器对 filter 这个样式的兼容性怎样，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-04-04-053339.png" alt="兼容性"> 这里我们看到，这里除了 IE，其他的 PC、手机端的浏览器都支持了，Firefox 的 PC、安卓端还单独对 SVG 图像加了支持，可以放心使用。</p>
                  <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
                  <p>本篇文章简单介绍了一下今天观察到的网站变灰的实现，也学习了 filter 的更详细的用法，希望有帮助。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-04-09 15:03:09" itemprop="dateCreated datePublished" datetime="2020-04-09T15:03:09+08:00">2020-04-09</time>
                </span>
                <span id="/9136.html" class="post-meta-item leancloud_visitors" data-flag-title="一行代码让网站变成灰色 CSS filter 的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9134.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/9134.html" class="post-title-link" itemprop="url">Python 中异常处理库 merry 的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>写程序时，异常处理是在所难免的，但你有没有考虑过怎样让异常处理机制变得扩展性更好，让写法更优雅呢？</p>
                  <h2 id="实例引入"><a href="#实例引入" class="headerlink" title="实例引入"></a>实例引入</h2>
                  <p>比如写 Python 的时候，举个最简单的算术运算和文件写入的例子，代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def <span class="built_in">process</span>(num1, num2, <span class="built_in">file</span>):</span><br><span class="line">    <span class="built_in">result</span> = num1 / num2</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="built_in">file</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.<span class="built_in">write</span>(str(<span class="built_in">result</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们定义了一个 process 方法，接收三个参数，前两个参数是 num1 和 num2，第三个参数是 file。这个方法会首先将 num1 除以 num2，然后把除法的结果写入到 file 文件里面。 好，就这么一个简单的操作，但是这个实现真的是漏洞百出：</p>
                  <ul>
                    <li>没有判断 num1、num2 的类型，如果不是数字类型，那会抛出 TypeError。</li>
                    <li>没有判断 num2 是不是 0，如果是 0，那么会抛出 ZeroDivisionError。</li>
                    <li>没有判断文件路径是否存在，如果是子文件夹下的路径，文件夹不存在的话，会抛出 FileNotFoundError。</li>
                  </ul>
                  <p>一些异常测试用例如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="title">process</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>, <span class="string">'result/result.txt'</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">process</span><span class="params">(<span class="number">1</span>, <span class="number">0</span>, <span class="string">'result.txt'</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">process</span><span class="params">(<span class="number">1</span>, [<span class="number">2</span>], <span class="string">'result.txt'</span>)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这些用例跑起来一定是会报错的。如果面试写出来这个代码，肯定就挂了。 当然最好的方式是通过一些判断条件把一些该处理的问题和判定都加上。 但这里我们为了说异常处理，如果把这几类的错误都进行异常处理的话，会写成什么样子呢？ 由于 Python 的语法是有缩进的，所以我们可能会首先将这些代码缩进四个空格，然后外面包上一个 try 和 except，可能写成这个样子：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(num1, num2, file)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = num1 / num2</span><br><span class="line">        <span class="keyword">with</span> open(file, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(str(result))</span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;num2&#125;</span> can not be zero'</span>)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        print(<span class="string">f'file <span class="subst">&#123;file&#125;</span> not found'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f'exception, <span class="subst">&#123;e.args&#125;</span>'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时候我们观察到了什么问题？</p>
                  <ul>
                    <li>代码一下子臃肿了起来，这里的异常处理都没有实现，仅仅是 print 了一些错误信息，但现在可以看到我们的异常处理代码可能比主逻辑还要多。</li>
                    <li>主逻辑代码整块被硬生生地缩进进去了，如果主逻辑代码比较多的话，那么会有大片大片的缩进。</li>
                    <li>如果再有相同的逻辑的代码，难道要再写一次 try except 这一坨代码吗？</li>
                  </ul>
                  <p>可能很多人都在面临这样的困扰，觉得代码很难看但又不知道怎么修改。 当然上面的代码写法本身就不好，有几种改善的方案：</p>
                  <ul>
                    <li>本身这个场景不需要这么多异常处理，使用判断条件把一些意外情况处理掉就好。</li>
                    <li>异常处理本身就不应该这么写，每个功能区域应该和异常处理单独分开，另外各个逻辑模块建议再分方法解耦。</li>
                    <li>使用 retrying 模块检测异常并进行重试。</li>
                    <li>使用上下文管理器 raise_api_error 来声明异常处理。</li>
                  </ul>
                  <p>但上面的一些解决方案其实还不能彻底解决代码复用和美观上的问题，比如某一类的异常处理我就统一在一个地方处理，另外我的任何代码都不想因为异常处理产生缩进。 那对于这样的问题，有没有解决方案呢？有。 下面我们来了解一个库，叫做 Merry。</p>
                  <h2 id="Merry"><a href="#Merry" class="headerlink" title="Merry"></a>Merry</h2>
                  <p>Merry，这个库是 Python 的一个第三方库，非常小巧，它实现了几个装饰器。通过使用 Merry 我们可以把异常检查和异常处理的代码分开，并可以通过装饰器来定义异常检查和处理的逻辑。 GitHub 地址：<a href="https://github.com/miguelgrinberg/merry，这个库的安装非常简单，使用" target="_blank" rel="noopener">https://github.com/miguelgrinberg/merry，这个库的安装非常简单，使用</a> pip3 安装即可：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> merry</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>有了这个库之后，上面的异常检查代码我们就可以这么来实现了，代码如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> merry <span class="keyword">import</span> Merry</span><br><span class="line"></span><br><span class="line">merry = Merry()</span><br><span class="line">merry.logger.disabled = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@merry._try</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(num1, num2, file)</span>:</span></span><br><span class="line">    result = num1 / num2</span><br><span class="line">    <span class="keyword">with</span> open(file, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(str(result))</span><br><span class="line"></span><br><span class="line"><span class="meta">@merry._except(ZeroDivisionError)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_zero_division_error</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(<span class="string">'zero_division_error'</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="meta">@merry._except(FileNotFoundError)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_file_not_found_error</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(<span class="string">'file_not_found_error'</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="meta">@merry._except(Exception)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(<span class="string">'exception'</span>, type(e), e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    process(<span class="number">1</span>, <span class="number">2</span>, <span class="string">'result/result.txt'</span>)</span><br><span class="line">    process(<span class="number">1</span>, <span class="number">0</span>, <span class="string">'result.txt'</span>)</span><br><span class="line">    process(<span class="number">1</span>, <span class="number">2</span>, <span class="string">'result.txt'</span>)</span><br><span class="line">    process(<span class="number">1</span>, [<span class="number">1</span>], <span class="string">'result.txt'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们可以看到，我们首先声明了一个 Merry 对象，然后 process 方法加上 merry 对象的 _try 方法的装饰器，这样就实现了异常的监听。 有了异常监听之后，怎么来进行异常处理呢？还是通过同一个 merry 对象，使用其 _except 方法作为装饰器即可。比如这里我们将几个异常处理方法分开了，如处理 ZeroDivisionError、FileNotFoundError、Exception 等异常分别都有一个方法的声明，分别加上对应的装饰器即可。 这样的话，我们就轻松实现了异常监听和处理了。 和上面比有什么不同呢？</p>
                  <ul>
                    <li>主逻辑里面不用额外加异常处理代码了，显得简洁。</li>
                    <li>主逻辑不用因为 try except 而缩进了。</li>
                    <li>每个异常处理方法单独分开了，可以实现解耦和重用。</li>
                  </ul>
                  <p>整个实现就舒服多了。 运行一下上面的代码，输出结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">file_not_found_error [Errno <span class="number">2</span>] No such file <span class="keyword">or</span> directory: <span class="string">'result/result.txt'</span></span><br><span class="line">zero_division_error division by zero</span><br><span class="line">exception &lt;<span class="keyword">class</span> '<span class="symbol">TypeError</span>'&gt; <span class="symbol">unsupported</span> <span class="symbol">operand</span> <span class="symbol">type</span>(<span class="symbol">s</span>) <span class="symbol">for</span> /: '<span class="symbol">int</span>' <span class="symbol">and</span> '<span class="symbol">list</span>'</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>完全没问题，可以看到每个异常都被正常地捕获到了。 舒服，代码变得更优雅了。</p>
                  <h2 id="类实现"><a href="#类实现" class="headerlink" title="类实现"></a>类实现</h2>
                  <p>虽然上面的实现相比最初已经好了很多了，但是整个看起来结构比较松散，代码不好复用，能不能把它封装成一个类来实现呢？ 如果封装好了类之后，我们就可以直接把类拿过来使用，实现的时候继承这个类，就不用再关心各个异常处理是怎么实现的了。 在这里一个简单的实现如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> merry <span class="keyword">import</span> Merry</span><br><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> ConnectTimeout</span><br><span class="line"></span><br><span class="line">merry = Merry()</span><br><span class="line">merry.logger.disabled = <span class="literal">True</span></span><br><span class="line">catch = merry._try</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @merry._except(ZeroDivisionError)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_zero_division_error</span><span class="params">(e)</span>:</span></span><br><span class="line">        print(<span class="string">'zero_division_error'</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @merry._except(FileNotFoundError)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_file_not_found_error</span><span class="params">(e)</span>:</span></span><br><span class="line">        print(<span class="string">'file_not_found_error'</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @merry._except(Exception)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(e)</span>:</span></span><br><span class="line">        print(<span class="string">'exception'</span>, type(e), e)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @merry._except(ConnectTimeout)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_connect_timeout</span><span class="params">(e)</span>:</span></span><br><span class="line">        print(<span class="string">'connect_timeout'</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calculator</span><span class="params">(BaseClass)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, num1, num2, file)</span>:</span></span><br><span class="line">        result = num1 / num2</span><br><span class="line">        <span class="keyword">with</span> open(file, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(str(result))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fetcher</span><span class="params">(BaseClass)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        response = requests.get(url, timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            print(response.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    c = Calculator()</span><br><span class="line">    c.process(<span class="number">1</span>, <span class="number">0</span>, <span class="string">'result.txt'</span>)</span><br><span class="line"></span><br><span class="line">    f = Fetcher()</span><br><span class="line">    f.process(<span class="string">'http://notfound.com'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们看到，我们先实现了一个 BaseClass，里面通过 merry 定义了好多个异常处理方法和处理流程，异常处理方法定义成 staticmethod。 接着我们定义了两个类，一个是 Calculator，一个是 Fetcher，分别完成不同的功能，一个是计算，一个是抓取网页。另外 Merry 的 _try 方法我们给它取了个别名，比如叫做 catch，显得更简洁。 在 process 方法中，我们我们想要进行异常处理，那么就加上 @catch 这装饰器就好了，其他的不需要管。 这样，我们在实现子类的时候，只需要集成 BaseClass 然后实现对应的方法就好了，如果想加上异常处理就加个装饰器，也无需再关心 Merry 的具体实现，父类都帮我们实现好了，这样就方便多了。 运行结果如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">zero_division_error division by zero</span><br><span class="line">connect_timeout <span class="constructor">HTTPConnectionPool(<span class="params">host</span>='<span class="params">notfound</span>.<span class="params">com</span>', <span class="params">port</span>=80)</span>: Max retries exceeded <span class="keyword">with</span> url:<span class="operator"> / </span>(Caused by <span class="constructor">ConnectTimeoutError(&lt;<span class="params">urllib3</span>.<span class="params">connection</span>.HTTPConnection <span class="params">object</span> <span class="params">at</span> 0x10d5b9310&gt;, 'Connection <span class="params">to</span> <span class="params">notfound</span>.<span class="params">com</span> <span class="params">timed</span> <span class="params">out</span>. (<span class="params">connect</span> <span class="params">timeout</span>=1)</span>'))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行之后我们发现也正常输出了对应的错误信息。</p>
                  <h2 id="数据传递"><a href="#数据传递" class="headerlink" title="数据传递"></a>数据传递</h2>
                  <p>有人会问了，利用 try except 我们可以直接获取异常代码的变量信息，分了方法之后，一些上下文的变量不就拿不到了吗？ 这的确是个问题，Merry 是用了一个全局的变量来解决的，它使用了 merry.g 这个对象来存储上下文的变量，在 主逻辑方法里面要把想要传递的参数赋值进去，在异常处理的方法里面再用 merry.g 取出来，官方示例写法如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">@merry._try</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app_logic</span><span class="params">()</span>:</span></span><br><span class="line">    db = open_database()</span><br><span class="line">    merry.g.database = db  <span class="comment"># save it in the error context just in case</span></span><br><span class="line">    <span class="comment"># do database stuff here</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@merry._except(Exception)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">catch_all</span><span class="params">()</span>:</span></span><br><span class="line">    db = getattr(merry.g, <span class="string">'database'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> is_database_open(db):</span><br><span class="line">        close_database(db)</span><br><span class="line">    print(<span class="string">'Unexpected error, quitting'</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>但我个人觉得这个写法很鸡肋，我个人觉得应该能获取主逻辑方法里面的 context 对象，context 里面包含了主逻辑方法里面的变量状态，然后异常处理的方法的某个参数可以接收到这个 context 对象，就能直接获取变量值了。 不过这只是个个人想法，还没有实现，有兴趣的朋友可以试试。</p>
                  <h2 id="源码剖析"><a href="#源码剖析" class="headerlink" title="源码剖析"></a>源码剖析</h2>
                  <p>最后，我们来看看它的源码吧，其实源码就这么多：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">getargspec = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> getattr(inspect, <span class="string">'getfullargspec'</span>, <span class="literal">None</span>):</span><br><span class="line">    getargspec = inspect.getfullargspec</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># this one is deprecated in Python 3, but available in Python 2</span></span><br><span class="line">    getargspec = inspect.getargspec</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Namespace</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Merry</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, logger_name=<span class="string">'merry'</span>, debug=False)</span>:</span></span><br><span class="line">        self.logger = logging.getLogger(logger_name)</span><br><span class="line">        self.g = _Namespace()</span><br><span class="line">        self.debug = debug</span><br><span class="line">        self.except_ = &#123;&#125;</span><br><span class="line">        self.force_debug = []</span><br><span class="line">        self.force_handle = []</span><br><span class="line">        self.else_ = <span class="literal">None</span></span><br><span class="line">        self.finally_ = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_try</span><span class="params">(self, f)</span>:</span></span><br><span class="line"><span class="meta">        @wraps(f)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            ret = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ret = f(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># note that if the function returned something, the else clause</span></span><br><span class="line">                <span class="comment"># will be skipped. This is a similar behavior to a normal</span></span><br><span class="line">                <span class="comment"># try/except/else block.</span></span><br><span class="line">                <span class="keyword">if</span> ret <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">return</span> ret</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># find the best handler for this exception</span></span><br><span class="line">                handler = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> self.except_.keys():</span><br><span class="line">                    <span class="keyword">if</span> isinstance(e, c):</span><br><span class="line">                        <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> issubclass(c, handler):</span><br><span class="line">                            handler = c</span><br><span class="line"></span><br><span class="line">                <span class="comment"># if we don't have any handler, we let the exception bubble up</span></span><br><span class="line">                <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">                <span class="comment"># log exception</span></span><br><span class="line">                self.logger.exception(<span class="string">'[merry] Exception caught'</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># if in debug mode, then bubble up to let a debugger handle</span></span><br><span class="line">                debug = self.debug</span><br><span class="line">                <span class="keyword">if</span> handler <span class="keyword">in</span> self.force_debug:</span><br><span class="line">                    debug = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">elif</span> handler <span class="keyword">in</span> self.force_handle:</span><br><span class="line">                    debug = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> debug:</span><br><span class="line">                    <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">                <span class="comment"># invoke handler</span></span><br><span class="line">                <span class="keyword">if</span> len(getargspec(self.except_[handler])[<span class="number">0</span>]) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> self.except_[handler]()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> self.except_[handler](e)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># if we have an else handler, call it now</span></span><br><span class="line">                <span class="keyword">if</span> self.else_ <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">return</span> self.else_()</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="comment"># if we have a finally handler, call it now</span></span><br><span class="line">                <span class="keyword">if</span> self.finally_ <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    alt_ret = self.finally_()</span><br><span class="line">                    <span class="keyword">if</span> alt_ret <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        ret = alt_ret</span><br><span class="line">                    <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_except</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line">            <span class="keyword">for</span> e <span class="keyword">in</span> args:</span><br><span class="line">                self.except_[e] = f</span><br><span class="line">            d = kwargs.get(<span class="string">'debug'</span>, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> d:</span><br><span class="line">                self.force_debug.append(e)</span><br><span class="line">            <span class="keyword">elif</span> d <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self.force_handle.append(e)</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_else</span><span class="params">(self, f)</span>:</span></span><br><span class="line">        self.else_ = f</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_finally</span><span class="params">(self, f)</span>:</span></span><br><span class="line">        self.finally_ = f</span><br><span class="line">        <span class="keyword">return</span> f</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里最主要的逻辑都在 _try 方法里面了，它主要做了什么事呢？其实就是仿照这标准的 try、except、else、finally 方法把流程实现下来了，只不过在对应的逻辑区块里面调用了装饰器修饰的方法。 其中有一个地方比较有意思：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">handler</span> = <span class="keyword">None</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> self.except_.keys():</span><br><span class="line">    <span class="keyword">if</span> isinstance(e, c):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">handler</span> <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> issubclass(c, <span class="keyword">handler</span>):</span><br><span class="line">            <span class="keyword">handler</span> = c</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里是为异常处理找寻一个最佳的异常处理方法，可以看到这里通过各个 _except 修饰的方法，然后通过 issubclass 方法来找寻最小能处理的子类，最终找到最佳匹配方法，实现有点妙。 好了，本节整体介绍了 Merry 这个库的基本使用，利用它我们可以使得 Python 的异常处理变得更优雅可扩展，来试试吧。 更多的用法可以看官方的说明 <a href="https://github.com/miguelgrinberg/merry" target="_blank" rel="noopener">https://github.com/miguelgrinberg/merry</a> 或者源码，谢谢。 希望对大家有帮助。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-04-09 15:01:25" itemprop="dateCreated datePublished" datetime="2020-04-09T15:01:25+08:00">2020-04-09</time>
                </span>
                <span id="/9134.html" class="post-meta-item leancloud_visitors" data-flag-title="Python 中异常处理库 merry 的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9132.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/9132.html" class="post-title-link" itemprop="url">利用 PyCharm 实现本地代码和远端的实时同步</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>我们知道在国内使用 Docker，无论是 Pull、Build 还是 Push 镜像都十分慢，因为毕竟很多源都是国外的源，下载和上传慢是必然的现象。 最近我在写的项目都是用 Docker 运行起来的，在测试的时候，我可能需要先 Build 一下然后跑起来测试下逻辑有没有问题。 在我自己本地机器上构建就有这么几个问题，一个问题当然就是速度慢，我用的肯定是国内的上网线路，有时候用个新镜像，半天 Pull 不下来，而且有的镜像是一些私有镜像，不好弄加速器，有的公开镜像试了几个加速器效果也不理想。另外一个问题当 Build 镜像的时候，如果涉及到一些编译的过程，就会占用我的本地机器的 CPU 资源，有时候搞得还挺卡。 所以，我干嘛不把这些 Build 的过程挪到服务器上来搞呢？如果我有一台国外的服务器，还能解决速度问题，另外还不会占用我本地机器的 CPU 资源。 但问题是，我要在自己机器上写代码呀，编译和运行又在远端，那代码怎么同步到远端呢？ 那么本节就来介绍下一种本地代码实时同步远程服务器的方法吧。 其实这个功能我用了好久了，但之前一直用起来感觉略鸡肋，因为免不了的还需要在远端配置一下运行环境才能跑，不过后来切到 Docker 运行的话，就舒服多了。如果大家用 Docker 运行项目的话，推荐大家可以试下。</p>
                  <h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2>
                  <p>在这开始之前要求有一台远程 Linux 服务器，安装好 Docker 即可。另外当然还需要能 SSH 远程访问，这是必须的。另外如果是海外的服务器是最好的了，构建镜像速度会更快。 另外这里我是用 PyCharm 实现的远程同步功能，如果大家写 Python 多的话当然是推荐 PyCharm。不过其他的 JetBrains IDE 也基本都带着这个功能，所以如果用其他的 JetBrains IDE 也是 OK 的。注意，这里必须要用的是专业版，只有专业版才有这个功能。</p>
                  <h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2>
                  <p>好，我们要实现的是本地代码实时同步服务器的功能。利用 PyCharm 自带的组件我们轻松实现这个功能。 PyCharm 有一个 SFTP 部署模块，可以帮助我们把本地的代码实时同步到远端。 好，首先 PyCharm 打开任意一个项目，在这里我就以自己的项目为例了。 <img src="https://qiniu.cuiqingcai.com/2020-03-20-133718.png" alt="项目预览"> 接着我们点击 PyCharm 的 Tools -&gt; Deployment -&gt; Configuration，这里我们可以配置远程 SFTP 服务器，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133741.png" alt="配置"> 打开之后是这样子，这里选择 SFTP，然后填入服务器的连接信息，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133749.png" alt="配置信息"> 在这里可以点「TEST CONNECTION」测试下是否能够连接成功。 OK，配置完了之后，我们已经成功添加好了一台远程服务器了，比如我这里就添加了一台我自己的服务器，Host 为 vm1.cuiqingcai.com。 既然要实现本地和服务器文件同步，那么当然必须要指定本地项目文件夹和远程哪个文件夹同步吧。在哪里指定呢？切换到第二个选项卡，Mappings，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133811.png" alt="Mappings"> 这里我们可以通过选择 LocalPath 和 Deployment Path 分别指定本地和远程的文件夹名称。注意这里后者指的是相对服务器工作目录的路径。 好了，就是这样，基本配置就完成了。如果你还想配置某些路径不同步的话，还可以在第三个选项卡 Excluded Paths 里面配置。 接着，还有一些可以配置的地方，点击 Tools -&gt; Deployment -&gt; Options 我们可以配置更多细节，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133832.png" alt="细节配置"> 比如这里我就配置了下什么时候上传，这里我改成了按 Ctrl + S 保存的时候再上传，这样我可以自由控制上传的时机。 另外这里还需要把自动上传勾选上，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133841.png" alt="自动上传"> 好了，整个都配置好啦。</p>
                  <h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2>
                  <p>接下来我们上传下试试吧，可以点菜单里面的 Upload to 选项来上传代码。 点击上传之后，PyCharm 会单独开一个 File Transfer 窗口来显示文件上传的结果，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133910.png" alt="上传结果"> 这样就上传完毕了。 接着我们任意修改一个文件，按保存，即 Ctrl + S，这里就出现了自动上传的日志，提示某个文件被上传成功了。 <img src="https://qiniu.cuiqingcai.com/2020-03-20-133921.png" alt="自动上传测试"> OK，验证没问题。</p>
                  <h2 id="远程-SSH"><a href="#远程-SSH" class="headerlink" title="远程 SSH"></a>远程 SSH</h2>
                  <p>当然 PyCharm 还提供了远程 SSH Termial 的功能，直接点选 Tools -&gt; Start SSH Session 即可，如图所示： <img src="https://qiniu.cuiqingcai.com/2020-03-20-133932.png" alt="远程 SSH"> 点了之后就会提示选择哪个远程服务器，选了之后，下方 Terminal 就弹出来了，和普通的 SSH Shell 一模一样。 <img src="https://qiniu.cuiqingcai.com/2020-03-20-133953.png" alt="SSH Terminal"> OK，接下来要构建镜像，我只需要运行对应的 docker-compose 命令就好了，速度瞬间就上来了，我再也不用看着龟速的下拉速度而发愁了，而不用担心本地机器的资源消耗了。 <img src="https://qiniu.cuiqingcai.com/2020-03-20-134032.png" alt="构建过程"> OK，美滋滋。 构建完了运行之后，直接远程访问就好了。</p>
                  <blockquote>
                    <p>注意：这里记得把服务器的安全组限制打开，以免出现远程端口无法访问的问题。</p>
                  </blockquote>
                  <p>好，以上就是利用 PyCharm 实现代码实时远程同步的方法，大家也来试试吧。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-04-09 14:59:53" itemprop="dateCreated datePublished" datetime="2020-04-09T14:59:53+08:00">2020-04-09</time>
                </span>
                <span id="/9132.html" class="post-meta-item leancloud_visitors" data-flag-title="利用 PyCharm 实现本地代码和远端的实时同步" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9077.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/9077.html" class="post-title-link" itemprop="url">推荐一些实用的的 Python 库</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>一门语言好用、方便的程度在很多时候会取决于这门语言相关的库够不够丰富，Python 之所以火爆除了其本身的语法和特性之外，还在一定程度上取决于其有太多太多库的支持，不论是官方维护的还是第三方开发的。就比如说做机器学习为什么很多人都用 Python，一个非常大的因素就是 TensorFlow 和 PyTorch 对 Python 的支持。当然在这里并不是说 Python 的库真的就全的不要不要的，它在某些领域或者项目的生态还是有待完善的。 正好昨天刷到知乎一个问题「你见过哪些相见恨晚的 Python 库？」，其意就是想了解下有哪些非常好用的提高生产力的 Python 库。一些回答直接把 awesome-python 贴过来，点赞非常多，当然多归多，但是里面很多都是些过期的或者其实没太有什么价值的库，反而会增加了挑选库的成本。我大体上把一些回答过了一遍，另外结合自己平时了解的内容，稍微对一些基础生产力库做了简单的梳理，在这里分享给大家。 所以这里就不再针对于一些特殊的场景推荐了，如一些 Web开发库、网络请求库、数据操作库、数据分析库、机器分析库等等。下面主要罗列一些适用范围和方向较广，对于一些基础设施的建设比较有用，能在多数场景下提高 Python 生产力的库，描述比较简单，主要是提供一个列表，仅供参考哈。</p>
                  <h3 id="attrs、cattrs"><a href="#attrs、cattrs" class="headerlink" title="attrs、cattrs"></a>attrs、cattrs</h3>
                  <p>GitHub：<a href="https://github.com/python-attrs/attrs、https://github.com/Tinche/cattrs" target="_blank" rel="noopener">https://github.com/python-attrs/attrs、https://github.com/Tinche/cattrs</a> 简化类的定义、序列化反序列化等操作。 个人写的简介：<a href="https://mp.weixin.qq.com/s/oHK-Y4lOeaQCFtDWgqXxFA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/oHK-Y4lOeaQCFtDWgqXxFA</a></p>
                  <h3 id="loguru"><a href="#loguru" class="headerlink" title="loguru"></a>loguru</h3>
                  <p>GitHub：<a href="https://github.com/Delgan/loguru" target="_blank" rel="noopener">https://github.com/Delgan/loguru</a> 可简化日志记录写法。 个人写的简介：<a href="https://mp.weixin.qq.com/s/5Ri1WS5cTGCNAQ0I_zYycg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/5Ri1WS5cTGCNAQ0I_zYycg</a></p>
                  <h3 id="autopep8"><a href="#autopep8" class="headerlink" title="autopep8"></a>autopep8</h3>
                  <p>GitHub：<a href="https://github.com/hhatto/autopep8" target="_blank" rel="noopener">https://github.com/hhatto/autopep8</a> 把 Python 代码转成符合 PEP8 规范的代码。</p>
                  <h3 id="psutil"><a href="#psutil" class="headerlink" title="psutil"></a>psutil</h3>
                  <p>GitHub：<a href="https://github.com/giampaolo/psutil" target="_blank" rel="noopener">https://github.com/giampaolo/psutil</a> Python 实现任务监控的库。</p>
                  <h3 id="furl"><a href="#furl" class="headerlink" title="furl"></a>furl</h3>
                  <p>GitHub：<a href="https://github.com/gruns/furl" target="_blank" rel="noopener">https://github.com/gruns/furl</a> 对 url 的处理非常方便，比 urllib 等库好用多。</p>
                  <h3 id="retrying、tenacity"><a href="#retrying、tenacity" class="headerlink" title="retrying、tenacity"></a>retrying、tenacity</h3>
                  <p>GitHub：<a href="https://github.com/rholder/retrying、https://github.com/jd/tenacity" target="_blank" rel="noopener">https://github.com/rholder/retrying、https://github.com/jd/tenacity</a> 异常重试库，如出错之后重试多少次，尤其在发起一些 HTTP 请求时非常有用，当然也能用于其他地方。</p>
                  <h3 id="typing"><a href="#typing" class="headerlink" title="typing"></a>typing</h3>
                  <p>Docs：<a href="https://docs.python.org/zh-cn/3/library/typing.html#module-typing" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3/library/typing.html#module-typing</a> 对 Python 类型的支持，支持多种类型、嵌套类型，也推荐多多使用 Python 的类型注解。</p>
                  <h3 id="argparse"><a href="#argparse" class="headerlink" title="argparse"></a>argparse</h3>
                  <p>Docs：<a href="https://docs.python.org/zh-cn/3/library/argparse.html" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3/library/argparse.html</a> 个人曾经使用过几个命令行解析工具，如 docopt，但后来还是转回来了 argparse，功能齐全强大。</p>
                  <h3 id="absl-py"><a href="#absl-py" class="headerlink" title="absl-py"></a>absl-py</h3>
                  <p>GitHub：<a href="https://github.com/abseil/abseil-py" target="_blank" rel="noopener">https://github.com/abseil/abseil-py</a> 个人感觉比 argparse 更易用的库，如 TensorFlow 就在使用这个，对于定义一些 Flag 非常方便。</p>
                  <h3 id="pipenv"><a href="#pipenv" class="headerlink" title="pipenv"></a>pipenv</h3>
                  <p>GitHub：<a href="https://github.com/pypa/pipenv" target="_blank" rel="noopener">https://github.com/pypa/pipenv</a> 功能更全的包管理工具，集成虚拟环境、支持 Lock 机制锁定安装包版本和依赖信息。当然也有坑点，可自行搜索。</p>
                  <h3 id="drf"><a href="#drf" class="headerlink" title="drf"></a>drf</h3>
                  <p>Docs：<a href="https://www.django-rest-framework.org/" target="_blank" rel="noopener">https://www.django-rest-framework.org/</a> 基于 Django 的 REST Framework，快速实现 REST API。</p>
                  <h3 id="watchdog"><a href="#watchdog" class="headerlink" title="watchdog"></a>watchdog</h3>
                  <p>GitHub：<a href="https://github.com/gorakhargosh/watchdog" target="_blank" rel="noopener">https://github.com/gorakhargosh/watchdog</a> 方便监视文件系统改动。</p>
                  <h3 id="glob"><a href="#glob" class="headerlink" title="glob"></a>glob</h3>
                  <p>Docs：<a href="https://docs.python.org/3/library/glob.html" target="_blank" rel="noopener">https://docs.python.org/3/library/glob.html</a> 对文件的操作非常方便。</p>
                  <h3 id="2to3"><a href="#2to3" class="headerlink" title="2to3"></a>2to3</h3>
                  <p>Docs：<a href="https://docs.python.org/2/library/2to3.html" target="_blank" rel="noopener">https://docs.python.org/2/library/2to3.html</a> 把 Python2 代码转成 Python3 代码。</p>
                  <h3 id="glom"><a href="#glom" class="headerlink" title="glom"></a>glom</h3>
                  <p>GitHub：<a href="https://github.com/mahmoud/glom" target="_blank" rel="noopener">https://github.com/mahmoud/glom</a> 对 JSON 嵌套的处理非常方便。</p>
                  <h3 id="pathlib"><a href="#pathlib" class="headerlink" title="pathlib"></a>pathlib</h3>
                  <p>Docs：<a href="https://docs.python.org/3/library/pathlib.html" target="_blank" rel="noopener">https://docs.python.org/3/library/pathlib.html</a> 更为方便的 Python 路径操作库。</p>
                  <h3 id="environs"><a href="#environs" class="headerlink" title="environs"></a>environs</h3>
                  <p>GitHub：<a href="https://github.com/sloria/environs" target="_blank" rel="noopener">https://github.com/sloria/environs</a> 对于环境变量的获取非常方便，支持多种类型，如 int、bool 等。</p>
                  <h3 id="pysnooper"><a href="#pysnooper" class="headerlink" title="pysnooper"></a>pysnooper</h3>
                  <p>GitHub：<a href="https://github.com/cool-RR/PySnooper" target="_blank" rel="noopener">https://github.com/cool-RR/PySnooper</a> 非常方便简单的 Python 调试器，可以追踪到代码每一处细节的执行状态。</p>
                  <h3 id="tqdm"><a href="#tqdm" class="headerlink" title="tqdm"></a>tqdm</h3>
                  <p>GitHub：<a href="https://github.com/tqdm/tqdm" target="_blank" rel="noopener">https://github.com/tqdm/tqdm</a> 进度条控制显示非常方便。</p>
                  <h3 id="sh"><a href="#sh" class="headerlink" title="sh"></a>sh</h3>
                  <p>GitHub：<a href="https://github.com/amoffat/sh" target="_blank" rel="noopener">https://github.com/amoffat/sh</a> 对 Linux 一些命令的封装，简单好用又高效。</p>
                  <h3 id="faker"><a href="#faker" class="headerlink" title="faker"></a>faker</h3>
                  <p>GitHub：<a href="https://github.com/joke2k/faker" target="_blank" rel="noopener">https://github.com/joke2k/faker</a> 模拟数据的生成。 个人写的简介：<a href="https://mp.weixin.qq.com/s/iLjr95uqgTclxYfWWNxrAA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/iLjr95uqgTclxYfWWNxrAA</a></p>
                  <h3 id="arrow、dateutil、dateparser、pendulum"><a href="#arrow、dateutil、dateparser、pendulum" class="headerlink" title="arrow、dateutil、dateparser、pendulum"></a>arrow、dateutil、dateparser、pendulum</h3>
                  <p>GitHub：<a href="https://github.com/crsmithdev/arrow、https://github.com/dateutil/dateutil、https://github.com/scrapinghub/dateparser、https://github.com/sdispater/pendulum" target="_blank" rel="noopener">https://github.com/crsmithdev/arrow、https://github.com/dateutil/dateutil、https://github.com/scrapinghub/dateparser、https://github.com/sdispater/pendulum</a> 时间解析和处理库，非常方便。arrow 目前 Star 最多，好评最多。</p>
                  <h3 id="yagmail"><a href="#yagmail" class="headerlink" title="yagmail"></a>yagmail</h3>
                  <p>GitHub：<a href="https://github.com/kootenpv/yagmail" target="_blank" rel="noopener">https://github.com/kootenpv/yagmail</a> 方便的发邮件库，替代自带的 smtplib。</p>
                  <h3 id="chardet"><a href="#chardet" class="headerlink" title="chardet"></a>chardet</h3>
                  <p>GitHub：<a href="https://github.com/chardet/chardet" target="_blank" rel="noopener">https://github.com/chardet/chardet</a> 字符串类型编码检测。</p>
                  <h3 id="pypinyin"><a href="#pypinyin" class="headerlink" title="pypinyin"></a>pypinyin</h3>
                  <p>GitHub：<a href="https://github.com/mozillazg/python-pinyin" target="_blank" rel="noopener">https://github.com/mozillazg/python-pinyin</a> 汉字转拼音，在一些中文转化处理上很有用。 个人写的简介：<a href="https://mp.weixin.qq.com/s/NvA3j8Ns1-6CFgWpUcWwQw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/NvA3j8Ns1-6CFgWpUcWwQw</a></p>
                  <h3 id="sphinx"><a href="#sphinx" class="headerlink" title="sphinx"></a>sphinx</h3>
                  <p>Docs：<a href="https://www.sphinx-doc.org/en/master/" target="_blank" rel="noopener">https://www.sphinx-doc.org/en/master/</a> 编写文档使用，大多数 Python 库文档都是这个写的，如 Scrapy、requests。 个人 sphinx + markdown 的样例：<a href="https://github.com/Gerapy/Docs" target="_blank" rel="noopener">https://github.com/Gerapy/Docs</a></p>
                  <h3 id="jinja2"><a href="#jinja2" class="headerlink" title="jinja2"></a>jinja2</h3>
                  <p>GitHub：<a href="https://github.com/pallets/jinja" target="_blank" rel="noopener">https://github.com/pallets/jinja</a> 一个方便的模板引擎，呈现页面时很方便。</p>
                  <h3 id="click"><a href="#click" class="headerlink" title="click"></a>click</h3>
                  <p>GitHub：<a href="https://github.com/pallets/click" target="_blank" rel="noopener">https://github.com/pallets/click</a> 更方便灵活地实现命令行传递参数。</p>
                  <h3 id="ray"><a href="#ray" class="headerlink" title="ray"></a>ray</h3>
                  <p>GitHub：<a href="https://github.com/ray-project/ray" target="_blank" rel="noopener">https://github.com/ray-project/ray</a> 分布式多进程管理。</p>
                  <h3 id="supervisor"><a href="#supervisor" class="headerlink" title="supervisor"></a>supervisor</h3>
                  <p>GitHub：<a href="https://github.com/Supervisor/supervisor" target="_blank" rel="noopener">https://github.com/Supervisor/supervisor</a> 进程管理工具，如实现多任务后台运行，Docker 打包时会经常用到。</p>
                  <h3 id="apscheduler"><a href="#apscheduler" class="headerlink" title="apscheduler"></a>apscheduler</h3>
                  <p>GitHub：<a href="https://github.com/agronholm/apscheduler" target="_blank" rel="noopener">https://github.com/agronholm/apscheduler</a> Python 定时任务，不过 K8S 也可以实现，个人目前可能更倾向于 K8S。</p>
                  <h3 id="intelpython"><a href="#intelpython" class="headerlink" title="intelpython"></a>intelpython</h3>
                  <p>Home：<a href="https://software.intel.com/en-us/distribution-for-python" target="_blank" rel="noopener">https://software.intel.com/en-us/distribution-for-python</a> 这不是 Python 库，是一个 Intel 开发的基于 Intel 处理器优化的 Python 解释器，对于大规模运算提升很大。 先推荐这么多了，后面还会慢慢积累，大家可以了解下，有不少库还是能极大提高生产力的。 由于这次主要是推荐一些适用范围和方向较广，个人感觉对于一些基础设施的建设比较有用的库，所以一些 Web、爬虫、数据分析、机器学习等库就没有列在这里了。当然也由于个人水平有限，也有很多库没有列全，如果大家有推荐的，欢迎留言分享哈！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-03-20 21:57:01" itemprop="dateCreated datePublished" datetime="2020-03-20T21:57:01+08:00">2020-03-20</time>
                </span>
                <span id="/9077.html" class="post-meta-item leancloud_visitors" data-flag-title="推荐一些实用的的 Python 库" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>3.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/9075.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/9075.html" class="post-title-link" itemprop="url">爬虫工程师学习养成路径</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>当今大数据的时代，网络爬虫已经成为了获取数据的一个重要手段。 但要学习好爬虫并没有那么简单。首先知识点和方向实在是太多了，它关系到了计算机网络、编程基础、前端开发、后端开发、App 开发与逆向、网络安全、数据库、运维、机器学习、数据分析等各个方向的内容，它像一张大网一样把现在一些主流的技术栈都连接在了一起。正因为涵盖的方向多，因此学习的东西也非常零散和杂乱，很多初学者搞不清楚究竟要学习哪些知识，学习过程中遇到反爬也不知道用什么方法来解决，本篇我们来做一些归纳和总结。</p>
                  <h2 id="初学爬虫"><a href="#初学爬虫" class="headerlink" title="初学爬虫"></a>初学爬虫</h2>
                  <p>一些最基本的网站，往往不带任何反爬措施。比如某个博客站点，我们要爬全站的话就顺着列表页爬到文章页，再把文章的时间、作者、正文等信息爬下来就可以了。 那代码怎么写呢？用 Python 的 requests 等库就够了，写一个基本的逻辑，顺着把一篇篇文章的源码获取下来，解析的话用 XPath、BeautifulSoup、PyQuery 或者正则表达式，或者粗暴的字符串匹配把想要的内容抠出来，再加个文本写入存下来就完事了。 代码很简单，就几个方法调用。逻辑很简单，几个循环加存储。最后就能看到一篇篇文章就被我们存到自己的电脑里面了。当然有的同学可能不太会写代码或者都懒得写，那么利用基本的可视化爬取工具，如某爪鱼、某裔采集器也能通过可视化点选的方式把数据爬下来。 如果存储方面稍微扩展一下的话，可以对接上 MySQL、MongoDB、Elasticsearch、Kafka 等等来保存数据，实现持久化存储。以后查询或者操作会更方便。 反正，不管效率如何，一个完全没有反爬的网站用最最基本的方式就搞定了。 到这里，你就说你会爬虫了吗？不，还差的远呢。</p>
                  <h2 id="Ajax、动态渲染"><a href="#Ajax、动态渲染" class="headerlink" title="Ajax、动态渲染"></a>Ajax、动态渲染</h2>
                  <p>随着互联网的发展，前端技术也在不断变化，数据的加载方式也不再是单纯的服务端渲染了。现在你可以看到很多网站的数据可能都是通过接口的形式传输的，或者即使不是接口那也是一些 JSON 的数据，然后经过 JavaScript 渲染得出来的。 这时候，你要再用 requests 来爬那就不顶用了，因为 requests 爬下来的源码是服务端渲染得到的，浏览器看到页面的和 requests 获取的结果是不一样的。真正的数据是经过 JavaScript 执行的出来的，数据来源可能是 Ajax，也可能是页面里的某些 Data，也可能是一些 ifame 页面等等，不过大多数情况下可能是 Ajax 接口获取的。 所以很多情况下需要分析 Ajax，知道这些接口的调用方式之后再用程序来模拟。但是有些接口带着加密参数，比如 token、sign 等等，又不好模拟，咋整呢？ 一种方法就是去分析网站的 JavaScript 逻辑，死抠里面的代码，揪出来这些参数是怎么构造的，找出思路来了之后再用爬虫模拟或重写就行了。如果你解出来了，那么直接模拟的方式效率会高非常多，这里面就需要一些 JavaScript 基础了，当然有些网站加密逻辑做的太牛逼了，你可能花一个星期也解不出来，最后放弃了。 那这样解不出来或者不想解，那咋办呢？这时候可以有一种简单粗暴的方法就是直接用模拟浏览器的方式来爬取，比如用 Puppeteer、Pyppeteer、Selenium、Splash 等，这样爬取到的源代码就是真正的网页代码，数据自然就好提取了，同时也就绕过分析 Ajax 和一些 JavaScript 逻辑的过程。这种方式就做到了可见即可爬，难度也不大，同时模拟了浏览器，也不太会有一些法律方面的问题。 但其实后面的这种方法也会遇到各种反爬的情况，现在很多网站都会去识别 webdriver，看到你是用的 Selenium 等工具，直接干掉或不返回数据，所以你碰到这种网站还得来专门解一下这个问题。</p>
                  <h2 id="多进程、多线程、协程"><a href="#多进程、多线程、协程" class="headerlink" title="多进程、多线程、协程"></a>多进程、多线程、协程</h2>
                  <p>上面的情况如果用单线程的爬虫来模拟是比较简单的，但是有个问题就是速度慢啊。 爬虫是 IO 密集型的任务，所以可能大多数情况下都在等待网络的响应，如果网络响应速度慢，那就得一直等着。但这个空余的时间其实可以让 CPU 去做更多事情。那怎么办呢？多开点线程吧。 所以这时候我们就可以在某些场景下加上多进程、多线程，虽然说多线程有 GIL 锁，但对于爬虫来说其实影响没那么大，所以用上多进程、多线程都可以成倍地提高爬取速度，对应的库就有 threading、multiprocessing 了。 异步协程就更牛逼了，用 aiohttp、gevent、tornado 等等的基本上你想搞多少并发就搞多少并发，但是还是悠着点，别把人家网站搞挂了。 总之，用上这几个，爬虫速度就提上来了。 但速度提上来了不一定是好事，反爬接着肯定就要来了，封你 IP、封你账号、弹验证码、返回假数据，所以有时候龟速爬似乎也是个解决办法？</p>
                  <h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2>
                  <p>多线程、多进程、协程都能加速，但终究还是单机的爬虫。要真正做到规模化，还得来靠分布式爬虫来搞。 分布式的核心是什么？资源共享。比如爬取队列共享、去重指纹共享等等。 我们可以使用一些基础的队列或组件来实现分布式，比如 RabbitMQ、Celery、Kafka、Redis 等等，但经过很多人的尝试，自己去实现一个分布式爬虫，性能和扩展性总会出现一些问题，当然特别牛逼的除外哈。不少企业内部其实也有自己开发的一套分布式爬虫，和业务更紧密，这种当然是最好了。 现在主流的 Python 分布式爬虫还是基于 Scrapy 的，对接 Scrapy-Redis、Scrapy-Redis-BloomFilter 或者用 Scrapy-Cluster 等等，他们都是基于 Redis 来共享爬取队列的，总会多多少少遇到一些内存的问题。所以一些人也考虑对接到了其他的消息队列上面，比如 RabbitMQ、Kafka 等等，解决一些问题，效率也不差。 总之，要提高爬取效率，分布式还是必须要掌握的。</p>
                  <h2 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h2>
                  <p>爬虫难免遇到反爬，验证码就是其中之一。要会反爬，那首先就要会解验证码。 现在你可以看到很多网站都会有各种各样的验证码了，比如最简单的图形验证码，要是验证码的文字规整的话，OCR 过一遍或者基本的模型库都能识别，不想搞这个的话可以直接去对接个打码平台来搞，准确率还是有的。 然而你可能现在都见不到什么图形验证码了，都是一些行为验证码，如某验、某盾等等，国外也有很多，比如 reCaptcha 等等。一些稍微简单一点的，比如滑动的，你可以找点办法识别缺口，比如图像处理比对、深度学习识别都是可以的。轨迹呢自己写个模拟正常人行为的，加点抖动之类的。有了轨迹之后咋模拟呢，如果你牛逼，那么可以直接去分析验证码的 JavaScript 逻辑，把轨迹数据录入，那就能得到里面的一些加密参数，直接拿着这些参数放到表单或接口里面就能直接用了。当然也可以用模拟浏览器的方式来拖动，也能通过一定的方式拿到加密参数，或者直接用模拟浏览器的方式把登录一起做了，拿着 Cookies 来爬也行。 当然拖动只是一种验证码，还有文字点选、逻辑推理等，要是真不想搞，可以找打码平台来解出来再模拟，但毕竟花钱的，一些高手就会选择自己训练深度学习相关的模型，收集数据、标注、训练，针对不同的业务训练不同的模型。这样有了核心技术，也不用再去花钱找打码平台了，再研究下验证码的逻辑模拟一下，加密参数就能解出来了。不过有的验证码难得很，有的我也没搞定。 当然有些验证码可能是请求过于频繁而弹出来的，这种如果换个 IP 什么的也能解。</p>
                  <h2 id="封-IP"><a href="#封-IP" class="headerlink" title="封 IP"></a>封 IP</h2>
                  <p>封 IP 也是个令人头疼的事，行之有效的方法就是换代理了。 代理很多种，市面上免费的，收费的太多太多了。 首先可以把市面上免费的代理用起来，自己搭建一个代理池，收集现在全网所有的免费代理，然后加一个测试器一直不断测试，测试的网址可以改成你要爬的网址。这样测试通过的一般都能直接拿来爬你的目标网站。我自己也搭建过一个代理池，现在对接了一些免费代理，定时爬、定时测，还写了个 API 来取，放在 GitHub 了：<a href="https://github.com/Python3WebSpider/ProxyPool，打好了" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool，打好了</a> Docker 镜像，提供了 Kubernetes 脚本，大家可以直接拿来用。 付费代理也是一样，很多商家提供了代理提取接口，请求一下就能获取几十几百个代理，我们可以同样把它们接入到代理池里面。但这个代理也分各种套餐，什么开放代理、独享代理等等的质量和被封的几率也是不一样的。 有的商家还利用隧道技术搭了代理，这样代理的地址和端口我们是不知道的，代理池是由他们来维护的，比如某布云，这样用起来更省心一些，但是可控性就差一些。 还有更稳定的代理，比如拨号代理、蜂窝代理等等，接入成本会高一些，但是一定程度上也能解决一些封 IP 的问题。 不过这些背后也不简单，为啥一个好好的高匿代理就是莫名其妙爬不了，背后的一些事就不多讲了。</p>
                  <h2 id="封账号"><a href="#封账号" class="headerlink" title="封账号"></a>封账号</h2>
                  <p>有些信息需要模拟登录才能爬嘛，如果爬的过快，人家网站直接把你的账号封禁了，就啥都没得说了。比如爬公众号的，人家把你 WX 号封了，那就全完了。 一种解决方法当然就是放慢频率，控制下节奏。 还有种方法就是看看别的终端，比如手机页、App 页、wap 页，看看有没有能绕过登录的法子。 另外比较好的方法，那就是分流。如果你号足够多，建一个池子，比如 Cookies 池、Token 池、Sign 池反正不管什么池吧，多个账号跑出来的 Cookies、Token 都放到这个池子里面，用的时候随机从里面拿一个。如果你想保证爬取效率不变，那么 100 个账号相比 20 个账号，对于每个账号对应的 Cookies、Token 的取用频率就变成原来的了 1/5，那么被封的概率也就随之降低了。</p>
                  <h2 id="奇葩的反爬"><a href="#奇葩的反爬" class="headerlink" title="奇葩的反爬"></a>奇葩的反爬</h2>
                  <p>上面说的是几种比较主流的反爬，当然还有非常多奇葩的反爬。比如返回假数据、返回图片化数据、返回乱序数据、返回骂人的数据、返回求饶的数据，那都具体情况看着办吧。 这些反爬也得小心点，之前见过一个反爬直接返回 <code>rm -rf /</code> 的也不是没有，你要是正好有个脚本模拟执行返回结果，后果自己想象哈。</p>
                  <h2 id="JavaScript-逆向"><a href="#JavaScript-逆向" class="headerlink" title="JavaScript 逆向"></a>JavaScript 逆向</h2>
                  <p>说到重头了。随着前端技术的进步和网站反爬意识的增强，很多网站选择在前端上下功夫，那就是在前端对一些逻辑或代码进行加密或混淆。当然这不仅仅是为了保护前端的代码不被轻易盗取，更重要的是反爬。比如很多 Ajax 接口都会带着一些参数，比如 sign、token 等等，这些前文也讲过了。这种数据我们可以用前文所说的 Selenium 等方式来爬，但总归来说效率太低了，毕竟它模拟的是网页渲染的整个过程，而真实的数据可能仅仅就藏在一个小接口里。 如果我们能够把一些接口的参数真正找出其中的逻辑，用代码来模拟执行，那效率就会有成倍的提升，而且还能在一定程度上规避上述的反爬现象。 但问题是什么？难啊。 Webpack 是一方面，前端代码都被压缩和转码成一些 bundle 文件，一些变量的含义已经丢失，不好还原。然后一些网站再加上一些 obfuscator 的机制，把前端代码变成你完全看不懂的东西，比如字符串拆散打乱、变量十六进制化、控制流扁平化、无限 debug、控制台禁用等等，前端的代码和逻辑已经面目全非。有的用 WebAssembly 等技术把前端核心逻辑直接编译，那就只能慢慢抠了，虽然说有些有一定的技巧，但是总归来说还是会花费很多时间。但一旦解出来了，那就万事大吉了。怎么说？就像奥赛题一样，解出来升天，解不出来 GG。 很多公司招聘爬虫工程师都会问有没有 JavaScript 逆向基础，破解过哪些网站，比如某宝、某多、某条等等，解出来某个他们需要的可能就直接录用你。每家网站的逻辑都不一样，难度也不一样。</p>
                  <h2 id="App"><a href="#App" class="headerlink" title="App"></a>App</h2>
                  <p>当然爬虫不仅仅是网页爬虫了，随着互联网时代的发展，现在越来越多的公司都选择将数据放到 App 上面，甚至有些公司只有 App 没有网站。所以数据只能通过 App 来爬。 咋爬呢？基本的就是抓包工具了，Charles、Fiddler 一把梭，抓到接口之后，直接拿来模拟就行了。 如果接口有加密参数怎么办呢？一种方法你可以边爬边处理，比如 mitmproxy 直接监听接口数据。另一方面你可以走 Hook，比如上 Xposed 也可以拿到。 那爬的时候又怎么实现自动化呢？总不能拿手来戳吧。其实工具也多，安卓原生的 adb 工具也行，Appium 现在已经是比较主流的方案了，当然还有其他的某精灵都是可以实现的。 最后，有的时候可能真的就不想走自动化的流程，我就想把里面的一些接口逻辑抠出来，那就得搞逆向了，IDA Pro、jdax、FRIDA 等工具就派上用场了，当然这个过程和 JavaScript 逆向一样很痛苦，甚至可能得读汇编指令。搞一个案例掉一把头发也不是不可能的。</p>
                  <h2 id="智能化"><a href="#智能化" class="headerlink" title="智能化"></a>智能化</h2>
                  <p>上面的这一通，都搞熟了，恭喜你已经超过了百分之八九十的爬虫玩家了，当然专门搞 JavaScript 逆向、App 逆向的都是站在食物链顶端的男人，这种严格来说已经不算爬虫范畴了，这种神我们就不算在里面了，反正我不是。 除了上面的一些技能，在一些场合下，我们可能也需要结合一些机器学习的技术，让我们的爬虫变得更智能起来。 比如现在很多博客、新闻文章，其页面结构相似度比较高，要提取的信息也比较类似。 比如如何区分一个页面是索引页还是详情页？如何提取详情页的文章链接？如何解析文章页的页面内容？这些其实都是可以通过一些算法来计算出来的。 所以，一些智能解析技术也营运而生，比如提取详情页，一位朋友写的 GeneralNewsExtractor 表现就非常好。 假如说我来了一个需求，我要爬取一万个新闻网站数据，要一个个写 XPath 吗？写死我吧。如果有了智能化解析技术，在容忍一定错误的条件下，完成这个就是分分钟的事情。 总之，如果我们能把这一块也学会了，我们的爬虫技术就会如虎添翼。</p>
                  <h2 id="运维"><a href="#运维" class="headerlink" title="运维"></a>运维</h2>
                  <p>这块也是一个重头戏。爬虫和运维也是息息相关。 比如写完一个爬虫，怎样去快速部署到 100 台主机上跑起来。 比如怎么灵活地监控每个爬虫的运行状态。 比如爬虫有处代码改动，如何去快速更新。 比如怎样监控一些爬虫的占用内存、消耗的 CPU 状况。 比如怎样科学地控制爬虫的定时运行、 比如爬虫出现了问题，怎样能及时收到通知，怎样设置科学的报警机制。 这里面，部署大家各有各的方法，比如用 Ansible 当然可以。如果用 Scrapy 的话有 Scrapyd，然后配合上一些管理工具也能完成一些监控和定时任务。不过我现在用的更多是还是 Docker + Kubernetes，再加上 DevOps 一套，比如 GitHub Actions、Azure Pipelines、Jenkins 等等，快速实现分发和部署。 定时任务大家有的用 crontab，有的用 apscheduler，有的用管理工具，有的用 Kubernetes，我的话用 Kubernetes 就多一些了，定时任务也是很好实现。 至于监控的话，也有很多，专门的一些爬虫管理工具自带了一些监控和报警功能。一些云服务也带了一些监控的功能。我用的是 Kubernetes + Prometheus + Grafana，什么 CPU、内存、运行状态，一目了然，报警机制在 Grafana 里面配一下也很方便，支持 Webhook、邮件甚至某钉。 数据的存储和监控，用 Kafka、Elasticsearch 个人感觉也挺方便的，我主要用的是后者，然后再和 Grafana 配合起来，数据爬取量、爬取速度等等监控也都一目了然。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>至此，爬虫的一些涵盖的知识点也就差不多了，怎么样，梳理一下，是不是计算机网络、编程基础、前端开发、后端开发、App 开发与逆向、网络安全、数据库、运维、机器学习都涵盖到了？上面总结的可以算是从爬虫小白到爬虫高手的路径了，里面每个方向其实可研究的点非常多，每个点做精了，都会非常了不起。 爬虫往往学着学着，就成为了一名全栈工程师或者全干工程师，因为你可能真的啥都会了。但是没办法啊，都是被爬虫逼的啊，如果不是生活所困，谁愿意一身才华呢？ 然而有了才华之后呢？摸摸头顶，卧槽，我的头发呢？ 嗯，大家都懂的。 最后最重要的，珍爱生命、珍爱每一根头发。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-03-20 21:55:48" itemprop="dateCreated datePublished" datetime="2020-03-20T21:55:48+08:00">2020-03-20</time>
                </span>
                <span id="/9075.html" class="post-meta-item leancloud_visitors" data-flag-title="爬虫工程师学习养成路径" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8947.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/8947.html" class="post-title-link" itemprop="url">Python 使用 environs 库来更好地定义环境变量</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在运行一个项目的时候，我们经常会遇到设置不同环境的需求，如设置是开发环境、测试环境还是生产环境，或者在某些设置里面可能还需要设置一些变量开关，如设置调试开关、日志开关、功能开关等等。 这些变量其实就是在项目运行时我们给项目设置的一些参数。这些参数一般情况来说，可以有两种设置方法，一种是通过命令行参数，一种是通过环境变量。二者的适用范围不同，在不同的场景下我们可以选用更方便的方式来实现参数的设置。 本节我们以 Python 项目为例，说说环境变量的设置。</p>
                  <h2 id="设置和获取环境变量"><a href="#设置和获取环境变量" class="headerlink" title="设置和获取环境变量"></a>设置和获取环境变量</h2>
                  <p>首先，我们先来了解一下在 Python 项目里面怎样设置和获取变量。 首先让我们定义一个最简单的 Python 文件，命名为 main.py，内容如下：</p>
                  <figure class="highlight moonscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> <span class="built_in">os</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.environ[<span class="string">'VAR1'</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里我们导入了 os 模块，它的 environ 对象里面就包含了当前运行状态下的所有环境变量，它其实是一个 <code>os._Environ</code> 对象，我们可以通过类似字典取值的方式从中获取里面包含的环境变量的值，如代码所示。 好，接下来我们什么也不设置，直接运行，看下结果：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">python3</span> main.<span class="keyword">py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">raise</span> KeyError(key) <span class="keyword">from</span> <span class="keyword">None</span></span><br><span class="line">KeyError: <span class="string">'VAR1'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>直接抛出来了一个错误，这很正常，我们此时并没有设置 VAR1 这个环境变量，当然会抛出键值异常的错误了。 接下来我们在命令行下进行设置，运行如下命令：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">VAR1</span>=germey python3 main.py</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">germey</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到我们在运行之前，在命令行之前通过键值对的形式对环境变量进行设置，程序就可以获取到 VAR1 这个值了，成功打印出来了 germey。 但这个环境变量是永久的吗？我们这次再运行一遍原来的命令：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">python3</span> main.<span class="keyword">py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">raise</span> KeyError(key) <span class="keyword">from</span> <span class="keyword">None</span></span><br><span class="line">KeyError: <span class="string">'VAR1'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>嗯，又抛错了。 这说明了什么，在命令行的前面加上的这个环境变量声明只能对当前执行的命令生效。 好，那既然如此，我难道每次运行都要在命令行前面加上这些声明吗？那岂不麻烦死了。 当然有解决方法，我们使用 export 就可以了。 比如这里，我们执行如下命令：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR1</span>=germey</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行完这个命令之后，当前运行环境下 VAR1 就被设置成功了，下面我们运行的命令都能获取到 VAR1 这个环境变量了。 下面来试试，还是执行原来的命令：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">python3</span> main.<span class="keyword">py</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">germey</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以，成功获取到了 VAR1 这个变量，后面我们运行的每一个命令就都会生效了。 但等一下，这个用了 export 就是永久生效了吗？ 其实并不是，其实这个 export 只对当前的命令行运行环境生效，我们只要把命令行关掉再重新打开，之前用 export 设置的环境变量就都没有了。 可以试试，重新打开命令行，再次执行原来的命令，就会又抛出键值异常的错误了。 那又有同学会问了，我要在每次命令行运行时都想自动设置好环境变量怎么办呢？ 这个就更好办了，只需要把 export 的这些命令加入到 <code>~/.bashrc</code> 文件里面就好了，每次打开命令行的时候，系统都会自动先执行以下这个脚本里面的命令，这样环境变量就设置成功了。当然这里面还有很多不同的文件，如 <code>~/.bash_profile</code> 、<code>~/.zshrc</code> 、<code>~/.profile</code>、<code>/etc/profile</code> 等等，其加载是有先后顺序的，大家感兴趣可以去了解下。 好了，扯远了，我们现在已经了解了如何设置环境变量和基本的环境变量获取方法了。</p>
                  <h2 id="更安全的获取方式"><a href="#更安全的获取方式" class="headerlink" title="更安全的获取方式"></a>更安全的获取方式</h2>
                  <p>但是上面的这种获取变量的方式实际上是非常不友好的，万一这个环境变量没设置好，那岂不是就报错了，这是很不安全的。 所以，下面再介绍几种比较友好的获取环境变量的方式，即使没有设置过，也不会报错。 我们可以把中括号取值的方式改成 get 方法，如下所示：</p>
                  <figure class="highlight moonscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> <span class="built_in">os</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.environ.get(<span class="string">'VAR1'</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就不会报错了，如果 VAR1 没设置，会直接返回 None，而不是直接报错。 另外我们也可以给 get 方法传入第二个参数，表示默认值，如下所示：</p>
                  <figure class="highlight moonscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> <span class="built_in">os</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.environ.get(<span class="string">'VAR1'</span>, <span class="string">'germey'</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样即使我们如果设置过 VAR1，他就会用 germey 这个字符串代替，这就完成了默认环境变量的设置。 下面还有几种获取环境变量的方式，总结如下：</p>
                  <figure class="highlight lua">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import <span class="built_in">os</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">'VAR1'</span>, <span class="string">'germey'</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个方式比上面的写法更简单，功能完全一致。</p>
                  <h2 id="弊端"><a href="#弊端" class="headerlink" title="弊端"></a>弊端</h2>
                  <p>但其实上面的方法有一个不方便的地方，如果我们想要设置非字符串类型的环境变量怎么办呢？比如设置 int 类型、float 类型、list 类型，可能我们的写法就会变成这个样子：</p>
                  <figure class="highlight lua">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import <span class="built_in">os</span></span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">VAR1 = int(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">'VAR1'</span>, <span class="number">1</span>))</span><br><span class="line">VAR2 = float(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">'VAR2'</span>, <span class="number">5.5</span>))</span><br><span class="line">VAR3 = json.loads(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">'VAR3'</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后设置环境变量的时候就变成这样子：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR1</span>=1</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR2</span>=2.3</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR3</span>=<span class="string">'["1", "2"]'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样才能成功获取到结果，打印出来结果如下：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2.3</span></span><br><span class="line">[<span class="symbol">'1</span>', <span class="symbol">'2</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>不过看下这个，写法也太奇葩了吧，又是类型转换，又是 json 解析什么的，有没有更好的方法来设置。</p>
                  <h2 id="environs"><a href="#environs" class="headerlink" title="environs"></a>environs</h2>
                  <p>当然有的，下面推荐一个 environs 库，利用它我们可以轻松地设置各种类型的环境变量。 这是一个第三方库，可以通过 pip 来安装：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> environs</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好，安装之后，我们再来体验一下使用 environs 来设置环境变量的方式。</p>
                  <figure class="highlight dockerfile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> environs import <span class="keyword">Env</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">env</span> = <span class="keyword">Env</span>()</span><br><span class="line">VAR1 = <span class="keyword">env</span>.int(<span class="string">'VAR1'</span>, <span class="number">1</span>)</span><br><span class="line">VAR2 = <span class="keyword">env</span>.float(<span class="string">'VAR2'</span>, <span class="number">5.5</span>)</span><br><span class="line">VAR3 = <span class="keyword">env</span>.list(<span class="string">'VAR3'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 environs 直接提供了 int、float、list 等方法，我们就不用再去进行类型转换了。 与此同时，设置环境变量的方式也有所变化：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR1</span>=1</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR2</span>=2.3</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR3</span>=1,2</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 VAR3 是列表，我们可以直接用逗号分隔开来。 打印结果如下：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2.3</span></span><br><span class="line">[<span class="symbol">'1</span>', <span class="symbol">'2</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="官方示例"><a href="#官方示例" class="headerlink" title="官方示例"></a>官方示例</h3>
                  <p>下面我们再看一个官方示例，这里示例了一些常见的用法。 首先我们来定义一些环境变量，如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">GITHUB_USER</span>=sloria</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">MAX_CONNECTIONS</span>=100</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">SHIP_DATE</span>=<span class="string">'1984-06-25'</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">TTL</span>=42</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">ENABLE_LOGIN</span>=<span class="literal">true</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">GITHUB_REPOS</span>=webargs,konch,ped</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">COORDINATES</span>=23.3,50.0</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">LOG_LEVEL</span>=DEBUG</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里有字符串、有日期、有日志级别、有字符串列表、有浮点数列表、有布尔。 我们来看下怎么获取，写法如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> environs import Env</span><br><span class="line"></span><br><span class="line">env = Env()</span><br><span class="line">env.read_env()  # read .env file, <span class="keyword">if</span> it exists</span><br><span class="line"><span class="comment"># required variables</span></span><br><span class="line">gh_user = env(<span class="string">"GITHUB_USER"</span>)  # =&gt; <span class="string">'sloria'</span></span><br><span class="line">secret = env(<span class="string">"SECRET"</span>)  # =&gt; raises <span class="builtin-name">error</span> <span class="keyword">if</span> <span class="keyword">not</span> set</span><br><span class="line"></span><br><span class="line"><span class="comment"># casting</span></span><br><span class="line">max_connections = env.int(<span class="string">"MAX_CONNECTIONS"</span>)  # =&gt; 100</span><br><span class="line">ship_date = env.date(<span class="string">"SHIP_DATE"</span>)  # =&gt; datetime.date(1984, 6, 25)</span><br><span class="line">ttl = env.timedelta(<span class="string">"TTL"</span>)  # =&gt; datetime.timedelta(0, 42)</span><br><span class="line">log_level = env.log_level(<span class="string">"LOG_LEVEL"</span>)  # =&gt; logging.DEBUG</span><br><span class="line"></span><br><span class="line"><span class="comment"># providing a default value</span></span><br><span class="line">enable_login = env.bool(<span class="string">"ENABLE_LOGIN"</span>, <span class="literal">False</span>)  # =&gt; <span class="literal">True</span></span><br><span class="line">enable_feature_x = env.bool(<span class="string">"ENABLE_FEATURE_X"</span>, <span class="literal">False</span>)  # =&gt; <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># parsing lists</span></span><br><span class="line">gh_repos = env.list(<span class="string">"GITHUB_REPOS"</span>)  # =&gt; [<span class="string">'webargs'</span>, <span class="string">'konch'</span>, <span class="string">'ped'</span>]</span><br><span class="line">coords = env.list(<span class="string">"COORDINATES"</span>, <span class="attribute">subcast</span>=float)  # =&gt; [23.3, 50.0]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>通过观察代码可以发现它提供了这些功能：</p>
                  <ul>
                    <li>通过 env 可以设置必需定义的变量，如果没有定义，则会报错。</li>
                    <li>通过 date、timedelta 方法可以对日期或时间进行转化，转成 datetime.date 或 timedelta 类型。</li>
                    <li>通过 log_level 方法可以对日志级别进行转化，转成 logging 里的日志级别定义。</li>
                    <li>通过 bool 方法可以对布尔类型变量进行转化。</li>
                    <li>通过 list 方法可以对逗号分隔的内容进行 list 转化，并可以通过 subcast 方法对 list 的每个元素进行类型转化。</li>
                  </ul>
                  <p>可以说有了这些方法，定义各种类型的变量都不再是问题了。</p>
                  <h3 id="支持类型"><a href="#支持类型" class="headerlink" title="支持类型"></a>支持类型</h3>
                  <p>总的来说，environs 支持的转化类型有这么多：</p>
                  <ul>
                    <li><code>env.str</code></li>
                    <li><code>env.bool</code></li>
                    <li><code>env.int</code></li>
                    <li><code>env.float</code></li>
                    <li><code>env.decimal</code></li>
                    <li><code>env.list</code> (accepts optional <code>subcast</code> keyword argument)</li>
                    <li><code>env.dict</code> (accepts optional <code>subcast</code> keyword argument)</li>
                    <li><code>env.json</code></li>
                    <li><code>env.datetime</code></li>
                    <li><code>env.date</code></li>
                    <li><code>env.timedelta</code> (assumes value is an integer in seconds)</li>
                    <li><code>env.url</code></li>
                    <li><code>env.uuid</code></li>
                    <li><code>env.log_level</code></li>
                    <li><code>env.path</code> (casts to a <a href="https://docs.python.org/3/library/pathlib.html" target="_blank" rel="noopener"><code>pathlib.Path</code></a>)</li>
                  </ul>
                  <p>这里 list、dict、json、date、url、uuid、path 个人认为都还是比较有用的，另外 list、dict 方法还有一个 subcast 方法可以对元素内容进行转化。 对于 dict、url、date、uuid、path 这里我们来补充说明一下。 下面我们定义这些类型的环境变量：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR_DICT</span>=name=germey,age=25</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR_JSON</span>=<span class="string">'&#123;"name": "germey", "age": 25&#125;'</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR_URL</span>=https://cuiqingcai.com</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR_UUID</span>=762c8d53-5860-4d5d-81bc-210bf2663d0e</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">VAR_PATH</span>=/var/py/env</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>需要注意的是，DICT 的解析，需要传入的是逗号分隔的键值对，JSON 的解析是需要传入序列化的字符串。 解析写法如下：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> environs <span class="keyword">import</span> Env</span><br><span class="line"></span><br><span class="line"><span class="title">env</span> = <span class="type">Env</span>()</span><br><span class="line"><span class="type">VAR_DICT</span> = env.dict('<span class="type">VAR_DICT'</span>)</span><br><span class="line"><span class="title">print</span>(<span class="class"><span class="keyword">type</span>(<span class="type">VAR_DICT</span>), <span class="type">VAR_DICT</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">VAR_JSON</span> = env.json('<span class="type">VAR_JSON'</span>)</span><br><span class="line"><span class="title">print</span>(<span class="class"><span class="keyword">type</span>(<span class="type">VAR_JSON</span>), <span class="type">VAR_JSON</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">VAR_URL</span> = env.url('<span class="type">VAR_URL'</span>)</span><br><span class="line"><span class="title">print</span>(<span class="class"><span class="keyword">type</span>(<span class="type">VAR_URL</span>), <span class="type">VAR_URL</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">VAR_UUID</span> = env.uuid('<span class="type">VAR_UUID'</span>)</span><br><span class="line"><span class="title">print</span>(<span class="class"><span class="keyword">type</span>(<span class="type">VAR_UUID</span>), <span class="type">VAR_UUID</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">VAR_PATH</span> = env.path('<span class="type">VAR_PATH'</span>)</span><br><span class="line"><span class="title">print</span>(<span class="class"><span class="keyword">type</span>(<span class="type">VAR_PATH</span>), <span class="type">VAR_PATH</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&lt;class <span class="string">'dict'</span>&gt; &#123;<span class="string">'name'</span>: <span class="string">'germey'</span>, <span class="string">'age'</span>: <span class="string">'25'</span>&#125;</span><br><span class="line">&lt;class <span class="string">'dict'</span>&gt; &#123;<span class="string">'name'</span>: <span class="string">'germey'</span>, <span class="string">'age'</span>: 25&#125;</span><br><span class="line">&lt;class <span class="string">'urllib.parse.ParseResult'</span>&gt; ParseResult(<span class="attribute">scheme</span>=<span class="string">'https'</span>, <span class="attribute">netloc</span>=<span class="string">'cuiqingcai.com'</span>, <span class="attribute">path</span>=<span class="string">''</span>, <span class="attribute">params</span>=<span class="string">''</span>, <span class="attribute">query</span>=<span class="string">''</span>, <span class="attribute">fragment</span>=<span class="string">''</span>)</span><br><span class="line">&lt;class <span class="string">'uuid.UUID'</span>&gt; 762c8d53-5860-4d5d-81bc-210bf2663d0e</span><br><span class="line">&lt;class <span class="string">'pathlib.PosixPath'</span>&gt; /var/py/env</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，它分别给我们转化成了 dict、dict、ParseResult、UUID、PosixPath 类型了。 在代码中直接使用即可。</p>
                  <h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3>
                  <p>如果我们的一些环境变量是定义在文件中的，environs 还可以进行读取和加载，默认会读取本地当前运行目录下的 <code>.env</code> 文件。 示例如下：</p>
                  <figure class="highlight dockerfile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> environs import <span class="keyword">Env</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">env</span> = <span class="keyword">Env</span>()</span><br><span class="line"><span class="keyword">env</span>.read_env()</span><br><span class="line">APP_DEBUG = <span class="keyword">env</span>.bool(<span class="string">'APP_DEBUG'</span>)</span><br><span class="line">APP_ENV = <span class="keyword">env</span>.str(<span class="string">'APP_ENV'</span>)</span><br><span class="line">print(APP_DEBUG)</span><br><span class="line">print(APP_ENV)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下面我们在 <code>.env</code> 文件中写入如下内容：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">APP_DEBUG</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">APP_ENV</span>=prod</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="string">prod</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>没问题，成功读取。 当然我们也可以自定义读取的文件，如 <code>.env.test</code> 文件，内容如下：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">APP_DEBUG</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">APP_ENV</span>=test</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码则可以这么定义：</p>
                  <figure class="highlight dockerfile">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> environs import <span class="keyword">Env</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">env</span> = <span class="keyword">Env</span>()</span><br><span class="line"><span class="keyword">env</span>.read_env(path=<span class="string">'.env.test'</span>)</span><br><span class="line">APP_DEBUG = <span class="keyword">env</span>.bool(<span class="string">'APP_DEBUG'</span>)</span><br><span class="line">APP_ENV = <span class="keyword">env</span>.str(<span class="string">'APP_ENV'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里就通过 path 传入了定义环境变量的文件路径即可。</p>
                  <h3 id="前缀处理"><a href="#前缀处理" class="headerlink" title="前缀处理"></a>前缀处理</h3>
                  <p>environs 还支持前缀处理，一般来说我们定义一些环境变量，如数据库的连接，可能有 host、port、password 等，但在定义环境变量的时候往往会加上对应的前缀，如 MYSQL_HOST、MYSQL_PORT、MYSQL_PASSWORD 等，但在解析时，我们可以根据前缀进行分组处理，见下面的示例：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># export MYAPP_HOST=lolcathost</span></span><br><span class="line"><span class="comment"># export MYAPP_PORT=3000</span></span><br><span class="line"></span><br><span class="line">with env.prefixed(<span class="string">"MYAPP_"</span>):</span><br><span class="line">    host = env(<span class="string">"HOST"</span>, <span class="string">"localhost"</span>)  # =&gt; <span class="string">'lolcathost'</span></span><br><span class="line">   <span class="built_in"> port </span>= env.int(<span class="string">"PORT"</span>, 5000)  # =&gt; 3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># nested prefixes are also supported:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># export MYAPP_DB_HOST=lolcathost</span></span><br><span class="line"><span class="comment"># export MYAPP_DB_PORT=10101</span></span><br><span class="line"></span><br><span class="line">with env.prefixed(<span class="string">"MYAPP_"</span>):</span><br><span class="line">    with env.prefixed(<span class="string">"DB_"</span>):</span><br><span class="line">        db_host = env(<span class="string">"HOST"</span>, <span class="string">"lolcathost"</span>)</span><br><span class="line">        db_port = env.int(<span class="string">"PORT"</span>, 10101)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到这里通过 with 和 priefixed 方法组合使用即可实现分区处理，这样在每个分组下再赋值到一个字典里面即可。</p>
                  <h3 id="合法性验证"><a href="#合法性验证" class="headerlink" title="合法性验证"></a>合法性验证</h3>
                  <p>有些环境变量的传入是不可预知的，如果传入一些非法的环境变量很可能导致一些难以预料的问题。比如说一些可执行的命令，通过环境变量传进来，如果是危险命令，那么会非常危险。 所以在某些情况下我们需要验证传入的环境变量的有效性，看下面的例子：</p>
                  <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># <span class="keyword">export</span> TTL=<span class="number">-2</span></span><br><span class="line"># <span class="keyword">export</span> NODE_ENV=<span class="string">'invalid'</span></span><br><span class="line"># <span class="keyword">export</span> EMAIL=<span class="string">'^_^'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> environs <span class="keyword">import</span> Env</span><br><span class="line"><span class="keyword">from</span> marshmallow.validate <span class="keyword">import</span> OneOf, Length, Email</span><br><span class="line"></span><br><span class="line">env = Env()</span><br><span class="line"></span><br><span class="line"># simple validator</span><br><span class="line">env.int(<span class="string">"TTL"</span>, validate=lambda n: n &gt; <span class="number">0</span>)</span><br><span class="line"># =&gt; Environment variable <span class="string">"TTL"</span> invalid: [<span class="string">'Invalid value.'</span>]</span><br><span class="line"></span><br><span class="line"># using marshmallow validators</span><br><span class="line">env.str(</span><br><span class="line">    <span class="string">"NODE_ENV"</span>,</span><br><span class="line">    validate=OneOf(</span><br><span class="line">        [<span class="string">"production"</span>, <span class="string">"development"</span>], error=<span class="string">"NODE_ENV must be one of: &#123;choices&#125;"</span></span><br><span class="line">    ),</span><br><span class="line">)</span><br><span class="line"># =&gt; Environment variable <span class="string">"NODE_ENV"</span> invalid: [<span class="string">'NODE_ENV must be one of: production, development'</span>]</span><br><span class="line"></span><br><span class="line"># multiple validators</span><br><span class="line">env.str(<span class="string">"EMAIL"</span>, validate=[Length(min=<span class="number">4</span>), Email()])</span><br><span class="line"># =&gt; Environment variable <span class="string">"EMAIL"</span> invalid: [<span class="string">'Shorter than minimum length 4.'</span>, <span class="string">'Not a valid email address.'</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里，我们通过 validate 方法，并传入一些判断条件。如 NODE_ENV 只允许传入 production 和 develpment 其中之一；EMAIL 必须符合 email 的格式。 这里依赖于 marshmallow 这个库，里面有很多验证条件，大家可以了解下。 如果不符合条件的，会直接抛错，例如：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">marshmallow</span><span class="selector-class">.exceptions</span><span class="selector-class">.ValidationError</span>: <span class="selector-attr">[<span class="string">'Invalid value.'</span>]</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>关于 marshmallow 库的用法，大家可以参考：<a href="https://marshmallow.readthedocs.io/en/stable/，后面我也抽空写一下介绍下" target="_blank" rel="noopener">https://marshmallow.readthedocs.io/en/stable/，后面我也抽空写一下介绍下</a>。 最后再附一点我平时定义环境变量的一些常见写法，如：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> dirname, abspath, <span class="keyword">join</span></span><br><span class="line"><span class="keyword">from</span> environs <span class="keyword">import</span> Env</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">env = Env()</span><br><span class="line">env.read_env()</span><br><span class="line"></span><br><span class="line"># definition <span class="keyword">of</span> flags</span><br><span class="line">IS_WINDOWS = platform.<span class="keyword">system</span>().lower() == <span class="string">'windows'</span></span><br><span class="line"></span><br><span class="line"># definition <span class="keyword">of</span> dirs</span><br><span class="line">ROOT_DIR = dirname(dirname(abspath(__file__)))</span><br><span class="line">LOG_DIR = <span class="keyword">join</span>(ROOT_DIR, env.str(<span class="string">'LOG_DIR'</span>, <span class="string">'logs'</span>))</span><br><span class="line"></span><br><span class="line"># definition <span class="keyword">of</span> environments</span><br><span class="line">DEV_MODE, TEST_MODE, PROD_MODE = <span class="string">'dev'</span>, <span class="string">'test'</span>, <span class="string">'prod'</span></span><br><span class="line">APP_ENV = env.str(<span class="string">'APP_ENV'</span>, DEV_MODE).lower()</span><br><span class="line">APP_DEBUG = env.bool(<span class="string">'APP_DEBUG'</span>, <span class="keyword">True</span> <span class="keyword">if</span> APP_ENV == DEV_MODE <span class="keyword">else</span> <span class="keyword">False</span>)</span><br><span class="line">APP_DEV = IS_DEV = APP_ENV == DEV_MODE</span><br><span class="line">APP_PROD = IS_PROD = APP_DEV == PROD_MODE</span><br><span class="line">APP_TEST = IS_TEST = APP_ENV = TEST_MODE</span><br><span class="line"></span><br><span class="line"># redis host</span><br><span class="line">REDIS_HOST = env.str(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>)</span><br><span class="line"># redis port</span><br><span class="line">REDIS_PORT = env.int(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>)</span><br><span class="line"># redis <span class="keyword">password</span>, <span class="keyword">if</span> <span class="keyword">no</span> <span class="keyword">password</span>, <span class="keyword">set</span> it <span class="keyword">to</span> <span class="keyword">None</span></span><br><span class="line">REDIS_PASSWORD = env.str(<span class="string">'REDIS_PASSWORD'</span>, <span class="keyword">None</span>)</span><br><span class="line"># redis <span class="keyword">connection</span> string, <span class="keyword">like</span> redis://[<span class="keyword">password</span>]@host:port <span class="keyword">or</span> rediss://[<span class="keyword">password</span>]@host:port</span><br><span class="line">REDIS_CONNECTION_STRING = env.str(<span class="string">'REDIS_CONNECTION_STRING'</span>, <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line"># definition <span class="keyword">of</span> api</span><br><span class="line">API_HOST = env.str(<span class="string">'API_HOST'</span>, <span class="string">'0.0.0.0'</span>)</span><br><span class="line">API_PORT = env.int(<span class="string">'API_PORT'</span>, <span class="number">5555</span>)</span><br><span class="line">API_THREADED = env.bool(<span class="string">'API_THREADED'</span>, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"># definition <span class="keyword">of</span> flags</span><br><span class="line">ENABLE_TESTER = env.bool(<span class="string">'ENABLE_TESTER'</span>, <span class="keyword">True</span>)</span><br><span class="line">ENABLE_GETTER = env.bool(<span class="string">'ENABLE_GETTER'</span>, <span class="keyword">True</span>)</span><br><span class="line">ENABLE_SERVER = env.bool(<span class="string">'ENABLE_SERVER'</span>, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"># logger</span><br><span class="line">logger.<span class="keyword">add</span>(env.str(<span class="string">'LOG_RUNTIME_FILE'</span>, <span class="string">'runtime.log'</span>), <span class="keyword">level</span>=<span class="string">'DEBUG'</span>, rotation=<span class="string">'1 week'</span>, retention=<span class="string">'20 days'</span>)</span><br><span class="line">logger.<span class="keyword">add</span>(env.str(<span class="string">'LOG_ERROR_FILE'</span>, <span class="string">'error.log'</span>), <span class="keyword">level</span>=<span class="string">'ERROR'</span>, rotation=<span class="string">'1 week'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里定义了一些开发环境、日志路径、数据库连接、API 设置、开关设置等等，是从我之前写的一个代理池项目拿来的，大家可以参考：<a href="https://github.com/Python3WebSpider/ProxyPool" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool</a>。 好了，以上就是一些环境变量的定义方法，谢谢大家。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-02-25 01:25:12" itemprop="dateCreated datePublished" datetime="2020-02-25T01:25:12+08:00">2020-02-25</time>
                </span>
                <span id="/8947.html" class="post-meta-item leancloud_visitors" data-flag-title="Python 使用 environs 库来更好地定义环境变量" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>9.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8943.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/8943.html" class="post-title-link" itemprop="url">Python 序列化和反序列化库 MarshMallow 的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>在很多情况下，我们会有把 Python 对象进行序列化或反序列化的需求，比如开发 REST API，比如一些面向对象化的数据加载和保存，都会应用到这个功能。 比如这里看一个最基本的例子，这里给到一个 User 的 Class 定义，再给到一个 data 数据，像这样：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, name, age)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.age = age</span><br><span class="line"></span><br><span class="line">data = [&#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Germey'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="number">23</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Mike'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="number">20</span></span><br><span class="line">&#125;]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>现在我要把这个 data 快速转成 User 组成的数组，变成这样：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[User(<span class="attribute">name</span>=<span class="string">'Germey'</span>, <span class="attribute">age</span>=23), User(<span class="attribute">name</span>=<span class="string">'Mike'</span>, <span class="attribute">age</span>=20)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>你会怎么来实现？ 或者我有了上面的列表内容，想要转成一个 JSON 字符串，变成这样：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[&#123;<span class="attr">"name"</span>: <span class="string">"Germey"</span>, <span class="attr">"age"</span>: <span class="number">23</span>&#125;, &#123;<span class="attr">"name"</span>: <span class="string">"Mike"</span>, <span class="attr">"age"</span>: <span class="number">20</span>&#125;]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>你又会怎么操作呢？ 另外如果 JSON 数据里面有各种各样的脏数据，你需要在初始化时验证这些字段是否合法，另外 User 这个对象里面 name、age 的数据类型不同，如何针对不同的数据类型进行针对性的类型转换，这个你有更好的实现方案吗？</p>
                  <h2 id="初步思路"><a href="#初步思路" class="headerlink" title="初步思路"></a>初步思路</h2>
                  <p>之前我写过一篇文章介绍过 attrs 和 cattrs 这两个库，它们二者的组合可以非常方便地实现对象的序列化和反序列化。 譬如这样：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> attr <span class="keyword">import</span> attrs, attrib</span><br><span class="line"><span class="keyword">from</span> cattr <span class="keyword">import</span> structure, unstructure</span><br><span class="line"></span><br><span class="line">@attrs</span><br><span class="line"><span class="keyword">class</span> <span class="keyword">User</span>(<span class="keyword">object</span>):</span><br><span class="line">    <span class="type">name</span> = attrib()</span><br><span class="line">    age = attrib()</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Germey'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="number">23</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">user</span> = structure(data, <span class="keyword">User</span>)</span><br><span class="line">print(<span class="string">'user'</span>, <span class="keyword">user</span>)</span><br><span class="line"><span class="type">json</span> = unstructure(<span class="keyword">user</span>)</span><br><span class="line">print(<span class="string">'json'</span>, <span class="type">json</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">user</span> <span class="keyword">User</span>(<span class="type">name</span>=<span class="string">'Germey'</span>, age=<span class="number">23</span>)</span><br><span class="line"><span class="type">json</span> &#123;<span class="string">'name'</span>: <span class="string">'Germey'</span>, <span class="string">'age'</span>: <span class="number">23</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好，这里我们通过 attrs 和 cattrs 这两个库来实现了单个对象的转换。 首先我们要肯定一下 attrs 这个库，它可以极大地简化 Python 类的定义，同时每个字段可以定义多种数据类型。 但 cattrs 这个库就相对弱一些了，如果把 data 换成数组，用 cattrs 还是不怎么好转换的，另外它的 structure 和 unstructure 在某些情景下容错能力较差，所以对于上面的需求，用这两个库搭配起来并不是一个最优的解决方案。 另外数据的校验也是一个问题，attrs 虽然提供了 validator 的参数，但对于多种类型的数据处理的支持并没有那么强大。 所以，我们想要寻求一个更优的解决方案。</p>
                  <h2 id="更优雅的方案"><a href="#更优雅的方案" class="headerlink" title="更优雅的方案"></a>更优雅的方案</h2>
                  <p>这里推荐一个库，叫做 marshmallow，它是专门用来支持 Python 对象和原生数据相互转换的库，如实现 object -&gt; dict，objects -&gt; list, string -&gt; dict, string -&gt; list 等的转换功能，另外它还提供了非常丰富的数据类型转换和校验 API，帮助我们快速实现数据的转换。 要使用 marshmallow 这个库，需要先安装下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> marshmallow</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了之后，我们在之前的基础上定义一个 Schema，如下：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="title">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    age = fields.Integer()</span><br><span class="line"></span><br><span class="line">    @post_load</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make</span><span class="params">(<span class="keyword">self</span>, data, **kwargs)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> User(**data)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>还是之前的数据：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">data</span> = [&#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Germey'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="number">23</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Mike'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="number">20</span></span><br><span class="line">&#125;]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时候我们只需要调用 Schema 的 load 事件就好了：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">schema = UserSchema()</span><br><span class="line">users = schema.load(data, <span class="attribute">many</span>=<span class="literal">True</span>)</span><br><span class="line"><span class="builtin-name">print</span>(users)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出结果如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[User(<span class="attribute">name</span>=<span class="string">'Germey'</span>, <span class="attribute">age</span>=23), User(<span class="attribute">name</span>=<span class="string">'Mike'</span>, <span class="attribute">age</span>=20)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样，我们非常轻松地完成了 JSON 到 User List 的转换。 有人说，如果是单个数据怎么办呢，只需要把 load 方法的 many 参数去掉即可：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Germey'</span>,</span><br><span class="line">    <span class="string">'age'</span>: 23</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">schema = UserSchema()</span><br><span class="line">user = schema.load(data)</span><br><span class="line"><span class="builtin-name">print</span>(user)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出结果：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">User(<span class="attribute">name</span>=<span class="string">'Germey'</span>, <span class="attribute">age</span>=23)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>当然，这仅仅是一个反序列化操作，我们还可以正向进行序列化，以及使用各种各样的验证条件。 下面我们再来看看吧。</p>
                  <h2 id="更方便的序列化"><a href="#更方便的序列化" class="headerlink" title="更方便的序列化"></a>更方便的序列化</h2>
                  <p>上面的例子我们实现了序列化操作，输出了 users 为：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[User(<span class="attribute">name</span>=<span class="string">'Germey'</span>, <span class="attribute">age</span>=23), User(<span class="attribute">name</span>=<span class="string">'Mike'</span>, <span class="attribute">age</span>=20)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>有了这个数据，我们也能轻松实现序列化操作。 序列化操作，使用 dump 方法即可</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">result = schema.dump(users, <span class="attribute">many</span>=<span class="literal">True</span>)</span><br><span class="line"><span class="builtin-name">print</span>(<span class="string">'result'</span>, result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">result</span> <span class="selector-attr">[&#123;<span class="string">'age'</span>: 23, <span class="string">'name'</span>: <span class="string">'Germey'</span>&#125;, &#123;<span class="string">'age'</span>: 20, <span class="string">'name'</span>: <span class="string">'Mike'</span>&#125;]</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>由于是 List，所以 dump 方法需要加一个参数 many 为 True。 当然对于单个对象，直接使用 dump 同样是可以的：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">result = schema.dump(user)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">'result'</span>, result)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight puppet">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">result</span> &#123;<span class="string">'name'</span>: <span class="string">'Germey'</span>, <span class="string">'age'</span>: <span class="number">23</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样的话，单个、多个对象的序列化也不再是难事。 经过上面的操作，我们完成了 object 到 dict 或 list 的转换，即：</p>
                  <figure class="highlight ocaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">object</span> &lt;-&gt; dict</span><br><span class="line">objects &lt;-&gt; <span class="built_in">list</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2>
                  <p>当然，上面的功能其实并不足以让你觉得 marshmallow 有多么了不起，其实就是一个对象到基本数据的转换嘛。但肯定不止这些，marshmallow 还提供了更加强大啊功能，比如说验证，Validation。 比如这里我们将 age 这个字段设置为 hello，它无法被转换成数值类型，所以肯定会报错，样例如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Germey'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="string">'hello'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    schema = UserSchema()</span><br><span class="line">    user, errors = schema.load(data)</span><br><span class="line">    print(user, errors)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">'e.message'</span>, e.messages)</span><br><span class="line">    print(<span class="string">'e.valid_data'</span>, e.valid_data)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里如果加载报错，我们可以直接拿到 Error 的 messages 和 valid_data 对象，它包含了错误的信息和正确的字段结果，运行结果如下：</p>
                  <figure class="highlight puppet">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">e.<span class="keyword">message</span> &#123;<span class="string">'age'</span>: [<span class="string">'Not a valid integer.'</span>]&#125;</span><br><span class="line"><span class="keyword">e</span>.<span class="keyword">valid_data</span> &#123;<span class="string">'name'</span>: <span class="string">'Germey'</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>因此，比如我们想要开发一个功能，比如用户注册，表单信息就是提交过来的 data，我们只需要过一遍 Validation，就可以轻松得知哪些数据符合要求，哪些不符合要求，接着再进一步进行处理。 当然验证功能肯定不止这一些，我们再来感受一下另一个示例：</p>
                  <figure class="highlight xquery">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from pprint <span class="keyword">import</span> pprint</span><br><span class="line">from marshmallow <span class="keyword">import</span> Schema, fields, <span class="keyword">validate</span>, ValidationError</span><br><span class="line"></span><br><span class="line">class UserSchema(Schema):</span><br><span class="line">   <span class="built_in"> name</span> = fields.Str(<span class="keyword">validate</span>=<span class="keyword">validate</span>.Length<span class="built_in">(min</span>=<span class="number">1</span>))</span><br><span class="line">    permission = fields.Str(<span class="keyword">validate</span>=<span class="keyword">validate</span>.OneOf([<span class="string">'read'</span>, <span class="string">'write'</span>, <span class="string">'admin'</span>]))</span><br><span class="line">    age = fields.Int(<span class="keyword">validate</span>=<span class="keyword">validate</span>.Range<span class="built_in">(min</span>=<span class="number">18</span>,<span class="built_in"> max</span>=<span class="number">40</span>))</span><br><span class="line"></span><br><span class="line">in_data = &#123;<span class="string">'name'</span>: <span class="string">''</span>, <span class="string">'permission'</span>: <span class="string">'invalid'</span>, <span class="string">'age'</span>: <span class="number">71</span>&#125;</span><br><span class="line">try:</span><br><span class="line">    UserSchema().load(in_data)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> err:</span><br><span class="line">    pprint(err.messages)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>比如这里的 validate 字段，我们分别校验了 name、permission、age 三个字段，校验方式各不相同。 如 name 我们要判断其最小值为 1，则使用了 Length 对象。permission 必须要是几个字符串之一，这里又使用了 OneOf 对象，age 又必须是介于某个范围之间，这里就使用了 Range 对象。 下面我们故意传入一些错误的数据，看下运行结果：</p>
                  <figure class="highlight applescript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;'age': ['Must be <span class="keyword">greater than</span> <span class="keyword">or</span> <span class="keyword">equal</span> <span class="keyword">to</span> <span class="number">18</span> <span class="keyword">and</span> <span class="keyword">less than or equal</span> <span class="keyword">to</span> <span class="number">40.</span>'],</span><br><span class="line"> '<span class="built_in">name</span>': ['Shorter than minimum <span class="built_in">length</span> <span class="number">1.</span>'],</span><br><span class="line"> 'permission': ['Must be one <span class="keyword">of</span>: <span class="built_in">read</span>, <span class="built_in">write</span>, admin.']&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，这里也返回了数据验证的结果，对于不符合条件的字段，一一进行说明。 另外我们也可以自定义验证方法：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from marshmallow import Schema, fields, ValidationError</span><br><span class="line"></span><br><span class="line">def validate<span class="constructor">_quantity(<span class="params">n</span>)</span>:</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">0</span>:</span><br><span class="line">        raise <span class="constructor">ValidationError('Quantity <span class="params">must</span> <span class="params">be</span> <span class="params">greater</span> <span class="params">than</span> 0.')</span></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">30</span>:</span><br><span class="line">        raise <span class="constructor">ValidationError('Quantity <span class="params">must</span> <span class="params">not</span> <span class="params">be</span> <span class="params">greater</span> <span class="params">than</span> 30.')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">ItemSchema(Schema)</span>:</span><br><span class="line">    quantity = fields.<span class="constructor">Integer(<span class="params">validate</span>=<span class="params">validate_quantity</span>)</span></span><br><span class="line"></span><br><span class="line">in_data = &#123;'quantity': <span class="number">31</span>&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="constructor">ItemSchema()</span>.load(in_data)</span><br><span class="line">except ValidationError <span class="keyword">as</span> err:</span><br><span class="line">    print(err.messages)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>通过自定义方法，同样可以实现更灵活的验证，运行结果：</p>
                  <figure class="highlight prolog">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;<span class="string">'quantity'</span>: [<span class="string">'Quantity must not be greater than 30.'</span>]&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>对于上面的例子，还有更优雅的写法：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from marshmallow import fields, Schema, validates, ValidationError</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">ItemSchema(Schema)</span>:</span><br><span class="line">    quantity = fields.<span class="constructor">Integer()</span></span><br><span class="line"></span><br><span class="line">    @validates('quantity')</span><br><span class="line">    def validate<span class="constructor">_quantity(<span class="params">self</span>, <span class="params">value</span>)</span>:</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            raise <span class="constructor">ValidationError('Quantity <span class="params">must</span> <span class="params">be</span> <span class="params">greater</span> <span class="params">than</span> 0.')</span></span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">30</span>:</span><br><span class="line">            raise <span class="constructor">ValidationError('Quantity <span class="params">must</span> <span class="params">not</span> <span class="params">be</span> <span class="params">greater</span> <span class="params">than</span> 30.')</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>通过定义方法并用 validates 修饰符，使得代码的书写更加简洁。</p>
                  <h2 id="必填字段"><a href="#必填字段" class="headerlink" title="必填字段"></a>必填字段</h2>
                  <p>如果要想定义必填字段，只需要在 fields 里面加入 required 参数并设置为 True 即可，另外我们还可以自定义错误信息，使用 error_messages 即可，例如：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields, ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span><span class="params">(Schema)</span>:</span></span><br><span class="line">    name = fields.String(required=<span class="literal">True</span>)</span><br><span class="line">    age = fields.Integer(required=<span class="literal">True</span>, error_messages=&#123;<span class="string">'required'</span>: <span class="string">'Age is required.'</span>&#125;)</span><br><span class="line">    city = fields.String(</span><br><span class="line">        required=<span class="literal">True</span>,</span><br><span class="line">        error_messages=&#123;<span class="string">'required'</span>: &#123;<span class="string">'message'</span>: <span class="string">'City required'</span>, <span class="string">'code'</span>: <span class="number">400</span>&#125;&#125;,</span><br><span class="line">    )</span><br><span class="line">    email = fields.Email()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = UserSchema().load(&#123;<span class="string">'email'</span>: <span class="string">'foo@bar.com'</span>&#125;)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> err:</span><br><span class="line">    pprint(err.messages)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="默认字段"><a href="#默认字段" class="headerlink" title="默认字段"></a>默认字段</h2>
                  <p>对于序列化和反序列化字段，marshmallow 还提供了默认值，而且区分得非常清楚！如 missing 则是在反序列化时自动填充的数据，default 则是在序列化时自动填充的数据。 例如：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"><span class="keyword">import</span> datetime <span class="keyword">as</span> dt</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">UserSchema</span>(<span class="type">Schema</span>):</span></span><br><span class="line"><span class="class">    id = fields.<span class="type">UUID</span>(<span class="title">missing</span>=<span class="title">uuid</span>.<span class="title">uuid1</span>)</span></span><br><span class="line"><span class="class">    birthdate = fields.<span class="type">DateTime</span>(<span class="title">default</span>=<span class="title">dt</span>.<span class="title">datetime</span>(2017, 9, 29))</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">print(<span class="type">UserSchema</span>().load(&#123;&#125;))</span></span><br><span class="line"><span class="class">print(<span class="type">UserSchema</span>().dump(&#123;&#125;))</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们都是定义的空数据，分别进行序列化和反序列化，运行结果如下：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;'id': UUID('06aa384a-570c-11ea-<span class="number">9869</span>-a<span class="number">0999</span>b0d<span class="number">6843</span>')&#125;</span><br><span class="line">&#123;'birthdate': '<span class="number">2017-09-29</span>T00:00:00'&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，在没有真实值的情况下，序列化和反序列化都是用了默认值。 这个真的是解决了我之前在 cattrs 序列化和反序列化时候的痛点啊！</p>
                  <h2 id="指定属性名"><a href="#指定属性名" class="headerlink" title="指定属性名"></a>指定属性名</h2>
                  <p>在序列化时，Schema 对象会默认使用和自身定义相同的 fields 属性名，当然也可以自定义，如：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">class UserSchema(Schema):</span><br><span class="line">    name = fields.String()</span><br><span class="line">    email_addr = fields.String(<span class="attribute">attribute</span>=<span class="string">'email'</span>)</span><br><span class="line">    date_created = fields.DateTime(<span class="attribute">attribute</span>=<span class="string">'created_at'</span>)</span><br><span class="line"></span><br><span class="line">user = User(<span class="string">'Keith'</span>, <span class="attribute">email</span>=<span class="string">'keith@stones.com'</span>)</span><br><span class="line">ser = UserSchema()</span><br><span class="line">result, errors = ser.dump(user)</span><br><span class="line">pprint(result)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;'name': 'Keith',</span><br><span class="line"> 'email_addr': 'keith@stones.com',</span><br><span class="line"> 'date_created': '<span class="number">2014-08-17</span>T14:58:57.<span class="number">600623</span>+00:00'&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>反序列化也是一样，例如：</p>
                  <figure class="highlight kotlin">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span></span>(Schema):</span><br><span class="line">    name = fields.String()</span><br><span class="line">    email = fields.Email(load_from=<span class="string">'emailAddress'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Mike'</span>,</span><br><span class="line">    <span class="string">'emailAddress'</span>: <span class="string">'foo@bar.com'</span></span><br><span class="line">&#125;</span><br><span class="line">s = UserSchema()</span><br><span class="line">result, errors = s.load(<span class="keyword">data</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;<span class="string">'name'</span>: <span class="string">u'Mike'</span>,</span><br><span class="line"> <span class="string">'email'</span>: <span class="string">'foo@bar.com'</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="嵌套属性"><a href="#嵌套属性" class="headerlink" title="嵌套属性"></a>嵌套属性</h2>
                  <p>对于嵌套属性，marshmallow 当然也不在话下，这也是让我觉得 marshmallow 非常好用的地方，例如：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="title">from</span> marshmallow <span class="keyword">import</span> Schema, fields, pprint</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">ArtistSchema</span>(<span class="type">Schema</span>):</span></span><br><span class="line"><span class="class">    name = fields.<span class="type">Str</span>()</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">AlbumSchema</span>(<span class="type">Schema</span>):</span></span><br><span class="line"><span class="class">    title = fields.<span class="type">Str</span>()</span></span><br><span class="line"><span class="class">    release_date = fields.<span class="type">Date</span>()</span></span><br><span class="line"><span class="class">    artist = fields.<span class="type">Nested</span>(<span class="type">ArtistSchema</span>())</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">bowie = dict(<span class="title">name</span>='<span class="type">David</span> <span class="type">Bowie</span>')</span></span><br><span class="line"><span class="class">album = dict(<span class="title">artist</span>=<span class="title">bowie</span>, <span class="title">title</span>='<span class="type">Hunky</span> <span class="type">Dory</span>', <span class="title">release_date</span>=<span class="title">date</span>(1971, 12, 17))</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">schema = <span class="type">AlbumSchema</span>()</span></span><br><span class="line"><span class="class">result = schema.dump(<span class="title">album</span>)</span></span><br><span class="line"><span class="class">pprint(<span class="title">result</span>, <span class="title">indent</span>=2)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就能充分利用好对象关联外键来方便地实现很多关联功能。 以上介绍的内容基本算在日常的使用中是够用了，当然以上都是一些基本的示例，对于更多功能，可以参考 marchmallow 的官方文档：<a href="https://marshmallow.readthedocs.io/en/stable/，强烈推荐大家用起来" target="_blank" rel="noopener">https://marshmallow.readthedocs.io/en/stable/，强烈推荐大家用起来</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-02-25 01:21:41" itemprop="dateCreated datePublished" datetime="2020-02-25T01:21:41+08:00">2020-02-25</time>
                </span>
                <span id="/8943.html" class="post-meta-item leancloud_visitors" data-flag-title="Python 序列化和反序列化库 MarshMallow 的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8939.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 福利专区 <i class="label-arrow"></i>
                  </a>
                  <a href="/8939.html" class="post-title-link" itemprop="url">东鸽送3台｜做开发没有云服务器怎么行？</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>随着云计算和虚拟技术的发展，主机业务从虚拟主机逐步发展到独享云服务器。我们 IT 人对服务器的需求是很强烈的，无论你是后端研发、前端开发、云计算、大数据、架构、数据存储、运维还是产品经理，每个人手上多多少少都会有几台云服务器。 <img src="http://can.sfhfpc.com/sfhfpc/20200220191443.jpg" alt=""> 这些云服务器被用做测试用机、学习用机或者正式生产用机，有些朋友会在上面搭建博客，有些朋友在上面搭建 API。东鸽自己也手握几台服务器： <img src="http://can.sfhfpc.com/sfhfpc/20200220182953.jpg" alt=""> 其中有 3 台用作实际的生产，新书《<a href="https://item.jd.com/12794078.html" target="_blank" rel="noopener">Python3 反爬虫原理与绕过实战</a>》的<a href="http://www.porters.vip/" target="_blank" rel="noopener">在线练习平台</a>、<a href="https://bbs.nightteam.cn/" target="_blank" rel="noopener">夜幕爬虫安全论坛</a>和我的<a href="http://www.sfhfpc.com/" target="_blank" rel="noopener">个人博客</a>。另外几台用来做测试、数据合作和练习。 练习的话，像平时学习 MongoDB 数据库、Redis 数据库和 Mysql 数据库的时候，我会在服务器上安装对应的应用，启动服务后在自己的电脑上连接，这样能得到与生产环境一样的体验。学习 Linux 和 Shell 脚本的时候也会用云服务器进行练习，这样既能够确保练习效果，又避免了对本机电脑的干扰。 <strong>你总不能在自己的电脑上折腾来折腾去吧，万一搞坏了，工作咋办？</strong> 数据合作，那是个人业务上的事了。数据用云端数据库的方式交付给客户，不需要其他传输媒介，轻便快捷，没有延时风险。我这边把数据存储到服务器，客户从服务器上拉取数据。 <img src="https://www.rabbitmq.com/img/tutorials/python-one.png" alt=""> <strong>一个普通的生产者消费者模式就诞生了。</strong>如果数据业务体量比较大，或者说数据业务的出口比较多，那我可能会借用消息中间件来进行调节。 <img src="https://www.rabbitmq.com/img/tutorials/python-four.png" alt=""> 为了保证数据的完整性和可用性，我可能会对服务器进行镜像，那么我就需要 2～3 台服务器。假设每台服务器的成本是 300元/年，数据合作业务的收入是 3W/年，那真是四两拨千斤了。 要合理利用资源，让资源为我们生<strong>小钱钱</strong>！ 服务器配置跟具体业务需求有关，用于测试的服务器通常是 1 核 2G 1M；博客和论坛的服务器带宽稍大一些，带宽通常是 3M ；用于数据合作的服务器内存较大，一般需要为 4G～8G； 除了服务器之外，<strong>华为云</strong>还有很多<strong>神奇的业务</strong>。我觉得<strong>黑科技</strong>真的是太多了。 <img src="https://www.huaweicloud.com/content/dam/cloudbu-site/archive/china/zh-cn/product/enterprise_intelligence/modelarts/images/modelarts-learn-slide1.png" alt=""> 上次我用华为云的深度学习一体化服务 ModelArts 在线实现了图像深度学习中的图片标注、图片分类预测和模型部署+生成 API，感觉很流畅。 <img src="http://can.sfhfpc.com/sfhfpc/20200221172409.jpg" alt=""> 鼠标点点点，配置一丢丢参数，也不用自己写代码，也不用弄 Web 框架，唰唰唰地几下，就可以调用了。 崔庆才崔哥用 ModelArts 实现了爬虫工程师常用到的拼图验证码缺口识别 API。 <img src="http://can.sfhfpc.com/sfhfpc/20200221172230.jpg" alt=""> 样本准备了小小几十个，训练完成后的识别准确率很高，这样我们就不用担心缺口位置定位的问题了。 <img src="http://can.sfhfpc.com/sfhfpc/20200221172556.jpg" alt=""> 服务器数量多，开销自然就大。如无必要，通常我是不会购买服务器的，但每当云服务器厂商有活动时我都会做一些购买计划。例如我今年打算增加数据业务，并且学习架构方面的知识，那我至少得再买 5 台服务器。趁着华为开年采购季活动，购买一台服务器的成本最低 79元/年。除此之外，华为云还有数据库专场活动、域名建站专场活动、云安全专场活动在等着我们，买买买！ <img src="http://can.sfhfpc.com/sfhfpc/20200220185546.jpeg" alt=""> 大家相识已久，东鸽感谢大家关注和支持，这次华为云开年采购季活动我自掏腰包购买 3 台 1 核 2G 1M 的服务器（1年期）送给各位粉丝。大家扫码即可参与抽奖，到期自动开奖。 <strong>参与要求</strong>：参与活动时必须转发上方华为云开年采购季海报，领奖时小编会检查的哦。 <img src="http://can.sfhfpc.com/sfhfpc/20200220190807.jpeg" alt=""></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-02-24 10:06:03" itemprop="dateCreated datePublished" datetime="2020-02-24T10:06:03+08:00">2020-02-24</time>
                </span>
                <span id="/8939.html" class="post-meta-item leancloud_visitors" data-flag-title="东鸽送3台｜做开发没有云服务器怎么行？" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8893.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/8893.html" class="post-title-link" itemprop="url">推荐个好用的书签工具</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>今天刚发现了一个我觉得不错的工具，介绍给大家，不是打广告哈，是真心推荐。 在推荐之前，问大家一个问题：</p>
                  <ul>
                    <li>大家平常遇到不错的网站或文章，会用什么方式收藏？Chrome 书签？</li>
                    <li>现在你们 Chrome 书签里面啥样子？乱不乱？</li>
                    <li>如果我让你们快速从书签里面找出一个曾经收藏过网站，你要花多久？</li>
                    <li>如果你在手机上用其他的浏览器，比如 Safari、微博上看到了一个不错的网站，怎么存？</li>
                    <li>存到了 Safari 上面，又怎么和电脑上的 Chrome 书签合并？之后还能找到吗？</li>
                  </ul>
                  <p>在这个终身学习的时代，我们需要保存和收藏的东西太多太多了。好的网站，好的博文，好的软件，都需要存下来。那么怎么存？这是个问题。 我最早也用过 Chrome 书签，但是这有个毛病，怎么全平台同步？我想在手机（iPhone）上看我的书签内容，难道我还要专门下个 Chrome？另外书签的整理和搜索也是个问题，实在是让我喜欢不起来。 我在选择软件都会追求全平台云同步。比如时间规划软件，我会用「滴答清单」；SSH 软件，我会用「Termius」；翅膀软件我会用「Surge」，为的都是解决一些跨终端问题，它们都是 iPhone、iPad、Mac、Windows、Web 全部平台同步的，有的甚至还支持浏览器插件或者 Apple Watch 等等，这样我们不论切换到哪个终端，都会非常方便地同步数据。</p>
                  <h2 id="Pocket"><a href="#Pocket" class="headerlink" title="Pocket"></a>Pocket</h2>
                  <p>所以，对于上面说的这个问题，怎么来收藏链接，有什么好用的 App 呢？这个最初是选择了「Pocket」。 <img src="https://qiniu.cuiqingcai.com/2020-02-03-142941.png" alt="image-20200203222939945"> 「Pocket」这个软件有一个不错的特性，那就是跨平台，我可以在浏览器、Mac、iPhone、iPad 上使用，看到不错的网站，调出插件或者点击「分享到 Pocket」就可以存进去了，这样就解决了多平台同步问题，另外 「Pocket」还能设置一些标签等等，然后每周或定期我再翻出来整理整理。 说实话，我用「Pocket」好几年了，但总觉得一直达不到我心中完美的标准，怎么说呢？下面总结一下：</p>
                  <h3 id="跨平台"><a href="#跨平台" class="headerlink" title="跨平台"></a>跨平台</h3>
                  <p>跨平台的支持确实挺好的，这也是我选择「Pocket」的重要原因，支持 Web、Mac、Windows、iPhone、iPad 、Android 各大平台，另外还提供了多款浏览器插件，全平台同步。 光这一点就干倒了很多竞争者了。 然而，不好的也有很多。</p>
                  <h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3>
                  <p>首先，Mac 的界面太丑了，多少年了，我一直盼着能改好看点，结果界面一直没有大的改观。这谁受得住啊？ 截图看看： <img src="https://qiniu.cuiqingcai.com/2020-02-03-113030.png" alt="image-20200203193029173"> 哎，一眼难尽啊，左边浓浓的拟物化风格，右边自作聪明出了个阅读模式，也就是自动提取正文内容，结果把文章格式整的这么乱。</p>
                  <h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3>
                  <p>怎么说呢？其实不能追求太多，我最初也只是想找一个存书签的软件。但它的一些分类和标签做的体验并不友好。另外如果我想存文件、存图片，那几乎是不可能的了。 另外这个页面布局吧，实在是让我难以恭维。我不能一目了然地看到我的所有分类和分类层级、标签等等内容。 另外「Pocket」里面还增加了「发现」、「活动」、「资料」三个选项卡，总体来说有点社交性质，它让我去关注点别人，然后看到别人的收藏动态，其中两个选项卡几乎都是常年没啥有效内容的，觉得这些功能有点鸡肋，不足以上升到能和我的收藏列表一个级别。所以我基本上就只开第一个选项卡「我的列表」，只有这里才是我真正想要的收藏列表。 看下图吧，只有第一个选项卡才是收藏列表，第二个就是「发现」，第三个「活动」，最后一个「资料」，后三个基本上没啥卵用，没关注几个人，第三个基本上是常年空着的状态。 <img src="https://qiniu.cuiqingcai.com/2020-02-03-144032.png" alt="IMG_2326"> 所以说，这软件的界面、操作和功能，只能说我不喜欢。不喜欢就不要将就，我将就了这么久，最后还是要放弃它。</p>
                  <h2 id="Raindrop-io"><a href="#Raindrop-io" class="headerlink" title="Raindrop.io"></a>Raindrop.io</h2>
                  <p>所以近期我就一直在找一款能替换掉「Pocket」的纯粹的内容收集软件，这么几个原则吧：</p>
                  <ul>
                    <li>跨平台，必须支持所有终端，包括 Windows、Mac、iPhone、iPad、Android、Web 并提供各个浏览器插件。</li>
                    <li>功能明确，能方便地管理分类、标签、收藏等内容，且不要有一些其他鸡肋的功能。</li>
                    <li>好看，好看，好看！我还是很注重界面和美观的，不论是图标还是内页，不优雅的界面会让我觉得很不爽。（之前找软件的时候因为某些软件的图标设计得不好看而被我 Pass 了）。</li>
                  </ul>
                  <p>好了，搜啊搜，找到这么一款软件—— Raindrop.io，感觉不错，看到首页的介绍，被吸引到了！ <img src="https://qiniu.cuiqingcai.com/2020-02-03-143755.png" alt=""> 大家可以看视频来感受一下：<a href="https://up.raindrop.io/web/marketing/intro.mp4" target="_blank" rel="noopener">https://up.raindrop.io/web/marketing/intro.mp4</a> 可以说首先界面真的吸引到我了，而且左侧的导航分类、收藏夹的管理非常清晰，页面布局也很清晰，甚至支持文件、图片等格式的收藏！另外它同样也支持全平台，完全符合我的需求。 然后我就下载下来了各个平台都试了试，首先试了试它的一些基础功能，比如收藏夹的管理，然后添加上一些不错的内容。 初步整理成下图这么个样子： <img src="https://qiniu.cuiqingcai.com/2020-02-03-141955.png" alt="image-20200203221953942"> 另外内容还支持各种其他的布局，如列表式： <img src="https://qiniu.cuiqingcai.com/2020-02-03-142113.png" alt="image-20200203222112657"> 瀑布流式： <img src="https://qiniu.cuiqingcai.com/2020-02-03-135545.png" alt="image-20200203215543721"> 舒服了。 说回功能，这里我先分了几个分组，为「网站」、「代码」、「图片」，我估计我用到的最多的肯定是「网站」这个分组，用来存各种链接的，「代码」和「图片」是为了测试它的上传文件和图片功能而加的，可以用来存代码文件和图片。 分组建好之后，我们可以在分组里面添加收藏夹，看图里面每行前面有个小图标的就是一个收藏夹。没错，每个收藏夹都可以自定义它的小图标，这个功能真的是增色不少！ 它提供了非常多的小图标，看： <img src="https://qiniu.cuiqingcai.com/2020-02-03-140212.png" alt="image-20200203220210879"> 这个功能，我觉得简直不能更赞！另外这些小图标还可以自己上传，所以你看图里面的 GitHub 图标、Python 图标，都是我从 icons8 上面找到并上传的，毫无违和感！ 另外每一个收藏它都会自动生成一张封面图，会自动截取网站当前页面的内容，或者也可以自定义上传图片或者自定义截屏，最后每个收藏项都会变成一张张卡片。 当然添加标签页不在话下。 <img src="https://qiniu.cuiqingcai.com/2020-02-03-143951.png" alt="image-20200203220829929"> 另外浏览器的插件也做的很精致，提供了 Mini Application 和极简模式，收藏一个页面只需要点一下这个图标就收藏好了。如果是高级版的账号，还支持自动分类。 <img src="https://qiniu.cuiqingcai.com/2020-02-03-141017.png" alt="image-20200203221016017"> 手机和 iPad 上面的软件我也试了，功能基本类似。怎么保存呢？比如我的 iPhone 上可以把这个软件放到分享的 App 列表里面，这样在浏览器里面点击「分享」，然后选「Raindrop.io」就好了，它会自动弹出一个窗口，让我们选择分类或加标签，体验很不错。 <img src="https://qiniu.cuiqingcai.com/2020-02-03-141751.png" alt="IMG_2327"> 嗯，总之整体体验下来，非常好用。 另外它还支持自动导入书签或从其他的收藏软件里面迁移，大家如果一些网站保存在书签里面的话，如果用了这个，可以快速导入进来，非常方便！ <img src="https://qiniu.cuiqingcai.com/2020-02-03-142317.png" alt="image-20200203222316105"> 另外还有一些高级的功能大家再探索吧。怎么感觉越写越像个广告文了，但确实这不是广告文，它确实很好用，在这强推给大家！希望它能帮助大家方便管理各种资源，什么博客、公众号、干货、微博、图片、文件统统可以保存到这里并明确清晰地归类啦！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-02-10 01:37:28" itemprop="dateCreated datePublished" datetime="2020-02-10T01:37:28+08:00">2020-02-10</time>
                </span>
                <span id="/8893.html" class="post-meta-item leancloud_visitors" data-flag-title="推荐个好用的书签工具" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8891.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 个人随笔 <i class="label-arrow"></i>
                  </a>
                  <a href="/8891.html" class="post-title-link" itemprop="url">关于开会的一些思考</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>今天一个偶然的机会，在群里看到了一个推送，是来自一个软件「飞书」的公开课，它讲如何使用飞书，以及如何提高团队的协作效率，我就去听了一下。 头条是飞书开发的，整个 Talk 其实讲了挺多的关于飞书的使用，其实和很多软件的功能大体上是相同的，如文件共享、文档协作、任务分配、聊天沟通等等，像行业内挺多软件，如 Worktile、TAPD、Teambition 等等也都比较完善了，所以一些类似的功能我就不展开说了。 不过其中有一个点，让我听了之后深受启发，那就是如何提高开会效率。 我也参加过很多会议了，包括研究生期间跟着导师出去汇报、开实验室小组会或者公司内部开大会。其中有的内容是讨论具体的实施方案，有的一些时候是单纯的分享或者 sync 进度。对于后者的话，其实没什么问题，就是一个人分享或者快速跟其他人沟通，我想大部分情况下大家都是类似的。但是对于前者，我就觉得一些会议效率太低了，甚至说价值并不高，那么这里就主要说说这种会议。 比如有些会议，尤其是大会，比如十几二十人围在一起开会讨论方案，参与的人很多很杂，有的人甚至还是和会议相关度不高的人或者本身对会议主题完全不了解的人。这时候可能有一个人主持会先说说这个会是干嘛的，开这个会要讨论点什么，说了十分钟之后，一些人才大体上明白这个会在做什么。然后后面就是后面开始讨论方案了，大家也没有整个的时间把控，不知道一共可能讨论多久，大家你一句我一句，有时候扯着扯着扯远了，最后一个会能开上一个半甚至两个多小时，然后会议结束了之后，大家又接着去干活去了。过了一阵子或者几天，想回想一下当时会上到底是怎么说的或者讨论了什么方案，很可能就忘了。如果当时会上有专门做会议纪要的人，那还 OK，如果没有，那这么多人过了一段时间，具体会上说了那些有用的东西或者最后采取了什么方案具体怎么实施呢？很可能就是两个字：忘了。另外，有些人可能整个会上一句话也没说，完全感觉不到任何参与感，所以他也就越来越觉得这个会议没有什么意义，甚至可能就在会上就睡着了。 我想工作的各位难免会遇到这样的问题，或者甚至大家的会议现状就是这样子的。我之前也一直觉得，这种会议模式其实挺病态的，在时间这么宝贵的今天，到底有没有一个比较好的开会方式呢？ 今天听了这个分享之后，我确实被其中所讲的一个会议模式吸引到了。 怎么个方式呢？这里我就根据自己的理解大体概括一下。</p>
                  <h2 id="提前准备"><a href="#提前准备" class="headerlink" title="提前准备"></a>提前准备</h2>
                  <p>会议的组织者，在开会之前，根据会议的适用场景，列好这个会议想要讨论的内容，以文档的形式写下来。比如要开发一个软件，那么可能就列出来其中的交互或实现方案。如果是要讨论一个解决方案，那就把已经想到的解决方案写下来。 然后呢，很重要的，在开会之前，把文档都发给大家，比如附在邮件链接里面，大家都可以下载或者在线查看。这样可以让大家提前对会议的内容有所了解，如果是对会议毫不了解的人，也能对会议的主题有个整体的把握。 这样就不会出现这样的情况了： 咦，来了一个会啊，咋叫上我了？这个会到底干嘛的？写的这个主题到底啥意思？我去了能干啥？ 这就是其一，提前准备，让所有人都有所了解。 另外，每个人知道主题和讨论内容了，也就知道自己需要准备什么东西，哪些需要演示，哪些需要重点讲解。</p>
                  <h2 id="阅读及评论"><a href="#阅读及评论" class="headerlink" title="阅读及评论"></a>阅读及评论</h2>
                  <p>这个环节也很新颖和高效。 在会议开始的时候，前 15 分钟（时间视情况而定），没有任何人讲话！注意是没有任何人讲话！ 那么大家做什么？看文档！ 大家会在这前 15 分钟里面仔细阅读文档和思考。由于文档是共享的，可以在线协作编辑的，每个人都可以在上面写 Comments，比如提意见或者提想法。由于大家都登录了自己的账户，所以谁提的 Comments，所有人都一清二楚，而且可以实时看到。 就类似下图的这种感觉，见图右侧的 Comments。 <img src="https://qiniu.cuiqingcai.com/2020-02-05-151914.png" alt="image-20200205231912431"> 然后 15 分钟过后，大家会针对大家疑虑的点进行讨论。 注意，由于有了 Comments，大家就知道一共有多少需要讨论的点，这个会还剩余多久，每个 Comment 可以讨论多长时间，这样又避免了开会时间无节制的问题。 然后还有一个重要的点，就是每讨论完一个 Comment，就在对应的地方写上解决方案或者附上 Todo List，即具体的实施措施，做到当场讨论问题、当场提出解决方案、当场分配任务计划。 OK，然后整个会就很有目标地开完了，很有侧重点，而且大家都清除的就不需要讨论了。 另外还有一个优点就是，每个人都可以提 Comments，这样每个人都会感到极强的参与感，再也不会出现会上一言不发事不关己高高挂起的状态了。</p>
                  <h2 id="会后"><a href="#会后" class="headerlink" title="会后"></a>会后</h2>
                  <p>由于采取了前面的两步措施，所以会后也就更方便了。 整个会议的纪要在哪里？就是之前的文档里。 整个会议关键的点在哪里？都在 Comments 和对应的回复里。 整个会议讨论出了什么计划？当场也已经分配好了，大家会后直接根据会上分配的 Todo 去做就好了，分配的任务会自动加到每个人的 Todo List 里面。 过了几天，我想复盘整个会议或者回想下这个会议说了些啥，怎么办？直接打开会议文档就好了。 还需要专门写会议纪要的吗？会上大家共同协作会议文档，已经都写好了。 嗯，这就是整个会议的模式。 节省了多少时间或者避免了什么问题呢？我们数数吧。</p>
                  <ul>
                    <li>每个人在会前都可以对会议提前了解和准备，每个人的了解和准备都会更充分。</li>
                    <li>开会前半段每个人都会有单独的时间去理解和思考并做评论。</li>
                    <li>每个人都会有极强的参与感。</li>
                    <li>根据大家评论的数量来把握整个开会的节奏，减少了拖延的概率。</li>
                    <li>会上当场确定好解决方案和人员，自动同步到每个人的 Todo 列表。</li>
                    <li>会后随时查看，随时复盘。</li>
                    <li>文档记录，永不丢失遗忘。</li>
                  </ul>
                  <p>真的可以说，这个模式我觉得非常好，大幅提高了开会的效率，节省了时间。 这个模式我听 Talk 里面说已经在诸如头条的公司里面用了很久了，很多人都反馈很不错。飞书在这方面的支持已经做得挺好了，但可能很多公司不用飞书，不过现在还有很不错的在线协作文档，比如 石墨文档、Pages、Worktile、OneNote 等等也都可以成为候选方案，这个模式还是完全可以借鉴的。 以上仅是我的一点总结和思考，希望对大家有所启发，谢谢！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-02-10 01:34:12" itemprop="dateCreated datePublished" datetime="2020-02-10T01:34:12+08:00">2020-02-10</time>
                </span>
                <span id="/8891.html" class="post-meta-item leancloud_visitors" data-flag-title="关于开会的一些思考" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8889.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 个人随笔 <i class="label-arrow"></i>
                  </a>
                  <a href="/8889.html" class="post-title-link" itemprop="url">2020 才过去了一个多月，世界都发生了些什么</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>有人说：2019 年可能是过去十年里最坏的一年，但可能是未来十年里最好的一年。 的确 2019 整个大环境确实比较差，很多人可能在 2020，这个新的一个十年的开端，许愿接下来的日子能慢慢好起来。但目前的状况，大家可能都看到了，新型冠状病毒的肆虐，让全国都变成了什么样子。在国内，新型冠状病毒相关的态势一直最近的头条，但可能大家并没有注意到，其实世界各地都似乎不怎么太平，如。而看看时间，2020 才过去了一个多月而已。</p>
                  <h2 id="中国"><a href="#中国" class="headerlink" title="中国"></a>中国</h2>
                  <p>不知道大家是不是和我一样，起床醒来的第一件事就是去查一查现在国内新型冠状病毒的确诊人数。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-131059.png" alt="image-20200209211057573"> 截止今天（2 月 9 日）晚上 9 点，全国确诊病例达到 37289 例，疑似病例 28942 例，每天还以好几千的数量增加，估计明天早上能突破 4 万。 全国 31 个省区均早已经启动了一级响应，这在过去是从未有过的，随着病毒的传播蔓延，事态的严重性远远超出人们最大胆的想象。现在国家正在举全国之力支援灾区，前线的医疗人员一直在全力以赴救治患者。全国各个地区也在采取可以说是历史上最严格的防疫措施，全国范围内的商场、餐厅、娱乐场所几乎都被关停，各家各户的居民也都在家隔离，企业也延迟复工或者到现在还有很多企业都没有正式复工，口罩物资都已经全网脱销，一罩难求。但没有办法，在这个非常时刻，只要我们每个人都尽上自己的所能，相信疫情肯定会慢慢控制下来，请相信我们的国家。 观察了几天，从数据上来看，可能有这么两个好消息： <img src="https://qiniu.cuiqingcai.com/2020-02-09-133307.png" alt="image-20200209213305882"></p>
                  <ul>
                    <li>一个是现在总的治愈人数已经超过死亡人数接近三倍，而且治愈人数的每日增长速度已经远超过死亡人数，比如今天的治愈人数就已经是死亡人数的大约 10 倍（891：90）。而且现在疫苗已经投入临床试验，相信接下来的治愈数据的增长液会越来越快。</li>
                    <li>新增的确诊和疑似人数出现缓和和下降迹象，至少从最近四天的数据上来看，能看出新增数量整体呈现下降的态势，今天刚刚也有新闻报道说全国除湖北外其他省份每日报告的确诊病例数从 2 月 3 日 890 例下降到 2 月 8 日的 509 例，下降幅度达到 42.8%，这表明各地联防联控机制以及严格管理等防控措施正在发挥作用。希望前几天数据最高的点，就是那个拐点吧。</li>
                  </ul>
                  <p>加油武汉，加油中国！💪</p>
                  <h2 id="美国"><a href="#美国" class="headerlink" title="美国"></a>美国</h2>
                  <p>可能我们大多数人关注更多的是国内的新型冠状病毒。但现在，美国其实也不太平。美国正在遭受近 10 年来最严重的流感疫情。 看图，这是美国疾病控制与预防中心网站上的流感活动地图，现在是 2 月 9 日周日，数据的统计是每周一次更新，当前更新到 2 月 1 日，数据来源链接见文末。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-135555.png" alt="image-20200209215553293"> CDC 称，在其流感活动地图上，美国大部分地区为深红色，表明「流感样疾病」活动水平达到最高级。由于美国的流感季还要持续一段时间，因此这一数据可能会继续上升。从地区上看，目前全美 50 个州里，有 48 个州出现流感疫情，其中 32 个州流感活动水平维持高位，人口稠密的纽约、华盛顿和加州无一幸免，纷纷中招。此次流感季将是10年来美国最严重的流感季之一，2019 - 2020 流感季中，美国 1900 万人感染流感，至少 1 万人死亡，包括 68 名儿童。预计流感季将持续至 5 月，而 2 月是高峰期。 我有几个亲戚朋友现在就住在美国，因为流感的问题，每天他们也是和我们一样，待在家里不敢出门，同样体会出来了 ”隔离“ 的滋味。</p>
                  <h2 id="澳洲"><a href="#澳洲" class="headerlink" title="澳洲"></a>澳洲</h2>
                  <p>澳洲最近同样也不太平。 之前大家可能有听说澳洲大火的消息，其实关于澳洲大火的报道，去年 10 月份开始就有了，本来大家以为只是一场普通的森林火灾，扑灭就完事了。我看最近有报道澳洲大火的消息的时候，很多人在底下评论，大火一直在烧啊？没错，这大火一直烧，四个月了，烧的时候澳洲的卫星地图状况就是这个样子： <img src="https://qiniu.cuiqingcai.com/2020-02-09-141721.jpg" alt="img"> 这场火，不仅造成人命伤亡及经济损失，也对自然生态带来毁灭性破坏，使数亿动物遭遇灭顶之灾。已有近 5 亿只动物死于澳洲山火，并据相关报道显示考拉或将功能性灭绝。悉尼大学发布报告，全国约有 10 亿动物被大火波及，其中仅在澳大利亚袋鼠岛的大火中就有超 2 万只考拉死亡，考拉将被列为濒危动物。澳大利亚全境被烧毁的森林面积约 1120万 公顷，而去年震惊世界的亚马孙雨林大火烧毁森林面积才约 180 万公顷。此外，有 1400多公里的海岸线都在燃烧，相当从东北烧到了江浙沪。 慢慢地，前几天，山火逐渐逼近了堪培拉。1 月 31 日，因为山火的步步紧逼，澳大利亚政府宣布堪培拉进入紧急状态，这是自 2003 年山火危机之后 17 年以来，堪培拉首次进入紧急状态。2 月 2 日整天，堪培拉均处于高度戒备状态。堪培拉和周边地区的气温一度超过 42 摄氏度。 当时堪培拉就是这么一个状态： <img src="https://qiniu.cuiqingcai.com/2020-02-09-142308.png" alt="image-20200209222306881"> 其他的地区山火基本是这么一个状态： <img src="https://qiniu.cuiqingcai.com/2020-02-09-142602.jpg" alt="img"> 以及那些被烧死的无辜的动物们： <img src="https://qiniu.cuiqingcai.com/2020-02-09-142729.jpg" alt="img"> 澳大利亚的这场大火也对全球造成了影响。欧洲哥白尼大气监测服务发表数据：澳大利亚已经向大气排放约 4 亿吨二氧化碳，这个数据比全球 116 个二氧化碳排放量最低国家年排放量总和还要高。 不过，就在最近几天，现在澳洲的山火由于一场暴雨的到来，很多地区的火已经灭了。但，这还没完，由于雨过大，洪水又来了。 据《每日邮报》2 月 9 日报道，近日，澳大利亚遭遇了十年来最大降雨，东海岸被大规模破坏，悉尼正在全力应对洪水爆发，火车站都变成了游泳池。澳大利亚气象局预计，在新南威尔士州北部的一些气象站在 48 小时内录得超过 300 毫米的降雨后，降雨将持续到周日。 据报道，周六，在新南威尔士州北部，67 岁的吉尔·萨瑟兰和她 30 岁的侄女汉娜驱车前往位于新南威尔士州北部河流地区的宁宾，途中他们穿过了一条被洪水淹没的道路。然而，他们很快就失去了对汽车的控制，车子灌满了水，沉了下去，完全从视线中消失了。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-143813.png" alt="image-20200209223811908"> 但好在，大火已经基本停了，但愿这次洪水也能尽快过去，祝好！</p>
                  <h2 id="巴西"><a href="#巴西" class="headerlink" title="巴西"></a>巴西</h2>
                  <p>当地时间 1 月 26 日，巴西东南部因受强风暴雨影响，正在遭遇百年不遇的泥石流灾害。 暴雨接连两日肆虐米纳斯吉拉斯州，导致多处房屋倒塌，道路摧毁，很多生命瞬间流逝。到目前为主，此次灾情至少已造成 46 人死亡，超过 25000 人流离失所。巴西国家气象研究所表示，这是自 110 年前开始有纪录以来，本地区降下的最猛烈暴雨。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-144450.png" alt="image-20200209224448748"> 军队现已对山区的村镇与交通设施展开全力救助，巴西政府也声称将努力建立一个全国性的灾害预防和早期预警系统。</p>
                  <h2 id="波兰、丹麦"><a href="#波兰、丹麦" class="headerlink" title="波兰、丹麦"></a>波兰、丹麦</h2>
                  <p>1 月 23 日，波兰海关总署发布消息。1 月 7 日，波兰官方向世界动物卫生组织通报，2019 年 12 月 31 日至 2020 年 1 月 4 日，该国卢布林省和大波兰省发生 8 起 H5N8 亚型高致病性禽流感。波兰是欧洲最大的家禽生产国，自2017 年以来从未爆发过禽流感。 1 月 30 日，丹麦环境和食品部向 OIE 紧急报告称，丹麦发生一起 H5N1 型低致病性禽流感疫情。本次疫情于 1 月 29 日得到确认，此次疫情可能导致多达 4 万只禽类被宰杀，方圆 3 公里多达 35 万只家禽受到威胁。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-145504.jpg" alt="img"></p>
                  <h2 id="法国、西班牙"><a href="#法国、西班牙" class="headerlink" title="法国、西班牙"></a>法国、西班牙</h2>
                  <p>1 月 21日，西班牙东北部地区遭强暴风和大雪袭击，供电中断，几十万人无电可用，暴风和大雪至少已造成 4 人死亡。阿联酋《宣言报》22 日报道称，由于暴风和降大雪，能见度很低，气温急速下降，达到结冰的程度，地中海沿岸海浪急剧上升。 西班牙紧急部门的报告表示，虽然与法国之间的供给线得到了修复，但因为积雪覆盖了2600多公里的道路，交通受阻，供电难以解决，位于东北部的吉罗纳省 22 万居民仍然没有电可用。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-145710.png" alt="image-20200209225709188"></p>
                  <h2 id="土耳其"><a href="#土耳其" class="headerlink" title="土耳其"></a>土耳其</h2>
                  <p>土耳其内政部 1 月 25 日消息称，24 日晚发生在该国东部埃拉泽省的 6.8 级地震已经造成 22 人死亡，超过 1000 人受伤。 据土耳其阿纳多卢通讯社报道，土耳其内政部部长索伊卢 25 日在新闻发布会上表示，埃拉泽省在地震中的死亡人数为 18 人，其邻省马拉提亚省死亡人数为 4 人。政府派出的救援队已从倒塌的房屋和建筑物的废墟中救出 39 人。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-150519.png" alt="image-20200209230517249"></p>
                  <h2 id="利比亚"><a href="#利比亚" class="headerlink" title="利比亚"></a>利比亚</h2>
                  <p>根据俄罗斯卫星通讯社开罗 1 月 14 日的报道，利比亚冲突各方停火问题谈判 13 日在莫斯科举行，俄土两国代表参加了谈判。 然而利比亚战火和谈失败，双方陷入了僵局。土耳其出兵面临全面内战永久分裂风险。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-150608.png" alt="image-20200209230607701"></p>
                  <h2 id="苏丹"><a href="#苏丹" class="headerlink" title="苏丹"></a>苏丹</h2>
                  <p>1 月 14 日下午，苏丹发生政变，安全部门和军方在首都喀土穆机场附近发生激烈对峙，并伴有阵阵枪声。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-150849.png" alt="image-20200209230847784"> 军方戒严了城区主要街道，喀土穆国际机场已关闭。中国驻苏丹使馆发出安全警告，提醒中国公民不要靠近机场区域。</p>
                  <h2 id="也门"><a href="#也门" class="headerlink" title="也门"></a>也门</h2>
                  <p>1 月 19 日，也门西部一个军事训练营遭遇袭击，造成数十名也门政府军士兵死亡，至少 100 人受伤，胡塞武装在马里布市发动了大规模伤亡袭击，命令也门军队必须保持高度戒备，做好战斗准备。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-150959.png" alt="image-20200209230958809"></p>
                  <h2 id="印尼"><a href="#印尼" class="headerlink" title="印尼"></a>印尼</h2>
                  <p>印尼国家抗灾署 6 号通报，首都雅加达和周边地区日前遭遇的洪灾，已造成 67 人死亡。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-151243.jpg" alt="img"> 印尼国家抗灾署发言人阿古斯在一份声明中说，截至当地时间 6 日下午，灾害还造成 1 人失踪，另有 3.6 万人居住在临时避难所。由于强降雨引发洪灾、山体滑坡等灾害，雅加达周边的 12 个县市已陆续宣布进入为期一到两周的紧急状态，以便救援和物资运输工作展开。</p>
                  <h2 id="东非"><a href="#东非" class="headerlink" title="东非"></a>东非</h2>
                  <p>东非近期爆发蝗灾，这被称为 70 年来最严重的沙漠蝗灾，其中肯尼亚受灾最为严重，数亿只蝗虫在肯尼亚境内肆虐。 据联合国估计此次蝗虫数量达 3600 亿只，且数量可能在数月后暴增 500 倍。非常令人惊恐的是沙漠蝗群一天内可以吃掉能养活 2500 人的粮食，这也令当地出现了严重的粮食危机。蝗群密度一般达到每平方公里 1.5 亿只，蝗群一天可以随风飞行 100 至 150 公里，破坏范围及力量惊人。 <img src="https://qiniu.cuiqingcai.com/2020-02-09-152055.png" alt="image-20200209232054576"> 联合国粮食及农业组织已经发出警告，蝗灾将会造成近年来罕见的粮食危机，1900 万人将面临危及生命的饥荒。 这个确实非常严重的，一些更详细的报道大家可以了解澎湃新闻报道的视频：<a href="https://www.thepaper.cn/newsDetail_forward_5758503，真的难以想象" target="_blank" rel="noopener">https://www.thepaper.cn/newsDetail_forward_5758503，真的难以想象</a>。</p>
                  <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
                  <p>总的来说，全世界的 2020 开局的确可以说是不怎么太平。仔细想想，这些现象的发生有天灾，有人祸。除了一些政治上的问题，这些灾难其实来源于人们对大自然的过渡攫取，或者说是对野生动物的滥杀和捕食。 多难兴邦，天灾无情人有情。在大自然的面前，我们显得非常渺小，在灾难的面前，我们都是受害者。这时候就需要我们团结一心，站在一个战线上去把这些困难渡过去，而不是在这个节骨眼上发国难财，造谣传谣。像我们之前非典、汶川地震一样，众志成城，再难我们也能挺过去的。 相信我们的国家，相信世界的人们。 加油武汉，加油中国，加油全世界！</p>
                  <h2 id="参考来源"><a href="#参考来源" class="headerlink" title="参考来源"></a>参考来源</h2>
                  <ul>
                    <li>本文选题和主要参考来源：2020年只过去了一个月，全世界正在发生什么？<a href="https://mp.weixin.qq.com/s/V1iioQsuYITpFfRijZkQHw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/V1iioQsuYITpFfRijZkQHw</a></li>
                    <li>卫健委：全国除湖北外其他省份确诊病例下降超40% <a href="http://news.sina.com.cn/c/2020-02-09/doc-iimxxstf0048640.shtml" target="_blank" rel="noopener">http://news.sina.com.cn/c/2020-02-09/doc-iimxxstf0048640.shtml</a></li>
                    <li>美国4个月近2000万人感染流感 今年或是10年来最严重 <a href="https://www.codingsky.com/news/2020-02-08/11567.html" target="_blank" rel="noopener">https://www.codingsky.com/news/2020-02-08/11567.html</a></li>
                    <li>Weekly U.S. Influenza Surveillance Report <a href="https://www.cdc.gov/flu/weekly/index.htm#ILIActivityMap" target="_blank" rel="noopener">https://www.cdc.gov/flu/weekly/index.htm#ILIActivityMap</a></li>
                    <li>澳洲遭十年最大暴雨，悉尼全力应对洪水爆发 <a href="https://new.qq.com/rain/a/20200209A06URA" target="_blank" rel="noopener">https://new.qq.com/rain/a/20200209A06URA</a></li>
                    <li>巴西遭创纪录暴雨肆虐 泥石流冲毁房屋 <a href="http://www.chinanews.com/m/tp/hd/2020/0126/134972.shtml" target="_blank" rel="noopener">http://www.chinanews.com/m/tp/hd/2020/0126/134972.shtml</a></li>
                    <li>也门政府军遭胡塞武装导弹袭击至少40人死亡 <a href="http://www.xinhuanet.com/mil/2020-01/19/c_1210444134.htm" target="_blank" rel="noopener">http://www.xinhuanet.com/mil/2020-01/19/c_1210444134.htm</a></li>
                    <li>苏丹安全部门和军方在喀土穆机场附近激烈对峙 <a href="https://news.sina.cn/gj/2020-01-15/detail-iihnzhha2484546.d.html" target="_blank" rel="noopener">https://news.sina.cn/gj/2020-01-15/detail-iihnzhha2484546.d.html</a></li>
                    <li>67人死亡 1人失踪 印尼洪水灾情严重 <a href="http://news.cri.cn/20200107/235b849d-523f-b512-c6d4-4feacd8347f4.html" target="_blank" rel="noopener">http://news.cri.cn/20200107/235b849d-523f-b512-c6d4-4feacd8347f4.html</a></li>
                    <li>东非遭70年来最严重蝗灾，情况或将恶化 <a href="https://www.thepaper.cn/newsDetail_forward_5758503" target="_blank" rel="noopener">https://www.thepaper.cn/newsDetail_forward_5758503</a></li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-02-10 01:33:41" itemprop="dateCreated datePublished" datetime="2020-02-10T01:33:41+08:00">2020-02-10</time>
                </span>
                <span id="/8889.html" class="post-meta-item leancloud_visitors" data-flag-title="2020 才过去了一个多月，世界都发生了些什么" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8811.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/8811.html" class="post-title-link" itemprop="url">Kubernetes 批量部署 Splash 服务</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>做爬虫的小伙伴可能听说过 Splash，它可以提供动态页面渲染服务，如果我们要爬的某些页面是 JavaScript 渲染而成的，此时我们直接用 requests 或 Scrapy 来爬是没法直接爬到的，此时我们可以借助于 Splash 来帮我们把 JavaScript 渲染后的真实页面结果拿下来。 不过 Splash 在大批量爬虫使用的时候坑不少，Splash 可能用着用着可能就内存炸了，如果只是单纯启 Docker 服务又不好 Scale，另外也不方便当前服务的使用状态，比如内存占用、CPU 消耗等等。 最近把 Splash 迁移到了 Kubernetes 上面，正好上面的问题就一带解决了。 我们既可以方便地扩容，又可以设置超额重启，又可以方便地观察到当前服务使用情况。 下面简单记录一下我把 Splash 迁移到 Kubernetes 上面的过程，真的迁移过来之后省了很多麻烦，推荐大家也可以试试。 好，下面正式开始介绍。</p>
                  <h2 id="必备条件"><a href="#必备条件" class="headerlink" title="必备条件"></a>必备条件</h2>
                  <p>首先，我们需要有一个 Kubernetes 集群，可以自己搭建，也可以使用 Minikube 或者用阿里云、腾讯云、Azure 等服务商直接提供的 Kubernetes 服务。 另外我们需要能使用 <code>kubectl</code> 连接和控制当前的集群，同时需要安装好 <code>helm</code> 并配置好 stable 版本的 Charts，在这里我使用的是 Helm 2.x。 在这里列一些参考资料：</p>
                  <ul>
                    <li>搭建 Kubernetes 集群：<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a></li>
                    <li>Minikube：<a href="https://kubernetes.io/zh/docs/setup/learning-environment/minikube/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/setup/learning-environment/minikube/</a></li>
                    <li>Helm V2 安装和使用：<a href="https://v2.helm.sh/docs/" target="_blank" rel="noopener">https://v2.helm.sh/docs/</a></li>
                    <li>Charts：<a href="https://github.com/helm/charts" target="_blank" rel="noopener">https://github.com/helm/charts</a></li>
                  </ul>
                  <p>上面的内容准备就绪之后，我们就可以开始 Kubernetes 搭建 Splash 服务的流程了。</p>
                  <h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2>
                  <ul>
                    <li>创建 NameSpace</li>
                    <li>创建 Service</li>
                    <li>创建 Deployment</li>
                    <li>安装 Ingress Controller</li>
                    <li>配置域名解析</li>
                    <li>配置 Authentication</li>
                    <li>配置 HTTPS</li>
                  </ul>
                  <p>上面就是本节所要介绍的基本内容，下面我们开始吧。</p>
                  <h2 id="创建-NameSpace"><a href="#创建-NameSpace" class="headerlink" title="创建 NameSpace"></a>创建 NameSpace</h2>
                  <p>首先我们将 Splash 安装在一个独立的 Namespace 下面，名字就叫做 splash 吧。 yaml 内容如下：</p>
                  <figure class="highlight dts">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Namespace</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> splash</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就声明了一个 NameSpace，名字叫做 splash。</p>
                  <h2 id="创建-Service"><a href="#创建-Service" class="headerlink" title="创建 Service"></a>创建 Service</h2>
                  <p>Service 的创建也很简单，我们注意声明好 namespace 和端口等信息即可：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">splash</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">splash</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">splash</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"8050"</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8050</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8050</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">splash</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> <span class="string">&#123;&#125;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里选择了端口号 port 8050，即服务运行的端口为 8050。targetPort 也是 8050，这个代表 Pod 里面容器的运行端口。另外声明了 labels 和 selector 的内容，大家可以稍作了解。</p>
                  <h2 id="创建-Deployment"><a href="#创建-Deployment" class="headerlink" title="创建 Deployment"></a>创建 Deployment</h2>
                  <p>接下来，就是最关键的了，我们使用 scrapinghub/splash 这个 Docker 镜像来创建一个 Deployment，yaml 文件如下：</p>
                  <figure class="highlight less">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">apiVersion</span>: apps/v1</span><br><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: splash</span><br><span class="line">  <span class="attribute">name</span>: splash</span><br><span class="line">  <span class="attribute">namespace</span>: splash</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">3</span></span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">matchLabels</span>:</span><br><span class="line">      <span class="attribute">app</span>: splash</span><br><span class="line">  <span class="attribute">revisionHistoryLimit</span>: <span class="number">1</span></span><br><span class="line">  <span class="attribute">strategy</span>: &#123;&#125;</span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">app</span>: splash</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">        - <span class="attribute">image</span>: scrapinghub/splash</span><br><span class="line">          <span class="attribute">name</span>: splash</span><br><span class="line">          <span class="attribute">ports</span>:</span><br><span class="line">            - <span class="attribute">containerPort</span>: <span class="number">8050</span></span><br><span class="line">          <span class="attribute">resources</span>:</span><br><span class="line">            <span class="attribute">requests</span>:</span><br><span class="line">              <span class="attribute">memory</span>: <span class="string">"1Gi"</span></span><br><span class="line">              <span class="attribute">cpu</span>: <span class="string">"1"</span></span><br><span class="line">            <span class="attribute">limits</span>:</span><br><span class="line">              <span class="attribute">memory</span>: <span class="string">"4Gi"</span></span><br><span class="line">              <span class="attribute">cpu</span>: <span class="string">"4"</span></span><br><span class="line">      <span class="attribute">restartPolicy</span>: Always</span><br><span class="line"><span class="attribute">status</span>: &#123;&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里也有几个比较关键的点：</p>
                  <ul>
                    <li><code>metadata.labels</code>：这里需要和 Service 里面的 selector 对应起来。</li>
                    <li><code>spec.template.spec.containers[]</code>：这里声明 splash 的镜像，用的是 latest 镜像 scrapinghub/splash；端口地址用的 8050；restartPolicy 使用的是 Always，这样 Splash 如果崩溃了会自动重启；resources 设置了使用的内存和 CPU 的请求和限制值，这里大家可以根据机器和爬取需求自行修改。</li>
                    <li><code>spec.replicas</code>：运行的实例个数，这里设置为了 3，这样就会启动 3 个 Splash ，Service 会对其负载均衡。</li>
                  </ul>
                  <p>好了，写了上面三个 yaml，我们可以将其合并到一个 yaml 文件里面，如 <code>deployment.yml</code>，然后执行：</p>
                  <figure class="highlight coq">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">kubectl <span class="built_in">apply</span> -f deployment.yml</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就可以观察到 NameSpace、Service、Deployment 都创建成功了，Pod 随之也创建成功了。 <img src="https://qiniu.cuiqingcai.com/2020-01-29-131028.png" alt="image-20200129211026981"></p>
                  <h2 id="安装-Ingress-Controller"><a href="#安装-Ingress-Controller" class="headerlink" title="安装 Ingress Controller"></a>安装 Ingress Controller</h2>
                  <p>接下来我们想要配置一个域名解析，并配置好 HTTPS。 首先我们需要安装 Ingress，这里我们使用 Helm 2.x 安装，使用的 Charts 为：<a href="https://github.com/helm/charts/tree/master/stable/nginx-ingress" target="_blank" rel="noopener">https://github.com/helm/charts/tree/master/stable/nginx-ingress</a>。 这里我们稍作修改，指定 NameSpace 和镜像即可：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">helm install --name ingress-splash --namespace splash --<span class="builtin-name">set</span> defaultBackend.image.<span class="attribute">repository</span>=mirrorgooglecontainers/defaultbackend-amd64 stable/nginx-ingress</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里我们将镜像修改了一下，避免国内 Kubernetes 无法拉取镜像的问题。 OK，安装好了之后，可以看到 Ingress Controller 就安装成功了。</p>
                  <h2 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h2>
                  <p>域名解析就好配置了，直接将域名配置到 Ingress Controller Service 的 External IP 上面即可。 <img src="https://qiniu.cuiqingcai.com/2020-01-29-131156.png" alt="image-20200129211154610"></p>
                  <h2 id="配置-Authentication"><a href="#配置-Authentication" class="headerlink" title="配置 Authentication"></a>配置 Authentication</h2>
                  <p>Splash 部署完了之后，默认是没有 Authentication 的，如果直接暴露在公网中，是可以被他人直接使用的。 所以我们需要对其配置 Authentication，并配置 Ingress 域名解析。 这里 Authentication 我们使用 HTTP Basic Auth 就好了，要配置这个，我们需要先新建一个 Secret。 那么 Secret 怎么创建呢，我们先用 htpasswd 生成一个秘钥文件，用户名为 splash：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">htpasswd -c auth splash</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>执行完了之后本地会生成一个 auth 文件，我们用这个 auth 文件创建一个 Secret 即可：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">kubectl create<span class="built_in"> secret </span>generic basic-auth <span class="attribute">--from-file</span>=auth --namespace splash</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样 Secret 就创建好啦，用户名就是 splash，密码就是刚才创建秘钥文件时输入的密码。 上面更详细的介绍参见：<a href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/examples/auth/basic/</a> 好，然后我们创建 Ingress。 新建 ingress.yml 文件内容如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-splash</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">splash</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">'Authentication Required'</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&lt;domain&gt;</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">splash</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">8050</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 <code>metadata.annotations</code> 里面声明了三个选项，就是设定 HTTP Basic Auth 的。 注意这里 <code>spec.rules[].host</code> 的内容换成自己的域名。 好，然后执行即可：</p>
                  <figure class="highlight coq">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">kubectl <span class="built_in">apply</span> -f ingress.yml</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>OK，这样 Ingress 也创建好啦。 现在我们只需要访问 <code>http://&lt;domain&gt;</code> 即可访问到 Splash 服务啦。 初次访问需要输入用户名和密码，如图所示。 <img src="https://qiniu.cuiqingcai.com/2020-01-29-133031.png" alt="image-20200129213029854"> 登录完成之后就可以看到 Splash 的界面了，如图所示。 <img src="https://qiniu.cuiqingcai.com/2020-01-29-132037.png" alt="image-20200129212035193"></p>
                  <h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2>
                  <p>这时候整个 Endpoint 是 HTTP 协议，会被提示不安全，如果我们想要配置 HTTPS，还需要申请一个证书。 证书可以到阿里云、腾讯云等等服务商申请即可。 申请完了，我们可以得到 crt 和 key 两个文件。 接下来我们首先需要配置一个 tls 类型的 Secret，命令如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">kubectl create<span class="built_in"> secret </span>tls tls-splash -n splash --cert &lt;cert_name&gt;.crt --key &lt;cert_name&gt;.key</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 <code>&lt;cert_name&gt;</code> 替换成你申请的证书文件名即可。 这样我们就创建了一个名字为 tls-splash 的 Secret，下面我们开始使用。 修改 ingress.yml 文件如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-splash</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">splash</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">'Authentication Required'</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&lt;domain&gt;</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">tls-splash</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&lt;domain&gt;</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">splash</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">8050</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里主要修改的点有两个，一个是增加了 ssl 重定向，这样如果我们以 HTTP 访问过去，就会被跳转到 HTTPS 的地址。另外就是 <code>spec.tls</code> 字段了，这里声明 hosts 和 secretName 即可。 OK，重新应用：</p>
                  <figure class="highlight coq">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">kubectl <span class="built_in">apply</span> -f ingress.yml</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>大功告成，现在我们就可以使用 <code>https://&lt;domain&gt;</code> 来访问我们的 Splash 服务了。</p>
                  <h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2>
                  <p>最后，输入个网址测试下吧，如百度，渲染成功，如图所示。 <img src="https://qiniu.cuiqingcai.com/2020-01-29-133132.png" alt="image-20200129213130109"> 以上，便是 Kubernetes 搭建 Splash 的方法。 希望对大家有帮助。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-01-29 23:54:06" itemprop="dateCreated datePublished" datetime="2020-01-29T23:54:06+08:00">2020-01-29</time>
                </span>
                <span id="/8811.html" class="post-meta-item leancloud_visitors" data-flag-title="Kubernetes 批量部署 Splash 服务" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8808.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/8808.html" class="post-title-link" itemprop="url">2019 年终总结：新生活、新探索</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>2020 年的新年过去了，去年也是在春节期间写的年终总结，今年也是时候再总结和反思一下我的 2019 年了。 总的来说，2019 我给自己的一句话总结为：新生活、新探索。 今年是我从学生时代正式迈入职场的第一年，也是体验了新的生活环境的第一年，没有预想到的变化有很多，接触的新的挑战也很多。这一年，我也在努力调整自己，去适应新的工作环境和生活节奏。但今年自己达成的面上的成就不算多，更多的时间在于学习、自我适应和调整，同时一年里我也有了一些新的感悟。 所以，在此把我这一年的变化、思考和新一年的目标做一下总结，希望来年可以继续加油。</p>
                  <h2 id="变化"><a href="#变化" class="headerlink" title="变化"></a>变化</h2>
                  <h3 id="第一次正式工作"><a href="#第一次正式工作" class="headerlink" title="第一次正式工作"></a>第一次正式工作</h3>
                  <p>2019 年 1 月份，我硕士毕业了，接下来就正式开始工作了。2019 年 3 月 1 日，我正式入职微软，在微软小冰部门，我换了一个新的小组，有了一群 Nice 的新同事。 我的工作的内容属于 AI Creation，不过偏全栈一点，会涉及到自然语言处理、图像处理、前端、后端等各个方面的技术。正式入职之后，我负责小组的这一个全新的探索方向。 怎么说呢？刚开始我接手这个项目的时候，基本上整个项目还是在实验阶段，我要做的就是把整个项目规范化、搭建一套完整的 End2End 的 Pipeline、检测模型、管理平台和服务器。我之前在实习阶段的时候没有接触过线上代码，不了解现在代码的一些逻辑和架构。所以刚开始的时候面对一些杂乱的实验数据、设计草稿、线上代码，面对这些一些需求，一段时间内真的是感觉不知道怎么办才好。那会儿我记得一直在梳理思路，在一点点 Debug 现有的代码的一些逻辑，然后和我的 Manager 和同事一起讨论实现的思路。 慢慢地，我逐渐也清楚了现有的代码和架构，知道了我可以具体怎么实现，期间我把自己的一些设计思路改了好几次，比如我记得有好几个 Pipeline 拆了又拆，有一些设计 Schema 改了好几次，最后慢慢稳定下来了，渐渐地，我把一些模型、Pipeline、管理平台、服务器慢慢搭建好了，现在我做的一些东西也上线并正式投入使用了。回想起来，刚开始真的挺难的，不过现在做成了，还是很有成就感的。 在这里真的要好好感谢我的 Manager 和同事们，他们对我的帮助很大。在讨论项目实现的过程中，我收获了很多新的想法。我承认我自己这个人并不是特别喜欢与人合作，倾向于坚持自己的想法，倾向于自己去把一件事去做完，所以我最开始可能更偏己见一点。但在讨论整个项目的过程中，我学到了，有些思路原来还可以这么想，原来还可以这么实现。真的，有些设计思路和想法我确实一开始没有想到，但经过讨论之后，确实学习到了很多技巧和方法，慢慢地，我的一些编程的思想也有了变化，我会有自己的想法，同时也倾向于把我的一些思路说给别人，看看别人怎么想的，在大多数情况下，我会想到更优的解决思路，即使没有，我也学到了一些新的思考方法或者知识点。另外在这期间，我的小组队伍也壮大了起来，我自己也作为小组长（算是）指导了几位新同事一起参与整个项目，在这期间我也悟到了一些合作或指导的一些经验，大家都非常给力，目前来说还是很不错的。 要说这一年的工作压力和强度的话，整个走下来其实还是不小的。在前期阶段，其实更多来自于项目本身的压力，因为有太多的东西需要做，同时需要学习和了解的新东西也有很多，当时也没有找到适合自己的工作节奏，算是“摸爬滚打”了好一阵。在后期阶段，也有一些新的挑战，比如要去思考哪些方向是对的，怎样和同事更好地协作一起优化一些功能点，当然也一直有新的技术需要学习。整体感觉上来，比我的实习期的工作强度大了非常非常多，可以说和实习期的工作强度是没法比的。 现在想想，实习的时候，我差不多半年时间写完了一本爬虫书，晚上还能和我的小伙伴们聚众开黑王者荣耀。现在？功能实现了吗？Bug 修完了吗？好了，滚去撸代码了。写书？开黑？一天，一晃就这么过去了。</p>
                  <h3 id="公众号"><a href="#公众号" class="headerlink" title="公众号"></a>公众号</h3>
                  <p>正式工作之后，发现自己打理公众号的时间比我预想中的要紧张许多，没错就是这个「进击的Coder」。 对于公众号的运营，我也慢慢地佛系了，在 2019 快年底的时候，我把我的公众号转给我的女朋友小马来运营了，不得不说她运营得非常好，会找一些很不错的技术文章帮我排版，帮我发布，我有原创文章我也会交给她帮我发一下，的确减轻了我不少的压力。她也有很多想法，写了一些原创，也会策划一些活动，后来，不少公众号的粉丝居然渐渐转成她的粉丝了？！我回来后，你们还认识我吗？ 说一下数据吧，写文章时，公众号粉丝数量为 <strong>57420</strong>，常读用户是 <strong>9857</strong>，平均阅读 <strong>3000</strong> 左右，算是技术号中比较普通的水平了，常读用户比例也不怎么高，而且对于我 2019 年的 Flag 10 万，还有挺大的差距，这个后文会详细说。 说说公众号这件事吧，为什么我这次单独把「常读用户」数据放出来了呢？因为现在其实粉丝数并不是那么重要的，常读用户才是更重要的。公众号在 2019 年做了一次大的改动，「信息流」是其一，「在看」是其二，另一个大的改动就是有了「常读的订阅号」这个功能，大家应该也都注意到了，它会出现在最上端，几个圆形的公众号头像，如果公众号有了消息，它会有一个绿色的小点，大多数情况下，然后我们就会点开看了，可以说对阅读量的帮助是很大的。对于信息流来说，如果我们发文的时机把握不好的话，很可能文章就会被冲淡在信息流里面再也找不见了。所以，常读用户的多少和阅读量有着很大的关系。这也是有一些公众号虽然粉丝很多，但是阅读量并不高的很大原因；同时也是一些公众号虽然粉丝少，但是阅读量一直很高的很大原因。 「在看」功能也是很重要的，当然这取决于文章质量了，如果文章质量高，「在看」多，大家从「朋友在看」入口进入到文章的的人也越多，阅读量自然也会高。 另外还有原创，大家可以看到很多原创率高的号主，阅读量都是很高的，因为原创，内容独特，见解到位，他们的公众号常读用户量和常读用户比率一般都是非常高的，阅读量自然就高了。另外公众平台对于原创也有一定的鼓励和推荐机制，帮助原创号主获得更多的流量。另外现在我观察到技术公众号的一个趋势，就是很多文章都转来转去，大多数公众号的原创率都是很低的，另外广告现在也越来越多（我也参与了），读者又不是傻子，在筛选一篇优质公众号文章越来越难的今天，读者会倾向于阅读原创率高或内容优质的公众号。那些没有原创能力或者内容质量不高的公众号，阅读量增长会非常困难，甚至于淹没于越来越大的公众号海洋之中。 所以，现在运营公众号，最重要的数据是什么？最直接的当然是平均阅读量，这可能直接关乎一个公众号值多少钱或者接到的广告值多少钱。平均阅读量更多取决于什么？「常读用户」和「在看」。所以一方面，我在运营的时候会更注意公众号的发文质量和频率，一定不能长时间不更新，否则万一公众号从「常读的订阅号」列表里面掉出去，就很难找回来了。另外我对于粉丝量其实并没有那么看重了，所以我也很少去参与互推的一些活动。 2019 年我发的文章一部分是原创的技术文，要写的话我会写好，把一些来龙去脉和原理都说清楚，保证文章的质量，但由于时间紧张，原创个人感觉发的并不多。另一部分是转载的一些觉得有价值的技术文，我会和小马一起去挑选一些我们认为还不错的技术文或时效新闻发给大家，希望读者能有所收获。最后就是广告了，2019 年接的广告其实说实话不少，当然接广告也基本上是为了恰口饭，如果大家看到了是广告标题，能帮着戳一戳进去加点阅读量我就非常感激不尽了。其他的互推或者抽奖送书等等活动，我很少很少参与了，一方面觉得意义并没有那么大，对读者也不友好。 我觉得公众号专注于提供优质的内容、见解和想法，这才是好的发展路子，我的涨粉速度肯定没有互推来得快，而且确实也因为我的个人原因对公众号精力投入不够，导致阅读量增长比较慢，但我觉得这是适合我的初衷的发展路子，也是我比较舒服的运营方式。所以，接下来我还是秉承的之前的运营理念，公众号的方向还会专注于技术，致力去提供优质的内容给大家。 另外我也有一些新的运营想法。我一直有关注一个公众号叫做「未闻Code」，公号主是「青南」，他是做网络爬虫方向的，也著有很不错的技术书籍，也在维护一个开源项目 GNE，即新闻网页正文通用抽取器，项目地址：<a href="https://github.com/kingname/GeneralNewsExtractor，可以实现新闻页面的自动化抽取，目前已经有" target="_blank" rel="noopener">https://github.com/kingname/GeneralNewsExtractor，可以实现新闻页面的自动化抽取，目前已经有</a> 1k 多个 Star，推荐大家关注下。他的公众号有一个我觉得很不错的运营模式，那就是「一日一技」，他会把一些总结或新学到的技能整理出来发到公众号上，有的文章内容可能并不长，可能就是记录自己学习或踩坑的过程，甚至可能就是一个个小的零碎的知识点，但我感觉还是很有价值的，读者反响也不错。而我之前在写文章的时候，我会必须要把一个知识点扩得很大，把知识点或项目的来龙去脉或者完整的使用流程写一篇长文再发出来，因此大家可以看到我的技术原创文一般都会显得比较完整甚至叫啰嗦，为写这篇文章，我可能要去搜罗各种资料，可能也去新学一些新的东西，这样也致使我写一篇文章耗费的时间也会比较长。所以，我想寻求一个转变，我想，比如某天我在工作中解决了一个什么问题，或者我学到了一个小的骚操作，或者我就学到了一个小的知识点，我想也把它写下来，把这件事稍微说明白就行，暂时不去把所有的涉及这个知识点的的东西完整总结。比如我今天刚学到了 Kubernetes 在部署时动态替换环境变量的骚操作，我就只把这个记录下来，分享给大家，不再去展开讲。这样可以提高我的产量，同时把我今天学到的或想法写下来与大家分享，可能文章比较短，可能知识点描述得不够全，但我觉得是一个不错的路子。后面我会尝试下这个方案，如果得到的反响不错的话，我会继续坚持。</p>
                  <h3 id="开源"><a href="#开源" class="headerlink" title="开源"></a>开源</h3>
                  <p>作为一名程序猿，比起刷抖音，我更喜欢逛 GitHub，同时自己也会喜欢写一些开源项目并发到 GitHub 上面，如果能收获一些 Star，心里会有很大的成就感。 先说一下目前的数据吧，我的 GitHub 地址是：<a href="https://github.com/Germey，目前粉丝数" target="_blank" rel="noopener">https://github.com/Germey，目前粉丝数</a> 4.9k，收获 Star 数约 4k，2019 年 Commits 数量 1053 次，目前主要维护了 Gerapy 和 ModelZoo 两个项目，还有一些其他的项目如 ProxyPool、CookiesPool 也有一些人在使用。 由于时间问题，2019 年我在开源这一方面的贡献并不好，Gerapy 和 ModelZoo 两个项目也有一段时间的停更，导致现在也一直不瘟不火，Star 数也一直不多。 我觉得能够有自己拿得出手的开源项目确实是一件很有成就感的事情，新的一年，我会投入更多的精力参与到上面来，目前还是会专注于 Gerapy 和 ModelZoo 两个项目上面来。同时随着学习和积累，可能还会酝酿出新的项目。新的一年，继续加油。</p>
                  <h3 id="写作"><a href="#写作" class="headerlink" title="写作"></a>写作</h3>
                  <p>关注我的读者可能知道我在 2018 年 4 月出版了一本《Python3网络爬虫开发实战》，这也是我写的第一本书，其目前销量已经远远超过我的预期，到现在为止不到两年时间，累积印刷 15 次，印刷量 7w 多，豆瓣评分 9.0 分，也已经被很多学校或培训机构当做教材或辅导书，这些都是我之前没有预料到的，同时这本书也为我带来了一笔可观的收入。 但免不了的，讲爬虫，网站不会是一成不变的，网站一改版，整个案例就跑不通了。这本书，现在挺多案例已经过期了，书稿的内容不好直接修改，我只能在 GitHub 上尽量去跟进修改，但对于一些初学者来说，是很不友好的。另外，爬虫技术日新月异，很多技术或框架已经过时了，另外也出现了一些新的技术和知识点，当时在写书的时候并没有提及到。 所以，我去年就跟编辑策划了《Python3网络爬虫开发实战》第二版的撰写。本次第二版相对于第一版来说，修订了过期的案例，补充了新的知识点。第二版为每个知识点的实战项目对接了针对性的练习平台，避免了案例过期的问题。另外主要增加了异步爬虫、JavaScript 逆向、App 逆向、智能网页解析、深度学习识别验证码、Kubernetes 运维及部署等知识点，同时各个爬虫知识点涉及到的请求、存储、解析、测试等工具也进行了丰富和更新。 到现在算是基本完稿了，现在已经在审稿了，但我还想修改和增加一部分内容。比如最近提议出来的修订过期案例的问题，这个问题很重要，不然不知道啥时候我书里的案例就又过期了，为此我自建了爬虫案例平台，项目在这里：<a href="https://github.com/Germey/Scrape，最近忙着迁移和开发，现在正在把一些案例修改到案例平台上面。其他的稿子差不多了，正在审核中。所以基本上我现在是边改边审的状态，也希望能提前出版的时间。我知道有些读者很急，也盼着第二版的出版" target="_blank" rel="noopener">https://github.com/Germey/Scrape，最近忙着迁移和开发，现在正在把一些案例修改到案例平台上面。其他的稿子差不多了，正在审核中。所以基本上我现在是边改边审的状态，也希望能提前出版的时间。我知道有些读者很急，也盼着第二版的出版</a>。 现在没几天就会有读者问我第二版什么时候出版呀？情况，就是上面这个样子，已经开始审稿了，可能还得几个月吧，争取 2020 上半年可以出来，如有消息，我一定第一时间通知大家。 当然写作也不仅仅是写书，也包括日常的积累。 我自己在平时的工作和学习的过程中也会记一些笔记。我现在把我所有的笔记都用 Typora 这个 MarkDown 编辑工具写下来，然后整理和同步到 GitHub 和 GitBook 上面，我分了好几个记事本，有技术类、生活类、书稿类、开源文档类，整理和总结了不少东西，挺多东西并没有公开发出来，原因我也在上文「公众号」一节提及了一下，但我也想寻求一个新的运营方式，所以我准备把一些自己整理的东西，即便是小的知识点，也都发出来，跟大家一起学习和探讨。 不怕被笑话「原来我这个知识点还不会呢」，我新学到的就发出来看。因为只有「改革开放」才能真正地进步，固步自封最终吃亏的还是自己。</p>
                  <h3 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h3>
                  <p>说到知识，今年来我个人觉得学习的还算及格，我学到的知识一方面来自于工作，一方面来自于平时生活。 稍微总结一下今年来都学了些什么吧：</p>
                  <ul>
                    <li>C#、.NET。其实在实习期间我不接触线上代码，C#、.NET 并不常用。正式开始工作了，这个必须学起来了，因为一些 Service 必须要用它来搭。学了之后，确实觉得 C# 设计得真的很棒，很多特性和理念值得好好学习。</li>
                    <li>爬虫逆向。在 2019 年之前，我对爬虫逆向可以说基本不了解，因为在写第一版书那段期间，网站采取混淆或加密的不多，App 抓包基本都能抓得到。后来时代变了，网站现在你没有个混淆，基本就不是个合格的网站，很多 App 接口抓包也搞不到，或者一些接口加了很多加密参数。所以说 JavaScript 逆向和 App 逆向不学基本上就没法玩爬虫了。所以我也在开始学习和了解这一部分的内容，在 2019 下半年加入了夜幕团队，团队有几位搞逆向非常厉害的大佬，同时我们也合作出了一套 JavaScript 逆向课，另一方面也为了写书做准备。总之，收获很大，也非常感谢大家的指导和帮助。但由于这个技术比较敏感，担心发出来被对方寄律师函什么的，所以我也几乎不发文。不过现在我有了新的思路了，自建爬虫案例平台，所以等建好了，我会发一些关于逆向方面的文章的，大家敬请期待。</li>
                    <li>Kubernetes、DevOps。现在 DevOps 和 Kubernetes 基本上可以说是大势了，部署一把梭。在工作中我们也慢慢地把一些服务迁移到 Kubernetes 上面，为此我也自己摸索和搭建过 Kubernetes 集群，搞了一些 Service、数据库的搭建，DevOps 一套主要用 Azure Pipelines、GitHub Actions，是真香！现在我的几乎所有服务都在往 Kubernetes 上面迁，新的爬虫案例平台也用了 GitHub Actions 来实现自动部署。</li>
                    <li>深度学习。在 2019 年之前，我也有一些深度学习的基础，但 2019 年我在实现一些自己的开源项目 ModelZoo 的的时候，又学习了一些新的模型，把 ModelZoo 重新迁移到 TensorFlow 2.0 上面。另外在工作之余也学习了一些新的模型，如序列标注相关、图像识别相关。但最近我又有了新的想法，用了一段时间 TensorFlow 2.0 之后，感觉有些地方实现起来还是别扭，对接了 Keras 之后，调试也还是不太方便。经过与一些大佬的交流，决定准备转 PyTorch 了，这真可能是趋势，不知道我的感觉对不对。但选择比努力更重要吗不是？方向感觉不对，就要及时调整，没毛病。（逃</li>
                    <li>各种开源库。这些也不算系统的知识点了，单纯就是逛 GitHub 看到的，比如一些实用的类库，比如 typing、loguru、retrying、faker、airtest 等等，学了，顺带写一篇总结文，慢慢积累下来。</li>
                  </ul>
                  <p>总的来说，2019 学到的新东西还算不少，慢慢地我也摸清了我的技术路线，现在还会是 Python 主力的全栈方向，将来可能还会变，一些技术栈我会去慢慢补齐，我知道自己哪些不会，为了达成我的一些目标还需要去学什么。 另外在学习过程中，思考和总结是非常重要的。</p>
                  <ul>
                    <li>遇到不会的，多去思考和搜索，实在不行求助别人。</li>
                    <li>解决了问题，记得复盘和梳理下来。</li>
                    <li>学习新知识，顺带把学到的整理和记录下来。</li>
                  </ul>
                  <p>个人觉得这样学习起来，效果还是不错的。新的一年，继续加油。 当然除了技术，我自己也在学一些其他的，比如英语，之前跟小马出去塞尔维亚玩了一趟，英语要么听不懂，要么说不出来，太难受了。现在上班路上，我会抽时间听一点 BBC，用的是网易云。大家都在用啥学英语啊？ 另外理财相关的知识，我也在了解，同时买了点基金试试水，不过我还觉得储备的知识还不够，还需要继续学习。</p>
                  <h3 id="健身"><a href="#健身" class="headerlink" title="健身"></a>健身</h3>
                  <p>这个话题，真的有点让我难以开口。因为这个健身，我真是做的太失败了，我一年几乎没有健身几次，加上吃太好，从 116 斤胖到了 141 斤。141 - 116 = 25，没错，我一年胖了 25 斤！ 一方面，小马带我吃的太好了，哈哈哈哈，我们几乎每周都会出去吃好吃的，另外她还会给我买各种零食和好吃的，家里的零食一箱箱永远吃不完。 有人说了，你胖了这么多，人家小马怎么瘦了呀？别找借口了。偷偷抹眼泪，说好一起变胖呢？ 另一方面，也是不运动，一坐一天，晚上还没啥空去健身房，日积月累，就成了这样子了，照片就不要看了，我不会给你们看的。 说到健身，小马几乎每周都会去跳舞或者去健身房，我偶尔周末会跟着去体验几节课，但是上完之后，在家就没有继续炼了。哎，也是确实没太有时间锻炼，也有一个原因就是太懒了，可能后者才是最主要的原因。 但这样下去我的体重就要收不住了。在年前的时候我立了 Flag，一周运动至少两次，主要是跑步，如果参与了一次健身也算，我成功坚持下来了。年后继续！ 我会变瘦的！ 没想到，短短一年，「减肥」这个词居然会落在了我的身上。</p>
                  <h3 id="感情"><a href="#感情" class="headerlink" title="感情"></a>感情</h3>
                  <p>嘿嘿，我和小马一起从 2018 跨到了 2020，在一起三年了（抖机灵。哈哈，其实我们已经在一起 449 天啦！总之和小马在一起的日子特别开心，以至于幸福肥了 25 斤（逃。 想分享的生活有太多，但是又觉得在这里公开秀恩爱有点不好意思，反正就是很幸福哈哈哈。比如一起出去吃好吃的、一起旅游、一起健身、一起拍照、一起画画、一起插玩具、一起玩游戏、一起去看展、一起穿情侣装。有时候我们一起吃到了好吃的就会一起高呼「卧槽这个好吃，卧槽这个也好吃，卧槽这个怎么这么好吃！」，有时候走在路上两人就像小孩子一样牵着手或者追来追去，有时候好长时间（一天）不见面，我们再见到对方就互相扑过去，我们很多时候会在对方面前表现得像个孩子或者像一只动物（猫？），我们每人的表情包已经全是「猫」和「狗」了，不多，也就一百多套吧。不好意思，不小心又秀了一下。 怎么说呢？我经常会在微博分享我们两人的生活。有人说我的微博已经从「互联网资讯博主」变成了「恋爱博主」，就是这么个感觉。本来我的书里面不是写了一节「Ajax 爬取微博」来教大家怎么学 Ajax 分析和爬取吗，结果大家爬下来了一堆狗粮，之后跟我说再也不学爬虫了。 我：？？？ 嗯，我也不知道他后来有没有再学，可能真的没有再学了吗？ 不过有时候我也会犯蠢，惹小马不开心或生气（但我们不会分手的，我也慢慢地从中学到了很多，我们的感情也变得越来越好了。昨天我看到知乎一个推荐「女生最想收到男生送的什么礼物？」，我看了看这都什么玩意，然后发给了小马，说我要是送你这些肯定会被分手了，小马看完，说我长大了，开心！看我是不是变得越来越懂你了呢。 新的一年，希望我们还会继续好好在一起呀！ 对了，朋友圈和微博没得刷了或者饿了的话，来刷刷我的微博「崔庆才丨静觅」吧（逃。</p>
                  <h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3>
                  <p>关于思考，这是一个非常抽象的东西，看不见摸不着，但确实很多时候，某些事情思考的深度、广度决定了我们的高度。 在这一年来，我接触了很多人，了解了一些事。比如一个技术项目吧，不同的人对于一个项目思考的深度就不同。很多人可能就是，接到了一个任务，别人告诉他要做什么，怎么做，那他就做完就行了，然后就完事了。但有的人，接到这个任务，会首先想，我这是在做什么？为什么要这么做而不是那么做？做的时候怎样实现才是最佳的？做完了还能做点什么才能变得更好？他会对事情的来龙去脉了解的非常清楚，结束了再去复盘和思考。这也是我觉得很多人所欠缺的一些地方。我觉得人和人之间段位的差距就是这么拉开的。 有的人可能会觉得，考虑这么多，找这个麻烦干什么呢？这其实真不是自己找麻烦，思考的成本其实很低，我们用来思考的时间其实很多，比如路上、休息时、吃饭时、睡前等等。不怕思考浪费时间，怕的是不去思考。 我前几天跟一位非常好的朋友吃饭聊天。这位朋友，我真的很佩服他，我觉得他有很多程序员少有的一些思维，他在思考一些事情时会考虑非常全面，就像上文所提到的一样。比如我之前曾经跟他商量一个实现方案，他第一个问我的问题是，为什么你会这么想这么做？你的理由是什么？你打算怎么来实现？只要你能把我说得通，我就支持你这么做。比如一些方法论上的东西，他一直在思考和探索一些适合自己的生活、工作方式，会思考自己想要做什么、为了达成某个目标怎样做最好、怎样才是最佳实践，同时他也在不断的探索和试错中完善自己的方法论。我从他身上学到了很多，同时我觉得我自己跟他还有很大的差距，还是要多多加油啊。 所以，有时候，我们也需要停下来去思考，自己在做什么、为什么要这么做、怎样做最好，甚至需要去思考一下，自己是谁、从哪里来、要到哪里去。</p>
                  <h3 id="合作"><a href="#合作" class="headerlink" title="合作"></a>合作</h3>
                  <p>关于合作，今年我也体会到了很多，我的想法也变了许多。 怎么说呢，我自己原本是一个倾向于单枪匹马挑战一切的人，同时也不想去麻烦别人，比如一件事情，我习惯于包揽下来，自己去完成，有时候不想给别人添麻烦，有时候觉得交给别人不太放心或者担心做出来不符合我的心意。 慢慢地，在团队合作过程中，我意识到了，自己不是全能的，术业总会有专攻，总会有在某一方面比自己强的人。而且随着工作强度的变大，有些事情自己大包大揽真的有点力不从心。 两点体会吧。</p>
                  <ul>
                    <li>第一，一个人并不是万能的。每个人不可能在所有的事情上做到极致，同时一个人的精力也是有限的。几乎没有人能像 Linus 一样几乎单枪匹马做出一个 Linux 内核，但你说 Linux 和杜兰特比打篮球，谁更厉害？</li>
                    <li>第二，总会有人在某个方面强过自己。随着接触的人和事越来越多，我发现就是有人在某个方面比自己强，或者思考的问题深入，或者完成的效果好。所以，首先不要因为某个方面不如别人而感到难过，有些事，可以放心交给别人去做，有时候结果可能甚至远超过自己的预期。当然这个有个前提，确实也得看人，去学会分辨一些靠谱和不靠谱的人。</li>
                  </ul>
                  <p>所以，现在我在工作中，一些功能和需求，我不会再像之前一样倾向于大包大揽，相信自己的一些靠谱的合作伙伴，每个人直接好好分配，合作的时候一起交流、探讨。同时我自己也指导着两位同事，有些任务我会交给他们去做，不会再因为不放心和给别人添麻烦而全把任务归到自己。有时候真的，最终可能还会有意想不到的效果，或者在跟别人交流的过程中学到一些新的东西。 所以，Be Open，这是我的一点体会。</p>
                  <h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3>
                  <p>关于这个，我体会也很深。 我回顾了自己一年以来没有做和已经做的事情，发现了这么一个现象：有件事我确实给自己定目标了，比如我要学习 Go 语言。然后我就把这个加到了我的待做清单里面，没有给他设置时间限度，也没有具体规划我怎样去做，哪个时间去学什么，反而自己的时间被一些零碎的或更紧急的事情占据了，最后我一整年都没有学 Go。我仔细想想，其实也并不是没有时间，有时候，我在某个时间段，确实是完全闲着的，比如我周六的时候，可能会躺在床上玩手机，一玩一上午，但那会啥也不想做，也没想好要那会要做什么。 我反思了一下自己，还是因为自己给自己的规划不明确。 主要有这么两点：</p>
                  <ul>
                    <li>第一，某些目标我设置的太大，没有详细去规划什么时间做什么。比如学 Go 语言，我应该去好好思考一下，我要在多久时间内达成这个目标，我应该什么时间去做什么，我应该去细分到每一章节，在最开始的时候可能没必要所有的都分的那么细，但真正下一步要做的，一定要列得详细再详细。 比如说，我要三个月内学好 Go 语言，我可以先思考，三个月，我要学多少知识模块，比如有十个知识模块，那么我就规划每一个模块大体什么时候完成，每个模块列到自己的 Todo List 里面，设定好期限，注意，一定要设置好期限，不然真的会一拖再拖！然后，最开始我可能没必要把大把的时间把每个模块里面的每个小知识点都拆分好，但前面的一定要列好，比如我十个模块，我最开始的一两个模块一定要再拆分规划好，同时再设定好每个小知识点的时间。要是前面的模块学完了，再去抽时间规划下一个模块就好了。</li>
                    <li>第二，没有提前设定好每个小目标。我反思了，为什么有的时候我不知道要干些啥呢？原因就是我没有提前规划好我第二天或者接下来的时间做什么。所以我后面决定改变一下，我会为自己提前做好规划，比如我第二天做什么，以及另外一个很重要的，规划一些零碎的时间做什么，比如学习慕课网的一个视频，或者去学习某一节英语课，或者去完成某项健身活动，把时间都利用起来。</li>
                  </ul>
                  <h3 id="感悟"><a href="#感悟" class="headerlink" title="感悟"></a>感悟</h3>
                  <p>另外，这一年中，我也悟出了一些做事的原则或者生活上的感悟，我把一些体会比较深的写下来。</p>
                  <ul>
                    <li>别自嗨，多往外看看。有时候我们可能新学到了一个知识点，或者新做成了一个功能，就觉得自己很了不起了，但殊不知，可能别人已经把这个知识点当做必备知识，或者我们做出来的这个功能拿到外面去，其实是完全被爆的。所以，不要闭门造车，多出去看看，多了解下别人是怎么做的，多了解下这个的前沿和天花板已经到了什么地步，站在巨人的肩膀上，往往会走得更远。</li>
                    <li>别沉浸于过去。有时候我就会沉浸或满足于自己已经取得的一些成就，去“啃老”，但这样是不对的。不论我现在已经取得了什么成就，我都不应该沉浸进去。要把每一天当成 0 起点去对待，和自己的前一天去比较，每天进步一点，这样日积月累，进步就显现出来了。</li>
                    <li>多反思和复盘。就像刚才说的，我们每个人可能一天上班完了，就回家睡大觉了，然后第二天接着去上班。但有多少人每天晚上回问，自己今天到底进步了什么，即使没有进步，也反思一下自己今天为什么没有进步，怎样来解决这个现状。所以，我觉得每天去反思和复盘是很重要的。睡前的十几二十分钟，去思考一下，今天做成了什么、没有做成什么、下一步该怎么做，我觉得还是非常有价值的。</li>
                    <li>不能打包票的不要许诺。很多事情，我们要量力而行。有时候我答应过别人一件事情，可是到了时候，我发现自己没有时间完成或者没有能力去完成，最后去跟别人说要拖延时间或者干脆不做了。这其实对别人来说也很不好，而且本来可能是帮别人一个忙，反而可能会成为倒忙。所以，一些事情，在答应之前，好好想想到底有没有问题，如果不能打包票，不要轻易许诺。</li>
                    <li>一些小事也别以为很简单，重要的是细节。一件事，做的时候不要眼高手低，本来以为很简单的一件事，觉得分分钟就能做完，结果做完了发现很多细节没有把握好，出了很多错误。比如我记得之前我答应小马改个文章，本来以为很简单的东西，心想不就是改个这个吗，当时改的时候还在想着别的东西，改的时候并没有那么认真，结果导致有些错别字，最后被打回来返工，使得事情变得更糟。我不止一次犯过这种毛病了，犯错之后我也深深自责，为什么这么简单的事也能错。所以，一些小事也不要以为很简单，要认认真真去做，一些细节要把握好。</li>
                  </ul>
                  <p>还有一些别的感悟，有的感悟更深刻了，不过之前都写过了，我就不再写了，大家如果感兴趣可以看看我去年的年度总结或者之前我的一些分享。 好了，一些变化和反思我就暂时总结这么多了，不足的地方还有很多，也希望来年我能变得更好，无愧于自己的努力。</p>
                  <h2 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h2>
                  <p>照例，新的 2020 年，我给自己立一点 Flag 吧！明年再来继续总结和验收。</p>
                  <h3 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h3>
                  <p>工作继续好好努力，这是最重要的，现在我规划了一些新的尝试的方向，愿明年能够顺利实现和上线。</p>
                  <h3 id="健身减肥"><a href="#健身减肥" class="headerlink" title="健身减肥"></a>健身减肥</h3>
                  <p>新的一年，每个工作周，健身至少 2 次。体重减重到 130 斤并一直维持，减掉赘肉和小肚子。</p>
                  <h3 id="读书"><a href="#读书" class="headerlink" title="读书"></a>读书</h3>
                  <p>给自己定一个读书计划，读完自己规划的一些书，每一本写出自己的感悟。</p>
                  <h3 id="日-周总结"><a href="#日-周总结" class="headerlink" title="日/周总结"></a>日/周总结</h3>
                  <p>每日复盘和总结，写到日记本中，每周末对该周的内容进行复盘和总结。</p>
                  <h3 id="爬虫书"><a href="#爬虫书" class="headerlink" title="爬虫书"></a>爬虫书</h3>
                  <p>《Python3网络爬虫开发实战（第二版）》书籍完成，书籍争取在上半年发售。另外还规划了配套视频，按照计划顺利出来。</p>
                  <h3 id="公众号-1"><a href="#公众号-1" class="headerlink" title="公众号"></a>公众号</h3>
                  <p>公众号我就不按照粉丝量来设定目标了，如果「常读用户」机制一直存在的话，新的一年，我希望公众号常读用户数目可以达到 2w，平均阅读量达到 6000，即翻倍。 另外公众号会尝试新的运营思路，我会写一些小的知识点发到公众号上，如果反响不错，新的一年会一直保持。</p>
                  <h3 id="开源-1"><a href="#开源-1" class="headerlink" title="开源"></a>开源</h3>
                  <p>继续维护自己的项目 Gerapy 和 ModelZoo。 Gerapy 把已经规划好的「可视化爬虫」、「智能解析」、「监控分析」等功能完善，Star 数破 3k。 ModelZoo 将其迁移到 PyTorch，并对接好当前规划的前沿主流模型，总 Star 数破 1k。</p>
                  <h3 id="理财"><a href="#理财" class="headerlink" title="理财"></a>理财</h3>
                  <p>学习一些理财知识，记录成自己的一套方法论。</p>
                  <h3 id="感情-1"><a href="#感情-1" class="headerlink" title="感情"></a>感情</h3>
                  <p>当然是和小马好好在一起！让我们的感情变得更好！</p>
                  <h3 id="收入"><a href="#收入" class="headerlink" title="收入"></a>收入</h3>
                  <p>这个自己给自己定了一个目标，这个具体数字我不说啦，朝着我的小米之家梦进发！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-01-29 10:35:13" itemprop="dateCreated datePublished" datetime="2020-01-29T10:35:13+08:00">2020-01-29</time>
                </span>
                <span id="/8808.html" class="post-meta-item leancloud_visitors" data-flag-title="2019 年终总结：新生活、新探索" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>12k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>11 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8703.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/8703.html" class="post-title-link" itemprop="url">新书发售 限时折扣｜《Python3 反爬虫原理与绕过实战》</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>无论是在学习还是工作中，反爬虫技术是所有爬虫工程师都要面对的问题。 常见的反爬虫原理和绕过技巧也是中高级爬虫工程师<strong>面试中关注的焦点</strong>， 尤其是那些竞争激烈的大型互联网企业。作为一名<strong>开发者</strong>，了解<strong>反爬虫原理</strong>和<strong>绕过技巧</strong>有助于<strong>设计</strong>出更合理的<strong>反爬虫策略</strong>，这会使你在同行中<strong>脱颖而出</strong>，<strong>大放异彩</strong>。</p>
                  <h1 id="那么问题来了"><a href="#那么问题来了" class="headerlink" title="那么问题来了"></a>那么问题来了</h1>
                  <p>如何<strong>深入</strong>学习<strong>反爬虫原理</strong>并<strong>掌握绕过技巧</strong>呢？ 今天给大家推荐业内深受欢迎的反爬虫专题书籍《Python3 反爬虫原理与绕过实战》</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191214150839.jpeg" alt="" title="null"></p>
                  <p>这本书于 2020 年 1 月出版，目前在各大电商平台和书城均有售。本书定价 89，现在各大平台均有不同的<strong>限时折扣</strong>，喜欢的朋友赶紧下手哦！ 【京东自营】 <a href="https://item.jd.com/12794078.html" target="_blank" rel="noopener">https://item.jd.com/12794078.html</a> 【天猫】<a href="https://detail.tmall.com/item.htm?spm=a230r.1.14.201.15272c73Ta0USk&amp;id=611222843708&amp;ns=1&amp;abbucket=7" target="_blank" rel="noopener">https://detail.tmall.com/item.htm?spm=a230r.1.14.201.15272c73Ta0USk&amp;id=611222843708&amp;ns=1&amp;abbucket=7</a> 【当当】<a href="http://product.dangdang.com/28508464.html" target="_blank" rel="noopener">http://product.dangdang.com/28508464.html</a> 书中描述了爬虫技术与反爬虫技术的<strong>对抗过程</strong>，并详细介绍了这其中的<strong>原理</strong>和具体的<strong>实现方法</strong>。本书从开发环境的配置到 Web 网站的构成和页面渲染，再到动态网页和静态网页对爬虫造成的影响。然后介绍了不同类型的<strong>反爬虫原理</strong>、<strong>具体实现</strong>和<strong>绕过方法</strong>。书中还讲解了<strong>常见验证码的实现过程</strong>，并使用<strong>深度学习技术完成了验证</strong>。最后介绍了常见的<strong>编码和加密原理</strong>、<strong>JavaScript 代码混淆</strong>知识、<strong>前端禁止事件</strong>以及<strong>与爬虫相关的法律知识和风险点</strong>。</p>
                  <h1 id="精彩抢先看"><a href="#精彩抢先看" class="headerlink" title="精彩抢先看"></a>精彩抢先看</h1>
                  <p>在原理探究和分析方面，你会经历细致的分析过程，并通过示意图加深对知识的理解。例如第 6 章第 2 节 CSS 偏移反爬虫中描述元素位置和样式值关系的示意图：</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231134122.png" alt="" title="null"></p>
                  <p>例如第 6 章第 3 节 SVG 反爬虫中描述 SVG text 定位的示意图：</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231134610.jpg" alt="" title="null"></p>
                  <p>例如第 10 章第 1 节编码与加密中描述加密过程的示意图：</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231134642.png" alt="" title="null"></p>
                  <p>例如第 9 章第 3 节滑动验证码中描述移动距离的示意图：</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231134827.png" alt="" title="null"></p>
                  <p>网站的反爬虫措施是会更新的，为了保证读者的学习质量，本书在编写过程中开发了一套拥有 21 个示例的练习平台 Steamboat。</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231135742.jpg" alt="" title="null"></p>
                  <p>练习平台与书本紧密结合，不会出现学习过程中找不到与书本相同环境的情况，同时也能避免因练习而导致的侵权问题。除了配套的示例之外，书中还分析了众多互联网产品中使用到的反爬虫手段，这些产品包括大众点评、淘宝滑动验证码、猫眼电影、京东商城、去哪儿网、掘金社区和掌上英雄联盟等。 你有想过将深度学习应用到爬虫中吗？</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231140847.jpg" alt="" title="null"></p>
                  <p>书中介绍了如何通过卷积神经网络来应对字符验证码，并给出了训练用的图片和识别率高达 99% 的训练代码。其中部分代码如下：</p>
                  <figure class="highlight arcade">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="string">`folders \= PATH_TEST # 指定预测集路径`</span><span class="string">`trains \= get_image_name(PATH_TRAIN)  # 获取训练样本所有图片的名称`</span><span class="string">`pres \= get_image_name(folders)  # 获取预测集所有图片的名称`</span><span class="string">`repeat \= len([p for p in pres if p in trains])  # 获取重复数量`</span><span class="string">`start_verifies(folders)  # 开启预测`</span><span class="string">`logging.info('预测前确认待预测图片与训练样本的重复情况，'`</span><span class="string">`'待预测图片%s张，训练样本%s张，重复数量为%s张' % (len(pres), len(trains), repeat))`</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>当然，还有通过目标检测算法来应对点选验证码的精彩章节。</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191231141853.png" alt="" title="null"></p>
                  <h1 id="这本书是谁写的？"><a href="#这本书是谁写的？" class="headerlink" title="这本书是谁写的？"></a>这本书是谁写的？</h1>
                  <p>作者韦世东是一名资深爬虫工程师，2019年华为云认证云享专家、掘金社区优秀作者、GitChat认证作者、夜幕团队 NightTeam 的成员。</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102171141.png" alt="" title="null"></p>
                  <p>他曾在掘金社区发布过电子小册《Python 实战：用 Scrapyd 打造个人化的爬虫部署管理控制台[1]》 。也在 GitChat 上发布过 MongoDB 的 10 万字教程《超高性价比的 MongoDB 零基础快速入门实战教程[2]》。还在华为总部进行过时长 2 小时的技术直播，直播主题为《Python 项目部署与调度核心逻辑[3]》。</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102171245.jpg" alt="" title="null"></p>
                  <h1 id="这本书适合哪些朋友？"><a href="#这本书适合哪些朋友？" class="headerlink" title="这本书适合哪些朋友？"></a>这本书适合哪些朋友？</h1>
                  <p>这本书的目标读者分为两个阵营：<strong>爬虫</strong>和<strong>反爬虫</strong>。 爬虫工程师自然不用多说，大家最期待的正是对反爬虫技术的剖析和绕过实战。 反爬虫的设计者和实施者遍布于各个岗位，它可以是<strong>前端工程师</strong>、<strong>后端工程师</strong>、<strong>移动端研发</strong>甚至是<strong>产品经理</strong>。他们能够<strong>从书中了解到爬虫工程师常用的技术手段和思路</strong>，知道<strong>哪些防护措施容易被突破</strong>、<strong>哪些措施的绕过难度会更高</strong>以及<strong>如何限制爬虫</strong>，从而<strong>设计出适合的反爬虫策略</strong>。</p>
                  <h1 id="大厂高级研发怎么看？"><a href="#大厂高级研发怎么看？" class="headerlink" title="大厂高级研发怎么看？"></a>大厂高级研发怎么看？</h1>
                  <p>以下是几位大厂工程师为本书编写的推荐语。</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102175332.jpg" alt="" title="null"></p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102175558.jpg" alt="" title="null"></p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102175614.jpg" alt="" title="null"></p>
                  <h1 id="详细的章节目录"><a href="#详细的章节目录" class="headerlink" title="详细的章节目录"></a>详细的章节目录</h1>
                  <p>详细目录如下：</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102165750.jpg" alt="" title="null"></p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102165805.jpg" alt="" title="null"></p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102165825.jpg" alt="" title="null"></p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20200102165838.jpg" alt="" title="null"></p>
                  <p>这简直就是手把手带你探寻反爬虫的世界！ <img src="https://qiniu.cuiqingcai.com/wp-content/uploads/2020/01/0f042d65-8e75-484b-89c0-b2b944a66661_0.png" alt=""></p>
                  <h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3>
                  <p><code>[1]</code> Python 实战：用 Scrapyd 打造个人化的爬虫部署管理控制台: <em><a href="https://juejin.im/book/5bb5d3fa6fb9a05d2a1d819a/section" target="_blank" rel="noopener">https://juejin.im/book/5bb5d3fa6fb9a05d2a1d819a/section</a></em> <code>[2]</code> 超高性价比的 MongoDB 零基础快速入门实战教程: <em><a href="https://gitbook.cn/gitchat/activity/5d52baeaac15fd68e9f78297" target="_blank" rel="noopener">https://gitbook.cn/gitchat/activity/5d52baeaac15fd68e9f78297</a></em> <code>[3]</code> Python 项目部署与调度核心逻辑: <em><a href="http://huaweicloud.bugu.mudu.tv/watch/vondje76" target="_blank" rel="noopener">http://huaweicloud.bugu.mudu.tv/watch/vondje76</a></em></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2020-01-03 19:55:51" itemprop="dateCreated datePublished" datetime="2020-01-03T19:55:51+08:00">2020-01-03</time>
                </span>
                <span id="/8703.html" class="post-meta-item leancloud_visitors" data-flag-title="新书发售 限时折扣｜《Python3 反爬虫原理与绕过实战》" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8678.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/8678.html" class="post-title-link" itemprop="url">揭秘去哪儿网在用的 CSS 偏移反爬虫手段！</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>内容选自<strong>即将出版</strong>的《Python3 反爬虫原理与绕过实战》，本次公开书稿范围为第 6 章——文本混淆反爬虫。本篇为第 6 章中的第 2 小节，第 3、4 小节已发，直达链接：</p>
                  <ul>
                    <li>《<a href="https://juejin.im/post/5e05a58b6fb9a0164f2955b2" target="_blank" rel="noopener">一线大厂在用的反爬虫手段，看我破！</a>》</li>
                    <li>《<a href="https://juejin.im/post/5e03ef93518825125c4316c3" target="_blank" rel="noopener">用前考虑清楚，伤敌一千自损八百的字体反爬虫</a>》</li>
                  </ul>
                  <p>其余小节将<strong>逐步放送</strong>。</p>
                  <h2 id="CSS-偏移反爬虫"><a href="#CSS-偏移反爬虫" class="headerlink" title="CSS 偏移反爬虫"></a>CSS 偏移反爬虫</h2>
                  <p>CSS 偏移反爬虫指的是利用 CSS 样式将乱序的文字排版为人类正常阅读顺序的行为。这个概念不是很好理解，我们可以通过对比两段文字来加深对这个概念的理解。</p>
                  <ul>
                    <li>HTML 文本中的文字：我的学号是 1308205，我在北京大学读书。</li>
                    <li>浏览器显示的文字：我的学号是 1380205，我在北京大学读书。</li>
                  </ul>
                  <p>爬虫提取到的学号是 1308205，但用户在浏览器中看到的却是 1380205。如果不细心观察，爬虫工程师很容易被爬取结果糊弄。这种混淆方法和图片伪装一样，是不会影响用户阅读的。让人好奇的是，浏览器如何将 HTML 文本中的数字按照开发者的意愿排序或放置呢？这种放置规则是如何运作的呢？我们可以通过一个具体的例子来了解 CSS 偏移反爬虫的应用和绕过方法。</p>
                  <h3 id="6-2-1-CSS-偏移反爬虫绕过实战"><a href="#6-2-1-CSS-偏移反爬虫绕过实战" class="headerlink" title="6.2.1 CSS 偏移反爬虫绕过实战"></a>6.2.1 CSS 偏移反爬虫绕过实战</h3>
                  <p>示例 5：CSS 偏移反爬虫示例。 网址：<a href="http://www.porters.vip/confusion/flight.html" target="_blank" rel="noopener">http://www.porters.vip/confusion/flight.html</a>。 任务：爬取航班查询和机票销售网站页面中的航站名称、所属航空公司和票价，页面内容如图 6-4 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223139.jpg" alt=""> 图 6-4 示例 5 页面 在编写 Python 代码之前，我们需要确定目标数据的元素定位。航空公司名称元素定位如图 6-5 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223224.jpg" alt=""> 图 6-5 航空公司名称元素定位结果 航空公司名称包裹在没有属性的 span 标签中，但该 span 标签包裹在 class 属性为 air g-tips 的 div 标签中。接下来我们看一下航站名称的元素定位，定位结果如图 6-6 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223314.jpg" alt=""> 图 6-6 航站名称元素定位结果 航站名称包裹在没有属性的 h2 标签中，h2 标签包裹在 class 为 sep-lf 的 div 标签中。 我们再看一下票价的元素定位，定位结果如图 6-7 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223407.jpg" alt=""> 图 6-7 票价的元素定位结果 页面中显示的票价为 467，但是在网页中却有两组不同的数字，其中一组是[7, 7, 7]，而另一组是 [6, 4]，这看起来就有点奇怪了。 难道是网页显示有问题？ 按照正常排序来说，这架航班的票价应该是 77 764 才对。我们可以查看第二架航班信息的价格，思考是网页显示问题还是做了什么反爬虫措施。第二架航班的票价元素定位结果如图 6-8 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223516.jpg" alt=""> 图 6-8 第二架航班的票价元素定位结果 结果与第一架航班的票价显示有同样的问题：网页显示内容和 HTML 代码中的内容不一致。我们分析一下 HTML 代码，看一看是否能找到什么线索。第一架航班票价的 HTML 代码为：</p>
                  <figure class="highlight xml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"prc_wp"</span> <span class="attr">style</span>=<span class="string">"width:48px"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"rel"</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width:48px;left:-48px"</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>7<span class="tag">&lt;/<span class="name">i</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>7<span class="tag">&lt;/<span class="name">i</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>7<span class="tag">&lt;/<span class="name">i</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width: 16px;left:-32px"</span>&gt;</span>6<span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width: 16px;left:-48px"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">em</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码中有 3 对 b 标签，第 1 对 b 标签中包含 3 对 i 标签，i 标签中的数字都是 7，也就是说第 1 对 b 标签的显示结果应该是 777。而第 2 对 b 标签中的数字是 6，第 3 对 b 标签中的数字是 4。 这些数字与页面所显示票价 467 的关系是什么呢？ 这一步找到的标签和数字有可能是数据源，但是数字的组合有很多种可能，如图 6-9 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223638.jpg" alt=""> 图 6-9 数字组合推测 5 个数字的组合结果太多了，我们必须找出其中的规律，这样就能知道网页为什么显示 467 而不是 764 或者 776 。在仔细查看过后，发现每个带有数字的标签都设定了样式。第 1 对 b 标签的样式为：</p>
                  <figure class="highlight scss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">width</span>:<span class="number">48px</span>;<span class="attribute">left</span>:-<span class="number">48px</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第 2 对 b 标签的样式为：</p>
                  <figure class="highlight scss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">width</span>: <span class="number">16px</span>;<span class="attribute">left</span>:-<span class="number">32px</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第 3 对 b 标签的样式为：</p>
                  <figure class="highlight scss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">width</span>: <span class="number">16px</span>;<span class="attribute">left</span>:-<span class="number">48px</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>i 标签对的样式是相同的，都是：</p>
                  <figure class="highlight scss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">width</span>: <span class="number">16px</span>;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外，还注意到最外层的 span 标签对的样式为：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">width:<span class="number">48</span>px</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果按照 CSS 样式这条线索来分析的话，第 1 对 b 标签中的 3 对 i 标签刚好占满 span 标签对的位置，其位置如图 6-10 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223828.jpg" alt=""> 图 6-10 span 标签对和 i 标签对位置图 此时网页中显示的价格应该是 777，但是由于第 2 和第 3 对 b 标签中有值，所以我们还需要计算它们的位置。此时标签位置的变化如图 6-11 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225223941.jpg" alt=""> 图 6-11 标签位置变化 右侧是标签位置变化后的结果，由于第 2 对 b 标签的位置样式是 left:-32px，所以第 2 对 b 标签中的值 6 就会覆盖原来第 1 对 b 标签中的中的第 2 个数字 7，此时页面应该显示的数字是 767。 按此规律推算，第 3 对 b 标签的位置样式是 left:-48px，这个标签的值会覆盖第 1 对 b 标签中的第 1 个数字 7，覆盖结果如图 6-12 所示，最后显示的票价是 467。 <img src="http://can.sfhfpc.com/sfhfpc/20191225224032.jpg" alt=""> 图 6-12 覆盖结果 根据结果来看这种算法是合理的，不过我们还需要对其进行验证，现在将第二架航班的 HTML 值 和 CSS 样式按照这个规律进行推算。最后推算得到的结果与页面显示结果相同，说明这个位置偏移的计算方法是正确的，这样我们就可以编写 Python 代码获取网页中的票价信息了。因为 b 标签包裹在 class 属性为 rel 的 em 标签下，所以我们要定位所有的 em 标签。对应的 Python 代码如下：</p>
                  <figure class="highlight xl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests </span><br><span class="line"><span class="keyword">import</span> re </span><br><span class="line">from parsel <span class="keyword">import</span> Selector </span><br><span class="line">url = <span class="string">'http://www.porters.vip/confusion/flight.html'</span> </span><br><span class="line">resp = requests.get(url) </span><br><span class="line">sel = Selector(resp.<span class="keyword">text</span>) </span><br><span class="line">em = sel.css(<span class="string">'em.rel'</span>).extract()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接着定位所有的 b 标签。由于 b 标签中还有 i 标签，而且 i 标签的值是基准数据，所以可以直接提取。对应的 Python 代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">for</span> <span class="keyword">element</span> <span class="keyword">in</span> em: </span><br><span class="line">    <span class="keyword">element</span> = Selector(<span class="keyword">element</span>) </span><br><span class="line">    <span class="comment"># 定位所有的&lt;b&gt;标签</span></span><br><span class="line">    element_b = <span class="keyword">element</span>.css(<span class="string">'b'</span>).extract() </span><br><span class="line">    b1 = Selector(element_b.pop(<span class="number">0</span>)) </span><br><span class="line">    <span class="comment"># 获取第 1 对&lt;b&gt;标签中的值(列表) </span></span><br><span class="line">    base_price = b1.css(<span class="string">'i::text'</span>).extract()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来要提取其他 b 标签的偏移量和数字。对应的 Python 代码如下：</p>
                  <figure class="highlight cs">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">alternate_price = [] </span><br><span class="line"><span class="keyword">for</span> eb <span class="keyword">in</span> element_b: </span><br><span class="line">   eb = Selector(eb) </span><br><span class="line">   <span class="meta"># 提取&lt;b&gt;标签的 style 属性值</span></span><br><span class="line">   style = eb.css(<span class="string">'b::attr("style")'</span>).<span class="keyword">get</span>() </span><br><span class="line">   <span class="meta"># 获得具体的位置</span></span><br><span class="line">   position = <span class="string">''</span>.<span class="keyword">join</span>(re.findall(<span class="string">'left:(.*)px'</span>, style)) </span><br><span class="line">   <span class="meta"># 获得该标签下的数字</span></span><br><span class="line">   <span class="keyword">value</span> = eb.css(<span class="string">'b::text'</span>).<span class="keyword">get</span>() </span><br><span class="line">   <span class="meta"># 将&lt;b&gt;标签的位置信息和数字以字典的格式添加到替补票价列表中</span></span><br><span class="line">   alternate_price.append(&#123;<span class="string">'position'</span>: position, <span class="string">'value'</span>: <span class="keyword">value</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后根据偏移量决定基准数据列表的覆盖元素，实际上是完成图 6-11 中的操作。</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">for</span> <span class="keyword">al</span> in alternate_price: </span><br><span class="line">   position = <span class="keyword">int</span>(<span class="keyword">al</span>.<span class="built_in">get</span>(<span class="string">'position'</span>)) </span><br><span class="line">   value = <span class="keyword">al</span>.<span class="built_in">get</span>(<span class="string">'value'</span>) </span><br><span class="line">   # 判断位置的数值是否正整数</span><br><span class="line">   plus = True <span class="keyword">if</span> position &gt;= <span class="number">0</span> <span class="keyword">else</span> False </span><br><span class="line">   # 计算下标，以 <span class="number">16</span>px 为基准</span><br><span class="line">   <span class="built_in">index</span> = <span class="keyword">int</span>(position / <span class="number">16</span>) </span><br><span class="line">   # 替换第一对<span class="symbol">&lt;b&gt;</span>标签值列表中的元素，也就是完成值覆盖操作</span><br><span class="line">   base_price[<span class="built_in">index</span>] = value </span><br><span class="line"><span class="keyword">print</span>(base_price)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后将数据列表打印出来，得到的输出结果为：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">'4</span>', <span class="symbol">'6</span>', <span class="symbol">'7</span>'] </span><br><span class="line">[<span class="symbol">'8</span>', <span class="symbol">'7</span>', <span class="symbol">'0</span>', <span class="symbol">'5</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>令人感到奇怪的是，输出结果中第一组票价数字与页面中显示的相同，但第二组却不同。这是因为第二架航班的票价基准数据有 4 个值。航班票价对应的 HTML 代码如下：</p>
                  <figure class="highlight xml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"rel"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width:64px;left:-64px"</span>&gt;</span> </span><br><span class="line">       <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>8<span class="tag">&lt;/<span class="name">i</span>&gt;</span> </span><br><span class="line">       <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">i</span>&gt;</span> </span><br><span class="line">       <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>9<span class="tag">&lt;/<span class="name">i</span>&gt;</span> </span><br><span class="line">       <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"width: 16px;"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width: 16px;left:-32px"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width: 16px;left:-48px"</span>&gt;</span>7<span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">"width: 16px;left:-16px"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">b</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>覆盖操作是根据由偏移量计算得出的下标进行的，实际上就是列表元素的替换。当基准数据列表的元素数量超过包裹着 i 标签的 b 标签宽度时，我们就对列表进行切片，否则按照原来的替换规则进行。因此，需要对代码做一些调整。调整内容如下：</p>
                  <figure class="highlight vala">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta"># 减号代表删除此行代码，加号代表新增代码</span></span><br><span class="line">+ import re </span><br><span class="line">- base_price = b1.css(<span class="string">'i::text'</span>).extract() </span><br><span class="line">+ b1_style = b1.css(<span class="string">'b::attr("style")'</span>).<span class="keyword">get</span>() </span><br><span class="line"><span class="meta"># 获得具体的位置</span></span><br><span class="line">+ b1_width = <span class="string">''</span>.join(re.findall(<span class="string">'width:(.*)px;'</span>, b1_style)) </span><br><span class="line">+ number = <span class="keyword">int</span>(<span class="keyword">int</span>(b1_width) / <span class="number">16</span>) </span><br><span class="line"><span class="meta"># 获取第 1 对 &lt;b&gt; 标签中的值(列表) </span></span><br><span class="line">+ base_price = b1.css(<span class="string">'i::text'</span>).extract()[:number]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果列表中元素的数量超过标签宽度，那么后面的元素是不会显示的。比如 width:32px，每个标签占位宽度 16 px，那么即使 b 标签下有 5 个 i 标签（base_price=[1, 2 ,3 ,4 , 5]），在页面中也仅显示前面的两个数字。代码调整完毕后，再次运行代码。运行结果为：</p>
                  <figure class="highlight scheme">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">'4</span>', <span class="symbol">'6</span>', <span class="symbol">'7</span>'] </span><br><span class="line">[<span class="symbol">'8</span>', <span class="symbol">'7</span>', <span class="symbol">'0</span>', <span class="symbol">'5</span>']</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第二架航班的票价结果仍然跟页面显示的内容不同，但根据 CSS 宽度规则，我们之前分析的逻辑是正确的。为什么结果还是跟页面显示的不一样呢？ 实际上并不是我们的逻辑和代码有错，而是页面显示错误。要注意的是，页面数据显示错误是常发生的事，我们只需要按照正确的逻辑编写代码即可。</p>
                  <h3 id="6-2-2-去哪儿网反爬虫案例"><a href="#6-2-2-去哪儿网反爬虫案例" class="headerlink" title="6.2.2 去哪儿网反爬虫案例"></a>6.2.2 去哪儿网反爬虫案例</h3>
                  <p>去哪儿网是中国领先的在线旅游平台，覆盖全球 68 万余条航线，并与国内的旅游景点和航空公司进行了深度的合作。去哪儿网也有用到类似的反爬虫手段，我们一起来了解一下。 打开浏览器并访问 <a href="https://dwz.cn/d05zNKyq，页面内容如图" target="_blank" rel="noopener">https://dwz.cn/d05zNKyq，页面内容如图</a> 6-13 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225224432.jpg" alt=""> 图 6-13 去哪儿网航班信息 航班票价对应的 HTML 代码如图 6-14 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225224514.jpg" alt=""> 图 6-14 去哪儿网航班票价 HTML 代码 去哪儿网航班票价所对应的 HTML 代码结构和 CSS 与我们在示例 5 中见到的类似。我们可以大胆猜测，去哪儿网航班票价的显示规律与示例 5 中所用的方法也是类似的，感兴趣的同学可以按照 6.2.1 节的思路进行票价推算。去哪儿网航班票价中第 1 对 b 标签下的 i 标签数量与 width 是相匹配的，并未出现显示错误的问题。</p>
                  <h3 id="6-2-3-小结"><a href="#6-2-3-小结" class="headerlink" title="6.2.3 小结"></a>6.2.3 小结</h3>
                  <p>CSS 样式可以改变页面显示，但这种“改变”仅存在于浏览器（能够解释 CSS 的渲染工具）中，即使爬虫工程师借助渲染工具，也无法获得“见到”的内容。 </p>
                  <h2 id="新书福利"><a href="#新书福利" class="headerlink" title="新书福利"></a>新书福利</h2>
                  <p>真是翘首以盼！《Python3 反爬虫原理与绕过实战》一书终于要跟大家见面了！为了感谢大家对韦世东和本书的期待与支持，在新书发布时会举办多场送书活动和限时折扣活动。 <img src="http://can.sfhfpc.com/sfhfpc/20191226081009.jpg" alt=""> 想要与作者韦世东交流或者参加新书发布活动的朋友可以扫描二维码进群与我互动哦！</p>
                  <h3 id="转载说明"><a href="#转载说明" class="headerlink" title="转载说明"></a>转载说明</h3>
                  <p>本篇内容摘自出版图书《Python3 反爬虫原理与绕过实战》，欢迎各位好友与同行转载！ 记得带上相关的版权信息哦😊。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-12-31 16:41:19" itemprop="dateCreated datePublished" datetime="2019-12-31T16:41:19+08:00">2019-12-31</time>
                </span>
                <span id="/8678.html" class="post-meta-item leancloud_visitors" data-flag-title="揭秘去哪儿网在用的 CSS 偏移反爬虫手段！" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8648.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/8648.html" class="post-title-link" itemprop="url">大厂在用的反爬虫手段，破了它！</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>内容选自<strong>即将出版</strong>的《Python3 反爬虫原理与绕过实战》，本次公开书稿范围为第 6 章——文本混淆反爬虫。本篇为第 6 章中的第 3 小节，第 4 小节<a href="https://juejin.im/post/5e03ef93518825125c4316c3" target="_blank" rel="noopener"><strong>字体反爬虫</strong></a>已发布，其余小节将<strong>逐步放送</strong>。</p>
                  <h2 id="新书福利"><a href="#新书福利" class="headerlink" title="新书福利"></a>新书福利</h2>
                  <p>真是翘首以盼！《Python3 反爬虫原理与绕过实战》一书终于要跟大家见面了！为了感谢大家对韦世东和本书的期待与支持，在新书发布时会举办多场送书活动和限时折扣活动。</p>
                  <p><img src="http://can.sfhfpc.com/sfhfpc/20191226081009.jpg" alt="" title="null"></p>
                  <p>想要与作者韦世东交流或者参加新书发布活动的朋友可以扫描二维码进群与我互动哦！</p>
                  <h2 id="SVG-映射反爬虫"><a href="#SVG-映射反爬虫" class="headerlink" title="SVG 映射反爬虫"></a>SVG 映射反爬虫</h2>
                  <p>SVG 是用于描述二维矢量图形的一种图形格式。它基于 XML 描述图形，对图形进行放大或缩小操作都不会影响图形质量。矢量图形的这个特点使得它被广泛应用在 Web 网站中。 接下来我们要了解的反爬虫手段正是利用 SVG 实现的，这种反爬虫手段用矢量图形代替具体的文字，不会影响用户正常阅读，但爬虫程序却无法像读取文字那样获得 SVG 图形中的内容。由于 SVG 中的图形代表的也是一个个文字，所以在使用时必须在后端或前端将真实的文字与对应的 SVG 图形进行映射和替换，这种反爬虫手段被称为 SVG 映射反爬虫。</p>
                  <h3 id="6-3-1-SVG-映射反爬虫绕过实战"><a href="#6-3-1-SVG-映射反爬虫绕过实战" class="headerlink" title="6.3.1 SVG 映射反爬虫绕过实战"></a>6.3.1 SVG 映射反爬虫绕过实战</h3>
                  <p>示例 6：SVG 映射反爬虫示例。 网址：<a href="http://www.porters.vip/confusion/food.html" target="_blank" rel="noopener">http://www.porters.vip/confusion/food.html</a>。 任务：爬取美食商家评价网站页面中的商家联系电话、店铺地址和评分数据，页面内容如图 6-15 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225224848.jpg" alt=""> 图 6-15 示例 6 页面 在编写 Python 代码之前，我们需要确定目标数据的元素定位。在定位过程中，发现一个与以往不同的现象：有些数字在 HTML 代码中并不存在。例如口味的评分数据，其元素定位如图 6-16 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225224930.jpg" alt=""> 图 6-16 评分数据中口味分数元素定位 根据页面显示内容，HTML 代码中应该是 8.7 才对，但实际上我们看到的却是：</p>
                  <figure class="highlight xml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span>口味:<span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkjj4"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span>.7<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>HTML 代码中有数字 7 和小数点，但没有 8 这个数字，似乎数字 8 的位置被 d 标签占据。而商家电话号码处的显示就更奇怪了，一个数字都没有。商家电话对应的 HTML 代码如下：</p>
                  <figure class="highlight xml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col more"</span>&gt;</span> </span><br><span class="line">        电话：</span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkbvu"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk08k"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk08k"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span>-<span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk84t"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk6zl"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkqsc"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkqsc"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk6zl"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>包含很多的 d 标签，难道它使用 d 标签进行占位，然后用元素进行覆盖吗？我们可以将 d 标签的数量和数字的数量进行对比，发现它们的数量是相同的，也就是说一对 d 标签代表一个数字。 每一对 d 标签都有 class 属性，有些 class 属性值是相同的，有些则不同。我们再将 class 属性值与数字进行对比，看一看能否找到规律，如图 6-17 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225103.jpg" alt=""> 图 6-17 class 属性值和数字的对比 从图 6-17 中可以看出，class 属性值和数字是一一对应的，如属性值 vhk08k 与数字 0 对应。根据这个线索，我们可以猜测每个数字都与一个属性值对应，对应关系如图 6-18 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225143.jpg" alt=""> 图 6-18 数字与属性值对应关系 浏览器在渲染页面的时候就会按照这个对应关系进行映射，所以页面中显示的是数字，而我们在 HTML 代码中看到的则是这些 class 属性值。浏览器在渲染时将 HTML 中的 d 标签与数字按照此关系进行映射，并将映射结果呈现在页面中。映射逻辑如图 6-19 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225239.jpg" alt=""> 图 6-19 映射逻辑 我们的爬虫代码可以按照同样的逻辑实现映射功能，在解析 HTML 代码时将 d 标签的 class 属性值取出来，然后进行映射即可得到页面中显示的数字。如何在爬虫代码中实现映射关系呢？实际上网页中使用的是“属性名数字”这种结构，Python 中内置的字典正好可以满足我们的需求。我们可以用 Python 代码测试一下，代码如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 定义映射关系</span></span><br><span class="line"><span class="string">mappings</span> <span class="string">=</span> <span class="string">&#123;'vhk08k':</span> <span class="number">0</span><span class="string">,</span> <span class="attr">'vhk6zl':</span> <span class="number">1</span><span class="string">,</span> <span class="attr">'vhk9or':</span> <span class="number">2</span><span class="string">,</span> </span><br><span class="line">   <span class="attr">'vhkfln':</span> <span class="number">3</span><span class="string">,</span> <span class="attr">'vhkbvu':</span> <span class="number">4</span><span class="string">,</span> <span class="attr">'vhk84t':</span> <span class="number">5</span><span class="string">,</span> </span><br><span class="line">   <span class="attr">'vhkvxd':</span> <span class="number">6</span><span class="string">,</span> <span class="attr">'vhkqsc':</span> <span class="number">7</span><span class="string">,</span> <span class="attr">'vhkjj4':</span> <span class="number">8</span><span class="string">,</span> </span><br><span class="line">   <span class="attr">'vhk0f1':</span> <span class="number">9</span><span class="string">&#125;</span> </span><br><span class="line"><span class="comment"># HTML 中得到的属性值</span></span><br><span class="line"><span class="string">html_d_class</span> <span class="string">=</span> <span class="string">'vhkvxd'</span> </span><br><span class="line"><span class="comment"># 将映射后的结果打印输出</span></span><br><span class="line"><span class="string">print(mappings.get(html_d_class))</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这段代码的逻辑是：首先定义属性值与数字的映射关系，然后假设一个 HTML 中 d 标签的属性值，接着将这个属性值的映射结果打印出来。代码运行后得到的结果为：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">6</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果说明映射这种方法是可行的。接着我们试一试将商家的联系电话映射出来：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 定义映射关系</span></span><br><span class="line">mappings = &#123;<span class="string">'vhk08k'</span>: 0, <span class="string">'vhk6zl'</span>: 1, <span class="string">'vhk9or'</span>: 2, </span><br><span class="line">            <span class="string">'vhkfln'</span>: 3, <span class="string">'vhkbvu'</span>: 4, <span class="string">'vhk84t'</span>: 5, </span><br><span class="line">            <span class="string">'vhkvxd'</span>: 6, <span class="string">'vhkqsc'</span>: 7, <span class="string">'vhkjj4'</span>: 8, </span><br><span class="line">            <span class="string">'vhk0f1'</span>: 9&#125; </span><br><span class="line"><span class="comment"># 商家联系电话 class 属性</span></span><br><span class="line">html_d_class = [<span class="string">'vhkbvu'</span>, <span class="string">'vhk08k'</span>, <span class="string">'vhk08k'</span>, </span><br><span class="line">                <span class="string">''</span>, <span class="string">'vhk84t'</span>, <span class="string">'vhk6zl'</span>, </span><br><span class="line">                <span class="string">'vhkqsc'</span>, <span class="string">'vhkqsc'</span>, <span class="string">'vhk6zl'</span>] </span><br><span class="line"></span><br><span class="line">phone = [mappings.<span class="builtin-name">get</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> html_d_class] </span><br><span class="line"><span class="comment"># 将映射后的结果打印输出</span></span><br><span class="line"><span class="builtin-name">print</span>(phone)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果为：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, None, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们使用映射的方法得到了商家联系电话，说明 SVG 映射反爬虫已经被我们绕过了。</p>
                  <h3 id="6-3-2-大众点评反爬虫案例"><a href="#6-3-2-大众点评反爬虫案例" class="headerlink" title="6.3.2 大众点评反爬虫案例"></a>6.3.2 大众点评反爬虫案例</h3>
                  <p>这种映射手段不仅仅出现在本书的示例中，在大型网站中也有应用。大众点评是中国领先的本地生活信息及交易平台，也是全球最早建立的独立第三方消费点评网站。大众点评不仅为用户提供商户信息、消费点评及消费优惠等信息服务，同时提供团购、餐厅预订、外卖和电子会员卡等 O2O（Online To Offline）交易服务。大众点评网站也使用了映射型反爬虫手段，打开浏览器并访问 <a href="https://www.dianping.com/shop/14741057，页面如图" target="_blank" rel="noopener">https://www.dianping.com/shop/14741057，页面如图</a> 6-20 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225522.jpg" alt=""> 图 6-20 大众点评商家信息页 大众点评的商家信息页主要用于展示消费者对商家的各项评分、商家电话、店铺地址和推荐菜品等。我们可以看一看商家电话或评分的 HTML 代码，如图 6-21 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225608.jpg" alt=""> 图 6-21 商家电话 HTML 代码 大众点评中的商家号码并不是全部使用 d 标签代替，其中有部分使用了数字。但是仔细观察一下就可以发现商家号码的数量等于 d 标签数量加上数字的数量，说明 d 标签的 class 属性值与数字也有可能是一一对应的映射关系。感兴趣的同学可以使用示例 6 中的方法，尝试映射大众点评案例中的数字。 如果这种手段的绕过方法这么简单的话，那么它早就被淘汰了，为什么连大众点评这样的大型网站都会使用呢？我们继续往下看，大众点评的商家营业时间部分的 HTML 代码如图 6-22 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225659.jpg" alt=""> 图 6-22 大众点评商家营业时间 除了刚才的数字映射之外，大众点评还对中文进行了映射。此时如果按照示例 6 中人为地将 class 值和对应的文字进行映射的话，就非常麻烦了。试想一下，如果网页中所有的文字都使用这种映射反爬虫的手段，那么爬虫工程师要如何应对呢？对所有用到的文字进行映射吗？ 这不可能做到，其中要完成映射的包括 10 个数字、26 个英文字母和几千个常用汉字。而且目标网站一旦更改文字的对应关系，那么爬虫工程师就需要重新映射所有文字。面对这样的问题，我们必须找到文字映射规律，并且能够使用 Python 语言实现映射算法。如此一来，无论目标网站文字映射的对应关系如何变化，我们都能够使用这套映射算法得到正确的结果。 这种映射关系在网页中是如何实现的呢？是使用 JavaScript 在页面中定义数组吗？还是异步请求API 拿到 JSON 数据？这都有可能，接下来我们就去寻找答案。</p>
                  <h3 id="6-3-3-SVG-反爬虫原理"><a href="#6-3-3-SVG-反爬虫原理" class="headerlink" title="6.3.3 SVG 反爬虫原理"></a>6.3.3 SVG 反爬虫原理</h3>
                  <p>映射关系不可能凭空出现，一定使用了某种技术特性。HTML 中与标签 class 属性相关的只有 JavaScript 和 CSS。根据这个线索，我们需要继续对示例 6 进行分析。案例中商家电话的 HTML 代码为：</p>
                  <figure class="highlight xml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col more"</span>&gt;</span>电话：</span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkbvu"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk08k"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk08k"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span>-<span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk84t"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk6zl"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkqsc"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhkqsc"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">d</span> <span class="attr">class</span>=<span class="string">"vhk6zl"</span>&gt;</span><span class="tag">&lt;/<span class="name">d</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们可以随意选择一对 d 标签，然后观察它对应的 CSS 样式有没有可以深入分析的线索，如果没有线索再看 JavaScript。 d 标签的 CSS 样式如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">d</span><span class="selector-attr">[class^=<span class="string">"vhk"</span>]</span> &#123; </span><br><span class="line">   <span class="attribute">width</span>: <span class="number">14px</span>; </span><br><span class="line">   <span class="attribute">height</span>: <span class="number">30px</span>; </span><br><span class="line">   <span class="attribute">margin-top</span>: -<span class="number">9px</span>; </span><br><span class="line">   <span class="attribute">background-image</span>: <span class="built_in">url</span>(../font/food.svg); </span><br><span class="line">   <span class="attribute">background-repeat</span>: no-repeat; </span><br><span class="line">   <span class="attribute">display</span>: inline-block; </span><br><span class="line">   <span class="attribute">vertical-align</span>: middle; </span><br><span class="line">   <span class="attribute">margin-left</span>: -<span class="number">6px</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="selector-class">.vhkqsc</span> &#123; </span><br><span class="line">    <span class="attribute">background</span>: -<span class="number">288.0px</span> -<span class="number">141.0px</span>; </span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>d 标签样式看上去没有什么特别之处，只是设置了 background 属性的坐标值。但是上方 d 标签的公共样式中设置了背景图片，我们可以复制背景图片的地址，在浏览器的新标签页中打开，d 标签背景图如图 6-23 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225857.jpg" alt=""> 图 6-23 标签背景图 d 标签的背景图中全部都是数字，这些无序的数字共有 4 行。但这好像不是一张大图片，我们查看该图片页面的源代码，内容如图 6-24 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225225953.jpg" alt=""> 图 6-24 图片页面源代码 源代码中前两行表明这是一个 SVG 文件，该文件中使用 text 标签定义文本， style 标签用于设置文本样式， text 标签定义的文本正是图片页面显示的数字。难道这些无序的数字就是我们在页面中看到的电话号码和评分数字？ 除了 class 属性值为 vhkbvu 的 d 标签，其他标签也使用了这个的 CSS 样式，但每对 d 标签的坐标定位都不同。它们的坐标定位如下：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-class">.vhkbvu</span> &#123; </span><br><span class="line">    <span class="attribute">background</span>: -<span class="number">386px</span> -<span class="number">97px</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="selector-class">.vhk08k</span> &#123; </span><br><span class="line">    <span class="attribute">background</span>: -<span class="number">274px</span> -<span class="number">141px</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="selector-class">.vhk84t</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: -<span class="number">176px</span> -<span class="number">141px</span>; </span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>坐标是定位数字的关键，要想知道坐标的计算方法，必须了解一些关于 SVG 的知识。 在本节开始的时候，我们简单地了解了 SVG 的概念，知道 SVG 是基于 XML 的。实际上它是用文本格式的描述性语言来描述图像内容的，因此 SVG 是一种与图像分辨率无关的矢量图形格式。打开文本编辑器，并在新建的文件中写入以下内容：</p>
                  <figure class="highlight django">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span> </span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD SVG 1.1//EN"</span> <span class="meta-string">"http://www.w3.org/Graphics/SVG/1.1/ </span></span></span></span><br><span class="line"><span class="xml"> DTD/svg11.dtd"&gt; </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/ </span></span></span></span><br><span class="line"><span class="xml"> 1999/xlink" width="250px" height="250.0px"&gt; </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">'10'</span> <span class="attr">y</span>=<span class="string">'30'</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">text</span>&gt;</span> </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>将该文件保存为 test.svg，然后使用浏览器打开 test.svg 文件，显示内容如图 6-25 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225230140.jpg" alt=""> 图 6-25 test.svg 显示内容 代码前 3 行声明文件类型，第 4 行~第 5 行定义了 SVG 内容块和画布宽高，第 6 行使用 text 标签定义了一段文本并指定了文本的坐标。这段文本就是我们在浏览器中看到的内容，而代码中的 <em>x</em> 坐标和 <em>y</em> 坐标则用于确定该文本在画布中的位置，坐标规则如下。</p>
                  <ul>
                    <li>以页面的左上角为零坐标点，即坐标值为 (0, 0)。</li>
                    <li>坐标以像素为单位。</li>
                    <li><em>x</em> 轴的正方向为从左到右，<em>y</em> 轴的正方向是从上到下。</li>
                    <li><em>n</em> 个字符可以有 <em>n</em> 个位置参数。</li>
                  </ul>
                  <p>如果字符数量大于位置参数数量，那么没有位置参数的字符将以最后一个位置参数为零坐标点，并按原文顺序排列。 看上去并不是很好理解，我们可以通过修改代码来理解坐标轴的定义。首先是 <em>x</em> 轴， text 标签中的 <em>x</em> 代表列表字符在页面中的 <em>x</em> 轴位置，test.svg 中的 <em>x</em> 值为 10，现在我们将其设为 0 ，保存后刷新网页，页面内容如图 6-26 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225230255.jpg" alt=""> 图 6-26 <em>x</em> 为 0 时的 test.svg 显示内容 <em>x</em> 的值为 0 时，文本紧贴浏览器左侧。而 <em>x</em> 的值为 10 时，文本距离浏览器左侧有一定的距离，这说明 <em>x</em> 的值能够决定文字所在的位置。现在我们将代码中 <em>x</em> 对应的值改为“10 50 30 40 20 60”（注意这里特意将第 2个数字 20与第 5个数字互换了位置），这样做是为了设定前 6个字符的坐标位置。 此时，第 1 个字符的位置参数为 10，第 2 个字符的位置参数为 50，第 3 个字符的位置参数为 30，以此类推，页面中正常显示的文字顺序应该是：</p>
                  <figure class="highlight autohotkey">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">holle,</span>world</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>但是由于我们调换了第 2 个字符和第 5 个字符的位置参数，即字母 e 和字母 o 的位置互换，如图 6-27 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225230403.jpg" alt=""> 图 6-27 设定多个 <em>x</em> 值的 svg 图 6-27 中文字顺序与我们猜测的顺序是一样的，这说明 SVG 中每个字符都可以有自己的 <em>x</em> 轴坐标值。<em>y</em> 与 <em>x</em> 同理，每个字符都可以有自己的 <em>y</em> 轴坐标值。虽然我们只设定了 6 个位置参数， svg 中的字符却有 11 个，但没有设定位置参数的字符依然能够按照原文顺序排序。在了解 SVG 基本知识之后，我们回头看一下案例中所使用的 SVG 文件中坐标参数的设定，图 6-23 中的字符与图 6-24 图片页源代码中的字符一一对应，且每个字符都设定了 <em>x</em> 轴的位置参数，而 <em>y</em> 轴则只有 1 个值。 在了解位置参数之后，我们还需要弄清楚字符定位的问题。浏览器根据 CSS 样式中设定的坐标和元素宽高来确定 SVG 中对应数字。<em>x</em> 轴的正方向为从左到右，<em>y</em> 轴的正方向是从上到下，如图 6-28 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225230507.jpg" alt=""> 图 6-28 SVG <em>x</em> 轴和 <em>y</em> 轴与位置参数的关系 而 CSS 样式中的 <em>x</em> 轴与 <em>y</em> 轴是相反的，也就是说 CSS 样式中 <em>x</em> 轴是负数向右的，<em>y</em> 轴是负数向下的，如图 6-29 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225230553.jpg" alt=""> 图 6-29 CSS <em>x</em> 轴和 <em>y</em> 轴与位置参数的关系 所以当我们需要在 CSS 中定位 SVG 中的字符位置时，需要用负数表示。我们可以通过一个例子来理解它们的关系，现在需要在 CSS 中定位图 6-30 中第 1 行的第 1 个字符的中心点。 <img src="http://can.sfhfpc.com/sfhfpc/20191225230642.jpg" alt=""> 图 6-30 SVG 假设字符大小为 14 px，那么 SVG 的计算规则如下。</p>
                  <ul>
                    <li>字符在<em>x</em>轴中心点的计算规则为：字符大小除以2，再加字符的<em>x</em>轴起点位置参数，即14÷2+0 等于 7。</li>
                    <li>字符在 <em>y</em> 轴中心点的计算规则为：<em>y</em> 轴高度减字符 <em>y</em> 轴起点减字符大小，其值除以 2 后加上字符 <em>y</em> 轴起点位置参数，最后再加上字符大小数值的一半，即(38−0−14)÷2+0+7 等于 19。</li>
                  </ul>
                  <p>最后得到 SVG 的坐标为：</p>
                  <figure class="highlight gml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">x</span>=<span class="string">'7'</span> <span class="symbol">y</span>=<span class="string">'19'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>CSS 样式的 <em>x</em> 轴和 <em>y</em> 轴与 SVG 是相反的，所以 CSS 样式中对该字符的定位为：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">\<span class="number">-7</span>px <span class="number">-19</span>px</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就能够定位到指定字符的中心点了。但是如果要在 HTML 页面中完整显示该字符，那么还需要为 HTML 中对应的标签设置宽高样式，如：</p>
                  <figure class="highlight scss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">width</span>: <span class="number">14px</span>; </span><br><span class="line"><span class="attribute">height</span>: <span class="number">30px</span>;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在了解了 SVG 与 CSS 样式的关联关系后，我们就能够根据 CSS 样式映射出 SVG 中对应的字符。 在实际场景中，我们需要让程序能够自动处理 CSS 样式和 SVG 的映射关系，而不是人为地完成这些 工作。以示例 6 中的 SVG 和 CSS 样式为例，假如我们需要用 Python 代码实现自动映射功能，首先我 们就需要拿到这两个文件的 URL，如：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">url_css</span> = <span class="string">'http://www.porters.vip/confusion/css/food.css'</span> </span><br><span class="line"><span class="attr">url_svg</span> = <span class="string">'http://www.porters.vip/confusion/font/food.svg'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>还有需要映射的 HTML 标签的 class 属性值，如：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">css_class_name</span> = <span class="string">'vhkbvu'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来使用 Requests 库向 URL 发出请求，拿到文本内容。对应代码如下：</p>
                  <figure class="highlight arduino">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests </span><br><span class="line">css_resp = requests.<span class="built_in">get</span>(url_css).<span class="built_in">text</span> </span><br><span class="line">svg_resp = requests.<span class="built_in">get</span>(url_svg).<span class="built_in">text</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>提取 CSS 样式文件中标签属性对应的坐标值，这里使用正则进行匹配即可。对应代码如下：</p>
                  <figure class="highlight sas">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import re </span><br><span class="line">pile = <span class="string">'.%s&#123;background:-(d+)px-(d+)px;&#125;'</span> % css_class_name </span><br><span class="line">pattern = re.compile(pile) </span><br><span class="line">css = css_resp.<span class="meta">replace</span>(<span class="string">'n'</span>, <span class="string">''</span>).<span class="meta">replace</span>(<span class="string">' '</span>, <span class="string">''</span>) </span><br><span class="line">coord = pattern.findall(css) </span><br><span class="line"><span class="meta">if</span> coord: </span><br><span class="line"> <span class="meta">x</span>, y = coord[0] </span><br><span class="line"> <span class="meta">x</span>, y =<span class="meta"> int(</span><span class="meta">x</span>),<span class="meta"> int(</span>y)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>此时得到的坐标值是正数，可以直接用于 SVG 字符定位。定位前我们要先拿到 SVG 中所有 text 标签的 Element 对象：</p>
                  <figure class="highlight oxygene">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> parsel import <span class="keyword">Selector</span> </span><br><span class="line">svg_data = <span class="keyword">Selector</span>(svg_resp) </span><br><span class="line">texts = svg_data.xpath(<span class="string">'//text'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后获取所有 text 标签中的 y 值，接着我们将上一步得到的 Element 对象进行循环取值即可：</p>
                  <figure class="highlight markdown">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">axis_y = [<span class="string">i.attrib.get('y') for i in texts if y &lt;= int(i.attrib.get('y'))</span>][<span class="symbol">0</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>得到 <em>y</em> 值后就可以开始字符定位了。要注意的是，SVG 中 text 标签的 <em>y</em> 值与 CSS 样式中得到的 <em>y</em> 值并不需要完全相等，因为样式可以随意调整，比如 CSS 样式中-90 和-92 对于 SVG 的定位来说并没有什么差别，所以我们只需要知道具体是哪一个 text 即可。 那么如何确定是哪一个 text呢？ 我们可以用排除法来确定，假如当前 CSS 样式中的 <em>y</em> 值是-97，那么在 SVG 中 text 的 <em>y</em> 值就不可能小于 97，我们只需要取到比 97 大且最相近的 text 标签 <em>y</em> 值即可。比如当前 SVG 所有 text 标签的 <em>y</em> 值为：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="number">38</span>, <span class="number">83</span>, <span class="number">120</span>, <span class="number">164</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>那么大于 97 且最相近的是 120。将这个逻辑转化为代码：</p>
                  <figure class="highlight markdown">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">axis_y = [<span class="string">i.attrib.get('y') for i in texts if y &lt;= int(i.attrib.get('y'))</span>][<span class="symbol">0</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>得到 y 值后就可以确定具体是哪个 text 标签了。对应代码如下：</p>
                  <figure class="highlight excel">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">svg_text = svg_data.xpath('//<span class="built_in">text</span>[@y=<span class="string">"%s"</span>]/<span class="built_in">text</span>()' % axis_y).extract_first()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来需要确认 SVG 中的文字大小，也就是需要找到 font-size 属性的值。对应代码如下：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">font_size</span> = re.search(<span class="string">'font-size:(d+)px'</span>, svg_resp).group(<span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>得到 font-size 的值后，我们就可以定位具体的字符了。<em>x</em> 轴有多少个字符呢？刚才我们拿到的 svg_text 就是指定的 text 标签中的字符：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">'<span class="number">67126078110409</span><span class="number">66630008923284</span><span class="number">40489239185923</span>'</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们需要计算字符串长度吗？并不用，我们知道，每个字符大小为 14 px，只需要将 CSS 样式中的 <em>x</em> 值除以字符大小，得到的就是该字符在字符串中的位置。除法得到的结果有可能是整数也有可能是非整数，当结果是整数是说明定位完全准确，我们利用切片特性就可以拿到字符。如果结果是非整数，就说明定位不完全准确，由于字符不可能出现一半，所以我们利用地板除（编程语言中常见的向下取整除法，返回商的整数部分。）就可以拿到整数：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">position</span> = x // int(font_size) <span class="comment"># 结果为 27</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>也就是说 CSS 样式 vhkbvu 映射的是 SVG 中第 4 行文本的第 27 个位置的值。映射结果如图 6-31 所示。 <img src="http://can.sfhfpc.com/sfhfpc/20191225231136.jpg" alt=""> 图 6-31 映射结果 然后再利用切片特性拿到字符。对应代码如下：</p>
                  <figure class="highlight fortran">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">number</span> = svg_text[<span class="keyword">position</span>] </span><br><span class="line"><span class="built_in">print</span>(<span class="keyword">number</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>代码运行结果为 4。我们还可以尝试其他的 class 属性值，最后得到的结果与页面显示的字符都是相同的，说明这种映射算法是正确的。至此，我们已经完成了对映射型反爬虫的绕过。</p>
                  <h3 id="6-3-4-小结"><a href="#6-3-4-小结" class="headerlink" title="6.3.4 小结"></a>6.3.4 小结</h3>
                  <p>与 6.1 节和 6.2 节相同，本节示例所用的反爬虫手段，即使借助渲染工具也无法获得“见到”的内容。SVG 映射反爬虫利用了浏览器与编程语言在渲染方面的差异，以及 SVG 与 CSS 定位这样的前端知识。如果爬虫工程师不熟悉渲染原理和前端知识，那么这种反爬虫手段就会带来很大的困扰。 </p>
                  <h3 id="转载说明"><a href="#转载说明" class="headerlink" title="转载说明"></a>转载说明</h3>
                  <p>本篇内容摘自出版图书《Python3 反爬虫原理与绕过实战》，欢迎各位好友与同行转载！ 记得带上相关的版权信息哦😊。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/韦世东学算法和反爬虫" class="author" itemprop="url" rel="index">韦世东学算法和反爬虫</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-12-27 15:09:11" itemprop="dateCreated datePublished" datetime="2019-12-27T15:09:11+08:00">2019-12-27</time>
                </span>
                <span id="/8648.html" class="post-meta-item leancloud_visitors" data-flag-title="大厂在用的反爬虫手段，破了它！" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>9.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/8637.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="崔庆才的个人站点，记录生活的瞬间，分享学习的心得。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/8637.html" class="post-title-link" itemprop="url">谷歌验证码 ReCaptcha 破解教程，简单方便从零开始。</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>很久没有做爬虫破解类相关的分享了，之前交流群里有朋友提问谷歌系的reCAPTCHA V2 验证码怎么破，因为工作的原因我是很久之后才看到的，也不知道那位朋友后来成功了没有。所以今天就来跟大家分享一下 reCAPTCHA V2 的破解。 （小马补充：想加交流群的朋友，进入公众号下方，点击技术交流，有读者群和交流群，点击后都会弹出崔老师的二维码，扫微信二维码拉群～） 如果大家访问国外的一些网站的话，想必肯定见过这样的一个验证码，它上面写着「I’m not a robot」，意为「我不是机器人」，验证码长这个样子： <img src="https://qiniu.cuiqingcai.com/2019-12-26-001513.png" alt=""> 这时候，只要我们点击最前面的复选框，验证码算法会首先利用其「风险分析引擎」做一次安全检测，如果直接检验通过的话，我们会直接得到如下的结果： <img src="https://qiniu.cuiqingcai.com/2019-12-26-000950.png" alt=""> 如果算法检测到当前系统存在风险，比如可能是陌生的网络环境，可能是模拟程序，会需要做二次校验。它会进一步弹出类似如下的内容： <img src="https://qiniu.cuiqingcai.com/2019-12-26-002143.png" alt=""> 比如上面这张图，验证码页面会出现九张图片，同时最上方出现文字「树木」，我们需要点选下方九张图中出现「树木」的图片，点选完成之后，可能还会出现几张新的图片，我们需要再次完成点选，最后点击「验证」按钮即可完成验证。 或者我们可以点击下方的「耳机」图标，这时候会切换到听写模式，验证码会变成这样： <img src="https://qiniu.cuiqingcai.com/2019-12-26-004236.png" alt=""> 这时候我们如果能填写对验证码读的音频内容，同样可以通过验证。 这两种方式都可以通过验证，验证完成之后，我们才能完成表单的提交，比如完成登录、注册等操作。 这种验证码叫什么名字？ 这个验证码就是 Google 的 reCAPTCHA V2 验证码，它就属于行为验证码的一种，这些行为包括点选复选框、选择对应图片、语音听写等内容，只有将这些行为校验通过，此验证码才能通过验证。相比于一般的图形验证码来说，此种验证码交互体验更好、安全性会更高、破解难度更大。 许多国外的网站都采用了此种验证码，由于某些原因，在国内其实无法直接使用，但只需要将验证码的域名更换为 recaptcha.net 同样是可以使用的，所以有时候我们在国内某些站点同样能看到它的身影。 其实上文所介绍的验证码仅仅是 reCAPTCHA 验证码的一种形式，是 V2 的显式版本，另外其 V2 版本还有隐式版本，隐式版本在校验的时候不会再显式地出现验证页面，它是通过 JavaScript 将验证码和提交按钮进行绑定，在提交表单的时候会自动完成校验。除了 V2 版本，Google 又推出了最新的 V3 版本，reCAPTCHA V3 验证码会为根据用户的行为来计算一个分数，这个分数代表了用户可能为机器人的概率，最后通过概率来判断校验是否可以通过。其安全性更高、体验更好。 具体的内容大家可以参考 reCAPTCHA 的官方介绍：<a href="https://developers.google.com/recaptcha" target="_blank" rel="noopener">https://developers.google.com/recaptcha</a>。 那么在做爬虫的时候，如果我们遇到了这样的验证码？该怎么办呢？不要着急，这篇文章就来介绍一个解决方案。</p>
                  <h2 id="机器学习-vs-识别服务"><a href="#机器学习-vs-识别服务" class="headerlink" title="机器学习 vs 识别服务"></a>机器学习 vs 识别服务</h2>
                  <p>之前我在写上一篇如何识别滑动验证码问题的时候，当时朋友留言问我能不能做一个机器学习的，我回复了，我说当然没问题，你等着，我这周就做。 我那周从周一做到周五，我记得用的应该是 yolo，反复修改，小马还经常过来催崔稿，耗费良久，然后就在那周周五晚上的23:59分，我灵机一动，终于明白了。 去他的机器学习，有服务不好吗？ reCAPTCHA 本身比极验还要复杂，国内网站我暂时没看到破解的，然后这次是用的俄罗斯的一个服务商 2Captcha 提供的 图像识别和一系列行为验证码的识别服务。 <img src="https://qiniu.cuiqingcai.com/2019-12-26-012846.png" alt=""> 破解验证码背后有图像识别算法和大量人力的支撑，如果我们仅仅是简单的图形验证码，其可以通过一些图像识别算法将内容识别出来转化为文本内容。如果是较为复杂的图形验证码或者像 reCAPTCHA 类似的行为验证码，其背后会有人来对验证码进行模拟，然后返回其验证成功后的秘钥，我们利用其结果便可以完成一些验证码的绕过。 当然这种网站肯定是要收费的，按照 1000 次识别为单位，其花费的费用为 0.5 美刀到 2.99 美刀不等，比如非常简单的图形验证码可能就是 0.5 美刀，这种验证码对于其人力和算力资源消耗都是相对较小的，对于复杂的 reCAPTCHA 验证码，就要花 2.99 美刀了，因为识别这么一个验证码并不容易，其背后的人可能需要看好多图，点选好多次才能完成一次成功的验证。 目前我用的服务的收费标准是这样的： <img src="https://qiniu.cuiqingcai.com/2019-12-26-012237.png" alt=""> 具体的内容或者更新大家可以到其官方说明 <a href="https://2captcha.com/2captcha-api#rates" target="_blank" rel="noopener">https://2captcha.com/2captcha-api#rates</a> 去查看。 后面我用他的服务来破解 reCAPTCHA，当然类比其他服务也是可以的，过程大概都是这样。</p>
                  <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2>
                  <p>要使用 2Captcha，第一步当然是注册一下它的账号了，注册完成之后我们可以进入到 2Captcha 的控制台，类似于这样子： <img src="https://qiniu.cuiqingcai.com/2019-12-26-013234.png" alt=""> 在这里我们可以看到账户余额、API KEY、FAQ 等配置。 这里最重要的就是 API KEY 了，它是我们用来使用 2Captcha 的凭证，我们将它复制下来，后面我们会在代码中使用它。 <img src="https://qiniu.cuiqingcai.com/2019-12-26-013456.png" alt=""> 好，准备工作完成了，我们接下来进入正式内容。</p>
                  <h2 id="2Captcha-for-reCAPTCHA-V2"><a href="#2Captcha-for-reCAPTCHA-V2" class="headerlink" title="2Captcha for reCAPTCHA V2"></a>2Captcha for reCAPTCHA V2</h2>
                  <p>在上文我们已经介绍过 reCAPTCHA V2 的使用和交互流程了，下面我们来介绍下其识别和绕过的基本流程。 在这里我们就拿官方的 reCAPTCHA V2 的示例网站来做演示吧，其网址为：<a href="https://www.google.com/recaptcha/api2/demo，打开之后界面如下所示" target="_blank" rel="noopener">https://www.google.com/recaptcha/api2/demo，打开之后界面如下所示</a>： <img src="https://qiniu.cuiqingcai.com/2019-12-26-014533.png" alt=""> 在这里可以看到有一个表单，上面有一些输入框，下方是 reCAPTCHA V2 验证码。 要识别这个验证码，第一步便是找到这个验证码 sitekey，这个是验证码的唯一标识。 我们打开浏览器的开发者工具，查看其页面源码，首先找到 reCAPTCHA 的源代码，如下图所示： <img src="https://qiniu.cuiqingcai.com/2019-12-26-015303.png" alt=""> 可以看到 reCAPTCHA 是对应了一个 iframe，我们看到的 reCAPTCHA 内容都是在 iframe 里面呈现出来的。 这里我们可以观察到在 reCAPTCHA 的源码的最外层的 div 上面有一个字段，叫做 data-sitekey，这就是刚才我们所说的 sitekey，它是验证码的唯一标识，比如这里我先将这个 sitekey 保存下来，这里其值为：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">6</span>Le-wvkSAAAAAPBMRTvw0Q4Muexq9bi0DJwx_mJ-</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下一步，我们就需要将这个 sitekey 和当前页面的 URL 告诉 2Captcha，让 2Captcha 来帮助我们识别这个 reCAPTCHA 验证码，告诉 2Captcha 之后，2Captcha 会利用这些信息加载出对应的验证码，再利用其背后的人力来对验证码进行识别，最后将识别得到的 token 返回给我们即可。 好，那么接下来怎么把这个信息告诉 2Captcha 呢？ 很简单，2Captcha 为我们提供了一个接口，其接口地址为：<a href="https://2captcha.com/in.php，我们只需要将对应的信息发送到这个接口就好了" target="_blank" rel="noopener">https://2captcha.com/in.php，我们只需要将对应的信息发送到这个接口就好了</a>。 那么发送需要什么参数呢，在这里介绍一下：</p>
                  <p>参数</p>
                  <p>类型</p>
                  <p>必须</p>
                  <p><strong>描述</strong></p>
                  <p>key</p>
                  <p>String</p>
                  <p>Yes</p>
                  <p>我们自己的 API KEY</p>
                  <p>method</p>
                  <p>String</p>
                  <p>Yes</p>
                  <p>userrecaptcha，定义破解 reCAPTCHA 验证码的方式</p>
                  <p>googlekey</p>
                  <p>String</p>
                  <p>Yes</p>
                  <p>reCAPTCHA 的 sitekey</p>
                  <p>pageurl</p>
                  <p>String</p>
                  <p>Yes</p>
                  <p>reCAPTCHA 当前所在的 URL</p>
                  <p>invisible</p>
                  <p>Integer Default: 0</p>
                  <p>No</p>
                  <p>是否可见，1 代表是隐式验证码，0 代表普通验证码。</p>
                  <p>header_acao</p>
                  <p>Integer Default: 0</p>
                  <p>No</p>
                  <p>跨域访问配置</p>
                  <p>pingback</p>
                  <p>String</p>
                  <p>No</p>
                  <p>回调地址</p>
                  <p>json</p>
                  <p>Integer Default: 0</p>
                  <p>No</p>
                  <p>返回格式，1 代表返回 JSON 格式，0 代表纯文本，默认 0</p>
                  <p>soft_id</p>
                  <p>Integer</p>
                  <p>No</p>
                  <p>ID of software developer. Developers who integrated their software with 2captcha get reward: 10% of spendings of their software users.</p>
                  <p>proxy</p>
                  <p>String</p>
                  <p>No</p>
                  <p>代理配置</p>
                  <p>在这里我们可以构造一个 URL，它包括这几个参数：</p>
                  <ul>
                    <li>key：注意这里的 KEY 换成你自己的 API KEY</li>
                    <li>method：直接赋值 userrecaptcha</li>
                    <li>googlekey：复制的 sitekey</li>
                    <li>pageurl：当前 URL</li>
                    <li>json：直接赋值 1，代表返回 JSON 格式</li>
                  </ul>
                  <p>比如在这里我就构造了这个 URL，内容如下：</p>
                  <figure class="highlight llvm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">https://<span class="number">2</span>captcha.com/in.php?key=<span class="keyword">c</span><span class="number">0</span>ae<span class="number">5935</span>d<span class="number">807</span><span class="keyword">c</span><span class="number">28</span>f<span class="number">285e5</span>cb<span class="number">16</span><span class="keyword">c</span><span class="number">676</span>a<span class="number">48</span>&amp;method=userrecaptcha&amp;googlekey=<span class="number">6</span>Le-wvkSAAAAAPBMRTvw<span class="number">0</span>Q<span class="number">4</span>Muexq<span class="number">9</span>b<span class="keyword">i0</span>DJwx_mJ-&amp;pageurl=https://www.google.com/recaptcha/ap<span class="keyword">i2</span>/demo&amp;json=<span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时候我们直接向这个 URL 发起一个 GET 请求即可。 我们可以直接在浏览器里面输入这个 URL，也可以使用 requests 等请求库来完成：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">response = requests.<span class="builtin-name">get</span>(url)</span><br><span class="line"><span class="builtin-name">print</span>(response.json())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接口会返回如下格式的内容：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;'status': <span class="number">1</span>, 'request': '<span class="number">6291941969</span>5'&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里它返回了一个 JSON 格式的数据，其中 status 代表请求状态，如果是 1 的话，代表请求成功，另外其还会包含一个 request 字段，其内容是一个 ID，这个 ID 就是识别这个验证码的任务的 ID。因为 2Captcha 背后有很多人来帮助识别验证码，所以 2Captcha 将每个验证码的识别划分为一个个任务，每个任务都有一个唯一的 ID，刚分配任务时，这个任务被标记为 NOT_READY 状态。这些任务接下来会被分发给一个个人，识别完成之后，该任务就会被标记为已经识别状态，同时附有识别之后的信息，如 token 等内容。 好，刚才的接口请求成功之后，这个 reCAPTCHA 的识别任务就已经被下发了，其背后会有对应的人来对这个 reCAPTCHA 验证码进行识别，识别过程可能需要十几秒到几十秒不等，我们可以通过另一个接口来获取任务的结果。 获取结果的接口地址为：<a href="https://2captcha.com/res.php，同样我们需要传入一些参数，其参数介绍如下" target="_blank" rel="noopener">https://2captcha.com/res.php，同样我们需要传入一些参数，其参数介绍如下</a>：</p>
                  <p>参数</p>
                  <p><strong>类型</strong></p>
                  <p><strong>必需</strong></p>
                  <p><strong>描述</strong></p>
                  <p>key</p>
                  <p>String</p>
                  <p>Yes</p>
                  <p>API KEY</p>
                  <p>action</p>
                  <p>String</p>
                  <p>Yes</p>
                  <p>get，表示获取验证码的结果</p>
                  <p>id</p>
                  <p>Integer</p>
                  <p>Yes</p>
                  <p>任务 ID，就是刚才 in.php 接口返回的结果。</p>
                  <p>json</p>
                  <p>Integer Default: 0</p>
                  <p>No</p>
                  <p>返回 JSON 格式，1 代表使用 JSON 格式，0 代表纯文本格式</p>
                  <p>在这里我们构造一个 URL，它包括如上的参数：</p>
                  <ul>
                    <li>key：在这里换成你的 API KEY</li>
                    <li>action：就直接赋值 get</li>
                    <li>id：任务 ID</li>
                    <li>json：在这里用 1，即返回 JSON 格式数据</li>
                  </ul>
                  <p>这样我们就构造了如下的 URL：</p>
                  <figure class="highlight sas">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">https://2captcha.com/res.php?<span class="meta">key</span>=c0ae5935d807c28f285e5cb16c676a48<span class="variable">&amp;action</span>=get<span class="variable">&amp;id</span>=62919419695<span class="variable">&amp;json</span>=1</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>同样我们可以在浏览器中访问或者用 requests 请求，得到如下结果：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"request"</span>: <span class="string">"03AOLTBLSg0fQUUMtP2o3kvJWNm6zla8MEjP_vPh629-xS-d_QrlJwMcxQfSJMUIU92noqbJ16yt5a0PdB3ORW-5MEbqK7NZ82bTnSZohCG_mYVVv8TbuvM1A99DFvlepxGEKlGCoi5lTHJd5z_QQ2mV1trGlI8VJkHjVAhLZzlz67MVgQzIu7aDl39n6aocAIVueQuCyjmA1C3hUECxpNlXJuXYVD10eJrqY_Bu36_2E0uBrmDIkAIjxCzEZWgadToU4ByLReOrNJ7_4t-P8leTUbPC5YBXvoDZZZByz8-vNnHzUu3GNNESzGSCMFfVPYumnXXI6i7TO5p1k-AElgb7qor6vDJGA_RpNNSUgAj8B0synG9APpbMQ4cEprHXle5pJtNCBX_v_8uqJLobomIx0St5l_H1tHGuTgI2UU-nWmR9TwvKp6SR-6G2Fi6pv7c8350tPbqJWWMcV0AXdfM85GjRDh2t7wh1CMukLQE21aIIwHh88kR0Fh0481Kw_umw8IfFCHyHKu8IcTERUL5LZdDzQkiGdF1wqWP-GhySMXEx-eOT7tB6SqPEAmO_mbwtJtA-qKzcHP"</span></span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果其返回的是如上格式的数据，就代表 reCAPTCHA 验证码已经识别成功了，其返回的 request 字段的内容就是识别的 token，我们直接拿着这个 token 放到表单里面提交就成功了。 那这个 token 怎么来用呢？ 其实如果不走 2Captcha 接口，我们如果人工验证成功之后，在其表单里面会把一个 name 叫做 g-recaptcha-response 的 textarea 赋值，如果验证成功，它的 value 值就是验证之后得到的 token，这个会作为表单提交的一部分发送到服务器进行验证。如果这个字段校验成功了，那就没问题了。 <img src="https://qiniu.cuiqingcai.com/2019-12-26-024847.png" alt=""> 所以，2Captcha 相当于为我们模拟了点选验证码的过程，其最终得到的这个 token 其实就是我们应该赋值给 name 为 g-recaptcha-response 的内容。 那么怎么赋值呢？ 很简单，用 JavaScript 就好了。我们可以用 JavaScript 选取到这个 textarea，然后直接赋值即可，代码如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">document.getElementById(<span class="string">"g-recaptcha-response"</span>).<span class="attribute">innerHTML</span>=<span class="string">"TOKEN_FROM_2CAPTCHA"</span>;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>注意这里的 <code>TOKEN_FROM_2CAPTCHA</code> 需要换成刚才我们所得到的 token 值。我们做爬虫模拟登录的时候，假如是用 Selenium、Puppeteer 等软件，在模拟程序里面，只需要模拟执行这段 JavaScript 代码，就可以成功赋值了。 执行之后，直接提交表单，我们查看下 Network 请求： <img src="https://qiniu.cuiqingcai.com/2019-12-26-025745.png" alt=""> 可以看到其就是提交了一个表单，其中有一个字段就是 g-recaptcha-response，它会发送到服务端进行校验，校验通过，那就成功了。 所以，如果我们借助于 2Captcha 得到了这个 token，然后把它赋值到表单的 textarea 里面，表单就会提交，如果 token 有效，就能成功绕过登录，而不需要我们再去点选验证码了。 最后我们得到如下成功的页面： <img src="https://qiniu.cuiqingcai.com/2019-12-26-030006.png" alt=""> 至此，我们就成功地借助 2Captcha 来完成了 reCAPTCHA V2 验证码的识别。</p>
                  <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
                  <p>本节我们介绍了利用 2Captcha 来帮助识别 reCAPTCHA V2 的流程。那应该来讲，我觉得工程师使用这样的服务并不是一种令人羞耻的过程，尤其是他可以以比较低的价格实现你的需求的情况下。毕竟你的时间，本身就是一种价值。 最后 2Captcha 这个网站我放在下面，有感兴趣的朋友可以看一下。另外如果有什么爬虫方面想看的文章，也欢迎在下面留言，我们会挑选被点赞较多的主题尽快写文。谢谢！</p>
                  <p><a href="http://2captcha.com/zh" target="_blank" rel="noopener">2captcha.com/zh</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2019-12-27 08:55:16" itemprop="dateCreated datePublished" datetime="2019-12-27T08:55:16+08:00">2019-12-27</time>
                </span>
                <span id="/8637.html" class="post-meta-item leancloud_visitors" data-flag-title="谷歌验证码 ReCaptcha 破解教程，简单方便从零开始。" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <script>
              document.querySelectorAll('.random').forEach(item => item.src = "https://picsum.photos/id/" + Math.floor(Math.random() * Math.floor(300)) + "/200/133")

            </script>
            <nav class="pagination">
              <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
            </nav>
          </div>
          <script>
            window.addEventListener('tabs:register', () =>
            {
              let
              {
                activeClass
              } = CONFIG.comments;
              if (CONFIG.comments.storage)
              {
                activeClass = localStorage.getItem('comments_active') || activeClass;
              }
              if (activeClass)
              {
                let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
                if (activeTab)
                {
                  activeTab.click();
                }
              }
            });
            if (CONFIG.comments.storage)
            {
              window.addEventListener('tabs:click', event =>
              {
                if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
                let commentClass = event.target.classList[1];
                localStorage.setItem('comments_active', commentClass);
              });
            }

          </script>
        </div>
        <div class="toggle sidebar-toggle">
          <span class="toggle-line toggle-line-first"></span>
          <span class="toggle-line toggle-line-middle"></span>
          <span class="toggle-line toggle-line-last"></span>
        </div>
        <aside class="sidebar">
          <div class="sidebar-inner">
            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc"> 文章目录 </li>
              <li class="sidebar-nav-overview"> 站点概览 </li>
            </ul>
            <!--noindex-->
            <div class="post-toc-wrap sidebar-panel">
            </div>
            <!--/noindex-->
            <div class="site-overview-wrap sidebar-panel">
              <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <img class="site-author-image" itemprop="image" alt="崔庆才" src="/images/avatar.png">
                <p class="site-author-name" itemprop="name">崔庆才</p>
                <div class="site-description" itemprop="description">崔庆才的个人站点，记录生活的瞬间，分享学习的心得。</div>
              </div>
              <div class="site-state-wrap motion-element">
                <nav class="site-state">
                  <div class="site-state-item site-state-posts">
                    <a href="/archives/">
                      <span class="site-state-item-count">518</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>
                  <div class="site-state-item site-state-categories">
                    <a href="/categories/">
                      <span class="site-state-item-count">21</span>
                      <span class="site-state-item-name">分类</span></a>
                  </div>
                  <div class="site-state-item site-state-tags">
                    <a href="/tags/">
                      <span class="site-state-item-count">121</span>
                      <span class="site-state-item-name">标签</span></a>
                  </div>
                </nav>
              </div>
              <div class="links-of-author motion-element">
                <span class="links-of-author-item">
                  <a href="https://github.com/Germey" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Germey" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
                </span>
                <span class="links-of-author-item">
                  <a href="mailto:cqc@cuiqingcai.com.com" title="邮件 → mailto:cqc@cuiqingcai.com.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>邮件</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://weibo.com/cuiqingcai" title="微博 → https:&#x2F;&#x2F;weibo.com&#x2F;cuiqingcai" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>微博</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/Germey" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Germey" rel="noopener" target="_blank"><i class="fa fa-magic fa-fw"></i>知乎</a>
                </span>
              </div>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://www.abuyun.com/http-proxy/introduce.html" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/88au8.jpg" style=" width: 100%;">
              </a>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://tutorial.lengyue.video/?coupon=12ef4b1a-a3db-11ea-bb37-0242ac130002_cqx_850" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/bco2a.png" style=" width: 100%;">
              </a>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://luminati-china.io/?affiliate=ref_5fbbaaa9647883f5c6f77095" target="_blank" rel="noopener">
                <img src="https://qiniu.cuiqingcai.com/ikkq9.jpg" style=" width: 100%;">
              </a>
            </div>
            <div class="sidebar-panel sidebar-panel-tags sidebar-panel-active">
              <h4 class="name"> 标签云 </h4>
              <div class="content">
                <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/599/" style="font-size: 10px;">599</a> <a href="/tags/Bootstrap/" style="font-size: 11.25px;">Bootstrap</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CQC/" style="font-size: 10px;">CQC</a> <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/CSS-%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">CSS 反爬虫</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Eclipse/" style="font-size: 11.25px;">Eclipse</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/GitHub/" style="font-size: 11.25px;">GitHub</a> <a href="/tags/HTML5/" style="font-size: 10px;">HTML5</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/IT/" style="font-size: 10px;">IT</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/LOGO/" style="font-size: 10px;">LOGO</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MIUI/" style="font-size: 10px;">MIUI</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/PHP/" style="font-size: 11.25px;">PHP</a> <a href="/tags/PS/" style="font-size: 10px;">PS</a> <a href="/tags/Pathlib/" style="font-size: 10px;">Pathlib</a> <a href="/tags/PhantomJS/" style="font-size: 10px;">PhantomJS</a> <a href="/tags/PySpider/" style="font-size: 10px;">PySpider</a> <a href="/tags/Python/" style="font-size: 16.25px;">Python</a> <a href="/tags/Python3/" style="font-size: 12.5px;">Python3</a> <a href="/tags/Pythonic/" style="font-size: 10px;">Pythonic</a> <a href="/tags/QQ/" style="font-size: 10px;">QQ</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SAE/" style="font-size: 10px;">SAE</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SVG/" style="font-size: 10px;">SVG</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/Scrapy-redis/" style="font-size: 10px;">Scrapy-redis</a> <a href="/tags/Scrapy%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">Scrapy分布式</a> <a href="/tags/Selenium/" style="font-size: 10px;">Selenium</a> <a href="/tags/TKE/" style="font-size: 10px;">TKE</a> <a href="/tags/Ubuntu/" style="font-size: 11.25px;">Ubuntu</a> <a href="/tags/Vue/" style="font-size: 11.25px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Winpcap/" style="font-size: 10px;">Winpcap</a> <a href="/tags/WordPress/" style="font-size: 13.75px;">WordPress</a> <a href="/tags/object-Object/" style="font-size: 10px;">[object Object]</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/cocos2d-x/" style="font-size: 10px;">cocos2d-x</a> <a href="/tags/e6/" style="font-size: 10px;">e6</a> <a href="/tags/fitvids/" style="font-size: 10px;">fitvids</a> <a href="/tags/git/" style="font-size: 11.25px;">git</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/js%E9%80%86%E5%90%91/" style="font-size: 10px;">js逆向</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/logging/" style="font-size: 10px;">logging</a> <a href="/tags/matlab/" style="font-size: 11.25px;">matlab</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/pywin32/" style="font-size: 10px;">pywin32</a> <a href="/tags/style/" style="font-size: 10px;">style</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/uwsgi/" style="font-size: 10px;">uwsgi</a> <a href="/tags/validate-cert/" style="font-size: 10px;">validate_cert</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/wamp/" style="font-size: 10px;">wamp</a> <a href="/tags/wineQQ/" style="font-size: 10px;">wineQQ</a> <a href="/tags/%E4%B8%83%E7%89%9B/" style="font-size: 11.25px;">七牛</a> <a href="/tags/%E4%B8%8A%E6%B5%B7/" style="font-size: 10px;">上海</a> <a href="/tags/%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99/" style="font-size: 10px;">个人网站</a> <a href="/tags/%E4%B8%BB%E9%A2%98/" style="font-size: 10px;">主题</a> <a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 10px;">云存储</a> <a href="/tags/%E4%BA%AC%E4%B8%9C%E4%BA%91/" style="font-size: 10px;">京东云</a> <a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 10px;">人工智能</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 10px;">代理</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" style="font-size: 10px;">代码</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size: 10px;">位运算</a> <a href="/tags/%E5%88%86%E4%BA%AB/" style="font-size: 10px;">分享</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">分布式</a> <a href="/tags/%E5%88%9B%E4%B8%9A/" style="font-size: 10px;">创业</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 11.25px;">前端</a> <a href="/tags/%E5%8E%9F%E7%94%9FAPP/" style="font-size: 10px;">原生APP</a> <a href="/tags/%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 12.5px;">反爬虫</a> <a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 10px;">命令</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80/" style="font-size: 10px;">响应式布局</a> <a href="/tags/%E5%9F%9F%E5%90%8D%E7%BB%91%E5%AE%9A/" style="font-size: 10px;">域名绑定</a> <a href="/tags/%E5%A4%A7%E4%BC%97%E7%82%B9%E8%AF%84/" style="font-size: 10px;">大众点评</a> <a href="/tags/%E5%AD%97%E4%BD%93%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">字体反爬虫</a> <a href="/tags/%E5%AE%9E%E7%94%A8/" style="font-size: 10px;">实用</a> <a href="/tags/%E5%B4%94%E5%BA%86%E6%89%8D/" style="font-size: 18.75px;">崔庆才</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%89%8B%E6%9C%BA%E8%AE%BF%E9%97%AE/" style="font-size: 10px;">手机访问</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%97%85%E6%B8%B8/" style="font-size: 10px;">旅游</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 10px;">日志</a> <a href="/tags/%E6%9D%9C%E5%85%B0%E7%89%B9/" style="font-size: 10px;">杜兰特</a> <a href="/tags/%E6%A1%8C%E9%9D%A2/" style="font-size: 10px;">桌面</a> <a href="/tags/%E6%B1%9F%E5%8D%97/" style="font-size: 10px;">江南</a> <a href="/tags/%E6%B8%B8%E6%88%8F/" style="font-size: 10px;">游戏</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 15px;">爬虫</a> <a href="/tags/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" style="font-size: 10px;">环境变量</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">生活笔记</a> <a href="/tags/%E7%99%BB%E5%BD%95/" style="font-size: 10px;">登录</a> <a href="/tags/%E7%9F%A5%E4%B9%8E/" style="font-size: 10px;">知乎</a> <a href="/tags/%E7%9F%AD%E4%BF%A1/" style="font-size: 10px;">短信</a> <a href="/tags/%E7%BA%B8%E5%BC%A0/" style="font-size: 10px;">纸张</a> <a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 10px;">网站</a> <a href="/tags/%E8%82%89%E5%A4%B9%E9%A6%8D/" style="font-size: 10px;">肉夹馍</a> <a href="/tags/%E8%A5%BF%E5%B0%91%E7%88%B7/" style="font-size: 10px;">西少爷</a> <a href="/tags/%E8%A7%86%E9%A2%91/" style="font-size: 10px;">视频</a> <a href="/tags/%E8%BF%9C%E7%A8%8B/" style="font-size: 10px;">远程</a> <a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 10px;">逆向</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 10px;">配置</a> <a href="/tags/%E9%87%8D%E8%A3%85/" style="font-size: 10px;">重装</a> <a href="/tags/%E9%9D%99%E8%A7%85/" style="font-size: 17.5px;">静觅</a> <a href="/tags/%E9%A2%A0%E8%A6%86/" style="font-size: 10px;">颠覆</a> <a href="/tags/%E9%A3%9E%E4%BF%A1/" style="font-size: 10px;">飞信</a>
              </div>
              <script>
                const tagsColors = ['#00a67c', '#5cb85c', '#d9534f', '#567e95', '#b37333', '#f4843d', '#15a287']
                const tagsElements = document.querySelectorAll('.sidebar-panel-tags .content a')
                tagsElements.forEach((item) =>
                {
                  item.style.backgroundColor = tagsColors[Math.floor(Math.random() * tagsColors.length)]
                })

              </script>
            </div>
            <div class="sidebar-panel sidebar-panel-categories sidebar-panel-active">
              <h4 class="name"> 分类 </h4>
              <div class="content">
                <ul class="category-list">
                  <li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">23</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><span class="category-list-count">13</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">26</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">15</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Net/">Net</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a><span class="category-list-count">38</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">27</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Paper/">Paper</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">256</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E5%B1%95%E7%A4%BA/">个人展示</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/">个人日记</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/">个人随笔</a><span class="category-list-count">10</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/">技术杂谈</a><span class="category-list-count">74</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/">生活笔记</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A6%8F%E5%88%A9%E4%B8%93%E5%8C%BA/">福利专区</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%81%8C%E4%BD%8D%E6%8E%A8%E8%8D%90/">职位推荐</a><span class="category-list-count">2</span></li>
                </ul>
              </div>
            </div>
            <div class="sidebar-panel sidebar-panel-friends sidebar-panel-active">
              <h4 class="name"> 友情链接 </h4>
              <ul class="friends">
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/j2dub.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.findhao.net/" target="_blank" rel="noopener">FindHao</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ou6mm.jpg">
                  </span>
                  <span class="link">
                    <a href="https://diygod.me/" target="_blank" rel="noopener">DIYgod</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/6apxu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.51dev.com/" target="_blank" rel="noopener">IT技术社区</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.jankl.com/img/titleshu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.jankl.com/" target="_blank" rel="noopener">liberalist</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/bqlbs.png">
                  </span>
                  <span class="link">
                    <a href="http://www.urselect.com/" target="_blank" rel="noopener">优社电商</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/8s88c.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yuanrenxue.com/" target="_blank" rel="noopener">猿人学</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/4i7yf.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lizenghai.com/" target="_blank" rel="noopener">Python量化投资</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/2wgg5.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yunlifang.cn/" target="_blank" rel="noopener">云立方</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/shwr6.png">
                  </span>
                  <span class="link">
                    <a href="http://lanbing510.info/" target="_blank" rel="noopener">冰蓝</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/blvoh.jpg">
                  </span>
                  <span class="link">
                    <a href="https://lengyue.me/" target="_blank" rel="noopener">冷月</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="http://qianxunclub.com/favicon.png">
                  </span>
                  <span class="link">
                    <a href="http://qianxunclub.com/" target="_blank" rel="noopener">千寻啊千寻</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/0044u.jpg">
                  </span>
                  <span class="link">
                    <a href="http://kodcloud.com/" target="_blank" rel="noopener">可道云</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ygnpn.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.kunkundashen.cn/" target="_blank" rel="noopener">坤坤大神</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/22uv1.png">
                  </span>
                  <span class="link">
                    <a href="http://www.cenchong.com/" target="_blank" rel="noopener">岑冲博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/ev9kl.png">
                  </span>
                  <span class="link">
                    <a href="http://www.zxiaoji.com/" target="_blank" rel="noopener">张小鸡</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.chrafz.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.chrafz.com/" target="_blank" rel="noopener">张弦先生</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.503error.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.503error.com/" target="_blank" rel="noopener">张志明个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://seofangfa.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://seofangfa.com/" target="_blank" rel="noopener">方法SEO</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/x714o.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.hubwiz.com/" target="_blank" rel="noopener">汇智网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/lfmj3.png">
                  </span>
                  <span class="link">
                    <a href="http://frankchen.xyz/" target="_blank" rel="noopener">不正经数据科学家</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/129d8.png">
                  </span>
                  <span class="link">
                    <a href="https://www.bysocket.com/" target="_blank" rel="noopener">泥瓦匠BYSocket</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.xiongge.club/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.xiongge.club/" target="_blank" rel="noopener">熊哥club</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/3w4fe.png">
                  </span>
                  <span class="link">
                    <a href="https://zerlong.com/" target="_blank" rel="noopener">知语</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/262r1.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.ysir308.com/" target="_blank" rel="noopener">程序员虾说</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/44hxf.png">
                  </span>
                  <span class="link">
                    <a href="http://redstonewill.com/" target="_blank" rel="noopener">红色石头</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/8g1fk.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.laodong.me/" target="_blank" rel="noopener">老董博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/wkaus.jpg">
                  </span>
                  <span class="link">
                    <a href="https://zhaoshuai.me/" target="_blank" rel="noopener">碎念</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/pgo0r.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.chenwenguan.com/" target="_blank" rel="noopener">陈文管的博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/kk82a.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lxlinux.net/" target="_blank" rel="noopener">良许Linux教程网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/lj0t2.jpg">
                  </span>
                  <span class="link">
                    <a href="https://tanqingbo.cn/" target="_blank" rel="noopener">IT码农</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/i8cdr.png">
                  </span>
                  <span class="link">
                    <a href="https://junyiseo.com/" target="_blank" rel="noopener">均益个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/chwv2.png">
                  </span>
                  <span class="link">
                    <a href="https://brucedone.com/" target="_blank" rel="noopener">大鱼的鱼塘</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://qiniu.cuiqingcai.com/2y43o.png">
                  </span>
                  <span class="link">
                    <a href="http://bbs.nightteam.cn/" target="_blank" rel="noopener">夜幕爬虫安全论坛</a>
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </aside>
        <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span>
          <span class="with-love">
            <i class="fa fa-heart"></i>
          </span>
          <span class="author" itemprop="copyrightHolder">崔庆才丨静觅</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-chart-area"></i>
          </span>
          <span title="站点总字数">2.5m</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-coffee"></i>
          </span>
          <span title="站点阅读时长">37:31</span>
        </div>
        <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动 </div>
        <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18015597号-1 </a>
        </div>
        <script>
          (function ()
          {
            function leancloudSelector(url)
            {
              url = encodeURI(url);
              return document.getElementById(url).querySelector('.leancloud-visitors-count');
            }

            function addCount(Counter)
            {
              var visitors = document.querySelector('.leancloud_visitors');
              var url = decodeURI(visitors.id);
              var title = visitors.dataset.flagTitle;
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                if (results.length > 0)
                {
                  var counter = results[0];
                  leancloudSelector(url).innerText = counter.time + 1;
                  Counter('put', '/classes/Counter/' + counter.objectId,
                  {
                    time:
                    {
                      '__op': 'Increment',
                      'amount': 1
                    }
                  }).catch(error =>
                  {
                    console.error('Failed to save visitor count', error);
                  });
                }
                else
                {
                  Counter('post', '/classes/Counter',
                  {
                    title,
                    url,
                    time: 1
                  }).then(response => response.json()).then(() =>
                  {
                    leancloudSelector(url).innerText = 1;
                  }).catch(error =>
                  {
                    console.error('Failed to create', error);
                  });
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }

            function showTime(Counter)
            {
              var visitors = document.querySelectorAll('.leancloud_visitors');
              var entries = [...visitors].map(element =>
              {
                return decodeURI(element.id);
              });
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url:
                {
                  '$in': entries
                }
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                for (let url of entries)
                {
                  let target = results.find(item => item.url === url);
                  leancloudSelector(url).innerText = target ? target.time : 0;
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }
            let
            {
              app_id,
              app_key,
              server_url
            } = {
              "enable": true,
              "app_id": "6X5dRQ0pnPWJgYy8SXOg0uID-gzGzoHsz",
              "app_key": "ziLDVEy73ne5HtFTiGstzHMS",
              "server_url": null,
              "security": false
            };

            function fetchData(api_server)
            {
              var Counter = (method, url, data) =>
              {
                return fetch(`${api_server}/1.1${url}`,
                {
                  method,
                  headers:
                  {
                    'X-LC-Id': app_id,
                    'X-LC-Key': app_key,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data)
                });
              };
              if (CONFIG.page.isPost)
              {
                if (CONFIG.hostname !== location.hostname) return;
                addCount(Counter);
              }
              else if (document.querySelectorAll('.post-title-link').length >= 1)
              {
                showTime(Counter);
              }
            }
            let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;
            if (api_server)
            {
              fetchData(api_server);
            }
            else
            {
              fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id).then(response => response.json()).then((
              {
                api_server
              }) =>
              {
                fetchData('https://' + api_server);
              });
            }
          })();

        </script>
      </div>
      <div class="footer-stat">
        <span id="cnzz_stat_icon_1279355174"></span>
        <script type="text/javascript">
          document.write(unescape("%3Cspan id='cnzz_stat_icon_1279355174'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279355174%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));

        </script>
      </div>
    </footer>
  </div>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/.js"></script>
  <script src="/js/schemes/pisces.js"></script>
  <script src="/.js"></script>
  <script src="/js/next-boot.js"></script>
  <script src="/.js"></script>
  <script>
    (function ()
    {
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x = document.getElementsByTagName("link");
      //Find the last canonical URL
      if (x.length > 0)
      {
        for (i = 0; i < x.length; i++)
        {
          if (x[i].rel.toLowerCase() == 'canonical' && x[i].href)
          {
            canonicalURL = x[i].href;
          }
        }
      }
      //Get protocol
      if (!canonicalURL)
      {
        curProtocol = window.location.protocol.split(':')[0];
      }
      else
      {
        curProtocol = canonicalURL.split(':')[0];
      }
      //Get current URL if the canonical URL does not exist
      if (!canonicalURL) canonicalURL = window.location.href;
      //Assign script content. Replace current URL with the canonical URL
      ! function ()
      {
        var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,
          r = canonicalURL,
          t = document.referrer;
        if (!e.test(r))
        {
          var n = (String(curProtocol).toLowerCase() === 'https') ? "https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif" : "//api.share.baidu.com/s.gif";
          t ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
          var i = new Image;
          i.src = n
        }
      }(window);
    })();

  </script>
  <script src="/js/local-search.js"></script>
  <script src="/.js"></script>
</body>

</html>
